import { __decorate } from "tslib";
import React from 'react';
import PropTypes from 'prop-types';
import omit from 'lodash/omit';
import shallowEqual from 'lodash/isEqual';
import noop from 'lodash/noop';
import isElement from 'lodash/isElement';
import ClassNames from 'classnames';
import Align from 'choerodon-ui/lib/align';
import Portal from 'choerodon-ui/lib/rc-components/util/Portal';
import { getProPrefixCls } from 'choerodon-ui/lib/configure';
import Animate from '../animate';
import ViewComponent from '../core/ViewComponent';
import PopupInner from './PopupInner';
import autobind from '../_util/autobind';
let popupContainer;
/**
 * 记录ID生成器
 */
const PopupKeyGen = (function* (start) {
    while (true) {
        yield `popup-key-${start++}`;
    }
})(1);
export default class Popup extends ViewComponent {
    constructor() {
        super(...arguments);
        this.contentRendered = false;
        this.popupKey = PopupKeyGen.next().value;
        this.saveRef = align => (this.align = align);
    }
    getOtherProps() {
        const otherProps = omit(super.getOtherProps(), [
            'align',
            'transitionName',
            'getRootDomNode',
            'getPopupContainer',
            'getClassNameFromAlign',
            'getStyleFromAlign',
            'onAlign',
            'onAnimateAppear',
            'onAnimateEnter',
            'onAnimateLeave',
            'onAnimateEnd',
        ]);
        return otherProps;
    }
    render() {
        const { hidden, align, transitionName, getRootDomNode, children, onAnimateAppear = noop, onAnimateEnter = noop, onAnimateLeave = noop, onAnimateEnd = noop, } = this.props;
        if (!hidden) {
            this.contentRendered = true;
        }
        return this.contentRendered ? (React.createElement(Portal, { key: this.popupKey, getContainer: this.getContainer },
            React.createElement(Animate, { component: "", exclusive: true, transitionAppear: true, transitionName: transitionName, hiddenProp: "hidden", onAppear: onAnimateAppear, onEnter: onAnimateEnter, onLeave: onAnimateLeave, onEnd: onAnimateEnd },
                React.createElement(Align, { ref: this.saveRef, key: "align", childrenProps: { hidden: 'hidden' }, align: align, onAlign: this.onAlign, target: getRootDomNode, hidden: hidden, monitorWindowResize: true },
                    React.createElement(PopupInner, Object.assign({}, omit(this.getMergedProps(), ['ref'])), children))))) : null;
    }
    getContainer() {
        const { getPopupContainer, getRootDomNode = noop } = this.props;
        if (typeof window !== 'undefined') {
            const doc = window.document;
            popupContainer = doc.createElement('div');
            popupContainer.className = ClassNames(getProPrefixCls('popup-container'));
            const mountNode = getPopupContainer ? getPopupContainer(getRootDomNode()) : doc.body;
            if (isElement(mountNode)) {
                mountNode.appendChild(popupContainer);
            }
            else {
                doc.body.appendChild(popupContainer);
            }
        }
        return popupContainer;
    }
    onAlign(source, align, target) {
        const { getClassNameFromAlign = noop, getStyleFromAlign = noop, onAlign = noop } = this.props;
        const currentAlignClassName = getClassNameFromAlign(align);
        if (this.currentAlignClassName !== currentAlignClassName) {
            this.currentAlignClassName = currentAlignClassName;
            source.className = this.getMergedClassNames(currentAlignClassName);
        }
        const currentAlignStyle = getStyleFromAlign(target, align);
        if (!shallowEqual(this.currentAlignStyle, currentAlignStyle)) {
            this.currentAlignStyle = currentAlignStyle;
            Object.assign(source.style, currentAlignStyle);
        }
        onAlign(source, align, target);
    }
    forceAlign() {
        if (this.align) {
            this.align.forceAlign();
        }
    }
}
Popup.displayName = 'Popup';
Popup.propTypes = {
    align: PropTypes.object,
    onAlign: PropTypes.func,
    getRootDomNode: PropTypes.func,
    getPopupContainer: PropTypes.func,
    transitionName: PropTypes.string,
    onAnimateAppear: PropTypes.func,
    onAnimateEnter: PropTypes.func,
    onAnimateLeave: PropTypes.func,
    onAnimateEnd: PropTypes.func,
    getStyleFromAlign: PropTypes.func,
    getClassNameFromAlign: PropTypes.func,
    ...ViewComponent.propTypes,
};
Popup.defaultProps = {
    suffixCls: 'popup',
    transitionName: 'zoom',
};
__decorate([
    autobind
], Popup.prototype, "getContainer", null);
__decorate([
    autobind
], Popup.prototype, "onAlign", null);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RyaWdnZXIvUG9wdXAudHN4IiwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQTZCLE1BQU0sT0FBTyxDQUFDO0FBQ2xELE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQztBQUNuQyxPQUFPLElBQUksTUFBTSxhQUFhLENBQUM7QUFDL0IsT0FBTyxZQUFZLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxJQUFJLE1BQU0sYUFBYSxDQUFDO0FBQy9CLE9BQU8sU0FBUyxNQUFNLGtCQUFrQixDQUFDO0FBQ3pDLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQTtBQUNuQyxPQUFPLEtBQUssTUFBTSx3QkFBd0IsQ0FBQztBQUMzQyxPQUFPLE1BQU0sTUFBTSw0Q0FBNEMsQ0FBQztBQUNoRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBQ2pDLE9BQU8sYUFBcUMsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRSxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFDdEMsT0FBTyxRQUFRLE1BQU0sbUJBQW1CLENBQUM7QUFFekMsSUFBSSxjQUFjLENBQUM7QUFFbkI7O0dBRUc7QUFDSCxNQUFNLFdBQVcsR0FBNkIsQ0FBQyxRQUFRLENBQUMsRUFBQyxLQUFhO0lBQ3BFLE9BQU8sSUFBSSxFQUFFO1FBQ1gsTUFBTSxhQUFhLEtBQUssRUFBRSxFQUFFLENBQUM7S0FDOUI7QUFDSCxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQWdCTixNQUFNLENBQUMsT0FBTyxPQUFPLEtBQU0sU0FBUSxhQUF5QjtJQUE1RDs7UUE2QkUsb0JBQWUsR0FBWSxLQUFLLENBQUM7UUFFakMsYUFBUSxHQUFXLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUM7UUFFNUMsWUFBTyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FB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LEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDaEMsZUFBZSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQy9CLGNBQWMsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUM5QixjQUFjLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDOUIsWUFBWSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzVCLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQ2pDLHFCQUFxQixFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQ3JDLEdBQUcsYUFBYSxDQUFDLFNBQVM7Q0FDM0IsQ0FBQztBQUVLLGtCQUFZLEdBQUc7SUFDcEIsU0FBUyxFQUFFLE9BQU87SUFDbEIsY0FBYyxFQUFFLE1BQU07Q0FDdkIsQ0FBQztBQWtGRjtJQURDLFFBQVE7eUNBZVI7QUFHRDtJQURDLFFBQVE7b0NBY1IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RyaWdnZXIvUG9wdXAudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDU1NQcm9wZXJ0aWVzLCBLZXkgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IG9taXQgZnJvbSAnbG9kYXNoL29taXQnO1xuaW1wb3J0IHNoYWxsb3dFcXVhbCBmcm9tICdsb2Rhc2gvaXNFcXVhbCc7XG5pbXBvcnQgbm9vcCBmcm9tICdsb2Rhc2gvbm9vcCc7XG5pbXBvcnQgaXNFbGVtZW50IGZyb20gJ2xvZGFzaC9pc0VsZW1lbnQnO1xuaW1wb3J0IENsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcydcbmltcG9ydCBBbGlnbiBmcm9tICdjaG9lcm9kb24tdWkvbGliL2FsaWduJztcbmltcG9ydCBQb3J0YWwgZnJvbSAnY2hvZXJvZG9uLXVpL2xpYi9yYy1jb21wb25lbnRzL3V0aWwvUG9ydGFsJztcbmltcG9ydCB7IGdldFByb1ByZWZpeENscyB9IGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvY29uZmlndXJlJztcbmltcG9ydCBBbmltYXRlIGZyb20gJy4uL2FuaW1hdGUnO1xuaW1wb3J0IFZpZXdDb21wb25lbnQsIHsgVmlld0NvbXBvbmVudFByb3BzIH0gZnJvbSAnLi4vY29yZS9WaWV3Q29tcG9uZW50JztcbmltcG9ydCBQb3B1cElubmVyIGZyb20gJy4vUG9wdXBJbm5lcic7XG5pbXBvcnQgYXV0b2JpbmQgZnJvbSAnLi4vX3V0aWwvYXV0b2JpbmQnO1xuXG5sZXQgcG9wdXBDb250YWluZXI7XG5cbi8qKlxuICog6K6w5b2VSUTnlJ/miJDlmahcbiAqL1xuY29uc3QgUG9wdXBLZXlHZW46IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiA9IChmdW5jdGlvbiooc3RhcnQ6IG51bWJlcikge1xuICB3aGlsZSAodHJ1ZSkge1xuICAgIHlpZWxkIGBwb3B1cC1rZXktJHtzdGFydCsrfWA7XG4gIH1cbn0pKDEpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFBvcHVwUHJvcHMgZXh0ZW5kcyBWaWV3Q29tcG9uZW50UHJvcHMge1xuICBhbGlnbjogb2JqZWN0O1xuICBvbkFsaWduPzogKHNvdXJjZTogTm9kZSwgYWxpZ246IG9iamVjdCwgdGFyZ2V0OiBOb2RlIHwgV2luZG93KSA9PiB2b2lkO1xuICBnZXRSb290RG9tTm9kZT86ICgpID0+IE5vZGU7XG4gIGdldFBvcHVwQ29udGFpbmVyPzogKHRyaWdnZXJOb2RlOiBFbGVtZW50KSA9PiBIVE1MRWxlbWVudDtcbiAgdHJhbnNpdGlvbk5hbWU/OiBzdHJpbmc7XG4gIG9uQW5pbWF0ZUFwcGVhcj86IChrZXk6IEtleSB8IG51bGwpID0+IHZvaWQ7XG4gIG9uQW5pbWF0ZUVudGVyPzogKGtleTogS2V5IHwgbnVsbCkgPT4gdm9pZDtcbiAgb25BbmltYXRlTGVhdmU/OiAoa2V5OiBLZXkgfCBudWxsKSA9PiB2b2lkO1xuICBvbkFuaW1hdGVFbmQ/OiAoa2V5OiBLZXkgfCBudWxsLCBleGlzdHM6IGJvb2xlYW4pID0+IHZvaWQ7XG4gIGdldFN0eWxlRnJvbUFsaWduPzogKHRhcmdldDogTm9kZSB8IFdpbmRvdywgYWxpZ246IG9iamVjdCkgPT4gb2JqZWN0IHwgdW5kZWZpbmVkO1xuICBnZXRDbGFzc05hbWVGcm9tQWxpZ24/OiAoYWxpZ246IG9iamVjdCkgPT4gc3RyaW5nIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQb3B1cCBleHRlbmRzIFZpZXdDb21wb25lbnQ8UG9wdXBQcm9wcz4ge1xuICBzdGF0aWMgZGlzcGxheU5hbWUgPSAnUG9wdXAnO1xuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgYWxpZ246IFByb3BUeXBlcy5vYmplY3QsXG4gICAgb25BbGlnbjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgZ2V0Um9vdERvbU5vZGU6IFByb3BUeXBlcy5mdW5jLFxuICAgIGdldFBvcHVwQ29udGFpbmVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICB0cmFuc2l0aW9uTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvbkFuaW1hdGVBcHBlYXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uQW5pbWF0ZUVudGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkFuaW1hdGVMZWF2ZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25BbmltYXRlRW5kOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBnZXRTdHlsZUZyb21BbGlnbjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgZ2V0Q2xhc3NOYW1lRnJvbUFsaWduOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAuLi5WaWV3Q29tcG9uZW50LnByb3BUeXBlcyxcbiAgfTtcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIHN1ZmZpeENsczogJ3BvcHVwJyxcbiAgICB0cmFuc2l0aW9uTmFtZTogJ3pvb20nLFxuICB9O1xuXG4gIGN1cnJlbnRBbGlnbkNsYXNzTmFtZT86IHN0cmluZztcblxuICBjdXJyZW50QWxpZ25TdHlsZT86IENTU1Byb3BlcnRpZXM7XG5cbiAgYWxpZ246IEFsaWduIHwgbnVsbDtcblxuICBjb250ZW50UmVuZGVyZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwb3B1cEtleTogc3RyaW5nID0gUG9wdXBLZXlHZW4ubmV4dCgpLnZhbHVlO1xuXG4gIHNhdmVSZWYgPSBhbGlnbiA9PiAodGhpcy5hbGlnbiA9IGFsaWduKTtcblxuICBnZXRPdGhlclByb3BzKCkge1xuICAgIGNvbnN0IG90aGVyUHJvcHMgPSBvbWl0KHN1cGVyLmdldE90aGVyUHJvcHMoKSwgW1xuICAgICAgJ2FsaWduJyxcbiAgICAgICd0cmFuc2l0aW9uTmFtZScsXG4gICAgICAnZ2V0Um9vdERvbU5vZGUnLFxuICAgICAgJ2dldFBvcHVwQ29udGFpbmVyJyxcbiAgICAgICdnZXRDbGFzc05hbWVGcm9tQWxpZ24nLFxuICAgICAgJ2dldFN0eWxlRnJvbUFsaWduJyxcbiAgICAgICdvbkFsaWduJyxcbiAgICAgICdvbkFuaW1hdGVBcHBlYXInLFxuICAgICAgJ29uQW5pbWF0ZUVudGVyJyxcbiAgICAgICdvbkFuaW1hdGVMZWF2ZScsXG4gICAgICAnb25BbmltYXRlRW5kJyxcbiAgICBdKTtcbiAgICByZXR1cm4gb3RoZXJQcm9wcztcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBoaWRkZW4sXG4gICAgICBhbGlnbixcbiAgICAgIHRyYW5zaXRpb25OYW1lLFxuICAgICAgZ2V0Um9vdERvbU5vZGUsXG4gICAgICBjaGlsZHJlbixcbiAgICAgIG9uQW5pbWF0ZUFwcGVhciA9IG5vb3AsXG4gICAgICBvbkFuaW1hdGVFbnRlciA9IG5vb3AsXG4gICAgICBvbkFuaW1hdGVMZWF2ZSA9IG5vb3AsXG4gICAgICBvbkFuaW1hdGVFbmQgPSBub29wLFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmICghaGlkZGVuKSB7XG4gICAgICB0aGlzLmNvbnRlbnRSZW5kZXJlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuY29udGVudFJlbmRlcmVkID8gKFxuICAgICAgPFBvcnRhbFxuICAgICAgICBrZXk9e3RoaXMucG9wdXBLZXl9XG4gICAgICAgIGdldENvbnRhaW5lcj17dGhpcy5nZXRDb250YWluZXJ9XG4gICAgICA+XG4gICAgICAgIDxBbmltYXRlXG4gICAgICAgICAgY29tcG9uZW50PVwiXCJcbiAgICAgICAgICBleGNsdXNpdmVcbiAgICAgICAgICB0cmFuc2l0aW9uQXBwZWFyXG4gICAgICAgICAgdHJhbnNpdGlvbk5hbWU9e3RyYW5zaXRpb25OYW1lfVxuICAgICAgICAgIGhpZGRlblByb3A9XCJoaWRkZW5cIlxuICAgICAgICAgIG9uQXBwZWFyPXtvbkFuaW1hdGVBcHBlYXJ9XG4gICAgICAgICAgb25FbnRlcj17b25BbmltYXRlRW50ZXJ9XG4gICAgICAgICAgb25MZWF2ZT17b25BbmltYXRlTGVhdmV9XG4gICAgICAgICAgb25FbmQ9e29uQW5pbWF0ZUVuZH1cbiAgICAgICAgPlxuICAgICAgICAgIDxBbGlnblxuICAgICAgICAgICAgcmVmPXt0aGlzLnNhdmVSZWZ9XG4gICAgICAgICAgICBrZXk9XCJhbGlnblwiXG4gICAgICAgICAgICBjaGlsZHJlblByb3BzPXt7IGhpZGRlbjogJ2hpZGRlbicgfX1cbiAgICAgICAgICAgIGFsaWduPXthbGlnbn1cbiAgICAgICAgICAgIG9uQWxpZ249e3RoaXMub25BbGlnbn1cbiAgICAgICAgICAgIHRhcmdldD17Z2V0Um9vdERvbU5vZGV9XG4gICAgICAgICAgICBoaWRkZW49e2hpZGRlbn1cbiAgICAgICAgICAgIG1vbml0b3JXaW5kb3dSZXNpemVcbiAgICAgICAgICA+XG4gICAgICAgICAgICA8UG9wdXBJbm5lciB7Li4ub21pdCh0aGlzLmdldE1lcmdlZFByb3BzKCksIFsncmVmJ10pfT57Y2hpbGRyZW59PC9Qb3B1cElubmVyPlxuICAgICAgICAgIDwvQWxpZ24+XG4gICAgICAgIDwvQW5pbWF0ZT5cbiAgICAgIDwvUG9ydGFsPlxuICAgICkgOiBudWxsO1xuICB9XG5cblxuICBAYXV0b2JpbmRcbiAgZ2V0Q29udGFpbmVyKCkge1xuICAgIGNvbnN0IHsgZ2V0UG9wdXBDb250YWluZXIsIGdldFJvb3REb21Ob2RlID0gbm9vcCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNvbnN0IGRvYyA9IHdpbmRvdy5kb2N1bWVudDtcbiAgICAgIHBvcHVwQ29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgcG9wdXBDb250YWluZXIuY2xhc3NOYW1lID0gQ2xhc3NOYW1lcyhnZXRQcm9QcmVmaXhDbHMoJ3BvcHVwLWNvbnRhaW5lcicpKTtcbiAgICAgIGNvbnN0IG1vdW50Tm9kZSA9IGdldFBvcHVwQ29udGFpbmVyID8gZ2V0UG9wdXBDb250YWluZXIoZ2V0Um9vdERvbU5vZGUoKSkgOiBkb2MuYm9keTtcbiAgICAgIGlmIChpc0VsZW1lbnQobW91bnROb2RlKSkge1xuICAgICAgICBtb3VudE5vZGUuYXBwZW5kQ2hpbGQocG9wdXBDb250YWluZXIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQocG9wdXBDb250YWluZXIpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcG9wdXBDb250YWluZXI7XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgb25BbGlnbihzb3VyY2UsIGFsaWduLCB0YXJnZXQpIHtcbiAgICBjb25zdCB7IGdldENsYXNzTmFtZUZyb21BbGlnbiA9IG5vb3AsIGdldFN0eWxlRnJvbUFsaWduID0gbm9vcCwgb25BbGlnbiA9IG5vb3AgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY3VycmVudEFsaWduQ2xhc3NOYW1lID0gZ2V0Q2xhc3NOYW1lRnJvbUFsaWduKGFsaWduKTtcbiAgICBpZiAodGhpcy5jdXJyZW50QWxpZ25DbGFzc05hbWUgIT09IGN1cnJlbnRBbGlnbkNsYXNzTmFtZSkge1xuICAgICAgdGhpcy5jdXJyZW50QWxpZ25DbGFzc05hbWUgPSBjdXJyZW50QWxpZ25DbGFzc05hbWU7XG4gICAgICBzb3VyY2UuY2xhc3NOYW1lID0gdGhpcy5nZXRNZXJnZWRDbGFzc05hbWVzKGN1cnJlbnRBbGlnbkNsYXNzTmFtZSk7XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRBbGlnblN0eWxlID0gZ2V0U3R5bGVGcm9tQWxpZ24odGFyZ2V0LCBhbGlnbik7XG4gICAgaWYgKCFzaGFsbG93RXF1YWwodGhpcy5jdXJyZW50QWxpZ25TdHlsZSwgY3VycmVudEFsaWduU3R5bGUpKSB7XG4gICAgICB0aGlzLmN1cnJlbnRBbGlnblN0eWxlID0gY3VycmVudEFsaWduU3R5bGU7XG4gICAgICBPYmplY3QuYXNzaWduKHNvdXJjZS5zdHlsZSwgY3VycmVudEFsaWduU3R5bGUpO1xuICAgIH1cbiAgICBvbkFsaWduKHNvdXJjZSwgYWxpZ24sIHRhcmdldCk7XG4gIH1cblxuICBmb3JjZUFsaWduKCkge1xuICAgIGlmICh0aGlzLmFsaWduKSB7XG4gICAgICB0aGlzLmFsaWduLmZvcmNlQWxpZ24oKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==