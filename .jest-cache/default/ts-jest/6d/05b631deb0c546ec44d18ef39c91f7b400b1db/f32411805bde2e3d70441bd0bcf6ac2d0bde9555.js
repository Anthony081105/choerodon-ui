import React, { Component } from 'react';
import classNames from 'classnames';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';
import Icon from '../icon';
import Tooltip from '../tooltip';
import Progress from '../progress';
import Animate from '../animate';
import { getPrefixCls } from '../configure';
import { previewImage } from './utils';
const isImageUrl = (url) => {
    return /^data:image\//.test(url) || /\.(webp|svg|png|gif|jpg|jpeg)$/.test(url);
};
// a little function to help us with reordering the result
const reorder = (list, startIndex, endIndex) => {
    const result = Array.from(list);
    const [removed] = result.splice(startIndex, 1);
    result.splice(endIndex, 0, removed);
    return result;
};
export default class UploadList extends Component {
    constructor() {
        super(...arguments);
        this.handleClose = (file) => {
            const { onRemove } = this.props;
            if (onRemove) {
                onRemove(file);
            }
        };
        this.handlePreview = (file, e) => {
            const { onPreview } = this.props;
            if (!onPreview) {
                return;
            }
            e.preventDefault();
            return onPreview(file);
        };
        /**
         * 拖拽事件
         * @param result
         */
        this.onDragEnd = (result) => {
            const { items, onDragEnd } = this.props;
            // dropped outside the list
            if (!result.destination) {
                return;
            }
            const dragItems = reorder(items, result.source.index, result.destination.index);
            onDragEnd(dragItems);
        };
    }
    componentDidUpdate() {
        const { listType, items, previewFile } = this.props;
        if (listType !== 'picture' && listType !== 'picture-card') {
            return;
        }
        (items || []).forEach(file => {
            if (typeof document === 'undefined' ||
                typeof window === 'undefined' ||
                !window.FileReader ||
                !window.File ||
                !(file.originFileObj instanceof File || file.originFileObj instanceof Blob) ||
                file.thumbUrl !== undefined) {
                return;
            }
            file.thumbUrl = '';
            if (previewFile) {
                previewFile(file.originFileObj).then((previewDataUrl) => {
                    // Need append '' to avoid dead loop
                    file.thumbUrl = previewDataUrl || '';
                    this.forceUpdate();
                });
            }
        });
    }
    render() {
        const { prefixCls: customizePrefixCls, items = [], listType, showPreviewIcon, showRemoveIcon, locale, dragUploadList, } = this.props;
        const prefixCls = getPrefixCls('upload', customizePrefixCls);
        const list = items.map((file, index) => {
            let progress;
            let icon = React.createElement(Icon, { type: file.status === 'uploading' ? 'loading' : 'attach_file' });
            if (listType === 'picture' || listType === 'picture-card') {
                if (listType === 'picture-card' && file.status === 'uploading') {
                    icon = React.createElement("div", { className: `${prefixCls}-list-item-uploading-text` }, locale.uploading);
                }
                else if (!file.thumbUrl && !file.url) {
                    icon = React.createElement(Icon, { className: `${prefixCls}-list-item-thumbnail`, type: "picture" });
                }
                else {
                    const thumbnail = isImageUrl((file.thumbUrl || file.url)) ? (React.createElement("img", { src: file.thumbUrl || file.url, alt: file.name })) : (React.createElement(Icon, { type: "file", style: { fontSize: 48, color: 'rgba(0,0,0,0.5)' } }));
                    icon = (React.createElement("a", { className: `${prefixCls}-list-item-thumbnail`, onClick: e => this.handlePreview(file, e), href: file.url || file.thumbUrl, target: "_blank", rel: "noopener noreferrer" }, thumbnail));
                }
            }
            if (file.status === 'uploading') {
                const { progressAttr } = this.props;
                // show loading icon if upload progress listener is disabled
                const loadingProgress = 'percent' in file ? (React.createElement(Progress, Object.assign({ type: "line" /* line */ }, progressAttr, { percent: file.percent }))) : null;
                progress = (React.createElement("div", { className: `${prefixCls}-list-item-progress`, key: "progress" }, loadingProgress));
            }
            const infoUploadingClass = classNames({
                [`${prefixCls}-list-item`]: true,
                [`${prefixCls}-list-item-${file.status}`]: true,
            });
            const preview = file.url ? (React.createElement("a", Object.assign({}, file.linkProps, { href: file.url, target: "_blank", rel: "noopener noreferrer", className: `${prefixCls}-list-item-name`, onClick: e => this.handlePreview(file, e), title: file.name }), file.name)) : (React.createElement("span", { className: `${prefixCls}-list-item-name`, onClick: e => this.handlePreview(file, e), title: file.name }, file.name));
            const style = file.url || file.thumbUrl
                ? undefined
                : {
                    pointerEvents: 'none',
                    opacity: 0.5,
                };
            const previewIcon = showPreviewIcon ? (React.createElement("a", { href: file.url || file.thumbUrl, target: "_blank", rel: "noopener noreferrer", style: style, onClick: e => this.handlePreview(file, e), title: locale.previewFile },
                React.createElement(Icon, { type: "visibility" }))) : null;
            const removeIcon = showRemoveIcon ? (React.createElement(Icon, { type: "delete", title: locale.removeFile, onClick: () => this.handleClose(file) })) : null;
            const removeIconCross = showRemoveIcon ? (React.createElement(Icon, { type: "close", title: locale.removeFile, onClick: () => this.handleClose(file) })) : null;
            const actions = listType === 'picture-card' && file.status !== 'uploading' ? (React.createElement("span", { className: `${prefixCls}-list-item-actions` },
                previewIcon,
                removeIcon)) : (removeIconCross);
            let message;
            if (file.response && typeof file.response === 'string') {
                message = file.response;
            }
            else {
                message = (file.error && file.error.statusText) || locale.uploadError;
            }
            const iconAndPreview = file.status === 'error' ? (React.createElement(Tooltip, { title: message },
                icon,
                preview)) : (React.createElement("span", null,
                icon,
                preview));
            if (dragUploadList) {
                return (React.createElement(Draggable, { key: file.uid, draggableId: String(file.uid), index: index }, provided => (React.createElement("div", Object.assign({ className: infoUploadingClass, key: file.uid, ref: provided.innerRef }, provided.draggableProps, provided.dragHandleProps),
                    React.createElement("div", { className: `${prefixCls}-list-item-info` }, iconAndPreview),
                    actions,
                    React.createElement(Animate, { transitionName: "fade", component: "" }, progress)))));
            }
            return (React.createElement("div", { className: infoUploadingClass, key: file.uid },
                React.createElement("div", { className: `${prefixCls}-list-item-info` }, iconAndPreview),
                actions,
                React.createElement(Animate, { transitionName: "fade", component: "" }, progress)));
        });
        const listClassNames = classNames({
            [`${prefixCls}-list`]: true,
            [`${prefixCls}-list-${listType}`]: true,
            [`${prefixCls}-list-drag`]: dragUploadList,
        });
        const animationDirection = listType === 'picture-card' ? 'animate-inline' : 'animate';
        if (dragUploadList) {
            return (React.createElement(DragDropContext, { onDragEnd: this.onDragEnd },
                React.createElement(Droppable, { droppableId: "droppable", direction: "horizontal" }, (provided, snapshot) => (React.createElement("div", Object.assign({ ref: provided.innerRef, style: {
                        background: snapshot.isDraggingOver ? '#f2f9f4' : '',
                        border: snapshot.isDraggingOver ? '2px dashed #1ab16f' : '',
                        display: 'inline-flex',
                        maxWidth: '100%',
                        flexWrap: 'wrap',
                        overflow: 'auto',
                    } }, provided.droppableProps, { className: listClassNames }),
                    list,
                    provided.placeholder)))));
        }
        return (React.createElement(Animate, { transitionName: `${prefixCls}-${animationDirection}`, component: "div", className: listClassNames }, list));
    }
}
UploadList.displayName = 'UploadList';
UploadList.defaultProps = {
    listType: 'text',
    progressAttr: {
        strokeWidth: 2,
        showInfo: false,
    },
    previewFile: previewImage,
    showRemoveIcon: true,
    showPreviewIcon: true,
    dragUploadList: false,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdXBsb2FkL1VwbG9hZExpc3QudHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFpQyxNQUFNLE9BQU8sQ0FBQztBQUN4RSxPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUUsT0FBTyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBQzNCLE9BQU8sT0FBTyxNQUFNLFlBQVksQ0FBQztBQUNqQyxPQUFPLFFBQVEsTUFBTSxhQUFhLENBQUM7QUFFbkMsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBRWpDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUV2QyxNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQVcsRUFBVyxFQUFFO0lBQzFDLE9BQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxnQ0FBZ0MsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDakYsQ0FBQyxDQUFDO0FBRUYsMERBQTBEO0FBQzFELE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQWdCLEVBQUU7SUFDM0QsTUFBTSxNQUFNLEdBQWlCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUVwQyxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxPQUFPLFVBQVcsU0FBUSxTQUErQjtJQUF2RTs7UUFlRSxnQkFBVyxHQUFHLENBQUMsSUFBZ0IsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2hDLElBQUksUUFBUSxFQUFFO2dCQUNaLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQjtRQUNILENBQUMsQ0FBQztRQUVGLGtCQUFhLEdBQUcsQ0FBQyxJQUFnQixFQUFFLENBQThCLEVBQUUsRUFBRTtZQUNuRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNqQyxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNkLE9BQU87YUFDUjtZQUNELENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNuQixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUM7UUE2QkY7OztXQUdHO1FBQ0gsY0FBUyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDckIsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3hDLDJCQUEyQjtZQUMzQixJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtnQkFDdkIsT0FBTzthQUNSO1lBRUQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUN2QixLQUFLLEVBQ0wsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQ25CLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUN6QixDQUFDO1lBRUYsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQztJQWdOSixDQUFDO0lBN1BDLGtCQUFrQjtRQUNoQixNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3BELElBQUksUUFBUSxLQUFLLFNBQVMsSUFBSSxRQUFRLEtBQUssY0FBYyxFQUFFO1lBQ3pELE9BQU87U0FDUjtRQUNELENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMzQixJQUNFLE9BQU8sUUFBUSxLQUFLLFdBQVc7Z0JBQy9CLE9BQU8sTUFBTSxLQUFLLFdBQVc7Z0JBQzdCLENBQUUsTUFBYyxDQUFDLFVBQVU7Z0JBQzNCLENBQUUsTUFBYyxDQUFDLElBQUk7Z0JBQ3JCLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxZQUFZLElBQUksSUFBSSxJQUFJLENBQUMsYUFBYSxZQUFZLElBQUksQ0FBQztnQkFDM0UsSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQzNCO2dCQUNBLE9BQU87YUFDUjtZQUNELElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBQ25CLElBQUksV0FBVyxFQUFFO2dCQUNmLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQXNCLEVBQUUsRUFBRTtvQkFDdEUsb0NBQW9DO29CQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLGNBQWMsSUFBSSxFQUFFLENBQUM7b0JBQ3JDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDckIsQ0FBQyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQXNCRCxNQUFNO1FBQ0osTUFBTSxFQUNKLFNBQVMsRUFBRSxrQkFBa0IsRUFDN0IsS0FBSyxHQUFHLEVBQUUsRUFDVixRQUFRLEVBQ1IsZUFBZSxFQUNmLGNBQWMsRUFDZCxNQUFNLEVBQ04sY0FBYyxHQUNmLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNmLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxRQUFRLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUM3RCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksUUFBUSxDQUFDO1lBQ2IsSUFBSSxJQUFJLEdBQUcsb0JBQUMsSUFBSSxJQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxhQUFhLEdBQUksQ0FBQztZQUVuRixJQUFJLFFBQVEsS0FBSyxTQUFTLElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtnQkFDekQsSUFBSSxRQUFRLEtBQUssY0FBYyxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssV0FBVyxFQUFFO29CQUM5RCxJQUFJLEdBQUcsNkJBQUssU0FBUyxFQUFFLEdBQUcsU0FBUywyQkFBMkIsSUFBRyxNQUFNLENBQUMsU0FBUyxDQUFPLENBQUM7aUJBQzFGO3FCQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDdEMsSUFBSSxHQUFHLG9CQUFDLElBQUksSUFBQyxTQUFTLEVBQUUsR0FBRyxTQUFTLHNCQUFzQixFQUFFLElBQUksRUFBQyxTQUFTLEdBQUcsQ0FBQztpQkFDL0U7cUJBQU07b0JBQ0wsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDcEUsNkJBQUssR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLElBQUksR0FBSSxDQUN4RCxDQUFDLENBQUMsQ0FBQyxDQUNGLG9CQUFDLElBQUksSUFBQyxJQUFJLEVBQUMsTUFBTSxFQUFDLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLEdBQUksQ0FDeEUsQ0FBQztvQkFDRixJQUFJLEdBQUcsQ0FDTCwyQkFDRSxTQUFTLEVBQUUsR0FBRyxTQUFTLHNCQUFzQixFQUM3QyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFDekMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsRUFDL0IsTUFBTSxFQUFDLFFBQVEsRUFDZixHQUFHLEVBQUMscUJBQXFCLElBRXhCLFNBQVMsQ0FDUixDQUNMLENBQUM7aUJBQ0g7YUFDRjtZQUVELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxXQUFXLEVBQUU7Z0JBQy9CLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNwQyw0REFBNEQ7Z0JBQzVELE1BQU0sZUFBZSxHQUNuQixTQUFTLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNsQixvQkFBQyxRQUFRLGtCQUFDLElBQUksdUJBQXlCLFlBQVksSUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUMvRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBRVgsUUFBUSxHQUFHLENBQ1QsNkJBQUssU0FBUyxFQUFFLEdBQUcsU0FBUyxxQkFBcUIsRUFBRSxHQUFHLEVBQUMsVUFBVSxJQUM5RCxlQUFlLENBQ1osQ0FDUCxDQUFDO2FBQ0g7WUFDRCxNQUFNLGtCQUFrQixHQUFHLFVBQVUsQ0FBQztnQkFDcEMsQ0FBQyxHQUFHLFNBQVMsWUFBWSxDQUFDLEVBQUUsSUFBSTtnQkFDaEMsQ0FBQyxHQUFHLFNBQVMsY0FBYyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxJQUFJO2FBQ2hELENBQUMsQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQ3pCLDJDQUNNLElBQUksQ0FBQyxTQUFTLElBQ2xCLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxFQUNkLE1BQU0sRUFBQyxRQUFRLEVBQ2YsR0FBRyxFQUFDLHFCQUFxQixFQUN6QixTQUFTLEVBQUUsR0FBRyxTQUFTLGlCQUFpQixFQUN4QyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFDekMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLEtBRWYsSUFBSSxDQUFDLElBQUksQ0FDUixDQUNMLENBQUMsQ0FBQyxDQUFDLENBQ0YsOEJBQ0UsU0FBUyxFQUFFLEdBQUcsU0FBUyxpQkFBaUIsRUFDeEMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQ3pDLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxJQUVmLElBQUksQ0FBQyxJQUFJLENBQ0wsQ0FDUixDQUFDO1lBQ0YsTUFBTSxLQUFLLEdBQ1QsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsUUFBUTtnQkFDdkIsQ0FBQyxDQUFDLFNBQVM7Z0JBQ1gsQ0FBQyxDQUFFO29CQUNDLGFBQWEsRUFBRSxNQUFNO29CQUNyQixPQUFPLEVBQUUsR0FBRztpQkFDSyxDQUFDO1lBQzFCLE1BQU0sV0FBVyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FDcEMsMkJBQ0UsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsRUFDL0IsTUFBTSxFQUFDLFFBQVEsRUFDZixHQUFHLEVBQUMscUJBQXFCLEVBQ3pCLEtBQUssRUFBRSxLQUFLLEVBQ1osT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQ3pDLEtBQUssRUFBRSxNQUFNLENBQUMsV0FBVztnQkFFekIsb0JBQUMsSUFBSSxJQUFDLElBQUksRUFBQyxZQUFZLEdBQUcsQ0FDeEIsQ0FDTCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDVCxNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQ2xDLG9CQUFDLElBQUksSUFBQyxJQUFJLEVBQUMsUUFBUSxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFJLENBQ3hGLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNULE1BQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FDdkMsb0JBQUMsSUFBSSxJQUFDLElBQUksRUFBQyxPQUFPLEVBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUksQ0FDdkYsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ1QsTUFBTSxPQUFPLEdBQ1gsUUFBUSxLQUFLLGNBQWMsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FDM0QsOEJBQU0sU0FBUyxFQUFFLEdBQUcsU0FBUyxvQkFBb0I7Z0JBQzlDLFdBQVc7Z0JBQ1gsVUFBVSxDQUNOLENBQ1IsQ0FBQyxDQUFDLENBQUMsQ0FDRixlQUFlLENBQ2hCLENBQUM7WUFDSixJQUFJLE9BQU8sQ0FBQztZQUNaLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxPQUFPLElBQUksQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO2dCQUN0RCxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQzthQUN6QjtpQkFBTTtnQkFDTCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQzthQUN2RTtZQUNELE1BQU0sY0FBYyxHQUNsQixJQUFJLENBQUMsTUFBTSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FDeEIsb0JBQUMsT0FBTyxJQUFDLEtBQUssRUFBRSxPQUFPO2dCQUNwQixJQUFJO2dCQUNKLE9BQU8sQ0FDQSxDQUNYLENBQUMsQ0FBQyxDQUFDLENBQ0Y7Z0JBQ0csSUFBSTtnQkFDSixPQUFPLENBQ0gsQ0FDUixDQUFDO1lBRUosSUFBSSxjQUFjLEVBQUU7Z0JBQ2xCLE9BQU8sQ0FDTCxvQkFBQyxTQUFTLElBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssSUFDbEUsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUNYLDJDQUNFLFNBQVMsRUFBRSxrQkFBa0IsRUFDN0IsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQ2IsR0FBRyxFQUFFLFFBQVEsQ0FBQyxRQUFRLElBQ2xCLFFBQVEsQ0FBQyxjQUFjLEVBQ3ZCLFFBQVEsQ0FBQyxlQUFlO29CQUU1Qiw2QkFBSyxTQUFTLEVBQUUsR0FBRyxTQUFTLGlCQUFpQixJQUFHLGNBQWMsQ0FBTztvQkFDcEUsT0FBTztvQkFDUixvQkFBQyxPQUFPLElBQUMsY0FBYyxFQUFDLE1BQU0sRUFBQyxTQUFTLEVBQUMsRUFBRSxJQUN4QyxRQUFRLENBQ0QsQ0FDTixDQUNQLENBQ1MsQ0FDYixDQUFDO2FBQ0g7WUFFRCxPQUFPLENBQ0wsNkJBQUssU0FBUyxFQUFFLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRztnQkFDL0MsNkJBQUssU0FBUyxFQUFFLEdBQUcsU0FBUyxpQkFBaUIsSUFBRyxjQUFjLENBQU87Z0JBQ3BFLE9BQU87Z0JBQ1Isb0JBQUMsT0FBTyxJQUFDLGNBQWMsRUFBQyxNQUFNLEVBQUMsU0FBUyxFQUFDLEVBQUUsSUFDeEMsUUFBUSxDQUNELENBQ04sQ0FDUCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUM7WUFDaEMsQ0FBQyxHQUFHLFNBQVMsT0FBTyxDQUFDLEVBQUUsSUFBSTtZQUMzQixDQUFDLEdBQUcsU0FBUyxTQUFTLFFBQVEsRUFBRSxDQUFDLEVBQUUsSUFBSTtZQUN2QyxDQUFDLEdBQUcsU0FBUyxZQUFZLENBQUMsRUFBRSxjQUFjO1NBQzNDLENBQUMsQ0FBQztRQUNILE1BQU0sa0JBQWtCLEdBQUcsUUFBUSxLQUFLLGNBQWMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUN0RixJQUFJLGNBQWMsRUFBRTtZQUNsQixPQUFPLENBQ0wsb0JBQUMsZUFBZSxJQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztnQkFDeEMsb0JBQUMsU0FBUyxJQUFDLFdBQVcsRUFBQyxXQUFXLEVBQUMsU0FBUyxFQUFDLFlBQVksSUFDdEQsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUN2QiwyQ0FDRSxHQUFHLEVBQUUsUUFBUSxDQUFDLFFBQVEsRUFDdEIsS0FBSyxFQUFFO3dCQUNMLFVBQVUsRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ3BELE1BQU0sRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDM0QsT0FBTyxFQUFFLGFBQWE7d0JBQ3RCLFFBQVEsRUFBRSxNQUFNO3dCQUNoQixRQUFRLEVBQUUsTUFBTTt3QkFDaEIsUUFBUSxFQUFFLE1BQU07cUJBQ2pCLElBQ0csUUFBUSxDQUFDLGNBQWMsSUFDM0IsU0FBUyxFQUFFLGNBQWM7b0JBRXhCLElBQUk7b0JBQ0osUUFBUSxDQUFDLFdBQVcsQ0FDakIsQ0FDUCxDQUNTLENBQ0ksQ0FDbkIsQ0FBQztTQUNIO1FBQ0QsT0FBTyxDQUNMLG9CQUFDLE9BQU8sSUFDTixjQUFjLEVBQUUsR0FBRyxTQUFTLElBQUksa0JBQWtCLEVBQUUsRUFDcEQsU0FBUyxFQUFDLEtBQUssRUFDZixTQUFTLEVBQUUsY0FBYyxJQUV4QixJQUFJLENBQ0csQ0FDWCxDQUFDO0lBQ0osQ0FBQzs7QUExUk0sc0JBQVcsR0FBRyxZQUFZLENBQUM7QUFFM0IsdUJBQVksR0FBRztJQUNwQixRQUFRLEVBQUUsTUFBTTtJQUNoQixZQUFZLEVBQUU7UUFDWixXQUFXLEVBQUUsQ0FBQztRQUNkLFFBQVEsRUFBRSxLQUFLO0tBQ2hCO0lBQ0QsV0FBVyxFQUFFLFlBQVk7SUFDekIsY0FBYyxFQUFFLElBQUk7SUFDcEIsZUFBZSxFQUFFLElBQUk7SUFDckIsY0FBYyxFQUFFLEtBQUs7Q0FDdEIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy91cGxvYWQvVXBsb2FkTGlzdC50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCwgQ1NTUHJvcGVydGllcywgU3ludGhldGljRXZlbnQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7IERyYWdEcm9wQ29udGV4dCwgRHJvcHBhYmxlLCBEcmFnZ2FibGUgfSBmcm9tICdyZWFjdC1iZWF1dGlmdWwtZG5kJztcbmltcG9ydCBJY29uIGZyb20gJy4uL2ljb24nO1xuaW1wb3J0IFRvb2x0aXAgZnJvbSAnLi4vdG9vbHRpcCc7XG5pbXBvcnQgUHJvZ3Jlc3MgZnJvbSAnLi4vcHJvZ3Jlc3MnO1xuaW1wb3J0IHsgVXBsb2FkRmlsZSwgVXBsb2FkTGlzdFByb3BzIH0gZnJvbSAnLi9pbnRlcmZhY2UnO1xuaW1wb3J0IEFuaW1hdGUgZnJvbSAnLi4vYW5pbWF0ZSc7XG5pbXBvcnQgeyBQcm9ncmVzc1R5cGUgfSBmcm9tICcuLi9wcm9ncmVzcy9lbnVtJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5pbXBvcnQgeyBwcmV2aWV3SW1hZ2UgfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgaXNJbWFnZVVybCA9ICh1cmw6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gL15kYXRhOmltYWdlXFwvLy50ZXN0KHVybCkgfHwgL1xcLih3ZWJwfHN2Z3xwbmd8Z2lmfGpwZ3xqcGVnKSQvLnRlc3QodXJsKTtcbn07XG5cbi8vIGEgbGl0dGxlIGZ1bmN0aW9uIHRvIGhlbHAgdXMgd2l0aCByZW9yZGVyaW5nIHRoZSByZXN1bHRcbmNvbnN0IHJlb3JkZXIgPSAobGlzdCwgc3RhcnRJbmRleCwgZW5kSW5kZXgpOiBVcGxvYWRGaWxlW10gPT4ge1xuICBjb25zdCByZXN1bHQ6IFVwbG9hZEZpbGVbXSA9IEFycmF5LmZyb20obGlzdCk7XG4gIGNvbnN0IFtyZW1vdmVkXSA9IHJlc3VsdC5zcGxpY2Uoc3RhcnRJbmRleCwgMSk7XG4gIHJlc3VsdC5zcGxpY2UoZW5kSW5kZXgsIDAsIHJlbW92ZWQpO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVcGxvYWRMaXN0IGV4dGVuZHMgQ29tcG9uZW50PFVwbG9hZExpc3RQcm9wcywgYW55PiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdVcGxvYWRMaXN0JztcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGxpc3RUeXBlOiAndGV4dCcsIC8vIG9yIHBpY3R1cmVcbiAgICBwcm9ncmVzc0F0dHI6IHtcbiAgICAgIHN0cm9rZVdpZHRoOiAyLFxuICAgICAgc2hvd0luZm86IGZhbHNlLFxuICAgIH0sXG4gICAgcHJldmlld0ZpbGU6IHByZXZpZXdJbWFnZSxcbiAgICBzaG93UmVtb3ZlSWNvbjogdHJ1ZSxcbiAgICBzaG93UHJldmlld0ljb246IHRydWUsXG4gICAgZHJhZ1VwbG9hZExpc3Q6IGZhbHNlLFxuICB9O1xuXG4gIGhhbmRsZUNsb3NlID0gKGZpbGU6IFVwbG9hZEZpbGUpID0+IHtcbiAgICBjb25zdCB7IG9uUmVtb3ZlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblJlbW92ZSkge1xuICAgICAgb25SZW1vdmUoZmlsZSk7XG4gICAgfVxuICB9O1xuXG4gIGhhbmRsZVByZXZpZXcgPSAoZmlsZTogVXBsb2FkRmlsZSwgZTogU3ludGhldGljRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiB7XG4gICAgY29uc3QgeyBvblByZXZpZXcgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFvblByZXZpZXcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHJldHVybiBvblByZXZpZXcoZmlsZSk7XG4gIH07XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIGNvbnN0IHsgbGlzdFR5cGUsIGl0ZW1zLCBwcmV2aWV3RmlsZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAobGlzdFR5cGUgIT09ICdwaWN0dXJlJyAmJiBsaXN0VHlwZSAhPT0gJ3BpY3R1cmUtY2FyZCcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgKGl0ZW1zIHx8IFtdKS5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICB0eXBlb2YgZG9jdW1lbnQgPT09ICd1bmRlZmluZWQnIHx8XG4gICAgICAgIHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnIHx8XG4gICAgICAgICEod2luZG93IGFzIGFueSkuRmlsZVJlYWRlciB8fFxuICAgICAgICAhKHdpbmRvdyBhcyBhbnkpLkZpbGUgfHxcbiAgICAgICAgIShmaWxlLm9yaWdpbkZpbGVPYmogaW5zdGFuY2VvZiBGaWxlIHx8IGZpbGUub3JpZ2luRmlsZU9iaiBpbnN0YW5jZW9mIEJsb2IpIHx8XG4gICAgICAgIGZpbGUudGh1bWJVcmwgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGZpbGUudGh1bWJVcmwgPSAnJztcbiAgICAgIGlmIChwcmV2aWV3RmlsZSkge1xuICAgICAgICBwcmV2aWV3RmlsZShmaWxlLm9yaWdpbkZpbGVPYmogYXMgRmlsZSkudGhlbigocHJldmlld0RhdGFVcmw6IHN0cmluZykgPT4ge1xuICAgICAgICAgIC8vIE5lZWQgYXBwZW5kICcnIHRvIGF2b2lkIGRlYWQgbG9vcFxuICAgICAgICAgIGZpbGUudGh1bWJVcmwgPSBwcmV2aWV3RGF0YVVybCB8fCAnJztcbiAgICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOaLluaLveS6i+S7tlxuICAgKiBAcGFyYW0gcmVzdWx0XG4gICAqL1xuICBvbkRyYWdFbmQgPSAocmVzdWx0KSA9PiB7XG4gICAgY29uc3QgeyBpdGVtcywgb25EcmFnRW5kIH0gPSB0aGlzLnByb3BzO1xuICAgIC8vIGRyb3BwZWQgb3V0c2lkZSB0aGUgbGlzdFxuICAgIGlmICghcmVzdWx0LmRlc3RpbmF0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZHJhZ0l0ZW1zID0gcmVvcmRlcihcbiAgICAgIGl0ZW1zLFxuICAgICAgcmVzdWx0LnNvdXJjZS5pbmRleCxcbiAgICAgIHJlc3VsdC5kZXN0aW5hdGlvbi5pbmRleCxcbiAgICApO1xuXG4gICAgb25EcmFnRW5kKGRyYWdJdGVtcyk7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHByZWZpeENsczogY3VzdG9taXplUHJlZml4Q2xzLFxuICAgICAgaXRlbXMgPSBbXSxcbiAgICAgIGxpc3RUeXBlLFxuICAgICAgc2hvd1ByZXZpZXdJY29uLFxuICAgICAgc2hvd1JlbW92ZUljb24sXG4gICAgICBsb2NhbGUsXG4gICAgICBkcmFnVXBsb2FkTGlzdCxcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSBnZXRQcmVmaXhDbHMoJ3VwbG9hZCcsIGN1c3RvbWl6ZVByZWZpeENscyk7XG4gICAgY29uc3QgbGlzdCA9IGl0ZW1zLm1hcCgoZmlsZSwgaW5kZXgpID0+IHtcbiAgICAgIGxldCBwcm9ncmVzcztcbiAgICAgIGxldCBpY29uID0gPEljb24gdHlwZT17ZmlsZS5zdGF0dXMgPT09ICd1cGxvYWRpbmcnID8gJ2xvYWRpbmcnIDogJ2F0dGFjaF9maWxlJ30gLz47XG5cbiAgICAgIGlmIChsaXN0VHlwZSA9PT0gJ3BpY3R1cmUnIHx8IGxpc3RUeXBlID09PSAncGljdHVyZS1jYXJkJykge1xuICAgICAgICBpZiAobGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnICYmIGZpbGUuc3RhdHVzID09PSAndXBsb2FkaW5nJykge1xuICAgICAgICAgIGljb24gPSA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0tdXBsb2FkaW5nLXRleHRgfT57bG9jYWxlLnVwbG9hZGluZ308L2Rpdj47XG4gICAgICAgIH0gZWxzZSBpZiAoIWZpbGUudGh1bWJVcmwgJiYgIWZpbGUudXJsKSB7XG4gICAgICAgICAgaWNvbiA9IDxJY29uIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0tdGh1bWJuYWlsYH0gdHlwZT1cInBpY3R1cmVcIiAvPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCB0aHVtYm5haWwgPSBpc0ltYWdlVXJsKChmaWxlLnRodW1iVXJsIHx8IGZpbGUudXJsKSBhcyBzdHJpbmcpID8gKFxuICAgICAgICAgICAgPGltZyBzcmM9e2ZpbGUudGh1bWJVcmwgfHwgZmlsZS51cmx9IGFsdD17ZmlsZS5uYW1lfSAvPlxuICAgICAgICAgICkgOiAoXG4gICAgICAgICAgICA8SWNvbiB0eXBlPVwiZmlsZVwiIHN0eWxlPXt7IGZvbnRTaXplOiA0OCwgY29sb3I6ICdyZ2JhKDAsMCwwLDAuNSknIH19IC8+XG4gICAgICAgICAgKTtcbiAgICAgICAgICBpY29uID0gKFxuICAgICAgICAgICAgPGFcbiAgICAgICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS10aHVtYm5haWxgfVxuICAgICAgICAgICAgICBvbkNsaWNrPXtlID0+IHRoaXMuaGFuZGxlUHJldmlldyhmaWxlLCBlKX1cbiAgICAgICAgICAgICAgaHJlZj17ZmlsZS51cmwgfHwgZmlsZS50aHVtYlVybH1cbiAgICAgICAgICAgICAgdGFyZ2V0PVwiX2JsYW5rXCJcbiAgICAgICAgICAgICAgcmVsPVwibm9vcGVuZXIgbm9yZWZlcnJlclwiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIHt0aHVtYm5haWx9XG4gICAgICAgICAgICA8L2E+XG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZmlsZS5zdGF0dXMgPT09ICd1cGxvYWRpbmcnKSB7XG4gICAgICAgIGNvbnN0IHsgcHJvZ3Jlc3NBdHRyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAvLyBzaG93IGxvYWRpbmcgaWNvbiBpZiB1cGxvYWQgcHJvZ3Jlc3MgbGlzdGVuZXIgaXMgZGlzYWJsZWRcbiAgICAgICAgY29uc3QgbG9hZGluZ1Byb2dyZXNzID1cbiAgICAgICAgICAncGVyY2VudCcgaW4gZmlsZSA/IChcbiAgICAgICAgICAgIDxQcm9ncmVzcyB0eXBlPXtQcm9ncmVzc1R5cGUubGluZX0gey4uLnByb2dyZXNzQXR0cn0gcGVyY2VudD17ZmlsZS5wZXJjZW50fSAvPlxuICAgICAgICAgICkgOiBudWxsO1xuXG4gICAgICAgIHByb2dyZXNzID0gKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS1wcm9ncmVzc2B9IGtleT1cInByb2dyZXNzXCI+XG4gICAgICAgICAgICB7bG9hZGluZ1Byb2dyZXNzfVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgaW5mb1VwbG9hZGluZ0NsYXNzID0gY2xhc3NOYW1lcyh7XG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbWBdOiB0cnVlLFxuICAgICAgICBbYCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0tJHtmaWxlLnN0YXR1c31gXTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcHJldmlldyA9IGZpbGUudXJsID8gKFxuICAgICAgICA8YVxuICAgICAgICAgIHsuLi5maWxlLmxpbmtQcm9wc31cbiAgICAgICAgICBocmVmPXtmaWxlLnVybH1cbiAgICAgICAgICB0YXJnZXQ9XCJfYmxhbmtcIlxuICAgICAgICAgIHJlbD1cIm5vb3BlbmVyIG5vcmVmZXJyZXJcIlxuICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0tbmFtZWB9XG4gICAgICAgICAgb25DbGljaz17ZSA9PiB0aGlzLmhhbmRsZVByZXZpZXcoZmlsZSwgZSl9XG4gICAgICAgICAgdGl0bGU9e2ZpbGUubmFtZX1cbiAgICAgICAgPlxuICAgICAgICAgIHtmaWxlLm5hbWV9XG4gICAgICAgIDwvYT5cbiAgICAgICkgOiAoXG4gICAgICAgIDxzcGFuXG4gICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS1uYW1lYH1cbiAgICAgICAgICBvbkNsaWNrPXtlID0+IHRoaXMuaGFuZGxlUHJldmlldyhmaWxlLCBlKX1cbiAgICAgICAgICB0aXRsZT17ZmlsZS5uYW1lfVxuICAgICAgICA+XG4gICAgICAgICAge2ZpbGUubmFtZX1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICAgIGNvbnN0IHN0eWxlID1cbiAgICAgICAgZmlsZS51cmwgfHwgZmlsZS50aHVtYlVybFxuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiAoe1xuICAgICAgICAgICAgICBwb2ludGVyRXZlbnRzOiAnbm9uZScsXG4gICAgICAgICAgICAgIG9wYWNpdHk6IDAuNSxcbiAgICAgICAgICAgIH0gYXMgQ1NTUHJvcGVydGllcyk7XG4gICAgICBjb25zdCBwcmV2aWV3SWNvbiA9IHNob3dQcmV2aWV3SWNvbiA/IChcbiAgICAgICAgPGFcbiAgICAgICAgICBocmVmPXtmaWxlLnVybCB8fCBmaWxlLnRodW1iVXJsfVxuICAgICAgICAgIHRhcmdldD1cIl9ibGFua1wiXG4gICAgICAgICAgcmVsPVwibm9vcGVuZXIgbm9yZWZlcnJlclwiXG4gICAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgICAgIG9uQ2xpY2s9e2UgPT4gdGhpcy5oYW5kbGVQcmV2aWV3KGZpbGUsIGUpfVxuICAgICAgICAgIHRpdGxlPXtsb2NhbGUucHJldmlld0ZpbGV9XG4gICAgICAgID5cbiAgICAgICAgICA8SWNvbiB0eXBlPVwidmlzaWJpbGl0eVwiIC8+XG4gICAgICAgIDwvYT5cbiAgICAgICkgOiBudWxsO1xuICAgICAgY29uc3QgcmVtb3ZlSWNvbiA9IHNob3dSZW1vdmVJY29uID8gKFxuICAgICAgICA8SWNvbiB0eXBlPVwiZGVsZXRlXCIgdGl0bGU9e2xvY2FsZS5yZW1vdmVGaWxlfSBvbkNsaWNrPXsoKSA9PiB0aGlzLmhhbmRsZUNsb3NlKGZpbGUpfSAvPlxuICAgICAgKSA6IG51bGw7XG4gICAgICBjb25zdCByZW1vdmVJY29uQ3Jvc3MgPSBzaG93UmVtb3ZlSWNvbiA/IChcbiAgICAgICAgPEljb24gdHlwZT1cImNsb3NlXCIgdGl0bGU9e2xvY2FsZS5yZW1vdmVGaWxlfSBvbkNsaWNrPXsoKSA9PiB0aGlzLmhhbmRsZUNsb3NlKGZpbGUpfSAvPlxuICAgICAgKSA6IG51bGw7XG4gICAgICBjb25zdCBhY3Rpb25zID1cbiAgICAgICAgbGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnICYmIGZpbGUuc3RhdHVzICE9PSAndXBsb2FkaW5nJyA/IChcbiAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbGlzdC1pdGVtLWFjdGlvbnNgfT5cbiAgICAgICAgICAgIHtwcmV2aWV3SWNvbn1cbiAgICAgICAgICAgIHtyZW1vdmVJY29ufVxuICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgKSA6IChcbiAgICAgICAgICByZW1vdmVJY29uQ3Jvc3NcbiAgICAgICAgKTtcbiAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgaWYgKGZpbGUucmVzcG9uc2UgJiYgdHlwZW9mIGZpbGUucmVzcG9uc2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG1lc3NhZ2UgPSBmaWxlLnJlc3BvbnNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IChmaWxlLmVycm9yICYmIGZpbGUuZXJyb3Iuc3RhdHVzVGV4dCkgfHwgbG9jYWxlLnVwbG9hZEVycm9yO1xuICAgICAgfVxuICAgICAgY29uc3QgaWNvbkFuZFByZXZpZXcgPVxuICAgICAgICBmaWxlLnN0YXR1cyA9PT0gJ2Vycm9yJyA/IChcbiAgICAgICAgICA8VG9vbHRpcCB0aXRsZT17bWVzc2FnZX0+XG4gICAgICAgICAgICB7aWNvbn1cbiAgICAgICAgICAgIHtwcmV2aWV3fVxuICAgICAgICAgIDwvVG9vbHRpcD5cbiAgICAgICAgKSA6IChcbiAgICAgICAgICA8c3Bhbj5cbiAgICAgICAgICAgIHtpY29ufVxuICAgICAgICAgICAge3ByZXZpZXd9XG4gICAgICAgICAgPC9zcGFuPlxuICAgICAgICApO1xuXG4gICAgICBpZiAoZHJhZ1VwbG9hZExpc3QpIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8RHJhZ2dhYmxlIGtleT17ZmlsZS51aWR9IGRyYWdnYWJsZUlkPXtTdHJpbmcoZmlsZS51aWQpfSBpbmRleD17aW5kZXh9PlxuICAgICAgICAgICAge3Byb3ZpZGVkID0+IChcbiAgICAgICAgICAgICAgPGRpdlxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17aW5mb1VwbG9hZGluZ0NsYXNzfVxuICAgICAgICAgICAgICAgIGtleT17ZmlsZS51aWR9XG4gICAgICAgICAgICAgICAgcmVmPXtwcm92aWRlZC5pbm5lclJlZn1cbiAgICAgICAgICAgICAgICB7Li4ucHJvdmlkZWQuZHJhZ2dhYmxlUHJvcHN9XG4gICAgICAgICAgICAgICAgey4uLnByb3ZpZGVkLmRyYWdIYW5kbGVQcm9wc31cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS1pbmZvYH0+e2ljb25BbmRQcmV2aWV3fTwvZGl2PlxuICAgICAgICAgICAgICAgIHthY3Rpb25zfVxuICAgICAgICAgICAgICAgIDxBbmltYXRlIHRyYW5zaXRpb25OYW1lPVwiZmFkZVwiIGNvbXBvbmVudD1cIlwiPlxuICAgICAgICAgICAgICAgICAge3Byb2dyZXNzfVxuICAgICAgICAgICAgICAgIDwvQW5pbWF0ZT5cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICApfVxuICAgICAgICAgIDwvRHJhZ2dhYmxlPlxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17aW5mb1VwbG9hZGluZ0NsYXNzfSBrZXk9e2ZpbGUudWlkfT5cbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0taW5mb2B9PntpY29uQW5kUHJldmlld308L2Rpdj5cbiAgICAgICAgICB7YWN0aW9uc31cbiAgICAgICAgICA8QW5pbWF0ZSB0cmFuc2l0aW9uTmFtZT1cImZhZGVcIiBjb21wb25lbnQ9XCJcIj5cbiAgICAgICAgICAgIHtwcm9ncmVzc31cbiAgICAgICAgICA8L0FuaW1hdGU+XG4gICAgICAgIDwvZGl2PlxuICAgICAgKTtcbiAgICB9KTtcbiAgICBjb25zdCBsaXN0Q2xhc3NOYW1lcyA9IGNsYXNzTmFtZXMoe1xuICAgICAgW2Ake3ByZWZpeENsc30tbGlzdGBdOiB0cnVlLFxuICAgICAgW2Ake3ByZWZpeENsc30tbGlzdC0ke2xpc3RUeXBlfWBdOiB0cnVlLFxuICAgICAgW2Ake3ByZWZpeENsc30tbGlzdC1kcmFnYF06IGRyYWdVcGxvYWRMaXN0LFxuICAgIH0pO1xuICAgIGNvbnN0IGFuaW1hdGlvbkRpcmVjdGlvbiA9IGxpc3RUeXBlID09PSAncGljdHVyZS1jYXJkJyA/ICdhbmltYXRlLWlubGluZScgOiAnYW5pbWF0ZSc7XG4gICAgaWYgKGRyYWdVcGxvYWRMaXN0KSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8RHJhZ0Ryb3BDb250ZXh0IG9uRHJhZ0VuZD17dGhpcy5vbkRyYWdFbmR9PlxuICAgICAgICAgIDxEcm9wcGFibGUgZHJvcHBhYmxlSWQ9XCJkcm9wcGFibGVcIiBkaXJlY3Rpb249XCJob3Jpem9udGFsXCI+XG4gICAgICAgICAgICB7KHByb3ZpZGVkLCBzbmFwc2hvdCkgPT4gKFxuICAgICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgcmVmPXtwcm92aWRlZC5pbm5lclJlZn1cbiAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogc25hcHNob3QuaXNEcmFnZ2luZ092ZXIgPyAnI2YyZjlmNCcgOiAnJyxcbiAgICAgICAgICAgICAgICAgIGJvcmRlcjogc25hcHNob3QuaXNEcmFnZ2luZ092ZXIgPyAnMnB4IGRhc2hlZCAjMWFiMTZmJyA6ICcnLFxuICAgICAgICAgICAgICAgICAgZGlzcGxheTogJ2lubGluZS1mbGV4JyxcbiAgICAgICAgICAgICAgICAgIG1heFdpZHRoOiAnMTAwJScsXG4gICAgICAgICAgICAgICAgICBmbGV4V3JhcDogJ3dyYXAnLFxuICAgICAgICAgICAgICAgICAgb3ZlcmZsb3c6ICdhdXRvJyxcbiAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIHsuLi5wcm92aWRlZC5kcm9wcGFibGVQcm9wc31cbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2xpc3RDbGFzc05hbWVzfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAge2xpc3R9XG4gICAgICAgICAgICAgICAge3Byb3ZpZGVkLnBsYWNlaG9sZGVyfVxuICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICl9XG4gICAgICAgICAgPC9Ecm9wcGFibGU+XG4gICAgICAgIDwvRHJhZ0Ryb3BDb250ZXh0PlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxBbmltYXRlXG4gICAgICAgIHRyYW5zaXRpb25OYW1lPXtgJHtwcmVmaXhDbHN9LSR7YW5pbWF0aW9uRGlyZWN0aW9ufWB9XG4gICAgICAgIGNvbXBvbmVudD1cImRpdlwiXG4gICAgICAgIGNsYXNzTmFtZT17bGlzdENsYXNzTmFtZXN9XG4gICAgICA+XG4gICAgICAgIHtsaXN0fVxuICAgICAgPC9BbmltYXRlPlxuICAgICk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==