import React, { Component } from 'react';
import { createPortal, render } from 'react-dom';
import classNames from 'classnames';
import findLast from 'lodash/findLast.js';
import noop from 'lodash/noop';
import measureScrollbar from 'choerodon-ui/lib/_util/measureScrollbar';
import { pxToRem } from 'choerodon-ui/lib/_util/UnitConvertor';
import warning from 'choerodon-ui/lib/_util/warning';
import { getProPrefixCls } from 'choerodon-ui/lib/configure';
import Modal, { destroyFns } from '../modal/Modal';
import Animate from '../animate';
import Mask from './Mask';
import { stopEvent } from '../_util/EventManager';
import { suffixCls } from '../modal/utils';
const KeyGen = (function* (id) {
    while (true) {
        yield `${getProPrefixCls(suffixCls)}-${id}`;
        id += 1;
    }
})(1);
const containerInstanses = [];
function removeInstanse(instanse) {
    const index = containerInstanses.indexOf(instanse);
    if (index > -1) {
        containerInstanses.splice(index, 1);
    }
}
function addInstanse(instanse) {
    removeInstanse(instanse);
    containerInstanses.push(instanse);
}
export function getKey() {
    return KeyGen.next().value;
}
let root;
let defaultBodyStyle;
function getRoot() {
    if (typeof window !== 'undefined') {
        const doc = window.document;
        if (root) {
            if (!root.parentNode) {
                doc.body.appendChild(root);
            }
        }
        else {
            root = doc.createElement('div');
            root.className = `${getProPrefixCls(suffixCls)}-container`;
            doc.body.appendChild(root);
        }
    }
    return root;
}
/**
 * 判断body是否有滚动条
 *
 * @returns {boolean}
 */
function hasScrollBar() {
    const { scrollHeight, clientHeight } = document.body;
    return scrollHeight > clientHeight;
}
function hideBodyScrollBar() {
    const { style } = document.body;
    if (!defaultBodyStyle) {
        defaultBodyStyle = {
            overflow: style.overflow,
            paddingRight: style.paddingRight,
        };
        style.overflow = 'hidden';
        if (hasScrollBar()) {
            style.paddingRight = pxToRem(measureScrollbar()) || '';
        }
    }
}
function showBodyScrollBar() {
    const { style } = document.body;
    if (defaultBodyStyle) {
        const { overflow, paddingRight } = defaultBodyStyle;
        defaultBodyStyle = undefined;
        style.overflow = overflow;
        style.paddingRight = paddingRight;
    }
}
export default class ModalContainer extends Component {
    constructor(props, context) {
        super(props, context);
        this.state = {
            modals: [],
        };
        this.handleAnimationEnd = (modalKey, isEnter) => {
            if (!isEnter) {
                const { modals } = this.state;
                const index = this.findIndex(modalKey);
                if (index !== -1) {
                    const props = modals[index];
                    modals.splice(index, 1);
                    if (!props.destroyOnClose) {
                        modals.unshift(props);
                    }
                    if (props.afterClose) {
                        props.afterClose();
                    }
                    this.setState({ modals });
                }
            }
        };
        this.handleMaskClick = async () => {
            const { modals } = this.state;
            const modal = findLast(modals, ({ hidden }) => !hidden);
            if (modal) {
                const { close = noop, onCancel = noop, maskClosable } = modal;
                if (maskClosable) {
                    const ret = await onCancel();
                    if (ret !== false) {
                        close();
                    }
                }
            }
        };
        this.top();
    }
    top() {
        addInstanse(this);
        return this;
    }
    componentWillUpdate(nextProps) {
        const { location } = nextProps;
        const { location: currentLocation } = this.props;
        if (location && currentLocation && location.pathname !== currentLocation.pathname) {
            this.clear();
        }
        this.top();
    }
    componentWillUnmount() {
        removeInstanse(this);
    }
    findIndex(modalKey) {
        const { modals } = this.state;
        return modals.findIndex(({ key }) => key === modalKey);
    }
    open(props) {
        const { modals } = this.state;
        if (!props.key) {
            props.key = getKey();
            warning(!!props.destroyOnClose, `The modal which opened has no key, please provide a key or set the \`destroyOnClose\` as true.`);
        }
        else {
            const index = this.findIndex(props.key);
            if (index !== -1) {
                modals.splice(index, 1);
            }
        }
        modals.push({ ...props, hidden: false });
        this.setState({ modals });
    }
    close(props) {
        const { modals } = this.state;
        const target = modals.find(({ key }) => key === props.key);
        if (target) {
            Object.assign(target, props, { hidden: true });
            this.setState({ modals });
        }
    }
    update(props) {
        const { modals: originModals } = this.state;
        const modals = [...originModals];
        if (props.key) {
            const index = this.findIndex(props.key);
            if (index !== -1) {
                modals[index] = props;
                this.setState({ modals });
            }
        }
    }
    clear() {
        const { modals } = this.state;
        modals.forEach(modal => this.close({ ...modal, destroyOnClose: true }));
    }
    getOffset(modals, idx) {
        const MARGIN_RIGHT_ARRAY = [];
        const DEFAULT = 150;
        const drawers = modals.filter(modal => modal.drawer && !modal.hidden);
        const indexInDrawers = drawers.findIndex(drawer => drawer.key === modals[idx].key);
        if (indexInDrawers === -1) {
            return 0;
        }
        for (let i = drawers.length - 1; i >= indexInDrawers; i--) {
            if (i === drawers.length - 1) {
                MARGIN_RIGHT_ARRAY.push(0);
            }
            else {
                const CURRENT_WIDTH = this.getModalWidth(drawers[i]);
                const NEXT_WIDTH = this.getModalWidth(drawers[i + 1]);
                const NEXT_MARGIN = MARGIN_RIGHT_ARRAY[drawers.length - i - 2];
                if (CURRENT_WIDTH >= NEXT_MARGIN + NEXT_WIDTH + DEFAULT) {
                    MARGIN_RIGHT_ARRAY.push(0);
                }
                else {
                    MARGIN_RIGHT_ARRAY.push(NEXT_MARGIN + NEXT_WIDTH + DEFAULT - CURRENT_WIDTH);
                }
            }
        }
        return MARGIN_RIGHT_ARRAY[MARGIN_RIGHT_ARRAY.length - 1];
    }
    getModalWidth(modal) {
        return (modal && modal.style && modal.style.width) || 520;
    }
    getComponent() {
        let hidden = true;
        const { modals } = this.state;
        const items = modals.map((props, index) => {
            const thisHidden = props.hidden;
            const { drawerTransitionName = 'slide-right' } = props;
            if (hidden && !thisHidden) {
                hidden = false;
            }
            const newProps = {};
            if (props.drawer) {
                newProps.style = {
                    marginRight: this.getOffset(modals, index),
                    ...props.style,
                };
            }
            if (index === modals.length - 1) {
                newProps.className = classNames(props.className, `${getProPrefixCls(suffixCls)}-active`);
            }
            return (React.createElement(Animate, { key: props.key, component: "div", transitionAppear: true, transitionName: props.drawer ? drawerTransitionName : 'zoom', hiddenProp: "hidden", onEnd: this.handleAnimationEnd },
                React.createElement(Modal, Object.assign({ key: props.key }, props, newProps))));
        });
        const animationProps = {};
        if (typeof window !== 'undefined') {
            if (hidden) {
                animationProps.onEnd = showBodyScrollBar;
            }
            else {
                hideBodyScrollBar();
            }
        }
        const modal = findLast(modals, ({ hidden: modalHidden }) => !modalHidden);
        const { maskStyle, mask, maskClassName } = modal || {};
        return (React.createElement(React.Fragment, null,
            React.createElement(Animate, Object.assign({ component: "", transitionAppear: true, transitionName: "fade", hiddenProp: "hidden" }, animationProps), mask ? (React.createElement(Mask, { style: maskStyle, className: maskClassName, hidden: hidden, onClick: this.handleMaskClick, onMouseDown: stopEvent })) : React.createElement("div", { hidden: hidden })),
            items));
    }
    render() {
        const mount = getRoot();
        if (mount) {
            return createPortal(this.getComponent(), mount);
        }
        return null;
    }
}
ModalContainer.displayName = 'ModalContainer';
export function getContainer(loop) {
    const { length } = containerInstanses;
    if (length) {
        return containerInstanses[length - 1];
    }
    if (loop !== true) {
        render(React.createElement(ModalContainer, null), getRoot());
        return getContainer(true);
    }
}
export function open(props) {
    const container = getContainer();
    async function close(destroy) {
        const { onClose = noop } = props;
        if ((await onClose()) !== false) {
            if (destroy) {
                container.close({ ...props, destroyOnClose: true });
            }
            else {
                container.close(props);
            }
        }
    }
    function update(newProps) {
        container.update({ ...props, ...newProps });
    }
    props = {
        close,
        update,
        ...Modal.defaultProps,
        ...props,
    };
    container.open(props);
    destroyFns.push(close);
    function show(newProps) {
        container.open({ ...props, ...newProps });
    }
    return {
        close,
        open: show,
        update,
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL21vZGFsLWNvbnRhaW5lci9Nb2RhbENvbnRhaW5lci50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDekMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxVQUFVLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sUUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLGdCQUFnQixNQUFNLHlDQUF5QyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMvRCxPQUFPLE9BQU8sTUFBTSxnQ0FBZ0MsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxLQUFLLEVBQUUsRUFBYyxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvRCxPQUFPLE9BQU8sTUFBTSxZQUFZLENBQUM7QUFDakMsT0FBTyxJQUFJLE1BQU0sUUFBUSxDQUFDO0FBQzFCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsTUFBTSxNQUFNLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO0lBQzNCLE9BQU8sSUFBSSxFQUFFO1FBQ1gsTUFBTSxHQUFHLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUM1QyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ1Q7QUFDSCxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVOLE1BQU0sa0JBQWtCLEdBQXFCLEVBQUUsQ0FBQztBQUVoRCxTQUFTLGNB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bnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy1wcm8vbW9kYWwtY29udGFpbmVyL01vZGFsQ29udGFpbmVyLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgY3JlYXRlUG9ydGFsLCByZW5kZXIgfSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgZmluZExhc3QgZnJvbSAnbG9kYXNoL2ZpbmRMYXN0LmpzJztcbmltcG9ydCBub29wIGZyb20gJ2xvZGFzaC9ub29wJztcbmltcG9ydCBtZWFzdXJlU2Nyb2xsYmFyIGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvX3V0aWwvbWVhc3VyZVNjcm9sbGJhcic7XG5pbXBvcnQgeyBweFRvUmVtIH0gZnJvbSAnY2hvZXJvZG9uLXVpL2xpYi9fdXRpbC9Vbml0Q29udmVydG9yJztcbmltcG9ydCB3YXJuaW5nIGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvX3V0aWwvd2FybmluZyc7XG5pbXBvcnQgeyBnZXRQcm9QcmVmaXhDbHMgfSBmcm9tICdjaG9lcm9kb24tdWkvbGliL2NvbmZpZ3VyZSc7XG5pbXBvcnQgTW9kYWwsIHsgTW9kYWxQcm9wcywgZGVzdHJveUZucyB9IGZyb20gJy4uL21vZGFsL01vZGFsJztcbmltcG9ydCBBbmltYXRlIGZyb20gJy4uL2FuaW1hdGUnO1xuaW1wb3J0IE1hc2sgZnJvbSAnLi9NYXNrJztcbmltcG9ydCB7IHN0b3BFdmVudCB9IGZyb20gJy4uL191dGlsL0V2ZW50TWFuYWdlcic7XG5pbXBvcnQgeyBzdWZmaXhDbHMgfSBmcm9tICcuLi9tb2RhbC91dGlscyc7XG5cbmNvbnN0IEtleUdlbiA9IChmdW5jdGlvbiogKGlkKSB7XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgeWllbGQgYCR7Z2V0UHJvUHJlZml4Q2xzKHN1ZmZpeENscyl9LSR7aWR9YDtcbiAgICBpZCArPSAxO1xuICB9XG59KSgxKTtcblxuY29uc3QgY29udGFpbmVySW5zdGFuc2VzOiBNb2RhbENvbnRhaW5lcltdID0gW107XG5cbmZ1bmN0aW9uIHJlbW92ZUluc3RhbnNlKGluc3RhbnNlOiBNb2RhbENvbnRhaW5lcikge1xuICBjb25zdCBpbmRleCA9IGNvbnRhaW5lckluc3RhbnNlcy5pbmRleE9mKGluc3RhbnNlKTtcbiAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICBjb250YWluZXJJbnN0YW5zZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRJbnN0YW5zZShpbnN0YW5zZTogTW9kYWxDb250YWluZXIpIHtcbiAgcmVtb3ZlSW5zdGFuc2UoaW5zdGFuc2UpO1xuICBjb250YWluZXJJbnN0YW5zZXMucHVzaChpbnN0YW5zZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRLZXkoKTogc3RyaW5nIHtcbiAgcmV0dXJuIEtleUdlbi5uZXh0KCkudmFsdWU7XG59XG5cbmxldCByb290O1xubGV0IGRlZmF1bHRCb2R5U3R5bGU6IHsgb3ZlcmZsb3c7IHBhZGRpbmdSaWdodDsgfSB8IHVuZGVmaW5lZDtcblxuZnVuY3Rpb24gZ2V0Um9vdCgpIHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc3QgZG9jID0gd2luZG93LmRvY3VtZW50O1xuICAgIGlmIChyb290KSB7XG4gICAgICBpZiAoIXJvb3QucGFyZW50Tm9kZSkge1xuICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChyb290KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcm9vdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIHJvb3QuY2xhc3NOYW1lID0gYCR7Z2V0UHJvUHJlZml4Q2xzKHN1ZmZpeENscyl9LWNvbnRhaW5lcmA7XG4gICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChyb290KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJvb3Q7XG59XG5cbi8qKlxuICog5Yik5patYm9keeaYr+WQpuaciea7muWKqOadoVxuICpcbiAqIEByZXR1cm5zIHtib29sZWFufVxuICovXG5mdW5jdGlvbiBoYXNTY3JvbGxCYXIoKTogYm9vbGVhbiB7XG4gIGNvbnN0IHsgc2Nyb2xsSGVpZ2h0LCBjbGllbnRIZWlnaHQgfSA9IGRvY3VtZW50LmJvZHk7XG4gIHJldHVybiBzY3JvbGxIZWlnaHQgPiBjbGllbnRIZWlnaHQ7XG59XG5cbmZ1bmN0aW9uIGhpZGVCb2R5U2Nyb2xsQmFyKCkge1xuICBjb25zdCB7IHN0eWxlIH0gPSBkb2N1bWVudC5ib2R5O1xuICBpZiAoIWRlZmF1bHRCb2R5U3R5bGUpIHtcbiAgICBkZWZhdWx0Qm9keVN0eWxlID0ge1xuICAgICAgb3ZlcmZsb3c6IHN0eWxlLm92ZXJmbG93LFxuICAgICAgcGFkZGluZ1JpZ2h0OiBzdHlsZS5wYWRkaW5nUmlnaHQsXG4gICAgfTtcbiAgICBzdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xuICAgIGlmIChoYXNTY3JvbGxCYXIoKSkge1xuICAgICAgc3R5bGUucGFkZGluZ1JpZ2h0ID0gcHhUb1JlbShtZWFzdXJlU2Nyb2xsYmFyKCkpIHx8ICcnO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzaG93Qm9keVNjcm9sbEJhcigpIHtcbiAgY29uc3QgeyBzdHlsZSB9ID0gZG9jdW1lbnQuYm9keTtcbiAgaWYgKGRlZmF1bHRCb2R5U3R5bGUpIHtcbiAgICBjb25zdCB7IG92ZXJmbG93LCBwYWRkaW5nUmlnaHQgfSA9IGRlZmF1bHRCb2R5U3R5bGU7XG4gICAgZGVmYXVsdEJvZHlTdHlsZSA9IHVuZGVmaW5lZDtcbiAgICBzdHlsZS5vdmVyZmxvdyA9IG92ZXJmbG93O1xuICAgIHN0eWxlLnBhZGRpbmdSaWdodCA9IHBhZGRpbmdSaWdodDtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsQ29udGFpbmVyUHJvcHMge1xuICBsb2NhdGlvbj86IHsgcGF0aG5hbWU6IHN0cmluZzsgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBNb2RhbENvbnRhaW5lclN0YXRlIHtcbiAgbW9kYWxzOiBNb2RhbFByb3BzW107XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZGFsQ29udGFpbmVyIGV4dGVuZHMgQ29tcG9uZW50PE1vZGFsQ29udGFpbmVyUHJvcHM+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ01vZGFsQ29udGFpbmVyJztcblxuICBzdGF0ZTogTW9kYWxDb250YWluZXJTdGF0ZSA9IHtcbiAgICBtb2RhbHM6IFtdLFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuICAgIHRoaXMudG9wKCk7XG4gIH1cblxuICBoYW5kbGVBbmltYXRpb25FbmQgPSAobW9kYWxLZXksIGlzRW50ZXIpID0+IHtcbiAgICBpZiAoIWlzRW50ZXIpIHtcbiAgICAgIGNvbnN0IHsgbW9kYWxzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZpbmRJbmRleChtb2RhbEtleSk7XG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgIGNvbnN0IHByb3BzID0gbW9kYWxzW2luZGV4XTtcbiAgICAgICAgbW9kYWxzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIGlmICghcHJvcHMuZGVzdHJveU9uQ2xvc2UpIHtcbiAgICAgICAgICBtb2RhbHMudW5zaGlmdChwcm9wcyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3BzLmFmdGVyQ2xvc2UpIHtcbiAgICAgICAgICBwcm9wcy5hZnRlckNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG1vZGFscyB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgaGFuZGxlTWFza0NsaWNrID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgbW9kYWxzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IG1vZGFsID0gZmluZExhc3QobW9kYWxzLCAoeyBoaWRkZW4gfSkgPT4gIWhpZGRlbik7XG4gICAgaWYgKG1vZGFsKSB7XG4gICAgICBjb25zdCB7IGNsb3NlID0gbm9vcCwgb25DYW5jZWwgPSBub29wLCBtYXNrQ2xvc2FibGUgfSA9IG1vZGFsO1xuICAgICAgaWYgKG1hc2tDbG9zYWJsZSkge1xuICAgICAgICBjb25zdCByZXQgPSBhd2FpdCBvbkNhbmNlbCgpO1xuICAgICAgICBpZiAocmV0ICE9PSBmYWxzZSkge1xuICAgICAgICAgIGNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgdG9wKCk6IE1vZGFsQ29udGFpbmVyIHtcbiAgICBhZGRJbnN0YW5zZSh0aGlzKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVcGRhdGUobmV4dFByb3BzKSB7XG4gICAgY29uc3QgeyBsb2NhdGlvbiB9ID0gbmV4dFByb3BzO1xuICAgIGNvbnN0IHsgbG9jYXRpb246IGN1cnJlbnRMb2NhdGlvbiB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAobG9jYXRpb24gJiYgY3VycmVudExvY2F0aW9uICYmIGxvY2F0aW9uLnBhdGhuYW1lICE9PSBjdXJyZW50TG9jYXRpb24ucGF0aG5hbWUpIHtcbiAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICB9XG4gICAgdGhpcy50b3AoKTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHJlbW92ZUluc3RhbnNlKHRoaXMpO1xuICB9XG5cbiAgZmluZEluZGV4KG1vZGFsS2V5KSB7XG4gICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0dXJuIG1vZGFscy5maW5kSW5kZXgoKHsga2V5IH0pID0+IGtleSA9PT0gbW9kYWxLZXkpO1xuICB9XG5cbiAgb3Blbihwcm9wczogTW9kYWxQcm9wcykge1xuICAgIGNvbnN0IHsgbW9kYWxzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGlmICghcHJvcHMua2V5KSB7XG4gICAgICBwcm9wcy5rZXkgPSBnZXRLZXkoKTtcbiAgICAgIHdhcm5pbmcoXG4gICAgICAgICEhcHJvcHMuZGVzdHJveU9uQ2xvc2UsXG4gICAgICAgIGBUaGUgbW9kYWwgd2hpY2ggb3BlbmVkIGhhcyBubyBrZXksIHBsZWFzZSBwcm92aWRlIGEga2V5IG9yIHNldCB0aGUgXFxgZGVzdHJveU9uQ2xvc2VcXGAgYXMgdHJ1ZS5gLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZpbmRJbmRleChwcm9wcy5rZXkpO1xuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICBtb2RhbHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbW9kYWxzLnB1c2goeyAuLi5wcm9wcywgaGlkZGVuOiBmYWxzZSB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHsgbW9kYWxzIH0pO1xuICB9XG5cbiAgY2xvc2UocHJvcHM6IE1vZGFsUHJvcHMpIHtcbiAgICBjb25zdCB7IG1vZGFscyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXQgPSBtb2RhbHMuZmluZCgoeyBrZXkgfSkgPT4ga2V5ID09PSBwcm9wcy5rZXkpO1xuICAgIGlmICh0YXJnZXQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24odGFyZ2V0LCBwcm9wcywgeyBoaWRkZW46IHRydWUgfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgbW9kYWxzIH0pO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZShwcm9wczogTW9kYWxQcm9wcykge1xuICAgIGNvbnN0IHsgbW9kYWxzOiBvcmlnaW5Nb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgbW9kYWxzID0gWy4uLm9yaWdpbk1vZGFsc107XG4gICAgaWYgKHByb3BzLmtleSkge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZpbmRJbmRleChwcm9wcy5rZXkpO1xuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICBtb2RhbHNbaW5kZXhdID0gcHJvcHM7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBtb2RhbHMgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgbW9kYWxzLmZvckVhY2gobW9kYWwgPT4gdGhpcy5jbG9zZSh7IC4uLm1vZGFsLCBkZXN0cm95T25DbG9zZTogdHJ1ZSB9KSk7XG4gIH1cblxuICBnZXRPZmZzZXQobW9kYWxzLCBpZHgpIHtcbiAgICBjb25zdCBNQVJHSU5fUklHSFRfQVJSQVk6IGFueSA9IFtdO1xuICAgIGNvbnN0IERFRkFVTFQgPSAxNTA7XG4gICAgY29uc3QgZHJhd2VycyA9IG1vZGFscy5maWx0ZXIobW9kYWwgPT4gbW9kYWwuZHJhd2VyICYmICFtb2RhbC5oaWRkZW4pO1xuICAgIGNvbnN0IGluZGV4SW5EcmF3ZXJzID0gZHJhd2Vycy5maW5kSW5kZXgoZHJhd2VyID0+IGRyYXdlci5rZXkgPT09IG1vZGFsc1tpZHhdLmtleSk7XG4gICAgaWYgKGluZGV4SW5EcmF3ZXJzID09PSAtMSkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSBkcmF3ZXJzLmxlbmd0aCAtIDE7IGkgPj0gaW5kZXhJbkRyYXdlcnM7IGktLSkge1xuICAgICAgaWYgKGkgPT09IGRyYXdlcnMubGVuZ3RoIC0gMSkge1xuICAgICAgICBNQVJHSU5fUklHSFRfQVJSQVkucHVzaCgwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IENVUlJFTlRfV0lEVEggPSB0aGlzLmdldE1vZGFsV2lkdGgoZHJhd2Vyc1tpXSk7XG4gICAgICAgIGNvbnN0IE5FWFRfV0lEVEggPSB0aGlzLmdldE1vZGFsV2lkdGgoZHJhd2Vyc1tpICsgMV0pO1xuICAgICAgICBjb25zdCBORVhUX01BUkdJTiA9IE1BUkdJTl9SSUdIVF9BUlJBWVtkcmF3ZXJzLmxlbmd0aCAtIGkgLSAyXTtcbiAgICAgICAgaWYgKENVUlJFTlRfV0lEVEggPj0gTkVYVF9NQVJHSU4gKyBORVhUX1dJRFRIICsgREVGQVVMVCkge1xuICAgICAgICAgIE1BUkdJTl9SSUdIVF9BUlJBWS5wdXNoKDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIE1BUkdJTl9SSUdIVF9BUlJBWS5wdXNoKE5FWFRfTUFSR0lOICsgTkVYVF9XSURUSCArIERFRkFVTFQgLSBDVVJSRU5UX1dJRFRIKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gTUFSR0lOX1JJR0hUX0FSUkFZW01BUkdJTl9SSUdIVF9BUlJBWS5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIGdldE1vZGFsV2lkdGgobW9kYWwpIHtcbiAgICByZXR1cm4gKG1vZGFsICYmIG1vZGFsLnN0eWxlICYmIG1vZGFsLnN0eWxlLndpZHRoKSB8fCA1MjA7XG4gIH1cblxuICBnZXRDb21wb25lbnQoKSB7XG4gICAgbGV0IGhpZGRlbiA9IHRydWU7XG4gICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgaXRlbXMgPSBtb2RhbHMubWFwKChwcm9wcywgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IHRoaXNIaWRkZW4gPSBwcm9wcy5oaWRkZW47XG4gICAgICBjb25zdCB7IGRyYXdlclRyYW5zaXRpb25OYW1lID0gJ3NsaWRlLXJpZ2h0JyB9ID0gcHJvcHM7XG4gICAgICBpZiAoaGlkZGVuICYmICF0aGlzSGlkZGVuKSB7XG4gICAgICAgIGhpZGRlbiA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc3QgbmV3UHJvcHM6IGFueSA9IHt9O1xuICAgICAgaWYgKHByb3BzLmRyYXdlcikge1xuICAgICAgICBuZXdQcm9wcy5zdHlsZSA9IHtcbiAgICAgICAgICBtYXJnaW5SaWdodDogdGhpcy5nZXRPZmZzZXQobW9kYWxzLCBpbmRleCksXG4gICAgICAgICAgLi4ucHJvcHMuc3R5bGUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBpZiAoaW5kZXggPT09IG1vZGFscy5sZW5ndGggLSAxKSB7XG4gICAgICAgIG5ld1Byb3BzLmNsYXNzTmFtZSA9IGNsYXNzTmFtZXMocHJvcHMuY2xhc3NOYW1lLCBgJHtnZXRQcm9QcmVmaXhDbHMoc3VmZml4Q2xzKX0tYWN0aXZlYCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8QW5pbWF0ZVxuICAgICAgICAgIGtleT17cHJvcHMua2V5fVxuICAgICAgICAgIGNvbXBvbmVudD1cImRpdlwiXG4gICAgICAgICAgdHJhbnNpdGlvbkFwcGVhclxuICAgICAgICAgIHRyYW5zaXRpb25OYW1lPXtwcm9wcy5kcmF3ZXIgPyBkcmF3ZXJUcmFuc2l0aW9uTmFtZSA6ICd6b29tJ31cbiAgICAgICAgICBoaWRkZW5Qcm9wPVwiaGlkZGVuXCJcbiAgICAgICAgICBvbkVuZD17dGhpcy5oYW5kbGVBbmltYXRpb25FbmR9XG4gICAgICAgID5cbiAgICAgICAgICA8TW9kYWwga2V5PXtwcm9wcy5rZXl9IHsuLi5wcm9wc30gey4uLm5ld1Byb3BzfSAvPlxuICAgICAgICA8L0FuaW1hdGU+XG4gICAgICApO1xuICAgIH0pO1xuICAgIGNvbnN0IGFuaW1hdGlvblByb3BzOiBhbnkgPSB7fTtcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGlmIChoaWRkZW4pIHtcbiAgICAgICAgYW5pbWF0aW9uUHJvcHMub25FbmQgPSBzaG93Qm9keVNjcm9sbEJhcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGhpZGVCb2R5U2Nyb2xsQmFyKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbW9kYWwgPSBmaW5kTGFzdChtb2RhbHMsICh7IGhpZGRlbjogbW9kYWxIaWRkZW4gfSkgPT4gIW1vZGFsSGlkZGVuKTtcbiAgICBjb25zdCB7IG1hc2tTdHlsZSwgbWFzaywgbWFza0NsYXNzTmFtZSB9ID0gbW9kYWwgfHwge307XG4gICAgcmV0dXJuIChcbiAgICAgIDw+XG4gICAgICAgIDxBbmltYXRlXG4gICAgICAgICAgY29tcG9uZW50PVwiXCJcbiAgICAgICAgICB0cmFuc2l0aW9uQXBwZWFyXG4gICAgICAgICAgdHJhbnNpdGlvbk5hbWU9XCJmYWRlXCJcbiAgICAgICAgICBoaWRkZW5Qcm9wPVwiaGlkZGVuXCJcbiAgICAgICAgICB7Li4uYW5pbWF0aW9uUHJvcHN9XG4gICAgICAgID5cbiAgICAgICAgICB7XG4gICAgICAgICAgICBtYXNrID8gKFxuICAgICAgICAgICAgICA8TWFzayBzdHlsZT17bWFza1N0eWxlfSBjbGFzc05hbWU9e21hc2tDbGFzc05hbWV9IGhpZGRlbj17aGlkZGVufSBvbkNsaWNrPXt0aGlzLmhhbmRsZU1hc2tDbGlja30gb25Nb3VzZURvd249e3N0b3BFdmVudH0gLz5cbiAgICAgICAgICAgICkgOiA8ZGl2IGhpZGRlbj17aGlkZGVufSAvPlxuICAgICAgICAgIH1cbiAgICAgICAgPC9BbmltYXRlPlxuICAgICAgICB7aXRlbXN9XG4gICAgICA8Lz5cbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IG1vdW50ID0gZ2V0Um9vdCgpO1xuICAgIGlmIChtb3VudCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVBvcnRhbCh0aGlzLmdldENvbXBvbmVudCgpLCBtb3VudCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb250YWluZXIobG9vcD86IGJvb2xlYW4pIHtcbiAgY29uc3QgeyBsZW5ndGggfSA9IGNvbnRhaW5lckluc3RhbnNlcztcbiAgaWYgKGxlbmd0aCkge1xuICAgIHJldHVybiBjb250YWluZXJJbnN0YW5zZXNbbGVuZ3RoIC0gMV07XG4gIH1cbiAgaWYgKGxvb3AgIT09IHRydWUpIHtcbiAgICByZW5kZXIoPE1vZGFsQ29udGFpbmVyIC8+LCBnZXRSb290KCkpO1xuICAgIHJldHVybiBnZXRDb250YWluZXIodHJ1ZSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW4ocHJvcHM6IE1vZGFsUHJvcHMgJiB7IGNoaWxkcmVuOyB9KSB7XG4gIGNvbnN0IGNvbnRhaW5lciA9IGdldENvbnRhaW5lcigpO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGNsb3NlKGRlc3Ryb3k/OiBib29sZWFuKSB7XG4gICAgY29uc3QgeyBvbkNsb3NlID0gbm9vcCB9ID0gcHJvcHM7XG4gICAgaWYgKChhd2FpdCBvbkNsb3NlKCkpICE9PSBmYWxzZSkge1xuICAgICAgaWYgKGRlc3Ryb3kpIHtcbiAgICAgICAgY29udGFpbmVyLmNsb3NlKHsgLi4ucHJvcHMsIGRlc3Ryb3lPbkNsb3NlOiB0cnVlIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29udGFpbmVyLmNsb3NlKHByb3BzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGUobmV3UHJvcHMpIHtcbiAgICBjb250YWluZXIudXBkYXRlKHsgLi4ucHJvcHMsIC4uLm5ld1Byb3BzIH0pO1xuICB9XG5cbiAgcHJvcHMgPSB7XG4gICAgY2xvc2UsXG4gICAgdXBkYXRlLFxuICAgIC4uLk1vZGFsLmRlZmF1bHRQcm9wcyxcbiAgICAuLi5wcm9wcyxcbiAgfTtcbiAgY29udGFpbmVyLm9wZW4ocHJvcHMpO1xuXG4gIGRlc3Ryb3lGbnMucHVzaChjbG9zZSk7XG5cbiAgZnVuY3Rpb24gc2hvdyhuZXdQcm9wcykge1xuICAgIGNvbnRhaW5lci5vcGVuKHsgLi4ucHJvcHMsIC4uLm5ld1Byb3BzIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBjbG9zZSxcbiAgICBvcGVuOiBzaG93LFxuICAgIHVwZGF0ZSxcbiAgfTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==