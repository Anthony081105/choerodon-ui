import { __decorate } from "tslib";
import Set from 'core-js/library/fn/set';
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { observer } from 'mobx-react';
import { computed, action, observable, runInAction } from 'mobx';
import noop from 'lodash/noop';
import C7NTree, { TreeNode, } from 'choerodon-ui/lib/tree';
import autobind from 'choerodon-ui/pro/lib/_util/autobind';
import { getKey, getTreeNodes } from './util';
import Spin from '../spin';
function defaultRenderer({ text }) {
    return text;
}
function defaultNodeCover() {
    return {};
}
const keyPropType = PropTypes.oneOfType([PropTypes.string, PropTypes.number]);
let Tree = class Tree extends Component {
    constructor(props, context) {
        super(props, context);
        this.stateForceRenderKeys = [];
        this.handleExpand = (expandedKeys, eventObj) => {
            if (this.setExpand(eventObj)) {
                runInAction(() => {
                    this.stateExpandedKeys = expandedKeys;
                });
            }
            const { onExpand = noop } = this.props;
            // @ts-ignore
            onExpand(expandedKeys, eventObj);
        };
        this.handleCheck = (checkedKeys, eventObj) => {
            if (this.setCheck(eventObj)) {
                runInAction(() => {
                    this.stateCheckedKeys = checkedKeys;
                });
            }
            const { onCheck = noop } = this.props;
            // @ts-ignore
            onCheck(checkedKeys, eventObj);
        };
        this.handleSelect = (_selectedKeys, eventObj) => {
            const { dataSet } = this.props;
            if (dataSet) {
                const { idField } = dataSet.props;
                const { node, selected } = eventObj;
                const { eventKey } = node;
                const found = dataSet.find(record => eventKey === String(idField ? record.get(idField) : record.id));
                if (found) {
                    if (selected) {
                        dataSet.select(found);
                    }
                    else {
                        dataSet.unSelect(found);
                    }
                }
            }
        };
        runInAction(() => {
            this.stateCheckedKeys = [];
            this.stateExpandedKeys = [];
        });
    }
    componentWillMount() {
        this.handleDataSetLoad();
        this.processDataSetListener(true);
    }
    componentWillReceiveProps(nextProps) {
        const { defaultExpandAll, defaultSelectedKeys, defaultExpandedKeys, defaultCheckedKeys } = this.props;
        if (defaultExpandAll !== nextProps.defaultExpandAll ||
            defaultExpandedKeys !== nextProps.defaultExpandedKeys ||
            defaultCheckedKeys !== nextProps.defaultCheckKeys ||
            defaultSelectedKeys !== nextProps.defaultSelectedKeys) {
            this.processDataSetListener(false);
            this.processDataSetListener(true);
        }
    }
    componentWillUnmount() {
        this.processDataSetListener(false);
    }
    processDataSetListener(flag) {
        const { dataSet } = this.props;
        if (dataSet) {
            const handler = flag ? dataSet.addEventListener : dataSet.removeEventListener;
            handler.call(dataSet, 'load', this.handleDataSetLoad);
        }
    }
    handleDataSetLoad() {
        this.initDefaultExpandedRows();
        this.initDefaultCheckRows();
        this.initDefaultSelectRows();
    }
    initDefaultExpandedRows() {
        const { props: { defaultExpandAll, dataSet, defaultExpandedKeys, }, } = this;
        this.stateExpandedKeys = this.dealDefalutCheckExpand(dataSet, defaultExpandedKeys, defaultExpandAll);
    }
    initDefaultCheckRows() {
        const { props: { dataSet, defaultCheckedKeys, }, } = this;
        this.stateCheckedKeys = this.dealDefalutCheckExpand(dataSet, defaultCheckedKeys);
    }
    initDefaultSelectRows() {
        const { props: { dataSet, defaultSelectedKeys, }, } = this;
        if (dataSet && (defaultSelectedKeys)) {
            const { idField } = dataSet.props;
            defaultSelectedKeys.map(selectKey => {
                const found = dataSet.find(record => selectKey === String(idField ? record.get(idField) : record.id));
                if (found) {
                    dataSet.select(found);
                }
                return null;
            });
        }
    }
    /**
     * 处理tree的props expand check的默认事件
     * @param dataSet
     * @param defalutAll
     * @param defalutKeys
     */
    dealDefalutCheckExpand(dataSet, defalutKeys, defalutAll) {
        let defalutStateKeys = [];
        if (dataSet) {
            const { idField, expandField } = dataSet.props;
            if (defalutAll && !expandField) {
                defalutStateKeys = dataSet.reduce((array, record) => {
                    if (record.children) {
                        array.push(getKey(record, idField));
                    }
                    return array;
                }, []);
            }
            else if (defalutKeys && !expandField) {
                defalutStateKeys = dataSet.reduce((array, record) => {
                    defalutKeys.map((key) => {
                        if (getKey(record, idField) === key) {
                            array.push(key);
                        }
                        return null;
                    });
                    return array;
                }, []);
            }
        }
        return defalutStateKeys;
    }
    get forceRenderKeys() {
        return (this.stateForceRenderKeys = [
            ...new Set([...this.stateForceRenderKeys, ...this.expandedKeys]),
        ]);
    }
    get expandedKeys() {
        const { dataSet } = this.props;
        if (dataSet) {
            const { expandField, idField } = dataSet.props;
            if (expandField) {
                const keys = [];
                dataSet.forEach(record => {
                    if (record.isExpanded) {
                        keys.push(getKey(record, idField));
                    }
                });
                return keys;
            }
        }
        return this.stateExpandedKeys;
    }
    get checkedKeys() {
        const { dataSet } = this.props;
        if (dataSet) {
            const { checkField, idField } = dataSet.props;
            if (checkField) {
                const keys = [];
                dataSet.forEach(record => {
                    const field = record.getField(checkField);
                    if (record.get(checkField) === (field ? field.get("trueValue" /* trueValue */) : true)) {
                        keys.push(getKey(record, idField));
                    }
                });
                return keys;
            }
        }
        return this.stateCheckedKeys;
    }
    get selectedKeys() {
        const { dataSet } = this.props;
        if (dataSet) {
            const { idField } = dataSet.props;
            return dataSet.selected.map(record => getKey(record, idField));
        }
        return [];
    }
    setExpand(eventObj) {
        const { dataSet } = this.props;
        if (dataSet) {
            const { expandField, idField } = dataSet.props;
            if (expandField) {
                const { node, expanded } = eventObj;
                const { eventKey } = node;
                const found = dataSet.find(record => eventKey === getKey(record, idField));
                if (found) {
                    found.isExpanded = !!expanded;
                    return false;
                }
            }
        }
        return true;
    }
    setCheck(eventObj) {
        const { dataSet } = this.props;
        if (dataSet) {
            const { checkField, idField } = dataSet.props;
            if (checkField) {
                const { node, checked } = eventObj;
                const { eventKey } = node;
                const found = dataSet.find(record => eventKey === String(idField ? record.get(idField) : record.id));
                if (found) {
                    const field = found.getField(checkField);
                    found.set(checkField, field
                        ? checked
                            ? field.get("trueValue" /* trueValue */)
                            : field.get("falseValue" /* falseValue */)
                        : checked);
                    return false;
                }
            }
        }
        return true;
    }
    render() {
        const { dataSet, renderer = defaultRenderer, titleField, treeNodeRenderer = defaultNodeCover, loadData, ...otherProps } = this.props;
        if (dataSet) {
            const props = {};
            props.treeData = getTreeNodes(dataSet, dataSet.treeData, this.forceRenderKeys, renderer, 
            // @ts-ignore
            treeNodeRenderer, loadData, titleField);
            // @ts-ignore
            props.onExpand = this.handleExpand;
            // @ts-ignore
            props.onCheck = this.handleCheck;
            // @ts-ignore
            props.onSelect = this.handleSelect;
            props.loadData = loadData;
            props.expandedKeys = this.expandedKeys.slice();
            props.checkedKeys = this.checkedKeys.slice();
            props.multiple = dataSet.props.selection === "multiple" /* multiple */;
            props.selectedKeys = this.selectedKeys.slice();
            return (React.createElement(Spin, { dataSet: dataSet },
                React.createElement(C7NTree, Object.assign({}, otherProps, props))));
        }
        return React.createElement(C7NTree, Object.assign({}, otherProps));
    }
};
Tree.displayName = 'Tree<PRO>';
Tree.propTypes = {
    prefixCls: PropTypes.string,
    className: PropTypes.string,
    style: PropTypes.object,
    tabIndex: PropTypes.oneOfType([PropTypes.string, PropTypes.number]),
    children: PropTypes.any,
    treeData: PropTypes.array,
    showLine: PropTypes.bool,
    showIcon: PropTypes.bool,
    icon: PropTypes.oneOfType([PropTypes.node, PropTypes.func]),
    selectable: PropTypes.bool,
    disabled: PropTypes.bool,
    multiple: PropTypes.bool,
    checkable: PropTypes.oneOfType([PropTypes.bool, PropTypes.node]),
    checkStrictly: PropTypes.bool,
    draggable: PropTypes.bool,
    defaultExpandParent: PropTypes.bool,
    autoExpandParent: PropTypes.bool,
    defaultExpandAll: PropTypes.bool,
    defaultExpandedKeys: PropTypes.arrayOf(keyPropType),
    expandedKeys: PropTypes.arrayOf(keyPropType),
    defaultCheckedKeys: PropTypes.arrayOf(keyPropType),
    checkedKeys: PropTypes.oneOfType([
        PropTypes.arrayOf(keyPropType),
        PropTypes.object,
    ]),
    defaultSelectedKeys: PropTypes.arrayOf(keyPropType),
    selectedKeys: PropTypes.arrayOf(keyPropType),
    onClick: PropTypes.func,
    onDoubleClick: PropTypes.func,
    onExpand: PropTypes.func,
    onCheck: PropTypes.func,
    onSelect: PropTypes.func,
    onLoad: PropTypes.func,
    loadData: PropTypes.func,
    loadedKeys: PropTypes.arrayOf(keyPropType),
    onMouseEnter: PropTypes.func,
    onMouseLeave: PropTypes.func,
    onRightClick: PropTypes.func,
    onDragStart: PropTypes.func,
    onDragEnter: PropTypes.func,
    onDragOver: PropTypes.func,
    onDragLeave: PropTypes.func,
    onDragEnd: PropTypes.func,
    onDrop: PropTypes.func,
    filterTreeNode: PropTypes.func,
    motion: PropTypes.object,
    switcherIcon: PropTypes.oneOfType([PropTypes.node, PropTypes.func]),
};
Tree.TreeNode = TreeNode;
__decorate([
    observable
], Tree.prototype, "stateCheckedKeys", void 0);
__decorate([
    observable
], Tree.prototype, "stateExpandedKeys", void 0);
__decorate([
    autobind
], Tree.prototype, "handleDataSetLoad", null);
__decorate([
    action
], Tree.prototype, "initDefaultExpandedRows", null);
__decorate([
    action
], Tree.prototype, "initDefaultCheckRows", null);
__decorate([
    action
], Tree.prototype, "initDefaultSelectRows", null);
__decorate([
    computed
], Tree.prototype, "forceRenderKeys", null);
__decorate([
    computed
], Tree.prototype, "expandedKeys", null);
__decorate([
    computed
], Tree.prototype, "checkedKeys", null);
__decorate([
    computed
], Tree.prototype, "selectedKeys", null);
Tree = __decorate([
    observer
], Tree);
export default Tree;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RyZWUvaW5kZXgudHN4IiwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEdBQUcsTUFBTSx3QkFBd0IsQ0FBQztBQUN6QyxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBWSxNQUFNLE9BQU8sQ0FBQztBQUNuRCxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pFLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLE9BQU8sRUFBRSxFQUNkLFFBQVEsR0FLVCxNQUFNLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sUUFBUSxNQUFNLHFDQUFxQyxDQUFDO0FBRTNELE9BQU8sRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFpQyxNQUFNLFFBQVEsQ0FBQztBQUU3RSxPQUFPLElBQUksTUFBTSxTQUFTLENBQUM7QUFrQzNCLFNBQVMsZUFBZSxDQUFDLEVBQUUsSUFBSSxFQUFFO0lBQy9CLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMsZ0JBQWdCO0lBQ3ZCLE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQUVELE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBRTlFLElBQXFCLElBQUksR0FBekIsTUFBcUIsSUFBSyxTQUFRLFNBQW9CO0lBdU9wRCxZQUFZLEtBQUssRUFBRSxPQUFPO1FBQ3hCLEtBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUE3S3hCLHlCQUFvQixHQUFhLEVBQUUsQ0FBQztRQWlPcEMsaUJBQVksR0FBRyxDQUFDLFlB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LFNBQVMsQ0FBQyxJQUFJO0lBQ3RCLFFBQVEsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUN4QixVQUFVLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDMUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzVCLFlBQVksRUFBRSxTQUFTLENBQUMsSUFBSTtJQUM1QixZQUFZLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDNUIsV0FBVyxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzNCLFdBQVcsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUMzQixVQUFVLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDMUIsV0FBVyxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzNCLFNBQVMsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUN6QixNQUFNLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDdEIsY0FBYyxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzlCLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTtJQUN4QixZQUFZLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQ3BFLENBQUM7QUFFSyxhQUFRLEdBQUcsUUFBUSxDQUFDO0FBRWY7SUFBWCxVQUFVOzhDQUE0QjtBQUUzQjtJQUFYLFVBQVU7K0NBQTZCO0FBb0N4QztJQURDLFFBQVE7NkNBS1I7QUFHRDtJQURDLE1BQU07bURBVU47QUFHRDtJQURDLE1BQU07Z0RBU047QUFHRDtJQURDLE1BQU07aURBcUJOO0FBbUNEO0lBREMsUUFBUTsyQ0FLUjtBQUdEO0lBREMsUUFBUTt3Q0FnQlI7QUFHRDtJQURDLFFBQVE7dUNBaUJSO0FBR0Q7SUFEQyxRQUFRO3dDQVFSO0FBck9rQixJQUFJO0lBRHhCLFFBQVE7R0FDWSxJQUFJLENBc1d4QjtlQXRXb0IsSUFBSSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy1wcm8vdHJlZS9pbmRleC50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNldCBmcm9tICdjb3JlLWpzL2xpYnJhcnkvZm4vc2V0JztcbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsTW91c2VFdmVudH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7IG9ic2VydmVyIH0gZnJvbSAnbW9ieC1yZWFjdCc7XG5pbXBvcnQgeyBjb21wdXRlZCwgYWN0aW9uLCBvYnNlcnZhYmxlLCBydW5JbkFjdGlvbiB9IGZyb20gJ21vYngnO1xuaW1wb3J0IG5vb3AgZnJvbSAnbG9kYXNoL25vb3AnO1xuaW1wb3J0IEM3TlRyZWUsIHtcbiAgVHJlZU5vZGUsXG4gIERhdGFOb2RlLFxuICBDN25UcmVlTm9kZVByb3BzLFxuICBFdmVudERhdGFOb2RlLFxuICBUcmVlUHJvcHMgYXMgQzdOVHJlZVByb3BzLFxufSBmcm9tICdjaG9lcm9kb24tdWkvbGliL3RyZWUnO1xuaW1wb3J0IGF1dG9iaW5kIGZyb20gJ2Nob2Vyb2Rvbi11aS9wcm8vbGliL191dGlsL2F1dG9iaW5kJztcbmltcG9ydCBEYXRhU2V0IGZyb20gJy4uL2RhdGEtc2V0L0RhdGFTZXQnO1xuaW1wb3J0IHsgZ2V0S2V5LCBnZXRUcmVlTm9kZXMsIE5vZGVSZW5kZXJlciwgVHJlZU5vZGVSZW5kZXJlcn0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IEJvb2xlYW5WYWx1ZSwgRGF0YVNldFNlbGVjdGlvbiB9IGZyb20gJy4uL2RhdGEtc2V0L2VudW0nO1xuaW1wb3J0IFNwaW4gZnJvbSAnLi4vc3Bpbic7XG5cbmludGVyZmFjZSBDN25Ob2RlRXZlbnQgZXh0ZW5kcyBFdmVudERhdGFOb2RlIHtcbiAgZXZlbnRLZXk6c3RyaW5nXG59XG5pbnRlcmZhY2UgVHJlZU5vZGVDaGVja2VkRXZlbnQge1xuICBldmVudDogJ2NoZWNrJztcbiAgbm9kZTogQzduTm9kZUV2ZW50O1xuICBjaGVja2VkOiBib29sZWFuO1xuICBuYXRpdmVFdmVudDogTW91c2VFdmVudDtcbiAgY2hlY2tlZE5vZGVzOiBEYXRhTm9kZVtdO1xuICBjaGVja2VkTm9kZXNQb3NpdGlvbnM/OiB7IG5vZGU6IERhdGFOb2RlOyBwb3M6IHN0cmluZyB9W107XG4gIGhhbGZDaGVja2VkS2V5cz86IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgQzduVHJlZU5vZGVTZWxlY3RlZEV2ZW50IHtcbiAgZXZlbnQ6IFwic2VsZWN0XCI7XG4gIHNlbGVjdGVkOiBib29sZWFuO1xuICBub2RlOiBDN25Ob2RlRXZlbnQ7XG4gIHNlbGVjdGVkTm9kZXM6IERhdGFOb2RlW107XG4gIG5hdGl2ZUV2ZW50Ok1vdXNlRXZlbnQ7XG59XG5pbnRlcmZhY2UgQzduVHJlZU5vZGVFeHBhbmRlZEV2ZW50IHtcbiAgZXhwYW5kZWQ6Ym9vbGVhbjtcbiAgbmF0aXZlRXZlbnQ6TW91c2VFdmVudDtcbiAgbm9kZTpDN25Ob2RlRXZlbnQ7XG59XG5leHBvcnQgaW50ZXJmYWNlIFRyZWVQcm9wcyBleHRlbmRzIEM3TlRyZWVQcm9wcyB7XG4gIGRhdGFTZXQ/OiBEYXRhU2V0O1xuICByZW5kZXJlcj86IE5vZGVSZW5kZXJlcjtcbiAgdGl0bGVGaWVsZD86IHN0cmluZztcbiAgdHJlZU5vZGVSZW5kZXJlcj86VHJlZU5vZGVSZW5kZXJlcjtcbn1cblxuZnVuY3Rpb24gZGVmYXVsdFJlbmRlcmVyKHsgdGV4dCB9KSB7XG4gIHJldHVybiB0ZXh0O1xufVxuXG5mdW5jdGlvbiBkZWZhdWx0Tm9kZUNvdmVyKCl7XG4gIHJldHVybiB7fTtcbn1cblxuY29uc3Qga2V5UHJvcFR5cGUgPSBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMubnVtYmVyXSk7XG5Ab2JzZXJ2ZXJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRyZWUgZXh0ZW5kcyBDb21wb25lbnQ8VHJlZVByb3BzPiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdUcmVlPFBSTz4nO1xuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgcHJlZml4Q2xzOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBzdHlsZTogUHJvcFR5cGVzLm9iamVjdCxcbiAgICB0YWJJbmRleDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLm51bWJlcl0pLFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuYW55LFxuICAgIHRyZWVEYXRhOiBQcm9wVHlwZXMuYXJyYXksIC8vIEdlbmVyYXRlIHRyZWVOb2RlIGJ5IGNoaWxkcmVuXG4gICAgc2hvd0xpbmU6IFByb3BUeXBlcy5ib29sLFxuICAgIHNob3dJY29uOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBpY29uOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubm9kZSwgUHJvcFR5cGVzLmZ1bmNdKSxcbiAgICBzZWxlY3RhYmxlOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBkaXNhYmxlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgbXVsdGlwbGU6IFByb3BUeXBlcy5ib29sLFxuICAgIGNoZWNrYWJsZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLmJvb2wsIFByb3BUeXBlcy5ub2RlXSksXG4gICAgY2hlY2tTdHJpY3RseTogUHJvcFR5cGVzLmJvb2wsXG4gICAgZHJhZ2dhYmxlOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBkZWZhdWx0RXhwYW5kUGFyZW50OiBQcm9wVHlwZXMuYm9vbCxcbiAgICBhdXRvRXhwYW5kUGFyZW50OiBQcm9wVHlwZXMuYm9vbCxcbiAgICBkZWZhdWx0RXhwYW5kQWxsOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBkZWZhdWx0RXhwYW5kZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgZXhwYW5kZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgZGVmYXVsdENoZWNrZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgY2hlY2tlZEtleXM6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgICAgUHJvcFR5cGVzLmFycmF5T2Yoa2V5UHJvcFR5cGUpLFxuICAgICAgUHJvcFR5cGVzLm9iamVjdCxcbiAgICBdKSxcbiAgICBkZWZhdWx0U2VsZWN0ZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgc2VsZWN0ZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgb25DbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25Eb3VibGVDbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25FeHBhbmQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uQ2hlY2s6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uU2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkxvYWQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIGxvYWREYXRhOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBsb2FkZWRLZXlzOiBQcm9wVHlwZXMuYXJyYXlPZihrZXlQcm9wVHlwZSksXG4gICAgb25Nb3VzZUVudGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbk1vdXNlTGVhdmU6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uUmlnaHRDbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25EcmFnU3RhcnQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uRHJhZ0VudGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkRyYWdPdmVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkRyYWdMZWF2ZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25EcmFnRW5kOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkRyb3A6IFByb3BUeXBlcy5mdW5jLFxuICAgIGZpbHRlclRyZWVOb2RlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBtb3Rpb246IFByb3BUeXBlcy5vYmplY3QsXG4gICAgc3dpdGNoZXJJY29uOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubm9kZSwgUHJvcFR5cGVzLmZ1bmNdKSxcbiAgfTtcblxuICBzdGF0aWMgVHJlZU5vZGUgPSBUcmVlTm9kZTtcblxuICBAb2JzZXJ2YWJsZSBzdGF0ZUNoZWNrZWRLZXlzOiBzdHJpbmdbXTtcblxuICBAb2JzZXJ2YWJsZSBzdGF0ZUV4cGFuZGVkS2V5czogc3RyaW5nW107XG5cbiAgc3RhdGVGb3JjZVJlbmRlcktleXM6IHN0cmluZ1tdID0gW107XG5cblxuICBjb21wb25lbnRXaWxsTW91bnQoKSB7XG4gICAgdGhpcy5oYW5kbGVEYXRhU2V0TG9hZCgpO1xuICAgIHRoaXMucHJvY2Vzc0RhdGFTZXRMaXN0ZW5lcih0cnVlKTtcbiAgfVxuXG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICBjb25zdCB7ZGVmYXVsdEV4cGFuZEFsbCxkZWZhdWx0U2VsZWN0ZWRLZXlzLGRlZmF1bHRFeHBhbmRlZEtleXMsZGVmYXVsdENoZWNrZWRLZXlzfSA9IHRoaXMucHJvcHM7XG4gICAgaWYoZGVmYXVsdEV4cGFuZEFsbCAhPT0gbmV4dFByb3BzLmRlZmF1bHRFeHBhbmRBbGwgfHxcbiAgICAgIGRlZmF1bHRFeHBhbmRlZEtleXMgIT09IG5leHRQcm9wcy5kZWZhdWx0RXhwYW5kZWRLZXlzIHx8XG4gICAgICBkZWZhdWx0Q2hlY2tlZEtleXMgIT09IG5leHRQcm9wcy5kZWZhdWx0Q2hlY2tLZXlzIHx8XG4gICAgICBkZWZhdWx0U2VsZWN0ZWRLZXlzICE9PSBuZXh0UHJvcHMuZGVmYXVsdFNlbGVjdGVkS2V5c1xuICAgICAgKXtcbiAgICAgIHRoaXMucHJvY2Vzc0RhdGFTZXRMaXN0ZW5lcihmYWxzZSk7XG4gICAgICB0aGlzLnByb2Nlc3NEYXRhU2V0TGlzdGVuZXIodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5wcm9jZXNzRGF0YVNldExpc3RlbmVyKGZhbHNlKTtcbiAgfVxuXG4gIHByb2Nlc3NEYXRhU2V0TGlzdGVuZXIoZmxhZzogYm9vbGVhbikge1xuICAgIGNvbnN0IHsgZGF0YVNldCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZGF0YVNldCkge1xuICAgICAgY29uc3QgaGFuZGxlciA9IGZsYWcgPyBkYXRhU2V0LmFkZEV2ZW50TGlzdGVuZXIgOiBkYXRhU2V0LnJlbW92ZUV2ZW50TGlzdGVuZXI7XG4gICAgICBoYW5kbGVyLmNhbGwoZGF0YVNldCwgJ2xvYWQnLCB0aGlzLmhhbmRsZURhdGFTZXRMb2FkKTtcbiAgICB9XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgaGFuZGxlRGF0YVNldExvYWQoKSB7XG4gICAgdGhpcy5pbml0RGVmYXVsdEV4cGFuZGVkUm93cygpO1xuICAgIHRoaXMuaW5pdERlZmF1bHRDaGVja1Jvd3MoKTtcbiAgICB0aGlzLmluaXREZWZhdWx0U2VsZWN0Um93cygpO1xuICB9XG5cbiAgQGFjdGlvblxuICBpbml0RGVmYXVsdEV4cGFuZGVkUm93cygpIHtcbiAgICBjb25zdCB7XG4gICAgICBwcm9wczoge1xuICAgICAgICBkZWZhdWx0RXhwYW5kQWxsLFxuICAgICAgICBkYXRhU2V0LFxuICAgICAgICBkZWZhdWx0RXhwYW5kZWRLZXlzLFxuICAgICAgfSxcbiAgICB9ID0gdGhpcztcbiAgICB0aGlzLnN0YXRlRXhwYW5kZWRLZXlzID0gdGhpcy5kZWFsRGVmYWx1dENoZWNrRXhwYW5kKGRhdGFTZXQsZGVmYXVsdEV4cGFuZGVkS2V5cyxkZWZhdWx0RXhwYW5kQWxsKVxuICB9XG5cbiAgQGFjdGlvblxuICBpbml0RGVmYXVsdENoZWNrUm93cygpe1xuICAgIGNvbnN0IHtcbiAgICAgIHByb3BzOiB7XG4gICAgICAgIGRhdGFTZXQsXG4gICAgICAgIGRlZmF1bHRDaGVja2VkS2V5cyxcbiAgICAgIH0sXG4gICAgfSA9IHRoaXM7XG4gICAgdGhpcy5zdGF0ZUNoZWNrZWRLZXlzID0gdGhpcy5kZWFsRGVmYWx1dENoZWNrRXhwYW5kKGRhdGFTZXQsZGVmYXVsdENoZWNrZWRLZXlzKVxuICB9XG5cbiAgQGFjdGlvblxuICBpbml0RGVmYXVsdFNlbGVjdFJvd3MoKXtcbiAgICBjb25zdCB7XG4gICAgICBwcm9wczoge1xuICAgICAgICBkYXRhU2V0LFxuICAgICAgICBkZWZhdWx0U2VsZWN0ZWRLZXlzLFxuICAgICAgfSxcbiAgICB9ID0gdGhpcztcbiAgICBpZihkYXRhU2V0ICYmIChkZWZhdWx0U2VsZWN0ZWRLZXlzKSl7XG4gICAgICBjb25zdCB7IGlkRmllbGQgfSA9IGRhdGFTZXQucHJvcHM7XG4gICAgICBkZWZhdWx0U2VsZWN0ZWRLZXlzLm1hcChzZWxlY3RLZXkgPT4ge1xuICAgICAgICBjb25zdCBmb3VuZCA9IGRhdGFTZXQuZmluZChcbiAgICAgICAgICByZWNvcmQgPT4gc2VsZWN0S2V5ID09PSBTdHJpbmcoaWRGaWVsZCA/IHJlY29yZC5nZXQoaWRGaWVsZCkgOiByZWNvcmQuaWQpLFxuICAgICAgICApO1xuICAgICAgICBpZihmb3VuZCl7XG4gICAgICAgICAgZGF0YVNldC5zZWxlY3QoZm91bmQpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgIH0pXG4gICAgfVxuXG4gIH1cblxuICAvKipcbiAgICog5aSE55CGdHJlZeeahHByb3BzIGV4cGFuZCBjaGVja+eahOm7mOiupOS6i+S7tlxuICAgKiBAcGFyYW0gZGF0YVNldFxuICAgKiBAcGFyYW0gZGVmYWx1dEFsbFxuICAgKiBAcGFyYW0gZGVmYWx1dEtleXNcbiAgICovXG4gIGRlYWxEZWZhbHV0Q2hlY2tFeHBhbmQoZGF0YVNldDpEYXRhU2V0fHVuZGVmaW5lZCxkZWZhbHV0S2V5czpzdHJpbmdbXXx1bmRlZmluZWQsZGVmYWx1dEFsbD86Ym9vbGVhbil7XG4gICAgbGV0IGRlZmFsdXRTdGF0ZUtleXM6IHN0cmluZ1tdID0gW11cbiAgICBpZihkYXRhU2V0KXtcbiAgICAgIGNvbnN0IHtpZEZpZWxkLCBleHBhbmRGaWVsZH0gPSBkYXRhU2V0LnByb3BzO1xuICAgICAgaWYgKCBkZWZhbHV0QWxsICYmICFleHBhbmRGaWVsZCkge1xuICAgICAgICBkZWZhbHV0U3RhdGVLZXlzID0gZGF0YVNldC5yZWR1Y2U8KHN0cmluZylbXT4oKGFycmF5LCByZWNvcmQpID0+IHtcbiAgICAgICAgICBpZiAocmVjb3JkLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBhcnJheS5wdXNoKGdldEtleShyZWNvcmQsIGlkRmllbGQpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgICAgICB9LCBbXSk7XG4gICAgICB9ZWxzZSBpZihkZWZhbHV0S2V5cyAmJiAhZXhwYW5kRmllbGQpe1xuICAgICAgICBkZWZhbHV0U3RhdGVLZXlzID0gZGF0YVNldC5yZWR1Y2U8KHN0cmluZylbXT4oKGFycmF5LCByZWNvcmQpID0+IHtcbiAgICAgICAgICBkZWZhbHV0S2V5cy5tYXAoKGtleSkgPT4ge1xuICAgICAgICAgICAgaWYoZ2V0S2V5KHJlY29yZCxpZEZpZWxkKSA9PT0ga2V5KXtcbiAgICAgICAgICAgICAgYXJyYXkucHVzaChrZXkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgICAgICB9LFtdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRlZmFsdXRTdGF0ZUtleXNcbiAgfVxuXG4gIEBjb21wdXRlZFxuICBnZXQgZm9yY2VSZW5kZXJLZXlzKCkge1xuICAgIHJldHVybiAodGhpcy5zdGF0ZUZvcmNlUmVuZGVyS2V5cyA9IFtcbiAgICAgIC4uLm5ldyBTZXQ8c3RyaW5nPihbLi4udGhpcy5zdGF0ZUZvcmNlUmVuZGVyS2V5cywgLi4udGhpcy5leHBhbmRlZEtleXNdKSxcbiAgICBdKTtcbiAgfVxuXG4gIEBjb21wdXRlZFxuICBnZXQgZXhwYW5kZWRLZXlzKCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCB7IGRhdGFTZXQgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKGRhdGFTZXQpIHtcbiAgICAgIGNvbnN0IHsgZXhwYW5kRmllbGQsIGlkRmllbGQgfSA9IGRhdGFTZXQucHJvcHM7XG4gICAgICBpZiAoZXhwYW5kRmllbGQpIHtcbiAgICAgICAgY29uc3Qga2V5czogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgZGF0YVNldC5mb3JFYWNoKHJlY29yZCA9PiB7XG4gICAgICAgICAgaWYgKHJlY29yZC5pc0V4cGFuZGVkKSB7XG4gICAgICAgICAgICBrZXlzLnB1c2goZ2V0S2V5KHJlY29yZCwgaWRGaWVsZCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBrZXlzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zdGF0ZUV4cGFuZGVkS2V5cztcbiAgfVxuXG4gIEBjb21wdXRlZFxuICBnZXQgY2hlY2tlZEtleXMoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHsgZGF0YVNldCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZGF0YVNldCkge1xuICAgICAgY29uc3QgeyBjaGVja0ZpZWxkLCBpZEZpZWxkIH0gPSBkYXRhU2V0LnByb3BzO1xuICAgICAgaWYgKGNoZWNrRmllbGQpIHtcbiAgICAgICAgY29uc3Qga2V5czogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgZGF0YVNldC5mb3JFYWNoKHJlY29yZCA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSByZWNvcmQuZ2V0RmllbGQoY2hlY2tGaWVsZCk7XG4gICAgICAgICAgaWYgKHJlY29yZC5nZXQoY2hlY2tGaWVsZCkgPT09IChmaWVsZCA/IGZpZWxkLmdldChCb29sZWFuVmFsdWUudHJ1ZVZhbHVlKSA6IHRydWUpKSB7XG4gICAgICAgICAgICBrZXlzLnB1c2goZ2V0S2V5KHJlY29yZCwgaWRGaWVsZCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBrZXlzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zdGF0ZUNoZWNrZWRLZXlzO1xuICB9XG5cbiAgQGNvbXB1dGVkXG4gIGdldCBzZWxlY3RlZEtleXMoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHsgZGF0YVNldCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZGF0YVNldCkge1xuICAgICAgY29uc3QgeyBpZEZpZWxkIH0gPSBkYXRhU2V0LnByb3BzO1xuICAgICAgcmV0dXJuIGRhdGFTZXQuc2VsZWN0ZWQubWFwKHJlY29yZCA9PiBnZXRLZXkocmVjb3JkLCBpZEZpZWxkKSk7XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuICAgIHJ1bkluQWN0aW9uKCgpID0+IHtcbiAgICAgIHRoaXMuc3RhdGVDaGVja2VkS2V5cyA9IFtdO1xuICAgICAgdGhpcy5zdGF0ZUV4cGFuZGVkS2V5cyA9IFtdO1xuICAgIH0pO1xuICB9XG5cbiAgc2V0RXhwYW5kKGV2ZW50T2JqOiBDN25UcmVlTm9kZUV4cGFuZGVkRXZlbnQpIHtcbiAgICBjb25zdCB7IGRhdGFTZXQgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKGRhdGFTZXQpIHtcbiAgICAgIGNvbnN0IHsgZXhwYW5kRmllbGQsIGlkRmllbGQgfSA9IGRhdGFTZXQucHJvcHM7XG4gICAgICBpZiAoZXhwYW5kRmllbGQpIHtcbiAgICAgICAgY29uc3QgeyBub2RlLCBleHBhbmRlZCB9ID0gZXZlbnRPYmo7XG4gICAgICAgIGNvbnN0IHsgZXZlbnRLZXkgfSA9IG5vZGU7XG4gICAgICAgIGNvbnN0IGZvdW5kID0gZGF0YVNldC5maW5kKHJlY29yZCA9PiBldmVudEtleSA9PT0gZ2V0S2V5KHJlY29yZCwgaWRGaWVsZCkpO1xuICAgICAgICBpZiAoZm91bmQpIHtcbiAgICAgICAgICBmb3VuZC5pc0V4cGFuZGVkID0gISFleHBhbmRlZDtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuXG4gIHNldENoZWNrKGV2ZW50T2JqOiBDN25UcmVlTm9kZVByb3BzKSB7XG4gICAgY29uc3QgeyBkYXRhU2V0IH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChkYXRhU2V0KSB7XG4gICAgICBjb25zdCB7IGNoZWNrRmllbGQsIGlkRmllbGQgfSA9IGRhdGFTZXQucHJvcHM7XG4gICAgICBpZiAoY2hlY2tGaWVsZCkge1xuICAgICAgICBjb25zdCB7IG5vZGUsIGNoZWNrZWQgfSA9IGV2ZW50T2JqO1xuICAgICAgICBjb25zdCB7IGV2ZW50S2V5IH0gPSBub2RlO1xuICAgICAgICBjb25zdCBmb3VuZCA9IGRhdGFTZXQuZmluZChcbiAgICAgICAgICByZWNvcmQgPT4gZXZlbnRLZXkgPT09IFN0cmluZyhpZEZpZWxkID8gcmVjb3JkLmdldChpZEZpZWxkKSA6IHJlY29yZC5pZCksXG4gICAgICAgICk7XG4gICAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICAgIGNvbnN0IGZpZWxkID0gZm91bmQuZ2V0RmllbGQoY2hlY2tGaWVsZCk7XG4gICAgICAgICAgZm91bmQuc2V0KFxuICAgICAgICAgICAgY2hlY2tGaWVsZCxcbiAgICAgICAgICAgIGZpZWxkXG4gICAgICAgICAgICAgID8gY2hlY2tlZFxuICAgICAgICAgICAgICAgID8gZmllbGQuZ2V0KEJvb2xlYW5WYWx1ZS50cnVlVmFsdWUpXG4gICAgICAgICAgICAgICAgOiBmaWVsZC5nZXQoQm9vbGVhblZhbHVlLmZhbHNlVmFsdWUpXG4gICAgICAgICAgICAgIDogY2hlY2tlZCxcbiAgICAgICAgICApO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGhhbmRsZUV4cGFuZCA9IChleHBhbmRlZEtleXM6IHN0cmluZ1tdLCBldmVudE9iajogQzduVHJlZU5vZGVFeHBhbmRlZEV2ZW50KSA9PiB7XG4gICAgaWYgKHRoaXMuc2V0RXhwYW5kKGV2ZW50T2JqKSkge1xuICAgICAgcnVuSW5BY3Rpb24oKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlRXhwYW5kZWRLZXlzID0gZXhwYW5kZWRLZXlzO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHsgb25FeHBhbmQgPSBub29wIH0gPSB0aGlzLnByb3BzO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBvbkV4cGFuZChleHBhbmRlZEtleXMsIGV2ZW50T2JqKTtcbiAgfTtcblxuICBoYW5kbGVDaGVjayA9IChjaGVja2VkS2V5czogc3RyaW5nW10sIGV2ZW50T2JqOiBUcmVlTm9kZUNoZWNrZWRFdmVudCkgPT4ge1xuICAgIGlmICh0aGlzLnNldENoZWNrKGV2ZW50T2JqKSkge1xuICAgICAgcnVuSW5BY3Rpb24oKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlQ2hlY2tlZEtleXMgPSBjaGVja2VkS2V5cztcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB7IG9uQ2hlY2sgPSBub29wIH0gPSB0aGlzLnByb3BzO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBvbkNoZWNrKGNoZWNrZWRLZXlzLCBldmVudE9iaik7XG4gIH07XG5cbiAgaGFuZGxlU2VsZWN0ID0gKF9zZWxlY3RlZEtleXM6IHN0cmluZ1tdLCBldmVudE9iajogQzduVHJlZU5vZGVTZWxlY3RlZEV2ZW50KSA9PiB7XG4gICAgY29uc3QgeyBkYXRhU2V0IH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChkYXRhU2V0KSB7XG4gICAgICBjb25zdCB7IGlkRmllbGQgfSA9IGRhdGFTZXQucHJvcHM7XG4gICAgICBjb25zdCB7IG5vZGUsIHNlbGVjdGVkIH0gPSBldmVudE9iajtcbiAgICAgIGNvbnN0IHsgZXZlbnRLZXkgfSA9IG5vZGU7XG4gICAgICBjb25zdCBmb3VuZCA9IGRhdGFTZXQuZmluZChcbiAgICAgICAgcmVjb3JkID0+IGV2ZW50S2V5ID09PSBTdHJpbmcoaWRGaWVsZCA/IHJlY29yZC5nZXQoaWRGaWVsZCkgOiByZWNvcmQuaWQpLFxuICAgICAgKTtcbiAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICBpZiAoc2VsZWN0ZWQpIHtcbiAgICAgICAgICBkYXRhU2V0LnNlbGVjdChmb3VuZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGF0YVNldC51blNlbGVjdChmb3VuZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgZGF0YVNldCwgcmVuZGVyZXIgPSBkZWZhdWx0UmVuZGVyZXIsIHRpdGxlRmllbGQsIHRyZWVOb2RlUmVuZGVyZXIgPSBkZWZhdWx0Tm9kZUNvdmVyLGxvYWREYXRhICwuLi5vdGhlclByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChkYXRhU2V0KSB7XG4gICAgICBjb25zdCBwcm9wczogVHJlZVByb3BzID0ge307XG4gICAgICBwcm9wcy50cmVlRGF0YSA9IGdldFRyZWVOb2RlcyhcbiAgICAgICAgZGF0YVNldCxcbiAgICAgICAgZGF0YVNldC50cmVlRGF0YSxcbiAgICAgICAgdGhpcy5mb3JjZVJlbmRlcktleXMsXG4gICAgICAgIHJlbmRlcmVyLFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRyZWVOb2RlUmVuZGVyZXIsXG4gICAgICAgIGxvYWREYXRhLFxuICAgICAgICB0aXRsZUZpZWxkLFxuICAgICAgKTtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHByb3BzLm9uRXhwYW5kID0gdGhpcy5oYW5kbGVFeHBhbmQ7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBwcm9wcy5vbkNoZWNrID0gdGhpcy5oYW5kbGVDaGVjaztcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHByb3BzLm9uU2VsZWN0ID0gdGhpcy5oYW5kbGVTZWxlY3Q7XG4gICAgICBwcm9wcy5sb2FkRGF0YSA9IGxvYWREYXRhO1xuICAgICAgcHJvcHMuZXhwYW5kZWRLZXlzID0gdGhpcy5leHBhbmRlZEtleXMuc2xpY2UoKTtcbiAgICAgIHByb3BzLmNoZWNrZWRLZXlzID0gdGhpcy5jaGVja2VkS2V5cy5zbGljZSgpO1xuICAgICAgcHJvcHMubXVsdGlwbGUgPSBkYXRhU2V0LnByb3BzLnNlbGVjdGlvbiA9PT0gRGF0YVNldFNlbGVjdGlvbi5tdWx0aXBsZTtcbiAgICAgIHByb3BzLnNlbGVjdGVkS2V5cyA9IHRoaXMuc2VsZWN0ZWRLZXlzLnNsaWNlKCk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8U3BpbiBkYXRhU2V0PXtkYXRhU2V0fT5cbiAgICAgICAgICA8QzdOVHJlZSB7Li4ub3RoZXJQcm9wc30gey4uLnByb3BzfSAvPlxuICAgICAgICA8L1NwaW4+XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gPEM3TlRyZWUgey4uLm90aGVyUHJvcHN9IC8+O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=