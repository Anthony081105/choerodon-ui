import { __decorate } from "tslib";
import React, { cloneElement, Component } from 'react';
import { observer } from 'mobx-react';
import { pxToRem } from 'choerodon-ui/lib/_util/UnitConvertor';
import { getProPrefixCls } from 'choerodon-ui/lib/configure';
import Button from '../../button';
import TableContext from '../TableContext';
import { $l } from '../../locale-context';
import autobind from '../../_util/autobind';
import TableButtons from './TableButtons';
import FilterSelect from './FilterSelect';
import Modal from '../../modal';
import Form from '../../form/Form';
let TableAdvancedQueryBar = class TableAdvancedQueryBar extends Component {
    componentWillUnmount() {
        if (this.modal) {
            this.modal.close(true);
        }
    }
    handleFieldEnter() {
        this.handleQuery();
        if (this.modal) {
            this.modal.close();
        }
    }
    handleQuery() {
        const { dataSet } = this.props;
        dataSet.query();
    }
    valueFilter(value) {
        const { queryFields, queryFieldsLimit } = this.props;
        return queryFields.slice(0, queryFieldsLimit).every(element => element.props.name !== value);
    }
    getMoreFieldsButton(fields) {
        if (fields.length) {
            return (React.createElement(Button, { funcType: "raised" /* raised */, color: "primary" /* primary */, onClick: () => this.openMore(fields) }, $l('Table', 'advanced_query')));
        }
    }
    openMore(children) {
        this.modal = Modal.open({
            title: $l('Table', 'advanced_query'),
            children: React.createElement(Form, { labelLayout: "float" /* float */ }, children),
            okText: $l('Table', 'query_button'),
            onOk: this.handleQuery,
            style: {
                width: pxToRem(380),
            },
            drawer: true,
        });
    }
    getResetButton() {
        return (React.createElement(Button, { funcType: "raised" /* raised */, onClick: this.handleQueryReset }, $l('Table', 'reset_button')));
    }
    getQueryBar() {
        const { prefixCls, queryFieldsLimit, queryFields, buttons, queryDataSet } = this.props;
        if (queryDataSet && queryFields.length) {
            const currentFields = this.createFields(queryFields.slice(0, queryFieldsLimit), queryDataSet, false);
            const moreFields = this.createFields(queryFields.slice(queryFieldsLimit), queryDataSet, true);
            const moreFieldsButton = this.getMoreFieldsButton(moreFields);
            return (React.createElement("div", { key: "toolbar", className: `${prefixCls}-advanced-query-bar` },
                currentFields,
                React.createElement("span", { className: `${prefixCls}-advanced-query-bar-button` },
                    this.getResetButton(),
                    moreFieldsButton,
                    buttons)));
        }
    }
    createFields(elements, dataSet, isMore) {
        return elements.map(element => {
            const { name, style } = element.props;
            const newStyle = {};
            if (!isMore) {
                newStyle.width = pxToRem(260);
                newStyle.marginRight = pxToRem(10);
            }
            const props = {
                onEnterDown: this.handleFieldEnter,
                labelLayout: "float" /* float */,
                style: {
                    marginRight: !isMore ? pxToRem(10) : 0,
                    ...style,
                },
            };
            const field = dataSet.getField(name);
            if (field) {
                const label = field.get('label');
                if (label) {
                    if (isMore) {
                        props.label = label;
                    }
                    else {
                        props.placeholder = label;
                    }
                }
            }
            return cloneElement(element, props);
        });
    }
    handleQueryReset() {
        const { queryDataSet, dataSet, queryFields } = this.props;
        if (queryDataSet) {
            const { current } = queryDataSet;
            if (current) {
                current.reset();
            }
            dataSet.fireEvent('queryBarReset', {
                dataSet,
                queryFields,
            });
            this.handleQuery();
        }
    }
    getFilterSelect() {
        const { prefixCls, dataSet, queryDataSet } = this.props;
        return (React.createElement(FilterSelect, { key: "filter", prefixCls: `${prefixCls}-filter-select`, className: `${prefixCls}-advanced-query-bar-options`, optionDataSet: dataSet, queryDataSet: queryDataSet, prefix: `${$l('Table', 'advanced_query_conditions')}:`, editable: false, filter: this.valueFilter, hiddenIfNone: true }));
    }
    render() {
        const { buttons, prefixCls } = this.props;
        const queryBar = this.getQueryBar();
        if (queryBar) {
            return [queryBar, this.getFilterSelect()];
        }
        return React.createElement(TableButtons, { key: "toolbar", prefixCls: prefixCls, buttons: buttons });
    }
};
TableAdvancedQueryBar.contextType = TableContext;
TableAdvancedQueryBar.defaultProps = {
    prefixCls: getProPrefixCls('table'),
    queryFieldsLimit: 1,
};
__decorate([
    autobind
], TableAdvancedQueryBar.prototype, "handleFieldEnter", null);
__decorate([
    autobind
], TableAdvancedQueryBar.prototype, "handleQuery", null);
__decorate([
    autobind
], TableAdvancedQueryBar.prototype, "valueFilter", null);
__decorate([
    autobind
], TableAdvancedQueryBar.prototype, "handleQueryReset", null);
TableAdvancedQueryBar = __decorate([
    observer
], TableAdvancedQueryBar);
export default TableAdvancedQueryBar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RhYmxlL3F1ZXJ5LWJhci9UYWJsZUFkdmFuY2VkUXVlcnlCYXIudHN4IiwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssRUFBRSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQTBDLE1BQU0sT0FBTyxDQUFDO0FBQy9GLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUc3RCxPQUFPLE1BQU0sTUFBTSxjQUFjLENBQUM7QUFDbEMsT0FBTyxZQUFZLE1BQU0saUJBQWlCLENBQUM7QUFJM0MsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzFDLE9BQU8sUUFBUSxNQUFNLHNCQUFzQixDQUFDO0FBRTVDLE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxNQUFNLGFBQWEsQ0FBQztBQUNoQyxPQUFPLElBQUksTUFBTSxpQkFBaUIsQ0FBQztBQWFuQyxJQUFxQixxQkFBcUIsR0FBMUMsTUFBcUIscUJBQXNCLFNBQVEsU0FBcUM7SUFZdEYsb0JBQW9CO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztJQUdELGdCQUFnQjtRQUNkLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztJQUdELFdBQVc7UUFDVCxNQUFNLEVBQUUsT0FBTyxF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QUFDLE9BQU8sQ0FBQztJQUNuQyxnQkFBZ0IsRUFBRSxDQUFDO0NBQ3BCLENBQUM7QUFhRjtJQURDLFFBQVE7NkRBTVI7QUFHRDtJQURDLFFBQVE7d0RBSVI7QUFHRDtJQURDLFFBQVE7d0RBSVI7QUE0RkQ7SUFEQyxRQUFROzZEQWNSO0FBN0lrQixxQkFBcUI7SUFEekMsUUFBUTtHQUNZLHFCQUFxQixDQTBLekM7ZUExS29CLHFCQUFxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy1wcm8vdGFibGUvcXVlcnktYmFyL1RhYmxlQWR2YW5jZWRRdWVyeUJhci50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IGNsb25lRWxlbWVudCwgQ29tcG9uZW50LCBDU1NQcm9wZXJ0aWVzLCBSZWFjdEVsZW1lbnQsIFJlYWN0Tm9kZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IG9ic2VydmVyIH0gZnJvbSAnbW9ieC1yZWFjdCc7XG5pbXBvcnQgeyBweFRvUmVtIH0gZnJvbSAnY2hvZXJvZG9uLXVpL2xpYi9fdXRpbC9Vbml0Q29udmVydG9yJztcbmltcG9ydCB7IGdldFByb1ByZWZpeENscyB9IGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvY29uZmlndXJlJztcbmltcG9ydCBGaWVsZCBmcm9tICcuLi8uLi9kYXRhLXNldC9GaWVsZCc7XG5pbXBvcnQgRGF0YVNldCBmcm9tICcuLi8uLi9kYXRhLXNldCc7XG5pbXBvcnQgQnV0dG9uIGZyb20gJy4uLy4uL2J1dHRvbic7XG5pbXBvcnQgVGFibGVDb250ZXh0IGZyb20gJy4uL1RhYmxlQ29udGV4dCc7XG5pbXBvcnQgeyBFbGVtZW50UHJvcHMgfSBmcm9tICcuLi8uLi9jb3JlL1ZpZXdDb21wb25lbnQnO1xuaW1wb3J0IHsgQnV0dG9uQ29sb3IsIEZ1bmNUeXBlIH0gZnJvbSAnLi4vLi4vYnV0dG9uL2VudW0nO1xuaW1wb3J0IHsgQnV0dG9uUHJvcHMgfSBmcm9tICcuLi8uLi9idXR0b24vQnV0dG9uJztcbmltcG9ydCB7ICRsIH0gZnJvbSAnLi4vLi4vbG9jYWxlLWNvbnRleHQnO1xuaW1wb3J0IGF1dG9iaW5kIGZyb20gJy4uLy4uL191dGlsL2F1dG9iaW5kJztcbmltcG9ydCB7IFBhZ2luYXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL3BhZ2luYXRpb24vUGFnaW5hdGlvbic7XG5pbXBvcnQgVGFibGVCdXR0b25zIGZyb20gJy4vVGFibGVCdXR0b25zJztcbmltcG9ydCBGaWx0ZXJTZWxlY3QgZnJvbSAnLi9GaWx0ZXJTZWxlY3QnO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uLy4uL21vZGFsJztcbmltcG9ydCBGb3JtIGZyb20gJy4uLy4uL2Zvcm0vRm9ybSc7XG5pbXBvcnQgeyBMYWJlbExheW91dCB9IGZyb20gJy4uLy4uL2Zvcm0vZW51bSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGVBZHZhbmNlZFF1ZXJ5QmFyUHJvcHMgZXh0ZW5kcyBFbGVtZW50UHJvcHMge1xuICBkYXRhU2V0OiBEYXRhU2V0O1xuICBxdWVyeURhdGFTZXQ/OiBEYXRhU2V0O1xuICBxdWVyeUZpZWxkczogUmVhY3RFbGVtZW50PGFueT5bXTtcbiAgcXVlcnlGaWVsZHNMaW1pdD86IG51bWJlcjtcbiAgYnV0dG9uczogUmVhY3RFbGVtZW50PEJ1dHRvblByb3BzPltdO1xuICBwYWdpbmF0aW9uPzogUmVhY3RFbGVtZW50PFBhZ2luYXRpb25Qcm9wcz47XG59XG5cbkBvYnNlcnZlclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGFibGVBZHZhbmNlZFF1ZXJ5QmFyIGV4dGVuZHMgQ29tcG9uZW50PFRhYmxlQWR2YW5jZWRRdWVyeUJhclByb3BzPiB7XG4gIHN0YXRpYyBjb250ZXh0VHlwZSA9IFRhYmxlQ29udGV4dDtcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIHByZWZpeENsczogZ2V0UHJvUHJlZml4Q2xzKCd0YWJsZScpLFxuICAgIHF1ZXJ5RmllbGRzTGltaXQ6IDEsXG4gIH07XG5cbiAgbW9yZUZpZWxkczogRmllbGRbXTtcblxuICBtb2RhbDtcblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICBpZiAodGhpcy5tb2RhbCkge1xuICAgICAgdGhpcy5tb2RhbC5jbG9zZSh0cnVlKTtcbiAgICB9XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgaGFuZGxlRmllbGRFbnRlcigpIHtcbiAgICB0aGlzLmhhbmRsZVF1ZXJ5KCk7XG4gICAgaWYgKHRoaXMubW9kYWwpIHtcbiAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgaGFuZGxlUXVlcnkoKSB7XG4gICAgY29uc3QgeyBkYXRhU2V0IH0gPSB0aGlzLnByb3BzO1xuICAgIGRhdGFTZXQucXVlcnkoKTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICB2YWx1ZUZpbHRlcih2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgeyBxdWVyeUZpZWxkcywgcXVlcnlGaWVsZHNMaW1pdCB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gcXVlcnlGaWVsZHMuc2xpY2UoMCwgcXVlcnlGaWVsZHNMaW1pdCkuZXZlcnkoZWxlbWVudCA9PiBlbGVtZW50LnByb3BzLm5hbWUgIT09IHZhbHVlKTtcbiAgfVxuXG4gIGdldE1vcmVGaWVsZHNCdXR0b24oZmllbGRzOiBSZWFjdEVsZW1lbnQ8YW55PltdKSB7XG4gICAgaWYgKGZpZWxkcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxCdXR0b25cbiAgICAgICAgICBmdW5jVHlwZT17RnVuY1R5cGUucmFpc2VkfVxuICAgICAgICAgIGNvbG9yPXtCdXR0b25Db2xvci5wcmltYXJ5fVxuICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHRoaXMub3Blbk1vcmUoZmllbGRzKX1cbiAgICAgICAgPlxuICAgICAgICAgIHskbCgnVGFibGUnLCAnYWR2YW5jZWRfcXVlcnknKX1cbiAgICAgICAgPC9CdXR0b24+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG9wZW5Nb3JlKGNoaWxkcmVuOiBSZWFjdEVsZW1lbnQ8YW55PltdKSB7XG4gICAgdGhpcy5tb2RhbCA9IE1vZGFsLm9wZW4oe1xuICAgICAgdGl0bGU6ICRsKCdUYWJsZScsICdhZHZhbmNlZF9xdWVyeScpLFxuICAgICAgY2hpbGRyZW46IDxGb3JtIGxhYmVsTGF5b3V0PXtMYWJlbExheW91dC5mbG9hdH0+e2NoaWxkcmVufTwvRm9ybT4sXG4gICAgICBva1RleHQ6ICRsKCdUYWJsZScsICdxdWVyeV9idXR0b24nKSxcbiAgICAgIG9uT2s6IHRoaXMuaGFuZGxlUXVlcnksXG4gICAgICBzdHlsZToge1xuICAgICAgICB3aWR0aDogcHhUb1JlbSgzODApLFxuICAgICAgfSxcbiAgICAgIGRyYXdlcjogdHJ1ZSxcbiAgICB9KTtcbiAgfVxuXG4gIGdldFJlc2V0QnV0dG9uKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8QnV0dG9uIGZ1bmNUeXBlPXtGdW5jVHlwZS5yYWlzZWR9IG9uQ2xpY2s9e3RoaXMuaGFuZGxlUXVlcnlSZXNldH0+XG4gICAgICAgIHskbCgnVGFibGUnLCAncmVzZXRfYnV0dG9uJyl9XG4gICAgICA8L0J1dHRvbj5cbiAgICApO1xuICB9XG5cbiAgZ2V0UXVlcnlCYXIoKTogUmVhY3ROb2RlIHtcbiAgICBjb25zdCB7IHByZWZpeENscywgcXVlcnlGaWVsZHNMaW1pdCwgcXVlcnlGaWVsZHMsIGJ1dHRvbnMsIHF1ZXJ5RGF0YVNldCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAocXVlcnlEYXRhU2V0ICYmIHF1ZXJ5RmllbGRzLmxlbmd0aCkge1xuICAgICAgY29uc3QgY3VycmVudEZpZWxkcyA9IHRoaXMuY3JlYXRlRmllbGRzKFxuICAgICAgICBxdWVyeUZpZWxkcy5zbGljZSgwLCBxdWVyeUZpZWxkc0xpbWl0KSxcbiAgICAgICAgcXVlcnlEYXRhU2V0LFxuICAgICAgICBmYWxzZSxcbiAgICAgICk7XG4gICAgICBjb25zdCBtb3JlRmllbGRzID0gdGhpcy5jcmVhdGVGaWVsZHMocXVlcnlGaWVsZHMuc2xpY2UocXVlcnlGaWVsZHNMaW1pdCksIHF1ZXJ5RGF0YVNldCwgdHJ1ZSk7XG4gICAgICBjb25zdCBtb3JlRmllbGRzQnV0dG9uOiBSZWFjdEVsZW1lbnQgfCB1bmRlZmluZWQgPSB0aGlzLmdldE1vcmVGaWVsZHNCdXR0b24obW9yZUZpZWxkcyk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGtleT1cInRvb2xiYXJcIiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tYWR2YW5jZWQtcXVlcnktYmFyYH0+XG4gICAgICAgICAge2N1cnJlbnRGaWVsZHN9XG4gICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWFkdmFuY2VkLXF1ZXJ5LWJhci1idXR0b25gfT5cbiAgICAgICAgICAgIHt0aGlzLmdldFJlc2V0QnV0dG9uKCl9XG4gICAgICAgICAgICB7bW9yZUZpZWxkc0J1dHRvbn1cbiAgICAgICAgICAgIHtidXR0b25zfVxuICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGNyZWF0ZUZpZWxkcyhlbGVtZW50czogUmVhY3RFbGVtZW50PGFueT5bXSwgZGF0YVNldDogRGF0YVNldCwgaXNNb3JlOiBib29sZWFuKTogUmVhY3RFbGVtZW50W10ge1xuICAgIHJldHVybiBlbGVtZW50cy5tYXAoZWxlbWVudCA9PiB7XG4gICAgICBjb25zdCB7IG5hbWUsIHN0eWxlIH0gPSBlbGVtZW50LnByb3BzO1xuICAgICAgY29uc3QgbmV3U3R5bGU6IENTU1Byb3BlcnRpZXMgPSB7fTtcbiAgICAgIGlmICghaXNNb3JlKSB7XG4gICAgICAgIG5ld1N0eWxlLndpZHRoID0gcHhUb1JlbSgyNjApO1xuICAgICAgICBuZXdTdHlsZS5tYXJnaW5SaWdodCA9IHB4VG9SZW0oMTApO1xuICAgICAgfVxuICAgICAgY29uc3QgcHJvcHM6IGFueSA9IHtcbiAgICAgICAgb25FbnRlckRvd246IHRoaXMuaGFuZGxlRmllbGRFbnRlcixcbiAgICAgICAgbGFiZWxMYXlvdXQ6IExhYmVsTGF5b3V0LmZsb2F0LFxuICAgICAgICBzdHlsZToge1xuICAgICAgICAgIG1hcmdpblJpZ2h0OiAhaXNNb3JlID8gcHhUb1JlbSgxMCkgOiAwLFxuICAgICAgICAgIC4uLnN0eWxlLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGNvbnN0IGZpZWxkID0gZGF0YVNldC5nZXRGaWVsZChuYW1lKTtcbiAgICAgIGlmIChmaWVsZCkge1xuICAgICAgICBjb25zdCBsYWJlbCA9IGZpZWxkLmdldCgnbGFiZWwnKTtcbiAgICAgICAgaWYgKGxhYmVsKSB7XG4gICAgICAgICAgaWYgKGlzTW9yZSkge1xuICAgICAgICAgICAgcHJvcHMubGFiZWwgPSBsYWJlbDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJvcHMucGxhY2Vob2xkZXIgPSBsYWJlbDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBjbG9uZUVsZW1lbnQoZWxlbWVudCwgcHJvcHMpO1xuICAgIH0pO1xuICB9XG5cbiAgQGF1dG9iaW5kXG4gIGhhbmRsZVF1ZXJ5UmVzZXQoKSB7XG4gICAgY29uc3QgeyBxdWVyeURhdGFTZXQsIGRhdGFTZXQsIHF1ZXJ5RmllbGRzIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChxdWVyeURhdGFTZXQpIHtcbiAgICAgIGNvbnN0IHsgY3VycmVudCB9ID0gcXVlcnlEYXRhU2V0O1xuICAgICAgaWYgKGN1cnJlbnQpIHtcbiAgICAgICAgY3VycmVudC5yZXNldCgpO1xuICAgICAgfVxuICAgICAgZGF0YVNldC5maXJlRXZlbnQoJ3F1ZXJ5QmFyUmVzZXQnLCB7XG4gICAgICAgIGRhdGFTZXQsXG4gICAgICAgIHF1ZXJ5RmllbGRzLFxuICAgICAgfSk7XG4gICAgICB0aGlzLmhhbmRsZVF1ZXJ5KCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0RmlsdGVyU2VsZWN0KCkge1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzLCBkYXRhU2V0LCBxdWVyeURhdGFTZXQgfSA9IHRoaXMucHJvcHM7XG4gICAgcmV0dXJuIChcbiAgICAgIDxGaWx0ZXJTZWxlY3RcbiAgICAgICAga2V5PVwiZmlsdGVyXCJcbiAgICAgICAgcHJlZml4Q2xzPXtgJHtwcmVmaXhDbHN9LWZpbHRlci1zZWxlY3RgfVxuICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tYWR2YW5jZWQtcXVlcnktYmFyLW9wdGlvbnNgfVxuICAgICAgICBvcHRpb25EYXRhU2V0PXtkYXRhU2V0fVxuICAgICAgICBxdWVyeURhdGFTZXQ9e3F1ZXJ5RGF0YVNldH1cbiAgICAgICAgcHJlZml4PXtgJHskbCgnVGFibGUnLCAnYWR2YW5jZWRfcXVlcnlfY29uZGl0aW9ucycpfTpgfVxuICAgICAgICBlZGl0YWJsZT17ZmFsc2V9XG4gICAgICAgIGZpbHRlcj17dGhpcy52YWx1ZUZpbHRlcn1cbiAgICAgICAgaGlkZGVuSWZOb25lXG4gICAgICAvPlxuICAgICk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBidXR0b25zLCBwcmVmaXhDbHMgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgcXVlcnlCYXIgPSB0aGlzLmdldFF1ZXJ5QmFyKCk7XG5cbiAgICBpZiAocXVlcnlCYXIpIHtcbiAgICAgIHJldHVybiBbcXVlcnlCYXIsIHRoaXMuZ2V0RmlsdGVyU2VsZWN0KCldO1xuICAgIH1cblxuICAgIHJldHVybiA8VGFibGVCdXR0b25zIGtleT1cInRvb2xiYXJcIiBwcmVmaXhDbHM9e3ByZWZpeENsc30gYnV0dG9ucz17YnV0dG9uc30gLz47XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==