import { Children, cloneElement, Component } from 'react';
import PropTypes from 'prop-types';
import { findDOMNode } from 'react-dom';
import noop from 'lodash/noop';
import domAlign from 'dom-align';
import EventManager from '../_util/EventManager';
import TaskRunner from '../_util/TaskRunner';
function isWindow(obj) {
    return obj != null && obj === obj.window;
}
export default class Align extends Component {
    forceAlign() {
        const { hidden, onAlign = noop, target = () => window, align } = this.props;
        if (!hidden) {
            const source = findDOMNode(this);
            const ref = target();
            onAlign(source, domAlign(source, ref, align), ref);
        }
    }
    componentDidMount() {
        const { hidden, monitorWindowResize } = this.props;
        this.forceAlign();
        if (!hidden && monitorWindowResize) {
            this.startMonitorWindowResize();
        }
    }
    componentDidUpdate(prevProps) {
        const { hidden, align, target = () => window, monitorWindowResize } = this.props;
        const { hidden: preHidden, align: preAlign, target: preTarget } = prevProps;
        let reAlign = false;
        if (!hidden) {
            if (preHidden || preAlign !== align) {
                reAlign = true;
            }
            else {
                const lastTarget = preTarget();
                const currentTarget = target();
                if (isWindow(lastTarget) && isWindow(currentTarget)) {
                    reAlign = false;
                }
                else if (lastTarget !== currentTarget) {
                    reAlign = true;
                }
            }
        }
        if (reAlign) {
            this.forceAlign();
        }
        if (monitorWindowResize && !hidden) {
            this.startMonitorWindowResize();
        }
        else {
            this.stopMonitorWindowResize();
        }
    }
    componentWillUnmount() {
        this.stopMonitorWindowResize();
    }
    startMonitorWindowResize() {
        const { monitorBufferTime } = this.props;
        if (!this.resizeHandler) {
            this.resizeHandler = new EventManager(window);
            this.bufferMonitor = new TaskRunner();
            this.resizeHandler.addEventListener('resize', this.bufferMonitor.delay.bind(this.bufferMonitor, monitorBufferTime, this.forceAlign.bind(this)));
        }
    }
    stopMonitorWindowResize() {
        if (this.resizeHandler) {
            if (this.bufferMonitor) {
                this.bufferMonitor.cancel();
            }
            this.resizeHandler.clear();
            this.resizeHandler = null;
        }
    }
    render() {
        const { props } = this;
        const { childrenProps, children } = props;
        if (childrenProps) {
            const newProps = {};
            Object.keys(childrenProps).forEach(prop => {
                if ({}.hasOwnProperty.call(childrenProps, prop)) {
                    newProps[prop] = props[childrenProps[prop]];
                }
            });
            return cloneElement(Children.only(children), newProps);
        }
        return children;
    }
}
Align.displayName = 'Align';
Align.propTypes = {
    childrenProps: PropTypes.object,
    align: PropTypes.object.isRequired,
    target: PropTypes.func,
    onAlign: PropTypes.func,
    monitorBufferTime: PropTypes.number,
    monitorWindowResize: PropTypes.bool,
    hidden: PropTypes.bool,
    children: PropTypes.any,
};
Align.defaultProps = {
    monitorBufferTime: 50,
    monitorWindowResize: false,
    hidden: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvYWxpZ24vQWxpZ24udHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUMxRCxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4QyxPQUFPLElBQUksTUFBTSxhQUFhLENBQUM7QUFDL0IsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sWUFBWSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sVUFBVSxNQUFNLHFCQUFxQixDQUFDO0FBRTdDLFNBQVMsUUFBUSxDQUFDLEdBQUc7SUFDbkIsT0FBTyxHQUFHLElBQUksSUFBSSxJQUFJLEdBQUcsS0FBSyxHQUFHLENBQUMsTUFBTSxDQUFDO0FBQzNDLENBQUM7QUFpQkQsTUFBTSxDQUFDLE9BQU8sT0FBTyxLQUFNLFNBQVEsU0FBMEI7SUF3QjNELFVBQVU7UUFDUixNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sR0FBRyxJQUFJLEVBQUUsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzVFLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakMsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7SUFFRCxpQkFBaUI7UUFDZixNQUFNLEVBQUUsTUFBTSxFQUFFLG1CQUFtQixFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FB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SUFBSSxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQy9DLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7aUJBQzdDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ3hEO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQzs7QUFqSE0saUJBQVcsR0FBRyxPQUFPLENBQUM7QUFFdEIsZUFBUyxHQUFHO0lBQ2pCLGFBQWEsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMvQixLQUFLLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO0lBQ2xDLE1BQU0sRUFBRSxTQUFTLENBQUMsSUFBSTtJQUN0QixPQUFPLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDdkIsaUJBQWlCLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDbkMsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDbkMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQ3RCLFFBQVEsRUFBRSxTQUFTLENBQUMsR0FBRztDQUN4QixDQUFDO0FBRUssa0JBQVksR0FBRztJQUNwQixpQkFBaUIsRUFBRSxFQUFFO0lBQ3JCLG1CQUFtQixFQUFFLEtBQUs7SUFDMUIsTUFBTSxFQUFFLElBQUk7Q0FDYixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL2FsaWduL0FsaWduLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGlsZHJlbiwgY2xvbmVFbGVtZW50LCBDb21wb25lbnQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHsgZmluZERPTU5vZGUgfSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IG5vb3AgZnJvbSAnbG9kYXNoL25vb3AnO1xuaW1wb3J0IGRvbUFsaWduIGZyb20gJ2RvbS1hbGlnbic7XG5pbXBvcnQgRXZlbnRNYW5hZ2VyIGZyb20gJy4uL191dGlsL0V2ZW50TWFuYWdlcic7XG5pbXBvcnQgVGFza1J1bm5lciBmcm9tICcuLi9fdXRpbC9UYXNrUnVubmVyJztcblxuZnVuY3Rpb24gaXNXaW5kb3cob2JqKSB7XG4gIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7XG59XG5cbnR5cGUgRmlyc3RQYXJhbTxUIGV4dGVuZHMgKC4uLmFyZ3M6IGFueSkgPT4gYW55PiA9IFQgZXh0ZW5kcyAoYXJnMTogaW5mZXIgQSwgLi4ucmVzdDogYW55KSA9PiBhbnlcbiAgPyBBXG4gIDogbmV2ZXI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWxpZ25Qcm9wcyB7XG4gIGNoaWxkcmVuUHJvcHM/OiBvYmplY3Q7XG4gIGFsaWduOiBvYmplY3Q7XG4gIHRhcmdldD86ICgpID0+IE5vZGUgfCBXaW5kb3c7XG4gIG9uQWxpZ24/OiAoc291cmNlOiBFbGVtZW50IHwgVGV4dCB8IG51bGwsIGFsaWduOiBvYmplY3QsIHRhcmdldDogTm9kZSB8IFdpbmRvdykgPT4gdm9pZDtcbiAgbW9uaXRvckJ1ZmZlclRpbWU/OiBudW1iZXI7XG4gIG1vbml0b3JXaW5kb3dSZXNpemU/OiBib29sZWFuO1xuICBoaWRkZW4/OiBib29sZWFuO1xuICBjaGlsZHJlbjogRmlyc3RQYXJhbTx0eXBlb2YgY2xvbmVFbGVtZW50Pjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWxpZ24gZXh0ZW5kcyBDb21wb25lbnQ8QWxpZ25Qcm9wcywgYW55PiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdBbGlnbic7XG5cbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBjaGlsZHJlblByb3BzOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIGFsaWduOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgdGFyZ2V0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkFsaWduOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBtb25pdG9yQnVmZmVyVGltZTogUHJvcFR5cGVzLm51bWJlcixcbiAgICBtb25pdG9yV2luZG93UmVzaXplOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBoaWRkZW46IFByb3BUeXBlcy5ib29sLFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuYW55LFxuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgbW9uaXRvckJ1ZmZlclRpbWU6IDUwLFxuICAgIG1vbml0b3JXaW5kb3dSZXNpemU6IGZhbHNlLFxuICAgIGhpZGRlbjogdHJ1ZSxcbiAgfTtcblxuICByZXNpemVIYW5kbGVyOiBFdmVudE1hbmFnZXIgfCBudWxsO1xuXG4gIGJ1ZmZlck1vbml0b3I6IFRhc2tSdW5uZXIgfCBudWxsO1xuXG4gIGZvcmNlQWxpZ24oKSB7XG4gICAgY29uc3QgeyBoaWRkZW4sIG9uQWxpZ24gPSBub29wLCB0YXJnZXQgPSAoKSA9PiB3aW5kb3csIGFsaWduIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmICghaGlkZGVuKSB7XG4gICAgICBjb25zdCBzb3VyY2UgPSBmaW5kRE9NTm9kZSh0aGlzKTtcbiAgICAgIGNvbnN0IHJlZiA9IHRhcmdldCgpO1xuICAgICAgb25BbGlnbihzb3VyY2UsIGRvbUFsaWduKHNvdXJjZSwgcmVmLCBhbGlnbiksIHJlZik7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgY29uc3QgeyBoaWRkZW4sIG1vbml0b3JXaW5kb3dSZXNpemUgfSA9IHRoaXMucHJvcHM7XG4gICAgdGhpcy5mb3JjZUFsaWduKCk7XG4gICAgaWYgKCFoaWRkZW4gJiYgbW9uaXRvcldpbmRvd1Jlc2l6ZSkge1xuICAgICAgdGhpcy5zdGFydE1vbml0b3JXaW5kb3dSZXNpemUoKTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzKSB7XG4gICAgY29uc3QgeyBoaWRkZW4sIGFsaWduLCB0YXJnZXQgPSAoKSA9PiB3aW5kb3csIG1vbml0b3JXaW5kb3dSZXNpemUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBoaWRkZW46IHByZUhpZGRlbiwgYWxpZ246IHByZUFsaWduLCB0YXJnZXQ6IHByZVRhcmdldCB9ID0gcHJldlByb3BzO1xuICAgIGxldCByZUFsaWduID0gZmFsc2U7XG5cbiAgICBpZiAoIWhpZGRlbikge1xuICAgICAgaWYgKHByZUhpZGRlbiB8fCBwcmVBbGlnbiAhPT0gYWxpZ24pIHtcbiAgICAgICAgcmVBbGlnbiA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBsYXN0VGFyZ2V0ID0gcHJlVGFyZ2V0KCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUYXJnZXQgPSB0YXJnZXQoKTtcbiAgICAgICAgaWYgKGlzV2luZG93KGxhc3RUYXJnZXQpICYmIGlzV2luZG93KGN1cnJlbnRUYXJnZXQpKSB7XG4gICAgICAgICAgcmVBbGlnbiA9IGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKGxhc3RUYXJnZXQgIT09IGN1cnJlbnRUYXJnZXQpIHtcbiAgICAgICAgICByZUFsaWduID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChyZUFsaWduKSB7XG4gICAgICB0aGlzLmZvcmNlQWxpZ24oKTtcbiAgICB9XG5cbiAgICBpZiAobW9uaXRvcldpbmRvd1Jlc2l6ZSAmJiAhaGlkZGVuKSB7XG4gICAgICB0aGlzLnN0YXJ0TW9uaXRvcldpbmRvd1Jlc2l6ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0b3BNb25pdG9yV2luZG93UmVzaXplKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5zdG9wTW9uaXRvcldpbmRvd1Jlc2l6ZSgpO1xuICB9XG5cbiAgc3RhcnRNb25pdG9yV2luZG93UmVzaXplKCkge1xuICAgIGNvbnN0IHsgbW9uaXRvckJ1ZmZlclRpbWUgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCF0aGlzLnJlc2l6ZUhhbmRsZXIpIHtcbiAgICAgIHRoaXMucmVzaXplSGFuZGxlciA9IG5ldyBFdmVudE1hbmFnZXIod2luZG93KTtcbiAgICAgIHRoaXMuYnVmZmVyTW9uaXRvciA9IG5ldyBUYXNrUnVubmVyKCk7XG4gICAgICB0aGlzLnJlc2l6ZUhhbmRsZXIuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3Jlc2l6ZScsXG4gICAgICAgIHRoaXMuYnVmZmVyTW9uaXRvci5kZWxheS5iaW5kKFxuICAgICAgICAgIHRoaXMuYnVmZmVyTW9uaXRvcixcbiAgICAgICAgICBtb25pdG9yQnVmZmVyVGltZSxcbiAgICAgICAgICB0aGlzLmZvcmNlQWxpZ24uYmluZCh0aGlzKSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgc3RvcE1vbml0b3JXaW5kb3dSZXNpemUoKSB7XG4gICAgaWYgKHRoaXMucmVzaXplSGFuZGxlcikge1xuICAgICAgaWYgKHRoaXMuYnVmZmVyTW9uaXRvcikge1xuICAgICAgICB0aGlzLmJ1ZmZlck1vbml0b3IuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgICB0aGlzLnJlc2l6ZUhhbmRsZXIuY2xlYXIoKTtcbiAgICAgIHRoaXMucmVzaXplSGFuZGxlciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBjaGlsZHJlblByb3BzLCBjaGlsZHJlbiB9ID0gcHJvcHM7XG4gICAgaWYgKGNoaWxkcmVuUHJvcHMpIHtcbiAgICAgIGNvbnN0IG5ld1Byb3BzID0ge307XG4gICAgICBPYmplY3Qua2V5cyhjaGlsZHJlblByb3BzKS5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChjaGlsZHJlblByb3BzLCBwcm9wKSkge1xuICAgICAgICAgIG5ld1Byb3BzW3Byb3BdID0gcHJvcHNbY2hpbGRyZW5Qcm9wc1twcm9wXV07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGNsb25lRWxlbWVudChDaGlsZHJlbi5vbmx5KGNoaWxkcmVuKSwgbmV3UHJvcHMpO1xuICAgIH1cbiAgICByZXR1cm4gY2hpbGRyZW47XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==