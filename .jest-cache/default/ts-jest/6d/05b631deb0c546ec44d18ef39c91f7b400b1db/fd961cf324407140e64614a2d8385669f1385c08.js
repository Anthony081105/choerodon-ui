/**
 * 裁剪组件
 */
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { getPrefixCls } from '../configure';
let relativeX = 0;
let relativeY = 0;
let resizeMode;
let resizeX = 0;
let resizeY = 0;
let resizeSize = 0;
/**
 * when can't be exact division it will return false
 * @param rotate
 */
function rotateFlag(rotate) {
    return (rotate / 90) % 2 !== 0;
}
export default class Crop extends Component {
    constructor(props) {
        super(props);
        this.handleMoveStart = ({ clientX, clientY }) => {
            const { x, y } = this.state;
            relativeX = clientX - x;
            relativeY = clientY - y;
            document.addEventListener('mousemove', this.handleMoving);
            document.addEventListener('mouseup', this.handleMoveEnd);
        };
        this.handleMoving = ({ clientX, clientY }) => {
            const { size, imageStyle: { width, height }, rotate } = this.state;
            const { onComplete } = this.props;
            const flag = rotateFlag(rotate);
            const minX = flag ? (width - height) / 2 : 0; // if can't be exact division min is 0
            const minY = flag ? (height - width) / 2 : 0; // if can't be exact division min is 0
            const maxX = width - size - minX; // the max width is image minus the size , there would minus the sizeWidth
            const maxY = height - size - minY; // the max height is image minus the size , there would minus the sizeHeight 
            const movingXY = {
                x: Math.min(Math.max(minX, clientX - relativeX), maxX),
                y: Math.min(Math.max(minY, clientY - relativeY), maxY),
            };
            if (onComplete) {
                const completeXY = { ...movingXY, size };
                onComplete(completeXY);
            }
            this.setState(movingXY);
        };
        this.handleMoveEnd = () => {
            document.removeEventListener('mousemove', this.handleMoving);
            document.removeEventListener('mouseup', this.handleMoveEnd);
        };
        this.handleResizeStart = (e) => {
            e.stopPropagation();
            const { currentTarget, clientX, clientY } = e; // mouse of body the x y position
            const { x, y, size } = this.state;
            relativeX = clientX - x; // relativeX 
            relativeY = clientY - y; // relativeY
            resizeMode = currentTarget.className; // to confirm the witch border on handle 
            resizeX = x; // x of image position
            resizeY = y; // y of image position
            resizeSize = size; // size of crop area , TODO change to resizeHeight resizeWidth 
            document.addEventListener('mousemove', this.handleResizing);
            document.addEventListener('mouseup', this.handleResizeEnd);
        };
        this.handleResizing = ({ clientX, clientY }) => {
            const { onComplete, onCropChange, minRectSize } = this.props;
            const { imageStyle: { width, height }, rotate } = this.state;
            const flag = rotateFlag(rotate);
            const newX = clientX - relativeX; // mouse x diffrence from before 
            const newY = clientY - relativeY; // mouse y diffrence from before
            let x = resizeX;
            let y = resizeY;
            let size;
            if (resizeMode === 'lt') {
                const relative = Math.min(newX - resizeX, newY - resizeY);
                x += relative;
                y += relative;
                size = (resizeSize - x) + resizeX;
            }
            else if (resizeMode === 'rt') {
                const relative = Math.min(resizeX - newX, newY - resizeY);
                y += relative;
                size = (resizeSize - y) + resizeY;
            }
            else if (resizeMode === 'lb') {
                const relative = Math.min(newX - resizeX, resizeY - newY);
                x += relative;
                size = (resizeSize - x) + resizeX;
            }
            else {
                const relative = Math.min(resizeX - newX, resizeY - newY);
                size = resizeSize - relative;
            }
            const minX = flag ? (width - height) / 2 : 0;
            const minY = flag ? (height - width) / 2 : 0;
            const maxWidth = flag ? ((width - height) / 2) + height : width;
            const maxHeight = flag ? ((height - width) / 2) + width : height;
            x = Math.min(Math.max(minX, x), (resizeSize - minRectSize) + resizeX);
            y = Math.min(Math.max(minY, y), (resizeSize - minRectSize) + resizeY);
            const cropSize = {
                x,
                y,
                size: Math.max(Math.min(size, maxWidth - x, maxHeight - y), minRectSize),
            };
            if (onComplete) {
                onComplete(cropSize);
            }
            if (onCropChange) {
                onCropChange(cropSize);
            }
            this.setState(cropSize);
        };
        this.handleResizeEnd = () => {
            document.removeEventListener('mousemove', this.handleResizing);
            document.removeEventListener('mouseup', this.handleResizeEnd);
        };
        /** *
         * 永远计算理论上来说必须用sin这种方法来计算了
         * 最大高度和最小高度
         */
        /**
    *
    * Returns an x,y point once rotated around xMid,yMid
    */
        this.rotateAroundMidPoint = (x, y, xMid, yMid, degrees) => {
            const cos = Math.cos;
            const sin = Math.sin;
            const radian = (degrees * Math.PI) / 180; // Convert to radians
            // Subtract midpoints, so that midpoint is translated to origin
            // and add it in the end again
            const xr = (x - xMid) * cos(radian) - (y - yMid) * sin(radian) + xMid;
            const yr = (x - xMid) * sin(radian) + (y - yMid) * cos(radian) + yMid;
            return [xr, yr];
        };
        /**
         * Returns the new bounding area of a rotated rectangle.
         */
        this.translateSize = (width, height, rotation) => {
            const centerX = width / 2;
            const centerY = height / 2;
            const outerBounds = [
                this.rotateAroundMidPoint(0, 0, centerX, centerY, rotation),
                this.rotateAroundMidPoint(width, 0, centerX, centerY, rotation),
                this.rotateAroundMidPoint(width, height, centerX, centerY, rotation),
                this.rotateAroundMidPoint(0, height, centerX, centerY, rotation),
            ];
            const minX = Math.min(...outerBounds.map(p => p[0]));
            const maxX = Math.max(...outerBounds.map(p => p[0]));
            const minY = Math.min(...outerBounds.map(p => p[1]));
            const maxY = Math.max(...outerBounds.map(p => p[1]));
            return { width: maxX - minX, height: maxY - minY };
        };
        if (props.src) {
            this.loadImage(props.src);
        }
        const rotate = typeof props.rotation !== 'undefined' ? props.rotation : 0;
        const defaultRectSize = typeof props.defaultRectSize !== 'undefined' ? props.defaultRectSize : 200;
        this.state = {
            img: null,
            size: defaultRectSize,
            x: 0,
            y: 0,
            rotate,
            imageStyle: {},
        };
        if ('onMaskClick' in props) {
            console.warn('`onMaskClick` are removed, please use `onClose` instead.');
        }
    }
    componentDidUpdate(prevProps, prevState) {
        const { rotation, onRotationChange, src } = this.props;
        const { img } = prevState;
        if (img && rotation && prevProps.rotation !== rotation) {
            // 旋转触发方法
            if (onRotationChange) {
                onRotationChange(rotation);
            }
            this.initImageSize(img, rotation);
        }
        // 修改 src 触发方法
        if (src && prevProps.src !== src) {
            this.loadImage(src);
        }
    }
    initImageSize(img, rotate = 0) {
        const { editorWidth, editorHeight, defaultRectSize, minRectSize } = this.props;
        const { naturalWidth, naturalHeight } = img;
        // to judge the 
        const flag = rotateFlag(rotate);
        let width = flag ? naturalHeight : naturalWidth;
        let height = flag ? naturalWidth : naturalHeight;
        if (width < minRectSize || height < minRectSize) {
            if (width > height) {
                width = (width / height) * minRectSize;
                height = minRectSize;
            }
            else {
                height = (height / width) * minRectSize;
                width = minRectSize;
            }
        }
        else if (width > editorWidth || height > editorHeight) {
            if (width / editorWidth > height / editorHeight) {
                height = (height / width) * editorWidth;
                width = editorWidth;
            }
            else {
                width = (width / height) * editorHeight;
                height = editorHeight;
            }
        }
        if (flag) {
            const tmp = width;
            width = height;
            height = tmp;
        }
        const size = Math.min(defaultRectSize, width, height);
        const CropperInfo = {
            img,
            imageStyle: {
                width,
                height,
                top: (editorHeight - height) / 2,
                left: (editorWidth - width) / 2,
                transform: `rotate(${rotate}deg)`,
            },
            size,
            x: (width - size) / 2,
            y: (height - size) / 2,
            rotate,
        };
        this.setState(CropperInfo);
    }
    loadImage(src) {
        if (typeof window !== 'undefined') {
            const { crossOrigin, rotation } = this.props;
            const img = new Image();
            img.src = src;
            if (crossOrigin === 'anonymous' || crossOrigin === 'use-credentials') {
                img.crossOrigin = 'anonymous';
            }
            img.onload = () => {
                const imgRotate = rotation || 0;
                this.initImageSize(img, imgRotate);
            };
        }
    }
    render() {
        const { img, imageStyle, size, x, y } = this.state;
        const { editorHeight, editorWidth, prefixCls: customizePrefixCls } = this.props;
        const prefixCls = getPrefixCls('avatar-crop', customizePrefixCls);
        if (img) {
            const { src } = img;
            const { left, top } = imageStyle;
            const style = {
                width: editorWidth,
                height: editorHeight,
            };
            // 通过border位置来控制裁剪高宽
            const maskStyle = {
                borderTopWidth: y + top,
                borderRightWidth: editorWidth - x - left - size,
                borderBottomWidth: editorHeight - y - top - size,
                borderLeftWidth: x + left,
            };
            return (React.createElement("div", { className: `${prefixCls}-edit`, style: style },
                React.createElement("img", { alt: "", src: src, style: imageStyle }),
                React.createElement("div", { className: `${prefixCls}-edit-mask`, style: maskStyle },
                    React.createElement("div", { onMouseDown: this.handleMoveStart },
                        React.createElement("i", { className: "lt", onMouseDown: this.handleResizeStart }),
                        React.createElement("i", { className: "rt", onMouseDown: this.handleResizeStart }),
                        React.createElement("i", { className: "lb", onMouseDown: this.handleResizeStart }),
                        React.createElement("i", { className: "rb", onMouseDown: this.handleResizeStart })))));
        }
        return null;
    }
}
Crop.propTypes = {
    crossOrigin: PropTypes.string,
    src: PropTypes.string,
    rotation: PropTypes.number,
    onRotationChange: PropTypes.func,
    onComplete: PropTypes.func,
    onCropChange: PropTypes.func,
    prefixCls: PropTypes.string,
    editorWidth: PropTypes.number,
    editorHeight: PropTypes.number,
    minRectSize: PropTypes.number,
    defaultRectSize: PropTypes.number,
};
Crop.defaultProps = {
    editorWidth: 540,
    editorHeight: 300,
    minRectSize: 80,
    defaultRectSize: 200,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvaW1hZ2UtY3JvcC9Dcm9wLnRzeCIsIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUNILE9BQU8sS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQ3pDLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQztBQUNuQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTVDLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztBQUNsQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7QUFDbEIsSUFBSSxVQUFVLENBQUM7QUFDZixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDaEIsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0FBQ2hCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztBQUVuQjs7O0dBR0c7QUFDSCxTQUFTLFVBQVUsQ0FBQyxNQUFNO0lBQ3RCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNuQyxDQUFDO0FBaUNELE1BQU0sQ0FBQyxPQUFPLE9BQU8sSUFBSyxTQUFRLFNBQXlCO0lBd0J2RCxZQUFZLEtBQWdCO1FBQ3hCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQW9DakIsb0JBQWUsR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7WUFDdkMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQzVCLFNBQVMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLFNBQVMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzFELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFB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RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDcEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3BELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNwRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFFcEQsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEdBQUcsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEdBQUcsSUFBSSxFQUFFLENBQUE7UUFDdEQsQ0FBQyxDQUFBO1FBdExHLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNYLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1NBQzVCO1FBQ0QsTUFBTSxNQUFNLEdBQUcsT0FBTyxLQUFLLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFFLE1BQU0sZUFBZSxHQUFHLE9BQU8sS0FBSyxDQUFDLGVBQWUsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUNuRyxJQUFJLENBQUMsS0FBSyxHQUFH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V0FBVyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsR0FBSTt3QkFDekQsMkJBQUcsU0FBUyxFQUFDLElBQUksRUFBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixHQUFJO3dCQUN6RCwyQkFBRyxTQUFTLEVBQUMsSUFBSSxFQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEdBQUksQ0FDdkQsQ0FDSixDQUNKLENBQUMsQ0FBQTtTQUNWO1FBQ0QsT0FBTyxJQUFJLENBQUE7SUFDZixDQUFDOztBQWhUTSxjQUFTLEdBQUc7SUFDZixXQUFXLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDN0IsR0FBRyxFQUFFLFNBQVMsQ0FBQyxNQUFNO0lBQ3JCLFFBQVEsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMxQixnQkFBZ0IsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUNoQyxVQUFVLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDMUIsWUFBWSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQzVCLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMzQixXQUFXLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDN0IsWUFBWSxFQUFFLFNBQVMsQ0FBQyxNQUFNO0lBQzlCLFdBQVcsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUM3QixlQUFlLEVBQUUsU0FBUyxDQUFDLE1BQU07Q0FDcEMsQ0FBQztBQUVLLGlCQUFZLEdBQUc7SUFDbEIsV0FBVyxFQUFFLEdBQUc7SUFDaEIsWUFBWSxFQUFFLEdBQUc7SUFDakIsV0FBVyxFQUFFLEVBQUU7SUFDZixlQUFlLEVBQUUsR0FBRztDQUN2QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL2ltYWdlLWNyb3AvQ3JvcC50c3giXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiDoo4Hliarnu4Tku7ZcbiAqL1xuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBnZXRQcmVmaXhDbHMgfSBmcm9tICcuLi9jb25maWd1cmUnO1xuXG5sZXQgcmVsYXRpdmVYID0gMDtcbmxldCByZWxhdGl2ZVkgPSAwO1xubGV0IHJlc2l6ZU1vZGU7XG5sZXQgcmVzaXplWCA9IDA7XG5sZXQgcmVzaXplWSA9IDA7XG5sZXQgcmVzaXplU2l6ZSA9IDA7XG5cbi8qKlxuICogd2hlbiBjYW4ndCBiZSBleGFjdCBkaXZpc2lvbiBpdCB3aWxsIHJldHVybiBmYWxzZVxuICogQHBhcmFtIHJvdGF0ZSBcbiAqL1xuZnVuY3Rpb24gcm90YXRlRmxhZyhyb3RhdGUpIHtcbiAgICByZXR1cm4gKHJvdGF0ZSAvIDkwKSAlIDIgIT09IDA7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JvcFZhbHVlIHtcbiAgICBoZWlnaHQ6IG51bWJlcjtcbiAgICB3aWR0aDogbnVtYmVyO1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG59XG5cbmV4cG9ydCB0eXBlIFNpemUgPSB7XG4gICAgd2lkdGg6IG51bWJlclxuICAgIGhlaWdodDogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW1hZ2VDcm9wIGV4dGVuZHMgSFRNTEltYWdlRWxlbWVudCB7XG4gICAgc3JjOiBzdHJpbmc7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBDcm9wUHJvcHMge1xuICAgIGNyb3NzT3JpZ2luPzogXCJhbm9ueW1vdXNcIiB8IFwidXNlLWNyZWRlbnRpYWxzXCI7IC8vICAg5aaC5p6c5L2/55So6L+Z5Liq5YC855qE6K+d5bCx5Lya5Zyo6K+35rGC5Lit55qEaGVhZGVy5Lit55qE5bim5LiKT3JpZ2lu5bGe5oCn77yM5L2G6K+35rGC5LiN5Lya5bim5LiKY29va2ll5ZKM5YW25LuW55qE5LiA5Lqb6K6k6K+B5L+h5oGvIHwg6L+Z5Liq5bCx5ZCM5pe25Lya5Zyo6Leo5Z+f6K+35rGC5Lit5bim5LiKY29va2ll5ZKM5YW25LuW55qE5LiA5Lqb6K6k6K+B5L+h5oGvXG4gICAgc3JjPzogc3RyaW5nOyAvLyDlm77niYdcbiAgICBlZGl0b3JXaWR0aDogbnVtYmVyOyAvLyDnvJbovpHljLrln5/nmoTlrr3luqZcbiAgICBlZGl0b3JIZWlnaHQ6IG51bWJlcjsgLy8g57yW6L6R5Yy65Z+f55qE6auY5bqmXG4gICAgbWluUmVjdFNpemU6IG51bWJlcjsgLy8g5pyA5bCP55qE6KOB5Ymq5Yy65Z+fXG4gICAgZGVmYXVsdFJlY3RTaXplOiBudW1iZXI7IC8vIOm7mOiupOacgOWwj+eahFxuICAgIHJvdGF0aW9uPzogbnVtYmVyOyAvLyDluqbmlbBcbiAgICBvblJvdGF0aW9uQ2hhbmdlPzogKHJhdGU6IG51bWJlcikgPT4gdm9pZDsgLy8g6KOB5Ymq5bqm5pWw55qE5Y+Y5YyW6Kem5Y+RXG4gICAgb25Db21wbGV0ZT86ICh2YWx1ZTogYW55KSA9PiB2b2lkOyAvLyDoo4HliarlrozmiJDop6blj5FcbiAgICBvbkNyb3BDaGFuZ2U/OiAoY3JvcDogYW55KSA9PiB2b2lkOyAvLyDoo4HliarljLrln5/lj5jljJbml7blgJnop6blj5FcbiAgICBwcmVmaXhDbHM/OiBzdHJpbmcsIC8vIOiHquWumuS5ieagt+W8j+WJjee8gFxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDcm9wIGV4dGVuZHMgQ29tcG9uZW50PENyb3BQcm9wcywgYW55PiB7XG4gICAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAgICAgY3Jvc3NPcmlnaW46IFByb3BUeXBlcy5zdHJpbmcsIC8vIOaYr+WQpui3qOWfn1xuICAgICAgICBzcmM6IFByb3BUeXBlcy5zdHJpbmcsLy8g5Zu+54mHXG4gICAgICAgIHJvdGF0aW9uOiBQcm9wVHlwZXMubnVtYmVyLC8vIOaXi+i9rOW6puaVsFxuICAgICAgICBvblJvdGF0aW9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYywgLy8g6KOB5Ymq5bqm5pWw55qE5Y+Y5YyW6Kem5Y+RXG4gICAgICAgIG9uQ29tcGxldGU6IFByb3BUeXBlcy5mdW5jLC8vIOijgeWJquWujOaIkOinpuWPkVxuICAgICAgICBvbkNyb3BDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLCAvLyDoo4HliarljLrln5/lj5jljJbml7blgJnop6blj5FcbiAgICAgICAgcHJlZml4Q2xzOiBQcm9wVHlwZXMuc3RyaW5nLCAvLyDoh6rlrprkuYnmoLflvI/liY3nvIBcbiAgICAgICAgZWRpdG9yV2lkdGg6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgICAgIGVkaXRvckhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcbiAgICAgICAgbWluUmVjdFNpemU6IFByb3BUeXBlcy5udW1iZXIsIC8vIOacgOWwj+eahOijgeWJquWMuuWfn1xuICAgICAgICBkZWZhdWx0UmVjdFNpemU6IFByb3BUeXBlcy5udW1iZXIsIC8vIOm7mOiupOacgOWwj+eahFxuICAgIH07XG5cbiAgICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgICAgICBlZGl0b3JXaWR0aDogNTQwLFxuICAgICAgICBlZGl0b3JIZWlnaHQ6IDMwMCxcbiAgICAgICAgbWluUmVjdFNpemU6IDgwLFxuICAgICAgICBkZWZhdWx0UmVjdFNpemU6IDIwMCxcbiAgICB9O1xuXG5cblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBDcm9wUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBpZiAocHJvcHMuc3JjKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRJbWFnZShwcm9wcy5zcmMpXG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgcm90YXRlID0gdHlwZW9mIHByb3BzLnJvdGF0aW9uICE9PSAndW5kZWZpbmVkJyA/IHByb3BzLnJvdGF0aW9uIDogMDtcbiAgICAgICAgY29uc3QgZGVmYXVsdFJlY3RTaXplID0gdHlwZW9mIHByb3BzLmRlZmF1bHRSZWN0U2l6ZSAhPT0gJ3VuZGVmaW5lZCcgPyBwcm9wcy5kZWZhdWx0UmVjdFNpemUgOiAyMDA7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBpbWc6IG51bGwsXG4gICAgICAgICAgICBzaXplOiBkZWZhdWx0UmVjdFNpemUsXG4gICAgICAgICAgICB4OiAwLFxuICAgICAgICAgICAgeTogMCxcbiAgICAgICAgICAgIHJvdGF0ZSxcbiAgICAgICAgICAgIGltYWdlU3R5bGU6IHt9LFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICgnb25NYXNrQ2xpY2snIGluIHByb3BzKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ2Bvbk1hc2tDbGlja2AgYXJlIHJlbW92ZWQsIHBsZWFzZSB1c2UgYG9uQ2xvc2VgIGluc3RlYWQuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUpIHtcbiAgICAgICAgY29uc3QgeyByb3RhdGlvbiwgb25Sb3RhdGlvbkNoYW5nZSwgc3JjIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGltZyB9ID0gcHJldlN0YXRlO1xuICAgICAgICBpZiAoaW1nICYmIHJvdGF0aW9uICYmIHByZXZQcm9wcy5yb3RhdGlvbiAhPT0gcm90YXRpb24pIHtcbiAgICAgICAgICAgIC8vIOaXi+i9rOinpuWPkeaWueazlVxuICAgICAgICAgICAgaWYgKG9uUm90YXRpb25DaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICBvblJvdGF0aW9uQ2hhbmdlKHJvdGF0aW9uKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5pbml0SW1hZ2VTaXplKGltZywgcm90YXRpb24pO1xuICAgICAgICB9XG4gICAgICAgIC8vIOS/ruaUuSBzcmMg6Kem5Y+R5pa55rOVXG4gICAgICAgIGlmIChzcmMgJiYgcHJldlByb3BzLnNyYyAhPT0gc3JjKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRJbWFnZShzcmMpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBoYW5kbGVNb3ZlU3RhcnQgPSAoeyBjbGllbnRYLCBjbGllbnRZIH0pID0+IHtcbiAgICAgICAgY29uc3QgeyB4LCB5IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICByZWxhdGl2ZVggPSBjbGllbnRYIC0geDtcbiAgICAgICAgcmVsYXRpdmVZID0gY2xpZW50WSAtIHk7XG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuaGFuZGxlTW92aW5nKTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuaGFuZGxlTW92ZUVuZCk7XG4gICAgfTtcblxuICAgIGhhbmRsZU1vdmluZyA9ICh7IGNsaWVudFgsIGNsaWVudFkgfSkgPT4ge1xuICAgICAgICBjb25zdCB7IHNpemUsIGltYWdlU3R5bGU6IHsgd2lkdGgsIGhlaWdodCB9LCByb3RhdGUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IHsgb25Db21wbGV0ZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgZmxhZyA9IHJvdGF0ZUZsYWcocm90YXRlKTtcbiAgICAgICAgY29uc3QgbWluWCA9IGZsYWcgPyAod2lkdGggLSBoZWlnaHQpIC8gMiA6IDA7IC8vIGlmIGNhbid0IGJlIGV4YWN0IGRpdmlzaW9uIG1pbiBpcyAwXG4gICAgICAgIGNvbnN0IG1pblkgPSBmbGFnID8gKGhlaWdodCAtIHdpZHRoKSAvIDIgOiAwOyAvLyBpZiBjYW4ndCBiZSBleGFjdCBkaXZpc2lvbiBtaW4gaXMgMFxuICAgICAgICBjb25zdCBtYXhYID0gd2lkdGggLSBzaXplIC0gbWluWDsgLy8gdGhlIG1heCB3aWR0aCBpcyBpbWFnZSBtaW51cyB0aGUgc2l6ZSAsIHRoZXJlIHdvdWxkIG1pbnVzIHRoZSBzaXplV2lkdGhcbiAgICAgICAgY29uc3QgbWF4WSA9IGhlaWdodCAtIHNpemUgLSBtaW5ZOyAvLyB0aGUgbWF4IGhlaWdodCBpcyBpbWFnZSBtaW51cyB0aGUgc2l6ZSAsIHRoZXJlIHdvdWxkIG1pbnVzIHRoZSBzaXplSGVpZ2h0IFxuICAgICAgICBjb25zdCBtb3ZpbmdYWSA9IHtcbiAgICAgICAgICAgIHg6IE1hdGgubWluKE1hdGgubWF4KG1pblgsIGNsaWVudFggLSByZWxhdGl2ZVgpLCBtYXhYKSxcbiAgICAgICAgICAgIHk6IE1hdGgubWluKE1hdGgubWF4KG1pblksIGNsaWVudFkgLSByZWxhdGl2ZVkpLCBtYXhZKSxcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvbkNvbXBsZXRlKSB7XG4gICAgICAgICAgICBjb25zdCBjb21wbGV0ZVhZID0geyAuLi5tb3ZpbmdYWSwgc2l6ZSB9XG4gICAgICAgICAgICBvbkNvbXBsZXRlKGNvbXBsZXRlWFkpXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZShtb3ZpbmdYWSk7XG5cbiAgICB9O1xuXG4gICAgaGFuZGxlTW92ZUVuZCA9ICgpID0+IHtcbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5oYW5kbGVNb3ZpbmcpO1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5oYW5kbGVNb3ZlRW5kKTtcbiAgICB9O1xuXG4gICAgaGFuZGxlUmVzaXplU3RhcnQgPSAoZSkgPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCB7IGN1cnJlbnRUYXJnZXQsIGNsaWVudFgsIGNsaWVudFkgfSA9IGU7IC8vIG1vdXNlIG9mIGJvZHkgdGhlIHggeSBwb3NpdGlvblxuICAgICAgICBjb25zdCB7IHgsIHksIHNpemUgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIHJlbGF0aXZlWCA9IGNsaWVudFggLSB4OyAvLyByZWxhdGl2ZVggXG4gICAgICAgIHJlbGF0aXZlWSA9IGNsaWVudFkgLSB5OyAvLyByZWxhdGl2ZVlcbiAgICAgICAgcmVzaXplTW9kZSA9IGN1cnJlbnRUYXJnZXQuY2xhc3NOYW1lOyAgIC8vIHRvIGNvbmZpcm0gdGhlIHdpdGNoIGJvcmRlciBvbiBoYW5kbGUgXG4gICAgICAgIHJlc2l6ZVggPSB4OyAgICAgICAgLy8geCBvZiBpbWFnZSBwb3NpdGlvblxuICAgICAgICByZXNpemVZID0geTsgICAgICAgIC8vIHkgb2YgaW1hZ2UgcG9zaXRpb25cbiAgICAgICAgcmVzaXplU2l6ZSA9IHNpemU7ICAgLy8gc2l6ZSBvZiBjcm9wIGFyZWEgLCBUT0RPIGNoYW5nZSB0byByZXNpemVIZWlnaHQgcmVzaXplV2lkdGggXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuaGFuZGxlUmVzaXppbmcpO1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5oYW5kbGVSZXNpemVFbmQpO1xuICAgIH07XG5cbiAgICBoYW5kbGVSZXNpemluZyA9ICh7IGNsaWVudFgsIGNsaWVudFkgfSkgPT4ge1xuICAgICAgICBjb25zdCB7IG9uQ29tcGxldGUsIG9uQ3JvcENoYW5nZSwgbWluUmVjdFNpemUgfSA9IHRoaXMucHJvcHNcbiAgICAgICAgY29uc3QgeyBpbWFnZVN0eWxlOiB7IHdpZHRoLCBoZWlnaHQgfSwgcm90YXRlIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCBmbGFnID0gcm90YXRlRmxhZyhyb3RhdGUpO1xuICAgICAgICBjb25zdCBuZXdYID0gY2xpZW50WCAtIHJlbGF0aXZlWDsgLy8gbW91c2UgeCBkaWZmcmVuY2UgZnJvbSBiZWZvcmUgXG4gICAgICAgIGNvbnN0IG5ld1kgPSBjbGllbnRZIC0gcmVsYXRpdmVZOyAvLyBtb3VzZSB5IGRpZmZyZW5jZSBmcm9tIGJlZm9yZVxuICAgICAgICBsZXQgeCA9IHJlc2l6ZVg7XG4gICAgICAgIGxldCB5ID0gcmVzaXplWTtcbiAgICAgICAgbGV0IHNpemU7XG4gICAgICAgIGlmIChyZXNpemVNb2RlID09PSAnbHQnKSB7XG4gICAgICAgICAgICBjb25zdCByZWxhdGl2ZSA9IE1hdGgubWluKG5ld1ggLSByZXNpemVYLCBuZXdZIC0gcmVzaXplWSk7XG4gICAgICAgICAgICB4ICs9IHJlbGF0aXZlO1xuICAgICAgICAgICAgeSArPSByZWxhdGl2ZTtcbiAgICAgICAgICAgIHNpemUgPSAocmVzaXplU2l6ZSAtIHgpICsgcmVzaXplWDtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNpemVNb2RlID09PSAncnQnKSB7XG4gICAgICAgICAgICBjb25zdCByZWxhdGl2ZSA9IE1hdGgubWluKHJlc2l6ZVggLSBuZXdYLCBuZXdZIC0gcmVzaXplWSk7XG4gICAgICAgICAgICB5ICs9IHJlbGF0aXZlO1xuICAgICAgICAgICAgc2l6ZSA9IChyZXNpemVTaXplIC0geSkgKyByZXNpemVZO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc2l6ZU1vZGUgPT09ICdsYicpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlID0gTWF0aC5taW4obmV3WCAtIHJlc2l6ZVgsIHJlc2l6ZVkgLSBuZXdZKTtcbiAgICAgICAgICAgIHggKz0gcmVsYXRpdmU7XG4gICAgICAgICAgICBzaXplID0gKHJlc2l6ZVNpemUgLSB4KSArIHJlc2l6ZVg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCByZWxhdGl2ZSA9IE1hdGgubWluKHJlc2l6ZVggLSBuZXdYLCByZXNpemVZIC0gbmV3WSk7XG4gICAgICAgICAgICBzaXplID0gcmVzaXplU2l6ZSAtIHJlbGF0aXZlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1pblggPSBmbGFnID8gKHdpZHRoIC0gaGVpZ2h0KSAvIDIgOiAwO1xuICAgICAgICBjb25zdCBtaW5ZID0gZmxhZyA/IChoZWlnaHQgLSB3aWR0aCkgLyAyIDogMDtcbiAgICAgICAgY29uc3QgbWF4V2lkdGggPSBmbGFnID8gKCh3aWR0aCAtIGhlaWdodCkgLyAyKSArIGhlaWdodCA6IHdpZHRoO1xuICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBmbGFnID8gKChoZWlnaHQgLSB3aWR0aCkgLyAyKSArIHdpZHRoIDogaGVpZ2h0O1xuICAgICAgICB4ID0gTWF0aC5taW4oTWF0aC5tYXgobWluWCwgeCksIChyZXNpemVTaXplIC0gbWluUmVjdFNpemUpICsgcmVzaXplWCk7XG4gICAgICAgIHkgPSBNYXRoLm1pbihNYXRoLm1heChtaW5ZLCB5KSwgKHJlc2l6ZVNpemUgLSBtaW5SZWN0U2l6ZSkgKyByZXNpemVZKTtcblxuICAgICAgICBjb25zdCBjcm9wU2l6ZSA9IHtcbiAgICAgICAgICAgIHgsXG4gICAgICAgICAgICB5LFxuICAgICAgICAgICAgc2l6ZTogTWF0aC5tYXgoTWF0aC5taW4oc2l6ZSwgbWF4V2lkdGggLSB4LCBtYXhIZWlnaHQgLSB5KSwgbWluUmVjdFNpemUpLFxuICAgICAgICB9XG4gICAgICAgIGlmIChvbkNvbXBsZXRlKSB7XG4gICAgICAgICAgICBvbkNvbXBsZXRlKGNyb3BTaXplKVxuICAgICAgICB9XG4gICAgICAgIGlmIChvbkNyb3BDaGFuZ2UpIHtcbiAgICAgICAgICAgIG9uQ3JvcENoYW5nZShjcm9wU2l6ZSlcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKGNyb3BTaXplKTtcbiAgICB9O1xuXG4gICAgaGFuZGxlUmVzaXplRW5kID0gKCkgPT4ge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmhhbmRsZVJlc2l6aW5nKTtcbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuaGFuZGxlUmVzaXplRW5kKTtcbiAgICB9O1xuXG4gICAgLyoqICpcbiAgICAgKiDmsLjov5zorqHnrpfnkIborrrkuIrmnaXor7Tlv4XpobvnlKhzaW7ov5nnp43mlrnms5XmnaXorqHnrpfkuoZcbiAgICAgKiDmnIDlpKfpq5jluqblkozmnIDlsI/pq5jluqZcbiAgICAgKi9cblxuICAgIC8qKlxuKlxuKiBSZXR1cm5zIGFuIHgseSBwb2ludCBvbmNlIHJvdGF0ZWQgYXJvdW5kIHhNaWQseU1pZFxuKi9cbiAgICByb3RhdGVBcm91bmRNaWRQb2ludCA9IChcbiAgICAgICAgeDogbnVtYmVyLFxuICAgICAgICB5OiBudW1iZXIsXG4gICAgICAgIHhNaWQ6IG51bWJlcixcbiAgICAgICAgeU1pZDogbnVtYmVyLFxuICAgICAgICBkZWdyZWVzOiBudW1iZXIsXG4gICAgKTogW251bWJlciwgbnVtYmVyXSA9PiB7XG4gICAgICAgIGNvbnN0IGNvcyA9IE1hdGguY29zXG4gICAgICAgIGNvbnN0IHNpbiA9IE1hdGguc2luXG4gICAgICAgIGNvbnN0IHJhZGlhbiA9IChkZWdyZWVzICogTWF0aC5QSSkgLyAxODAgLy8gQ29udmVydCB0byByYWRpYW5zXG4gICAgICAgIC8vIFN1YnRyYWN0IG1pZHBvaW50cywgc28gdGhhdCBtaWRwb2ludCBpcyB0cmFuc2xhdGVkIHRvIG9yaWdpblxuICAgICAgICAvLyBhbmQgYWRkIGl0IGluIHRoZSBlbmQgYWdhaW5cbiAgICAgICAgY29uc3QgeHIgPSAoeCAtIHhNaWQpICogY29zKHJhZGlhbikgLSAoeSAtIHlNaWQpICogc2luKHJhZGlhbikgKyB4TWlkXG4gICAgICAgIGNvbnN0IHlyID0gKHggLSB4TWlkKSAqIHNpbihyYWRpYW4pICsgKHkgLSB5TWlkKSAqIGNvcyhyYWRpYW4pICsgeU1pZFxuXG4gICAgICAgIHJldHVybiBbeHIsIHlyXVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIG5ldyBib3VuZGluZyBhcmVhIG9mIGEgcm90YXRlZCByZWN0YW5nbGUuXG4gICAgICovXG4gICAgdHJhbnNsYXRlU2l6ZSA9ICh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgcm90YXRpb246IG51bWJlcik6IFNpemUgPT4ge1xuICAgICAgICBjb25zdCBjZW50ZXJYID0gd2lkdGggLyAyXG4gICAgICAgIGNvbnN0IGNlbnRlclkgPSBoZWlnaHQgLyAyXG5cbiAgICAgICAgY29uc3Qgb3V0ZXJCb3VuZHMgPSBbXG4gICAgICAgICAgICB0aGlzLnJvdGF0ZUFyb3VuZE1pZFBvaW50KDAsIDAsIGNlbnRlclgsIGNlbnRlclksIHJvdGF0aW9uKSxcbiAgICAgICAgICAgIHRoaXMucm90YXRlQXJvdW5kTWlkUG9pbnQod2lkdGgsIDAsIGNlbnRlclgsIGNlbnRlclksIHJvdGF0aW9uKSxcbiAgICAgICAgICAgIHRoaXMucm90YXRlQXJvdW5kTWlkUG9pbnQod2lkdGgsIGhlaWdodCwgY2VudGVyWCwgY2VudGVyWSwgcm90YXRpb24pLFxuICAgICAgICAgICAgdGhpcy5yb3RhdGVBcm91bmRNaWRQb2ludCgwLCBoZWlnaHQsIGNlbnRlclgsIGNlbnRlclksIHJvdGF0aW9uKSxcbiAgICAgICAgXVxuXG4gICAgICAgIGNvbnN0IG1pblggPSBNYXRoLm1pbiguLi5vdXRlckJvdW5kcy5tYXAocCA9PiBwWzBdKSlcbiAgICAgICAgY29uc3QgbWF4WCA9IE1hdGgubWF4KC4uLm91dGVyQm91bmRzLm1hcChwID0+IHBbMF0pKVxuICAgICAgICBjb25zdCBtaW5ZID0gTWF0aC5taW4oLi4ub3V0ZXJCb3VuZHMubWFwKHAgPT4gcFsxXSkpXG4gICAgICAgIGNvbnN0IG1heFkgPSBNYXRoLm1heCguLi5vdXRlckJvdW5kcy5tYXAocCA9PiBwWzFdKSlcblxuICAgICAgICByZXR1cm4geyB3aWR0aDogbWF4WCAtIG1pblgsIGhlaWdodDogbWF4WSAtIG1pblkgfVxuICAgIH1cblxuXG4gICAgaW5pdEltYWdlU2l6ZShpbWcsIHJvdGF0ZSA9IDApIHtcbiAgICAgICAgY29uc3QgeyBlZGl0b3JXaWR0aCwgZWRpdG9ySGVpZ2h0LCBkZWZhdWx0UmVjdFNpemUsIG1pblJlY3RTaXplIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IG5hdHVyYWxXaWR0aCwgbmF0dXJhbEhlaWdodCB9ID0gaW1nO1xuICAgICAgICAvLyB0byBqdWRnZSB0aGUgXG4gICAgICAgIGNvbnN0IGZsYWcgPSByb3RhdGVGbGFnKHJvdGF0ZSk7XG4gICAgICAgIGxldCB3aWR0aCA9IGZsYWcgPyBuYXR1cmFsSGVpZ2h0IDogbmF0dXJhbFdpZHRoO1xuICAgICAgICBsZXQgaGVpZ2h0ID0gZmxhZyA/IG5hdHVyYWxXaWR0aCA6IG5hdHVyYWxIZWlnaHQ7XG4gICAgICAgIGlmICh3aWR0aCA8IG1pblJlY3RTaXplIHx8IGhlaWdodCA8IG1pblJlY3RTaXplKSB7XG4gICAgICAgICAgICBpZiAod2lkdGggPiBoZWlnaHQpIHtcbiAgICAgICAgICAgICAgICB3aWR0aCA9ICh3aWR0aCAvIGhlaWdodCkgKiBtaW5SZWN0U2l6ZTtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBtaW5SZWN0U2l6ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gKGhlaWdodCAvIHdpZHRoKSAqIG1pblJlY3RTaXplO1xuICAgICAgICAgICAgICAgIHdpZHRoID0gbWluUmVjdFNpemU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAod2lkdGggPiBlZGl0b3JXaWR0aCB8fCBoZWlnaHQgPiBlZGl0b3JIZWlnaHQpIHtcbiAgICAgICAgICAgIGlmICh3aWR0aCAvIGVkaXRvcldpZHRoID4gaGVpZ2h0IC8gZWRpdG9ySGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gKGhlaWdodCAvIHdpZHRoKSAqIGVkaXRvcldpZHRoO1xuICAgICAgICAgICAgICAgIHdpZHRoID0gZWRpdG9yV2lkdGg7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHdpZHRoID0gKHdpZHRoIC8gaGVpZ2h0KSAqIGVkaXRvckhlaWdodDtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBlZGl0b3JIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZsYWcpIHtcbiAgICAgICAgICAgIGNvbnN0IHRtcCA9IHdpZHRoO1xuICAgICAgICAgICAgd2lkdGggPSBoZWlnaHQ7XG4gICAgICAgICAgICBoZWlnaHQgPSB0bXA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2l6ZSA9IE1hdGgubWluKGRlZmF1bHRSZWN0U2l6ZSwgd2lkdGgsIGhlaWdodCk7XG4gICAgICAgIGNvbnN0IENyb3BwZXJJbmZvID0ge1xuICAgICAgICAgICAgaW1nLFxuICAgICAgICAgICAgaW1hZ2VTdHlsZToge1xuICAgICAgICAgICAgICAgIHdpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodCxcbiAgICAgICAgICAgICAgICB0b3A6IChlZGl0b3JIZWlnaHQgLSBoZWlnaHQpIC8gMixcbiAgICAgICAgICAgICAgICBsZWZ0OiAoZWRpdG9yV2lkdGggLSB3aWR0aCkgLyAyLFxuICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogYHJvdGF0ZSgke3JvdGF0ZX1kZWcpYCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzaXplLFxuICAgICAgICAgICAgeDogKHdpZHRoIC0gc2l6ZSkgLyAyLFxuICAgICAgICAgICAgeTogKGhlaWdodCAtIHNpemUpIC8gMixcbiAgICAgICAgICAgIHJvdGF0ZSxcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoQ3JvcHBlckluZm8pO1xuICAgIH1cblxuICAgIGxvYWRJbWFnZShzcmMpIHtcbiAgICAgICAgaWYodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpe1xuICAgICAgICAgICAgY29uc3QgeyBjcm9zc09yaWdpbiwgcm90YXRpb24gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgICAgICBjb25zdCBpbWc6IEltYWdlQ3JvcCA9IG5ldyBJbWFnZSgpO1xuICAgICAgICAgICAgaW1nLnNyYyA9IHNyYztcbiAgICAgICAgICAgIGlmIChjcm9zc09yaWdpbiA9PT0gJ2Fub255bW91cycgfHwgY3Jvc3NPcmlnaW4gPT09ICd1c2UtY3JlZGVudGlhbHMnKSB7XG4gICAgICAgICAgICAgICAgaW1nLmNyb3NzT3JpZ2luID0gJ2Fub255bW91cyc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGltZ1JvdGF0ZSA9IHJvdGF0aW9uIHx8IDA7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0SW1hZ2VTaXplKGltZywgaW1nUm90YXRlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgaW1nLCBpbWFnZVN0eWxlLCBzaXplLCB4LCB5IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBjb25zdCB7IGVkaXRvckhlaWdodCwgZWRpdG9yV2lkdGgsIHByZWZpeENsczogY3VzdG9taXplUHJlZml4Q2xzIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBwcmVmaXhDbHMgPSBnZXRQcmVmaXhDbHMoJ2F2YXRhci1jcm9wJywgY3VzdG9taXplUHJlZml4Q2xzKTtcbiAgICAgICAgaWYgKGltZykge1xuICAgICAgICAgICAgY29uc3QgeyBzcmMgfSA9IGltZztcbiAgICAgICAgICAgIGNvbnN0IHsgbGVmdCwgdG9wIH0gPSBpbWFnZVN0eWxlO1xuICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IGVkaXRvcldpZHRoLFxuICAgICAgICAgICAgICAgIGhlaWdodDogZWRpdG9ySGVpZ2h0LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIOmAmui/h2JvcmRlcuS9jee9ruadpeaOp+WItuijgeWJqumrmOWuvVxuICAgICAgICAgICAgY29uc3QgbWFza1N0eWxlID0ge1xuICAgICAgICAgICAgICAgIGJvcmRlclRvcFdpZHRoOiB5ICsgdG9wLFxuICAgICAgICAgICAgICAgIGJvcmRlclJpZ2h0V2lkdGg6IGVkaXRvcldpZHRoIC0geCAtIGxlZnQgLSBzaXplLFxuICAgICAgICAgICAgICAgIGJvcmRlckJvdHRvbVdpZHRoOiBlZGl0b3JIZWlnaHQgLSB5IC0gdG9wIC0gc2l6ZSxcbiAgICAgICAgICAgICAgICBib3JkZXJMZWZ0V2lkdGg6IHggKyBsZWZ0LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiAoPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZWRpdGB9IHN0eWxlPXtzdHlsZX0+XG4gICAgICAgICAgICAgICAgPGltZyBhbHQ9XCJcIiBzcmM9e3NyY30gc3R5bGU9e2ltYWdlU3R5bGV9IC8+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZWRpdC1tYXNrYH0gc3R5bGU9e21hc2tTdHlsZX0+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgb25Nb3VzZURvd249e3RoaXMuaGFuZGxlTW92ZVN0YXJ0fT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzTmFtZT1cImx0XCIgb25Nb3VzZURvd249e3RoaXMuaGFuZGxlUmVzaXplU3RhcnR9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8aSBjbGFzc05hbWU9XCJydFwiIG9uTW91c2VEb3duPXt0aGlzLmhhbmRsZVJlc2l6ZVN0YXJ0fSAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGkgY2xhc3NOYW1lPVwibGJcIiBvbk1vdXNlRG93bj17dGhpcy5oYW5kbGVSZXNpemVTdGFydH0gLz5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzTmFtZT1cInJiXCIgb25Nb3VzZURvd249e3RoaXMuaGFuZGxlUmVzaXplU3RhcnR9IC8+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgfVxufVxuIl0sInZlcnNpb24iOjN9