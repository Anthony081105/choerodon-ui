import { isMoment } from 'moment';
import isNumber from 'lodash/isNumber';
import defaultTo from 'lodash/defaultTo';
export const MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER || 2 ** 53 - 1;
export function getPrecision(value) {
    const valueString = value.toString();
    if (valueString.indexOf('e-') >= 0) {
        return parseInt(valueString.slice(valueString.indexOf('e-') + 2), 10);
    }
    if (valueString.indexOf('.') >= 0) {
        return valueString.length - valueString.indexOf('.') - 1;
    }
    return 0;
}
function getMaxPrecision(value, step) {
    const stepPrecision = getPrecision(step);
    const currentValuePrecision = getPrecision(value);
    if (!value) {
        return stepPrecision;
    }
    return Math.max(currentValuePrecision, stepPrecision);
}
function getPrecisionFactor(value, step) {
    return 10 ** getMaxPrecision(value, step);
}
function precisionFix(value, precisionFactor) {
    return Math.round(value * precisionFactor);
}
export function plus(...values) {
    if (values.length > 2) {
        return plus(values.shift(), plus(...values));
    }
    if (values.length < 2) {
        return values[0];
    }
    const v1 = values[0];
    const v2 = values[1];
    const precisionFactor = getPrecisionFactor(v1, v2);
    return (precisionFix(v1, precisionFactor) + precisionFix(v2, precisionFactor)) / precisionFactor;
}
function getBeforeStepValue(value, minFactor, stepFactor) {
    return value - ((value - minFactor) % stepFactor);
}
function getNearStepMoments(value, step, unit) {
    const unitValue = value.get(unit);
    const mod = unitValue % step;
    if (mod !== 0) {
        const before = unitValue - mod;
        const after = before + step;
        return [value.clone().set(unit, before), value.clone().set(unit, after)];
    }
}
export function getNearStepValues(value, step, min, max) {
    if (isNumber(step)) {
        if (isNumber(value)) {
            min = defaultTo(Number(min), -MAX_SAFE_INTEGER);
            max = defaultTo(Number(max), MAX_SAFE_INTEGER);
            const precisionFactor = getPrecisionFactor(value, step);
            const valueFactor = precisionFix(value, precisionFactor);
            const minFactor = precisionFix(min, precisionFactor);
            const minFactorBase = min === -MAX_SAFE_INTEGER ? 0 : minFactor;
            const maxFactor = precisionFix(max, precisionFactor);
            const stepFactor = precisionFix(step, precisionFactor);
            let beforeStepFactor = getBeforeStepValue(valueFactor, minFactorBase, stepFactor);
            if (beforeStepFactor === valueFactor) {
                return undefined;
            }
            if (beforeStepFactor > maxFactor) {
                beforeStepFactor = getBeforeStepValue(maxFactor, minFactorBase, stepFactor);
            }
            else if (beforeStepFactor < minFactor) {
                beforeStepFactor = minFactor;
            }
            const afterStepFactor = beforeStepFactor + stepFactor;
            const values = [beforeStepFactor / precisionFactor];
            if (afterStepFactor <= maxFactor) {
                values.push(afterStepFactor / precisionFactor);
            }
            return values;
        }
    }
    else if (isMoment(value)) {
        const { hour, minute, second } = step;
        if (second) {
            return getNearStepMoments(value, second, "s" /* second */);
        }
        if (minute) {
            return getNearStepMoments(value, minute, "m" /* minute */);
        }
        if (hour) {
            return getNearStepMoments(value, hour, "h" /* hour */);
        }
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL251bWJlci1maWVsZC91dGlscy50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBc0IsTUFBTSxRQUFRLENBQUM7QUFDdEQsT0FBTyxRQUFRLE1BQU0saUJBQWlCLENBQUM7QUFDdkMsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFJekMsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXZFLE1BQU0sVUFBVSxZQUFZLENBQUMsS0FBYTtJQUN4QyxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDckMsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNsQyxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDdkU7SUFDRCxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2pDLE9BQU8sV0FBVyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUMxRDtJQUNELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLEtBQWEsRUFBRSxJQUFZO0lBQ2xELE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxNQUFNLHFCQUFxQixHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRCxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1YsT0FBTyxhQUFhLENBQUM7S0FDdEI7SUFDRCxPQUFPLElB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QUFLLEVBQUUsTUFBTSxtQkFBeUIsQ0FBQztTQUNsRTtRQUNELElBQUksSUFBSSxFQUFFO1lBQ1IsT0FBTyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxpQkFBdUIsQ0FBQztTQUM5RDtLQUNGO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy1wcm8vbnVtYmVyLWZpZWxkL3V0aWxzLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc01vbWVudCwgTW9tZW50LCB1bml0T2ZUaW1lIH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCBpc051bWJlciBmcm9tICdsb2Rhc2gvaXNOdW1iZXInO1xuaW1wb3J0IGRlZmF1bHRUbyBmcm9tICdsb2Rhc2gvZGVmYXVsdFRvJztcbmltcG9ydCB7IFRpbWVTdGVwIH0gZnJvbSAnLi4vZGF0ZS1waWNrZXIvRGF0ZVBpY2tlcic7XG5pbXBvcnQgeyBUaW1lVW5pdCB9IGZyb20gJy4uL2RhdGUtcGlja2VyL2VudW0nO1xuXG5leHBvcnQgY29uc3QgTUFYX1NBRkVfSU5URUdFUiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSIHx8IDIgKiogNTMgLSAxO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJlY2lzaW9uKHZhbHVlOiBudW1iZXIpOiBudW1iZXIge1xuICBjb25zdCB2YWx1ZVN0cmluZyA9IHZhbHVlLnRvU3RyaW5nKCk7XG4gIGlmICh2YWx1ZVN0cmluZy5pbmRleE9mKCdlLScpID49IDApIHtcbiAgICByZXR1cm4gcGFyc2VJbnQodmFsdWVTdHJpbmcuc2xpY2UodmFsdWVTdHJpbmcuaW5kZXhPZignZS0nKSArIDIpLCAxMCk7XG4gIH1cbiAgaWYgKHZhbHVlU3RyaW5nLmluZGV4T2YoJy4nKSA+PSAwKSB7XG4gICAgcmV0dXJuIHZhbHVlU3RyaW5nLmxlbmd0aCAtIHZhbHVlU3RyaW5nLmluZGV4T2YoJy4nKSAtIDE7XG4gIH1cbiAgcmV0dXJuIDA7XG59XG5cbmZ1bmN0aW9uIGdldE1heFByZWNpc2lvbih2YWx1ZTogbnVtYmVyLCBzdGVwOiBudW1iZXIpOiBudW1iZXIge1xuICBjb25zdCBzdGVwUHJlY2lzaW9uID0gZ2V0UHJlY2lzaW9uKHN0ZXApO1xuICBjb25zdCBjdXJyZW50VmFsdWVQcmVjaXNpb24gPSBnZXRQcmVjaXNpb24odmFsdWUpO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIHN0ZXBQcmVjaXNpb247XG4gIH1cbiAgcmV0dXJuIE1hdGgubWF4KGN1cnJlbnRWYWx1ZVByZWNpc2lvbiwgc3RlcFByZWNpc2lvbik7XG59XG5cbmZ1bmN0aW9uIGdldFByZWNpc2lvbkZhY3Rvcih2YWx1ZTogbnVtYmVyLCBzdGVwOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gMTAgKiogZ2V0TWF4UHJlY2lzaW9uKHZhbHVlLCBzdGVwKTtcbn1cblxuZnVuY3Rpb24gcHJlY2lzaW9uRml4KHZhbHVlOiBudW1iZXIsIHByZWNpc2lvbkZhY3RvcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBwcmVjaXNpb25GYWN0b3IpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGx1cyguLi52YWx1ZXM6IG51bWJlcltdKSB7XG4gIGlmICh2YWx1ZXMubGVuZ3RoID4gMikge1xuICAgIHJldHVybiBwbHVzKHZhbHVlcy5zaGlmdCgpIGFzIG51bWJlciwgcGx1cyguLi52YWx1ZXMpKTtcbiAgfVxuICBpZiAodmFsdWVzLmxlbmd0aCA8IDIpIHtcbiAgICByZXR1cm4gdmFsdWVzWzBdO1xuICB9XG4gIGNvbnN0IHYxID0gdmFsdWVzWzBdO1xuICBjb25zdCB2MiA9IHZhbHVlc1sxXTtcbiAgY29uc3QgcHJlY2lzaW9uRmFjdG9yID0gZ2V0UHJlY2lzaW9uRmFjdG9yKHYxLCB2Mik7XG4gIHJldHVybiAocHJlY2lzaW9uRml4KHYxLCBwcmVjaXNpb25GYWN0b3IpICsgcHJlY2lzaW9uRml4KHYyLCBwcmVjaXNpb25GYWN0b3IpKSAvIHByZWNpc2lvbkZhY3Rvcjtcbn1cblxuZnVuY3Rpb24gZ2V0QmVmb3JlU3RlcFZhbHVlKHZhbHVlOiBudW1iZXIsIG1pbkZhY3RvcjogbnVtYmVyLCBzdGVwRmFjdG9yOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gdmFsdWUgLSAoKHZhbHVlIC0gbWluRmFjdG9yKSAlIHN0ZXBGYWN0b3IpO1xufVxuXG5mdW5jdGlvbiBnZXROZWFyU3RlcE1vbWVudHMoXG4gIHZhbHVlOiBNb21lbnQsXG4gIHN0ZXA6IG51bWJlcixcbiAgdW5pdDogdW5pdE9mVGltZS5CYXNlLFxuKTogTW9tZW50W10gfCB1bmRlZmluZWQge1xuICBjb25zdCB1bml0VmFsdWUgPSB2YWx1ZS5nZXQodW5pdCk7XG4gIGNvbnN0IG1vZCA9IHVuaXRWYWx1ZSAlIHN0ZXA7XG4gIGlmIChtb2QgIT09IDApIHtcbiAgICBjb25zdCBiZWZvcmUgPSB1bml0VmFsdWUgLSBtb2Q7XG4gICAgY29uc3QgYWZ0ZXIgPSBiZWZvcmUgKyBzdGVwO1xuICAgIHJldHVybiBbdmFsdWUuY2xvbmUoKS5zZXQodW5pdCwgYmVmb3JlKSwgdmFsdWUuY2xvbmUoKS5zZXQodW5pdCwgYWZ0ZXIpXTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmVhclN0ZXBWYWx1ZXM8VCBleHRlbmRzIE1vbWVudCB8IG51bWJlcj4oXG4gIHZhbHVlOiBULFxuICBzdGVwOiBudW1iZXIgfCBUaW1lU3RlcCxcbiAgbWluPzogbnVtYmVyIHwgTW9tZW50IHwgbnVsbCxcbiAgbWF4PzogbnVtYmVyIHwgTW9tZW50IHwgbnVsbCxcbik6IFRbXSB8IHVuZGVmaW5lZCB7XG4gIGlmIChpc051bWJlcihzdGVwKSkge1xuICAgIGlmIChpc051bWJlcih2YWx1ZSkpIHtcbiAgICAgIG1pbiA9IGRlZmF1bHRUbyhOdW1iZXIobWluKSwgLU1BWF9TQUZFX0lOVEVHRVIpO1xuICAgICAgbWF4ID0gZGVmYXVsdFRvKE51bWJlcihtYXgpLCBNQVhfU0FGRV9JTlRFR0VSKTtcbiAgICAgIGNvbnN0IHByZWNpc2lvbkZhY3RvciA9IGdldFByZWNpc2lvbkZhY3Rvcih2YWx1ZSwgc3RlcCk7XG4gICAgICBjb25zdCB2YWx1ZUZhY3RvciA9IHByZWNpc2lvbkZpeCh2YWx1ZSwgcHJlY2lzaW9uRmFjdG9yKTtcbiAgICAgIGNvbnN0IG1pbkZhY3RvciA9IHByZWNpc2lvbkZpeChtaW4sIHByZWNpc2lvbkZhY3Rvcik7XG4gICAgICBjb25zdCBtaW5GYWN0b3JCYXNlID0gbWluID09PSAtTUFYX1NBRkVfSU5URUdFUiA/IDAgOiBtaW5GYWN0b3I7XG4gICAgICBjb25zdCBtYXhGYWN0b3IgPSBwcmVjaXNpb25GaXgobWF4LCBwcmVjaXNpb25GYWN0b3IpO1xuICAgICAgY29uc3Qgc3RlcEZhY3RvciA9IHByZWNpc2lvbkZpeChzdGVwLCBwcmVjaXNpb25GYWN0b3IpO1xuICAgICAgbGV0IGJlZm9yZVN0ZXBGYWN0b3IgPSBnZXRCZWZvcmVTdGVwVmFsdWUodmFsdWVGYWN0b3IsIG1pbkZhY3RvckJhc2UsIHN0ZXBGYWN0b3IpO1xuICAgICAgaWYgKGJlZm9yZVN0ZXBGYWN0b3IgPT09IHZhbHVlRmFjdG9yKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBpZiAoYmVmb3JlU3RlcEZhY3RvciA+IG1heEZhY3Rvcikge1xuICAgICAgICBiZWZvcmVTdGVwRmFjdG9yID0gZ2V0QmVmb3JlU3RlcFZhbHVlKG1heEZhY3RvciwgbWluRmFjdG9yQmFzZSwgc3RlcEZhY3Rvcik7XG4gICAgICB9IGVsc2UgaWYgKGJlZm9yZVN0ZXBGYWN0b3IgPCBtaW5GYWN0b3IpIHtcbiAgICAgICAgYmVmb3JlU3RlcEZhY3RvciA9IG1pbkZhY3RvcjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFmdGVyU3RlcEZhY3RvciA9IGJlZm9yZVN0ZXBGYWN0b3IgKyBzdGVwRmFjdG9yO1xuICAgICAgY29uc3QgdmFsdWVzOiBudW1iZXJbXSA9IFtiZWZvcmVTdGVwRmFjdG9yIC8gcHJlY2lzaW9uRmFjdG9yXTtcbiAgICAgIGlmIChhZnRlclN0ZXBGYWN0b3IgPD0gbWF4RmFjdG9yKSB7XG4gICAgICAgIHZhbHVlcy5wdXNoKGFmdGVyU3RlcEZhY3RvciAvIHByZWNpc2lvbkZhY3Rvcik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWVzIGFzIFRbXTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoaXNNb21lbnQodmFsdWUpKSB7XG4gICAgY29uc3QgeyBob3VyLCBtaW51dGUsIHNlY29uZCB9ID0gc3RlcDtcbiAgICBpZiAoc2Vjb25kKSB7XG4gICAgICByZXR1cm4gZ2V0TmVhclN0ZXBNb21lbnRzKHZhbHVlLCBzZWNvbmQsIFRpbWVVbml0LnNlY29uZCkgYXMgVFtdO1xuICAgIH1cbiAgICBpZiAobWludXRlKSB7XG4gICAgICByZXR1cm4gZ2V0TmVhclN0ZXBNb21lbnRzKHZhbHVlLCBtaW51dGUsIFRpbWVVbml0Lm1pbnV0ZSkgYXMgVFtdO1xuICAgIH1cbiAgICBpZiAoaG91cikge1xuICAgICAgcmV0dXJuIGdldE5lYXJTdGVwTW9tZW50cyh2YWx1ZSwgaG91ciwgVGltZVVuaXQuaG91cikgYXMgVFtdO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9