import React, { Children, cloneElement, Component } from 'react';
import PropTypes from 'prop-types';
import classNames from 'classnames';
import omit from 'lodash/omit';
import Spin from '../spin';
import LocaleReceiver from '../locale-provider/LocaleReceiver';
import defaultLocale from '../locale-provider/default';
import Pagination from '../pagination';
import { Row } from '../grid';
import Item from './Item';
import { getPrefixCls } from '../configure';
export default class List extends Component {
    constructor() {
        super(...arguments);
        this.keys = {};
        this.renderItem = (item, index) => {
            const { dataSource, renderItem, rowKey } = this.props;
            let key;
            if (typeof rowKey === 'function') {
                key = rowKey(dataSource[index]);
            }
            else if (typeof rowKey === 'string') {
                key = dataSource[rowKey];
            }
            else {
                key = dataSource.key;
            }
            if (!key) {
                key = `list-item-${index}`;
            }
            this.keys[index] = key;
            return renderItem(item, index);
        };
        this.renderEmpty = (contextLocale) => {
            const { props } = this;
            const locale = { ...contextLocale, ...props.locale };
            return React.createElement("div", { className: `${this.getPrefixCls()}-empty-text` }, locale.emptyText);
        };
    }
    getChildContext() {
        const { grid } = this.props;
        return {
            grid,
        };
    }
    isSomethingAfterLastTtem() {
        const { loadMore, pagination, footer } = this.props;
        return !!(loadMore || pagination || footer);
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('list', prefixCls);
    }
    render() {
        const { bordered, split, className, children, itemLayout, loadMore, pagination, grid, dataSource, size, header, footer, empty, loading, ...rest } = this.props;
        const prefixCls = this.getPrefixCls();
        let loadingProp = loading;
        if (typeof loadingProp === 'boolean') {
            loadingProp = {
                spinning: loadingProp,
            };
        }
        const isLoading = loadingProp && loadingProp.spinning;
        // large => lg
        // small => sm
        let sizeCls = '';
        switch (size) {
            case "large" /* large */:
                sizeCls = 'lg';
                break;
            case "small" /* small */:
                sizeCls = 'sm';
                break;
            default:
        }
        const classString = classNames(prefixCls, className, {
            [`${prefixCls}-vertical`]: itemLayout === 'vertical',
            [`${prefixCls}-${sizeCls}`]: sizeCls,
            [`${prefixCls}-split`]: split,
            [`${prefixCls}-bordered`]: bordered,
            [`${prefixCls}-loading`]: isLoading,
            [`${prefixCls}-grid`]: grid,
            [`${prefixCls}-something-after-last-item`]: this.isSomethingAfterLastTtem(),
        });
        const paginationContent = (React.createElement("div", { className: `${prefixCls}-pagination` },
            React.createElement(Pagination, Object.assign({}, pagination))));
        let childrenContent;
        childrenContent = isLoading && React.createElement("div", { style: { minHeight: 53 } });
        if (dataSource.length > 0) {
            const items = dataSource.map((item, index) => this.renderItem(item, index));
            const childrenList = Children.map(items, (child, index) => cloneElement(child, {
                key: this.keys[index],
            }));
            childrenContent = grid ? React.createElement(Row, { gutter: grid.gutter }, childrenList) : childrenList;
        }
        else if (!children && !isLoading && !empty) {
            childrenContent = (React.createElement(LocaleReceiver, { componentName: "Table", defaultLocale: defaultLocale.Table }, this.renderEmpty));
        }
        else {
            childrenContent = empty;
        }
        const content = (React.createElement("div", null,
            React.createElement(Spin, Object.assign({}, loadingProp), childrenContent),
            loadMore,
            !loadMore && pagination ? paginationContent : null));
        return (React.createElement("div", Object.assign({ className: classString }, omit(rest, ['prefixCls', 'rowKey', 'renderItem', 'selectable'])),
            header && React.createElement("div", { className: `${prefixCls}-header` }, header),
            content,
            children,
            footer && React.createElement("div", { className: `${prefixCls}-footer` }, footer)));
    }
}
List.displayName = 'List';
List.Item = Item;
List.childContextTypes = {
    grid: PropTypes.any,
};
List.defaultProps = {
    dataSource: [],
    bordered: false,
    split: true,
    loading: false,
    pagination: false,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvbGlzdC9pbmRleC50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBMkIsTUFBTSxPQUFPLENBQUM7QUFDMUYsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLElBQUksTUFBTSxhQUFhLENBQUM7QUFDL0IsT0FBTyxJQUFtQixNQUFNLFNBQVMsQ0FBQztBQUMxQyxPQUFPLGNBQWMsTUFBTSxtQ0FBbUMsQ0FBQztBQUMvRCxPQUFPLGFBQWEsTUFBTSw0QkFBNEIsQ0FBQztBQUV2RCxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM5QixPQUFPLElBQUksTUFBTSxRQUFRLENBQUM7QUFDMUIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQThDNUMsTUFBTSxDQUFDLE9BQU8sT0FBTyxJQUFLLFNBQVEsU0FBb0I7SUFBdEQ7O1FBaUJVLFNBQUksR0FBOEIsRUFBRSxDQUFDO1FBUzdDLGVBQVUsR0FBRyxDQUFDLElBQXVCLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDdEQsTUFBTSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUN0RCxJQUFJLEdBQUcsQ0FBQztZQUVSLElBQUksT0FBTyxNQUFNLEtBQUssVUFBVSxFQUFFO2dCQUNoQyxHQUFHLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ2pDO2lCQUFNLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUNyQyxHQUFHLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQzFCO2lCQUFN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TCxlQUFlLEdBQUcsS0FBSyxDQUFDO1NBQ3pCO1FBRUQsTUFBTSxPQUFPLEdBQUcsQ0FDZDtZQUNFLG9CQUFDLElBQUksb0JBQUssV0FBVyxHQUFHLGVBQWUsQ0FBUTtZQUM5QyxRQUFRO1lBQ1IsQ0FBQyxRQUFRLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUMvQyxDQUNQLENBQUM7UUFFRixPQUFPLENBQ0wsMkNBQUssU0FBUyxFQUFFLFdBQVcsSUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUMsWUFBWSxDQUFDLENBQUM7WUFDNUYsTUFBTSxJQUFJLDZCQUFLLFNBQVMsRUFBRSxHQUFHLFNBQVMsU0FBUyxJQUFHLE1BQU0sQ0FBTztZQUMvRCxPQUFPO1lBQ1AsUUFBUTtZQUNSLE1BQU0sSUFBSSw2QkFBSyxTQUFTLEVBQUUsR0FBRyxTQUFTLFNBQVMsSUFBRyxNQUFNLENBQU8sQ0FDNUQsQ0FDUCxDQUFDO0lBQ0osQ0FBQzs7QUEzSk0sZ0JBQVcsR0FBRyxNQUFNLENBQUM7QUFFckIsU0FBSSxHQUFnQixJQUFJLENBQUM7QUFFekIsc0JBQWlCLEdBQUc7SUFDekIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxHQUFHO0NBQ3BCLENBQUM7QUFFSyxpQkFBWSxHQUFHO0lBQ3BCLFVBQVUsRUFBRSxFQUFFO0lBQ2QsUUFBUSxFQUFFLEtBQUs7SUFDZixLQUFLLEVBQUUsSUFBSTtJQUNYLE9BQU8sRUFBRSxLQUFLO0lBQ2QsVUFBVSxFQUFFLEtBQUs7Q0FDbEIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy9saXN0L2luZGV4LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ2hpbGRyZW4sIGNsb25lRWxlbWVudCwgQ29tcG9uZW50LCBSZWFjdEVsZW1lbnQsIFJlYWN0Tm9kZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBvbWl0IGZyb20gJ2xvZGFzaC9vbWl0JztcbmltcG9ydCBTcGluLCB7IFNwaW5Qcm9wcyB9IGZyb20gJy4uL3NwaW4nO1xuaW1wb3J0IExvY2FsZVJlY2VpdmVyIGZyb20gJy4uL2xvY2FsZS1wcm92aWRlci9Mb2NhbGVSZWNlaXZlcic7XG5pbXBvcnQgZGVmYXVsdExvY2FsZSBmcm9tICcuLi9sb2NhbGUtcHJvdmlkZXIvZGVmYXVsdCc7XG5pbXBvcnQgeyBTaXplIH0gZnJvbSAnLi4vX3V0aWwvZW51bSc7XG5pbXBvcnQgUGFnaW5hdGlvbiBmcm9tICcuLi9wYWdpbmF0aW9uJztcbmltcG9ydCB7IFJvdyB9IGZyb20gJy4uL2dyaWQnO1xuaW1wb3J0IEl0ZW0gZnJvbSAnLi9JdGVtJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCB7IExpc3RJdGVtUHJvcHMsIExpc3RJdGVtTWV0YVByb3BzIH0gZnJvbSAnLi9JdGVtJztcblxuZXhwb3J0IHR5cGUgQ29sdW1uQ291bnQgPSAxIHwgMiB8IDMgfCA0IHwgNiB8IDggfCAxMiB8IDI0O1xuXG5leHBvcnQgdHlwZSBDb2x1bW5UeXBlID0gJ2d1dHRlcicgfCAnY29sdW1uJyB8ICd4cycgfCAnc20nIHwgJ21kJyB8ICdsZycgfCAneGwnIHwgJ3h4bCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlzdEdyaWRUeXBlIHtcbiAgZ3V0dGVyPzogbnVtYmVyO1xuICBjb2x1bW4/OiBDb2x1bW5Db3VudDtcbiAgeHM/OiBDb2x1bW5Db3VudDtcbiAgc20/OiBDb2x1bW5Db3VudDtcbiAgbWQ/OiBDb2x1bW5Db3VudDtcbiAgbGc/OiBDb2x1bW5Db3VudDtcbiAgeGw/OiBDb2x1bW5Db3VudDtcbiAgeHhsPzogQ29sdW1uQ291bnQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlzdFByb3BzIHtcbiAgYm9yZGVyZWQ/OiBib29sZWFuO1xuICBjbGFzc05hbWU/OiBzdHJpbmc7XG4gIGNoaWxkcmVuPzogUmVhY3ROb2RlO1xuICBkYXRhU291cmNlOiBhbnk7XG4gIGV4dHJhPzogUmVhY3ROb2RlO1xuICBncmlkPzogTGlzdEdyaWRUeXBlO1xuICBpZD86IHN0cmluZztcbiAgaXRlbUxheW91dD86IHN0cmluZztcbiAgbG9hZGluZz86IGJvb2xlYW4gfCBTcGluUHJvcHM7XG4gIGxvYWRNb3JlPzogUmVhY3ROb2RlO1xuICBwYWdpbmF0aW9uPzogYW55O1xuICBwcmVmaXhDbHM/OiBzdHJpbmc7XG4gIHJvd0tleT86IGFueTtcbiAgcmVuZGVySXRlbTogYW55O1xuICBzaXplPzogU2l6ZTtcbiAgc3BsaXQ/OiBib29sZWFuO1xuICBoZWFkZXI/OiBSZWFjdE5vZGU7XG4gIGZvb3Rlcj86IFJlYWN0Tm9kZTtcbiAgZW1wdHk/OiBSZWFjdE5vZGU7XG4gIGxvY2FsZT86IE9iamVjdDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMaXN0TG9jYWxlIHtcbiAgZW1wdHlUZXh0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExpc3QgZXh0ZW5kcyBDb21wb25lbnQ8TGlzdFByb3BzPiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdMaXN0JztcblxuICBzdGF0aWMgSXRlbTogdHlwZW9mIEl0ZW0gPSBJdGVtO1xuXG4gIHN0YXRpYyBjaGlsZENvbnRleHRUeXBlcyA9IHtcbiAgICBncmlkOiBQcm9wVHlwZXMuYW55LFxuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgZGF0YVNvdXJjZTogW10sXG4gICAgYm9yZGVyZWQ6IGZhbHNlLFxuICAgIHNwbGl0OiB0cnVlLFxuICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgIHBhZ2luYXRpb246IGZhbHNlLFxuICB9O1xuXG4gIHByaXZhdGUga2V5czogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gIGdldENoaWxkQ29udGV4dCgpIHtcbiAgICBjb25zdCB7IGdyaWQgfSA9IHRoaXMucHJvcHM7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdyaWQsXG4gICAgfTtcbiAgfVxuXG4gIHJlbmRlckl0ZW0gPSAoaXRlbTogUmVhY3RFbGVtZW50PGFueT4sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICBjb25zdCB7IGRhdGFTb3VyY2UsIHJlbmRlckl0ZW0sIHJvd0tleSB9ID0gdGhpcy5wcm9wcztcbiAgICBsZXQga2V5O1xuXG4gICAgaWYgKHR5cGVvZiByb3dLZXkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGtleSA9IHJvd0tleShkYXRhU291cmNlW2luZGV4XSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygcm93S2V5ID09PSAnc3RyaW5nJykge1xuICAgICAga2V5ID0gZGF0YVNvdXJjZVtyb3dLZXldO1xuICAgIH0gZWxzZSB7XG4gICAgICBrZXkgPSBkYXRhU291cmNlLmtleTtcbiAgICB9XG5cbiAgICBpZiAoIWtleSkge1xuICAgICAga2V5ID0gYGxpc3QtaXRlbS0ke2luZGV4fWA7XG4gICAgfVxuXG4gICAgdGhpcy5rZXlzW2luZGV4XSA9IGtleTtcblxuICAgIHJldHVybiByZW5kZXJJdGVtKGl0ZW0sIGluZGV4KTtcbiAgfTtcblxuICBpc1NvbWV0aGluZ0FmdGVyTGFzdFR0ZW0oKSB7XG4gICAgY29uc3QgeyBsb2FkTW9yZSwgcGFnaW5hdGlvbiwgZm9vdGVyIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiAhIShsb2FkTW9yZSB8fCBwYWdpbmF0aW9uIHx8IGZvb3Rlcik7XG4gIH1cblxuICByZW5kZXJFbXB0eSA9IChjb250ZXh0TG9jYWxlOiBMaXN0TG9jYWxlKSA9PiB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCBsb2NhbGUgPSB7IC4uLmNvbnRleHRMb2NhbGUsIC4uLnByb3BzLmxvY2FsZSB9O1xuICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17YCR7dGhpcy5nZXRQcmVmaXhDbHMoKX0tZW1wdHktdGV4dGB9Pntsb2NhbGUuZW1wdHlUZXh0fTwvZGl2PjtcbiAgfTtcblxuICBnZXRQcmVmaXhDbHMoKSB7XG4gICAgY29uc3QgeyBwcmVmaXhDbHMgfSA9IHRoaXMucHJvcHM7XG4gICAgcmV0dXJuIGdldFByZWZpeENscygnbGlzdCcsIHByZWZpeENscyk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgYm9yZGVyZWQsXG4gICAgICBzcGxpdCxcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgaXRlbUxheW91dCxcbiAgICAgIGxvYWRNb3JlLFxuICAgICAgcGFnaW5hdGlvbixcbiAgICAgIGdyaWQsXG4gICAgICBkYXRhU291cmNlLFxuICAgICAgc2l6ZSxcbiAgICAgIGhlYWRlcixcbiAgICAgIGZvb3RlcixcbiAgICAgIGVtcHR5LFxuICAgICAgbG9hZGluZyxcbiAgICAgIC4uLnJlc3RcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGxldCBsb2FkaW5nUHJvcCA9IGxvYWRpbmc7XG4gICAgaWYgKHR5cGVvZiBsb2FkaW5nUHJvcCA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICBsb2FkaW5nUHJvcCA9IHtcbiAgICAgICAgc3Bpbm5pbmc6IGxvYWRpbmdQcm9wLFxuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgaXNMb2FkaW5nID0gbG9hZGluZ1Byb3AgJiYgbG9hZGluZ1Byb3Auc3Bpbm5pbmc7XG5cbiAgICAvLyBsYXJnZSA9PiBsZ1xuICAgIC8vIHNtYWxsID0+IHNtXG4gICAgbGV0IHNpemVDbHMgPSAnJztcbiAgICBzd2l0Y2ggKHNpemUpIHtcbiAgICAgIGNhc2UgU2l6ZS5sYXJnZTpcbiAgICAgICAgc2l6ZUNscyA9ICdsZyc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBTaXplLnNtYWxsOlxuICAgICAgICBzaXplQ2xzID0gJ3NtJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgIH1cblxuICAgIGNvbnN0IGNsYXNzU3RyaW5nID0gY2xhc3NOYW1lcyhwcmVmaXhDbHMsIGNsYXNzTmFtZSwge1xuICAgICAgW2Ake3ByZWZpeENsc30tdmVydGljYWxgXTogaXRlbUxheW91dCA9PT0gJ3ZlcnRpY2FsJyxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LSR7c2l6ZUNsc31gXTogc2l6ZUNscyxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LXNwbGl0YF06IHNwbGl0LFxuICAgICAgW2Ake3ByZWZpeENsc30tYm9yZGVyZWRgXTogYm9yZGVyZWQsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1sb2FkaW5nYF06IGlzTG9hZGluZyxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWdyaWRgXTogZ3JpZCxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LXNvbWV0aGluZy1hZnRlci1sYXN0LWl0ZW1gXTogdGhpcy5pc1NvbWV0aGluZ0FmdGVyTGFzdFR0ZW0oKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHBhZ2luYXRpb25Db250ZW50ID0gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tcGFnaW5hdGlvbmB9PlxuICAgICAgICA8UGFnaW5hdGlvbiB7Li4ucGFnaW5hdGlvbn0gLz5cbiAgICAgIDwvZGl2PlxuICAgICk7XG5cbiAgICBsZXQgY2hpbGRyZW5Db250ZW50O1xuICAgIGNoaWxkcmVuQ29udGVudCA9IGlzTG9hZGluZyAmJiA8ZGl2IHN0eWxlPXt7IG1pbkhlaWdodDogNTMgfX0gLz47XG4gICAgaWYgKGRhdGFTb3VyY2UubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgaXRlbXMgPSBkYXRhU291cmNlLm1hcCgoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB0aGlzLnJlbmRlckl0ZW0oaXRlbSwgaW5kZXgpKTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuTGlzdCA9IENoaWxkcmVuLm1hcChpdGVtcywgKGNoaWxkOiBhbnksIGluZGV4KSA9PlxuICAgICAgICBjbG9uZUVsZW1lbnQoY2hpbGQsIHtcbiAgICAgICAgICBrZXk6IHRoaXMua2V5c1tpbmRleF0sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgY2hpbGRyZW5Db250ZW50ID0gZ3JpZCA/IDxSb3cgZ3V0dGVyPXtncmlkLmd1dHRlcn0+e2NoaWxkcmVuTGlzdH08L1Jvdz4gOiBjaGlsZHJlbkxpc3Q7XG4gICAgfSBlbHNlIGlmICghY2hpbGRyZW4gJiYgIWlzTG9hZGluZyAmJiAhZW1wdHkpIHtcbiAgICAgIGNoaWxkcmVuQ29udGVudCA9IChcbiAgICAgICAgPExvY2FsZVJlY2VpdmVyIGNvbXBvbmVudE5hbWU9XCJUYWJsZVwiIGRlZmF1bHRMb2NhbGU9e2RlZmF1bHRMb2NhbGUuVGFibGV9PlxuICAgICAgICAgIHt0aGlzLnJlbmRlckVtcHR5fVxuICAgICAgICA8L0xvY2FsZVJlY2VpdmVyPlxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2hpbGRyZW5Db250ZW50ID0gZW1wdHk7XG4gICAgfVxuXG4gICAgY29uc3QgY29udGVudCA9IChcbiAgICAgIDxkaXY+XG4gICAgICAgIDxTcGluIHsuLi5sb2FkaW5nUHJvcH0+e2NoaWxkcmVuQ29udGVudH08L1NwaW4+XG4gICAgICAgIHtsb2FkTW9yZX1cbiAgICAgICAgeyFsb2FkTW9yZSAmJiBwYWdpbmF0aW9uID8gcGFnaW5hdGlvbkNvbnRlbnQgOiBudWxsfVxuICAgICAgPC9kaXY+XG4gICAgKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NTdHJpbmd9IHsuLi5vbWl0KHJlc3QsIFsncHJlZml4Q2xzJywgJ3Jvd0tleScsICdyZW5kZXJJdGVtJywnc2VsZWN0YWJsZSddKX0+XG4gICAgICAgIHtoZWFkZXIgJiYgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30taGVhZGVyYH0+e2hlYWRlcn08L2Rpdj59XG4gICAgICAgIHtjb250ZW50fVxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICAgIHtmb290ZXIgJiYgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZm9vdGVyYH0+e2Zvb3Rlcn08L2Rpdj59XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=