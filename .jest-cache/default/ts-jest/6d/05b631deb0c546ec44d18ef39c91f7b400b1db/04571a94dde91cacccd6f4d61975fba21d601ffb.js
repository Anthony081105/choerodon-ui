import React, { Component } from 'react';
import Select from '../select';
import { Button, Group } from '../radio';
import { getPrefixCls } from '../configure';
const Option = Select.Option;
export default class Header extends Component {
    constructor() {
        super(...arguments);
        this.onYearChange = (year) => {
            const { value, validRange } = this.props;
            const newValue = value.clone();
            newValue.year(parseInt(year, 10));
            // switch the month so that it remains within range when year changes
            if (validRange) {
                const [start, end] = validRange;
                const newYear = newValue.get('year');
                const newMonth = newValue.get('month');
                if (newYear === end.get('year') && newMonth > end.get('month')) {
                    newValue.month(end.get('month'));
                }
                if (newYear === start.get('year') && newMonth < start.get('month')) {
                    newValue.month(start.get('month'));
                }
            }
            const { onValueChange } = this.props;
            if (onValueChange) {
                onValueChange(newValue);
            }
        };
        this.onMonthChange = (month) => {
            const { onValueChange, value } = this.props;
            const newValue = value.clone();
            newValue.month(parseInt(month, 10));
            if (onValueChange) {
                onValueChange(newValue);
            }
        };
        this.onTypeChange = (e) => {
            const { onTypeChange } = this.props;
            if (onTypeChange) {
                onTypeChange(e.target.value);
            }
        };
        this.getCalenderHeaderNode = (node) => {
            this.calenderHeaderNode = node;
        };
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('fullcalendar-header', prefixCls);
    }
    getYearSelectElement(year) {
        const { yearSelectOffset, yearSelectTotal, locale, fullscreen, validRange } = this.props;
        const prefixCls = this.getPrefixCls();
        let start = year - yearSelectOffset;
        let end = start + yearSelectTotal;
        if (validRange) {
            start = validRange[0].get('year');
            end = validRange[1].get('year') + 1;
        }
        const suffix = locale.year === '年' ? '年' : '';
        const options = [];
        for (let index = start; index < end; index++) {
            options.push(React.createElement(Option, { key: `${index}` }, index + suffix));
        }
        return (React.createElement(Select, { size: fullscreen ? "default" /* default */ : "small" /* small */, dropdownMatchSelectWidth: false, className: `${prefixCls}-year-select`, onChange: this.onYearChange, value: String(year), getPopupContainer: () => this.calenderHeaderNode }, options));
    }
    getMonthsLocale(value) {
        const current = value.clone();
        const localeData = value.localeData();
        const months = [];
        for (let i = 0; i < 12; i++) {
            current.month(i);
            months.push(localeData.monthsShort(current));
        }
        return months;
    }
    getMonthSelectElement(month, months) {
        const props = this.props;
        const { fullscreen, validRange, value } = props;
        const prefixCls = this.getPrefixCls();
        const options = [];
        let start = 0;
        let end = 12;
        if (validRange) {
            const [rangeStart, rangeEnd] = validRange;
            const currentYear = value.get('year');
            if (rangeEnd.get('year') === currentYear) {
                end = rangeEnd.get('month') + 1;
            }
            else {
                start = rangeStart.get('month');
            }
        }
        for (let index = start; index < end; index++) {
            options.push(React.createElement(Option, { key: `${index}` }, months[index]));
        }
        return (React.createElement(Select, { size: fullscreen ? "default" /* default */ : "small" /* small */, dropdownMatchSelectWidth: false, className: `${prefixCls}-month-select`, value: String(month), onChange: this.onMonthChange, getPopupContainer: () => this.calenderHeaderNode }, options));
    }
    render() {
        const { type, value, locale, fullscreen } = this.props;
        const prefixCls = this.getPrefixCls();
        const yearSelect = this.getYearSelectElement(value.year());
        const monthSelect = type === 'date'
            ? this.getMonthSelectElement(value.month(), this.getMonthsLocale(value))
            : null;
        const typeSwitch = (React.createElement(Group, { onChange: this.onTypeChange, value: type, size: fullscreen ? "default" /* default */ : "small" /* small */ },
            React.createElement(Button, { value: "date" }, locale.month),
            React.createElement(Button, { value: "month" }, locale.year)));
        return (React.createElement("div", { className: `${prefixCls}-header`, ref: this.getCalenderHeaderNode },
            yearSelect,
            monthSelect,
            typeSwitch));
    }
}
Header.displayName = 'Header';
Header.defaultProps = {
    yearSelectOffset: 10,
    yearSelectTotal: 20,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvY2FsZW5kYXIvSGVhZGVyLnRzeCIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxPQUFPLENBQUM7QUFHdkQsT0FBTyxNQUFNLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFvQixNQUFNLFVBQVUsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTVDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFlN0IsTUFBTSxDQUFDLE9BQU8sT0FBTyxNQUFPLFNBQVEsU0FBMkI7SUFBL0Q7O1FBdUZFLGlCQUFZLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUM5QixNQUFNLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDekMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQy9CLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLHFFQUFxRTtZQUNyRSxJQUFJLFVBQVUsRUFBRTtnQkFDZCxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQztnQkFDaEMsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDckMsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDdkMsSUFBSSxPQUFPLEtBQUssR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRTtvQkFDOUQsUUFBUSxDQUFDLEtBQUssQ0FBQyxH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QUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzRCxNQUFNLFdBQVcsR0FDZixJQUFJLEtBQUssTUFBTTtZQUNiLENBQUMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDeEUsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNYLE1BQU0sVUFBVSxHQUFHLENBQ2pCLG9CQUFDLEtBQUssSUFDSixRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFDM0IsS0FBSyxFQUFFLElBQUksRUFDWCxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUMseUJBQWMsQ0FBQyxvQkFBVztZQUU1QyxvQkFBQyxNQUFNLElBQUMsS0FBSyxFQUFDLE1BQU0sSUFBRSxNQUFNLENBQUMsS0FBSyxDQUFVO1lBQzVDLG9CQUFDLE1BQU0sSUFBQyxLQUFLLEVBQUMsT0FBTyxJQUFFLE1BQU0sQ0FBQyxJQUFJLENBQVUsQ0FDdEMsQ0FDVCxDQUFDO1FBRUYsT0FBTyxDQUNMLDZCQUFLLFNBQVMsRUFBRSxHQUFHLFNBQVMsU0FBUyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMscUJBQXFCO1lBQ25FLFVBQVU7WUFDVixXQUFXO1lBQ1gsVUFBVSxDQUNQLENBQ1AsQ0FBQztJQUNKLENBQUM7O0FBM0pNLGtCQUFXLEdBQUcsUUFBUSxDQUFDO0FBRXZCLG1CQUFZLEdBQUc7SUFDcEIsZ0JBQWdCLEVBQUUsRUFBRTtJQUNwQixlQUFlLEVBQUUsRUFBRTtDQUNwQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL2NhbGVuZGFyL0hlYWRlci50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCwgUmVhY3RFbGVtZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgTW9tZW50IH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IFNpemUgfSBmcm9tICcuLi9fdXRpbC9lbnVtJztcbmltcG9ydCBTZWxlY3QgZnJvbSAnLi4vc2VsZWN0JztcbmltcG9ydCB7IEJ1dHRvbiwgR3JvdXAsIFJhZGlvQ2hhbmdlRXZlbnQgfSBmcm9tICcuLi9yYWRpbyc7XG5pbXBvcnQgeyBnZXRQcmVmaXhDbHMgfSBmcm9tICcuLi9jb25maWd1cmUnO1xuXG5jb25zdCBPcHRpb24gPSBTZWxlY3QuT3B0aW9uO1xuXG5leHBvcnQgaW50ZXJmYWNlIEhlYWRlclByb3BzIHtcbiAgcHJlZml4Q2xzPzogc3RyaW5nO1xuICBsb2NhbGU/OiBhbnk7XG4gIGZ1bGxzY3JlZW4/OiBib29sZWFuO1xuICB5ZWFyU2VsZWN0T2Zmc2V0PzogbnVtYmVyO1xuICB5ZWFyU2VsZWN0VG90YWw/OiBudW1iZXI7XG4gIHR5cGU/OiBzdHJpbmc7XG4gIG9uVmFsdWVDaGFuZ2U/OiAodmFsdWU6IE1vbWVudCkgPT4gdm9pZDtcbiAgb25UeXBlQ2hhbmdlPzogKHR5cGU6IHN0cmluZykgPT4gdm9pZDtcbiAgdmFsdWU6IGFueTtcbiAgdmFsaWRSYW5nZT86IFtNb21lbnQsIE1vbWVudF07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEhlYWRlciBleHRlbmRzIENvbXBvbmVudDxIZWFkZXJQcm9wcywgYW55PiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdIZWFkZXInO1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgeWVhclNlbGVjdE9mZnNldDogMTAsXG4gICAgeWVhclNlbGVjdFRvdGFsOiAyMCxcbiAgfTtcblxuICBwcml2YXRlIGNhbGVuZGVySGVhZGVyTm9kZTogSFRNTERpdkVsZW1lbnQ7XG5cbiAgZ2V0UHJlZml4Q2xzKCkge1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiBnZXRQcmVmaXhDbHMoJ2Z1bGxjYWxlbmRhci1oZWFkZXInLCBwcmVmaXhDbHMpO1xuICB9XG5cbiAgZ2V0WWVhclNlbGVjdEVsZW1lbnQoeWVhcjogbnVtYmVyKSB7XG4gICAgY29uc3QgeyB5ZWFyU2VsZWN0T2Zmc2V0LCB5ZWFyU2VsZWN0VG90YWwsIGxvY2FsZSwgZnVsbHNjcmVlbiwgdmFsaWRSYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGxldCBzdGFydCA9IHllYXIgLSAoeWVhclNlbGVjdE9mZnNldCBhcyBudW1iZXIpO1xuICAgIGxldCBlbmQgPSBzdGFydCArICh5ZWFyU2VsZWN0VG90YWwgYXMgbnVtYmVyKTtcbiAgICBpZiAodmFsaWRSYW5nZSkge1xuICAgICAgc3RhcnQgPSB2YWxpZFJhbmdlWzBdLmdldCgneWVhcicpO1xuICAgICAgZW5kID0gdmFsaWRSYW5nZVsxXS5nZXQoJ3llYXInKSArIDE7XG4gICAgfVxuICAgIGNvbnN0IHN1ZmZpeCA9IGxvY2FsZS55ZWFyID09PSAn5bm0JyA/ICflubQnIDogJyc7XG4gICAgY29uc3Qgb3B0aW9uczogUmVhY3RFbGVtZW50PGFueT5bXSA9IFtdO1xuICAgIGZvciAobGV0IGluZGV4ID0gc3RhcnQ7IGluZGV4IDwgZW5kOyBpbmRleCsrKSB7XG4gICAgICBvcHRpb25zLnB1c2goPE9wdGlvbiBrZXk9e2Ake2luZGV4fWB9PntpbmRleCArIHN1ZmZpeH08L09wdGlvbj4pO1xuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPFNlbGVjdFxuICAgICAgICBzaXplPXtmdWxsc2NyZWVuID8gU2l6ZS5kZWZhdWx0IDogU2l6ZS5zbWFsbH1cbiAgICAgICAgZHJvcGRvd25NYXRjaFNlbGVjdFdpZHRoPXtmYWxzZX1cbiAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXllYXItc2VsZWN0YH1cbiAgICAgICAgb25DaGFuZ2U9e3RoaXMub25ZZWFyQ2hhbmdlfVxuICAgICAgICB2YWx1ZT17U3RyaW5nKHllYXIpfVxuICAgICAgICBnZXRQb3B1cENvbnRhaW5lcj17KCkgPT4gdGhpcy5jYWxlbmRlckhlYWRlck5vZGV9XG4gICAgICA+XG4gICAgICAgIHtvcHRpb25zfVxuICAgICAgPC9TZWxlY3Q+XG4gICAgKTtcbiAgfVxuXG4gIGdldE1vbnRoc0xvY2FsZSh2YWx1ZTogTW9tZW50KSB7XG4gICAgY29uc3QgY3VycmVudCA9IHZhbHVlLmNsb25lKCk7XG4gICAgY29uc3QgbG9jYWxlRGF0YSA9IHZhbHVlLmxvY2FsZURhdGEoKTtcbiAgICBjb25zdCBtb250aHM6IGFueVtdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMjsgaSsrKSB7XG4gICAgICBjdXJyZW50Lm1vbnRoKGkpO1xuICAgICAgbW9udGhzLnB1c2gobG9jYWxlRGF0YS5tb250aHNTaG9ydChjdXJyZW50KSk7XG4gICAgfVxuICAgIHJldHVybiBtb250aHM7XG4gIH1cblxuICBnZXRNb250aFNlbGVjdEVsZW1lbnQobW9udGg6IG51bWJlciwgbW9udGhzOiBudW1iZXJbXSkge1xuICAgIGNvbnN0IHByb3BzID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGZ1bGxzY3JlZW4sIHZhbGlkUmFuZ2UsIHZhbHVlIH0gPSBwcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGNvbnN0IG9wdGlvbnM6IFJlYWN0RWxlbWVudDxhbnk+W10gPSBbXTtcbiAgICBsZXQgc3RhcnQgPSAwO1xuICAgIGxldCBlbmQgPSAxMjtcbiAgICBpZiAodmFsaWRSYW5nZSkge1xuICAgICAgY29uc3QgW3JhbmdlU3RhcnQsIHJhbmdlRW5kXSA9IHZhbGlkUmFuZ2U7XG4gICAgICBjb25zdCBjdXJyZW50WWVhciA9IHZhbHVlLmdldCgneWVhcicpO1xuICAgICAgaWYgKHJhbmdlRW5kLmdldCgneWVhcicpID09PSBjdXJyZW50WWVhcikge1xuICAgICAgICBlbmQgPSByYW5nZUVuZC5nZXQoJ21vbnRoJykgKyAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhcnQgPSByYW5nZVN0YXJ0LmdldCgnbW9udGgnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChsZXQgaW5kZXggPSBzdGFydDsgaW5kZXggPCBlbmQ7IGluZGV4KyspIHtcbiAgICAgIG9wdGlvbnMucHVzaCg8T3B0aW9uIGtleT17YCR7aW5kZXh9YH0+e21vbnRoc1tpbmRleF19PC9PcHRpb24+KTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxTZWxlY3RcbiAgICAgICAgc2l6ZT17ZnVsbHNjcmVlbiA/IFNpemUuZGVmYXVsdCA6IFNpemUuc21hbGx9XG4gICAgICAgIGRyb3Bkb3duTWF0Y2hTZWxlY3RXaWR0aD17ZmFsc2V9XG4gICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1tb250aC1zZWxlY3RgfVxuICAgICAgICB2YWx1ZT17U3RyaW5nKG1vbnRoKX1cbiAgICAgICAgb25DaGFuZ2U9e3RoaXMub25Nb250aENoYW5nZX1cbiAgICAgICAgZ2V0UG9wdXBDb250YWluZXI9eygpID0+IHRoaXMuY2FsZW5kZXJIZWFkZXJOb2RlfVxuICAgICAgPlxuICAgICAgICB7b3B0aW9uc31cbiAgICAgIDwvU2VsZWN0PlxuICAgICk7XG4gIH1cblxuICBvblllYXJDaGFuZ2UgPSAoeWVhcjogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgeyB2YWx1ZSwgdmFsaWRSYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHZhbHVlLmNsb25lKCk7XG4gICAgbmV3VmFsdWUueWVhcihwYXJzZUludCh5ZWFyLCAxMCkpO1xuICAgIC8vIHN3aXRjaCB0aGUgbW9udGggc28gdGhhdCBpdCByZW1haW5zIHdpdGhpbiByYW5nZSB3aGVuIHllYXIgY2hhbmdlc1xuICAgIGlmICh2YWxpZFJhbmdlKSB7XG4gICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB2YWxpZFJhbmdlO1xuICAgICAgY29uc3QgbmV3WWVhciA9IG5ld1ZhbHVlLmdldCgneWVhcicpO1xuICAgICAgY29uc3QgbmV3TW9udGggPSBuZXdWYWx1ZS5nZXQoJ21vbnRoJyk7XG4gICAgICBpZiAobmV3WWVhciA9PT0gZW5kLmdldCgneWVhcicpICYmIG5ld01vbnRoID4gZW5kLmdldCgnbW9udGgnKSkge1xuICAgICAgICBuZXdWYWx1ZS5tb250aChlbmQuZ2V0KCdtb250aCcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChuZXdZZWFyID09PSBzdGFydC5nZXQoJ3llYXInKSAmJiBuZXdNb250aCA8IHN0YXJ0LmdldCgnbW9udGgnKSkge1xuICAgICAgICBuZXdWYWx1ZS5tb250aChzdGFydC5nZXQoJ21vbnRoJykpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHsgb25WYWx1ZUNoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25WYWx1ZUNoYW5nZSkge1xuICAgICAgb25WYWx1ZUNoYW5nZShuZXdWYWx1ZSk7XG4gICAgfVxuICB9O1xuXG4gIG9uTW9udGhDaGFuZ2UgPSAobW9udGg6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHsgb25WYWx1ZUNoYW5nZSwgdmFsdWUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgbmV3VmFsdWUgPSB2YWx1ZS5jbG9uZSgpO1xuICAgIG5ld1ZhbHVlLm1vbnRoKHBhcnNlSW50KG1vbnRoLCAxMCkpO1xuICAgIGlmIChvblZhbHVlQ2hhbmdlKSB7XG4gICAgICBvblZhbHVlQ2hhbmdlKG5ld1ZhbHVlKTtcbiAgICB9XG4gIH07XG5cbiAgb25UeXBlQ2hhbmdlID0gKGU6IFJhZGlvQ2hhbmdlRXZlbnQpID0+IHtcbiAgICBjb25zdCB7IG9uVHlwZUNoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25UeXBlQ2hhbmdlKSB7XG4gICAgICBvblR5cGVDaGFuZ2UoZS50YXJnZXQudmFsdWUpO1xuICAgIH1cbiAgfTtcblxuICBnZXRDYWxlbmRlckhlYWRlck5vZGUgPSAobm9kZTogSFRNTERpdkVsZW1lbnQpID0+IHtcbiAgICB0aGlzLmNhbGVuZGVySGVhZGVyTm9kZSA9IG5vZGU7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgdHlwZSwgdmFsdWUsIGxvY2FsZSwgZnVsbHNjcmVlbiB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGNvbnN0IHllYXJTZWxlY3QgPSB0aGlzLmdldFllYXJTZWxlY3RFbGVtZW50KHZhbHVlLnllYXIoKSk7XG4gICAgY29uc3QgbW9udGhTZWxlY3QgPVxuICAgICAgdHlwZSA9PT0gJ2RhdGUnXG4gICAgICAgID8gdGhpcy5nZXRNb250aFNlbGVjdEVsZW1lbnQodmFsdWUubW9udGgoKSwgdGhpcy5nZXRNb250aHNMb2NhbGUodmFsdWUpKVxuICAgICAgICA6IG51bGw7XG4gICAgY29uc3QgdHlwZVN3aXRjaCA9IChcbiAgICAgIDxHcm91cFxuICAgICAgICBvbkNoYW5nZT17dGhpcy5vblR5cGVDaGFuZ2V9XG4gICAgICAgIHZhbHVlPXt0eXBlfVxuICAgICAgICBzaXplPXtmdWxsc2NyZWVuID8gU2l6ZS5kZWZhdWx0IDogU2l6ZS5zbWFsbH1cbiAgICAgID5cbiAgICAgICAgPEJ1dHRvbiB2YWx1ZT1cImRhdGVcIj57bG9jYWxlLm1vbnRofTwvQnV0dG9uPlxuICAgICAgICA8QnV0dG9uIHZhbHVlPVwibW9udGhcIj57bG9jYWxlLnllYXJ9PC9CdXR0b24+XG4gICAgICA8L0dyb3VwPlxuICAgICk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30taGVhZGVyYH0gcmVmPXt0aGlzLmdldENhbGVuZGVySGVhZGVyTm9kZX0+XG4gICAgICAgIHt5ZWFyU2VsZWN0fVxuICAgICAgICB7bW9udGhTZWxlY3R9XG4gICAgICAgIHt0eXBlU3dpdGNofVxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9