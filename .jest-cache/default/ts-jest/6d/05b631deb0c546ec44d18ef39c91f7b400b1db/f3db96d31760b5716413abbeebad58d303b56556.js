import React, { Component } from 'react';
import classNames from 'classnames';
import uniqBy from 'lodash/uniqBy';
import LocaleReceiver from '../locale-provider/LocaleReceiver';
import defaultLocale from '../locale-provider/default';
import UploadList from './UploadList';
import { fileToObject, genPercentAdd, getFileItem, removeFileItem, T } from './utils';
import RcUpload from '../rc-components/upload';
import { getPrefixCls } from '../configure';
export default class Upload extends Component {
    constructor(props) {
        super(props);
        this.onStart = (file) => {
            const { fileList } = this.state;
            const nextFileList = [...fileList];
            const targetItem = fileToObject(file);
            targetItem.status = 'uploading';
            nextFileList.push(targetItem);
            this.onChange({
                file: targetItem,
                fileList: nextFileList,
            });
            // fix ie progress
            if (!window.FormData) {
                this.autoUpdateProgress(0, targetItem);
            }
            const { onStart } = this.props;
            if (onStart) {
                onStart(file);
            }
        };
        this.onSuccess = (response, file) => {
            this.clearProgressTimer();
            try {
                if (typeof response === 'string') {
                    response = JSON.parse(response);
                }
            }
            catch (e) {
                /* do nothing */
            }
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (targetItem) {
                targetItem.status = 'done';
                targetItem.response = response;
                this.onChange({
                    file: { ...targetItem },
                    fileList,
                });
            }
            const { onSuccess } = this.props;
            if (onSuccess) {
                onSuccess(response, file);
            }
        };
        this.onProgress = (e, file) => {
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (targetItem) {
                targetItem.percent = e.percent;
                this.onChange({
                    event: e,
                    file: { ...targetItem },
                    fileList,
                });
            }
            const { onProgress } = this.props;
            if (onProgress) {
                onProgress(e, file);
            }
        };
        this.onError = (error, response, file) => {
            this.clearProgressTimer();
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (!targetItem) {
                return;
            }
            targetItem.error = error;
            targetItem.response = response;
            targetItem.status = 'error';
            this.onChange({
                file: { ...targetItem },
                fileList,
            });
            const { onError } = this.props;
            if (onError) {
                onError(error, response, file);
            }
        };
        this.handleManualRemove = (file) => {
            this.upload.abort(file);
            file.status = 'removed'; // eslint-disable-line
            this.handleRemove(file);
        };
        /**
         * 拖拽触发回调
         * @param uploadFiles 拖拽后文件列表
         */
        this.onDragEnd = (uploadFiles) => {
            const { onDragEnd } = this.props;
            if (onDragEnd) {
                const result = onDragEnd(uploadFiles);
                if (result !== false) {
                    this.setState({
                        fileList: uploadFiles,
                    });
                }
                else {
                    return false;
                }
            }
            this.setState({
                fileList: uploadFiles,
            });
        };
        this.onChange = (info) => {
            if (!('fileList' in this.props)) {
                this.setState({ fileList: info.fileList });
            }
            const { onChange } = this.props;
            if (onChange) {
                onChange(info);
            }
        };
        this.onFileDrop = (e) => {
            this.setState({
                dragState: e.type,
            });
        };
        this.beforeUpload = (file, uploadFiles) => {
            const { beforeUpload } = this.props;
            if (beforeUpload) {
                const result = beforeUpload(file, uploadFiles);
                if (result === false) {
                    const { fileList } = this.state;
                    this.onChange({
                        file,
                        fileList: uniqBy(uploadFiles.concat(fileList), (item) => item.uid),
                    });
                    return false;
                }
                if (result && result.then) {
                    return result;
                }
            }
            return true;
        };
        this.saveUpload = (node) => {
            this.upload = node;
        };
        this.renderUploadList = (uploadLocale) => {
            const { showUploadList, listType, onPreview, locale, previewFile, dragUploadList } = this.props;
            const { fileList } = this.state;
            const { showRemoveIcon, showPreviewIcon } = showUploadList;
            return (React.createElement(UploadList, { listType: listType, items: fileList, onPreview: onPreview, dragUploadList: dragUploadList, onDragEnd: this.onDragEnd, previewFile: previewFile, onRemove: this.handleManualRemove, showRemoveIcon: showRemoveIcon, showPreviewIcon: showPreviewIcon, locale: { ...uploadLocale, ...locale } }));
        };
        this.state = {
            fileList: props.fileList || props.defaultFileList || [],
            dragState: 'drop',
        };
    }
    componentWillUnmount() {
        this.clearProgressTimer();
    }
    autoUpdateProgress(_, file) {
        const getPercent = genPercentAdd();
        let curPercent = 0;
        this.clearProgressTimer();
        this.progressTimer = setInterval(() => {
            curPercent = getPercent(curPercent);
            this.onProgress({
                percent: curPercent,
            }, file);
        }, 200);
    }
    handleRemove(file) {
        const { onRemove } = this.props;
        Promise.resolve(typeof onRemove === 'function' ? onRemove(file) : onRemove).then(ret => {
            // Prevent removing file
            if (ret === false) {
                return;
            }
            const { fileList } = this.state;
            const removedFileList = removeFileItem(file, fileList);
            if (removedFileList) {
                this.onChange({
                    file,
                    fileList: removedFileList,
                });
            }
        });
    }
    componentWillReceiveProps(nextProps) {
        if ('fileList' in nextProps) {
            this.setState({
                fileList: nextProps.fileList || [],
            });
        }
    }
    clearProgressTimer() {
        clearInterval(this.progressTimer);
    }
    render() {
        const { prefixCls: customizePrefixCls, className, showUploadList, listType, type, disabled, children, dragUploadList, } = this.props;
        const { fileList, dragState } = this.state;
        const prefixCls = getPrefixCls('upload', customizePrefixCls);
        const rcUploadProps = {
            ...this.props,
            onStart: this.onStart,
            onError: this.onError,
            onProgress: this.onProgress,
            onSuccess: this.onSuccess,
            beforeUpload: this.beforeUpload,
            prefixCls,
        };
        delete rcUploadProps.className;
        const uploadList = showUploadList ? (React.createElement(LocaleReceiver, { componentName: "Upload", defaultLocale: defaultLocale.Upload }, this.renderUploadList)) : null;
        if (type === 'drag') {
            const dragCls = classNames(prefixCls, {
                [`${prefixCls}-drag`]: true,
                [`${prefixCls}-drag-uploading`]: fileList.some(file => file.status === 'uploading'),
                [`${prefixCls}-drag-hover`]: dragState === 'dragover',
                [`${prefixCls}-disabled`]: disabled,
            });
            return (React.createElement("span", { className: className },
                React.createElement("div", { className: dragCls, onDrop: this.onFileDrop, onDragOver: this.onFileDrop, onDragLeave: this.onFileDrop },
                    React.createElement(RcUpload, Object.assign({}, rcUploadProps, { ref: this.saveUpload, className: `${prefixCls}-btn` }),
                        React.createElement("div", { className: `${prefixCls}-drag-container` }, children))),
                uploadList));
        }
        const uploadButtonCls = classNames(prefixCls, {
            [`${prefixCls}-select`]: true,
            [`${prefixCls}-select-${listType}`]: true,
            [`${prefixCls}-disabled`]: disabled,
            [`${prefixCls}-drag-btn`]: dragUploadList,
        });
        const uploadButton = (React.createElement("div", { className: uploadButtonCls, style: { display: children ? '' : 'none' } },
            React.createElement(RcUpload, Object.assign({}, rcUploadProps, { ref: this.saveUpload }))));
        if (listType === 'picture-card') {
            return (React.createElement("span", { className: className },
                uploadList,
                uploadButton));
        }
        return (React.createElement("span", { className: className },
            uploadButton,
            uploadList));
    }
}
Upload.displayName = 'Upload';
Upload.defaultProps = {
    type: 'select',
    multiple: false,
    action: '',
    data: {},
    accept: '',
    beforeUpload: T,
    showUploadList: true,
    listType: 'text',
    className: '',
    disabled: false,
    supportServerRender: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdXBsb2FkL1VwbG9hZC50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQWEsTUFBTSxPQUFPLENBQUM7QUFDcEQsT0FBTyxVQUFVLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUNuQyxPQUFPLGNBQWMsTUFBTSxtQ0FBbUMsQ0FBQztBQUMvRCxPQUFPLGFBQWEsTUFBTSw0QkFBNEIsQ0FBQztBQUV2RCxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFFdEMsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDdEYsT0FBTyxRQUFRLE1BQU0seUJBQXlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUk1QyxNQUFNLENBQUMsT0FBTyxPQUFPLE1BQU8sU0FBUSxTQUFtQztJQXlCckUsWUFBWSxLQUFrQjtRQUM1QixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFZZixZQUFPLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEVBQUU7WUFDN0IsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDaEMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxVQUFVLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztZQUNoQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQ1osSUFBSSxFQUFFLFVBQVU7Z0JBQ2hCLFFBQVEsRUFBRSxZQUFZO2FBQ3ZCLENBQUMsQ0FBQztZQUNILGtCQUFr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LElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtZQUMvQixPQUFPLENBQ0wsOEJBQU0sU0FBUyxFQUFFLFNBQVM7Z0JBQ3ZCLFVBQVU7Z0JBQ1YsWUFBWSxDQUNSLENBQ1IsQ0FBQztTQUNIO1FBQ0QsT0FBTyxDQUNMLDhCQUFNLFNBQVMsRUFBRSxTQUFTO1lBQ3ZCLFlBQVk7WUFDWixVQUFVLENBQ04sQ0FDUixDQUFDO0lBQ0osQ0FBQzs7QUFuVk0sa0JBQVcsR0FBRyxRQUFRLENBQUM7QUFJdkIsbUJBQVksR0FBRztJQUNwQixJQUFJLEVBQUUsUUFBUTtJQUNkLFFBQVEsRUFBRSxLQUFLO0lBQ2YsTUFBTSxFQUFFLEVBQUU7SUFDVixJQUFJLEVBQUUsRUFBRTtJQUNSLE1BQU0sRUFBRSxFQUFFO0lBQ1YsWUFBWSxFQUFFLENBQUM7SUFDZixjQUFjLEVBQUUsSUFBSTtJQUNwQixRQUFRLEVBQUUsTUFBTTtJQUNoQixTQUFTLEVBQUUsRUFBRTtJQUNiLFFBQVEsRUFBRSxLQUFLO0lBQ2YsbUJBQW1CLEVBQUUsSUFBSTtDQUMxQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL3VwbG9hZC9VcGxvYWQudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIERyYWdFdmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHVuaXFCeSBmcm9tICdsb2Rhc2gvdW5pcUJ5JztcbmltcG9ydCBMb2NhbGVSZWNlaXZlciBmcm9tICcuLi9sb2NhbGUtcHJvdmlkZXIvTG9jYWxlUmVjZWl2ZXInO1xuaW1wb3J0IGRlZmF1bHRMb2NhbGUgZnJvbSAnLi4vbG9jYWxlLXByb3ZpZGVyL2RlZmF1bHQnO1xuaW1wb3J0IERyYWdnZXIgZnJvbSAnLi9EcmFnZ2VyJztcbmltcG9ydCBVcGxvYWRMaXN0IGZyb20gJy4vVXBsb2FkTGlzdCc7XG5pbXBvcnQgeyBVcGxvYWRDaGFuZ2VQYXJhbSwgVXBsb2FkRmlsZSwgVXBsb2FkTG9jYWxlLCBVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBmaWxlVG9PYmplY3QsIGdlblBlcmNlbnRBZGQsIGdldEZpbGVJdGVtLCByZW1vdmVGaWxlSXRlbSwgVCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFJjVXBsb2FkIGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdXBsb2FkJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCB7IFVwbG9hZFByb3BzIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVwbG9hZCBleHRlbmRzIENvbXBvbmVudDxVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGU+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ1VwbG9hZCc7XG5cbiAgc3RhdGljIERyYWdnZXI6IHR5cGVvZiBEcmFnZ2VyO1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgdHlwZTogJ3NlbGVjdCcsXG4gICAgbXVsdGlwbGU6IGZhbHNlLFxuICAgIGFjdGlvbjogJycsXG4gICAgZGF0YToge30sXG4gICAgYWNjZXB0OiAnJyxcbiAgICBiZWZvcmVVcGxvYWQ6IFQsXG4gICAgc2hvd1VwbG9hZExpc3Q6IHRydWUsXG4gICAgbGlzdFR5cGU6ICd0ZXh0JywgLy8gb3IgcGljdHJ1ZVxuICAgIGNsYXNzTmFtZTogJycsXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxuICAgIHN1cHBvcnRTZXJ2ZXJSZW5kZXI6IHRydWUsXG4gIH07XG5cbiAgcmVjZW50VXBsb2FkU3RhdHVzOiBib29sZWFuIHwgUHJvbWlzZUxpa2U8YW55PjtcblxuICBwcm9ncmVzc1RpbWVyOiBhbnk7XG5cbiAgcHJpdmF0ZSB1cGxvYWQ6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogVXBsb2FkUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgZmlsZUxpc3Q6IHByb3BzLmZpbGVMaXN0IHx8IHByb3BzLmRlZmF1bHRGaWxlTGlzdCB8fCBbXSxcbiAgICAgIGRyYWdTdGF0ZTogJ2Ryb3AnLFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB0aGlzLmNsZWFyUHJvZ3Jlc3NUaW1lcigpO1xuICB9XG5cbiAgb25TdGFydCA9IChmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBuZXh0RmlsZUxpc3QgPSBbLi4uZmlsZUxpc3RdO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBmaWxlVG9PYmplY3QoZmlsZSk7XG4gICAgdGFyZ2V0SXRlbS5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICBuZXh0RmlsZUxpc3QucHVzaCh0YXJnZXRJdGVtKTtcbiAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgIGZpbGU6IHRhcmdldEl0ZW0sXG4gICAgICBmaWxlTGlzdDogbmV4dEZpbGVMaXN0LFxuICAgIH0pO1xuICAgIC8vIGZpeCBpZSBwcm9ncmVzc1xuICAgIGlmICghKHdpbmRvdyBhcyBhbnkpLkZvcm1EYXRhKSB7XG4gICAgICB0aGlzLmF1dG9VcGRhdGVQcm9ncmVzcygwLCB0YXJnZXRJdGVtKTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN0YXJ0IH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblN0YXJ0KSB7XG4gICAgICBvblN0YXJ0KGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBhdXRvVXBkYXRlUHJvZ3Jlc3MoXzogYW55LCBmaWxlOiBVcGxvYWRGaWxlKSB7XG4gICAgY29uc3QgZ2V0UGVyY2VudCA9IGdlblBlcmNlbnRBZGQoKTtcbiAgICBsZXQgY3VyUGVyY2VudCA9IDA7XG4gICAgdGhpcy5jbGVhclByb2dyZXNzVGltZXIoKTtcbiAgICB0aGlzLnByb2dyZXNzVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBjdXJQZXJjZW50ID0gZ2V0UGVyY2VudChjdXJQZXJjZW50KTtcbiAgICAgIHRoaXMub25Qcm9ncmVzcyhcbiAgICAgICAge1xuICAgICAgICAgIHBlcmNlbnQ6IGN1clBlcmNlbnQsXG4gICAgICAgIH0sXG4gICAgICAgIGZpbGUsXG4gICAgICApO1xuICAgIH0sIDIwMCk7XG4gIH1cblxuICBvblN1Y2Nlc3MgPSAocmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLyogZG8gbm90aGluZyAqL1xuICAgIH1cbiAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBnZXRGaWxlSXRlbShmaWxlLCBmaWxlTGlzdCk7XG4gICAgLy8gcmVtb3ZlZFxuICAgIGlmICh0YXJnZXRJdGVtKSB7XG4gICAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdkb25lJztcbiAgICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIHRoaXMub25DaGFuZ2Uoe1xuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN1Y2Nlc3MgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uU3VjY2Vzcykge1xuICAgICAgb25TdWNjZXNzKHJlc3BvbnNlLCBmaWxlKTtcbiAgICB9XG4gIH07XG5cbiAgb25Qcm9ncmVzcyA9IChlOiB7IHBlcmNlbnQ6IG51bWJlciB9LCBmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAodGFyZ2V0SXRlbSkge1xuICAgICAgdGFyZ2V0SXRlbS5wZXJjZW50ID0gZS5wZXJjZW50O1xuICAgICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICAgIGV2ZW50OiBlLFxuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblByb2dyZXNzIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblByb2dyZXNzKSB7XG4gICAgICBvblByb2dyZXNzKGUsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBvbkVycm9yID0gKGVycm9yOiBFcnJvciwgcmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAoIXRhcmdldEl0ZW0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGFyZ2V0SXRlbS5lcnJvciA9IGVycm9yO1xuICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgIGZpbGVMaXN0LFxuICAgIH0pO1xuICAgIGNvbnN0IHsgb25FcnJvciB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25FcnJvcikge1xuICAgICAgb25FcnJvcihlcnJvciwgcmVzcG9uc2UsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBoYW5kbGVSZW1vdmUoZmlsZTogVXBsb2FkRmlsZSkge1xuICAgIGNvbnN0IHsgb25SZW1vdmUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBQcm9taXNlLnJlc29sdmUodHlwZW9mIG9uUmVtb3ZlID09PSAnZnVuY3Rpb24nID8gb25SZW1vdmUoZmlsZSkgOiBvblJlbW92ZSkudGhlbihyZXQgPT4ge1xuICAgICAgLy8gUHJldmVudCByZW1vdmluZyBmaWxlXG4gICAgICBpZiAocmV0ID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgY29uc3QgcmVtb3ZlZEZpbGVMaXN0ID0gcmVtb3ZlRmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgICAgaWYgKHJlbW92ZWRGaWxlTGlzdCkge1xuICAgICAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgICAgICBmaWxlLFxuICAgICAgICAgIGZpbGVMaXN0OiByZW1vdmVkRmlsZUxpc3QsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlTWFudWFsUmVtb3ZlID0gKGZpbGU6IFVwbG9hZEZpbGUpID0+IHtcbiAgICB0aGlzLnVwbG9hZC5hYm9ydChmaWxlKTtcbiAgICBmaWxlLnN0YXR1cyA9ICdyZW1vdmVkJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgIHRoaXMuaGFuZGxlUmVtb3ZlKGZpbGUpO1xuICB9O1xuXG4gIC8qKlxuICAgKiDmi5bmi73op6blj5Hlm57osINcbiAgICogQHBhcmFtIHVwbG9hZEZpbGVzIOaLluaLveWQjuaWh+S7tuWIl+ihqFxuICAgKi9cbiAgb25EcmFnRW5kID0gKHVwbG9hZEZpbGVzOiBVcGxvYWRGaWxlW10pID0+IHtcbiAgICBjb25zdCB7IG9uRHJhZ0VuZCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25EcmFnRW5kKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBvbkRyYWdFbmQodXBsb2FkRmlsZXMpO1xuICAgICAgaWYgKHJlc3VsdCAhPT0gZmFsc2UpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgZmlsZUxpc3Q6IHVwbG9hZEZpbGVzLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBmaWxlTGlzdDogdXBsb2FkRmlsZXMsXG4gICAgfSk7XG4gIH07XG5cbiAgb25DaGFuZ2UgPSAoaW5mbzogVXBsb2FkQ2hhbmdlUGFyYW0pID0+IHtcbiAgICBpZiAoISgnZmlsZUxpc3QnIGluIHRoaXMucHJvcHMpKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgZmlsZUxpc3Q6IGluZm8uZmlsZUxpc3QgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBvbkNoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25DaGFuZ2UpIHtcbiAgICAgIG9uQ2hhbmdlKGluZm8pO1xuICAgIH1cbiAgfTtcblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogVXBsb2FkUHJvcHMpIHtcbiAgICBpZiAoJ2ZpbGVMaXN0JyBpbiBuZXh0UHJvcHMpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBmaWxlTGlzdDogbmV4dFByb3BzLmZpbGVMaXN0IHx8IFtdLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgb25GaWxlRHJvcCA9IChlOiBEcmFnRXZlbnQ8SFRNTERpdkVsZW1lbnQ+KSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBkcmFnU3RhdGU6IGUudHlwZSxcbiAgICB9KTtcbiAgfTtcblxuICBiZWZvcmVVcGxvYWQgPSAoZmlsZTogVXBsb2FkRmlsZSwgdXBsb2FkRmlsZXM6IFVwbG9hZEZpbGVbXSkgPT4ge1xuICAgIGNvbnN0IHsgYmVmb3JlVXBsb2FkIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChiZWZvcmVVcGxvYWQpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJlZm9yZVVwbG9hZChmaWxlLCB1cGxvYWRGaWxlcyk7XG4gICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkge1xuICAgICAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgICAgICBmaWxlLFxuICAgICAgICAgIGZpbGVMaXN0OiB1bmlxQnkodXBsb2FkRmlsZXMuY29uY2F0KGZpbGVMaXN0KSwgKGl0ZW06IGFueSkgPT4gaXRlbS51aWQpLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHJlc3VsdCAmJiAocmVzdWx0IGFzIFByb21pc2VMaWtlPGFueT4pLnRoZW4pIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgY2xlYXJQcm9ncmVzc1RpbWVyKCkge1xuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5wcm9ncmVzc1RpbWVyKTtcbiAgfVxuXG4gIHNhdmVVcGxvYWQgPSAobm9kZTogUmNVcGxvYWQgfCBudWxsKSA9PiB7XG4gICAgdGhpcy51cGxvYWQgPSBub2RlO1xuICB9O1xuXG4gIHJlbmRlclVwbG9hZExpc3QgPSAodXBsb2FkTG9jYWxlOiBVcGxvYWRMb2NhbGUpID0+IHtcbiAgICBjb25zdCB7IHNob3dVcGxvYWRMaXN0LCBsaXN0VHlwZSwgb25QcmV2aWV3LCBsb2NhbGUsIHByZXZpZXdGaWxlLCBkcmFnVXBsb2FkTGlzdCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHsgc2hvd1JlbW92ZUljb24sIHNob3dQcmV2aWV3SWNvbiB9ID0gc2hvd1VwbG9hZExpc3QgYXMgYW55O1xuICAgIHJldHVybiAoXG4gICAgICA8VXBsb2FkTGlzdFxuICAgICAgICBsaXN0VHlwZT17bGlzdFR5cGV9XG4gICAgICAgIGl0ZW1zPXtmaWxlTGlzdH1cbiAgICAgICAgb25QcmV2aWV3PXtvblByZXZpZXd9XG4gICAgICAgIGRyYWdVcGxvYWRMaXN0PXtkcmFnVXBsb2FkTGlzdH1cbiAgICAgICAgb25EcmFnRW5kPXt0aGlzLm9uRHJhZ0VuZH1cbiAgICAgICAgcHJldmlld0ZpbGU9e3ByZXZpZXdGaWxlfVxuICAgICAgICBvblJlbW92ZT17dGhpcy5oYW5kbGVNYW51YWxSZW1vdmV9XG4gICAgICAgIHNob3dSZW1vdmVJY29uPXtzaG93UmVtb3ZlSWNvbn1cbiAgICAgICAgc2hvd1ByZXZpZXdJY29uPXtzaG93UHJldmlld0ljb259XG4gICAgICAgIGxvY2FsZT17eyAuLi51cGxvYWRMb2NhbGUsIC4uLmxvY2FsZSB9fVxuICAgICAgLz5cbiAgICApO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBwcmVmaXhDbHM6IGN1c3RvbWl6ZVByZWZpeENscyxcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIHNob3dVcGxvYWRMaXN0LFxuICAgICAgbGlzdFR5cGUsXG4gICAgICB0eXBlLFxuICAgICAgZGlzYWJsZWQsXG4gICAgICBjaGlsZHJlbixcbiAgICAgIGRyYWdVcGxvYWRMaXN0LFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgZmlsZUxpc3QsIGRyYWdTdGF0ZSB9ID0gdGhpcy5zdGF0ZTtcblxuICAgIGNvbnN0IHByZWZpeENscyA9IGdldFByZWZpeENscygndXBsb2FkJywgY3VzdG9taXplUHJlZml4Q2xzKTtcblxuICAgIGNvbnN0IHJjVXBsb2FkUHJvcHMgPSB7XG4gICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgb25TdGFydDogdGhpcy5vblN0YXJ0LFxuICAgICAgb25FcnJvcjogdGhpcy5vbkVycm9yLFxuICAgICAgb25Qcm9ncmVzczogdGhpcy5vblByb2dyZXNzLFxuICAgICAgb25TdWNjZXNzOiB0aGlzLm9uU3VjY2VzcyxcbiAgICAgIGJlZm9yZVVwbG9hZDogdGhpcy5iZWZvcmVVcGxvYWQsXG4gICAgICBwcmVmaXhDbHMsXG4gICAgfTtcblxuICAgIGRlbGV0ZSByY1VwbG9hZFByb3BzLmNsYXNzTmFtZTtcblxuICAgIGNvbnN0IHVwbG9hZExpc3QgPSBzaG93VXBsb2FkTGlzdCA/IChcbiAgICAgIDxMb2NhbGVSZWNlaXZlciBjb21wb25lbnROYW1lPVwiVXBsb2FkXCIgZGVmYXVsdExvY2FsZT17ZGVmYXVsdExvY2FsZS5VcGxvYWR9PlxuICAgICAgICB7dGhpcy5yZW5kZXJVcGxvYWRMaXN0fVxuICAgICAgPC9Mb2NhbGVSZWNlaXZlcj5cbiAgICApIDogbnVsbDtcblxuICAgIGlmICh0eXBlID09PSAnZHJhZycpIHtcbiAgICAgIGNvbnN0IGRyYWdDbHMgPSBjbGFzc05hbWVzKHByZWZpeENscywge1xuICAgICAgICBbYCR7cHJlZml4Q2xzfS1kcmFnYF06IHRydWUsXG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWctdXBsb2FkaW5nYF06IGZpbGVMaXN0LnNvbWUoZmlsZSA9PiBmaWxlLnN0YXR1cyA9PT0gJ3VwbG9hZGluZycpLFxuICAgICAgICBbYCR7cHJlZml4Q2xzfS1kcmFnLWhvdmVyYF06IGRyYWdTdGF0ZSA9PT0gJ2RyYWdvdmVyJyxcbiAgICAgICAgW2Ake3ByZWZpeENsc30tZGlzYWJsZWRgXTogZGlzYWJsZWQsXG4gICAgICB9KTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NOYW1lfT5cbiAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICBjbGFzc05hbWU9e2RyYWdDbHN9XG4gICAgICAgICAgICBvbkRyb3A9e3RoaXMub25GaWxlRHJvcH1cbiAgICAgICAgICAgIG9uRHJhZ092ZXI9e3RoaXMub25GaWxlRHJvcH1cbiAgICAgICAgICAgIG9uRHJhZ0xlYXZlPXt0aGlzLm9uRmlsZURyb3B9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPFJjVXBsb2FkIHsuLi5yY1VwbG9hZFByb3BzfSByZWY9e3RoaXMuc2F2ZVVwbG9hZH0gY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWJ0bmB9PlxuICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1kcmFnLWNvbnRhaW5lcmB9PntjaGlsZHJlbn08L2Rpdj5cbiAgICAgICAgICAgIDwvUmNVcGxvYWQ+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICAgIDwvc3Bhbj5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBsb2FkQnV0dG9uQ2xzID0gY2xhc3NOYW1lcyhwcmVmaXhDbHMsIHtcbiAgICAgIFtgJHtwcmVmaXhDbHN9LXNlbGVjdGBdOiB0cnVlLFxuICAgICAgW2Ake3ByZWZpeENsc30tc2VsZWN0LSR7bGlzdFR5cGV9YF06IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1kaXNhYmxlZGBdOiBkaXNhYmxlZCxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWctYnRuYF06IGRyYWdVcGxvYWRMaXN0LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdXBsb2FkQnV0dG9uID0gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e3VwbG9hZEJ1dHRvbkNsc30gc3R5bGU9e3sgZGlzcGxheTogY2hpbGRyZW4gPyAnJyA6ICdub25lJyB9fT5cbiAgICAgICAgPFJjVXBsb2FkIHsuLi5yY1VwbG9hZFByb3BzfSByZWY9e3RoaXMuc2F2ZVVwbG9hZH0gLz5cbiAgICAgIDwvZGl2PlxuICAgICk7XG5cbiAgICBpZiAobGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2NsYXNzTmFtZX0+XG4gICAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NOYW1lfT5cbiAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICA8L3NwYW4+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9