import * as React from 'react';
import classNames from 'classnames';
import omit from 'lodash/omit';
import debounce from 'lodash/debounce';
import Icon from '../icon';
import { conductExpandParent } from '../rc-components/tree/util';
import { convertDataToEntities, convertTreeToData } from '../rc-components/tree/utils/treeUtil';
import { getPrefixCls } from '../configure';
import Tree from './index';
import { calcRangeKeys, convertDirectoryKeysToNodes } from './utils/dictUtil';
function getIcon(props) {
    const { isLeaf, expanded, prefixCls } = props;
    const prefixCl = getPrefixCls('tree', prefixCls);
    if (isLeaf) {
        return React.createElement(Icon, { type: "insert_drive_file", className: `${prefixCl}-switcher-line-icon` });
    }
    return expanded ? React.createElement(Icon, { type: "baseline-file_copy", className: `${prefixCl}-switcher-line-icon` }) : React.createElement(Icon, { type: "library_books", className: `${prefixCl}-switcher-line-icon` });
}
function getTreeData({ treeData, children }) {
    return treeData || convertTreeToData(children);
}
class DirectoryTree extends React.Component {
    constructor(props) {
        super(props);
        this.onExpand = (expandedKeys, info) => {
            const { onExpand } = this.props;
            this.setUncontrolledState({ expandedKeys });
            // Call origin function
            if (onExpand) {
                return onExpand(expandedKeys, info);
            }
            return undefined;
        };
        this.onClick = (event, node) => {
            const { onClick, expandAction } = this.props;
            // Expand the tree
            if (expandAction === 'click') {
                this.onDebounceExpand(event, node);
            }
            if (onClick) {
                onClick(event, node);
            }
        };
        this.onDoubleClick = (event, node) => {
            const { onDoubleClick, expandAction } = this.props;
            // Expand the tree
            if (expandAction === 'doubleClick') {
                this.onDebounceExpand(event, node);
            }
            if (onDoubleClick) {
                onDoubleClick(event, node);
            }
        };
        this.onSelect = (keys, event) => {
            const { onSelect, multiple } = this.props;
            const { expandedKeys = [] } = this.state;
            const { node, nativeEvent } = event;
            const { key = '' } = node;
            const treeData = getTreeData(this.props);
            const newState = {};
            // We need wrap this event since some value is not same
            const newEvent = {
                ...event,
                selected: true,
            };
            // Windows / Mac single pick
            const ctrlPick = nativeEvent.ctrlKey || nativeEvent.metaKey;
            const shiftPick = nativeEvent.shiftKey;
            // Generate new selected keys
            let newSelectedKeys;
            if (multiple && ctrlPick) {
                // Control click
                newSelectedKeys = keys;
                this.lastSelectedKey = key;
                this.cachedSelectedKeys = newSelectedKeys;
                newEvent.selectedNodes = convertDirectoryKeysToNodes(treeData, newSelectedKeys);
            }
            else if (multiple && shiftPick) {
                // Shift click
                newSelectedKeys = Array.from(new Set([
                    ...(this.cachedSelectedKeys || []),
                    ...calcRangeKeys(treeData, expandedKeys, key, this.lastSelectedKey),
                ]));
                newEvent.selectedNodes = convertDirectoryKeysToNodes(treeData, newSelectedKeys);
            }
            else {
                // Single click
                newSelectedKeys = [key];
                this.lastSelectedKey = key;
                this.cachedSelectedKeys = newSelectedKeys;
                newEvent.selectedNodes = convertDirectoryKeysToNodes(treeData, newSelectedKeys);
            }
            newState.selectedKeys = newSelectedKeys;
            if (onSelect) {
                onSelect(newSelectedKeys, newEvent);
            }
            this.setUncontrolledState(newState);
        };
        this.setTreeRef = (node) => {
            this.tree = node;
        };
        this.expandFolderNode = (event, node) => {
            const { isLeaf } = node;
            if (isLeaf || event.shiftKey || event.metaKey || event.ctrlKey) {
                return;
            }
            // Get internal rc-tree
            const internalTree = this.tree.tree;
            // Call internal rc-tree expand function
            // https://github.com/C7n-design/C7n-design/issues/12567
            internalTree.onNodeExpand(event, node);
        };
        this.setUncontrolledState = (state) => {
            const newState = omit(state, Object.keys(this.props));
            if (Object.keys(newState).length) {
                this.setState(newState);
            }
        };
        this.renderDirectoryTree = () => {
            const { className, ...props } = this.props;
            const { expandedKeys, selectedKeys } = this.state;
            const prefixCls = this.getPrefixCls();
            const connectClassName = classNames(`${prefixCls}-directory`, className, {
                [`${prefixCls}-directory-rtl`]: true,
            });
            return (React.createElement(Tree, Object.assign({ icon: getIcon, ref: this.setTreeRef, blockNode: true }, props, { prefixCls: prefixCls, className: connectClassName, expandedKeys: expandedKeys, selectedKeys: selectedKeys, onSelect: this.onSelect, onClick: this.onClick, onDoubleClick: this.onDoubleClick, onExpand: this.onExpand })));
        };
        const { defaultExpandAll, defaultExpandParent, expandedKeys, defaultExpandedKeys } = props;
        const { keyEntities } = convertDataToEntities(getTreeData(props));
        // Selected keys
        this.state = {
            selectedKeys: props.selectedKeys || props.defaultSelectedKeys || [],
        };
        // Expanded keys
        if (defaultExpandAll) {
            this.state.expandedKeys = Object.keys(keyEntities);
        }
        else if (defaultExpandParent) {
            this.state.expandedKeys = conductExpandParent(expandedKeys || defaultExpandedKeys || [], keyEntities);
        }
        else {
            this.state.expandedKeys = expandedKeys || defaultExpandedKeys;
        }
        this.onDebounceExpand = debounce(this.expandFolderNode, 200, {
            leading: true,
        });
    }
    static getDerivedStateFromProps(nextProps) {
        const newState = {};
        if ('expandedKeys' in nextProps) {
            newState.expandedKeys = nextProps.expandedKeys;
        }
        if ('selectedKeys' in nextProps) {
            newState.selectedKeys = nextProps.selectedKeys;
        }
        return newState;
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('tree', prefixCls);
    }
    render() {
        return this.renderDirectoryTree();
    }
}
DirectoryTree.defaultProps = {
    showIcon: true,
    expandAction: 'click',
};
export default DirectoryTree;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdHJlZS9EaXJlY3RvcnlUcmVlLnRzeCIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxJQUFJLE1BQU0sYUFBYSxDQUFDO0FBQy9CLE9BQU8sUUFBUSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZDLE9BQU8sSUFBSSxNQUFNLFNBQVMsQ0FBQztBQUMzQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVqRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUNoRyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTVDLE9BQU8sSUFBMEMsTUFBTSxTQUFTLENBQUM7QUFDakUsT0FBTyxFQUFFLGFBQWEsRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBYTlFLFNBQVMsT0FBTyxDQUFDLEtBQTRCO0lBRTNDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEtBQUssQ0FBQztJQUM5QyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELElBQUksTUFBTSxFQUFFO1FBQ1YsT0FBTyxvQkFBQyxJQUFJLElBQUMsSUFBSSxFQUFDLG1CQUFtQixFQUFDLFNBQVMsRUFBRSxHQUFHLFFBQVEscUJBQXFCLEdBQUksQ0FBQztLQUN2RjtJQUNELE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxvQkFBQyxJQUFJLElBQUMsSUFBSSxFQUFDLG9CQUFvQixFQUFDLFNBQVMsRUFBRSxHQUFHLFFBQVEscUJBQXFCLEdBQUksQ0FBQSxDQUFDLENBQUMsb0JBQUMsSUFBSSxJQUFDLElBQUksRUFBQyxlQUFlLEVBQUMsU0FB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LFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO1lBQzNELE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQWpERCxNQUFNLENBQUMsd0JBQXdCLENBQUMsU0FBNkI7UUFDM0QsTUFBTSxRQUFRLEdBQXVCLEVBQUUsQ0FBQztRQUN4QyxJQUFJLGNBQWMsSUFBSSxTQUFTLEVBQUU7WUFDL0IsUUFBUSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDO1NBQ2hEO1FBQ0QsSUFBSSxjQUFjLElBQUksU0FBUyxFQUFFO1lBQy9CLFFBQVEsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQztTQUNoRDtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUF3S0QsWUFBWTtRQUNWLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ2pDLE9BQU8sWUFBWSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBb0NELE1BQU07UUFDSixPQUFPLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQ3BDLENBQUM7O0FBL05NLDBCQUFZLEdBQUc7SUFDcEIsUUFBUSxFQUFFLElBQUk7SUFDZCxZQUFZLEVBQUUsT0FBTztDQUN0QixDQUFDO0FBK05KLGVBQWUsYUFBYSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL3RyZWUvRGlyZWN0b3J5VHJlZS50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgb21pdCBmcm9tICdsb2Rhc2gvb21pdCc7XG5pbXBvcnQgZGVib3VuY2UgZnJvbSAnbG9kYXNoL2RlYm91bmNlJztcbmltcG9ydCBJY29uIGZyb20gJy4uL2ljb24nO1xuaW1wb3J0IHsgY29uZHVjdEV4cGFuZFBhcmVudCB9IGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdHJlZS91dGlsJztcbmltcG9ydCB7IEV2ZW50RGF0YU5vZGUsIERhdGFOb2RlIH0gZnJvbSAnLi4vcmMtY29tcG9uZW50cy90cmVlL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBjb252ZXJ0RGF0YVRvRW50aXRpZXMsIGNvbnZlcnRUcmVlVG9EYXRhIH0gZnJvbSAnLi4vcmMtY29tcG9uZW50cy90cmVlL3V0aWxzL3RyZWVVdGlsJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmltcG9ydCBUcmVlLCB7IFRyZWVQcm9wcywgQzduZFRyZWVOb2RlQXR0cmlidXRlIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBjYWxjUmFuZ2VLZXlzLCBjb252ZXJ0RGlyZWN0b3J5S2V5c1RvTm9kZXMgfSBmcm9tICcuL3V0aWxzL2RpY3RVdGlsJztcblxuZXhwb3J0IHR5cGUgRXhwYW5kQWN0aW9uID0gZmFsc2UgfCAnY2xpY2snIHwgJ2RvdWJsZUNsaWNrJztcblxuZXhwb3J0IGludGVyZmFjZSBEaXJlY3RvcnlUcmVlUHJvcHMgZXh0ZW5kcyBUcmVlUHJvcHMge1xuICBleHBhbmRBY3Rpb24/OiBFeHBhbmRBY3Rpb247XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGlyZWN0b3J5VHJlZVN0YXRlIHtcbiAgZXhwYW5kZWRLZXlzPzogc3RyaW5nW107XG4gIHNlbGVjdGVkS2V5cz86IHN0cmluZ1tdO1xufVxuXG5mdW5jdGlvbiBnZXRJY29uKHByb3BzOiBDN25kVHJlZU5vZGVBdHRyaWJ1dGUpOiBSZWFjdC5SZWFjdE5vZGUge1xuXG4gIGNvbnN0IHsgaXNMZWFmLCBleHBhbmRlZCwgcHJlZml4Q2xzIH0gPSBwcm9wcztcbiAgY29uc3QgcHJlZml4Q2wgPSBnZXRQcmVmaXhDbHMoJ3RyZWUnLCBwcmVmaXhDbHMpO1xuICBpZiAoaXNMZWFmKSB7XG4gICAgcmV0dXJuIDxJY29uIHR5cGU9XCJpbnNlcnRfZHJpdmVfZmlsZVwiIGNsYXNzTmFtZT17YCR7cHJlZml4Q2x9LXN3aXRjaGVyLWxpbmUtaWNvbmB9IC8+O1xuICB9XG4gIHJldHVybiBleHBhbmRlZCA/IDxJY29uIHR5cGU9XCJiYXNlbGluZS1maWxlX2NvcHlcIiBjbGFzc05hbWU9e2Ake3ByZWZpeENsfS1zd2l0Y2hlci1saW5lLWljb25gfSAvPjogPEljb24gdHlwZT1cImxpYnJhcnlfYm9va3NcIiBjbGFzc05hbWU9e2Ake3ByZWZpeENsfS1zd2l0Y2hlci1saW5lLWljb25gfSAvPjtcbn1cblxuZnVuY3Rpb24gZ2V0VHJlZURhdGEoeyB0cmVlRGF0YSwgY2hpbGRyZW4gfTogRGlyZWN0b3J5VHJlZVByb3BzKSB7XG4gIHJldHVybiB0cmVlRGF0YSB8fCBjb252ZXJ0VHJlZVRvRGF0YShjaGlsZHJlbik7XG59XG5cbmNsYXNzIERpcmVjdG9yeVRyZWUgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8RGlyZWN0b3J5VHJlZVByb3BzLCBEaXJlY3RvcnlUcmVlU3RhdGU+IHtcbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBzaG93SWNvbjogdHJ1ZSxcbiAgICBleHBhbmRBY3Rpb246ICdjbGljaycsXG4gIH07XG5cbiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHM6IERpcmVjdG9yeVRyZWVQcm9wcykge1xuICAgIGNvbnN0IG5ld1N0YXRlOiBEaXJlY3RvcnlUcmVlU3RhdGUgPSB7fTtcbiAgICBpZiAoJ2V4cGFuZGVkS2V5cycgaW4gbmV4dFByb3BzKSB7XG4gICAgICBuZXdTdGF0ZS5leHBhbmRlZEtleXMgPSBuZXh0UHJvcHMuZXhwYW5kZWRLZXlzO1xuICAgIH1cbiAgICBpZiAoJ3NlbGVjdGVkS2V5cycgaW4gbmV4dFByb3BzKSB7XG4gICAgICBuZXdTdGF0ZS5zZWxlY3RlZEtleXMgPSBuZXh0UHJvcHMuc2VsZWN0ZWRLZXlzO1xuICAgIH1cbiAgICByZXR1cm4gbmV3U3RhdGU7XG4gIH1cblxuICBzdGF0ZTogRGlyZWN0b3J5VHJlZVN0YXRlO1xuICBcbiAgdHJlZTogVHJlZTtcblxuXG4gIG9uRGVib3VuY2VFeHBhbmQ6IChldmVudDogUmVhY3QuTW91c2VFdmVudDxIVE1MRWxlbWVudD4sIG5vZGU6IEV2ZW50RGF0YU5vZGUpID0+IHZvaWQ7XG5cbiAgLy8gU2hpZnQgY2xpY2sgdXNhZ2VcbiAgbGFzdFNlbGVjdGVkS2V5Pzogc3RyaW5nO1xuXG4gIGNhY2hlZFNlbGVjdGVkS2V5cz86IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBEaXJlY3RvcnlUcmVlUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICBjb25zdCB7IGRlZmF1bHRFeHBhbmRBbGwsIGRlZmF1bHRFeHBhbmRQYXJlbnQsIGV4cGFuZGVkS2V5cywgZGVmYXVsdEV4cGFuZGVkS2V5cyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBrZXlFbnRpdGllcyB9ID0gY29udmVydERhdGFUb0VudGl0aWVzKGdldFRyZWVEYXRhKHByb3BzKSk7XG5cbiAgICAvLyBTZWxlY3RlZCBrZXlzXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIHNlbGVjdGVkS2V5czogcHJvcHMuc2VsZWN0ZWRLZXlzIHx8IHByb3BzLmRlZmF1bHRTZWxlY3RlZEtleXMgfHwgW10sXG4gICAgfTtcblxuICAgIC8vIEV4cGFuZGVkIGtleXNcbiAgICBpZiAoZGVmYXVsdEV4cGFuZEFsbCkge1xuICAgICAgdGhpcy5zdGF0ZS5leHBhbmRlZEtleXMgPSBPYmplY3Qua2V5cyhrZXlFbnRpdGllcyk7XG4gICAgfSBlbHNlIGlmIChkZWZhdWx0RXhwYW5kUGFyZW50KSB7XG4gICAgICB0aGlzLnN0YXRlLmV4cGFuZGVkS2V5cyA9IGNvbmR1Y3RFeHBhbmRQYXJlbnQoXG4gICAgICAgIGV4cGFuZGVkS2V5cyB8fCBkZWZhdWx0RXhwYW5kZWRLZXlzfHwgW10sXG4gICAgICAgIGtleUVudGl0aWVzLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGF0ZS5leHBhbmRlZEtleXMgPSBleHBhbmRlZEtleXMgfHwgZGVmYXVsdEV4cGFuZGVkS2V5cztcbiAgICB9XG5cbiAgICB0aGlzLm9uRGVib3VuY2VFeHBhbmQgPSBkZWJvdW5jZSh0aGlzLmV4cGFuZEZvbGRlck5vZGUsIDIwMCwge1xuICAgICAgbGVhZGluZzogdHJ1ZSxcbiAgICB9KTtcbiAgfVxuXG4gIG9uRXhwYW5kID0gKFxuICAgIGV4cGFuZGVkS2V5czogc3RyaW5nW10sXG4gICAgaW5mbzoge1xuICAgICAgbm9kZTogRXZlbnREYXRhTm9kZTtcbiAgICAgIGV4cGFuZGVkOiBib29sZWFuO1xuICAgICAgbmF0aXZlRXZlbnQ6IE1vdXNlRXZlbnQ7XG4gICAgfSxcbiAgKSA9PiB7XG4gICAgY29uc3QgeyBvbkV4cGFuZCB9ID0gdGhpcy5wcm9wcztcblxuICAgIHRoaXMuc2V0VW5jb250cm9sbGVkU3RhdGUoeyBleHBhbmRlZEtleXMgfSk7XG5cbiAgICAvLyBDYWxsIG9yaWdpbiBmdW5jdGlvblxuICAgIGlmIChvbkV4cGFuZCkge1xuICAgICAgcmV0dXJuIG9uRXhwYW5kKGV4cGFuZGVkS2V5cywgaW5mbyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICBvbkNsaWNrID0gKGV2ZW50OiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxFbGVtZW50Piwgbm9kZTogRXZlbnREYXRhTm9kZSkgPT4ge1xuICAgIGNvbnN0IHsgb25DbGljaywgZXhwYW5kQWN0aW9uIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gRXhwYW5kIHRoZSB0cmVlXG4gICAgaWYgKGV4cGFuZEFjdGlvbiA9PT0gJ2NsaWNrJykge1xuICAgICAgdGhpcy5vbkRlYm91bmNlRXhwYW5kKGV2ZW50LCBub2RlKTtcbiAgICB9XG5cbiAgICBpZiAob25DbGljaykge1xuICAgICAgb25DbGljayhldmVudCwgbm9kZSk7XG4gICAgfVxuICB9O1xuXG4gIG9uRG91YmxlQ2xpY2sgPSAoZXZlbnQ6IFJlYWN0Lk1vdXNlRXZlbnQ8SFRNTEVsZW1lbnQ+LCBub2RlOiBFdmVudERhdGFOb2RlKSA9PiB7XG4gICAgY29uc3QgeyBvbkRvdWJsZUNsaWNrLCBleHBhbmRBY3Rpb24gfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBFeHBhbmQgdGhlIHRyZWVcbiAgICBpZiAoZXhwYW5kQWN0aW9uID09PSAnZG91YmxlQ2xpY2snKSB7XG4gICAgICB0aGlzLm9uRGVib3VuY2VFeHBhbmQoZXZlbnQsIG5vZGUpO1xuICAgIH1cblxuICAgIGlmIChvbkRvdWJsZUNsaWNrKSB7XG4gICAgICBvbkRvdWJsZUNsaWNrKGV2ZW50LCBub2RlKTtcbiAgICB9XG4gIH07XG5cbiAgb25TZWxlY3QgPSAoXG4gICAga2V5czogc3RyaW5nW10sXG4gICAgZXZlbnQ6IHtcbiAgICAgIGV2ZW50OiAnc2VsZWN0JztcbiAgICAgIHNlbGVjdGVkOiBib29sZWFuO1xuICAgICAgbm9kZTogYW55O1xuICAgICAgc2VsZWN0ZWROb2RlczogRGF0YU5vZGVbXTtcbiAgICAgIG5hdGl2ZUV2ZW50OiBNb3VzZUV2ZW50O1xuICAgIH0sXG4gICkgPT4ge1xuICAgIGNvbnN0IHsgb25TZWxlY3QsIG11bHRpcGxlIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgZXhwYW5kZWRLZXlzID0gW10gfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgeyBub2RlLCBuYXRpdmVFdmVudCB9ID0gZXZlbnQ7XG4gICAgY29uc3QgeyBrZXkgPSAnJyB9ID0gbm9kZTtcblxuICAgIGNvbnN0IHRyZWVEYXRhID0gZ2V0VHJlZURhdGEodGhpcy5wcm9wcyk7XG4gICAgY29uc3QgbmV3U3RhdGU6IERpcmVjdG9yeVRyZWVTdGF0ZSA9IHt9O1xuXG4gICAgLy8gV2UgbmVlZCB3cmFwIHRoaXMgZXZlbnQgc2luY2Ugc29tZSB2YWx1ZSBpcyBub3Qgc2FtZVxuICAgIGNvbnN0IG5ld0V2ZW50OiBhbnkgPSB7XG4gICAgICAuLi5ldmVudCxcbiAgICAgIHNlbGVjdGVkOiB0cnVlLCAvLyBEaXJlY3Rvcnkgc2VsZWN0ZWQgYWx3YXlzIHRydWVcbiAgICB9O1xuXG4gICAgLy8gV2luZG93cyAvIE1hYyBzaW5nbGUgcGlja1xuICAgIGNvbnN0IGN0cmxQaWNrOiBib29sZWFuID0gbmF0aXZlRXZlbnQuY3RybEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5O1xuICAgIGNvbnN0IHNoaWZ0UGljazogYm9vbGVhbiA9IG5hdGl2ZUV2ZW50LnNoaWZ0S2V5O1xuXG4gICAgLy8gR2VuZXJhdGUgbmV3IHNlbGVjdGVkIGtleXNcbiAgICBsZXQgbmV3U2VsZWN0ZWRLZXlzOiBzdHJpbmdbXTtcbiAgICBpZiAobXVsdGlwbGUgJiYgY3RybFBpY2spIHtcbiAgICAgIC8vIENvbnRyb2wgY2xpY2tcbiAgICAgIG5ld1NlbGVjdGVkS2V5cyA9IGtleXM7XG4gICAgICB0aGlzLmxhc3RTZWxlY3RlZEtleSA9IGtleTtcbiAgICAgIHRoaXMuY2FjaGVkU2VsZWN0ZWRLZXlzID0gbmV3U2VsZWN0ZWRLZXlzO1xuICAgICAgbmV3RXZlbnQuc2VsZWN0ZWROb2RlcyA9IGNvbnZlcnREaXJlY3RvcnlLZXlzVG9Ob2Rlcyh0cmVlRGF0YSwgbmV3U2VsZWN0ZWRLZXlzKTtcbiAgICB9IGVsc2UgaWYgKG11bHRpcGxlICYmIHNoaWZ0UGljaykge1xuICAgICAgLy8gU2hpZnQgY2xpY2tcbiAgICAgIG5ld1NlbGVjdGVkS2V5cyA9IEFycmF5LmZyb20oXG4gICAgICAgIG5ldyBTZXQoW1xuICAgICAgICAgIC4uLih0aGlzLmNhY2hlZFNlbGVjdGVkS2V5cyB8fCBbXSksXG4gICAgICAgICAgLi4uY2FsY1JhbmdlS2V5cyh0cmVlRGF0YSwgZXhwYW5kZWRLZXlzLCBrZXksIHRoaXMubGFzdFNlbGVjdGVkS2V5KSxcbiAgICAgICAgXSksXG4gICAgICApO1xuICAgICAgbmV3RXZlbnQuc2VsZWN0ZWROb2RlcyA9IGNvbnZlcnREaXJlY3RvcnlLZXlzVG9Ob2Rlcyh0cmVlRGF0YSwgbmV3U2VsZWN0ZWRLZXlzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gU2luZ2xlIGNsaWNrXG4gICAgICBuZXdTZWxlY3RlZEtleXMgPSBba2V5XTtcbiAgICAgIHRoaXMubGFzdFNlbGVjdGVkS2V5ID0ga2V5O1xuICAgICAgdGhpcy5jYWNoZWRTZWxlY3RlZEtleXMgPSBuZXdTZWxlY3RlZEtleXM7XG4gICAgICBuZXdFdmVudC5zZWxlY3RlZE5vZGVzID0gY29udmVydERpcmVjdG9yeUtleXNUb05vZGVzKHRyZWVEYXRhLCBuZXdTZWxlY3RlZEtleXMpO1xuICAgIH1cbiAgICBuZXdTdGF0ZS5zZWxlY3RlZEtleXMgPSBuZXdTZWxlY3RlZEtleXM7XG5cbiAgICBpZiAob25TZWxlY3QpIHtcbiAgICAgIG9uU2VsZWN0KG5ld1NlbGVjdGVkS2V5cywgbmV3RXZlbnQpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0VW5jb250cm9sbGVkU3RhdGUobmV3U3RhdGUpO1xuICB9O1xuXG4gIHNldFRyZWVSZWYgPSAobm9kZTogVHJlZSkgPT4ge1xuICAgIHRoaXMudHJlZSA9IG5vZGU7XG4gIH07XG5cbiAgZXhwYW5kRm9sZGVyTm9kZSA9IChldmVudDogUmVhY3QuTW91c2VFdmVudDxIVE1MRWxlbWVudD4sIG5vZGU6IGFueSkgPT4ge1xuICAgIGNvbnN0IHsgaXNMZWFmIH0gPSBub2RlO1xuXG4gICAgaWYgKGlzTGVhZiB8fCBldmVudC5zaGlmdEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LmN0cmxLZXkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBHZXQgaW50ZXJuYWwgcmMtdHJlZVxuICAgIGNvbnN0IGludGVybmFsVHJlZSA9IHRoaXMudHJlZS50cmVlO1xuXG4gICAgLy8gQ2FsbCBpbnRlcm5hbCByYy10cmVlIGV4cGFuZCBmdW5jdGlvblxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9DN24tZGVzaWduL0M3bi1kZXNpZ24vaXNzdWVzLzEyNTY3XG4gICAgaW50ZXJuYWxUcmVlLm9uTm9kZUV4cGFuZChldmVudCwgbm9kZSk7XG4gIH07XG5cbiAgZ2V0UHJlZml4Q2xzKCkge1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiBnZXRQcmVmaXhDbHMoJ3RyZWUnLCBwcmVmaXhDbHMpO1xuICB9XG5cbiAgc2V0VW5jb250cm9sbGVkU3RhdGUgPSAoc3RhdGU6IERpcmVjdG9yeVRyZWVTdGF0ZSkgPT4ge1xuICAgIGNvbnN0IG5ld1N0YXRlID0gb21pdChzdGF0ZSwgT2JqZWN0LmtleXModGhpcy5wcm9wcykpO1xuICAgIGlmIChPYmplY3Qua2V5cyhuZXdTdGF0ZSkubGVuZ3RoKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKG5ld1N0YXRlKTtcbiAgICB9XG4gIH07XG5cbiAgcmVuZGVyRGlyZWN0b3J5VHJlZSA9ICgpID0+IHtcbiAgICBjb25zdCB7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBleHBhbmRlZEtleXMsIHNlbGVjdGVkS2V5cyB9ID0gdGhpcy5zdGF0ZTtcblxuICAgIGNvbnN0IHByZWZpeENscyA9IHRoaXMuZ2V0UHJlZml4Q2xzKClcbiAgICBjb25zdCBjb25uZWN0Q2xhc3NOYW1lID0gY2xhc3NOYW1lcyhgJHtwcmVmaXhDbHN9LWRpcmVjdG9yeWAsIGNsYXNzTmFtZSwge1xuICAgICAgW2Ake3ByZWZpeENsc30tZGlyZWN0b3J5LXJ0bGBdOiB0cnVlICxcbiAgICB9KTtcblxuICAgIHJldHVybiAoXG4gICAgICA8VHJlZVxuICAgICAgICBpY29uPXtnZXRJY29ufVxuICAgICAgICByZWY9e3RoaXMuc2V0VHJlZVJlZn1cbiAgICAgICAgYmxvY2tOb2RlXG4gICAgICAgIHsuLi5wcm9wc31cbiAgICAgICAgcHJlZml4Q2xzPXtwcmVmaXhDbHN9XG4gICAgICAgIGNsYXNzTmFtZT17Y29ubmVjdENsYXNzTmFtZX1cbiAgICAgICAgZXhwYW5kZWRLZXlzPXtleHBhbmRlZEtleXN9XG4gICAgICAgIHNlbGVjdGVkS2V5cz17c2VsZWN0ZWRLZXlzfVxuICAgICAgICBvblNlbGVjdD17dGhpcy5vblNlbGVjdH1cbiAgICAgICAgb25DbGljaz17dGhpcy5vbkNsaWNrfVxuICAgICAgICBvbkRvdWJsZUNsaWNrPXt0aGlzLm9uRG91YmxlQ2xpY2t9XG4gICAgICAgIG9uRXhwYW5kPXt0aGlzLm9uRXhwYW5kfVxuICAgICAgLz5cbiAgICApO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5yZW5kZXJEaXJlY3RvcnlUcmVlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRGlyZWN0b3J5VHJlZTtcbiJdLCJ2ZXJzaW9uIjozfQ==