import { __decorate } from "tslib";
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { observer } from 'mobx-react';
import { action, computed } from 'mobx';
import classes from 'component-classes';
import raf from 'raf';
import { Droppable, Draggable, } from 'react-beautiful-dnd';
import { pxToRem } from 'choerodon-ui/lib/_util/UnitConvertor';
import ReactResizeObserver from 'choerodon-ui/lib/_util/resizeObserver';
import { isFunction } from 'lodash';
import TableContext from './TableContext';
import TableRow from './TableRow';
import ExpandedRow from './ExpandedRow';
import autobind from '../_util/autobind';
import { instance } from './Table';
import { findFirstFocusableInvalidElement } from './utils';
let TableTBody = class TableTBody extends Component {
    get leafColumns() {
        const { tableStore } = this.context;
        const { lock } = this.props;
        if (lock === 'right') {
            return tableStore.rightLeafColumns.filter(({ hidden }) => !hidden);
        }
        if (lock) {
            return tableStore.leftLeafColumns.filter(({ hidden }) => !hidden);
        }
        return tableStore.leafColumns.filter(({ hidden }) => !hidden);
    }
    get leafColumnsBody() {
        const { tableStore } = this.context;
        return tableStore.leafColumns.filter(({ hidden }) => !hidden);
    }
    handleResize() {
        if (this.nextFrameActionId !== undefined) {
            raf.cancel(this.nextFrameActionId);
        }
        this.nextFrameActionId = raf(this.syncBodyHeight);
    }
    saveRef(node) {
        this.tableBody = node;
        this.handleResize();
    }
    /**
     * 虚拟滚动计算可视化数据
     */
    processData() {
        const { tableStore: { data, lastScrollTop = 0, height, rowHeight }, } = this.context;
        const startIndex = Math.max(Math.round((lastScrollTop / rowHeight) - 3), 0);
        const endIndex = Math.min(Math.round((lastScrollTop + height) / rowHeight + 2), data.length);
        return data.slice(startIndex, endIndex);
    }
    render() {
        const { prefixCls, lock, indentSize, dragColumnAlign } = this.props;
        const { leafColumns, leafColumnsBody } = this;
        const { tableStore: { data, dragColumnAlign: propsDragColumnAlign, props: { virtual, rowDragRender = {} }, dataSet, height, dragRow }, } = this.context;
        const { droppableProps, renderClone } = rowDragRender;
        const rowData = virtual && height ? this.processData() : data;
        const rows = data.length
            ? this.getRows(rowData, leafColumns, true, lock)
            : this.getEmptyRow(leafColumns, lock);
        const body = (React.createElement(Droppable, Object.assign({ droppableId: "table", key: "table", isDropDisabled: (dragColumnAlign || propsDragColumnAlign) ? !(dragColumnAlign && propsDragColumnAlign) : !dragRow, renderClone: (provided, snapshot, rubric) => {
                const record = dataSet.get(rubric.source.index);
                if (renderClone && isFunction(renderClone)) {
                    return renderClone({
                        provided,
                        snapshot,
                        key: record.id,
                        hidden: false,
                        lock: false,
                        indentSize,
                        prefixCls,
                        columns: leafColumnsBody,
                        record,
                        index: record.id,
                        dragColumnAlign,
                        rubric,
                    });
                }
                return (React.createElement(TableRow, { provided: provided, snapshot: snapshot, key: record.id, hidden: false, lock: false, indentSize: indentSize, prefixCls: prefixCls, columns: leafColumnsBody, record: record, index: record.id, dragColumnAlign: dragColumnAlign }));
            }, getContainerForClone: () => instance().tbody }, droppableProps), (droppableProvided) => (React.createElement("tbody", Object.assign({ ref: (ref) => {
                if (ref) {
                    this.saveRef(ref);
                    droppableProvided.innerRef(ref);
                }
            } }, droppableProvided.droppableProps, { className: `${prefixCls}-tbody` }),
            rows,
            droppableProvided.placeholder))));
        return lock ? (body) : (React.createElement(ReactResizeObserver, { onResize: this.handleResize, resizeProp: "height" }, body));
    }
    componentWillMount() {
        this.processDataSetListener(true);
    }
    componentWillUnmount() {
        this.processDataSetListener(false);
    }
    processDataSetListener(flag) {
        const { tableStore: { dataSet } } = this.context;
        if (dataSet) {
            const handler = flag ? dataSet.addEventListener : dataSet.removeEventListener;
            handler.call(dataSet, 'validate', this.handleDataSetValidate);
        }
    }
    async handleDataSetValidate({ result }) {
        if (!await result) {
            const cell = this.tableBody ? findFirstFocusableInvalidElement(this.tableBody) : null;
            if (cell) {
                cell.focus();
            }
        }
    }
    componentDidUpdate() {
        const { lock, prefixCls } = this.props;
        if (!lock) {
            const { tableStore: { node }, } = this.context;
            if (classes(node.wrapper).has(`${prefixCls}-focused`) &&
                !node.wrapper.contains(document.activeElement)) {
                node.focus();
            }
        }
    }
    getRows(records, columns, expanded, lock) {
        return records.map((record, index) => this.getRow(columns, record, index, expanded, lock));
    }
    getEmptyRow(columns, lock) {
        const { tableStore: { dataSet, emptyText, width }, } = this.context;
        const { prefixCls } = this.props;
        const style = width
            ? {
                marginLeft: pxToRem(width / 2),
            }
            : {
                transform: 'none',
                display: 'inline-block',
            };
        const tdStyle = width ? {} : { textAlign: 'center' };
        return (React.createElement("tr", { className: `${prefixCls}-empty-row` },
            React.createElement("td", { colSpan: columns.length, style: tdStyle },
                React.createElement("div", { style: style }, !lock && dataSet.status === "ready" /* ready */ && emptyText))));
    }
    renderExpandedRows(columns, record, isExpanded, lock) {
        return this.getRows(record.children || [], columns, isExpanded, lock);
    }
    getRow(columns, record, index, expanded, lock) {
        const { prefixCls, indentSize, dragColumnAlign } = this.props;
        const { tableStore: { isTree, dragColumnAlign: propsDragColumnAlign, props: { rowDragRender = {} }, dragRow }, } = this.context;
        const { draggableProps } = rowDragRender;
        const children = isTree && (React.createElement(ExpandedRow, { record: record, columns: columns, lock: lock }, this.renderExpandedRows));
        return (React.createElement(Draggable, { draggableId: record.key.toString(), index: index, isDragDisabled: (dragColumnAlign || propsDragColumnAlign) ? !(dragColumnAlign && propsDragColumnAlign) : !dragRow, key: record.key }, (provided, snapshot) => (React.createElement(TableRow, Object.assign({ provided: provided, snapshot: snapshot, key: record.key, hidden: !expanded, lock: lock, indentSize: indentSize, prefixCls: prefixCls, columns: columns, record: record, index: index, dragColumnAlign: dragColumnAlign }, draggableProps), children))));
    }
    syncBodyHeight() {
        const { tableStore } = this.context;
        if (this.tableBody && !tableStore.hidden) {
            tableStore.bodyHeight = this.tableBody.offsetHeight;
        }
    }
};
TableTBody.displayName = 'TableTBody';
TableTBody.propTypes = {
    lock: PropTypes.oneOfType([
        PropTypes.bool,
        PropTypes.oneOf(["right" /* right */, "left" /* left */]),
    ]),
    dragColumnAlign: PropTypes.oneOf(["right" /* right */, "left" /* left */]),
    prefixCls: PropTypes.string,
    indentSize: PropTypes.number.isRequired,
};
TableTBody.contextType = TableContext;
__decorate([
    computed
], TableTBody.prototype, "leafColumns", null);
__decorate([
    computed
], TableTBody.prototype, "leafColumnsBody", null);
__decorate([
    autobind
], TableTBody.prototype, "handleResize", null);
__decorate([
    autobind
], TableTBody.prototype, "saveRef", null);
__decorate([
    autobind
], TableTBody.prototype, "processData", null);
__decorate([
    autobind
], TableTBody.prototype, "handleDataSetValidate", null);
__decorate([
    autobind
], TableTBody.prototype, "renderExpandedRows", null);
__decorate([
    autobind,
    action
], TableTBody.prototype, "syncBodyHeight", null);
TableTBody = __decorate([
    observer
], TableTBody);
export default TableTBody;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RhYmxlL1RhYmxlVEJvZHkudHN4IiwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBNEIsTUFBTSxPQUFPLENBQUM7QUFDbkUsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxPQUFPLE1BQU0sbUJBQW1CLENBQUM7QUFDeEMsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBQ3RCLE9BQU8sRUFDTCxTQUFTLEVBQ1QsU0FBUyxHQUtWLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQy9ELE9BQU8sbUJBQW1CLE1BQU0sdUNBQXVDLENBQUM7QUFDeEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdwQyxPQUFPLFlBQVksTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLFFBQVEsTUFBTSxZQUFZLENBQUM7QUFHbEMsT0FBTyxXQUFXLE1BQU0sZUFBZSxDQUFDO0FBRXhDLE9BQU8sUUFBUSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbkMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBUzNELElBQXFCLFVBQVUsR0FBL0IsTUFBcUIsVUFBVyxTQUFRLFNBQStCO0lBb0JyRSxJQUFJLFdBQVc7UUFDYixNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUM1QixJQUFJLElB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SUFEOUIsUUFBUTtHQUNZLFVBQVUsQ0FnUzlCO2VBaFNvQixVQUFVIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby90YWJsZS9UYWJsZVRCb2R5LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50LCBDU1NQcm9wZXJ0aWVzLCBSZWFjdE5vZGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHsgb2JzZXJ2ZXIgfSBmcm9tICdtb2J4LXJlYWN0JztcbmltcG9ydCB7IGFjdGlvbiwgY29tcHV0ZWQgfSBmcm9tICdtb2J4JztcbmltcG9ydCBjbGFzc2VzIGZyb20gJ2NvbXBvbmVudC1jbGFzc2VzJztcbmltcG9ydCByYWYgZnJvbSAncmFmJztcbmltcG9ydCB7XG4gIERyb3BwYWJsZSxcbiAgRHJhZ2dhYmxlLFxuICBEcmFnZ2FibGVQcm92aWRlZCxcbiAgRHJhZ2dhYmxlU3RhdGVTbmFwc2hvdCxcbiAgRHJvcHBhYmxlUHJvdmlkZWQsXG4gIERyYWdnYWJsZVJ1YnJpYyxcbn0gZnJvbSAncmVhY3QtYmVhdXRpZnVsLWRuZCc7XG5pbXBvcnQgeyBweFRvUmVtIH0gZnJvbSAnY2hvZXJvZG9uLXVpL2xpYi9fdXRpbC9Vbml0Q29udmVydG9yJztcbmltcG9ydCBSZWFjdFJlc2l6ZU9ic2VydmVyIGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvX3V0aWwvcmVzaXplT2JzZXJ2ZXInO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBDb2x1bW5Qcm9wcyB9IGZyb20gJy4vQ29sdW1uJztcbmltcG9ydCB7IEVsZW1lbnRQcm9wcyB9IGZyb20gJy4uL2NvcmUvVmlld0NvbXBvbmVudCc7XG5pbXBvcnQgVGFibGVDb250ZXh0IGZyb20gJy4vVGFibGVDb250ZXh0JztcbmltcG9ydCBUYWJsZVJvdyBmcm9tICcuL1RhYmxlUm93JztcbmltcG9ydCBSZWNvcmQgZnJvbSAnLi4vZGF0YS1zZXQvUmVjb3JkJztcbmltcG9ydCB7IENvbHVtbkxvY2sgLCBEcmFnQ29sdW1uQWxpZ259IGZyb20gJy4vZW51bSc7XG5pbXBvcnQgRXhwYW5kZWRSb3cgZnJvbSAnLi9FeHBhbmRlZFJvdyc7XG5pbXBvcnQgeyBEYXRhU2V0U3RhdHVzIH0gZnJvbSAnLi4vZGF0YS1zZXQvZW51bSc7XG5pbXBvcnQgYXV0b2JpbmQgZnJvbSAnLi4vX3V0aWwvYXV0b2JpbmQnO1xuaW1wb3J0IHsgaW5zdGFuY2UgfSBmcm9tICcuL1RhYmxlJztcbmltcG9ydCB7IGZpbmRGaXJzdEZvY3VzYWJsZUludmFsaWRFbGVtZW50IH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFibGVUQm9keVByb3BzIGV4dGVuZHMgRWxlbWVudFByb3BzIHtcbiAgbG9jaz86IENvbHVtbkxvY2sgfCBib29sZWFuO1xuICBpbmRlbnRTaXplOiBudW1iZXI7XG4gIGRyYWdDb2x1bW5BbGlnbj86RHJhZ0NvbHVtbkFsaWduO1xufVxuXG5Ab2JzZXJ2ZXJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhYmxlVEJvZHkgZXh0ZW5kcyBDb21wb25lbnQ8VGFibGVUQm9keVByb3BzLCBhbnk+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ1RhYmxlVEJvZHknO1xuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgbG9jazogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICBQcm9wVHlwZXMuYm9vbCxcbiAgICAgIFByb3BUeXBlcy5vbmVPZihbQ29sdW1uTG9jay5yaWdodCwgQ29sdW1uTG9jay5sZWZ0XSksXG4gICAgXSksXG4gICAgZHJhZ0NvbHVtbkFsaWduOiBQcm9wVHlwZXMub25lT2YoW0NvbHVtbkxvY2sucmlnaHQsIENvbHVtbkxvY2subGVmdF0pLFxuICAgIHByZWZpeENsczogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBpbmRlbnRTaXplOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG4gIH07XG5cbiAgc3RhdGljIGNvbnRleHRUeXBlID0gVGFibGVDb250ZXh0O1xuXG4gIHRhYmxlQm9keTogSFRNTEVsZW1lbnQgfCBudWxsO1xuXG4gIG5leHRGcmFtZUFjdGlvbklkPzogbnVtYmVyO1xuXG4gIEBjb21wdXRlZFxuICBnZXQgbGVhZkNvbHVtbnMoKTogQ29sdW1uUHJvcHNbXSB7XG4gICAgY29uc3QgeyB0YWJsZVN0b3JlIH0gPSB0aGlzLmNvbnRleHQ7XG4gICAgY29uc3QgeyBsb2NrIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChsb2NrID09PSAncmlnaHQnKSB7XG4gICAgICByZXR1cm4gdGFibGVTdG9yZS5yaWdodExlYWZDb2x1bW5zLmZpbHRlcigoeyBoaWRkZW4gfSkgPT4gIWhpZGRlbik7XG4gICAgfVxuICAgIGlmIChsb2NrKSB7XG4gICAgICByZXR1cm4gdGFibGVTdG9yZS5sZWZ0TGVhZkNvbHVtbnMuZmlsdGVyKCh7IGhpZGRlbiB9KSA9PiAhaGlkZGVuKTtcbiAgICB9XG4gICAgcmV0dXJuIHRhYmxlU3RvcmUubGVhZkNvbHVtbnMuZmlsdGVyKCh7IGhpZGRlbiB9KSA9PiAhaGlkZGVuKTtcbiAgfVxuXG4gIEBjb21wdXRlZFxuICBnZXQgbGVhZkNvbHVtbnNCb2R5KCk6IENvbHVtblByb3BzW10ge1xuICAgIGNvbnN0IHsgdGFibGVTdG9yZSB9ID0gdGhpcy5jb250ZXh0O1xuICAgIHJldHVybiB0YWJsZVN0b3JlLmxlYWZDb2x1bW5zLmZpbHRlcigoeyBoaWRkZW4gfSkgPT4gIWhpZGRlbik7XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgaGFuZGxlUmVzaXplKCkge1xuICAgIGlmICh0aGlzLm5leHRGcmFtZUFjdGlvbklkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJhZi5jYW5jZWwodGhpcy5uZXh0RnJhbWVBY3Rpb25JZCk7XG4gICAgfVxuICAgIHRoaXMubmV4dEZyYW1lQWN0aW9uSWQgPSByYWYodGhpcy5zeW5jQm9keUhlaWdodCk7XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgc2F2ZVJlZihub2RlKSB7XG4gICAgdGhpcy50YWJsZUJvZHkgPSBub2RlO1xuICAgIHRoaXMuaGFuZGxlUmVzaXplKCk7XG4gIH1cblxuICAvKipcbiAgICog6Jma5ouf5rua5Yqo6K6h566X5Y+v6KeG5YyW5pWw5o2uXG4gICAqL1xuICBAYXV0b2JpbmRcbiAgcHJvY2Vzc0RhdGEoKSB7XG4gICAgY29uc3Qge1xuICAgICAgdGFibGVTdG9yZTogeyBkYXRhLCBsYXN0U2Nyb2xsVG9wID0gMCwgaGVpZ2h0LCByb3dIZWlnaHQgfSxcbiAgICB9ID0gdGhpcy5jb250ZXh0O1xuICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBNYXRoLm1heChNYXRoLnJvdW5kKChsYXN0U2Nyb2xsVG9wIC8gcm93SGVpZ2h0KSAtIDMpLCAwKTtcbiAgICBjb25zdCBlbmRJbmRleCA9IE1hdGgubWluKE1hdGgucm91bmQoKGxhc3RTY3JvbGxUb3AgKyBoZWlnaHQpIC8gcm93SGVpZ2h0ICsgMiksIGRhdGEubGVuZ3RoKTtcbiAgICByZXR1cm4gZGF0YS5zbGljZShzdGFydEluZGV4LCBlbmRJbmRleCk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcmVmaXhDbHMsIGxvY2sgLCBpbmRlbnRTaXplLCBkcmFnQ29sdW1uQWxpZ259ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGxlYWZDb2x1bW5zLCBsZWFmQ29sdW1uc0JvZHkgfSA9IHRoaXM7XG4gICAgY29uc3Qge1xuICAgICAgdGFibGVTdG9yZTogeyBkYXRhLCBkcmFnQ29sdW1uQWxpZ246IHByb3BzRHJhZ0NvbHVtbkFsaWduLCBwcm9wczogeyB2aXJ0dWFsLHJvd0RyYWdSZW5kZXI9e319LGRhdGFTZXQsIGhlaWdodCwgZHJhZ1JvdyB9LFxuICAgIH0gPSB0aGlzLmNvbnRleHQ7XG4gICAgY29uc3Qge2Ryb3BwYWJsZVByb3BzLHJlbmRlckNsb25lfSA9IHJvd0RyYWdSZW5kZXJcbiAgICBjb25zdCByb3dEYXRhID0gdmlydHVhbCAmJiBoZWlnaHQgPyB0aGlzLnByb2Nlc3NEYXRhKCkgOiBkYXRhO1xuICAgIGNvbnN0IHJvd3MgPSBkYXRhLmxlbmd0aFxuICAgICAgPyB0aGlzLmdldFJvd3Mocm93RGF0YSwgbGVhZkNvbHVtbnMsIHRydWUsIGxvY2spXG4gICAgICA6IHRoaXMuZ2V0RW1wdHlSb3cobGVhZkNvbHVtbnMsIGxvY2spO1xuICAgIGNvbnN0IGJvZHkgPSAoXG4gICAgICA8RHJvcHBhYmxlXG4gICAgICAgIGRyb3BwYWJsZUlkPVwidGFibGVcIlxuICAgICAgICBrZXk9XCJ0YWJsZVwiXG4gICAgICAgIGlzRHJvcERpc2FibGVkPXsoZHJhZ0NvbHVtbkFsaWduIHx8IHByb3BzRHJhZ0NvbHVtbkFsaWduKSA/ICEoZHJhZ0NvbHVtbkFsaWduICYmIHByb3BzRHJhZ0NvbHVtbkFsaWduKSA6ICFkcmFnUm93fVxuICAgICAgICByZW5kZXJDbG9uZT17KFxuICAgICAgICAgIHByb3ZpZGVkOiBEcmFnZ2FibGVQcm92aWRlZCxcbiAgICAgICAgICBzbmFwc2hvdDogRHJhZ2dhYmxlU3RhdGVTbmFwc2hvdCxcbiAgICAgICAgICBydWJyaWM6IERyYWdnYWJsZVJ1YnJpYyxcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVjb3JkID0gZGF0YVNldC5nZXQocnVicmljLnNvdXJjZS5pbmRleClcbiAgICAgICAgICBpZihyZW5kZXJDbG9uZSAmJiBpc0Z1bmN0aW9uKHJlbmRlckNsb25lKSl7XG4gICAgICAgICAgICByZXR1cm4gcmVuZGVyQ2xvbmUoe1xuICAgICAgICAgICAgICBwcm92aWRlZCxcbiAgICAgICAgICAgICAgc25hcHNob3QsXG4gICAgICAgICAgICAgIGtleTpyZWNvcmQuaWQsXG4gICAgICAgICAgICAgIGhpZGRlbjpmYWxzZSxcbiAgICAgICAgICAgICAgbG9jazpmYWxzZSxcbiAgICAgICAgICAgICAgaW5kZW50U2l6ZSxcbiAgICAgICAgICAgICAgcHJlZml4Q2xzLFxuICAgICAgICAgICAgICBjb2x1bW5zOmxlYWZDb2x1bW5zQm9keSxcbiAgICAgICAgICAgICAgcmVjb3JkLFxuICAgICAgICAgICAgICBpbmRleDpyZWNvcmQuaWQsXG4gICAgICAgICAgICAgIGRyYWdDb2x1bW5BbGlnbixcbiAgICAgICAgICAgICAgcnVicmljLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxUYWJsZVJvd1xuICAgICAgICAgICAgICBwcm92aWRlZD17cHJvdmlkZWR9XG4gICAgICAgICAgICAgIHNuYXBzaG90PXtzbmFwc2hvdH1cbiAgICAgICAgICAgICAga2V5PXtyZWNvcmQuaWR9XG4gICAgICAgICAgICAgIGhpZGRlbj17ZmFsc2V9XG4gICAgICAgICAgICAgIGxvY2s9e2ZhbHNlfVxuICAgICAgICAgICAgICBpbmRlbnRTaXplPXtpbmRlbnRTaXplfVxuICAgICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgICAgY29sdW1ucz17bGVhZkNvbHVtbnNCb2R5fVxuICAgICAgICAgICAgICByZWNvcmQ9e3JlY29yZH1cbiAgICAgICAgICAgICAgaW5kZXg9e3JlY29yZC5pZH1cbiAgICAgICAgICAgICAgZHJhZ0NvbHVtbkFsaWduID0ge2RyYWdDb2x1bW5BbGlnbn1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKTtcbiAgICAgICAgfX1cbiAgICAgICAgZ2V0Q29udGFpbmVyRm9yQ2xvbmU9eygpID0+IGluc3RhbmNlKCkudGJvZHl9XG4gICAgICAgIHsuLi5kcm9wcGFibGVQcm9wc31cbiAgICAgID5cbiAgICAgIHsoZHJvcHBhYmxlUHJvdmlkZWQ6IERyb3BwYWJsZVByb3ZpZGVkKSA9PiAoXG4gICAgICAgIDx0Ym9keVxuICAgICAgICAgIHJlZj17KHJlZjogSFRNTFRhYmxlU2VjdGlvbkVsZW1lbnQgfCBudWxsKSA9PiB7XG4gICAgICAgICAgaWYocmVmKXtcbiAgICAgICAgICAgIHRoaXMuc2F2ZVJlZihyZWYpXG4gICAgICAgICAgICBkcm9wcGFibGVQcm92aWRlZC5pbm5lclJlZihyZWYpO1xuICAgICAgICAgIH1cbiAgICAgICAgfX1cbiAgICAgICAgey4uLmRyb3BwYWJsZVByb3ZpZGVkLmRyb3BwYWJsZVByb3BzfVxuICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tdGJvZHlgfT5cbiAgICAgICAge3Jvd3N9XG4gICAgICAgIHtkcm9wcGFibGVQcm92aWRlZC5wbGFjZWhvbGRlcn1cbiAgICAgIDwvdGJvZHk+XG4gICAgICApfVxuICAgICA8L0Ryb3BwYWJsZT5cbiAgICApO1xuICAgIHJldHVybiBsb2NrID8gKFxuICAgICAgYm9keVxuICAgICkgOiAoXG4gICAgICAgIDxSZWFjdFJlc2l6ZU9ic2VydmVyIG9uUmVzaXplPXt0aGlzLmhhbmRsZVJlc2l6ZX0gcmVzaXplUHJvcD1cImhlaWdodFwiPlxuICAgICAgICAgIHtib2R5fVxuICAgICAgICA8L1JlYWN0UmVzaXplT2JzZXJ2ZXI+XG4gICAgICApO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbE1vdW50KCkge1xuICAgIHRoaXMucHJvY2Vzc0RhdGFTZXRMaXN0ZW5lcih0cnVlKTtcbiAgfVxuXG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5wcm9jZXNzRGF0YVNldExpc3RlbmVyKGZhbHNlKTtcbiAgfVxuXG4gIHByb2Nlc3NEYXRhU2V0TGlzdGVuZXIoZmxhZzogYm9vbGVhbikge1xuICAgIGNvbnN0IHsgdGFibGVTdG9yZTogeyBkYXRhU2V0IH0gfSA9IHRoaXMuY29udGV4dDtcbiAgICBpZiAoZGF0YVNldCkge1xuICAgICAgY29uc3QgaGFuZGxlciA9IGZsYWcgPyBkYXRhU2V0LmFkZEV2ZW50TGlzdGVuZXIgOiBkYXRhU2V0LnJlbW92ZUV2ZW50TGlzdGVuZXI7XG4gICAgICBoYW5kbGVyLmNhbGwoZGF0YVNldCwgJ3ZhbGlkYXRlJywgdGhpcy5oYW5kbGVEYXRhU2V0VmFsaWRhdGUpO1xuICAgIH1cbiAgfVxuXG4gIEBhdXRvYmluZFxuICBhc3luYyBoYW5kbGVEYXRhU2V0VmFsaWRhdGUoeyByZXN1bHQgfSkge1xuICAgIGlmICghYXdhaXQgcmVzdWx0KSB7XG4gICAgICBjb25zdCBjZWxsID0gdGhpcy50YWJsZUJvZHkgPyBmaW5kRmlyc3RGb2N1c2FibGVJbnZhbGlkRWxlbWVudCh0aGlzLnRhYmxlQm9keSkgOiBudWxsO1xuICAgICAgaWYgKGNlbGwpIHtcbiAgICAgICAgY2VsbC5mb2N1cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICBjb25zdCB7IGxvY2ssIHByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoIWxvY2spIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgdGFibGVTdG9yZTogeyBub2RlIH0sXG4gICAgICB9ID0gdGhpcy5jb250ZXh0O1xuICAgICAgaWYgKFxuICAgICAgICBjbGFzc2VzKG5vZGUud3JhcHBlcikuaGFzKGAke3ByZWZpeENsc30tZm9jdXNlZGApICYmXG4gICAgICAgICFub2RlLndyYXBwZXIuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudClcbiAgICAgICkge1xuICAgICAgICBub2RlLmZvY3VzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0Um93cyhcbiAgICByZWNvcmRzOiBSZWNvcmRbXSxcbiAgICBjb2x1bW5zOiBDb2x1bW5Qcm9wc1tdLFxuICAgIGV4cGFuZGVkPzogYm9vbGVhbixcbiAgICBsb2NrPzogQ29sdW1uTG9jayB8IGJvb2xlYW4sXG4gICk6IFJlYWN0Tm9kZSB7XG4gICAgcmV0dXJuIHJlY29yZHMubWFwKChyZWNvcmQsIGluZGV4KSA9PiB0aGlzLmdldFJvdyhjb2x1bW5zLCByZWNvcmQsIGluZGV4LCBleHBhbmRlZCwgbG9jaykpO1xuICB9XG5cbiAgZ2V0RW1wdHlSb3coY29sdW1uczogQ29sdW1uUHJvcHNbXSwgbG9jaz86IENvbHVtbkxvY2sgfCBib29sZWFuKTogUmVhY3ROb2RlIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCB7XG4gICAgICB0YWJsZVN0b3JlOiB7IGRhdGFTZXQsIGVtcHR5VGV4dCwgd2lkdGggfSxcbiAgICB9ID0gdGhpcy5jb250ZXh0O1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHN0eWxlOiBDU1NQcm9wZXJ0aWVzID0gd2lkdGhcbiAgICAgID8ge1xuICAgICAgICBtYXJnaW5MZWZ0OiBweFRvUmVtKHdpZHRoIC8gMiksXG4gICAgICB9XG4gICAgICA6IHtcbiAgICAgICAgdHJhbnNmb3JtOiAnbm9uZScsXG4gICAgICAgIGRpc3BsYXk6ICdpbmxpbmUtYmxvY2snLFxuICAgICAgfTtcbiAgICBjb25zdCB0ZFN0eWxlOiBDU1NQcm9wZXJ0aWVzID0gd2lkdGggPyB7fSA6IHsgdGV4dEFsaWduOiAnY2VudGVyJyB9O1xuICAgIHJldHVybiAoXG4gICAgICA8dHIgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWVtcHR5LXJvd2B9PlxuICAgICAgICA8dGQgY29sU3Bhbj17Y29sdW1ucy5sZW5ndGh9IHN0eWxlPXt0ZFN0eWxlfT5cbiAgICAgICAgICA8ZGl2IHN0eWxlPXtzdHlsZX0+eyFsb2NrICYmIGRhdGFTZXQuc3RhdHVzID09PSBEYXRhU2V0U3RhdHVzLnJlYWR5ICYmIGVtcHR5VGV4dH08L2Rpdj5cbiAgICAgICAgPC90ZD5cbiAgICAgIDwvdHI+XG4gICAgKTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICByZW5kZXJFeHBhbmRlZFJvd3MoXG4gICAgY29sdW1uczogQ29sdW1uUHJvcHNbXSxcbiAgICByZWNvcmQ6IFJlY29yZCxcbiAgICBpc0V4cGFuZGVkPzogYm9vbGVhbixcbiAgICBsb2NrPzogQ29sdW1uTG9jayB8IGJvb2xlYW4sXG4gICk6IFJlYWN0Tm9kZSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Um93cyhyZWNvcmQuY2hpbGRyZW4gfHwgW10sIGNvbHVtbnMsIGlzRXhwYW5kZWQsIGxvY2spO1xuICB9XG5cbiAgZ2V0Um93KFxuICAgIGNvbHVtbnM6IENvbHVtblByb3BzW10sXG4gICAgcmVjb3JkOiBSZWNvcmQsXG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBleHBhbmRlZD86IGJvb2xlYW4sXG4gICAgbG9jaz86IENvbHVtbkxvY2sgfCBib29sZWFuLFxuICApOiBSZWFjdE5vZGUge1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzLCBpbmRlbnRTaXplLCBkcmFnQ29sdW1uQWxpZ24gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge1xuICAgICAgdGFibGVTdG9yZTogeyBpc1RyZWUsIGRyYWdDb2x1bW5BbGlnbjpwcm9wc0RyYWdDb2x1bW5BbGlnbiwgcHJvcHM6eyByb3dEcmFnUmVuZGVyID0ge319LGRyYWdSb3cgfSxcbiAgICB9ID0gdGhpcy5jb250ZXh0O1xuICAgIGNvbnN0IHtkcmFnZ2FibGVQcm9wc30gPSByb3dEcmFnUmVuZGVyXG4gICAgY29uc3QgY2hpbGRyZW4gPSBpc1RyZWUgJiYgKFxuICAgICAgPEV4cGFuZGVkUm93IHJlY29yZD17cmVjb3JkfSBjb2x1bW5zPXtjb2x1bW5zfSBsb2NrPXtsb2NrfT5cbiAgICAgICAge3RoaXMucmVuZGVyRXhwYW5kZWRSb3dzfVxuICAgICAgPC9FeHBhbmRlZFJvdz5cbiAgICApO1xuICAgIHJldHVybiAoXG4gICAgICA8RHJhZ2dhYmxlXG4gICAgICAgIGRyYWdnYWJsZUlkPXtyZWNvcmQua2V5LnRvU3RyaW5nKCl9XG4gICAgICAgIGluZGV4PXtpbmRleH1cbiAgICAgICAgaXNEcmFnRGlzYWJsZWQ9eyhkcmFnQ29sdW1uQWxpZ24gfHwgcHJvcHNEcmFnQ29sdW1uQWxpZ24pID8gIShkcmFnQ29sdW1uQWxpZ24gJiYgcHJvcHNEcmFnQ29sdW1uQWxpZ24pIDogIWRyYWdSb3d9XG4gICAgICAgIGtleT17cmVjb3JkLmtleX1cbiAgICAgID5cbiAgICAgICAgeyhcbiAgICAgICAgICBwcm92aWRlZDogRHJhZ2dhYmxlUHJvdmlkZWQsXG4gICAgICAgICAgc25hcHNob3Q6IERyYWdnYWJsZVN0YXRlU25hcHNob3QsXG4gICAgICAgICkgPT4gKFxuICAgICAgICAgICAgPFRhYmxlUm93XG4gICAgICAgICAgICAgIHByb3ZpZGVkPXtwcm92aWRlZH1cbiAgICAgICAgICAgICAgc25hcHNob3Q9e3NuYXBzaG90fVxuICAgICAgICAgICAgICBrZXk9e3JlY29yZC5rZXl9XG4gICAgICAgICAgICAgIGhpZGRlbj17IWV4cGFuZGVkfVxuICAgICAgICAgICAgICBsb2NrPXtsb2NrfVxuICAgICAgICAgICAgICBpbmRlbnRTaXplPXtpbmRlbnRTaXplfVxuICAgICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgICAgY29sdW1ucz17Y29sdW1uc31cbiAgICAgICAgICAgICAgcmVjb3JkPXtyZWNvcmR9XG4gICAgICAgICAgICAgIGluZGV4PXtpbmRleH1cbiAgICAgICAgICAgICAgZHJhZ0NvbHVtbkFsaWduPXtkcmFnQ29sdW1uQWxpZ259XG4gICAgICAgICAgICAgIHsuLi5kcmFnZ2FibGVQcm9wc31cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAge2NoaWxkcmVufVxuICAgICAgICAgICAgPC9UYWJsZVJvdz5cbiAgICAgICAgICApfVxuICAgICAgPC9EcmFnZ2FibGU+XG4gICAgKTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICBAYWN0aW9uXG4gIHN5bmNCb2R5SGVpZ2h0KCkge1xuICAgIGNvbnN0IHsgdGFibGVTdG9yZSB9ID0gdGhpcy5jb250ZXh0O1xuICAgIGlmICh0aGlzLnRhYmxlQm9keSAmJiAhdGFibGVTdG9yZS5oaWRkZW4pIHtcbiAgICAgIHRhYmxlU3RvcmUuYm9keUhlaWdodCA9IHRoaXMudGFibGVCb2R5Lm9mZnNldEhlaWdodDtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==