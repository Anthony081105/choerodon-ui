import React, { Component } from 'react';
import PropTypes from 'prop-types';
import moment from 'moment';
import noop from 'lodash/noop';
import LocaleReceiver from '../locale-provider/LocaleReceiver';
import Header from './Header';
import interopDefault from '../_util/interopDefault';
import enUS from './locale/en_US';
import FullCalendar from '../rc-components/calendar/FullCalendar';
import { getPrefixCls } from '../configure';
function zerofixed(v) {
    if (v < 10) {
        return `0${v}`;
    }
    return `${v}`;
}
export default class Calendar extends Component {
    constructor(props) {
        super(props);
        this.monthCellRender = (value) => {
            const { monthCellRender = noop } = this.props;
            const prefixCls = this.getPrefixCls();
            return (React.createElement("div", { className: `${prefixCls}-month` },
                React.createElement("div", { className: `${prefixCls}-value` }, value.localeData().monthsShort(value)),
                React.createElement("div", { className: `${prefixCls}-content` }, monthCellRender(value))));
        };
        this.dateCellRender = (value) => {
            const { dateCellRender = noop } = this.props;
            const prefixCls = this.getPrefixCls();
            return (React.createElement("div", { className: `${prefixCls}-date` },
                React.createElement("div", { className: `${prefixCls}-value` }, zerofixed(value.date())),
                React.createElement("div", { className: `${prefixCls}-content` }, dateCellRender(value))));
        };
        this.setValue = (value, way) => {
            if (!('value' in this.props)) {
                this.setState({ value });
            }
            if (way === 'select') {
                const { onSelect } = this.props;
                if (onSelect) {
                    onSelect(value);
                }
            }
            else if (way === 'changePanel') {
                const { mode } = this.state;
                this.onPanelChange(value, mode);
            }
        };
        this.setType = (type) => {
            const mode = type === 'date' ? 'month' : 'year';
            const { mode: stateMode, value } = this.state;
            if (stateMode !== mode) {
                this.setState({ mode });
                this.onPanelChange(value, mode);
            }
        };
        this.onHeaderValueChange = (value) => {
            this.setValue(value, 'changePanel');
        };
        this.onHeaderTypeChange = (type) => {
            this.setType(type);
        };
        this.onSelect = (value) => {
            this.setValue(value, 'select');
        };
        this.getDateRange = (validRange, disabledDate) => (current) => {
            if (!current) {
                return false;
            }
            const [startDate, endDate] = validRange;
            const inRange = !current.isBetween(startDate, endDate, 'days', '[]');
            if (disabledDate) {
                return disabledDate(current) || inRange;
            }
            return inRange;
        };
        this.renderCalendar = (locale, localeCode) => {
            const { state, props } = this;
            const { value, mode } = state;
            if (value && localeCode) {
                value.locale(localeCode);
            }
            const { style, className, fullscreen, dateFullCellRender, monthFullCellRender } = props;
            const prefixCls = this.getPrefixCls();
            const type = mode === 'year' ? 'month' : 'date';
            let cls = className || '';
            if (fullscreen) {
                cls += ` ${prefixCls}-fullscreen`;
            }
            const monthCellRender = monthFullCellRender || this.monthCellRender;
            const dateCellRender = dateFullCellRender || this.dateCellRender;
            let disabledDate = props.disabledDate;
            if (props.validRange) {
                disabledDate = this.getDateRange(props.validRange, disabledDate);
            }
            return (React.createElement("div", { className: cls, style: style },
                React.createElement(Header, { fullscreen: fullscreen, type: type, value: value, locale: locale.lang, prefixCls: prefixCls, onTypeChange: this.onHeaderTypeChange, onValueChange: this.onHeaderValueChange, validRange: props.validRange }),
                React.createElement(FullCalendar, Object.assign({}, props, { disabledDate: disabledDate, Select: noop, locale: locale.lang, type: type, prefixCls: prefixCls, showHeader: false, value: value, monthCellRender: monthCellRender, dateCellRender: dateCellRender, onSelect: this.onSelect }))));
        };
        const value = props.value || props.defaultValue || interopDefault(moment)();
        if (!interopDefault(moment).isMoment(value)) {
            throw new Error('The value/defaultValue of Calendar must be a moment object');
        }
        this.state = {
            value,
            mode: props.mode,
        };
    }
    componentWillReceiveProps(nextProps) {
        if ('value' in nextProps) {
            this.setState({
                value: nextProps.value,
            });
        }
        const { mode } = this.props;
        if ('mode' in nextProps && nextProps.mode !== mode) {
            this.setState({
                mode: nextProps.mode,
            });
        }
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('fullcalendar', prefixCls);
    }
    onPanelChange(value, mode) {
        const { onPanelChange } = this.props;
        if (onPanelChange) {
            onPanelChange(value, mode);
        }
    }
    render() {
        return (React.createElement(LocaleReceiver, { componentName: "Calendar", defaultLocale: enUS }, this.renderCalendar));
    }
}
Calendar.displayName = 'Calendar';
Calendar.defaultProps = {
    locale: {},
    fullscreen: true,
    mode: 'month',
    onSelect: noop,
    onPanelChange: noop,
};
Calendar.propTypes = {
    monthCellRender: PropTypes.func,
    dateCellRender: PropTypes.func,
    monthFullCellRender: PropTypes.func,
    dateFullCellRender: PropTypes.func,
    fullscreen: PropTypes.bool,
    locale: PropTypes.object,
    prefixCls: PropTypes.string,
    className: PropTypes.string,
    style: PropTypes.object,
    onPanelChange: PropTypes.func,
    value: PropTypes.object,
    onSelect: PropTypes.func,
    mode: PropTypes.string,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvY2FsZW5kYXIvaW5kZXgudHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUE0QixNQUFNLE9BQU8sQ0FBQztBQUNuRSxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxNQUFrQixNQUFNLFFBQVEsQ0FBQztBQUN4QyxPQUFPLElBQUksTUFBTSxhQUFhLENBQUM7QUFDL0IsT0FBTyxjQUFjLE1BQU0sbUNBQW1DLENBQUM7QUFDL0QsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sY0FBYyxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sSUFBSSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xDLE9BQU8sWUFBWSxNQUFNLHdDQUF3QyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFJNUMsU0FBUyxTQUFTLENBQUMsQ0FBUztJQUMxQixJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDVixPQUFPLElBQUksQ0FBQyxFQUFFLENBQUM7S0FDaEI7SUFDRCxPQUFPLEdBQUcsQ0FBQyxFQUFFLENBQUM7QUFDaEIsQ0FBQztBQTRCRCxNQUFNLENBQUMsT0FBTyxPQUFPLFFBQVMsU0FBUSxTQUF1QztJQTJCM0UsWUFBWSxLQUFvQjtRQUM5QixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUErQmYsb0JBQWUsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxlQUFlLEdBQUcsSUFBZ0IsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDMUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3RDLE9BQU8sQ0FDTCw2QkFBSyxTQUFTLEVBQUUsR0FBRyxTQUFTLFFBQVE7Z0JBQ2xDLDZCQUFLLFNBQVMsRUFBRSxHQUFHLFNBQVMsUUFBUSxJ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QixJQUFJLEVBQUUsT0FBTztJQUNiLFFBQVEsRUFBRSxJQUFJO0lBQ2QsYUFBYSxFQUFFLElBQUk7Q0FDcEIsQ0FBQztBQUVLLGtCQUFTLEdBQUc7SUFDakIsZUFBZSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQy9CLGNBQWMsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUM5QixtQkFBbUIsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUNuQyxrQkFBa0IsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUNsQyxVQUFVLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDMUIsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNO0lBQ3hCLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMzQixTQUFTLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDM0IsS0FBSyxFQUFFLFNBQVMsQ0FBQyxNQUFNO0lBQ3ZCLGFBQWEsRUFBRSxTQUFTLENBQUMsSUFBSTtJQUM3QixLQUFLLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDdkIsUUFBUSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQ3hCLElBQUksRUFBRSxTQUFTLENBQUMsTUFBTTtDQUN2QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL2NhbGVuZGFyL2luZGV4LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50LCBDU1NQcm9wZXJ0aWVzLCBSZWFjdE5vZGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IG1vbWVudCwgeyBNb21lbnQgfSBmcm9tICdtb21lbnQnO1xuaW1wb3J0IG5vb3AgZnJvbSAnbG9kYXNoL25vb3AnO1xuaW1wb3J0IExvY2FsZVJlY2VpdmVyIGZyb20gJy4uL2xvY2FsZS1wcm92aWRlci9Mb2NhbGVSZWNlaXZlcic7XG5pbXBvcnQgSGVhZGVyIGZyb20gJy4vSGVhZGVyJztcbmltcG9ydCBpbnRlcm9wRGVmYXVsdCBmcm9tICcuLi9fdXRpbC9pbnRlcm9wRGVmYXVsdCc7XG5pbXBvcnQgZW5VUyBmcm9tICcuL2xvY2FsZS9lbl9VUyc7XG5pbXBvcnQgRnVsbENhbGVuZGFyIGZyb20gJy4uL3JjLWNvbXBvbmVudHMvY2FsZW5kYXIvRnVsbENhbGVuZGFyJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCB7IEhlYWRlclByb3BzIH0gZnJvbSAnLi9IZWFkZXInO1xuXG5mdW5jdGlvbiB6ZXJvZml4ZWQodjogbnVtYmVyKSB7XG4gIGlmICh2IDwgMTApIHtcbiAgICByZXR1cm4gYDAke3Z9YDtcbiAgfVxuICByZXR1cm4gYCR7dn1gO1xufVxuXG5leHBvcnQgdHlwZSBDYWxlbmRhck1vZGUgPSAnbW9udGgnIHwgJ3llYXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIENhbGVuZGFyUHJvcHMge1xuICBwcmVmaXhDbHM/OiBzdHJpbmc7XG4gIGNsYXNzTmFtZT86IHN0cmluZztcbiAgdmFsdWU/OiBNb21lbnQ7XG4gIGRlZmF1bHRWYWx1ZT86IE1vbWVudDtcbiAgbW9kZT86IENhbGVuZGFyTW9kZTtcbiAgZnVsbHNjcmVlbj86IGJvb2xlYW47XG4gIGRhdGVDZWxsUmVuZGVyPzogKGRhdGU6IE1vbWVudCkgPT4gUmVhY3ROb2RlO1xuICBtb250aENlbGxSZW5kZXI/OiAoZGF0ZTogTW9tZW50KSA9PiBSZWFjdE5vZGU7XG4gIGRhdGVGdWxsQ2VsbFJlbmRlcj86IChkYXRlOiBNb21lbnQpID0+IFJlYWN0Tm9kZTtcbiAgbW9udGhGdWxsQ2VsbFJlbmRlcj86IChkYXRlOiBNb21lbnQpID0+IFJlYWN0Tm9kZTtcbiAgbG9jYWxlPzogYW55O1xuICBzdHlsZT86IENTU1Byb3BlcnRpZXM7XG4gIG9uUGFuZWxDaGFuZ2U/OiAoZGF0ZT86IE1vbWVudCwgbW9kZT86IENhbGVuZGFyTW9kZSkgPT4gdm9pZDtcbiAgb25TZWxlY3Q/OiAoZGF0ZT86IE1vbWVudCkgPT4gdm9pZDtcbiAgZGlzYWJsZWREYXRlPzogKGN1cnJlbnQ6IE1vbWVudCkgPT4gYm9vbGVhbjtcbiAgdmFsaWRSYW5nZT86IFtNb21lbnQsIE1vbWVudF07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FsZW5kYXJTdGF0ZSB7XG4gIHZhbHVlOiBNb21lbnQ7XG4gIG1vZGU/OiBDYWxlbmRhck1vZGU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENhbGVuZGFyIGV4dGVuZHMgQ29tcG9uZW50PENhbGVuZGFyUHJvcHMsIENhbGVuZGFyU3RhdGU+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ0NhbGVuZGFyJztcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGxvY2FsZToge30sXG4gICAgZnVsbHNjcmVlbjogdHJ1ZSxcbiAgICBtb2RlOiAnbW9udGgnLFxuICAgIG9uU2VsZWN0OiBub29wLFxuICAgIG9uUGFuZWxDaGFuZ2U6IG5vb3AsXG4gIH07XG5cbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBtb250aENlbGxSZW5kZXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIGRhdGVDZWxsUmVuZGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBtb250aEZ1bGxDZWxsUmVuZGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBkYXRlRnVsbENlbGxSZW5kZXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIGZ1bGxzY3JlZW46IFByb3BUeXBlcy5ib29sLFxuICAgIGxvY2FsZTogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBwcmVmaXhDbHM6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIHN0eWxlOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIG9uUGFuZWxDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLFxuICAgIHZhbHVlOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIG9uU2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBtb2RlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBDYWxlbmRhclByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgY29uc3QgdmFsdWUgPSBwcm9wcy52YWx1ZSB8fCBwcm9wcy5kZWZhdWx0VmFsdWUgfHwgaW50ZXJvcERlZmF1bHQobW9tZW50KSgpO1xuICAgIGlmICghaW50ZXJvcERlZmF1bHQobW9tZW50KS5pc01vbWVudCh2YWx1ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHZhbHVlL2RlZmF1bHRWYWx1ZSBvZiBDYWxlbmRhciBtdXN0IGJlIGEgbW9tZW50IG9iamVjdCcpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgdmFsdWUsXG4gICAgICBtb2RlOiBwcm9wcy5tb2RlLFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogQ2FsZW5kYXJQcm9wcykge1xuICAgIGlmICgndmFsdWUnIGluIG5leHRQcm9wcykge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIHZhbHVlOiBuZXh0UHJvcHMudmFsdWUhLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHsgbW9kZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoJ21vZGUnIGluIG5leHRQcm9wcyAmJiBuZXh0UHJvcHMubW9kZSAhPT0gbW9kZSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIG1vZGU6IG5leHRQcm9wcy5tb2RlISxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGdldFByZWZpeENscygpIHtcbiAgICBjb25zdCB7IHByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gZ2V0UHJlZml4Q2xzKCdmdWxsY2FsZW5kYXInLCBwcmVmaXhDbHMpO1xuICB9XG5cbiAgbW9udGhDZWxsUmVuZGVyID0gKHZhbHVlOiBNb21lbnQpID0+IHtcbiAgICBjb25zdCB7IG1vbnRoQ2VsbFJlbmRlciA9IG5vb3AgYXMgRnVuY3Rpb24gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbW9udGhgfT5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tdmFsdWVgfT57dmFsdWUubG9jYWxlRGF0YSgpLm1vbnRoc1Nob3J0KHZhbHVlKX08L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tY29udGVudGB9Pnttb250aENlbGxSZW5kZXIodmFsdWUpfTwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfTtcblxuICBkYXRlQ2VsbFJlbmRlciA9ICh2YWx1ZTogTW9tZW50KSA9PiB7XG4gICAgY29uc3QgeyBkYXRlQ2VsbFJlbmRlciA9IG5vb3AgYXMgRnVuY3Rpb24gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZGF0ZWB9PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS12YWx1ZWB9Pnt6ZXJvZml4ZWQodmFsdWUuZGF0ZSgpKX08L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tY29udGVudGB9PntkYXRlQ2VsbFJlbmRlcih2YWx1ZSl9PC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9O1xuXG4gIHNldFZhbHVlID0gKHZhbHVlOiBNb21lbnQsIHdheTogJ3NlbGVjdCcgfCAnY2hhbmdlUGFuZWwnKSA9PiB7XG4gICAgaWYgKCEoJ3ZhbHVlJyBpbiB0aGlzLnByb3BzKSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IHZhbHVlIH0pO1xuICAgIH1cbiAgICBpZiAod2F5ID09PSAnc2VsZWN0Jykge1xuICAgICAgY29uc3QgeyBvblNlbGVjdCB9ID0gdGhpcy5wcm9wcztcbiAgICAgIGlmIChvblNlbGVjdCkge1xuICAgICAgICBvblNlbGVjdCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh3YXkgPT09ICdjaGFuZ2VQYW5lbCcpIHtcbiAgICAgIGNvbnN0IHsgbW9kZSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIHRoaXMub25QYW5lbENoYW5nZSh2YWx1ZSwgbW9kZSk7XG4gICAgfVxuICB9O1xuXG4gIHNldFR5cGUgPSAodHlwZTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgbW9kZSA9IHR5cGUgPT09ICdkYXRlJyA/ICdtb250aCcgOiAneWVhcic7XG4gICAgY29uc3QgeyBtb2RlOiBzdGF0ZU1vZGUsIHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuICAgIGlmIChzdGF0ZU1vZGUgIT09IG1vZGUpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBtb2RlIH0pO1xuICAgICAgdGhpcy5vblBhbmVsQ2hhbmdlKHZhbHVlLCBtb2RlKTtcbiAgICB9XG4gIH07XG5cbiAgb25IZWFkZXJWYWx1ZUNoYW5nZSA9ICh2YWx1ZTogTW9tZW50KSA9PiB7XG4gICAgdGhpcy5zZXRWYWx1ZSh2YWx1ZSwgJ2NoYW5nZVBhbmVsJyk7XG4gIH07XG5cbiAgb25IZWFkZXJUeXBlQ2hhbmdlID0gKHR5cGU6IHN0cmluZykgPT4ge1xuICAgIHRoaXMuc2V0VHlwZSh0eXBlKTtcbiAgfTtcblxuICBvblBhbmVsQ2hhbmdlKHZhbHVlOiBNb21lbnQsIG1vZGU6IENhbGVuZGFyTW9kZSB8IHVuZGVmaW5lZCkge1xuICAgIGNvbnN0IHsgb25QYW5lbENoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25QYW5lbENoYW5nZSkge1xuICAgICAgb25QYW5lbENoYW5nZSh2YWx1ZSwgbW9kZSk7XG4gICAgfVxuICB9XG5cbiAgb25TZWxlY3QgPSAodmFsdWU6IE1vbWVudCkgPT4ge1xuICAgIHRoaXMuc2V0VmFsdWUodmFsdWUsICdzZWxlY3QnKTtcbiAgfTtcblxuICBnZXREYXRlUmFuZ2UgPSAodmFsaWRSYW5nZTogW01vbWVudCwgTW9tZW50XSwgZGlzYWJsZWREYXRlPzogKGN1cnJlbnQ6IE1vbWVudCkgPT4gYm9vbGVhbikgPT4gKFxuICAgIGN1cnJlbnQ6IE1vbWVudCxcbiAgKSA9PiB7XG4gICAgaWYgKCFjdXJyZW50KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IFtzdGFydERhdGUsIGVuZERhdGVdID0gdmFsaWRSYW5nZTtcbiAgICBjb25zdCBpblJhbmdlID0gIWN1cnJlbnQuaXNCZXR3ZWVuKHN0YXJ0RGF0ZSwgZW5kRGF0ZSwgJ2RheXMnLCAnW10nKTtcbiAgICBpZiAoZGlzYWJsZWREYXRlKSB7XG4gICAgICByZXR1cm4gZGlzYWJsZWREYXRlKGN1cnJlbnQpIHx8IGluUmFuZ2U7XG4gICAgfVxuICAgIHJldHVybiBpblJhbmdlO1xuICB9O1xuXG4gIHJlbmRlckNhbGVuZGFyID0gKGxvY2FsZTogYW55LCBsb2NhbGVDb2RlOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCB7IHN0YXRlLCBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZhbHVlLCBtb2RlIH0gPSBzdGF0ZTtcbiAgICBpZiAodmFsdWUgJiYgbG9jYWxlQ29kZSkge1xuICAgICAgdmFsdWUubG9jYWxlKGxvY2FsZUNvZGUpO1xuICAgIH1cbiAgICBjb25zdCB7IHN0eWxlLCBjbGFzc05hbWUsIGZ1bGxzY3JlZW4sIGRhdGVGdWxsQ2VsbFJlbmRlciwgbW9udGhGdWxsQ2VsbFJlbmRlciB9ID0gcHJvcHM7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICBjb25zdCB0eXBlID0gbW9kZSA9PT0gJ3llYXInID8gJ21vbnRoJyA6ICdkYXRlJztcblxuICAgIGxldCBjbHMgPSBjbGFzc05hbWUgfHwgJyc7XG4gICAgaWYgKGZ1bGxzY3JlZW4pIHtcbiAgICAgIGNscyArPSBgICR7cHJlZml4Q2xzfS1mdWxsc2NyZWVuYDtcbiAgICB9XG5cbiAgICBjb25zdCBtb250aENlbGxSZW5kZXIgPSBtb250aEZ1bGxDZWxsUmVuZGVyIHx8IHRoaXMubW9udGhDZWxsUmVuZGVyO1xuICAgIGNvbnN0IGRhdGVDZWxsUmVuZGVyID0gZGF0ZUZ1bGxDZWxsUmVuZGVyIHx8IHRoaXMuZGF0ZUNlbGxSZW5kZXI7XG5cbiAgICBsZXQgZGlzYWJsZWREYXRlID0gcHJvcHMuZGlzYWJsZWREYXRlO1xuXG4gICAgaWYgKHByb3BzLnZhbGlkUmFuZ2UpIHtcbiAgICAgIGRpc2FibGVkRGF0ZSA9IHRoaXMuZ2V0RGF0ZVJhbmdlKHByb3BzLnZhbGlkUmFuZ2UsIGRpc2FibGVkRGF0ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbHN9IHN0eWxlPXtzdHlsZX0+XG4gICAgICAgIDxIZWFkZXJcbiAgICAgICAgICBmdWxsc2NyZWVuPXtmdWxsc2NyZWVufVxuICAgICAgICAgIHR5cGU9e3R5cGV9XG4gICAgICAgICAgdmFsdWU9e3ZhbHVlfVxuICAgICAgICAgIGxvY2FsZT17bG9jYWxlLmxhbmd9XG4gICAgICAgICAgcHJlZml4Q2xzPXtwcmVmaXhDbHN9XG4gICAgICAgICAgb25UeXBlQ2hhbmdlPXt0aGlzLm9uSGVhZGVyVHlwZUNoYW5nZX1cbiAgICAgICAgICBvblZhbHVlQ2hhbmdlPXt0aGlzLm9uSGVhZGVyVmFsdWVDaGFuZ2V9XG4gICAgICAgICAgdmFsaWRSYW5nZT17cHJvcHMudmFsaWRSYW5nZX1cbiAgICAgICAgLz5cbiAgICAgICAgPEZ1bGxDYWxlbmRhclxuICAgICAgICAgIHsuLi5wcm9wc31cbiAgICAgICAgICBkaXNhYmxlZERhdGU9e2Rpc2FibGVkRGF0ZX1cbiAgICAgICAgICBTZWxlY3Q9e25vb3B9XG4gICAgICAgICAgbG9jYWxlPXtsb2NhbGUubGFuZ31cbiAgICAgICAgICB0eXBlPXt0eXBlfVxuICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgIHNob3dIZWFkZXI9e2ZhbHNlfVxuICAgICAgICAgIHZhbHVlPXt2YWx1ZX1cbiAgICAgICAgICBtb250aENlbGxSZW5kZXI9e21vbnRoQ2VsbFJlbmRlcn1cbiAgICAgICAgICBkYXRlQ2VsbFJlbmRlcj17ZGF0ZUNlbGxSZW5kZXJ9XG4gICAgICAgICAgb25TZWxlY3Q9e3RoaXMub25TZWxlY3R9XG4gICAgICAgIC8+XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgPExvY2FsZVJlY2VpdmVyIGNvbXBvbmVudE5hbWU9XCJDYWxlbmRhclwiIGRlZmF1bHRMb2NhbGU9e2VuVVN9PlxuICAgICAgICB7dGhpcy5yZW5kZXJDYWxlbmRhcn1cbiAgICAgIDwvTG9jYWxlUmVjZWl2ZXI+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9