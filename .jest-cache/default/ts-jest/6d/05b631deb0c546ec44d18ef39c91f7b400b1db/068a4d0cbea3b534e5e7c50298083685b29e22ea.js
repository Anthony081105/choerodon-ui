import React, { Component } from 'react';
import classNames from 'classnames';
import omit from 'lodash/omit';
import PropTypes from 'prop-types';
import Icon from '../icon';
import { getPrefixCls } from '../configure';
import { matchMediaPolifill } from '../_util/mediaQueryListPolyfill';
if (typeof window !== 'undefined') {
    // const matchMediaPolyfill = (mediaQuery: string): MediaQueryList => {
    //   return {
    //     media: mediaQuery,
    //     matches: false,
    //     addListener() {
    //     },
    //     removeListener() {
    //     },
    //   };
    // };
    window.matchMedia = window.matchMedia || matchMediaPolifill;
}
const dimensionMap = {
    xs: '480px',
    sm: '576px',
    md: '768px',
    lg: '992px',
    xl: '1200px',
    xxl: '1600px',
};
const generateId = (() => {
    let i = 0;
    return (prefix = '') => {
        i += 1;
        return `${prefix}${i}`;
    };
})();
export default class Sider extends Component {
    constructor(props) {
        super(props);
        this.responsiveHandler = (event) => {
            this.setState({ below: event.matches });
            const { collapsed } = this.state;
            if (collapsed !== event.matches) {
                this.setCollapsed(event.matches, 'responsive');
            }
        };
        this.setCollapsed = (collapsed, type) => {
            if (!('collapsed' in this.props)) {
                this.setState({
                    collapsed,
                });
            }
            const { onCollapse } = this.props;
            if (onCollapse) {
                onCollapse(collapsed, type);
            }
        };
        this.toggle = () => {
            const { collapsed } = this.state;
            this.setCollapsed(!collapsed, 'clickTrigger');
        };
        this.belowShowChange = () => {
            const { belowShow } = this.state;
            this.setState({ belowShow: !belowShow });
        };
        this.uniqueId = generateId(getPrefixCls('sider-'));
        let matchMedia;
        if (typeof window !== 'undefined') {
            matchMedia = window.matchMedia;
        }
        if (matchMedia && props.breakpoint && props.breakpoint in dimensionMap) {
            this.mql = matchMedia(`(max-width: ${dimensionMap[props.breakpoint]})`);
        }
        let collapsed;
        if ('collapsed' in props) {
            collapsed = props.collapsed;
        }
        else {
            collapsed = props.defaultCollapsed;
        }
        this.state = {
            collapsed,
            below: false,
        };
    }
    getChildContext() {
        const { collapsedWidth } = this.props;
        const { collapsed } = this.state;
        return {
            siderCollapsed: collapsed,
            collapsedWidth,
        };
    }
    componentWillReceiveProps(nextProps) {
        if ('collapsed' in nextProps) {
            this.setState({
                collapsed: nextProps.collapsed,
            });
        }
    }
    componentDidMount() {
        if (this.mql) {
            this.mql.addListener(this.responsiveHandler);
            this.responsiveHandler(new MediaQueryListEvent('change', {
                matches: this.mql.matches,
                media: this.mql.media,
            }));
        }
        const { siderHook } = this.context;
        if (siderHook) {
            siderHook.addSider(this.uniqueId);
        }
    }
    componentWillUnmount() {
        if (this.mql) {
            this.mql.removeListener(this.responsiveHandler);
        }
        const { siderHook } = this.context;
        if (siderHook) {
            siderHook.removeSider(this.uniqueId);
        }
    }
    render() {
        const { prefixCls: customizePrefixCls, className, collapsible, reverseArrow, trigger, style, width, collapsedWidth, children, ...others } = this.props;
        const { collapsed, below } = this.state;
        const prefixCls = getPrefixCls('layout-sider', customizePrefixCls);
        const divProps = omit(others, ['collapsed', 'defaultCollapsed', 'onCollapse', 'breakpoint']);
        const siderWidth = collapsed ? collapsedWidth : width;
        // special trigger when collapsedWidth == 0
        const zeroWidthTrigger = collapsedWidth === 0 || collapsedWidth === '0' || collapsedWidth === '0px' ? (React.createElement("span", { onClick: this.toggle, className: `${prefixCls}-zero-width-trigger` },
            React.createElement(Icon, { type: "bars" }))) : null;
        const iconObj = {
            expanded: reverseArrow ? React.createElement(Icon, { type: "right" }) : React.createElement(Icon, { type: "left" }),
            collapsed: reverseArrow ? React.createElement(Icon, { type: "left" }) : React.createElement(Icon, { type: "right" }),
        };
        const status = collapsed ? 'collapsed' : 'expanded';
        const defaultTrigger = iconObj[status];
        const triggerDom = trigger !== null
            ? zeroWidthTrigger || (React.createElement("div", { className: `${prefixCls}-trigger`, onClick: this.toggle, style: { width: siderWidth } }, trigger || defaultTrigger))
            : null;
        const divStyle = {
            ...style,
            flex: `0 0 ${siderWidth}px`,
            maxWidth: `${siderWidth}px`,
            minWidth: `${siderWidth}px`,
            width: `${siderWidth}px`,
        };
        const siderCls = classNames(className, prefixCls, {
            [`${prefixCls}-collapsed`]: !!collapsed,
            [`${prefixCls}-has-trigger`]: collapsible && trigger !== null && !zeroWidthTrigger,
            [`${prefixCls}-below`]: !!below,
            [`${prefixCls}-zero-width`]: siderWidth === 0 || siderWidth === '0' || siderWidth === '0px',
        });
        return (React.createElement("div", Object.assign({ className: siderCls }, divProps, { style: divStyle }),
            React.createElement("div", { className: `${prefixCls}-children` }, children),
            collapsible || (below && zeroWidthTrigger) ? triggerDom : null));
    }
}
Sider.displayName = 'LayoutSider';
Sider.__ANT_LAYOUT_SIDER = true;
Sider.defaultProps = {
    collapsible: false,
    defaultCollapsed: false,
    reverseArrow: false,
    width: 200,
    collapsedWidth: 80,
    style: {},
};
Sider.childContextTypes = {
    siderCollapsed: PropTypes.bool,
    collapsedWidth: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),
};
Sider.contextTypes = {
    siderHook: PropTypes.object,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvbGF5b3V0L1NpZGVyLnRzeCIsIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBNkIsTUFBTSxPQUFPLENBQUM7QUFDcEUsT0FBTyxVQUFVLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBQzNCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFckUsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7SUFDakMsdUVBQXVFO0lBQ3ZFLGFBQWE7SUFDYix5QkFBeUI7SUFDekIsc0JBQXNCO0lBQ3RCLHNCQUFzQjtJQUN0QixTQUFTO0lBQ1QseUJBQXlCO0lBQ3pCLFNBQVM7SUFDVCxPQUFPO0lBQ1AsS0FBSztJQUNMLE1BQU0sQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsSUFBSSxrQkFBa0IsQ0FBQztDQUM3RDtBQUVELE1BQU0sWUFBWSxHQUFHO0lBQ25CLEVBQUUsRUFBRSxPQUFPO0lBQ1gsRUFBRSxFQUFFLE9BQU87SUFDWCxFQUFFLEVBQUUsT0FBTztJQUNYLEVBQUUsRUFBRSxPQUFPO0lBQ1gsRUFBRSxFQUFFLFFBQVE7SUFDWixHQUFHLEVBQUUsUUFBUTtDQUNkLENBQUM7QUEyQkYsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLEVBQUU7SUFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsT0FBTyxDQUFDLFNBQWlCLEVBQUUsRUFBRSxFQUFFO1FBQzdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDUCxPQUFPLEdBQUcsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ3pCLENBQUMs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QUksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQzNELENBQ1AsQ0FBQztJQUNKLENBQUM7O0FBdExNLGlCQUFXLEdBQUcsYUFBYSxDQUFDO0FBRTVCLHdCQUFrQixHQUFRLElBQUksQ0FBQztBQUUvQixrQkFBWSxHQUFHO0lBQ3BCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLGdCQUFnQixFQUFFLEtBQUs7SUFDdkIsWUFBWSxFQUFFLEtBQUs7SUFDbkIsS0FBSyxFQUFFLEdBQUc7SUFDVixjQUFjLEVBQUUsRUFBRTtJQUNsQixLQUFLLEVBQUUsRUFBRTtDQUNWLENBQUM7QUFFSyx1QkFBaUIsR0FBRztJQUN6QixjQUFjLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDOUIsY0FBYyxFQUFFLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztDQUMxRSxDQUFDO0FBRUssa0JBQVksR0FBRztJQUNwQixTQUFTLEVBQUUsU0FBUyxDQUFDLE1BQU07Q0FDNUIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy9sYXlvdXQvU2lkZXIudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIEhUTUxBdHRyaWJ1dGVzLCBSZWFjdE5vZGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBvbWl0IGZyb20gJ2xvZGFzaC9vbWl0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgSWNvbiBmcm9tICcuLi9pY29uJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5pbXBvcnQgeyBtYXRjaE1lZGlhUG9saWZpbGwgfSBmcm9tICcuLi9fdXRpbC9tZWRpYVF1ZXJ5TGlzdFBvbHlmaWxsJztcblxuaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gIC8vIGNvbnN0IG1hdGNoTWVkaWFQb2x5ZmlsbCA9IChtZWRpYVF1ZXJ5OiBzdHJpbmcpOiBNZWRpYVF1ZXJ5TGlzdCA9PiB7XG4gIC8vICAgcmV0dXJuIHtcbiAgLy8gICAgIG1lZGlhOiBtZWRpYVF1ZXJ5LFxuICAvLyAgICAgbWF0Y2hlczogZmFsc2UsXG4gIC8vICAgICBhZGRMaXN0ZW5lcigpIHtcbiAgLy8gICAgIH0sXG4gIC8vICAgICByZW1vdmVMaXN0ZW5lcigpIHtcbiAgLy8gICAgIH0sXG4gIC8vICAgfTtcbiAgLy8gfTtcbiAgd2luZG93Lm1hdGNoTWVkaWEgPSB3aW5kb3cubWF0Y2hNZWRpYSB8fCBtYXRjaE1lZGlhUG9saWZpbGw7XG59XG5cbmNvbnN0IGRpbWVuc2lvbk1hcCA9IHtcbiAgeHM6ICc0ODBweCcsXG4gIHNtOiAnNTc2cHgnLFxuICBtZDogJzc2OHB4JyxcbiAgbGc6ICc5OTJweCcsXG4gIHhsOiAnMTIwMHB4JyxcbiAgeHhsOiAnMTYwMHB4Jyxcbn07XG5cbmV4cG9ydCB0eXBlIENvbGxhcHNlVHlwZSA9ICdjbGlja1RyaWdnZXInIHwgJ3Jlc3BvbnNpdmUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNpZGVyUHJvcHMgZXh0ZW5kcyBIVE1MQXR0cmlidXRlczxIVE1MRGl2RWxlbWVudD4ge1xuICBwcmVmaXhDbHM/OiBzdHJpbmc7XG4gIGNvbGxhcHNpYmxlPzogYm9vbGVhbjtcbiAgY29sbGFwc2VkPzogYm9vbGVhbjtcbiAgZGVmYXVsdENvbGxhcHNlZD86IGJvb2xlYW47XG4gIHJldmVyc2VBcnJvdz86IGJvb2xlYW47XG4gIG9uQ29sbGFwc2U/OiAoY29sbGFwc2VkOiBib29sZWFuLCB0eXBlOiBDb2xsYXBzZVR5cGUpID0+IHZvaWQ7XG4gIHRyaWdnZXI/OiBSZWFjdE5vZGU7XG4gIHdpZHRoPzogbnVtYmVyIHwgc3RyaW5nO1xuICBjb2xsYXBzZWRXaWR0aD86IG51bWJlciB8IHN0cmluZztcbiAgYnJlYWtwb2ludD86ICd4cycgfCAnc20nIHwgJ21kJyB8ICdsZycgfCAneGwnIHwgJ3h4bCc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2lkZXJTdGF0ZSB7XG4gIGNvbGxhcHNlZD86IGJvb2xlYW47XG4gIGJlbG93OiBib29sZWFuO1xuICBiZWxvd1Nob3c/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNpZGVyQ29udGV4dCB7XG4gIHNpZGVyQ29sbGFwc2VkOiBib29sZWFuO1xufVxuXG5jb25zdCBnZW5lcmF0ZUlkID0gKCgpID0+IHtcbiAgbGV0IGkgPSAwO1xuICByZXR1cm4gKHByZWZpeDogc3RyaW5nID0gJycpID0+IHtcbiAgICBpICs9IDE7XG4gICAgcmV0dXJuIGAke3ByZWZpeH0ke2l9YDtcbiAgfTtcbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNpZGVyIGV4dGVuZHMgQ29tcG9uZW50PFNpZGVyUHJvcHMsIFNpZGVyU3RhdGU+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ0xheW91dFNpZGVyJztcblxuICBzdGF0aWMgX19BTlRfTEFZT1VUX1NJREVSOiBhbnkgPSB0cnVlO1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgY29sbGFwc2libGU6IGZhbHNlLFxuICAgIGRlZmF1bHRDb2xsYXBzZWQ6IGZhbHNlLFxuICAgIHJldmVyc2VBcnJvdzogZmFsc2UsXG4gICAgd2lkdGg6IDIwMCxcbiAgICBjb2xsYXBzZWRXaWR0aDogODAsXG4gICAgc3R5bGU6IHt9LFxuICB9O1xuXG4gIHN0YXRpYyBjaGlsZENvbnRleHRUeXBlcyA9IHtcbiAgICBzaWRlckNvbGxhcHNlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgY29sbGFwc2VkV2lkdGg6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5udW1iZXIsIFByb3BUeXBlcy5zdHJpbmddKSxcbiAgfTtcblxuICBzdGF0aWMgY29udGV4dFR5cGVzID0ge1xuICAgIHNpZGVySG9vazogUHJvcFR5cGVzLm9iamVjdCxcbiAgfTtcblxuICBwcml2YXRlIG1xbDogTWVkaWFRdWVyeUxpc3Q7XG5cbiAgcHJpdmF0ZSB1bmlxdWVJZDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBTaWRlclByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMudW5pcXVlSWQgPSBnZW5lcmF0ZUlkKGdldFByZWZpeENscygnc2lkZXItJykpO1xuICAgIGxldCBtYXRjaE1lZGlhO1xuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgbWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhO1xuICAgIH1cbiAgICBpZiAobWF0Y2hNZWRpYSAmJiBwcm9wcy5icmVha3BvaW50ICYmIHByb3BzLmJyZWFrcG9pbnQgaW4gZGltZW5zaW9uTWFwKSB7XG4gICAgICB0aGlzLm1xbCA9IG1hdGNoTWVkaWEoYChtYXgtd2lkdGg6ICR7ZGltZW5zaW9uTWFwW3Byb3BzLmJyZWFrcG9pbnRdfSlgKTtcbiAgICB9XG4gICAgbGV0IGNvbGxhcHNlZDtcbiAgICBpZiAoJ2NvbGxhcHNlZCcgaW4gcHJvcHMpIHtcbiAgICAgIGNvbGxhcHNlZCA9IHByb3BzLmNvbGxhcHNlZDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29sbGFwc2VkID0gcHJvcHMuZGVmYXVsdENvbGxhcHNlZDtcbiAgICB9XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGNvbGxhcHNlZCxcbiAgICAgIGJlbG93OiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgZ2V0Q2hpbGRDb250ZXh0KCkge1xuICAgIGNvbnN0IHsgY29sbGFwc2VkV2lkdGggfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBjb2xsYXBzZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNpZGVyQ29sbGFwc2VkOiBjb2xsYXBzZWQsXG4gICAgICBjb2xsYXBzZWRXaWR0aCxcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IFNpZGVyUHJvcHMpIHtcbiAgICBpZiAoJ2NvbGxhcHNlZCcgaW4gbmV4dFByb3BzKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgY29sbGFwc2VkOiBuZXh0UHJvcHMuY29sbGFwc2VkLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgaWYgKHRoaXMubXFsKSB7XG4gICAgICB0aGlzLm1xbC5hZGRMaXN0ZW5lcih0aGlzLnJlc3BvbnNpdmVIYW5kbGVyKTtcbiAgICAgIHRoaXMucmVzcG9uc2l2ZUhhbmRsZXIoXG4gICAgICAgIG5ldyBNZWRpYVF1ZXJ5TGlzdEV2ZW50KCdjaGFuZ2UnLCB7XG4gICAgICAgICAgbWF0Y2hlczogdGhpcy5tcWwubWF0Y2hlcyxcbiAgICAgICAgICBtZWRpYTogdGhpcy5tcWwubWVkaWEsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgeyBzaWRlckhvb2sgfSA9IHRoaXMuY29udGV4dDtcbiAgICBpZiAoc2lkZXJIb29rKSB7XG4gICAgICBzaWRlckhvb2suYWRkU2lkZXIodGhpcy51bmlxdWVJZCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMubXFsKSB7XG4gICAgICB0aGlzLm1xbC5yZW1vdmVMaXN0ZW5lcih0aGlzLnJlc3BvbnNpdmVIYW5kbGVyKTtcbiAgICB9XG4gICAgY29uc3QgeyBzaWRlckhvb2sgfSA9IHRoaXMuY29udGV4dDtcbiAgICBpZiAoc2lkZXJIb29rKSB7XG4gICAgICBzaWRlckhvb2sucmVtb3ZlU2lkZXIodGhpcy51bmlxdWVJZCk7XG4gICAgfVxuICB9XG5cbiAgcmVzcG9uc2l2ZUhhbmRsZXIgPSAoZXZlbnQ6IE1lZGlhUXVlcnlMaXN0RXZlbnQpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHsgYmVsb3c6IGV2ZW50Lm1hdGNoZXMgfSk7XG4gICAgY29uc3QgeyBjb2xsYXBzZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgaWYgKGNvbGxhcHNlZCAhPT0gZXZlbnQubWF0Y2hlcykge1xuICAgICAgdGhpcy5zZXRDb2xsYXBzZWQoZXZlbnQubWF0Y2hlcywgJ3Jlc3BvbnNpdmUnKTtcbiAgICB9XG4gIH07XG5cbiAgc2V0Q29sbGFwc2VkID0gKGNvbGxhcHNlZDogYm9vbGVhbiwgdHlwZTogQ29sbGFwc2VUeXBlKSA9PiB7XG4gICAgaWYgKCEoJ2NvbGxhcHNlZCcgaW4gdGhpcy5wcm9wcykpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBjb2xsYXBzZWQsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvbkNvbGxhcHNlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvbkNvbGxhcHNlKSB7XG4gICAgICBvbkNvbGxhcHNlKGNvbGxhcHNlZCwgdHlwZSk7XG4gICAgfVxuICB9O1xuXG4gIHRvZ2dsZSA9ICgpID0+IHtcbiAgICBjb25zdCB7IGNvbGxhcHNlZCB9ID0gdGhpcy5zdGF0ZTtcbiAgICB0aGlzLnNldENvbGxhcHNlZCghY29sbGFwc2VkLCAnY2xpY2tUcmlnZ2VyJyk7XG4gIH07XG5cbiAgYmVsb3dTaG93Q2hhbmdlID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgYmVsb3dTaG93IH0gPSB0aGlzLnN0YXRlO1xuICAgIHRoaXMuc2V0U3RhdGUoeyBiZWxvd1Nob3c6ICFiZWxvd1Nob3cgfSk7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHByZWZpeENsczogY3VzdG9taXplUHJlZml4Q2xzLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgY29sbGFwc2libGUsXG4gICAgICByZXZlcnNlQXJyb3csXG4gICAgICB0cmlnZ2VyLFxuICAgICAgc3R5bGUsXG4gICAgICB3aWR0aCxcbiAgICAgIGNvbGxhcHNlZFdpZHRoLFxuICAgICAgY2hpbGRyZW4sXG4gICAgICAuLi5vdGhlcnNcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGNvbGxhcHNlZCwgYmVsb3cgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gZ2V0UHJlZml4Q2xzKCdsYXlvdXQtc2lkZXInLCBjdXN0b21pemVQcmVmaXhDbHMpO1xuICAgIGNvbnN0IGRpdlByb3BzID0gb21pdChvdGhlcnMsIFsnY29sbGFwc2VkJywgJ2RlZmF1bHRDb2xsYXBzZWQnLCAnb25Db2xsYXBzZScsICdicmVha3BvaW50J10pO1xuICAgIGNvbnN0IHNpZGVyV2lkdGggPSBjb2xsYXBzZWQgPyBjb2xsYXBzZWRXaWR0aCA6IHdpZHRoO1xuICAgIC8vIHNwZWNpYWwgdHJpZ2dlciB3aGVuIGNvbGxhcHNlZFdpZHRoID09IDBcbiAgICBjb25zdCB6ZXJvV2lkdGhUcmlnZ2VyID1cbiAgICAgIGNvbGxhcHNlZFdpZHRoID09PSAwIHx8IGNvbGxhcHNlZFdpZHRoID09PSAnMCcgfHwgY29sbGFwc2VkV2lkdGggPT09ICcwcHgnID8gKFxuICAgICAgICA8c3BhbiBvbkNsaWNrPXt0aGlzLnRvZ2dsZX0gY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXplcm8td2lkdGgtdHJpZ2dlcmB9PlxuICAgICAgICAgIDxJY29uIHR5cGU9XCJiYXJzXCIgLz5cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKSA6IG51bGw7XG4gICAgY29uc3QgaWNvbk9iaiA9IHtcbiAgICAgIGV4cGFuZGVkOiByZXZlcnNlQXJyb3cgPyA8SWNvbiB0eXBlPVwicmlnaHRcIiAvPiA6IDxJY29uIHR5cGU9XCJsZWZ0XCIgLz4sXG4gICAgICBjb2xsYXBzZWQ6IHJldmVyc2VBcnJvdyA/IDxJY29uIHR5cGU9XCJsZWZ0XCIgLz4gOiA8SWNvbiB0eXBlPVwicmlnaHRcIiAvPixcbiAgICB9O1xuICAgIGNvbnN0IHN0YXR1cyA9IGNvbGxhcHNlZCA/ICdjb2xsYXBzZWQnIDogJ2V4cGFuZGVkJztcbiAgICBjb25zdCBkZWZhdWx0VHJpZ2dlciA9IGljb25PYmpbc3RhdHVzXTtcbiAgICBjb25zdCB0cmlnZ2VyRG9tID1cbiAgICAgIHRyaWdnZXIgIT09IG51bGxcbiAgICAgICAgPyB6ZXJvV2lkdGhUcmlnZ2VyIHx8IChcbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXRyaWdnZXJgfVxuICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLnRvZ2dsZX1cbiAgICAgICAgICAgICAgc3R5bGU9e3sgd2lkdGg6IHNpZGVyV2lkdGggfX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAge3RyaWdnZXIgfHwgZGVmYXVsdFRyaWdnZXJ9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICApXG4gICAgICAgIDogbnVsbDtcbiAgICBjb25zdCBkaXZTdHlsZSA9IHtcbiAgICAgIC4uLnN0eWxlLFxuICAgICAgZmxleDogYDAgMCAke3NpZGVyV2lkdGh9cHhgLFxuICAgICAgbWF4V2lkdGg6IGAke3NpZGVyV2lkdGh9cHhgLCAvLyBGaXggd2lkdGggdHJhbnNpdGlvbiBidWcgaW4gSUUxMVxuICAgICAgbWluV2lkdGg6IGAke3NpZGVyV2lkdGh9cHhgLFxuICAgICAgd2lkdGg6IGAke3NpZGVyV2lkdGh9cHhgLFxuICAgIH07XG4gICAgY29uc3Qgc2lkZXJDbHMgPSBjbGFzc05hbWVzKGNsYXNzTmFtZSwgcHJlZml4Q2xzLCB7XG4gICAgICBbYCR7cHJlZml4Q2xzfS1jb2xsYXBzZWRgXTogISFjb2xsYXBzZWQsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1oYXMtdHJpZ2dlcmBdOiBjb2xsYXBzaWJsZSAmJiB0cmlnZ2VyICE9PSBudWxsICYmICF6ZXJvV2lkdGhUcmlnZ2VyLFxuICAgICAgW2Ake3ByZWZpeENsc30tYmVsb3dgXTogISFiZWxvdyxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LXplcm8td2lkdGhgXTogc2lkZXJXaWR0aCA9PT0gMCB8fCBzaWRlcldpZHRoID09PSAnMCcgfHwgc2lkZXJXaWR0aCA9PT0gJzBweCcsXG4gICAgfSk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtzaWRlckNsc30gey4uLmRpdlByb3BzfSBzdHlsZT17ZGl2U3R5bGV9PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1jaGlsZHJlbmB9PntjaGlsZHJlbn08L2Rpdj5cbiAgICAgICAge2NvbGxhcHNpYmxlIHx8IChiZWxvdyAmJiB6ZXJvV2lkdGhUcmlnZ2VyKSA/IHRyaWdnZXJEb20gOiBudWxsfVxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9