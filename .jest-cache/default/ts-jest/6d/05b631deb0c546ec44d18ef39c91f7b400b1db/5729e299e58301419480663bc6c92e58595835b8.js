import React, { Component } from 'react';
import classNames from 'classnames';
import Checkbox from '../checkbox';
import Dropdown from '../dropdown';
import Menu from '../menu';
import Icon from '../icon';
export default class SelectionCheckboxAll extends Component {
    constructor(props) {
        super(props);
        this.handleSelectAllChagne = (e) => {
            const { checked } = e.target;
            const { onSelect } = this.props;
            onSelect(checked ? 'all' : 'removeAll', 0, null);
        };
        this.defaultSelections = props.hideDefaultSelections
            ? []
            : [
                {
                    key: 'all',
                    text: props.locale.selectAll,
                    onSelect: () => { },
                },
                {
                    key: 'invert',
                    text: props.locale.selectInvert,
                    onSelect: () => { },
                },
            ];
        this.state = {
            checked: this.getCheckState(props),
            indeterminate: this.getIndeterminateState(props),
        };
    }
    componentDidMount() {
        this.subscribe();
    }
    componentWillReceiveProps(nextProps) {
        this.setCheckState(nextProps);
    }
    componentWillUnmount() {
        if (this.unsubscribe) {
            this.unsubscribe();
        }
    }
    subscribe() {
        const { store } = this.props;
        this.unsubscribe = store.subscribe(() => {
            this.setCheckState(this.props);
        });
    }
    checkSelection(data, type, byDefaultChecked) {
        const { store, getCheckboxPropsByItem, getRecordKey } = this.props;
        // type should be 'every' | 'some'
        if (type === 'every' || type === 'some') {
            return byDefaultChecked
                ? data[type]((item, i) => getCheckboxPropsByItem(item, i).defaultChecked)
                : data[type]((item, i) => store.getState().selectedRowKeys.indexOf(getRecordKey(item, i)) >= 0);
        }
        return false;
    }
    setCheckState(props) {
        const checked = this.getCheckState(props);
        const { state } = this;
        const indeterminate = this.getIndeterminateState(props);
        if (checked !== state.checked) {
            this.setState({ checked });
        }
        if (indeterminate !== state.indeterminate) {
            this.setState({ indeterminate });
        }
    }
    getCheckState(props) {
        const { store, data } = props;
        let checked;
        if (!data.length) {
            checked = false;
        }
        else {
            checked = store.getState().selectionDirty
                ? this.checkSelection(data, 'every', false)
                : this.checkSelection(data, 'every', false) || this.checkSelection(data, 'every', true);
        }
        return checked;
    }
    getIndeterminateState(props) {
        const { store, data } = props;
        let indeterminate;
        if (!data.length) {
            indeterminate = false;
        }
        else {
            indeterminate = store.getState().selectionDirty
                ? this.checkSelection(data, 'some', false) && !this.checkSelection(data, 'every', false)
                : (this.checkSelection(data, 'some', false) &&
                    !this.checkSelection(data, 'every', false)) ||
                    (this.checkSelection(data, 'some', true) && !this.checkSelection(data, 'every', true));
        }
        return indeterminate;
    }
    renderMenus(selections) {
        const { onSelect } = this.props;
        return selections.map((selection, index) => {
            return (React.createElement(Menu.Item, { key: selection.key || index },
                React.createElement("div", { onClick: () => onSelect(selection.key, index, selection.onSelect) }, selection.text)));
        });
    }
    render() {
        const { disabled, prefixCls, selections, getPopupContainer } = this.props;
        const { checked, indeterminate } = this.state;
        const selectionPrefixCls = `${prefixCls}-selection`;
        let customSelections = null;
        if (selections) {
            const newSelections = Array.isArray(selections)
                ? this.defaultSelections.concat(selections)
                : this.defaultSelections;
            const menu = (React.createElement(Menu, { className: `${selectionPrefixCls}-menu`, selectedKeys: [] }, this.renderMenus(newSelections)));
            customSelections =
                newSelections.length > 0 ? (React.createElement(Dropdown, { overlay: menu, getPopupContainer: getPopupContainer },
                    React.createElement("div", { className: `${selectionPrefixCls}-down` },
                        React.createElement(Icon, { type: "expand_more" })))) : null;
        }
        return (React.createElement("div", { className: selectionPrefixCls },
            React.createElement(Checkbox, { className: classNames({ [`${selectionPrefixCls}-select-all-custom`]: customSelections }), checked: checked, indeterminate: indeterminate, disabled: disabled, onChange: this.handleSelectAllChagne }),
            customSelections));
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdGFibGUvU2VsZWN0aW9uQ2hlY2tib3hBbGwudHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFhLE1BQU0sT0FBTyxDQUFDO0FBQ3BELE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLFFBQWlDLE1BQU0sYUFBYSxDQUFDO0FBQzVELE9BQU8sUUFBUSxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLElBQUksTUFBTSxTQUFTLENBQUM7QUFDM0IsT0FBTyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBRzNCLE1BQU0sQ0FBQyxPQUFPLE9BQU8sb0JBQXdCLFNBQVEsU0FHcEQ7SUFLQyxZQUFZLEtBQW1DO1FBQzdDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQWlHZiwwQkFBcUIsR0FBRyxDQUFDLENBQXNCLEVBQUUsRUFBRTtZQUNqRCxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUM3QixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNoQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDO1FBbkdBLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUMscUJBQXFCO1lBQ2xELENBQUMsQ0FBQyxFQUFFO1lBQ0osQ0FBQyxDQUFDO2dCQUNFO29CQUNFLEdBQUcsRUFBRSxLQUFLO29CQUNWLElBQUksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVM7b0JBQzVCLFFBQVEsRUFBRSxHQUFHLEVBQUUsR0FBRSxDQUFDO2lCQUNuQjtnQkFDRDtvQkFDRSxHQUFHLEVBQUUsUUFBUTtvQkFDYixJQUFJLEVBQUUsS0FBSyxDQUFDLE1B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QyxDQUN6QixvQkFBQyxRQUFRLElBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxpQkFBaUI7b0JBQzNELDZCQUFLLFNBQVMsRUFBRSxHQUFHLGtCQUFrQixPQUFPO3dCQUMxQyxvQkFBQyxJQUFJLElBQUMsSUFBSSxFQUFDLGFBQWEsR0FBRyxDQUN2QixDQUNHLENBQ1osQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1NBQ1o7UUFFRCxPQUFPLENBQ0wsNkJBQUssU0FBUyxFQUFFLGtCQUFrQjtZQUNoQyxvQkFBQyxRQUFRLElBQ1AsU0FBUyxFQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxrQkFBa0Isb0JBQW9CLENBQUMsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLEVBQ3hGLE9BQU8sRUFBRSxPQUFPLEVBQ2hCLGFBQWEsRUFBRSxhQUFhLEVBQzVCLFFBQVEsRUFBRSxRQUFRLEVBQ2xCLFFBQVEsRUFBRSxJQUFJLENBQUMscUJBQXFCLEdBQ3BDO1lBQ0QsZ0JBQWdCLENBQ2IsQ0FDUCxDQUFDO0lBQ0osQ0FBQztDQUNGIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL3RhYmxlL1NlbGVjdGlvbkNoZWNrYm94QWxsLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50LCBSZWFjdE5vZGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBDaGVja2JveCwgeyBDaGVja2JveENoYW5nZUV2ZW50IH0gZnJvbSAnLi4vY2hlY2tib3gnO1xuaW1wb3J0IERyb3Bkb3duIGZyb20gJy4uL2Ryb3Bkb3duJztcbmltcG9ydCBNZW51IGZyb20gJy4uL21lbnUnO1xuaW1wb3J0IEljb24gZnJvbSAnLi4vaWNvbic7XG5pbXBvcnQgeyBTZWxlY3Rpb25DaGVja2JveEFsbFByb3BzLCBTZWxlY3Rpb25DaGVja2JveEFsbFN0YXRlLCBTZWxlY3Rpb25JdGVtIH0gZnJvbSAnLi9pbnRlcmZhY2UnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZWxlY3Rpb25DaGVja2JveEFsbDxUPiBleHRlbmRzIENvbXBvbmVudDxcbiAgU2VsZWN0aW9uQ2hlY2tib3hBbGxQcm9wczxUPixcbiAgU2VsZWN0aW9uQ2hlY2tib3hBbGxTdGF0ZVxuPiB7XG4gIHVuc3Vic2NyaWJlOiAoKSA9PiB2b2lkO1xuXG4gIGRlZmF1bHRTZWxlY3Rpb25zOiBTZWxlY3Rpb25JdGVtW107XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFNlbGVjdGlvbkNoZWNrYm94QWxsUHJvcHM8VD4pIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLmRlZmF1bHRTZWxlY3Rpb25zID0gcHJvcHMuaGlkZURlZmF1bHRTZWxlY3Rpb25zXG4gICAgICA/IFtdXG4gICAgICA6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBrZXk6ICdhbGwnLFxuICAgICAgICAgICAgdGV4dDogcHJvcHMubG9jYWxlLnNlbGVjdEFsbCxcbiAgICAgICAgICAgIG9uU2VsZWN0OiAoKSA9PiB7fSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGtleTogJ2ludmVydCcsXG4gICAgICAgICAgICB0ZXh0OiBwcm9wcy5sb2NhbGUuc2VsZWN0SW52ZXJ0LFxuICAgICAgICAgICAgb25TZWxlY3Q6ICgpID0+IHt9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF07XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgY2hlY2tlZDogdGhpcy5nZXRDaGVja1N0YXRlKHByb3BzKSxcbiAgICAgIGluZGV0ZXJtaW5hdGU6IHRoaXMuZ2V0SW5kZXRlcm1pbmF0ZVN0YXRlKHByb3BzKSxcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBTZWxlY3Rpb25DaGVja2JveEFsbFByb3BzPFQ+KSB7XG4gICAgdGhpcy5zZXRDaGVja1N0YXRlKG5leHRQcm9wcyk7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICBpZiAodGhpcy51bnN1YnNjcmliZSkge1xuICAgICAgdGhpcy51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHN1YnNjcmliZSgpIHtcbiAgICBjb25zdCB7IHN0b3JlIH0gPSB0aGlzLnByb3BzO1xuICAgIHRoaXMudW5zdWJzY3JpYmUgPSBzdG9yZS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5zZXRDaGVja1N0YXRlKHRoaXMucHJvcHMpO1xuICAgIH0pO1xuICB9XG5cbiAgY2hlY2tTZWxlY3Rpb24oZGF0YTogVFtdLCB0eXBlOiBzdHJpbmcsIGJ5RGVmYXVsdENoZWNrZWQ6IGJvb2xlYW4pIHtcbiAgICBjb25zdCB7IHN0b3JlLCBnZXRDaGVja2JveFByb3BzQnlJdGVtLCBnZXRSZWNvcmRLZXkgfSA9IHRoaXMucHJvcHM7XG4gICAgLy8gdHlwZSBzaG91bGQgYmUgJ2V2ZXJ5JyB8ICdzb21lJ1xuICAgIGlmICh0eXBlID09PSAnZXZlcnknIHx8IHR5cGUgPT09ICdzb21lJykge1xuICAgICAgcmV0dXJuIGJ5RGVmYXVsdENoZWNrZWRcbiAgICAgICAgPyBkYXRhW3R5cGVdKChpdGVtLCBpKSA9PiBnZXRDaGVja2JveFByb3BzQnlJdGVtKGl0ZW0sIGkpLmRlZmF1bHRDaGVja2VkKVxuICAgICAgICA6IGRhdGFbdHlwZV0oXG4gICAgICAgICAgICAoaXRlbSwgaSkgPT4gc3RvcmUuZ2V0U3RhdGUoKS5zZWxlY3RlZFJvd0tleXMuaW5kZXhPZihnZXRSZWNvcmRLZXkoaXRlbSwgaSkpID49IDAsXG4gICAgICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc2V0Q2hlY2tTdGF0ZShwcm9wczogU2VsZWN0aW9uQ2hlY2tib3hBbGxQcm9wczxUPikge1xuICAgIGNvbnN0IGNoZWNrZWQgPSB0aGlzLmdldENoZWNrU3RhdGUocHJvcHMpO1xuICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXM7XG4gICAgY29uc3QgaW5kZXRlcm1pbmF0ZSA9IHRoaXMuZ2V0SW5kZXRlcm1pbmF0ZVN0YXRlKHByb3BzKTtcbiAgICBpZiAoY2hlY2tlZCAhPT0gc3RhdGUuY2hlY2tlZCkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGNoZWNrZWQgfSk7XG4gICAgfVxuICAgIGlmIChpbmRldGVybWluYXRlICE9PSBzdGF0ZS5pbmRldGVybWluYXRlKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgaW5kZXRlcm1pbmF0ZSB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRDaGVja1N0YXRlKHByb3BzOiBTZWxlY3Rpb25DaGVja2JveEFsbFByb3BzPFQ+KSB7XG4gICAgY29uc3QgeyBzdG9yZSwgZGF0YSB9ID0gcHJvcHM7XG4gICAgbGV0IGNoZWNrZWQ7XG4gICAgaWYgKCFkYXRhLmxlbmd0aCkge1xuICAgICAgY2hlY2tlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjaGVja2VkID0gc3RvcmUuZ2V0U3RhdGUoKS5zZWxlY3Rpb25EaXJ0eVxuICAgICAgICA/IHRoaXMuY2hlY2tTZWxlY3Rpb24oZGF0YSwgJ2V2ZXJ5JywgZmFsc2UpXG4gICAgICAgIDogdGhpcy5jaGVja1NlbGVjdGlvbihkYXRhLCAnZXZlcnknLCBmYWxzZSkgfHwgdGhpcy5jaGVja1NlbGVjdGlvbihkYXRhLCAnZXZlcnknLCB0cnVlKTtcbiAgICB9XG4gICAgcmV0dXJuIGNoZWNrZWQ7XG4gIH1cblxuICBnZXRJbmRldGVybWluYXRlU3RhdGUocHJvcHM6IFNlbGVjdGlvbkNoZWNrYm94QWxsUHJvcHM8VD4pIHtcbiAgICBjb25zdCB7IHN0b3JlLCBkYXRhIH0gPSBwcm9wcztcbiAgICBsZXQgaW5kZXRlcm1pbmF0ZTtcbiAgICBpZiAoIWRhdGEubGVuZ3RoKSB7XG4gICAgICBpbmRldGVybWluYXRlID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluZGV0ZXJtaW5hdGUgPSBzdG9yZS5nZXRTdGF0ZSgpLnNlbGVjdGlvbkRpcnR5XG4gICAgICAgID8gdGhpcy5jaGVja1NlbGVjdGlvbihkYXRhLCAnc29tZScsIGZhbHNlKSAmJiAhdGhpcy5jaGVja1NlbGVjdGlvbihkYXRhLCAnZXZlcnknLCBmYWxzZSlcbiAgICAgICAgOiAodGhpcy5jaGVja1NlbGVjdGlvbihkYXRhLCAnc29tZScsIGZhbHNlKSAmJlxuICAgICAgICAgICAgIXRoaXMuY2hlY2tTZWxlY3Rpb24oZGF0YSwgJ2V2ZXJ5JywgZmFsc2UpKSB8fFxuICAgICAgICAgICh0aGlzLmNoZWNrU2VsZWN0aW9uKGRhdGEsICdzb21lJywgdHJ1ZSkgJiYgIXRoaXMuY2hlY2tTZWxlY3Rpb24oZGF0YSwgJ2V2ZXJ5JywgdHJ1ZSkpO1xuICAgIH1cbiAgICByZXR1cm4gaW5kZXRlcm1pbmF0ZTtcbiAgfVxuXG4gIGhhbmRsZVNlbGVjdEFsbENoYWduZSA9IChlOiBDaGVja2JveENoYW5nZUV2ZW50KSA9PiB7XG4gICAgY29uc3QgeyBjaGVja2VkIH0gPSBlLnRhcmdldDtcbiAgICBjb25zdCB7IG9uU2VsZWN0IH0gPSB0aGlzLnByb3BzO1xuICAgIG9uU2VsZWN0KGNoZWNrZWQgPyAnYWxsJyA6ICdyZW1vdmVBbGwnLCAwLCBudWxsKTtcbiAgfTtcblxuICByZW5kZXJNZW51cyhzZWxlY3Rpb25zOiBTZWxlY3Rpb25JdGVtW10pIHtcbiAgICBjb25zdCB7IG9uU2VsZWN0IH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiBzZWxlY3Rpb25zLm1hcCgoc2VsZWN0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPE1lbnUuSXRlbSBrZXk9e3NlbGVjdGlvbi5rZXkgfHwgaW5kZXh9PlxuICAgICAgICAgIDxkaXYgb25DbGljaz17KCkgPT4gb25TZWxlY3Qoc2VsZWN0aW9uLmtleSwgaW5kZXgsIHNlbGVjdGlvbi5vblNlbGVjdCl9PlxuICAgICAgICAgICAge3NlbGVjdGlvbi50ZXh0fVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L01lbnUuSXRlbT5cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBkaXNhYmxlZCwgcHJlZml4Q2xzLCBzZWxlY3Rpb25zLCBnZXRQb3B1cENvbnRhaW5lciB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGNoZWNrZWQsIGluZGV0ZXJtaW5hdGUgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICBjb25zdCBzZWxlY3Rpb25QcmVmaXhDbHMgPSBgJHtwcmVmaXhDbHN9LXNlbGVjdGlvbmA7XG5cbiAgICBsZXQgY3VzdG9tU2VsZWN0aW9uczogUmVhY3ROb2RlID0gbnVsbDtcblxuICAgIGlmIChzZWxlY3Rpb25zKSB7XG4gICAgICBjb25zdCBuZXdTZWxlY3Rpb25zID0gQXJyYXkuaXNBcnJheShzZWxlY3Rpb25zKVxuICAgICAgICA/IHRoaXMuZGVmYXVsdFNlbGVjdGlvbnMuY29uY2F0KHNlbGVjdGlvbnMpXG4gICAgICAgIDogdGhpcy5kZWZhdWx0U2VsZWN0aW9ucztcblxuICAgICAgY29uc3QgbWVudSA9IChcbiAgICAgICAgPE1lbnUgY2xhc3NOYW1lPXtgJHtzZWxlY3Rpb25QcmVmaXhDbHN9LW1lbnVgfSBzZWxlY3RlZEtleXM9e1tdfT5cbiAgICAgICAgICB7dGhpcy5yZW5kZXJNZW51cyhuZXdTZWxlY3Rpb25zKX1cbiAgICAgICAgPC9NZW51PlxuICAgICAgKTtcblxuICAgICAgY3VzdG9tU2VsZWN0aW9ucyA9XG4gICAgICAgIG5ld1NlbGVjdGlvbnMubGVuZ3RoID4gMCA/IChcbiAgICAgICAgICA8RHJvcGRvd24gb3ZlcmxheT17bWVudX0gZ2V0UG9wdXBDb250YWluZXI9e2dldFBvcHVwQ29udGFpbmVyfT5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtzZWxlY3Rpb25QcmVmaXhDbHN9LWRvd25gfT5cbiAgICAgICAgICAgICAgPEljb24gdHlwZT1cImV4cGFuZF9tb3JlXCIgLz5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvRHJvcGRvd24+XG4gICAgICAgICkgOiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17c2VsZWN0aW9uUHJlZml4Q2xzfT5cbiAgICAgICAgPENoZWNrYm94XG4gICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKHsgW2Ake3NlbGVjdGlvblByZWZpeENsc30tc2VsZWN0LWFsbC1jdXN0b21gXTogY3VzdG9tU2VsZWN0aW9ucyB9KX1cbiAgICAgICAgICBjaGVja2VkPXtjaGVja2VkfVxuICAgICAgICAgIGluZGV0ZXJtaW5hdGU9e2luZGV0ZXJtaW5hdGV9XG4gICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVkfVxuICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmhhbmRsZVNlbGVjdEFsbENoYWduZX1cbiAgICAgICAgLz5cbiAgICAgICAge2N1c3RvbVNlbGVjdGlvbnN9XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=