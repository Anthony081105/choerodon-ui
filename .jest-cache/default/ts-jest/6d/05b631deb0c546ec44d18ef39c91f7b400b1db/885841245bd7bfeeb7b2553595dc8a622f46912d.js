import React, { cloneElement, Component } from 'react';
import { findDOMNode } from 'react-dom';
import closest from 'dom-closest';
import classNames from 'classnames';
import Dropdown from '../dropdown';
import Icon from '../icon';
import Radio from '../radio';
import FilterDropdownMenuWrapper from './FilterDropdownMenuWrapper';
import Menu, { Item as MenuItem, SubMenu } from '../rc-components/menu';
export default class FilterMenu extends Component {
    constructor(props) {
        super(props);
        this.setNeverShown = (column) => {
            const rootNode = findDOMNode(this);
            const { prefixCls } = this.props;
            const filterBelongToScrollBody = !!closest(rootNode, `${prefixCls}-scroll`);
            if (filterBelongToScrollBody) {
                // When fixed column have filters, there will be two dropdown menus
                // Filter dropdown menu inside scroll body should never be shown
                this.neverShown = !!column.fixed;
            }
        };
        this.setSelectedKeys = ({ selectedKeys }) => {
            this.setState({ selectedKeys });
        };
        this.handleClearFilters = () => {
            this.setState({
                selectedKeys: [],
            }, this.handleConfirm);
        };
        this.handleConfirm = () => {
            this.setVisible(false);
            this.confirmFilter();
        };
        this.onVisibleChange = (visible) => {
            this.setVisible(visible);
            if (!visible) {
                this.confirmFilter();
            }
        };
        this.handleFilterDropdownMenuClick = (e) => {
            e.preventDefault();
        };
        this.handleMenuItemClick = (info) => {
            if (info.keyPath.length <= 1) {
                return;
            }
            const { keyPathOfSelectedItem, selectedKeys } = this.state;
            if (selectedKeys.indexOf(info.key) >= 0) {
                // deselect SubMenu child
                delete keyPathOfSelectedItem[info.key];
            }
            else {
                // select SubMenu child
                keyPathOfSelectedItem[info.key] = info.keyPath;
            }
            this.setState({ keyPathOfSelectedItem });
        };
        this.renderFilterIcon = () => {
            const { column, locale, prefixCls, selectedKeys } = this.props;
            const filterIcon = column.filterIcon;
            const dropdownSelectedClass = selectedKeys.length > 0 ? `${prefixCls}-selected` : '';
            return filterIcon ? (cloneElement(filterIcon, {
                title: locale.filterTitle,
                className: classNames(filterIcon.className, {
                    [`${prefixCls}-icon`]: true,
                }),
            })) : (React.createElement(Icon, { title: locale.filterTitle, type: "filter_list", className: dropdownSelectedClass }));
        };
        const visible = 'filterDropdownVisible' in props.column ? props.column.filterDropdownVisible : false;
        this.state = {
            selectedKeys: props.selectedKeys,
            keyPathOfSelectedItem: {},
            visible,
        };
    }
    componentDidMount() {
        const { column } = this.props;
        this.setNeverShown(column);
    }
    componentWillReceiveProps(nextProps) {
        const { column } = nextProps;
        this.setNeverShown(column);
        const newState = {};
        if ('selectedKeys' in nextProps) {
            newState.selectedKeys = nextProps.selectedKeys;
        }
        if ('filterDropdownVisible' in column) {
            newState.visible = column.filterDropdownVisible;
        }
        if (Object.keys(newState).length > 0) {
            this.setState(newState);
        }
    }
    setVisible(visible) {
        const { column } = this.props;
        if (!('filterDropdownVisible' in column)) {
            this.setState({ visible });
        }
        if (column.onFilterDropdownVisibleChange) {
            column.onFilterDropdownVisibleChange(visible);
        }
    }
    confirmFilter() {
        const { selectedKeys: propSelectedKeys, column, confirmFilter } = this.props;
        const { selectedKeys } = this.state;
        if (selectedKeys !== propSelectedKeys) {
            confirmFilter(column, selectedKeys);
        }
    }
    renderMenuItem(item) {
        const { column } = this.props;
        const { selectedKeys } = this.state;
        const multiple = 'filterMultiple' in column ? column.filterMultiple : false;
        const input = multiple ? null : (React.createElement(Radio, { checked: selectedKeys.indexOf(item.value.toString()) >= 0 }));
        return (React.createElement(MenuItem, { key: item.value },
            input,
            React.createElement("span", null, item.text)));
    }
    hasSubMenu() {
        const { column: { filters = [] }, } = this.props;
        return filters.some(item => !!(item.children && item.children.length > 0));
    }
    renderMenus(items) {
        return items.map(item => {
            if (item.children && item.children.length > 0) {
                const { dropdownPrefixCls } = this.props;
                const { keyPathOfSelectedItem } = this.state;
                const containSelected = Object.keys(keyPathOfSelectedItem).some(key => keyPathOfSelectedItem[key].indexOf(item.value) >= 0);
                const subMenuCls = containSelected ? `${dropdownPrefixCls}-submenu-contain-selected` : '';
                return (React.createElement(SubMenu, { title: item.text, className: subMenuCls, key: item.value.toString() }, this.renderMenus(item.children)));
            }
            return this.renderMenuItem(item);
        });
    }
    render() {
        const { column, locale, prefixCls, dropdownPrefixCls, getPopupContainer } = this.props;
        const { visible, selectedKeys } = this.state;
        // default multiple selection in filter dropdown
        const multiple = 'filterMultiple' in column ? column.filterMultiple : false;
        const dropdownMenuClass = classNames({
            [`${dropdownPrefixCls}-menu-without-submenu`]: !this.hasSubMenu(),
        });
        const menus = column.filterDropdown ? (React.createElement(FilterDropdownMenuWrapper, { onClick: this.handleFilterDropdownMenuClick }, column.filterDropdown)) : (React.createElement(FilterDropdownMenuWrapper, { className: `${prefixCls}-dropdown`, onClick: this.handleFilterDropdownMenuClick },
            React.createElement(Menu, { multiple: multiple, onClick: this.handleMenuItemClick, prefixCls: `${dropdownPrefixCls}-menu`, className: dropdownMenuClass, onSelect: this.setSelectedKeys, onDeselect: this.setSelectedKeys, selectedKeys: selectedKeys, getPopupContainer: (triggerNode) => triggerNode.parentNode }, this.renderMenus(column.filters)),
            React.createElement("div", { className: `${prefixCls}-dropdown-btns` },
                React.createElement("a", { className: `${prefixCls}-dropdown-link confirm`, onClick: this.handleConfirm }, locale.filterConfirm),
                React.createElement("a", { className: `${prefixCls}-dropdown-link clear`, onClick: this.handleClearFilters }, locale.filterReset))));
        return (React.createElement(Dropdown, { trigger: ['click'], overlay: menus, visible: this.neverShown ? false : visible, onVisibleChange: this.onVisibleChange, getPopupContainer: getPopupContainer, forceRender: true }, this.renderFilterIcon()));
    }
}
FilterMenu.defaultProps = {
    handleFilter() { },
    column: {},
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdGFibGUvZmlsdGVyRHJvcGRvd24udHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBZ0MsTUFBTSxPQUFPLENBQUM7QUFDckYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4QyxPQUFPLE9BQU8sTUFBTSxhQUFhLENBQUM7QUFDbEMsT0FBTyxVQUFVLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sUUFBUSxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLElBQUksTUFBTSxTQUFTLENBQUM7QUFDM0IsT0FBTyxLQUFLLE1BQU0sVUFBVSxDQUFDO0FBQzdCLE9BQU8seUJBQXlCLE1BQU0sNkJBQTZCLENBQUM7QUFFcEUsT0FBTyxJQUFJLEVBQUUsRUFBRSxJQUFJLElBQUksUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXhFLE1BQU0sQ0FBQyxPQUFPLE9BQU8sVUFBYyxTQUFRLFNBQThDO0lBUXZGLFlBQVksS0FBeUI7UUFDbkMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBbUNmLGtCQUFhLEdBQUcsQ0FBQyxNQUFzQixFQUFFLEVBQUU7WUFDekMsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25DLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2pDLE1BQU0sd0JBQXdCLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsR0FBRyxTQUFTLFNBQVMsQ0FBQyxDQUFDO1lBQzVFLElBQUksd0JBQXdCLEVBQUU7Z0JBQzVCLG1FQUFtRTtnQkFDbkUsZ0VBQWdFO2dCQUVoRSxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2FBQ2xDO1FBQ0gsQ0FBQyxDQUFDO1FB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QUFnQjtnQkFDMUMsMkJBQUcsU0FBUyxFQUFFLEdBQUcsU0FBUyx3QkFBd0IsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsSUFDNUUsTUFBTSxDQUFDLGFBQWEsQ0FDbkI7Z0JBQ0osMkJBQUcsU0FBUyxFQUFFLEdBQUcsU0FBUyxzQkFBc0IsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixJQUMvRSxNQUFNLENBQUMsV0FBVyxDQUNqQixDQUNBLENBQ29CLENBQzdCLENBQUM7UUFFRixPQUFPLENBQ0wsb0JBQUMsUUFBUSxJQUNQLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUNsQixPQUFPLEVBQUUsS0FBSyxFQUNkLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFDMUMsZUFBZSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQ3JDLGlCQUFpQixFQUFFLGlCQUFpQixFQUNwQyxXQUFXLFVBRVYsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQ2YsQ0FDWixDQUFDO0lBQ0osQ0FBQzs7QUFwT00sdUJBQVksR0FBRztJQUNwQixZQUFZLEtBQUksQ0FBQztJQUNqQixNQUFNLEVBQUUsRUFBRTtDQUNYLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdGFibGUvZmlsdGVyRHJvcGRvd24udHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBjbG9uZUVsZW1lbnQsIENvbXBvbmVudCwgUmVhY3RFbGVtZW50LCBTeW50aGV0aWNFdmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IGZpbmRET01Ob2RlIH0gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBjbG9zZXN0IGZyb20gJ2RvbS1jbG9zZXN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IERyb3Bkb3duIGZyb20gJy4uL2Ryb3Bkb3duJztcbmltcG9ydCBJY29uIGZyb20gJy4uL2ljb24nO1xuaW1wb3J0IFJhZGlvIGZyb20gJy4uL3JhZGlvJztcbmltcG9ydCBGaWx0ZXJEcm9wZG93bk1lbnVXcmFwcGVyIGZyb20gJy4vRmlsdGVyRHJvcGRvd25NZW51V3JhcHBlcic7XG5pbXBvcnQgeyBDb2x1bW5GaWx0ZXJJdGVtLCBDb2x1bW5Qcm9wcywgRmlsdGVyTWVudVByb3BzLCBGaWx0ZXJNZW51U3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgTWVudSwgeyBJdGVtIGFzIE1lbnVJdGVtLCBTdWJNZW51IH0gZnJvbSAnLi4vcmMtY29tcG9uZW50cy9tZW51JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRmlsdGVyTWVudTxUPiBleHRlbmRzIENvbXBvbmVudDxGaWx0ZXJNZW51UHJvcHM8VD4sIEZpbHRlck1lbnVTdGF0ZT4ge1xuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGhhbmRsZUZpbHRlcigpIHt9LFxuICAgIGNvbHVtbjoge30sXG4gIH07XG5cbiAgbmV2ZXJTaG93bjogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogRmlsdGVyTWVudVByb3BzPFQ+KSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgY29uc3QgdmlzaWJsZSA9XG4gICAgICAnZmlsdGVyRHJvcGRvd25WaXNpYmxlJyBpbiBwcm9wcy5jb2x1bW4gPyBwcm9wcy5jb2x1bW4uZmlsdGVyRHJvcGRvd25WaXNpYmxlIDogZmFsc2U7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgc2VsZWN0ZWRLZXlzOiBwcm9wcy5zZWxlY3RlZEtleXMsXG4gICAgICBrZXlQYXRoT2ZTZWxlY3RlZEl0ZW06IHt9LCAvLyDorrDlvZXmiYDmnInmnInpgInkuK3lrZDoj5zljZXnmoTnpZblhYjoj5zljZVcbiAgICAgIHZpc2libGUsXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIGNvbnN0IHsgY29sdW1uIH0gPSB0aGlzLnByb3BzO1xuICAgIHRoaXMuc2V0TmV2ZXJTaG93bihjb2x1bW4pO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IEZpbHRlck1lbnVQcm9wczxUPikge1xuICAgIGNvbnN0IHsgY29sdW1uIH0gPSBuZXh0UHJvcHM7XG4gICAgdGhpcy5zZXROZXZlclNob3duKGNvbHVtbik7XG4gICAgY29uc3QgbmV3U3RhdGUgPSB7fSBhcyB7XG4gICAgICBzZWxlY3RlZEtleXM6IHN0cmluZ1tdO1xuICAgICAgdmlzaWJsZTogYm9vbGVhbjtcbiAgICB9O1xuICAgIGlmICgnc2VsZWN0ZWRLZXlzJyBpbiBuZXh0UHJvcHMpIHtcbiAgICAgIG5ld1N0YXRlLnNlbGVjdGVkS2V5cyA9IG5leHRQcm9wcy5zZWxlY3RlZEtleXM7XG4gICAgfVxuICAgIGlmICgnZmlsdGVyRHJvcGRvd25WaXNpYmxlJyBpbiBjb2x1bW4pIHtcbiAgICAgIG5ld1N0YXRlLnZpc2libGUgPSBjb2x1bW4uZmlsdGVyRHJvcGRvd25WaXNpYmxlIGFzIGJvb2xlYW47XG4gICAgfVxuICAgIGlmIChPYmplY3Qua2V5cyhuZXdTdGF0ZSkubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XG4gICAgfVxuICB9XG5cbiAgc2V0TmV2ZXJTaG93biA9IChjb2x1bW46IENvbHVtblByb3BzPFQ+KSA9PiB7XG4gICAgY29uc3Qgcm9vdE5vZGUgPSBmaW5kRE9NTm9kZSh0aGlzKTtcbiAgICBjb25zdCB7IHByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBmaWx0ZXJCZWxvbmdUb1Njcm9sbEJvZHkgPSAhIWNsb3Nlc3Qocm9vdE5vZGUsIGAke3ByZWZpeENsc30tc2Nyb2xsYCk7XG4gICAgaWYgKGZpbHRlckJlbG9uZ1RvU2Nyb2xsQm9keSkge1xuICAgICAgLy8gV2hlbiBmaXhlZCBjb2x1bW4gaGF2ZSBmaWx0ZXJzLCB0aGVyZSB3aWxsIGJlIHR3byBkcm9wZG93biBtZW51c1xuICAgICAgLy8gRmlsdGVyIGRyb3Bkb3duIG1lbnUgaW5zaWRlIHNjcm9sbCBib2R5IHNob3VsZCBuZXZlciBiZSBzaG93blxuXG4gICAgICB0aGlzLm5ldmVyU2hvd24gPSAhIWNvbHVtbi5maXhlZDtcbiAgICB9XG4gIH07XG5cbiAgc2V0U2VsZWN0ZWRLZXlzID0gKHsgc2VsZWN0ZWRLZXlzIH06IHsgc2VsZWN0ZWRLZXlzOiBzdHJpbmdbXSB9KSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IHNlbGVjdGVkS2V5cyB9KTtcbiAgfTtcblxuICBzZXRWaXNpYmxlKHZpc2libGU6IGJvb2xlYW4pIHtcbiAgICBjb25zdCB7IGNvbHVtbiB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoISgnZmlsdGVyRHJvcGRvd25WaXNpYmxlJyBpbiBjb2x1bW4pKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgdmlzaWJsZSB9KTtcbiAgICB9XG4gICAgaWYgKGNvbHVtbi5vbkZpbHRlckRyb3Bkb3duVmlzaWJsZUNoYW5nZSkge1xuICAgICAgY29sdW1uLm9uRmlsdGVyRHJvcGRvd25WaXNpYmxlQ2hhbmdlKHZpc2libGUpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUNsZWFyRmlsdGVycyA9ICgpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKFxuICAgICAge1xuICAgICAgICBzZWxlY3RlZEtleXM6IFtdLFxuICAgICAgfSxcbiAgICAgIHRoaXMuaGFuZGxlQ29uZmlybSxcbiAgICApO1xuICB9O1xuXG4gIGhhbmRsZUNvbmZpcm0gPSAoKSA9PiB7XG4gICAgdGhpcy5zZXRWaXNpYmxlKGZhbHNlKTtcbiAgICB0aGlzLmNvbmZpcm1GaWx0ZXIoKTtcbiAgfTtcblxuICBvblZpc2libGVDaGFuZ2UgPSAodmlzaWJsZTogYm9vbGVhbikgPT4ge1xuICAgIHRoaXMuc2V0VmlzaWJsZSh2aXNpYmxlKTtcbiAgICBpZiAoIXZpc2libGUpIHtcbiAgICAgIHRoaXMuY29uZmlybUZpbHRlcigpO1xuICAgIH1cbiAgfTtcblxuICBjb25maXJtRmlsdGVyKCkge1xuICAgIGNvbnN0IHsgc2VsZWN0ZWRLZXlzOiBwcm9wU2VsZWN0ZWRLZXlzLCBjb2x1bW4sIGNvbmZpcm1GaWx0ZXIgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBzZWxlY3RlZEtleXMgfSA9IHRoaXMuc3RhdGU7XG4gICAgaWYgKHNlbGVjdGVkS2V5cyAhPT0gcHJvcFNlbGVjdGVkS2V5cykge1xuICAgICAgY29uZmlybUZpbHRlcihjb2x1bW4sIHNlbGVjdGVkS2V5cyk7XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyTWVudUl0ZW0oaXRlbTogQ29sdW1uRmlsdGVySXRlbSkge1xuICAgIGNvbnN0IHsgY29sdW1uIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgc2VsZWN0ZWRLZXlzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IG11bHRpcGxlID0gJ2ZpbHRlck11bHRpcGxlJyBpbiBjb2x1bW4gPyBjb2x1bW4uZmlsdGVyTXVsdGlwbGUgOiBmYWxzZTtcbiAgICBjb25zdCBpbnB1dCA9IG11bHRpcGxlID8gbnVsbCA6IChcbiAgICAgIDxSYWRpbyBjaGVja2VkPXtzZWxlY3RlZEtleXMuaW5kZXhPZihpdGVtLnZhbHVlLnRvU3RyaW5nKCkpID49IDB9IC8+XG4gICAgKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8TWVudUl0ZW0ga2V5PXtpdGVtLnZhbHVlfT5cbiAgICAgICAge2lucHV0fVxuICAgICAgICA8c3Bhbj57aXRlbS50ZXh0fTwvc3Bhbj5cbiAgICAgIDwvTWVudUl0ZW0+XG4gICAgKTtcbiAgfVxuXG4gIGhhc1N1Yk1lbnUoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY29sdW1uOiB7IGZpbHRlcnMgPSBbXSB9LFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiBmaWx0ZXJzLnNvbWUoaXRlbSA9PiAhIShpdGVtLmNoaWxkcmVuICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoID4gMCkpO1xuICB9XG5cbiAgcmVuZGVyTWVudXMoaXRlbXM6IENvbHVtbkZpbHRlckl0ZW1bXSk6IFJlYWN0RWxlbWVudDxhbnk+W10ge1xuICAgIHJldHVybiBpdGVtcy5tYXAoaXRlbSA9PiB7XG4gICAgICBpZiAoaXRlbS5jaGlsZHJlbiAmJiBpdGVtLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgeyBkcm9wZG93blByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBrZXlQYXRoT2ZTZWxlY3RlZEl0ZW0gfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5TZWxlY3RlZCA9IE9iamVjdC5rZXlzKGtleVBhdGhPZlNlbGVjdGVkSXRlbSkuc29tZShcbiAgICAgICAgICBrZXkgPT4ga2V5UGF0aE9mU2VsZWN0ZWRJdGVtW2tleV0uaW5kZXhPZihpdGVtLnZhbHVlKSA+PSAwLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBzdWJNZW51Q2xzID0gY29udGFpblNlbGVjdGVkID8gYCR7ZHJvcGRvd25QcmVmaXhDbHN9LXN1Ym1lbnUtY29udGFpbi1zZWxlY3RlZGAgOiAnJztcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8U3ViTWVudSB0aXRsZT17aXRlbS50ZXh0fSBjbGFzc05hbWU9e3N1Yk1lbnVDbHN9IGtleT17aXRlbS52YWx1ZS50b1N0cmluZygpfT5cbiAgICAgICAgICAgIHt0aGlzLnJlbmRlck1lbnVzKGl0ZW0uY2hpbGRyZW4pfVxuICAgICAgICAgIDwvU3ViTWVudT5cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnJlbmRlck1lbnVJdGVtKGl0ZW0pO1xuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRmlsdGVyRHJvcGRvd25NZW51Q2xpY2sgPSAoZTogU3ludGhldGljRXZlbnQ8YW55PikgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgfTtcblxuICBoYW5kbGVNZW51SXRlbUNsaWNrID0gKGluZm86IHsga2V5UGF0aDogc3RyaW5nOyBrZXk6IHN0cmluZyB9KSA9PiB7XG4gICAgaWYgKGluZm8ua2V5UGF0aC5sZW5ndGggPD0gMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB7IGtleVBhdGhPZlNlbGVjdGVkSXRlbSwgc2VsZWN0ZWRLZXlzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGlmIChzZWxlY3RlZEtleXMuaW5kZXhPZihpbmZvLmtleSkgPj0gMCkge1xuICAgICAgLy8gZGVzZWxlY3QgU3ViTWVudSBjaGlsZFxuICAgICAgZGVsZXRlIGtleVBhdGhPZlNlbGVjdGVkSXRlbVtpbmZvLmtleV07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHNlbGVjdCBTdWJNZW51IGNoaWxkXG4gICAgICBrZXlQYXRoT2ZTZWxlY3RlZEl0ZW1baW5mby5rZXldID0gaW5mby5rZXlQYXRoO1xuICAgIH1cbiAgICB0aGlzLnNldFN0YXRlKHsga2V5UGF0aE9mU2VsZWN0ZWRJdGVtIH0pO1xuICB9O1xuXG4gIHJlbmRlckZpbHRlckljb24gPSAoKSA9PiB7XG4gICAgY29uc3QgeyBjb2x1bW4sIGxvY2FsZSwgcHJlZml4Q2xzLCBzZWxlY3RlZEtleXMgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgZmlsdGVySWNvbiA9IGNvbHVtbi5maWx0ZXJJY29uIGFzIGFueTtcbiAgICBjb25zdCBkcm9wZG93blNlbGVjdGVkQ2xhc3MgPSBzZWxlY3RlZEtleXMubGVuZ3RoID4gMCA/IGAke3ByZWZpeENsc30tc2VsZWN0ZWRgIDogJyc7XG5cbiAgICByZXR1cm4gZmlsdGVySWNvbiA/IChcbiAgICAgIGNsb25lRWxlbWVudChmaWx0ZXJJY29uIGFzIGFueSwge1xuICAgICAgICB0aXRsZTogbG9jYWxlLmZpbHRlclRpdGxlLFxuICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZXMoZmlsdGVySWNvbi5jbGFzc05hbWUsIHtcbiAgICAgICAgICBbYCR7cHJlZml4Q2xzfS1pY29uYF06IHRydWUsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICApIDogKFxuICAgICAgPEljb24gdGl0bGU9e2xvY2FsZS5maWx0ZXJUaXRsZX0gdHlwZT1cImZpbHRlcl9saXN0XCIgY2xhc3NOYW1lPXtkcm9wZG93blNlbGVjdGVkQ2xhc3N9IC8+XG4gICAgKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBjb2x1bW4sIGxvY2FsZSwgcHJlZml4Q2xzLCBkcm9wZG93blByZWZpeENscywgZ2V0UG9wdXBDb250YWluZXIgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyB2aXNpYmxlLCBzZWxlY3RlZEtleXMgfSA9IHRoaXMuc3RhdGU7XG4gICAgLy8gZGVmYXVsdCBtdWx0aXBsZSBzZWxlY3Rpb24gaW4gZmlsdGVyIGRyb3Bkb3duXG4gICAgY29uc3QgbXVsdGlwbGUgPSAnZmlsdGVyTXVsdGlwbGUnIGluIGNvbHVtbiA/IGNvbHVtbi5maWx0ZXJNdWx0aXBsZSA6IGZhbHNlO1xuICAgIGNvbnN0IGRyb3Bkb3duTWVudUNsYXNzID0gY2xhc3NOYW1lcyh7XG4gICAgICBbYCR7ZHJvcGRvd25QcmVmaXhDbHN9LW1lbnUtd2l0aG91dC1zdWJtZW51YF06ICF0aGlzLmhhc1N1Yk1lbnUoKSxcbiAgICB9KTtcbiAgICBjb25zdCBtZW51cyA9IGNvbHVtbi5maWx0ZXJEcm9wZG93biA/IChcbiAgICAgIDxGaWx0ZXJEcm9wZG93bk1lbnVXcmFwcGVyIG9uQ2xpY2s9e3RoaXMuaGFuZGxlRmlsdGVyRHJvcGRvd25NZW51Q2xpY2t9PlxuICAgICAgICB7Y29sdW1uLmZpbHRlckRyb3Bkb3dufVxuICAgICAgPC9GaWx0ZXJEcm9wZG93bk1lbnVXcmFwcGVyPlxuICAgICkgOiAoXG4gICAgICA8RmlsdGVyRHJvcGRvd25NZW51V3JhcHBlclxuICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZHJvcGRvd25gfVxuICAgICAgICBvbkNsaWNrPXt0aGlzLmhhbmRsZUZpbHRlckRyb3Bkb3duTWVudUNsaWNrfVxuICAgICAgPlxuICAgICAgICA8TWVudVxuICAgICAgICAgIG11bHRpcGxlPXttdWx0aXBsZX1cbiAgICAgICAgICBvbkNsaWNrPXt0aGlzLmhhbmRsZU1lbnVJdGVtQ2xpY2t9XG4gICAgICAgICAgcHJlZml4Q2xzPXtgJHtkcm9wZG93blByZWZpeENsc30tbWVudWB9XG4gICAgICAgICAgY2xhc3NOYW1lPXtkcm9wZG93bk1lbnVDbGFzc31cbiAgICAgICAgICBvblNlbGVjdD17dGhpcy5zZXRTZWxlY3RlZEtleXN9XG4gICAgICAgICAgb25EZXNlbGVjdD17dGhpcy5zZXRTZWxlY3RlZEtleXN9XG4gICAgICAgICAgc2VsZWN0ZWRLZXlzPXtzZWxlY3RlZEtleXN9XG4gICAgICAgICAgZ2V0UG9wdXBDb250YWluZXI9eyh0cmlnZ2VyTm9kZTogSFRNTEVsZW1lbnQpID0+IHRyaWdnZXJOb2RlLnBhcmVudE5vZGV9XG4gICAgICAgID5cbiAgICAgICAgICB7dGhpcy5yZW5kZXJNZW51cyhjb2x1bW4uZmlsdGVycyEpfVxuICAgICAgICA8L01lbnU+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWRyb3Bkb3duLWJ0bnNgfT5cbiAgICAgICAgICA8YSBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZHJvcGRvd24tbGluayBjb25maXJtYH0gb25DbGljaz17dGhpcy5oYW5kbGVDb25maXJtfT5cbiAgICAgICAgICAgIHtsb2NhbGUuZmlsdGVyQ29uZmlybX1cbiAgICAgICAgICA8L2E+XG4gICAgICAgICAgPGEgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWRyb3Bkb3duLWxpbmsgY2xlYXJgfSBvbkNsaWNrPXt0aGlzLmhhbmRsZUNsZWFyRmlsdGVyc30+XG4gICAgICAgICAgICB7bG9jYWxlLmZpbHRlclJlc2V0fVxuICAgICAgICAgIDwvYT5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L0ZpbHRlckRyb3Bkb3duTWVudVdyYXBwZXI+XG4gICAgKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8RHJvcGRvd25cbiAgICAgICAgdHJpZ2dlcj17WydjbGljayddfVxuICAgICAgICBvdmVybGF5PXttZW51c31cbiAgICAgICAgdmlzaWJsZT17dGhpcy5uZXZlclNob3duID8gZmFsc2UgOiB2aXNpYmxlfVxuICAgICAgICBvblZpc2libGVDaGFuZ2U9e3RoaXMub25WaXNpYmxlQ2hhbmdlfVxuICAgICAgICBnZXRQb3B1cENvbnRhaW5lcj17Z2V0UG9wdXBDb250YWluZXJ9XG4gICAgICAgIGZvcmNlUmVuZGVyXG4gICAgICA+XG4gICAgICAgIHt0aGlzLnJlbmRlckZpbHRlckljb24oKX1cbiAgICAgIDwvRHJvcGRvd24+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9