import { __decorate } from "tslib";
import React from 'react';
import PropTypes from 'prop-types';
import { observer } from 'mobx-react';
import { action, observable, runInAction } from 'mobx';
import { Select } from '../select/Select';
import Option from '../option/Option';
import OptGroup from '../option/OptGroup';
import TransferList from './TransferList';
import TransferOperation from './TransferOperation';
import autobind from '../_util/autobind';
import isSameLike from '../_util/isSameLike';
let Transfer = class Transfer extends Select {
    constructor(props, context) {
        super(props, context);
        runInAction(() => {
            this.sourceSelected = [];
            this.targetSelected = [];
        });
    }
    sourceFilter(record, index, array) {
        const { valueField, props: { optionsFilter }, } = this;
        if (optionsFilter && !optionsFilter(record, index, array)) {
            return false;
        }
        const values = this.getValues();
        if (values.length) {
            return values.every(v => !isSameLike(record.get(valueField), v));
        }
        return true;
    }
    targetFilter(record, index, array) {
        const { valueField, props: { optionsFilter }, } = this;
        if (optionsFilter && !optionsFilter(record, index, array)) {
            return false;
        }
        const values = this.getValues();
        if (values.length) {
            return values.some(v => isSameLike(record.get(valueField), v));
        }
        return false;
    }
    handleMenuClick({ item: { props: { value }, }, }) {
        if (this.multiple) {
            this.selectRecord(value, this.sourceSelected);
        }
        else {
            this.prepareSetValue(this.processRecordToObject(value));
        }
    }
    handleTargetMenuClick({ item: { props: { value }, }, }) {
        if (this.multiple) {
            this.selectRecord(value, this.targetSelected);
        }
        else {
            this.removeValue(value);
        }
    }
    handleMoveToLeft() {
        const { valueField } = this;
        this.removeValues(this.targetSelected.map(record => record.get(valueField)));
        this.targetSelected = [];
    }
    handleMoveToRight() {
        const { valueField } = this;
        this.prepareSetValue(...this.sourceSelected.map(record => record.get(valueField)));
        this.sourceSelected = [];
    }
    handleSourceSelectAllChange(selected) {
        this.sourceSelected = selected;
    }
    handleTargetSelectAllChange(selected) {
        this.targetSelected = selected;
    }
    selectRecord(value, selected) {
        const index = selected.indexOf(value);
        if (index !== -1) {
            selected.splice(index, 1);
        }
        else {
            selected.push(value);
        }
    }
    renderWrapper() {
        const { prefixCls, targetSelected, sourceSelected, multiple, props: { titles = [] }, } = this;
        const disabled = this.isDisabled();
        return (React.createElement("span", { key: "wrapper", className: `${prefixCls}-wrapper` },
            React.createElement(TransferList, Object.assign({}, this.props, { options: this.options, selected: sourceSelected, header: titles[0], onSelectAll: this.handleSourceSelectAllChange, onSelect: this.handleMenuClick, optionsFilter: this.sourceFilter })),
            React.createElement(TransferOperation, { className: `${prefixCls}-operation`, leftActive: !(!targetSelected.length || disabled), rightActive: !(!sourceSelected.length || disabled), moveToLeft: this.handleMoveToLeft, moveToRight: this.handleMoveToRight, multiple: multiple }),
            React.createElement(TransferList, Object.assign({}, this.props, { options: this.options, selected: targetSelected, header: titles[1], onSelectAll: this.handleTargetSelectAllChange, onSelect: this.handleTargetMenuClick, optionsFilter: this.targetFilter }))));
    }
};
Transfer.displayName = 'Transfer';
Transfer.propTypes = {
    ...Select.propTypes,
    titles: PropTypes.arrayOf(PropTypes.node),
};
Transfer.defaultProps = {
    ...Select.defaultProps,
    suffixCls: 'transfer',
    multiple: true,
};
Transfer.Option = Option;
Transfer.OptGroup = OptGroup;
__decorate([
    observable
], Transfer.prototype, "sourceSelected", void 0);
__decorate([
    observable
], Transfer.prototype, "targetSelected", void 0);
__decorate([
    autobind
], Transfer.prototype, "sourceFilter", null);
__decorate([
    autobind
], Transfer.prototype, "targetFilter", null);
__decorate([
    autobind
], Transfer.prototype, "handleMenuClick", null);
__decorate([
    autobind
], Transfer.prototype, "handleTargetMenuClick", null);
__decorate([
    autobind,
    action
], Transfer.prototype, "handleMoveToLeft", null);
__decorate([
    autobind,
    action
], Transfer.prototype, "handleMoveToRight", null);
__decorate([
    autobind,
    action
], Transfer.prototype, "handleSourceSelectAllChange", null);
__decorate([
    autobind,
    action
], Transfer.prototype, "handleTargetSelectAllChange", null);
__decorate([
    action
], Transfer.prototype, "selectRecord", null);
Transfer = __decorate([
    observer
], Transfer);
export default Transfer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3RyYW5zZmVyL1RyYW5zZmVyLnRzeCIsIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxLQUFvQixNQUFNLE9BQU8sQ0FBQztBQUN6QyxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBZSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZELE9BQU8sTUFBTSxNQUFNLGtCQUFrQixDQUFDO0FBQ3RDLE9BQU8sUUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sWUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8saUJBQWlCLE1BQU0scUJBQXFCLENBQUM7QUFDcEQsT0FBTyxRQUFRLE1BQU0sbUJBQW1CLENBQUM7QUFFekMsT0FBTyxVQUFVLE1BQU0scUJBQXFCLENBQUM7QUFRN0MsSUFBcUIsUUFBUSxHQUE3QixNQUFxQixRQUFTLFNBQVEsTUFBcUI7SUFzQnpELFlBQVksS0FBSyxFQUFFLE9BQU87UUFDeEIsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0QixXQUFXLENBQUMsR0FBRyxFQUFFO1lBQ2YsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7WUFDekIsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBR0QsWUFBWSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSztRQUMvQixNQUFNLEVBQ0osVUFBVSxFQUNWLEtBQUssRUFBRSxFQUFFLGFBQWEsRUFBRSxHQUN6QixHQUFHLElBQUksQ0FBQztRQUNULElBQUksYUFBYSxJQUFJLENBQUMsYUFBYSxDQUFDLE1B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NUIsUUFBUTtHQUNZLFFBQVEsQ0FzSzVCO2VBdEtvQixRQUFRIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby90cmFuc2Zlci9UcmFuc2Zlci50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IFJlYWN0Tm9kZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBvYnNlcnZlciB9IGZyb20gJ21vYngtcmVhY3QnO1xuaW1wb3J0IHsgYWN0aW9uLCBvYnNlcnZhYmxlLCBydW5JbkFjdGlvbiB9IGZyb20gJ21vYngnO1xuaW1wb3J0IHsgU2VsZWN0LCBTZWxlY3RQcm9wcyB9IGZyb20gJy4uL3NlbGVjdC9TZWxlY3QnO1xuaW1wb3J0IE9wdGlvbiBmcm9tICcuLi9vcHRpb24vT3B0aW9uJztcbmltcG9ydCBPcHRHcm91cCBmcm9tICcuLi9vcHRpb24vT3B0R3JvdXAnO1xuaW1wb3J0IFRyYW5zZmVyTGlzdCBmcm9tICcuL1RyYW5zZmVyTGlzdCc7XG5pbXBvcnQgVHJhbnNmZXJPcGVyYXRpb24gZnJvbSAnLi9UcmFuc2Zlck9wZXJhdGlvbic7XG5pbXBvcnQgYXV0b2JpbmQgZnJvbSAnLi4vX3V0aWwvYXV0b2JpbmQnO1xuaW1wb3J0IFJlY29yZCBmcm9tICcuLi9kYXRhLXNldC9SZWNvcmQnO1xuaW1wb3J0IGlzU2FtZUxpa2UgZnJvbSAnLi4vX3V0aWwvaXNTYW1lTGlrZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNmZXJQcm9wcyBleHRlbmRzIFNlbGVjdFByb3BzIHtcbiAgdGl0bGVzPzogW1JlYWN0Tm9kZSwgUmVhY3ROb2RlXTtcbiAgZm9vdGVyPzogKHByb3BzOiBhbnkpID0+IFJlYWN0Tm9kZTtcbn1cblxuQG9ic2VydmVyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUcmFuc2ZlciBleHRlbmRzIFNlbGVjdDxUcmFuc2ZlclByb3BzPiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdUcmFuc2Zlcic7XG5cbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAuLi5TZWxlY3QucHJvcFR5cGVzLFxuICAgIHRpdGxlczogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm5vZGUpLFxuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgLi4uU2VsZWN0LmRlZmF1bHRQcm9wcyxcbiAgICBzdWZmaXhDbHM6ICd0cmFuc2ZlcicsXG4gICAgbXVsdGlwbGU6IHRydWUsXG4gIH07XG5cbiAgc3RhdGljIE9wdGlvbiA9IE9wdGlvbjtcblxuICBzdGF0aWMgT3B0R3JvdXAgPSBPcHRHcm91cDtcblxuICBAb2JzZXJ2YWJsZSBzb3VyY2VTZWxlY3RlZDogUmVjb3JkW107XG5cbiAgQG9ic2VydmFibGUgdGFyZ2V0U2VsZWN0ZWQ6IFJlY29yZFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuICAgIHJ1bkluQWN0aW9uKCgpID0+IHtcbiAgICAgIHRoaXMuc291cmNlU2VsZWN0ZWQgPSBbXTtcbiAgICAgIHRoaXMudGFyZ2V0U2VsZWN0ZWQgPSBbXTtcbiAgICB9KTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICBzb3VyY2VGaWx0ZXIocmVjb3JkLCBpbmRleCwgYXJyYXkpIHtcbiAgICBjb25zdCB7XG4gICAgICB2YWx1ZUZpZWxkLFxuICAgICAgcHJvcHM6IHsgb3B0aW9uc0ZpbHRlciB9LFxuICAgIH0gPSB0aGlzO1xuICAgIGlmIChvcHRpb25zRmlsdGVyICYmICFvcHRpb25zRmlsdGVyKHJlY29yZCwgaW5kZXgsIGFycmF5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLmdldFZhbHVlcygpO1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdmFsdWVzLmV2ZXJ5KHYgPT4gIWlzU2FtZUxpa2UocmVjb3JkLmdldCh2YWx1ZUZpZWxkKSwgdikpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICB0YXJnZXRGaWx0ZXIocmVjb3JkLCBpbmRleCwgYXJyYXkpIHtcbiAgICBjb25zdCB7XG4gICAgICB2YWx1ZUZpZWxkLFxuICAgICAgcHJvcHM6IHsgb3B0aW9uc0ZpbHRlciB9LFxuICAgIH0gPSB0aGlzO1xuICAgIGlmIChvcHRpb25zRmlsdGVyICYmICFvcHRpb25zRmlsdGVyKHJlY29yZCwgaW5kZXgsIGFycmF5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLmdldFZhbHVlcygpO1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdmFsdWVzLnNvbWUodiA9PiBpc1NhbWVMaWtlKHJlY29yZC5nZXQodmFsdWVGaWVsZCksIHYpKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgQGF1dG9iaW5kXG4gIGhhbmRsZU1lbnVDbGljayh7XG4gICAgaXRlbToge1xuICAgICAgcHJvcHM6IHsgdmFsdWUgfSxcbiAgICB9LFxuICB9KSB7XG4gICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcbiAgICAgIHRoaXMuc2VsZWN0UmVjb3JkKHZhbHVlLCB0aGlzLnNvdXJjZVNlbGVjdGVkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wcmVwYXJlU2V0VmFsdWUodGhpcy5wcm9jZXNzUmVjb3JkVG9PYmplY3QodmFsdWUpKTtcbiAgICB9XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgaGFuZGxlVGFyZ2V0TWVudUNsaWNrKHtcbiAgICBpdGVtOiB7XG4gICAgICBwcm9wczogeyB2YWx1ZSB9LFxuICAgIH0sXG4gIH0pIHtcbiAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xuICAgICAgdGhpcy5zZWxlY3RSZWNvcmQodmFsdWUsIHRoaXMudGFyZ2V0U2VsZWN0ZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZVZhbHVlKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgQGFjdGlvblxuICBoYW5kbGVNb3ZlVG9MZWZ0KCkge1xuICAgIGNvbnN0IHsgdmFsdWVGaWVsZCB9ID0gdGhpcztcbiAgICB0aGlzLnJlbW92ZVZhbHVlcyh0aGlzLnRhcmdldFNlbGVjdGVkLm1hcChyZWNvcmQgPT4gcmVjb3JkLmdldCh2YWx1ZUZpZWxkKSkpO1xuICAgIHRoaXMudGFyZ2V0U2VsZWN0ZWQgPSBbXTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICBAYWN0aW9uXG4gIGhhbmRsZU1vdmVUb1JpZ2h0KCkge1xuICAgIGNvbnN0IHsgdmFsdWVGaWVsZCB9ID0gdGhpcztcbiAgICB0aGlzLnByZXBhcmVTZXRWYWx1ZSguLi50aGlzLnNvdXJjZVNlbGVjdGVkLm1hcChyZWNvcmQgPT4gcmVjb3JkLmdldCh2YWx1ZUZpZWxkKSkpO1xuICAgIHRoaXMuc291cmNlU2VsZWN0ZWQgPSBbXTtcbiAgfVxuXG4gIEBhdXRvYmluZFxuICBAYWN0aW9uXG4gIGhhbmRsZVNvdXJjZVNlbGVjdEFsbENoYW5nZShzZWxlY3RlZDogUmVjb3JkW10pIHtcbiAgICB0aGlzLnNvdXJjZVNlbGVjdGVkID0gc2VsZWN0ZWQ7XG4gIH1cblxuICBAYXV0b2JpbmRcbiAgQGFjdGlvblxuICBoYW5kbGVUYXJnZXRTZWxlY3RBbGxDaGFuZ2Uoc2VsZWN0ZWQ6IFJlY29yZFtdKSB7XG4gICAgdGhpcy50YXJnZXRTZWxlY3RlZCA9IHNlbGVjdGVkO1xuICB9XG5cbiAgQGFjdGlvblxuICBzZWxlY3RSZWNvcmQodmFsdWU6IFJlY29yZCwgc2VsZWN0ZWQ6IFJlY29yZFtdKSB7XG4gICAgY29uc3QgaW5kZXggPSBzZWxlY3RlZC5pbmRleE9mKHZhbHVlKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBzZWxlY3RlZC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxlY3RlZC5wdXNoKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICByZW5kZXJXcmFwcGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHByZWZpeENscyxcbiAgICAgIHRhcmdldFNlbGVjdGVkLFxuICAgICAgc291cmNlU2VsZWN0ZWQsXG4gICAgICBtdWx0aXBsZSxcbiAgICAgIHByb3BzOiB7IHRpdGxlcyA9IFtdIH0sXG4gICAgfSA9IHRoaXM7XG4gICAgY29uc3QgZGlzYWJsZWQgPSB0aGlzLmlzRGlzYWJsZWQoKTtcbiAgICByZXR1cm4gKFxuICAgICAgPHNwYW4ga2V5PVwid3JhcHBlclwiIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS13cmFwcGVyYH0+XG4gICAgICAgIDxUcmFuc2Zlckxpc3RcbiAgICAgICAgICB7Li4udGhpcy5wcm9wc31cbiAgICAgICAgICBvcHRpb25zPXt0aGlzLm9wdGlvbnN9XG4gICAgICAgICAgc2VsZWN0ZWQ9e3NvdXJjZVNlbGVjdGVkfVxuICAgICAgICAgIGhlYWRlcj17dGl0bGVzWzBdfVxuICAgICAgICAgIG9uU2VsZWN0QWxsPXt0aGlzLmhhbmRsZVNvdXJjZVNlbGVjdEFsbENoYW5nZX1cbiAgICAgICAgICBvblNlbGVjdD17dGhpcy5oYW5kbGVNZW51Q2xpY2t9XG4gICAgICAgICAgb3B0aW9uc0ZpbHRlcj17dGhpcy5zb3VyY2VGaWx0ZXJ9XG4gICAgICAgIC8+XG4gICAgICAgIDxUcmFuc2Zlck9wZXJhdGlvblxuICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1vcGVyYXRpb25gfVxuICAgICAgICAgIGxlZnRBY3RpdmU9eyEoIXRhcmdldFNlbGVjdGVkLmxlbmd0aCB8fCBkaXNhYmxlZCl9XG4gICAgICAgICAgcmlnaHRBY3RpdmU9eyEoIXNvdXJjZVNlbGVjdGVkLmxlbmd0aCB8fCBkaXNhYmxlZCl9XG4gICAgICAgICAgbW92ZVRvTGVmdD17dGhpcy5oYW5kbGVNb3ZlVG9MZWZ0fVxuICAgICAgICAgIG1vdmVUb1JpZ2h0PXt0aGlzLmhhbmRsZU1vdmVUb1JpZ2h0fVxuICAgICAgICAgIG11bHRpcGxlPXttdWx0aXBsZX1cbiAgICAgICAgLz5cbiAgICAgICAgPFRyYW5zZmVyTGlzdFxuICAgICAgICAgIHsuLi50aGlzLnByb3BzfVxuICAgICAgICAgIG9wdGlvbnM9e3RoaXMub3B0aW9uc31cbiAgICAgICAgICBzZWxlY3RlZD17dGFyZ2V0U2VsZWN0ZWR9XG4gICAgICAgICAgaGVhZGVyPXt0aXRsZXNbMV19XG4gICAgICAgICAgb25TZWxlY3RBbGw9e3RoaXMuaGFuZGxlVGFyZ2V0U2VsZWN0QWxsQ2hhbmdlfVxuICAgICAgICAgIG9uU2VsZWN0PXt0aGlzLmhhbmRsZVRhcmdldE1lbnVDbGlja31cbiAgICAgICAgICBvcHRpb25zRmlsdGVyPXt0aGlzLnRhcmdldEZpbHRlcn1cbiAgICAgICAgLz5cbiAgICAgIDwvc3Bhbj5cbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=