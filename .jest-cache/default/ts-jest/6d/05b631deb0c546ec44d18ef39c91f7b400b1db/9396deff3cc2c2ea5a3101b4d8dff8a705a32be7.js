import * as React from 'react';
import PropTypes from 'prop-types';
import classNames from 'classnames';
import { DOMMouseMoveTracker, addStyle, getOffset } from 'dom-lib';
import { SCROLLBAR_MIN_WIDTH } from './constants';
import { defaultClassPrefix, getUnhandledProps, prefix } from './utils';
import TableContext from './TableContext';
class Scrollbar extends React.PureComponent {
    constructor(props) {
        super(props);
        this.scrollOffset = 0;
        this.mouseMoveTracker = null;
        this.handleMouseDown = (event) => {
            this.mouseMoveTracker = this.getMouseMoveTracker();
            // @ts-ignore
            this.mouseMoveTracker?.captureMouseMoves(event);
            this.setState({ handlePressed: true });
            this.props.onMouseDown?.(event);
        };
        this.handleDragEnd = () => {
            this.releaseMouseMoves();
            this.setState({ handlePressed: false });
        };
        this.handleDragMove = (deltaX, deltaY, event) => {
            const { vertical } = this.props;
            // @ts-ignore
            if (!this.mouseMoveTracker || !this.mouseMoveTracker.isDragging()) {
                return;
            }
            if (event?.buttons === 0 || window?.event?.['buttons'] === 0) {
                this.releaseMouseMoves();
                return;
            }
            this.handleScroll(vertical ? deltaY : deltaX, event);
        };
        /**
         * 点击滚动条，然后滚动到指定位置
         */
        this.handleClick = (event) => {
            if (this.handleRef.current && this.handleRef.current?.contains(event.target)) {
                return;
            }
            const { vertical, length, scrollLength } = this.props;
            const { barOffset } = this.state;
            const offset = vertical ? event.pageY - barOffset.top : event.pageX - barOffset.left;
            const handleWidth = (length / scrollLength) * length;
            const delta = offset - handleWidth;
            const nextDelta = offset > this.scrollOffset ? delta - this.scrollOffset : offset - this.scrollOffset;
            this.handleScroll(nextDelta, event);
        };
        this.state = {
            barOffset: {
                top: 0,
                left: 0,
            },
            handlePressed: false,
        };
        this.handleRef = React.createRef();
        this.barRef = React.createRef();
    }
    componentDidMount() {
        this.initBarOffset();
    }
    componentDidUpdate(prevProps) {
        if (this.props.vertical && this.props.scrollLength !== prevProps.scrollLength) {
            this.initBarOffset();
        }
        else if (!this.props.vertical && this.props.scrollLength !== prevProps.scrollLength) {
            this.initBarOffset();
        }
    }
    componentWillUnmount() {
        this.releaseMouseMoves();
    }
    onWheelScroll(delta) {
        const { length, scrollLength } = this.props;
        const nextDelta = delta / (scrollLength / length);
        this.updateScrollBarPosition(nextDelta);
    }
    getMouseMoveTracker() {
        return (this.mouseMoveTracker ||
            new DOMMouseMoveTracker(this.handleDragMove, this.handleDragEnd, document.body));
    }
    initBarOffset() {
        setTimeout(() => {
            this.barRef.current &&
                this.setState({
                    barOffset: getOffset(this.barRef.current),
                });
        }, 1);
    }
    handleScroll(delta, event) {
        const { length, scrollLength } = this.props;
        const scrollDelta = delta * (scrollLength / length);
        this.updateScrollBarPosition(delta);
        this.props.onScroll?.(scrollDelta, event);
    }
    resetScrollBarPosition(forceDelta = 0) {
        this.scrollOffset = 0;
        this.updateScrollBarPosition(0, forceDelta);
    }
    updateScrollBarPosition(delta, forceDelta) {
        const { vertical, length, scrollLength } = this.props;
        const { translateDOMPositionXY } = this.context;
        const max = scrollLength && length
            ? length - Math.max((length / scrollLength) * length, SCROLLBAR_MIN_WIDTH + 2)
            : 0;
        const styles = {};
        if (typeof forceDelta === 'undefined') {
            this.scrollOffset += delta;
            this.scrollOffset = Math.max(this.scrollOffset, 0);
            this.scrollOffset = Math.min(this.scrollOffset, max);
        }
        else {
            this.scrollOffset = forceDelta || 0;
        }
        if (vertical) {
            translateDOMPositionXY?.(styles, 0, this.scrollOffset);
        }
        else {
            translateDOMPositionXY?.(styles, this.scrollOffset, 0);
        }
        addStyle(this.handleRef.current, styles);
    }
    releaseMouseMoves() {
        // @ts-ignore
        this.mouseMoveTracker?.releaseMouseMoves?.();
        this.mouseMoveTracker = null;
    }
    render() {
        const { vertical, length, scrollLength, classPrefix, className, ...rest } = this.props;
        const { handlePressed } = this.state;
        // @ts-ignore
        const addPrefix = prefix(classPrefix);
        const classes = classNames(classPrefix, className, {
            [addPrefix('vertical')]: vertical,
            [addPrefix('horizontal')]: !vertical,
            [addPrefix('hide')]: scrollLength <= length,
            [addPrefix('pressed')]: handlePressed,
        });
        const styles = {
            [vertical ? 'height' : 'width']: `${(length / scrollLength) * 100}%`,
            [vertical ? 'minHeight' : 'minWidth']: SCROLLBAR_MIN_WIDTH,
        };
        const unhandled = getUnhandledProps(Scrollbar, rest);
        return (React.createElement("div", Object.assign({}, unhandled, { ref: this.barRef, className: classes, onClick: this.handleClick, role: "toolbar" }),
            React.createElement("div", { ref: this.handleRef, className: addPrefix('handle'), style: styles, onMouseDown: this.handleMouseDown, role: "button", tabIndex: -1 })));
    }
}
Scrollbar.contextType = TableContext;
Scrollbar.propTypes = {
    vertical: PropTypes.bool,
    length: PropTypes.number,
    scrollLength: PropTypes.number,
    className: PropTypes.string,
    classPrefix: PropTypes.string,
    onScroll: PropTypes.func,
    onMouseDown: PropTypes.func,
};
Scrollbar.defaultProps = {
    classPrefix: defaultClassPrefix('performance-table-scrollbar'),
    scrollLength: 1,
    length: 1,
};
export default Scrollbar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3BlcmZvcm1hbmNlLXRhYmxlL1Njcm9sbGJhci50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNuRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN4RSxPQUFPLFlBQVksTUFBTSxnQkFBZ0IsQ0FBQztBQWUxQyxNQUFNLFNBQVUsU0FBUSxLQUFLLENBQUMsYUFBb0M7SUFzQmhFLFlBQVksS0FBcUI7UUFDL0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBTmYsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFDakIscUJBQWdCLEdBQUcsSUFBSSxDQUFDO1FBd0R4QixvQkFBZSxHQUFHLENBQUMsS0FBdUIsRUFBRSxFQUFFO1lBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUNuRCxhQUFhO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQztRQUVGLGtCQUFhLEdBQUcsR0FBRyxFQUFFO1lBQ25CLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxD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dWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby9wZXJmb3JtYW5jZS10YWJsZS9TY3JvbGxiYXIudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7IERPTU1vdXNlTW92ZVRyYWNrZXIsIGFkZFN0eWxlLCBnZXRPZmZzZXQgfSBmcm9tICdkb20tbGliJztcbmltcG9ydCB7IFNDUk9MTEJBUl9NSU5fV0lEVEggfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBkZWZhdWx0Q2xhc3NQcmVmaXgsIGdldFVuaGFuZGxlZFByb3BzLCBwcmVmaXggfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBUYWJsZUNvbnRleHQgZnJvbSAnLi9UYWJsZUNvbnRleHQnO1xuaW1wb3J0IHsgU2Nyb2xsYmFyUHJvcHMgfSBmcm9tICcuL1Njcm9sbGJhci5kJztcblxudHlwZSBPZmZzZXQgPSB7XG4gIHRvcDogbnVtYmVyO1xuICBsZWZ0OiBudW1iZXI7XG4gIGhlaWdodD86IG51bWJlcjtcbiAgd2lkdGg/OiBudW1iZXI7XG59O1xuXG50eXBlIFN0YXRlID0ge1xuICBiYXJPZmZzZXQ6IE9mZnNldDtcbiAgaGFuZGxlUHJlc3NlZDogYm9vbGVhbjtcbn07XG5cbmNsYXNzIFNjcm9sbGJhciBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8U2Nyb2xsYmFyUHJvcHMsIFN0YXRlPiB7XG4gIHN0YXRpYyBjb250ZXh0VHlwZSA9IFRhYmxlQ29udGV4dDtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICB2ZXJ0aWNhbDogUHJvcFR5cGVzLmJvb2wsXG4gICAgbGVuZ3RoOiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIHNjcm9sbExlbmd0aDogUHJvcFR5cGVzLm51bWJlcixcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgY2xhc3NQcmVmaXg6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgb25TY3JvbGw6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uTW91c2VEb3duOiBQcm9wVHlwZXMuZnVuYyxcbiAgfTtcbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBjbGFzc1ByZWZpeDogZGVmYXVsdENsYXNzUHJlZml4KCdwZXJmb3JtYW5jZS10YWJsZS1zY3JvbGxiYXInKSxcbiAgICBzY3JvbGxMZW5ndGg6IDEsXG4gICAgbGVuZ3RoOiAxLFxuICB9O1xuXG4gIHNjcm9sbE9mZnNldCA9IDA7XG4gIG1vdXNlTW92ZVRyYWNrZXIgPSBudWxsO1xuICBoYW5kbGVSZWY6IFJlYWN0LlJlZk9iamVjdDxIVE1MRGl2RWxlbWVudD47XG4gIGJhclJlZjogUmVhY3QuUmVmT2JqZWN0PEhUTUxEaXZFbGVtZW50PjtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogU2Nyb2xsYmFyUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGJhck9mZnNldDoge1xuICAgICAgICB0b3A6IDAsXG4gICAgICAgIGxlZnQ6IDAsXG4gICAgICB9LFxuICAgICAgaGFuZGxlUHJlc3NlZDogZmFsc2UsXG4gICAgfTtcbiAgICB0aGlzLmhhbmRsZVJlZiA9IFJlYWN0LmNyZWF0ZVJlZigpO1xuICAgIHRoaXMuYmFyUmVmID0gUmVhY3QuY3JlYXRlUmVmKCk7XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLmluaXRCYXJPZmZzZXQoKTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcbiAgICBpZiAodGhpcy5wcm9wcy52ZXJ0aWNhbCAmJiB0aGlzLnByb3BzLnNjcm9sbExlbmd0aCAhPT0gcHJldlByb3BzLnNjcm9sbExlbmd0aCkge1xuICAgICAgdGhpcy5pbml0QmFyT2Zmc2V0KCk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5wcm9wcy52ZXJ0aWNhbCAmJiB0aGlzLnByb3BzLnNjcm9sbExlbmd0aCAhPT0gcHJldlByb3BzLnNjcm9sbExlbmd0aCl7XG4gICAgICB0aGlzLmluaXRCYXJPZmZzZXQoKTtcbiAgICB9XG4gIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHRoaXMucmVsZWFzZU1vdXNlTW92ZXMoKTtcbiAgfVxuXG4gIG9uV2hlZWxTY3JvbGwoZGVsdGE6IG51bWJlcikge1xuICAgIGNvbnN0IHsgbGVuZ3RoLCBzY3JvbGxMZW5ndGggfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgbmV4dERlbHRhID0gZGVsdGEgLyAoc2Nyb2xsTGVuZ3RoIC8gbGVuZ3RoKTtcblxuICAgIHRoaXMudXBkYXRlU2Nyb2xsQmFyUG9zaXRpb24obmV4dERlbHRhKTtcbiAgfVxuXG4gIGdldE1vdXNlTW92ZVRyYWNrZXIoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMubW91c2VNb3ZlVHJhY2tlciB8fFxuICAgICAgbmV3IERPTU1vdXNlTW92ZVRyYWNrZXIodGhpcy5oYW5kbGVEcmFnTW92ZSwgdGhpcy5oYW5kbGVEcmFnRW5kLCBkb2N1bWVudC5ib2R5KVxuICAgICk7XG4gIH1cblxuICBpbml0QmFyT2Zmc2V0KCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5iYXJSZWYuY3VycmVudCAmJlxuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGJhck9mZnNldDogZ2V0T2Zmc2V0KHRoaXMuYmFyUmVmLmN1cnJlbnQpLFxuICAgICAgfSk7XG4gICAgfSwgMSk7XG4gIH1cblxuICBoYW5kbGVNb3VzZURvd24gPSAoZXZlbnQ6IFJlYWN0Lk1vdXNlRXZlbnQpID0+IHtcbiAgICB0aGlzLm1vdXNlTW92ZVRyYWNrZXIgPSB0aGlzLmdldE1vdXNlTW92ZVRyYWNrZXIoKTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgdGhpcy5tb3VzZU1vdmVUcmFja2VyPy5jYXB0dXJlTW91c2VNb3ZlcyhldmVudCk7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IGhhbmRsZVByZXNzZWQ6IHRydWUgfSk7XG4gICAgdGhpcy5wcm9wcy5vbk1vdXNlRG93bj8uKGV2ZW50KTtcbiAgfTtcblxuICBoYW5kbGVEcmFnRW5kID0gKCkgPT4ge1xuICAgIHRoaXMucmVsZWFzZU1vdXNlTW92ZXMoKTtcbiAgICB0aGlzLnNldFN0YXRlKHsgaGFuZGxlUHJlc3NlZDogZmFsc2UgfSk7XG4gIH07XG5cbiAgaGFuZGxlU2Nyb2xsKGRlbHRhOiBudW1iZXIsIGV2ZW50OiBSZWFjdC5Nb3VzZUV2ZW50KSB7XG4gICAgY29uc3QgeyBsZW5ndGgsIHNjcm9sbExlbmd0aCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBzY3JvbGxEZWx0YSA9IGRlbHRhICogKHNjcm9sbExlbmd0aCAvIGxlbmd0aCk7XG5cbiAgICB0aGlzLnVwZGF0ZVNjcm9sbEJhclBvc2l0aW9uKGRlbHRhKTtcbiAgICB0aGlzLnByb3BzLm9uU2Nyb2xsPy4oc2Nyb2xsRGVsdGEsIGV2ZW50KTtcbiAgfVxuXG4gIHJlc2V0U2Nyb2xsQmFyUG9zaXRpb24oZm9yY2VEZWx0YSA9IDApIHtcbiAgICB0aGlzLnNjcm9sbE9mZnNldCA9IDA7XG4gICAgdGhpcy51cGRhdGVTY3JvbGxCYXJQb3NpdGlvbigwLCBmb3JjZURlbHRhKTtcbiAgfVxuXG4gIHVwZGF0ZVNjcm9sbEJhclBvc2l0aW9uKGRlbHRhOiBudW1iZXIsIGZvcmNlRGVsdGE/OiBudW1iZXIpIHtcbiAgICBjb25zdCB7IHZlcnRpY2FsLCBsZW5ndGgsIHNjcm9sbExlbmd0aCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IHRyYW5zbGF0ZURPTVBvc2l0aW9uWFkgfSA9IHRoaXMuY29udGV4dDtcbiAgICBjb25zdCBtYXggPVxuICAgICAgc2Nyb2xsTGVuZ3RoICYmIGxlbmd0aFxuICAgICAgICA/IGxlbmd0aCAtIE1hdGgubWF4KChsZW5ndGggLyBzY3JvbGxMZW5ndGgpICogbGVuZ3RoLCBTQ1JPTExCQVJfTUlOX1dJRFRIICsgMilcbiAgICAgICAgOiAwO1xuICAgIGNvbnN0IHN0eWxlcyA9IHt9O1xuXG4gICAgaWYgKHR5cGVvZiBmb3JjZURlbHRhID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5zY3JvbGxPZmZzZXQgKz0gZGVsdGE7XG4gICAgICB0aGlzLnNjcm9sbE9mZnNldCA9IE1hdGgubWF4KHRoaXMuc2Nyb2xsT2Zmc2V0LCAwKTtcbiAgICAgIHRoaXMuc2Nyb2xsT2Zmc2V0ID0gTWF0aC5taW4odGhpcy5zY3JvbGxPZmZzZXQsIG1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2Nyb2xsT2Zmc2V0ID0gZm9yY2VEZWx0YSB8fCAwO1xuICAgIH1cblxuICAgIGlmICh2ZXJ0aWNhbCkge1xuICAgICAgdHJhbnNsYXRlRE9NUG9zaXRpb25YWT8uKHN0eWxlcywgMCwgdGhpcy5zY3JvbGxPZmZzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cmFuc2xhdGVET01Qb3NpdGlvblhZPy4oc3R5bGVzLCB0aGlzLnNjcm9sbE9mZnNldCwgMCk7XG4gICAgfVxuXG4gICAgYWRkU3R5bGUodGhpcy5oYW5kbGVSZWYuY3VycmVudCwgc3R5bGVzKTtcbiAgfVxuXG4gIHJlbGVhc2VNb3VzZU1vdmVzKCkge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICB0aGlzLm1vdXNlTW92ZVRyYWNrZXI/LnJlbGVhc2VNb3VzZU1vdmVzPy4oKTtcbiAgICB0aGlzLm1vdXNlTW92ZVRyYWNrZXIgPSBudWxsO1xuICB9XG5cbiAgaGFuZGxlRHJhZ01vdmUgPSAoZGVsdGFYOiBudW1iZXIsIGRlbHRhWTogbnVtYmVyLCBldmVudDogUmVhY3QuTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IHsgdmVydGljYWwgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgaWYgKCF0aGlzLm1vdXNlTW92ZVRyYWNrZXIgfHwgIXRoaXMubW91c2VNb3ZlVHJhY2tlci5pc0RyYWdnaW5nKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQ/LmJ1dHRvbnMgPT09IDAgfHwgd2luZG93Py5ldmVudD8uWydidXR0b25zJ10gPT09IDApIHtcbiAgICAgIHRoaXMucmVsZWFzZU1vdXNlTW92ZXMoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZVNjcm9sbCh2ZXJ0aWNhbCA/IGRlbHRhWSA6IGRlbHRhWCwgZXZlbnQpO1xuICB9O1xuXG4gIC8qKlxuICAgKiDngrnlh7vmu5rliqjmnaHvvIznhLblkI7mu5rliqjliLDmjIflrprkvY3nva5cbiAgICovXG4gIGhhbmRsZUNsaWNrID0gKGV2ZW50OiBSZWFjdC5Nb3VzZUV2ZW50KSA9PiB7XG4gICAgaWYgKHRoaXMuaGFuZGxlUmVmLmN1cnJlbnQgJiYgdGhpcy5oYW5kbGVSZWYuY3VycmVudD8uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyB2ZXJ0aWNhbCwgbGVuZ3RoLCBzY3JvbGxMZW5ndGggfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBiYXJPZmZzZXQgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3Qgb2Zmc2V0ID0gdmVydGljYWwgPyBldmVudC5wYWdlWSAtIGJhck9mZnNldC50b3AgOiBldmVudC5wYWdlWCAtIGJhck9mZnNldC5sZWZ0O1xuXG4gICAgY29uc3QgaGFuZGxlV2lkdGggPSAobGVuZ3RoIC8gc2Nyb2xsTGVuZ3RoKSAqIGxlbmd0aDtcbiAgICBjb25zdCBkZWx0YSA9IG9mZnNldCAtIGhhbmRsZVdpZHRoO1xuXG4gICAgY29uc3QgbmV4dERlbHRhID1cbiAgICAgIG9mZnNldCA+IHRoaXMuc2Nyb2xsT2Zmc2V0ID8gZGVsdGEgLSB0aGlzLnNjcm9sbE9mZnNldCA6IG9mZnNldCAtIHRoaXMuc2Nyb2xsT2Zmc2V0O1xuICAgIHRoaXMuaGFuZGxlU2Nyb2xsKG5leHREZWx0YSwgZXZlbnQpO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHZlcnRpY2FsLCBsZW5ndGgsIHNjcm9sbExlbmd0aCwgY2xhc3NQcmVmaXgsIGNsYXNzTmFtZSwgLi4ucmVzdCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGhhbmRsZVByZXNzZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGFkZFByZWZpeCA9IHByZWZpeChjbGFzc1ByZWZpeCk7XG5cbiAgICBjb25zdCBjbGFzc2VzID0gY2xhc3NOYW1lcyhjbGFzc1ByZWZpeCwgY2xhc3NOYW1lLCB7XG4gICAgICBbYWRkUHJlZml4KCd2ZXJ0aWNhbCcpIGFzIHVua25vd24gYXMgc3RyaW5nXTogdmVydGljYWwsXG4gICAgICBbYWRkUHJlZml4KCdob3Jpem9udGFsJylhcyB1bmtub3duIGFzIHN0cmluZ106ICF2ZXJ0aWNhbCxcbiAgICAgIFthZGRQcmVmaXgoJ2hpZGUnKWFzIHVua25vd24gYXMgc3RyaW5nXTogc2Nyb2xsTGVuZ3RoIDw9IGxlbmd0aCxcbiAgICAgIFthZGRQcmVmaXgoJ3ByZXNzZWQnKSBhcyB1bmtub3duIGFzIHN0cmluZ106IGhhbmRsZVByZXNzZWQsXG4gICAgfSk7XG5cbiAgICBjb25zdCBzdHlsZXM6IFJlYWN0LkNTU1Byb3BlcnRpZXMgPSB7XG4gICAgICBbdmVydGljYWwgPyAnaGVpZ2h0JyA6ICd3aWR0aCcgXTogYCR7KGxlbmd0aCAvIHNjcm9sbExlbmd0aCkgKiAxMDB9JWAsXG4gICAgICBbdmVydGljYWwgPyAnbWluSGVpZ2h0JyA6ICdtaW5XaWR0aCddOiBTQ1JPTExCQVJfTUlOX1dJRFRILFxuICAgIH07XG4gICAgY29uc3QgdW5oYW5kbGVkID0gZ2V0VW5oYW5kbGVkUHJvcHMoU2Nyb2xsYmFyLCByZXN0KTtcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2XG4gICAgICAgIHsuLi51bmhhbmRsZWR9XG4gICAgICAgIHJlZj17dGhpcy5iYXJSZWZ9XG4gICAgICAgIGNsYXNzTmFtZT17Y2xhc3Nlc31cbiAgICAgICAgb25DbGljaz17dGhpcy5oYW5kbGVDbGlja31cbiAgICAgICAgcm9sZT1cInRvb2xiYXJcIlxuICAgICAgPlxuICAgICAgICA8ZGl2XG4gICAgICAgICAgcmVmPXt0aGlzLmhhbmRsZVJlZn1cbiAgICAgICAgICBjbGFzc05hbWU9e2FkZFByZWZpeCgnaGFuZGxlJyl9XG4gICAgICAgICAgc3R5bGU9e3N0eWxlc31cbiAgICAgICAgICBvbk1vdXNlRG93bj17dGhpcy5oYW5kbGVNb3VzZURvd259XG4gICAgICAgICAgcm9sZT1cImJ1dHRvblwiXG4gICAgICAgICAgdGFiSW5kZXg9ey0xfVxuICAgICAgICAvPlxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTY3JvbGxiYXI7XG4iXSwidmVyc2lvbiI6M30=