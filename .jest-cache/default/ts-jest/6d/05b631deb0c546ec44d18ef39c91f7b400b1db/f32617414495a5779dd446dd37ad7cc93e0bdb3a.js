import React, { Children, Component } from 'react';
import { findDOMNode } from 'react-dom';
import PropTypes from 'prop-types';
import classNames from 'classnames';
import warning from '../_util/warning';
import { FIELD_DATA_PROP, FIELD_META_PROP } from './constants';
import PureRenderMixin from '../rc-components/util/PureRenderMixin';
import Animate from '../animate';
import { getPrefixCls } from '../configure';
export default class FormItem extends Component {
    constructor() {
        super(...arguments);
        this.state = { helpShow: false };
        this.onHelpAnimEnd = (_key, helpShow) => {
            this.setState({ helpShow });
        };
        // Resolve duplicated ids bug between different forms
        this.onLabelClick = (e) => {
            const { label, id: propId } = this.props;
            const id = propId || this.getId();
            if (!id) {
                return;
            }
            const controls = document.querySelectorAll(`[id="${id}"]`);
            if (controls.length !== 1) {
                // Only prevent in default situation
                // Avoid preventing event in `label={<a href="xx">link</a>}``
                if (typeof label === 'string') {
                    e.preventDefault();
                }
                const control = findDOMNode(this).querySelector(`[id="${id}"]`);
                if (control && control.focus) {
                    control.focus();
                }
            }
        };
    }
    componentDidMount() {
        const { children } = this.props;
        warning(this.getControls(children, true).length <= 1, '`Form.Item` cannot generate `validateStatus` and `help` automatically, ' +
            'while there are more than one `getFieldDecorator` in it.');
    }
    shouldComponentUpdate(...args) {
        return PureRenderMixin.shouldComponentUpdate.apply(this, args);
    }
    getHelpMsg() {
        const props = this.props;
        const onlyControl = this.getOnlyControl();
        if (props.help === undefined && onlyControl) {
            const errors = this.getField().errors;
            return errors ? errors.map((e) => e.message).join(', ') : '';
        }
        return props.help;
    }
    getControls(children, recursively) {
        let controls = [];
        const childrenArray = Children.toArray(children);
        for (let i = 0; i < childrenArray.length; i++) {
            if (!recursively && controls.length > 0) {
                break;
            }
            const child = childrenArray[i];
            if (child.type &&
                (child.type === FormItem || child.type.displayName === 'FormItem')) {
                continue;
            }
            if (!child.props) {
                continue;
            }
            if (FIELD_META_PROP in child.props) {
                // And means FIELD_DATA_PROP in chidl.props, too.
                controls.push(child);
            }
            else if (child.props.children) {
                controls = controls.concat(this.getControls(child.props.children, recursively));
            }
        }
        return controls;
    }
    getOnlyControl() {
        const { children } = this.props;
        const child = this.getControls(children, false)[0];
        return child !== undefined ? child : null;
    }
    getChildProp(prop) {
        const child = this.getOnlyControl();
        return child && child.props && child.props[prop];
    }
    getId() {
        return this.getChildProp('id');
    }
    getMeta() {
        return this.getChildProp(FIELD_META_PROP);
    }
    getField() {
        return this.getChildProp(FIELD_DATA_PROP);
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('form', prefixCls);
    }
    renderHelp() {
        const prefixCls = this.getPrefixCls();
        const help = this.getHelpMsg();
        const children = help ? (React.createElement("div", { className: `${prefixCls}-explain`, key: "error" }, help)) : null;
        return (React.createElement(Animate, { transitionName: "show-error", component: "", transitionAppear: true, key: "error", onEnd: this.onHelpAnimEnd }, children));
    }
    renderExtra() {
        const { extra } = this.props;
        const prefixCls = this.getPrefixCls();
        return extra ? React.createElement("div", { className: `${prefixCls}-extra` }, extra) : null;
    }
    getValidateStatus() {
        const onlyControl = this.getOnlyControl();
        if (onlyControl) {
            const field = this.getField();
            if (field.validating) {
                return "validating" /* validating */;
            }
            if (field.errors) {
                return "error" /* error */;
            }
            const fieldValue = 'value' in field ? field.value : this.getMeta().initialValue;
            if (fieldValue !== undefined && fieldValue !== null && fieldValue !== '') {
                return "success" /* success */;
            }
        }
    }
    renderValidateWrapper(c1, c2, c3) {
        const props = this.props;
        const prefixCls = this.getPrefixCls();
        const onlyControl = this.getOnlyControl();
        const validateStatus = props.validateStatus === undefined && onlyControl
            ? this.getValidateStatus()
            : props.validateStatus;
        let classes = `${prefixCls}-item-control`;
        if (validateStatus) {
            classes = classNames(`${prefixCls}-item-control`, {
                'has-feedback': props.hasFeedback || validateStatus === "validating" /* validating */,
                'has-success': validateStatus === "success" /* success */,
                'has-warning': validateStatus === "warning" /* warning */,
                'has-error': validateStatus === "error" /* error */,
                'is-validating': validateStatus === "validating" /* validating */,
            });
        }
        return (React.createElement("div", { className: classes },
            React.createElement("span", { className: `${prefixCls}-item-children` }, c1),
            c2,
            c3));
    }
    renderWrapper(children) {
        const { wrapperCol } = this.props;
        const prefixCls = this.getPrefixCls();
        const required = this.isRequired();
        const className = classNames(`${prefixCls}-item-control-wrapper`, wrapperCol && wrapperCol.className, {
            'is-required': required,
        });
        return (React.createElement("div", { className: className, key: "wrapper" }, children));
    }
    isRequired() {
        const { required } = this.props;
        if (required !== undefined) {
            return required;
        }
        if (this.getOnlyControl()) {
            const meta = this.getMeta() || {};
            const validate = meta.validate || [];
            return validate
                .filter((item) => !!item.rules)
                .some((item) => {
                return item.rules.some((rule) => rule.required);
            });
        }
        return false;
    }
    renderChildren() {
        const { children } = this.props;
        return [
            // this.renderLabel(),
            this.renderWrapper(this.renderValidateWrapper(children, this.renderHelp(), this.renderExtra())),
        ];
    }
    renderFormItem(children) {
        const props = this.props;
        const { helpShow } = this.state;
        const prefixCls = this.getPrefixCls();
        const style = props.style;
        const itemClassName = {
            [`${prefixCls}-item`]: true,
            [`${prefixCls}-item-with-help`]: !!this.getHelpMsg() || helpShow,
            [`${prefixCls}-item-no-colon`]: !props.colon,
            [`${props.className}`]: !!props.className,
        };
        return (React.createElement("div", { className: classNames(itemClassName), style: style }, children));
    }
    render() {
        const children = this.renderChildren();
        return this.renderFormItem(children);
    }
}
FormItem.displayName = 'FormItem';
FormItem.defaultProps = {
    hasFeedback: false,
    colon: true,
};
FormItem.propTypes = {
    prefixCls: PropTypes.string,
    label: PropTypes.oneOfType([PropTypes.string, PropTypes.node]),
    help: PropTypes.oneOfType([PropTypes.node, PropTypes.bool]),
    validateStatus: PropTypes.oneOf([
        "success" /* success */,
        "warning" /* warning */,
        "error" /* error */,
        "validating" /* validating */,
    ]),
    hasFeedback: PropTypes.bool,
    wrapperCol: PropTypes.object,
    className: PropTypes.string,
    id: PropTypes.string,
    children: PropTypes.node,
    colon: PropTypes.bool,
};
FormItem.contextTypes = {
    vertical: PropTypes.bool,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvZm9ybS9Gb3JtSXRlbS50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUEwQyxNQUFNLE9BQU8sQ0FBQztBQUMzRixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hDLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQztBQUNuQyxPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFFcEMsT0FBTyxPQUFPLE1BQU0sa0JBQWtCLENBQUM7QUFDdkMsT0FBTyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxlQUFlLE1BQU0sdUNBQXVDLENBQUM7QUFDcEUsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBRWpDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFxQjVDLE1BQU0sQ0FBQyxPQUFPLE9BQU8sUUFBUyxTQUFRLFNBQTZCO0lBQW5FOztRQWdDRSxVQUFLLEdBQUcsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFrRjVCLGtCQUFhLEdBQUcsQ0FBQyxJQUFZLEVBQUUsUUFBaUIsRUFBRSxFQUFFO1lBQ2xELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQztRQThHRixxREFBcUQ7UUFFckQsaUJBQVksR0FBRyxDQUFDLENBQU0sRUFBRSxFQUFFO1lBQ3hCLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDekMsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNQLE9BQU87YUFDUjtZQUNELE1BQU0sUUFBUSxHQUFHLFFB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QkFBUyxHQUFHO0lBQ2pCLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMzQixLQUFLLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlELElBQUksRUFBRSxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsY0FBYyxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUM7Ozs7O0tBSy9CLENBQUM7SUFDRixXQUFXLEVBQUUsU0FBUyxDQUFDLElBQUk7SUFDM0IsVUFBVSxFQUFFLFNBQVMsQ0FBQyxNQUFNO0lBQzVCLFNBQVMsRUFBRSxTQUFTLENBQUMsTUFBTTtJQUMzQixFQUFFLEVBQUUsU0FBUyxDQUFDLE1BQU07SUFDcEIsUUFBUSxFQUFFLFNBQVMsQ0FBQyxJQUFJO0lBQ3hCLEtBQUssRUFBRSxTQUFTLENBQUMsSUFBSTtDQUN0QixDQUFDO0FBRUsscUJBQVksR0FBRztJQUNwQixRQUFRLEVBQUUsU0FBUyxDQUFDLElBQUk7Q0FDekIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaHVpaHVhd2svRG9jdW1lbnRzL29wdC9jaG9lcm9kb24tdWkvY29tcG9uZW50cy9mb3JtL0Zvcm1JdGVtLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ2hpbGRyZW4sIENvbXBvbmVudCwgQ1NTUHJvcGVydGllcywgUmVhY3RFbGVtZW50LCBSZWFjdE5vZGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBmaW5kRE9NTm9kZSB9IGZyb20gJ3JlYWN0LWRvbSc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBDb2xQcm9wcyB9IGZyb20gJy4uL2dyaWQvY29sJztcbmltcG9ydCB3YXJuaW5nIGZyb20gJy4uL191dGlsL3dhcm5pbmcnO1xuaW1wb3J0IHsgRklFTERfREFUQV9QUk9QLCBGSUVMRF9NRVRBX1BST1AgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgUHVyZVJlbmRlck1peGluIGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdXRpbC9QdXJlUmVuZGVyTWl4aW4nO1xuaW1wb3J0IEFuaW1hdGUgZnJvbSAnLi4vYW5pbWF0ZSc7XG5pbXBvcnQgeyBGb3JtSXRlbVZhbGlkYXRlU3RhdHVzIH0gZnJvbSAnLi9lbnVtJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybUl0ZW1Qcm9wcyB7XG4gIHByZWZpeENscz86IHN0cmluZztcbiAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICBpZD86IHN0cmluZztcbiAgbGFiZWw/OiBSZWFjdE5vZGU7XG4gIHdyYXBwZXJDb2w/OiBDb2xQcm9wcztcbiAgaGVscD86IFJlYWN0Tm9kZTtcbiAgZXh0cmE/OiBSZWFjdE5vZGU7XG4gIHZhbGlkYXRlU3RhdHVzPzogRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cztcbiAgaGFzRmVlZGJhY2s/OiBib29sZWFuO1xuICByZXF1aXJlZD86IGJvb2xlYW47XG4gIHN0eWxlPzogQ1NTUHJvcGVydGllcztcbiAgY29sb24/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1JdGVtQ29udGV4dCB7XG4gIHZlcnRpY2FsOiBib29sZWFuO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBGb3JtSXRlbSBleHRlbmRzIENvbXBvbmVudDxGb3JtSXRlbVByb3BzLCBhbnk+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ0Zvcm1JdGVtJztcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGhhc0ZlZWRiYWNrOiBmYWxzZSxcbiAgICBjb2xvbjogdHJ1ZSxcbiAgfTtcblxuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIHByZWZpeENsczogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBsYWJlbDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLm5vZGVdKSxcbiAgICBoZWxwOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubm9kZSwgUHJvcFR5cGVzLmJvb2xdKSxcbiAgICB2YWxpZGF0ZVN0YXR1czogUHJvcFR5cGVzLm9uZU9mKFtcbiAgICAgIEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMuc3VjY2VzcyxcbiAgICAgIEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMud2FybmluZyxcbiAgICAgIEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMuZXJyb3IsXG4gICAgICBGb3JtSXRlbVZhbGlkYXRlU3RhdHVzLnZhbGlkYXRpbmcsXG4gICAgXSksXG4gICAgaGFzRmVlZGJhY2s6IFByb3BUeXBlcy5ib29sLFxuICAgIHdyYXBwZXJDb2w6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGlkOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMubm9kZSxcbiAgICBjb2xvbjogUHJvcFR5cGVzLmJvb2wsXG4gIH07XG5cbiAgc3RhdGljIGNvbnRleHRUeXBlcyA9IHtcbiAgICB2ZXJ0aWNhbDogUHJvcFR5cGVzLmJvb2wsXG4gIH07XG5cbiAgY29udGV4dDogRm9ybUl0ZW1Db250ZXh0O1xuXG4gIHN0YXRlID0geyBoZWxwU2hvdzogZmFsc2UgfTtcblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzO1xuICAgIHdhcm5pbmcoXG4gICAgICB0aGlzLmdldENvbnRyb2xzKGNoaWxkcmVuLCB0cnVlKS5sZW5ndGggPD0gMSxcbiAgICAgICdgRm9ybS5JdGVtYCBjYW5ub3QgZ2VuZXJhdGUgYHZhbGlkYXRlU3RhdHVzYCBhbmQgYGhlbHBgIGF1dG9tYXRpY2FsbHksICcgK1xuICAgICAgICAnd2hpbGUgdGhlcmUgYXJlIG1vcmUgdGhhbiBvbmUgYGdldEZpZWxkRGVjb3JhdG9yYCBpbiBpdC4nLFxuICAgICk7XG4gIH1cblxuICBzaG91bGRDb21wb25lbnRVcGRhdGUoLi4uYXJnczogYW55W10pIHtcbiAgICByZXR1cm4gUHVyZVJlbmRlck1peGluLnNob3VsZENvbXBvbmVudFVwZGF0ZS5hcHBseSh0aGlzLCBhcmdzKTtcbiAgfVxuXG4gIGdldEhlbHBNc2coKSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IG9ubHlDb250cm9sID0gdGhpcy5nZXRPbmx5Q29udHJvbCgpO1xuICAgIGlmIChwcm9wcy5oZWxwID09PSB1bmRlZmluZWQgJiYgb25seUNvbnRyb2wpIHtcbiAgICAgIGNvbnN0IGVycm9ycyA9IHRoaXMuZ2V0RmllbGQoKS5lcnJvcnM7XG4gICAgICByZXR1cm4gZXJyb3JzID8gZXJyb3JzLm1hcCgoZTogYW55KSA9PiBlLm1lc3NhZ2UpLmpvaW4oJywgJykgOiAnJztcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcHMuaGVscDtcbiAgfVxuXG4gIGdldENvbnRyb2xzKGNoaWxkcmVuOiBSZWFjdE5vZGUsIHJlY3Vyc2l2ZWx5OiBib29sZWFuKSB7XG4gICAgbGV0IGNvbnRyb2xzOiBSZWFjdEVsZW1lbnQ8YW55PltdID0gW107XG4gICAgY29uc3QgY2hpbGRyZW5BcnJheSA9IENoaWxkcmVuLnRvQXJyYXkoY2hpbGRyZW4pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW5BcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKCFyZWN1cnNpdmVseSAmJiBjb250cm9scy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuQXJyYXlbaV0gYXMgUmVhY3RFbGVtZW50PGFueT47XG4gICAgICBpZiAoXG4gICAgICAgIGNoaWxkLnR5cGUgJiZcbiAgICAgICAgKChjaGlsZC50eXBlIGFzIGFueSkgPT09IEZvcm1JdGVtIHx8IChjaGlsZC50eXBlIGFzIGFueSkuZGlzcGxheU5hbWUgPT09ICdGb3JtSXRlbScpXG4gICAgICApIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoIWNoaWxkLnByb3BzKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKEZJRUxEX01FVEFfUFJPUCBpbiBjaGlsZC5wcm9wcykge1xuICAgICAgICAvLyBBbmQgbWVhbnMgRklFTERfREFUQV9QUk9QIGluIGNoaWRsLnByb3BzLCB0b28uXG4gICAgICAgIGNvbnRyb2xzLnB1c2goY2hpbGQpO1xuICAgICAgfSBlbHNlIGlmIChjaGlsZC5wcm9wcy5jaGlsZHJlbikge1xuICAgICAgICBjb250cm9scyA9IGNvbnRyb2xzLmNvbmNhdCh0aGlzLmdldENvbnRyb2xzKGNoaWxkLnByb3BzLmNoaWxkcmVuLCByZWN1cnNpdmVseSkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY29udHJvbHM7XG4gIH1cblxuICBnZXRPbmx5Q29udHJvbCgpIHtcbiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGNoaWxkID0gdGhpcy5nZXRDb250cm9scyhjaGlsZHJlbiwgZmFsc2UpWzBdO1xuICAgIHJldHVybiBjaGlsZCAhPT0gdW5kZWZpbmVkID8gY2hpbGQgOiBudWxsO1xuICB9XG5cbiAgZ2V0Q2hpbGRQcm9wKHByb3A6IHN0cmluZykge1xuICAgIGNvbnN0IGNoaWxkID0gdGhpcy5nZXRPbmx5Q29udHJvbCgpIGFzIFJlYWN0RWxlbWVudDxhbnk+O1xuICAgIHJldHVybiBjaGlsZCAmJiBjaGlsZC5wcm9wcyAmJiBjaGlsZC5wcm9wc1twcm9wXTtcbiAgfVxuXG4gIGdldElkKCkge1xuICAgIHJldHVybiB0aGlzLmdldENoaWxkUHJvcCgnaWQnKTtcbiAgfVxuXG4gIGdldE1ldGEoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2hpbGRQcm9wKEZJRUxEX01FVEFfUFJPUCk7XG4gIH1cblxuICBnZXRGaWVsZCgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRDaGlsZFByb3AoRklFTERfREFUQV9QUk9QKTtcbiAgfVxuXG4gIGdldFByZWZpeENscygpIHtcbiAgICBjb25zdCB7IHByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gZ2V0UHJlZml4Q2xzKCdmb3JtJywgcHJlZml4Q2xzKTtcbiAgfVxuXG4gIG9uSGVscEFuaW1FbmQgPSAoX2tleTogc3RyaW5nLCBoZWxwU2hvdzogYm9vbGVhbikgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoeyBoZWxwU2hvdyB9KTtcbiAgfTtcblxuICByZW5kZXJIZWxwKCkge1xuICAgIGNvbnN0IHByZWZpeENscyA9IHRoaXMuZ2V0UHJlZml4Q2xzKCk7XG4gICAgY29uc3QgaGVscCA9IHRoaXMuZ2V0SGVscE1zZygpO1xuICAgIGNvbnN0IGNoaWxkcmVuID0gaGVscCA/IChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWV4cGxhaW5gfSBrZXk9XCJlcnJvclwiPlxuICAgICAgICB7aGVscH1cbiAgICAgIDwvZGl2PlxuICAgICkgOiBudWxsO1xuICAgIHJldHVybiAoXG4gICAgICA8QW5pbWF0ZVxuICAgICAgICB0cmFuc2l0aW9uTmFtZT1cInNob3ctZXJyb3JcIlxuICAgICAgICBjb21wb25lbnQ9XCJcIlxuICAgICAgICB0cmFuc2l0aW9uQXBwZWFyXG4gICAgICAgIGtleT1cImVycm9yXCJcbiAgICAgICAgb25FbmQ9e3RoaXMub25IZWxwQW5pbUVuZH1cbiAgICAgID5cbiAgICAgICAge2NoaWxkcmVufVxuICAgICAgPC9BbmltYXRlPlxuICAgICk7XG4gIH1cblxuICByZW5kZXJFeHRyYSgpIHtcbiAgICBjb25zdCB7IGV4dHJhIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHByZWZpeENscyA9IHRoaXMuZ2V0UHJlZml4Q2xzKCk7XG4gICAgcmV0dXJuIGV4dHJhID8gPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tZXh0cmFgfT57ZXh0cmF9PC9kaXY+IDogbnVsbDtcbiAgfVxuXG4gIGdldFZhbGlkYXRlU3RhdHVzKCk6IEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IG9ubHlDb250cm9sID0gdGhpcy5nZXRPbmx5Q29udHJvbCgpO1xuICAgIGlmIChvbmx5Q29udHJvbCkge1xuICAgICAgY29uc3QgZmllbGQgPSB0aGlzLmdldEZpZWxkKCk7XG4gICAgICBpZiAoZmllbGQudmFsaWRhdGluZykge1xuICAgICAgICByZXR1cm4gRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cy52YWxpZGF0aW5nO1xuICAgICAgfVxuICAgICAgaWYgKGZpZWxkLmVycm9ycykge1xuICAgICAgICByZXR1cm4gRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cy5lcnJvcjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZpZWxkVmFsdWUgPSAndmFsdWUnIGluIGZpZWxkID8gZmllbGQudmFsdWUgOiB0aGlzLmdldE1ldGEoKS5pbml0aWFsVmFsdWU7XG4gICAgICBpZiAoZmllbGRWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIGZpZWxkVmFsdWUgIT09IG51bGwgJiYgZmllbGRWYWx1ZSAhPT0gJycpIHtcbiAgICAgICAgcmV0dXJuIEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMuc3VjY2VzcztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZW5kZXJWYWxpZGF0ZVdyYXBwZXIoYzE6IFJlYWN0Tm9kZSwgYzI6IFJlYWN0Tm9kZSwgYzM6IFJlYWN0Tm9kZSkge1xuICAgIGNvbnN0IHByb3BzID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGNvbnN0IG9ubHlDb250cm9sID0gdGhpcy5nZXRPbmx5Q29udHJvbCgpO1xuICAgIGNvbnN0IHZhbGlkYXRlU3RhdHVzID1cbiAgICAgIHByb3BzLnZhbGlkYXRlU3RhdHVzID09PSB1bmRlZmluZWQgJiYgb25seUNvbnRyb2xcbiAgICAgICAgPyB0aGlzLmdldFZhbGlkYXRlU3RhdHVzKClcbiAgICAgICAgOiBwcm9wcy52YWxpZGF0ZVN0YXR1cztcblxuICAgIGxldCBjbGFzc2VzID0gYCR7cHJlZml4Q2xzfS1pdGVtLWNvbnRyb2xgO1xuICAgIGlmICh2YWxpZGF0ZVN0YXR1cykge1xuICAgICAgY2xhc3NlcyA9IGNsYXNzTmFtZXMoYCR7cHJlZml4Q2xzfS1pdGVtLWNvbnRyb2xgLCB7XG4gICAgICAgICdoYXMtZmVlZGJhY2snOiBwcm9wcy5oYXNGZWVkYmFjayB8fCB2YWxpZGF0ZVN0YXR1cyA9PT0gRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cy52YWxpZGF0aW5nLFxuICAgICAgICAnaGFzLXN1Y2Nlc3MnOiB2YWxpZGF0ZVN0YXR1cyA9PT0gRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cy5zdWNjZXNzLFxuICAgICAgICAnaGFzLXdhcm5pbmcnOiB2YWxpZGF0ZVN0YXR1cyA9PT0gRm9ybUl0ZW1WYWxpZGF0ZVN0YXR1cy53YXJuaW5nLFxuICAgICAgICAnaGFzLWVycm9yJzogdmFsaWRhdGVTdGF0dXMgPT09IEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMuZXJyb3IsXG4gICAgICAgICdpcy12YWxpZGF0aW5nJzogdmFsaWRhdGVTdGF0dXMgPT09IEZvcm1JdGVtVmFsaWRhdGVTdGF0dXMudmFsaWRhdGluZyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzZXN9PlxuICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30taXRlbS1jaGlsZHJlbmB9PntjMX08L3NwYW4+XG4gICAgICAgIHtjMn1cbiAgICAgICAge2MzfVxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxuXG4gIHJlbmRlcldyYXBwZXIoY2hpbGRyZW46IFJlYWN0Tm9kZSkge1xuICAgIGNvbnN0IHsgd3JhcHBlckNvbCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGNvbnN0IHJlcXVpcmVkID0gdGhpcy5pc1JlcXVpcmVkKCk7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gY2xhc3NOYW1lcyhcbiAgICAgIGAke3ByZWZpeENsc30taXRlbS1jb250cm9sLXdyYXBwZXJgLFxuICAgICAgd3JhcHBlckNvbCAmJiB3cmFwcGVyQ29sLmNsYXNzTmFtZSxcbiAgICAgIHtcbiAgICAgICAgJ2lzLXJlcXVpcmVkJzogcmVxdWlyZWQsXG4gICAgICB9LFxuICAgICk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWV9IGtleT1cIndyYXBwZXJcIj5cbiAgICAgICAge2NoaWxkcmVufVxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxuXG4gIGlzUmVxdWlyZWQoKSB7XG4gICAgY29uc3QgeyByZXF1aXJlZCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAocmVxdWlyZWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHJlcXVpcmVkO1xuICAgIH1cbiAgICBpZiAodGhpcy5nZXRPbmx5Q29udHJvbCgpKSB7XG4gICAgICBjb25zdCBtZXRhID0gdGhpcy5nZXRNZXRhKCkgfHwge307XG4gICAgICBjb25zdCB2YWxpZGF0ZSA9IG1ldGEudmFsaWRhdGUgfHwgW107XG5cbiAgICAgIHJldHVybiB2YWxpZGF0ZVxuICAgICAgICAuZmlsdGVyKChpdGVtOiBhbnkpID0+ICEhaXRlbS5ydWxlcylcbiAgICAgICAgLnNvbWUoKGl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgIHJldHVybiBpdGVtLnJ1bGVzLnNvbWUoKHJ1bGU6IGFueSkgPT4gcnVsZS5yZXF1aXJlZCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBSZXNvbHZlIGR1cGxpY2F0ZWQgaWRzIGJ1ZyBiZXR3ZWVuIGRpZmZlcmVudCBmb3Jtc1xuXG4gIG9uTGFiZWxDbGljayA9IChlOiBhbnkpID0+IHtcbiAgICBjb25zdCB7IGxhYmVsLCBpZDogcHJvcElkIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGlkID0gcHJvcElkIHx8IHRoaXMuZ2V0SWQoKTtcbiAgICBpZiAoIWlkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGNvbnRyb2xzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChgW2lkPVwiJHtpZH1cIl1gKTtcbiAgICBpZiAoY29udHJvbHMubGVuZ3RoICE9PSAxKSB7XG4gICAgICAvLyBPbmx5IHByZXZlbnQgaW4gZGVmYXVsdCBzaXR1YXRpb25cbiAgICAgIC8vIEF2b2lkIHByZXZlbnRpbmcgZXZlbnQgaW4gYGxhYmVsPXs8YSBocmVmPVwieHhcIj5saW5rPC9hPn1gYFxuICAgICAgaWYgKHR5cGVvZiBsYWJlbCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgfVxuICAgICAgY29uc3QgY29udHJvbCA9IChmaW5kRE9NTm9kZSh0aGlzKSBhcyBIVE1MRWxlbWVudCkucXVlcnlTZWxlY3RvcihcbiAgICAgICAgYFtpZD1cIiR7aWR9XCJdYCxcbiAgICAgICkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICBpZiAoY29udHJvbCAmJiBjb250cm9sLmZvY3VzKSB7XG4gICAgICAgIGNvbnRyb2wuZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcmVuZGVyQ2hpbGRyZW4oKSB7XG4gICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gW1xuICAgICAgLy8gdGhpcy5yZW5kZXJMYWJlbCgpLFxuICAgICAgdGhpcy5yZW5kZXJXcmFwcGVyKFxuICAgICAgICB0aGlzLnJlbmRlclZhbGlkYXRlV3JhcHBlcihjaGlsZHJlbiwgdGhpcy5yZW5kZXJIZWxwKCksIHRoaXMucmVuZGVyRXh0cmEoKSksXG4gICAgICApLFxuICAgIF07XG4gIH1cblxuICByZW5kZXJGb3JtSXRlbShjaGlsZHJlbjogUmVhY3ROb2RlKSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgaGVscFNob3cgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICBjb25zdCBzdHlsZSA9IHByb3BzLnN0eWxlO1xuICAgIGNvbnN0IGl0ZW1DbGFzc05hbWUgPSB7XG4gICAgICBbYCR7cHJlZml4Q2xzfS1pdGVtYF06IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1pdGVtLXdpdGgtaGVscGBdOiAhIXRoaXMuZ2V0SGVscE1zZygpIHx8IGhlbHBTaG93LFxuICAgICAgW2Ake3ByZWZpeENsc30taXRlbS1uby1jb2xvbmBdOiAhcHJvcHMuY29sb24sXG4gICAgICBbYCR7cHJvcHMuY2xhc3NOYW1lfWBdOiAhIXByb3BzLmNsYXNzTmFtZSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWVzKGl0ZW1DbGFzc05hbWUpfSBzdHlsZT17c3R5bGV9PlxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5yZW5kZXJDaGlsZHJlbigpO1xuICAgIHJldHVybiB0aGlzLnJlbmRlckZvcm1JdGVtKGNoaWxkcmVuKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9