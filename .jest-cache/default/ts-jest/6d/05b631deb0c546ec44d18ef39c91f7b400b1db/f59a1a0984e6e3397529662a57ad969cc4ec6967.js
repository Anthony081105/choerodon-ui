import { __decorate } from "tslib";
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { observer } from 'mobx-react';
import { findDOMNode } from 'react-dom';
import QuillImageDropAndPaste from 'quill-image-drop-and-paste';
import 'react-quill/dist/quill.snow.css';
import isEqual from 'lodash/isEqual';
import isObject from 'lodash/isObject';
import omit from 'lodash/omit';
import LightBox from 'react-image-lightbox';
import autobind from '../_util/autobind';
import RichTextViewer from './RichTextViewer';
import Toolbar from './toolbar';
let ReactQuill;
let Quill;
if (typeof window !== 'undefined') {
    // eslint-disable-next-line global-require
    ReactQuill = require('react-quill');
    // eslint-disable-next-line global-require
    Quill = require('react-quill').Quill;
    /**
     * 注册图片拖拽、粘贴
     */
    Quill.register('modules/imageDropAndPaste', QuillImageDropAndPaste);
}
let BaseEditor = class BaseEditor extends Component {
    constructor() {
        super(...arguments);
        this.state = {
            imgOpen: false,
            src: '',
        };
        this.handleOpenLightBox = (e) => {
            if (e.target.nodeName === 'IMG') {
                e.stopPropagation();
                this.setState({
                    imgOpen: true,
                    src: e.target.src,
                });
            }
        };
        this.saveRef = name => (ref) => {
            this[name] = ref;
            const { saveRef } = this.props;
            if (saveRef) {
                saveRef(ref);
            }
        };
    }
    setValue(value) {
        if (this.editor) {
            this.editor.getEditor().setContents(value);
        }
    }
    ;
    handleRichTextChange(_, __, ___, editor) {
        const rtDelta = editor.getContents();
        this.deltaOps = rtDelta.ops;
        const { onChange } = this.props;
        if (onChange && rtDelta && rtDelta.ops) {
            onChange(rtDelta.ops);
        }
    }
    ;
    componentDidUpdate() {
        const { value } = this.props;
        let deltaOps;
        if (!isObject(value) && this.editor) {
            deltaOps = this.editor.getEditor().clipboard.convert(value).ops;
        }
        if ('value' in this.props && !isEqual(this.deltaOps, deltaOps || value) && this.editor) {
            this.editor.getEditor().setContents(deltaOps || value);
        }
    }
    getOtherProps() {
        return omit(this.props, ['style', 'onBlur', 'toolbar', 'className', 'defaultValue', 'onChange', 'value']);
    }
    componentWillUnmount() {
        const thisNode = findDOMNode(this);
        if (thisNode) {
            thisNode.removeEventListener('click', this.handleOpenLightBox);
        }
    }
    componentDidMount() {
        const { autoFocus } = this.props;
        if (autoFocus && this.editor) {
            setTimeout(() => {
                this.editor.focus();
            });
        }
        const thisNode = findDOMNode(this);
        if (thisNode) {
            thisNode.addEventListener('click', this.handleOpenLightBox);
        }
    }
    renderContent() {
        const { style, className, toolbarId, toolbar, dataSet, value, mode } = this.props;
        let deltaOps;
        if (!isObject(value) && this.editor) {
            deltaOps = this.editor.getEditor().clipboard.convert(value).ops;
        }
        if (mode === 'preview') {
            return (React.createElement(RichTextViewer, { className: `${className}-preview`, style: style, deltaOps: deltaOps || value }));
        }
        if (ReactQuill) {
            return (React.createElement(React.Fragment, null,
                React.createElement(Toolbar, { id: toolbarId, dataSet: dataSet, toolbar: toolbar, prefixCls: className }),
                React.createElement(ReactQuill, Object.assign({}, this.getOtherProps(), { className: `${className}-quill`, defaultValue: value, ref: this.saveRef('editor'), onChange: this.handleRichTextChange, bounds: className }))));
        }
    }
    render() {
        const { imgOpen, src } = this.state;
        const { className, style } = this.props;
        const content = this.renderContent();
        return (React.createElement(React.Fragment, null,
            React.createElement("div", { className: className, style: style }, content),
            imgOpen && (React.createElement(LightBox, { mainSrc: src, onCloseRequest: () => this.setState({ imgOpen: false }), imageTitle: "images" }))));
    }
};
BaseEditor.propTypes = {
    value: PropTypes.any,
    onChange: PropTypes.func,
    options: PropTypes.object,
    saveRef: PropTypes.func,
    autoFocus: PropTypes.bool,
    mode: PropTypes.string,
    toolbarId: PropTypes.string,
    toolbar: PropTypes.oneOfType([
        PropTypes.oneOf([
            "none" /* none */,
            "normal" /* normal */,
        ]),
        PropTypes.func,
    ]),
};
__decorate([
    autobind
], BaseEditor.prototype, "setValue", null);
__decorate([
    autobind
], BaseEditor.prototype, "handleRichTextChange", null);
__decorate([
    autobind
], BaseEditor.prototype, "renderContent", null);
BaseEditor = __decorate([
    observer
], BaseEditor);
export default BaseEditor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3JpY2gtdGV4dC9CYXNlRWRpdG9yLnRzeCIsIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQWtCLE1BQU0sT0FBTyxDQUFDO0FBQ3pELE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQztBQUNuQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFeEMsT0FBTyxzQkFBc0IsTUFBTSw0QkFBNEIsQ0FBQztBQUNoRSxPQUFPLGlDQUFpQyxDQUFDO0FBQ3pDLE9BQU8sT0FBTyxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sUUFBUSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZDLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLFFBQVEsTUFBTSxzQkFBc0IsQ0FBQztBQUU1QyxPQUFPLFFBQVEsTUFBTSxtQkFBbUIsQ0FBQztBQUN6QyxPQUFPLGNBQWMsTUFBTSxrQkFBa0IsQ0FBQztBQUc5QyxPQUFPLE9BQU8sTUFBTSxXQUFXLENBQUM7QUFJaEMsSUFBSSxVQUEyQyxDQUFDO0FBRWhELElBQUksS0FBVSxDQUFDO0FBRWYsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7SUFDakMsMENBQTBDO0lBQzFDLFVBQVUsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDcEMsMENBQTBDO0lBQzFDLEtBQUssR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsS0FBSyxDQUFDO0lBRXJDOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFFBQVEsQ0FBQywyQkFBMkIsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0NBQ3JFO0FBdUNELElBQXFCLFVBQVUsR0FBL0IsTUFBcUIsVUFBVyxTQUFRLFNBQTBCO0lBQWxFOztRQWtCRSxVQUFLLEdBQUc7WUFDTixPQUFP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M0IsT0FBTyxFQUFFLFNBQVMsQ0FBQyxTQUFTLENBQUM7UUFDM0IsU0FBUyxDQUFDLEtBQUssQ0FBQzs7O1NBR2YsQ0FBQztRQUNGLFNBQVMsQ0FBQyxJQUFJO0tBQ2YsQ0FBQztDQUNILENBQUM7QUFZRjtJQURDLFFBQVE7MENBS1I7QUFHRDtJQURDLFFBQVE7c0RBUVI7QUFnREQ7SUFEQyxRQUFROytDQStCUjtBQXhIa0IsVUFBVTtJQUQ5QixRQUFRO0dBQ1ksVUFBVSxDQXVKOUI7ZUF2Sm9CLFVBQVUiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMtcHJvL3JpY2gtdGV4dC9CYXNlRWRpdG9yLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50LCBDb21wb25lbnRDbGFzcyB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgeyBvYnNlcnZlciB9IGZyb20gJ21vYngtcmVhY3QnO1xuaW1wb3J0IHsgZmluZERPTU5vZGUgfSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IHsgUmFuZ2UsIFJlYWN0UXVpbGxQcm9wcywgVW5wcml2aWxlZ2VkRWRpdG9yIH0gZnJvbSAncmVhY3QtcXVpbGwvbGliJztcbmltcG9ydCBRdWlsbEltYWdlRHJvcEFuZFBhc3RlIGZyb20gJ3F1aWxsLWltYWdlLWRyb3AtYW5kLXBhc3RlJztcbmltcG9ydCAncmVhY3QtcXVpbGwvZGlzdC9xdWlsbC5zbm93LmNzcyc7XG5pbXBvcnQgaXNFcXVhbCBmcm9tICdsb2Rhc2gvaXNFcXVhbCc7XG5pbXBvcnQgaXNPYmplY3QgZnJvbSAnbG9kYXNoL2lzT2JqZWN0JztcbmltcG9ydCBvbWl0IGZyb20gJ2xvZGFzaC9vbWl0JztcbmltcG9ydCBMaWdodEJveCBmcm9tICdyZWFjdC1pbWFnZS1saWdodGJveCc7XG5pbXBvcnQgeyBEZWx0YU9wZXJhdGlvbiwgRGVsdGFTdGF0aWMsIFNvdXJjZXMsIFN0cmluZ01hcCB9IGZyb20gJy4vcXVpbGwnO1xuaW1wb3J0IGF1dG9iaW5kIGZyb20gJy4uL191dGlsL2F1dG9iaW5kJztcbmltcG9ydCBSaWNoVGV4dFZpZXdlciBmcm9tICcuL1JpY2hUZXh0Vmlld2VyJztcbmltcG9ydCB7IFJpY2hUZXh0VG9vbGJhclR5cGUgfSBmcm9tICcuL2VudW0nO1xuaW1wb3J0IHsgUmljaFRleHRUb29sYmFySG9vayB9IGZyb20gJy4vUmljaFRleHQnO1xuaW1wb3J0IFRvb2xiYXIgZnJvbSAnLi90b29sYmFyJztcbmltcG9ydCBEYXRhU2V0IGZyb20gJy4uL2RhdGEtc2V0L0RhdGFTZXQnO1xuaW1wb3J0IFJlY29yZCBmcm9tICcuLi9kYXRhLXNldC9SZWNvcmQnO1xuXG5sZXQgUmVhY3RRdWlsbDogQ29tcG9uZW50Q2xhc3M8UmVhY3RRdWlsbFByb3BzPjtcblxubGV0IFF1aWxsOiBhbnk7XG5cbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ2xvYmFsLXJlcXVpcmVcbiAgUmVhY3RRdWlsbCA9IHJlcXVpcmUoJ3JlYWN0LXF1aWxsJyk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZVxuICBRdWlsbCA9IHJlcXVpcmUoJ3JlYWN0LXF1aWxsJykuUXVpbGw7XG5cbiAgLyoqXG4gICAqIOazqOWGjOWbvueJh+aLluaLveOAgeeymOi0tFxuICAgKi9cbiAgUXVpbGwucmVnaXN0ZXIoJ21vZHVsZXMvaW1hZ2VEcm9wQW5kUGFzdGUnLCBRdWlsbEltYWdlRHJvcEFuZFBhc3RlKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCYXNlRWRpdG9yUHJvcHMge1xuICBkYXRhU2V0PzogRGF0YVNldDtcbiAgcmVjb3JkPzogUmVjb3JkO1xuICB2YWx1ZTogRGVsdGFTdGF0aWM7XG4gIHNhdmVSZWY/OiBGdW5jdGlvbixcbiAgb25DaGFuZ2U/OiBGdW5jdGlvbixcbiAgYm91bmRzPzogc3RyaW5nIHwgSFRNTEVsZW1lbnQ7XG4gIGNoaWxkcmVuPzogUmVhY3QuUmVhY3RFbGVtZW50PGFueT47XG4gIGNsYXNzTmFtZT86IHN0cmluZztcbiAgZGVmYXVsdFZhbHVlPzogc3RyaW5nIHwgRGVsdGFTdGF0aWM7XG4gIGZvcm1hdHM/OiBzdHJpbmdbXTtcbiAgaWQ/OiBzdHJpbmc7XG4gIG1vZHVsZXM/OiBTdHJpbmdNYXA7XG5cbiAgb25DaGFuZ2VTZWxlY3Rpb24/KHNlbGVjdGlvbjogUmFuZ2UsIHNvdXJjZTogU291cmNlcywgZWRpdG9yOiBVbnByaXZpbGVnZWRFZGl0b3IpOiB2b2lkO1xuXG4gIG9uRm9jdXM/KHNlbGVjdGlvbjogUmFuZ2UsIHNvdXJjZTogU291cmNlcywgZWRpdG9yOiBVbnByaXZpbGVnZWRFZGl0b3IpOiB2b2lkO1xuXG4gIG9uQmx1cj8ocHJldmlvdXNTZWxlY3Rpb246IFJhbmdlLCBzb3VyY2U6IFNvdXJjZXMsIGVkaXRvcjogVW5wcml2aWxlZ2VkRWRpdG9yKTogdm9pZDtcblxuICBvbktleURvd24/OiBSZWFjdC5FdmVudEhhbmRsZXI8YW55PjtcbiAgb25LZXlQcmVzcz86IFJlYWN0LkV2ZW50SGFuZGxlcjxhbnk+O1xuICBvbktleVVwPzogUmVhY3QuRXZlbnRIYW5kbGVyPGFueT47XG4gIHBsYWNlaG9sZGVyPzogc3RyaW5nO1xuICBwcmVzZXJ2ZVdoaXRlc3BhY2U/OiBib29sZWFuO1xuICByZWFkT25seT86IGJvb2xlYW47XG4gIHNjcm9sbGluZ0NvbnRhaW5lcj86IHN0cmluZyB8IEhUTUxFbGVtZW50O1xuICBzdHlsZT86IFJlYWN0LkNTU1Byb3BlcnRpZXM7XG4gIHRhYkluZGV4PzogbnVtYmVyO1xuICB0aGVtZT86IHN0cmluZztcbiAgYXV0b0ZvY3VzPzogYm9vbGVhbjtcbiAgbW9kZT86ICdwcmV2aWV3JyB8ICdlZGl0b3InO1xuICB0b29sYmFySWQ/OiBzdHJpbmc7XG4gIHRvb2xiYXI/OiBSaWNoVGV4dFRvb2xiYXJUeXBlIHwgUmljaFRleHRUb29sYmFySG9vaztcbn1cblxuQG9ic2VydmVyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBCYXNlRWRpdG9yIGV4dGVuZHMgQ29tcG9uZW50PEJhc2VFZGl0b3JQcm9wcz4ge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIHZhbHVlOiBQcm9wVHlwZXMuYW55LFxuICAgIG9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvcHRpb25zOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIHNhdmVSZWY6IFByb3BUeXBlcy5mdW5jLFxuICAgIGF1dG9Gb2N1czogUHJvcFR5cGVzLmJvb2wsXG4gICAgbW9kZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICB0b29sYmFySWQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgdG9vbGJhcjogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICBQcm9wVHlwZXMub25lT2YoW1xuICAgICAgICBSaWNoVGV4dFRvb2xiYXJUeXBlLm5vbmUsXG4gICAgICAgIFJpY2hUZXh0VG9vbGJhclR5cGUubm9ybWFsLFxuICAgICAgXSksXG4gICAgICBQcm9wVHlwZXMuZnVuYyxcbiAgICBdKSxcbiAgfTtcblxuICBzdGF0ZSA9IHtcbiAgICBpbWdPcGVuOiBmYWxzZSxcbiAgICBzcmM6ICcnLFxuICB9O1xuXG4gIGVkaXRvcjogYW55O1xuXG4gIGRlbHRhT3BzPzogRGVsdGFPcGVyYXRpb25bXTtcblxuICBAYXV0b2JpbmRcbiAgc2V0VmFsdWUodmFsdWUpIHtcbiAgICBpZiAodGhpcy5lZGl0b3IpIHtcbiAgICAgIHRoaXMuZWRpdG9yLmdldEVkaXRvcigpLnNldENvbnRlbnRzKHZhbHVlKTtcbiAgICB9XG4gIH07XG5cbiAgQGF1dG9iaW5kXG4gIGhhbmRsZVJpY2hUZXh0Q2hhbmdlKF8sIF9fLCBfX18sIGVkaXRvcjogVW5wcml2aWxlZ2VkRWRpdG9yKSB7XG4gICAgY29uc3QgcnREZWx0YSA9IGVkaXRvci5nZXRDb250ZW50cygpO1xuICAgIHRoaXMuZGVsdGFPcHMgPSBydERlbHRhLm9wcztcbiAgICBjb25zdCB7IG9uQ2hhbmdlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvbkNoYW5nZSAmJiBydERlbHRhICYmIHJ0RGVsdGEub3BzKSB7XG4gICAgICBvbkNoYW5nZShydERlbHRhLm9wcyk7XG4gICAgfVxuICB9O1xuXG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSB0aGlzLnByb3BzO1xuICAgIGxldCBkZWx0YU9wcztcbiAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSAmJiB0aGlzLmVkaXRvcikge1xuICAgICAgZGVsdGFPcHMgPSB0aGlzLmVkaXRvci5nZXRFZGl0b3IoKS5jbGlwYm9hcmQuY29udmVydCh2YWx1ZSkub3BzO1xuICAgIH1cbiAgICBpZiAoJ3ZhbHVlJyBpbiB0aGlzLnByb3BzICYmICFpc0VxdWFsKHRoaXMuZGVsdGFPcHMsIGRlbHRhT3BzIHx8IHZhbHVlKSAmJiB0aGlzLmVkaXRvcikge1xuICAgICAgdGhpcy5lZGl0b3IuZ2V0RWRpdG9yKCkuc2V0Q29udGVudHMoZGVsdGFPcHMgfHwgdmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIGdldE90aGVyUHJvcHMoKSB7XG4gICAgcmV0dXJuIG9taXQodGhpcy5wcm9wcywgWydzdHlsZScsICdvbkJsdXInLCAndG9vbGJhcicsICdjbGFzc05hbWUnLCAnZGVmYXVsdFZhbHVlJywgJ29uQ2hhbmdlJywgJ3ZhbHVlJ10pO1xuICB9XG5cbiAgaGFuZGxlT3BlbkxpZ2h0Qm94ID0gKGUpID0+IHtcbiAgICBpZiAoZS50YXJnZXQubm9kZU5hbWUgPT09ICdJTUcnKSB7XG4gICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGltZ09wZW46IHRydWUsXG4gICAgICAgIHNyYzogZS50YXJnZXQuc3JjLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNvbnN0IHRoaXNOb2RlID0gZmluZERPTU5vZGUodGhpcyk7XG4gICAgaWYgKHRoaXNOb2RlKSB7XG4gICAgICB0aGlzTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGFuZGxlT3BlbkxpZ2h0Qm94KTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCB7IGF1dG9Gb2N1cyB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoYXV0b0ZvY3VzICYmIHRoaXMuZWRpdG9yKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB0aGlzTm9kZSA9IGZpbmRET01Ob2RlKHRoaXMpO1xuICAgIGlmICh0aGlzTm9kZSkge1xuICAgICAgdGhpc05vZGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhhbmRsZU9wZW5MaWdodEJveCk7XG4gICAgfVxuICB9XG5cbiAgQGF1dG9iaW5kXG4gIHJlbmRlckNvbnRlbnQoKSB7XG4gICAgY29uc3QgeyBzdHlsZSwgY2xhc3NOYW1lLCB0b29sYmFySWQsIHRvb2xiYXIsIGRhdGFTZXQsIHZhbHVlLCBtb2RlIH0gPSB0aGlzLnByb3BzO1xuICAgIGxldCBkZWx0YU9wcztcbiAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSAmJiB0aGlzLmVkaXRvcikge1xuICAgICAgZGVsdGFPcHMgPSB0aGlzLmVkaXRvci5nZXRFZGl0b3IoKS5jbGlwYm9hcmQuY29udmVydCh2YWx1ZSkub3BzO1xuICAgIH1cbiAgICBpZiAobW9kZSA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8UmljaFRleHRWaWV3ZXJcbiAgICAgICAgICBjbGFzc05hbWU9e2Ake2NsYXNzTmFtZX0tcHJldmlld2B9XG4gICAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgICAgIGRlbHRhT3BzPXtkZWx0YU9wcyB8fCB2YWx1ZX1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChSZWFjdFF1aWxsKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8PlxuICAgICAgICAgIDxUb29sYmFyIGlkPXt0b29sYmFySWR9IGRhdGFTZXQ9e2RhdGFTZXR9IHRvb2xiYXI9e3Rvb2xiYXJ9IHByZWZpeENscz17Y2xhc3NOYW1lfSAvPlxuICAgICAgICAgIDxSZWFjdFF1aWxsXG4gICAgICAgICAgICB7Li4udGhpcy5nZXRPdGhlclByb3BzKCl9XG4gICAgICAgICAgICBjbGFzc05hbWU9e2Ake2NsYXNzTmFtZX0tcXVpbGxgfVxuICAgICAgICAgICAgZGVmYXVsdFZhbHVlPXt2YWx1ZX1cbiAgICAgICAgICAgIHJlZj17dGhpcy5zYXZlUmVmKCdlZGl0b3InKX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmhhbmRsZVJpY2hUZXh0Q2hhbmdlfVxuICAgICAgICAgICAgYm91bmRzPXtjbGFzc05hbWV9XG4gICAgICAgICAgLz5cbiAgICAgICAgPC8+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGltZ09wZW4sIHNyYyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB7IGNsYXNzTmFtZSwgc3R5bGUgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY29udGVudCA9IHRoaXMucmVuZGVyQ29udGVudCgpO1xuICAgIHJldHVybiAoXG4gICAgICA8PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NOYW1lfSBzdHlsZT17c3R5bGV9PlxuICAgICAgICAgIHtjb250ZW50fVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAge1xuICAgICAgICAgIGltZ09wZW4gJiYgKFxuICAgICAgICAgICAgPExpZ2h0Qm94XG4gICAgICAgICAgICAgIG1haW5TcmM9e3NyY31cbiAgICAgICAgICAgICAgb25DbG9zZVJlcXVlc3Q9eygpID0+IHRoaXMuc2V0U3RhdGUoeyBpbWdPcGVuOiBmYWxzZSB9KX1cbiAgICAgICAgICAgICAgaW1hZ2VUaXRsZT1cImltYWdlc1wiXG4gICAgICAgICAgICAvPlxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgPC8+XG4gICAgKTtcbiAgfVxuXG4gIHNhdmVSZWYgPSBuYW1lID0+IChyZWYpID0+IHtcbiAgICB0aGlzW25hbWVdID0gcmVmO1xuICAgIGNvbnN0IHsgc2F2ZVJlZiB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoc2F2ZVJlZikge1xuICAgICAgc2F2ZVJlZihyZWYpO1xuICAgIH1cbiAgfTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==