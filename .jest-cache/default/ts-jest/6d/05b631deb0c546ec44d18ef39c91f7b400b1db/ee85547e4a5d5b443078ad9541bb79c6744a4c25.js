import React, { Component, } from 'react';
import omit from 'lodash/omit';
import classNames from 'classnames';
import calculateNodeHeight from './calculateNodeHeight';
import { getPrefixCls } from '../configure';
function onNextFrame(cb) {
    if (window.requestAnimationFrame) {
        return window.requestAnimationFrame(cb);
    }
    return window.setTimeout(cb, 1);
}
function clearNextFrameAction(nextFrameId) {
    if (window.cancelAnimationFrame) {
        window.cancelAnimationFrame(nextFrameId);
    }
    else {
        window.clearTimeout(nextFrameId);
    }
}
export default class TextArea extends Component {
    constructor() {
        super(...arguments);
        this.state = {
            textareaStyles: {},
            inputLength: 0,
            focused: false,
        };
        this.resizeTextarea = () => {
            const { autosize } = this.props;
            if (!autosize || !this.textAreaRef) {
                return;
            }
            const minRows = autosize ? autosize.minRows : null;
            const maxRows = autosize ? autosize.maxRows : null;
            const textareaStyles = calculateNodeHeight(this.textAreaRef, false, minRows, maxRows);
            this.setState({ textareaStyles });
        };
        this.handleTextareaChange = (e) => {
            if (!('value' in this.props)) {
                this.resizeTextarea();
            }
            const { onChange } = this.props;
            if (onChange) {
                onChange(e);
            }
        };
        this.handleKeyDown = (e) => {
            const { onPressEnter, onKeyDown } = this.props;
            if (e.keyCode === 13 && onPressEnter) {
                onPressEnter(e);
            }
            if (onKeyDown) {
                onKeyDown(e);
            }
        };
        this.handleInput = () => {
            this.setState({
                inputLength: this.textAreaRef.value.length,
            });
        };
        this.saveTextAreaRef = (textArea) => {
            this.textAreaRef = textArea;
        };
        this.handleFocus = (e) => {
            const { onFocus } = this.props;
            this.setState({
                focused: true,
            });
            if (onFocus) {
                onFocus(e);
            }
        };
        this.handleBlur = (e) => {
            const { onBlur } = this.props;
            this.setState({
                focused: false,
            });
            if (onBlur) {
                onBlur(e);
            }
        };
    }
    componentDidMount() {
        this.resizeTextarea();
        if (this.textAreaRef.value) {
            this.setState({
                inputLength: this.textAreaRef.value.length,
            });
        }
        const { autoFocus } = this.props;
        if (autoFocus) {
            this.setState({
                focused: true,
            });
        }
    }
    componentWillReceiveProps(nextProps) {
        // Re-render with the new content then recalculate the height as required.
        if (this.textAreaRef.value !== nextProps.value) {
            const inputLength = nextProps.value && nextProps.value.length;
            this.setState({
                inputLength: inputLength || 0,
            });
        }
        if (nextProps.autoFocus) {
            this.setState({
                focused: true,
            });
        }
        const { value } = this.props;
        if (value !== nextProps.value) {
            if (this.nextFrameActionId) {
                clearNextFrameAction(this.nextFrameActionId);
            }
            this.nextFrameActionId = onNextFrame(this.resizeTextarea);
        }
    }
    focus() {
        this.textAreaRef.focus();
    }
    blur() {
        this.textAreaRef.blur();
    }
    getPrefixCls() {
        const { prefixCls } = this.props;
        return getPrefixCls('input', prefixCls);
    }
    getTextAreaClassName() {
        const { className } = this.props;
        const prefixCls = this.getPrefixCls();
        return classNames(prefixCls, `${prefixCls}-textarea-element`, className);
    }
    getWrapperClassName() {
        const { disabled, label, border } = this.props;
        const { inputLength, focused } = this.state;
        const prefixCls = this.getPrefixCls();
        return classNames(`${prefixCls}-wrapper`, `${prefixCls}-textarea`, {
            [`${prefixCls}-has-value`]: inputLength !== 0,
            [`${prefixCls}-focused`]: focused,
            [`${prefixCls}-disabled`]: disabled,
            [`${prefixCls}-has-label`]: !!label,
            [`${prefixCls}-has-border`]: border,
        });
    }
    getLengthInfo() {
        const { maxLength, showLengthInfo } = this.props;
        const prefixCls = this.getPrefixCls();
        const { inputLength } = this.state;
        return (maxLength && showLengthInfo) ||
            (maxLength && maxLength > 0 && inputLength === maxLength) ? (React.createElement("div", { className: `${prefixCls}-length-info` }, `${inputLength}/${maxLength}`)) : null;
    }
    getLabel() {
        const { placeholder, label } = this.props;
        const { inputLength } = this.state;
        if (inputLength === 0 && placeholder) {
            return placeholder;
        }
        return label;
    }
    renderFloatLabel() {
        const label = this.getLabel();
        if (label) {
            const prefixCls = this.getPrefixCls();
            return (React.createElement("div", { className: `${prefixCls}-label-wrapper` },
                React.createElement("div", { className: `${prefixCls}-label` }, label)));
        }
    }
    render() {
        const props = this.props;
        const { textareaStyles } = this.state;
        const prefixCls = this.getPrefixCls();
        const otherProps = omit(props, [
            'prefixCls',
            'onPressEnter',
            'autosize',
            'placeholder',
            'focused',
            'showLengthInfo',
        ]);
        const style = {
            ...props.style,
            ...textareaStyles,
        };
        // Make sure it could be reset when using form.getFieldDecorator
        if ('value' in otherProps) {
            otherProps.value = otherProps.value || '';
        }
        otherProps.onInput = this.handleInput;
        return (React.createElement("span", { className: this.getWrapperClassName() },
            React.createElement("div", { className: `${prefixCls}-rendered-wrapper` },
                React.createElement("textarea", Object.assign({}, otherProps, { className: this.getTextAreaClassName(), style: style, onKeyDown: this.handleKeyDown, onChange: this.handleTextareaChange, ref: this.saveTextAreaRef, onInput: this.handleInput, onBlur: this.handleBlur, onFocus: this.handleFocus })),
                this.renderFloatLabel()),
            this.getLengthInfo()));
    }
}
TextArea.displayName = 'TextArea';
TextArea.defaultProps = {
    showLengthInfo: true,
    border: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvaW5wdXQvVGV4dEFyZWEudHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBRVosU0FBUyxHQU9WLE1BQU0sT0FBTyxDQUFDO0FBQ2YsT0FBTyxJQUFJLE1BQU0sYUFBYSxDQUFDO0FBQy9CLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUVwQyxPQUFPLG1CQUFtQixNQUFNLHVCQUF1QixDQUFDO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFNUMsU0FBUyxXQUFXLENBQUMsRUFBYztJQUNqQyxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRTtRQUNoQyxPQUFPLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUN6QztJQUNELE9BQU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDbEMsQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQUMsV0FBbUI7SUFDL0MsSUFBSSxNQUFNLENBQUMsb0JBQW9CLEVBQUU7UUFDL0IsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQzFDO1NBQU07UUFDTCxNQUFNLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ2xDO0FBQ0gsQ0FBQztBQXNCRCxNQUFNLENBQUMsT0FBTyxPQUFPLFFBQVMsU0FBUSxTQUEyRDtJQUFqRzs7UUFVRSxVQUFLLEdBQUc7WUFDTixjQUFjLEVBQUUsRUFBRTtZQUNsQixXQUFXLEVBQUUsQ0FBQztZQUNkLE9BQU8sRUFBRSxLQUFLO1NBQ2YsQ0FBQztRQW1ERixtQkFBYyxHQUFHLEdBQUcsRUFBRTtZQUNwQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNoQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFD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Q0FBQyxDQUFDO1FBQ0gsTUFBTSxLQUFLLEdBQUc7WUFDWixHQUFHLEtBQUssQ0FBQyxLQUFLO1lBQ2QsR0FBRyxjQUFjO1NBQ2xCLENBQUM7UUFFRixnRUFBZ0U7UUFDaEUsSUFBSSxPQUFPLElBQUksVUFBVSxFQUFFO1lBQ3pCLFVBQVUsQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7U0FDM0M7UUFDRCxVQUFVLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFdEMsT0FBTyxDQUNMLDhCQUFNLFNBQVMsRUFBRSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDekMsNkJBQUssU0FBUyxFQUFFLEdBQUcsU0FBUyxtQkFBbUI7Z0JBQzdDLGtEQUNNLFVBQVUsSUFDZCxTQUFTLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEVBQ3RDLEtBQUssRUFBRSxLQUFLLEVBQ1osU0FBUyxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQzdCLFFBQVEsRUFBRSxJQUFJLENBQUMsb0JBQW9CLEVBQ25DLEdBQUcsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFDekIsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQ3ZCLE9BQU8sRUFBRSxJQUFJLENBQUMsV0FBVyxJQUN6QjtnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FDcEI7WUFDTCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQ2hCLENBQ1IsQ0FBQztJQUNKLENBQUM7O0FBOU5NLG9CQUFXLEdBQUcsVUFBVSxDQUFDO0FBRXpCLHFCQUFZLEdBQUc7SUFDcEIsY0FBYyxFQUFFLElBQUk7SUFDcEIsTUFBTSxFQUFFLElBQUk7Q0FDYixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL2lucHV0L1RleHRBcmVhLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHtcbiAgQ2hhbmdlRXZlbnQsXG4gIENvbXBvbmVudCxcbiAgQ1NTUHJvcGVydGllcyxcbiAgRm9jdXNFdmVudCxcbiAgRm9ybUV2ZW50SGFuZGxlcixcbiAgS2V5Ym9hcmRFdmVudCxcbiAgUmVhY3ROb2RlLFxuICBUZXh0YXJlYUhUTUxBdHRyaWJ1dGVzLFxufSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgb21pdCBmcm9tICdsb2Rhc2gvb21pdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7IEFic3RyYWN0SW5wdXRQcm9wcyB9IGZyb20gJy4vSW5wdXQnO1xuaW1wb3J0IGNhbGN1bGF0ZU5vZGVIZWlnaHQgZnJvbSAnLi9jYWxjdWxhdGVOb2RlSGVpZ2h0JztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmZ1bmN0aW9uIG9uTmV4dEZyYW1lKGNiOiAoKSA9PiB2b2lkKSB7XG4gIGlmICh3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7XG4gICAgcmV0dXJuIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2IpO1xuICB9XG4gIHJldHVybiB3aW5kb3cuc2V0VGltZW91dChjYiwgMSk7XG59XG5cbmZ1bmN0aW9uIGNsZWFyTmV4dEZyYW1lQWN0aW9uKG5leHRGcmFtZUlkOiBudW1iZXIpIHtcbiAgaWYgKHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSkge1xuICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZShuZXh0RnJhbWVJZCk7XG4gIH0gZWxzZSB7XG4gICAgd2luZG93LmNsZWFyVGltZW91dChuZXh0RnJhbWVJZCk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRvU2l6ZVR5cGUge1xuICBtaW5Sb3dzPzogbnVtYmVyO1xuICBtYXhSb3dzPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRleHRBcmVhUHJvcHMgZXh0ZW5kcyBBYnN0cmFjdElucHV0UHJvcHMge1xuICBhdXRvc2l6ZT86IGJvb2xlYW4gfCBBdXRvU2l6ZVR5cGU7XG4gIG9uUHJlc3NFbnRlcj86IEZvcm1FdmVudEhhbmRsZXI8YW55PjtcbiAgYXV0b0ZvY3VzPzogYm9vbGVhbjtcbiAgYm9yZGVyPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZXh0QXJlYVN0YXRlIHtcbiAgdGV4dGFyZWFTdHlsZXM/OiBDU1NQcm9wZXJ0aWVzO1xuICBpbnB1dExlbmd0aD86IG51bWJlcjtcbiAgZm9jdXNlZD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCB0eXBlIEhUTUxUZXh0YXJlYVByb3BzID0gVGV4dGFyZWFIVE1MQXR0cmlidXRlczxIVE1MVGV4dEFyZWFFbGVtZW50PjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGV4dEFyZWEgZXh0ZW5kcyBDb21wb25lbnQ8VGV4dEFyZWFQcm9wcyAmIEhUTUxUZXh0YXJlYVByb3BzLCBUZXh0QXJlYVN0YXRlPiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdUZXh0QXJlYSc7XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBzaG93TGVuZ3RoSW5mbzogdHJ1ZSxcbiAgICBib3JkZXI6IHRydWUsXG4gIH07XG5cbiAgbmV4dEZyYW1lQWN0aW9uSWQ6IG51bWJlcjtcblxuICBzdGF0ZSA9IHtcbiAgICB0ZXh0YXJlYVN0eWxlczoge30sXG4gICAgaW5wdXRMZW5ndGg6IDAsXG4gICAgZm9jdXNlZDogZmFsc2UsXG4gIH07XG5cbiAgcHJpdmF0ZSB0ZXh0QXJlYVJlZjogSFRNTFRleHRBcmVhRWxlbWVudDtcblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLnJlc2l6ZVRleHRhcmVhKCk7XG4gICAgaWYgKHRoaXMudGV4dEFyZWFSZWYudmFsdWUpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBpbnB1dExlbmd0aDogdGhpcy50ZXh0QXJlYVJlZi52YWx1ZS5sZW5ndGgsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBhdXRvRm9jdXMgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKGF1dG9Gb2N1cykge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGZvY3VzZWQ6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogVGV4dEFyZWFQcm9wcykge1xuICAgIC8vIFJlLXJlbmRlciB3aXRoIHRoZSBuZXcgY29udGVudCB0aGVuIHJlY2FsY3VsYXRlIHRoZSBoZWlnaHQgYXMgcmVxdWlyZWQuXG5cbiAgICBpZiAodGhpcy50ZXh0QXJlYVJlZi52YWx1ZSAhPT0gbmV4dFByb3BzLnZhbHVlKSB7XG4gICAgICBjb25zdCBpbnB1dExlbmd0aCA9IG5leHRQcm9wcy52YWx1ZSAmJiBuZXh0UHJvcHMudmFsdWUubGVuZ3RoO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGlucHV0TGVuZ3RoOiBpbnB1dExlbmd0aCB8fCAwLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5leHRQcm9wcy5hdXRvRm9jdXMpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBmb2N1c2VkOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHsgdmFsdWUgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKHZhbHVlICE9PSBuZXh0UHJvcHMudmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLm5leHRGcmFtZUFjdGlvbklkKSB7XG4gICAgICAgIGNsZWFyTmV4dEZyYW1lQWN0aW9uKHRoaXMubmV4dEZyYW1lQWN0aW9uSWQpO1xuICAgICAgfVxuICAgICAgdGhpcy5uZXh0RnJhbWVBY3Rpb25JZCA9IG9uTmV4dEZyYW1lKHRoaXMucmVzaXplVGV4dGFyZWEpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCkge1xuICAgIHRoaXMudGV4dEFyZWFSZWYuZm9jdXMoKTtcbiAgfVxuXG4gIGJsdXIoKSB7XG4gICAgdGhpcy50ZXh0QXJlYVJlZi5ibHVyKCk7XG4gIH1cblxuICByZXNpemVUZXh0YXJlYSA9ICgpID0+IHtcbiAgICBjb25zdCB7IGF1dG9zaXplIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmICghYXV0b3NpemUgfHwgIXRoaXMudGV4dEFyZWFSZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbWluUm93cyA9IGF1dG9zaXplID8gKGF1dG9zaXplIGFzIEF1dG9TaXplVHlwZSkubWluUm93cyA6IG51bGw7XG4gICAgY29uc3QgbWF4Um93cyA9IGF1dG9zaXplID8gKGF1dG9zaXplIGFzIEF1dG9TaXplVHlwZSkubWF4Um93cyA6IG51bGw7XG4gICAgY29uc3QgdGV4dGFyZWFTdHlsZXMgPSBjYWxjdWxhdGVOb2RlSGVpZ2h0KHRoaXMudGV4dEFyZWFSZWYsIGZhbHNlLCBtaW5Sb3dzLCBtYXhSb3dzKTtcbiAgICB0aGlzLnNldFN0YXRlKHsgdGV4dGFyZWFTdHlsZXMgfSk7XG4gIH07XG5cbiAgZ2V0UHJlZml4Q2xzKCkge1xuICAgIGNvbnN0IHsgcHJlZml4Q2xzIH0gPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiBnZXRQcmVmaXhDbHMoJ2lucHV0JywgcHJlZml4Q2xzKTtcbiAgfVxuXG4gIGdldFRleHRBcmVhQ2xhc3NOYW1lKCkge1xuICAgIGNvbnN0IHsgY2xhc3NOYW1lIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHByZWZpeENscyA9IHRoaXMuZ2V0UHJlZml4Q2xzKCk7XG4gICAgcmV0dXJuIGNsYXNzTmFtZXMocHJlZml4Q2xzLCBgJHtwcmVmaXhDbHN9LXRleHRhcmVhLWVsZW1lbnRgLCBjbGFzc05hbWUpO1xuICB9XG5cbiAgaGFuZGxlVGV4dGFyZWFDaGFuZ2UgPSAoZTogQ2hhbmdlRXZlbnQ8SFRNTFRleHRBcmVhRWxlbWVudD4pID0+IHtcbiAgICBpZiAoISgndmFsdWUnIGluIHRoaXMucHJvcHMpKSB7XG4gICAgICB0aGlzLnJlc2l6ZVRleHRhcmVhKCk7XG4gICAgfVxuICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uQ2hhbmdlKSB7XG4gICAgICBvbkNoYW5nZShlKTtcbiAgICB9XG4gIH07XG5cbiAgaGFuZGxlS2V5RG93biA9IChlOiBLZXlib2FyZEV2ZW50PEhUTUxUZXh0QXJlYUVsZW1lbnQ+KSA9PiB7XG4gICAgY29uc3QgeyBvblByZXNzRW50ZXIsIG9uS2V5RG93biB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZS5rZXlDb2RlID09PSAxMyAmJiBvblByZXNzRW50ZXIpIHtcbiAgICAgIG9uUHJlc3NFbnRlcihlKTtcbiAgICB9XG4gICAgaWYgKG9uS2V5RG93bikge1xuICAgICAgb25LZXlEb3duKGUpO1xuICAgIH1cbiAgfTtcblxuICBoYW5kbGVJbnB1dCA9ICgpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGlucHV0TGVuZ3RoOiB0aGlzLnRleHRBcmVhUmVmLnZhbHVlLmxlbmd0aCxcbiAgICB9KTtcbiAgfTtcblxuICBzYXZlVGV4dEFyZWFSZWYgPSAodGV4dEFyZWE6IEhUTUxUZXh0QXJlYUVsZW1lbnQpID0+IHtcbiAgICB0aGlzLnRleHRBcmVhUmVmID0gdGV4dEFyZWE7XG4gIH07XG5cbiAgZ2V0V3JhcHBlckNsYXNzTmFtZSgpIHtcbiAgICBjb25zdCB7IGRpc2FibGVkLCBsYWJlbCwgYm9yZGVyIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgaW5wdXRMZW5ndGgsIGZvY3VzZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICByZXR1cm4gY2xhc3NOYW1lcyhgJHtwcmVmaXhDbHN9LXdyYXBwZXJgLCBgJHtwcmVmaXhDbHN9LXRleHRhcmVhYCwge1xuICAgICAgW2Ake3ByZWZpeENsc30taGFzLXZhbHVlYF06IGlucHV0TGVuZ3RoICE9PSAwLFxuICAgICAgW2Ake3ByZWZpeENsc30tZm9jdXNlZGBdOiBmb2N1c2VkLFxuICAgICAgW2Ake3ByZWZpeENsc30tZGlzYWJsZWRgXTogZGlzYWJsZWQsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1oYXMtbGFiZWxgXTogISFsYWJlbCxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWhhcy1ib3JkZXJgXTogYm9yZGVyLFxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRm9jdXMgPSAoZTogRm9jdXNFdmVudDxIVE1MVGV4dEFyZWFFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IHsgb25Gb2N1cyB9ID0gdGhpcy5wcm9wcztcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGZvY3VzZWQ6IHRydWUsXG4gICAgfSk7XG4gICAgaWYgKG9uRm9jdXMpIHtcbiAgICAgIG9uRm9jdXMoZSk7XG4gICAgfVxuICB9O1xuXG4gIGhhbmRsZUJsdXIgPSAoZTogRm9jdXNFdmVudDxIVE1MVGV4dEFyZWFFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IHsgb25CbHVyIH0gPSB0aGlzLnByb3BzO1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgZm9jdXNlZDogZmFsc2UsXG4gICAgfSk7XG4gICAgaWYgKG9uQmx1cikge1xuICAgICAgb25CbHVyKGUpO1xuICAgIH1cbiAgfTtcblxuICBnZXRMZW5ndGhJbmZvKCkge1xuICAgIGNvbnN0IHsgbWF4TGVuZ3RoLCBzaG93TGVuZ3RoSW5mbyB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgIGNvbnN0IHsgaW5wdXRMZW5ndGggfSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0dXJuIChtYXhMZW5ndGggJiYgc2hvd0xlbmd0aEluZm8pIHx8XG4gICAgICAobWF4TGVuZ3RoICYmIG1heExlbmd0aCA+IDAgJiYgaW5wdXRMZW5ndGggPT09IG1heExlbmd0aCkgPyAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1sZW5ndGgtaW5mb2B9PntgJHtpbnB1dExlbmd0aH0vJHttYXhMZW5ndGh9YH08L2Rpdj5cbiAgICApIDogbnVsbDtcbiAgfVxuXG4gIGdldExhYmVsKCkge1xuICAgIGNvbnN0IHsgcGxhY2Vob2xkZXIsIGxhYmVsIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgaW5wdXRMZW5ndGggfSA9IHRoaXMuc3RhdGU7XG4gICAgaWYgKGlucHV0TGVuZ3RoID09PSAwICYmIHBsYWNlaG9sZGVyKSB7XG4gICAgICByZXR1cm4gcGxhY2Vob2xkZXI7XG4gICAgfVxuICAgIHJldHVybiBsYWJlbDtcbiAgfVxuXG4gIHJlbmRlckZsb2F0TGFiZWwoKTogUmVhY3ROb2RlIHtcbiAgICBjb25zdCBsYWJlbCA9IHRoaXMuZ2V0TGFiZWwoKTtcbiAgICBpZiAobGFiZWwpIHtcbiAgICAgIGNvbnN0IHByZWZpeENscyA9IHRoaXMuZ2V0UHJlZml4Q2xzKCk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1sYWJlbC13cmFwcGVyYH0+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbGFiZWxgfT57bGFiZWx9PC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgdGV4dGFyZWFTdHlsZXMgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICBjb25zdCBvdGhlclByb3BzOiBUZXh0QXJlYVByb3BzICYgSFRNTFRleHRhcmVhUHJvcHMgPSBvbWl0KHByb3BzLCBbXG4gICAgICAncHJlZml4Q2xzJyxcbiAgICAgICdvblByZXNzRW50ZXInLFxuICAgICAgJ2F1dG9zaXplJyxcbiAgICAgICdwbGFjZWhvbGRlcicsXG4gICAgICAnZm9jdXNlZCcsXG4gICAgICAnc2hvd0xlbmd0aEluZm8nLFxuICAgIF0pO1xuICAgIGNvbnN0IHN0eWxlID0ge1xuICAgICAgLi4ucHJvcHMuc3R5bGUsXG4gICAgICAuLi50ZXh0YXJlYVN0eWxlcyxcbiAgICB9O1xuXG4gICAgLy8gTWFrZSBzdXJlIGl0IGNvdWxkIGJlIHJlc2V0IHdoZW4gdXNpbmcgZm9ybS5nZXRGaWVsZERlY29yYXRvclxuICAgIGlmICgndmFsdWUnIGluIG90aGVyUHJvcHMpIHtcbiAgICAgIG90aGVyUHJvcHMudmFsdWUgPSBvdGhlclByb3BzLnZhbHVlIHx8ICcnO1xuICAgIH1cbiAgICBvdGhlclByb3BzLm9uSW5wdXQgPSB0aGlzLmhhbmRsZUlucHV0O1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17dGhpcy5nZXRXcmFwcGVyQ2xhc3NOYW1lKCl9PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1yZW5kZXJlZC13cmFwcGVyYH0+XG4gICAgICAgICAgPHRleHRhcmVhXG4gICAgICAgICAgICB7Li4ub3RoZXJQcm9wc31cbiAgICAgICAgICAgIGNsYXNzTmFtZT17dGhpcy5nZXRUZXh0QXJlYUNsYXNzTmFtZSgpfVxuICAgICAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgICAgICAgb25LZXlEb3duPXt0aGlzLmhhbmRsZUtleURvd259XG4gICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5oYW5kbGVUZXh0YXJlYUNoYW5nZX1cbiAgICAgICAgICAgIHJlZj17dGhpcy5zYXZlVGV4dEFyZWFSZWZ9XG4gICAgICAgICAgICBvbklucHV0PXt0aGlzLmhhbmRsZUlucHV0fVxuICAgICAgICAgICAgb25CbHVyPXt0aGlzLmhhbmRsZUJsdXJ9XG4gICAgICAgICAgICBvbkZvY3VzPXt0aGlzLmhhbmRsZUZvY3VzfVxuICAgICAgICAgIC8+XG4gICAgICAgICAge3RoaXMucmVuZGVyRmxvYXRMYWJlbCgpfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAge3RoaXMuZ2V0TGVuZ3RoSW5mbygpfVxuICAgICAgPC9zcGFuPlxuICAgICk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==