import React, { Component } from 'react';
import classNames from 'classnames';
import Icon from '../icon';
import Tooltip from '../tooltip';
import Progress from '../progress';
import Animate from '../animate';
import { getPrefixCls } from '../configure';
// https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
const previewFile = (file, callback) => {
    const reader = new FileReader();
    reader.onloadend = () => callback(reader.result);
    reader.readAsDataURL(file);
};
const isImageUrl = (url) => {
    return /^data:image\//.test(url) || /\.(webp|svg|png|gif|jpg|jpeg)$/.test(url);
};
export default class UploadList extends Component {
    constructor() {
        super(...arguments);
        this.handleClose = (file) => {
            const { onRemove } = this.props;
            if (onRemove) {
                onRemove(file);
            }
        };
        this.handlePreview = (file, e) => {
            const { onPreview } = this.props;
            if (!onPreview) {
                return;
            }
            e.preventDefault();
            return onPreview(file);
        };
    }
    componentDidUpdate() {
        const { listType, items } = this.props;
        if (listType !== 'picture' && listType !== 'picture-card') {
            return;
        }
        (items || []).forEach(file => {
            if (typeof document === 'undefined' ||
                typeof window === 'undefined' ||
                !window.FileReader ||
                !window.File ||
                !(file.originFileObj instanceof File) ||
                file.thumbUrl !== undefined) {
                return;
            }
            /* eslint-disable-next-line */
            file.thumbUrl = '';
            previewFile(file.originFileObj, (previewDataUrl) => {
                /* eslint-disable-next-line */
                file.thumbUrl = previewDataUrl;
                this.forceUpdate();
            });
        });
    }
    render() {
        const { prefixCls: customizePrefixCls, items = [], listType, showPreviewIcon, showRemoveIcon, locale, } = this.props;
        const prefixCls = getPrefixCls('upload', customizePrefixCls);
        const list = items.map(file => {
            let progress;
            let icon = React.createElement(Icon, { type: file.status === 'uploading' ? 'loading' : 'attach_file' });
            if (listType === 'picture' || listType === 'picture-card') {
                if (listType === 'picture-card' && file.status === 'uploading') {
                    icon = React.createElement("div", { className: `${prefixCls}-list-item-uploading-text` }, locale.uploading);
                }
                else if (!file.thumbUrl && !file.url) {
                    icon = React.createElement(Icon, { className: `${prefixCls}-list-item-thumbnail`, type: "picture" });
                }
                else {
                    const thumbnail = isImageUrl((file.thumbUrl || file.url)) ? (React.createElement("img", { src: file.thumbUrl || file.url, alt: file.name })) : (React.createElement(Icon, { type: "file", style: { fontSize: 48, color: 'rgba(0,0,0,0.5)' } }));
                    icon = (React.createElement("a", { className: `${prefixCls}-list-item-thumbnail`, onClick: e => this.handlePreview(file, e), href: file.url || file.thumbUrl, target: "_blank", rel: "noopener noreferrer" }, thumbnail));
                }
            }
            if (file.status === 'uploading') {
                const { progressAttr } = this.props;
                // show loading icon if upload progress listener is disabled
                const loadingProgress = 'percent' in file ? (React.createElement(Progress, Object.assign({ type: "line" /* line */ }, progressAttr, { percent: file.percent }))) : null;
                progress = (React.createElement("div", { className: `${prefixCls}-list-item-progress`, key: "progress" }, loadingProgress));
            }
            const infoUploadingClass = classNames({
                [`${prefixCls}-list-item`]: true,
                [`${prefixCls}-list-item-${file.status}`]: true,
            });
            const preview = file.url ? (React.createElement("a", Object.assign({}, file.linkProps, { href: file.url, target: "_blank", rel: "noopener noreferrer", className: `${prefixCls}-list-item-name`, onClick: e => this.handlePreview(file, e), title: file.name }), file.name)) : (React.createElement("span", { className: `${prefixCls}-list-item-name`, onClick: e => this.handlePreview(file, e), title: file.name }, file.name));
            const style = file.url || file.thumbUrl
                ? undefined
                : {
                    pointerEvents: 'none',
                    opacity: 0.5,
                };
            const previewIcon = showPreviewIcon ? (React.createElement("a", { href: file.url || file.thumbUrl, target: "_blank", rel: "noopener noreferrer", style: style, onClick: e => this.handlePreview(file, e), title: locale.previewFile },
                React.createElement(Icon, { type: "visibility" }))) : null;
            const removeIcon = showRemoveIcon ? (React.createElement(Icon, { type: "delete", title: locale.removeFile, onClick: () => this.handleClose(file) })) : null;
            const removeIconCross = showRemoveIcon ? (React.createElement(Icon, { type: "close", title: locale.removeFile, onClick: () => this.handleClose(file) })) : null;
            const actions = listType === 'picture-card' && file.status !== 'uploading' ? (React.createElement("span", { className: `${prefixCls}-list-item-actions` },
                previewIcon,
                removeIcon)) : (removeIconCross);
            let message;
            if (file.response && typeof file.response === 'string') {
                message = file.response;
            }
            else {
                message = (file.error && file.error.statusText) || locale.uploadError;
            }
            const iconAndPreview = file.status === 'error' ? (React.createElement(Tooltip, { title: message },
                icon,
                preview)) : (React.createElement("span", null,
                icon,
                preview));
            return (React.createElement("div", { className: infoUploadingClass, key: file.uid },
                React.createElement("div", { className: `${prefixCls}-list-item-info` }, iconAndPreview),
                actions,
                React.createElement(Animate, { transitionName: "fade", component: "" }, progress)));
        });
        const listClassNames = classNames({
            [`${prefixCls}-list`]: true,
            [`${prefixCls}-list-${listType}`]: true,
        });
        const animationDirection = listType === 'picture-card' ? 'animate-inline' : 'animate';
        return (React.createElement(Animate, { transitionName: `${prefixCls}-${animationDirection}`, component: "div", className: listClassNames }, list));
    }
}
UploadList.displayName = 'UploadList';
UploadList.defaultProps = {
    listType: 'text',
    progressAttr: {
        strokeWidth: 2,
        showInfo: false,
    },
    showRemoveIcon: true,
    showPreviewIcon: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdXBsb2FkL1VwbG9hZExpc3QudHN4IiwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLEVBQUUsU0FBUyxFQUFpQyxNQUFNLE9BQU8sQ0FBQztBQUN4RSxPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBQzNCLE9BQU8sT0FBTyxNQUFNLFlBQVksQ0FBQztBQUNqQyxPQUFPLFFBQVEsTUFBTSxhQUFhLENBQUM7QUFFbkMsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFDO0FBRWpDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFNUMsNEVBQTRFO0FBQzVFLE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBVSxFQUFFLFFBQWtCLEVBQUUsRUFBRTtJQUNyRCxNQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQ2hDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzdCLENBQUMsQ0FBQztBQUVGLE1BQU0sVUFBVSxHQUFHLENBQUMsR0FBVyxFQUFXLEVBQUU7SUFDMUMsT0FBTyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLGdDQUFnQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNqRixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxPQUFPLFVBQVcsU0FBUSxTQUErQjtJQUF2RTs7UUFhRSxnQkFBVyxHQUFHLENBQUMsSUFBZ0IsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2hDLElBQUksUUFBUSxFQUFFO2dCQUNaLFFBQVEsQ0FBQyxJQUFJ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Q0FBQztJQUNKLENBQUM7O0FBak5NLHNCQUFXLEdBQUcsWUFBWSxDQUFDO0FBRTNCLHVCQUFZLEdBQUc7SUFDcEIsUUFBUSxFQUFFLE1BQU07SUFDaEIsWUFBWSxFQUFFO1FBQ1osV0FBVyxFQUFFLENBQUM7UUFDZCxRQUFRLEVBQUUsS0FBSztLQUNoQjtJQUNELGNBQWMsRUFBRSxJQUFJO0lBQ3BCLGVBQWUsRUFBRSxJQUFJO0NBQ3RCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdXBsb2FkL1VwbG9hZExpc3QudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIENTU1Byb3BlcnRpZXMsIFN5bnRoZXRpY0V2ZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgSWNvbiBmcm9tICcuLi9pY29uJztcbmltcG9ydCBUb29sdGlwIGZyb20gJy4uL3Rvb2x0aXAnO1xuaW1wb3J0IFByb2dyZXNzIGZyb20gJy4uL3Byb2dyZXNzJztcbmltcG9ydCB7IFVwbG9hZEZpbGUsIFVwbG9hZExpc3RQcm9wcyB9IGZyb20gJy4vaW50ZXJmYWNlJztcbmltcG9ydCBBbmltYXRlIGZyb20gJy4uL2FuaW1hdGUnO1xuaW1wb3J0IHsgUHJvZ3Jlc3NUeXBlIH0gZnJvbSAnLi4vcHJvZ3Jlc3MvZW51bSc7XG5pbXBvcnQgeyBnZXRQcmVmaXhDbHMgfSBmcm9tICcuLi9jb25maWd1cmUnO1xuXG4vLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvRmlsZVJlYWRlci9yZWFkQXNEYXRhVVJMXG5jb25zdCBwcmV2aWV3RmlsZSA9IChmaWxlOiBGaWxlLCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IGNhbGxiYWNrKHJlYWRlci5yZXN1bHQpO1xuICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcbn07XG5cbmNvbnN0IGlzSW1hZ2VVcmwgPSAodXJsOiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIC9eZGF0YTppbWFnZVxcLy8udGVzdCh1cmwpIHx8IC9cXC4od2VicHxzdmd8cG5nfGdpZnxqcGd8anBlZykkLy50ZXN0KHVybCk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVcGxvYWRMaXN0IGV4dGVuZHMgQ29tcG9uZW50PFVwbG9hZExpc3RQcm9wcywgYW55PiB7XG4gIHN0YXRpYyBkaXNwbGF5TmFtZSA9ICdVcGxvYWRMaXN0JztcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGxpc3RUeXBlOiAndGV4dCcsIC8vIG9yIHBpY3R1cmVcbiAgICBwcm9ncmVzc0F0dHI6IHtcbiAgICAgIHN0cm9rZVdpZHRoOiAyLFxuICAgICAgc2hvd0luZm86IGZhbHNlLFxuICAgIH0sXG4gICAgc2hvd1JlbW92ZUljb246IHRydWUsXG4gICAgc2hvd1ByZXZpZXdJY29uOiB0cnVlLFxuICB9O1xuXG4gIGhhbmRsZUNsb3NlID0gKGZpbGU6IFVwbG9hZEZpbGUpID0+IHtcbiAgICBjb25zdCB7IG9uUmVtb3ZlIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblJlbW92ZSkge1xuICAgICAgb25SZW1vdmUoZmlsZSk7XG4gICAgfVxuICB9O1xuXG4gIGhhbmRsZVByZXZpZXcgPSAoZmlsZTogVXBsb2FkRmlsZSwgZTogU3ludGhldGljRXZlbnQ8SFRNTEVsZW1lbnQ+KSA9PiB7XG4gICAgY29uc3QgeyBvblByZXZpZXcgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFvblByZXZpZXcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHJldHVybiBvblByZXZpZXcoZmlsZSk7XG4gIH07XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIGNvbnN0IHsgbGlzdFR5cGUsIGl0ZW1zIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChsaXN0VHlwZSAhPT0gJ3BpY3R1cmUnICYmIGxpc3RUeXBlICE9PSAncGljdHVyZS1jYXJkJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAoaXRlbXMgfHwgW10pLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcgfHxcbiAgICAgICAgdHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgfHxcbiAgICAgICAgISh3aW5kb3cgYXMgYW55KS5GaWxlUmVhZGVyIHx8XG4gICAgICAgICEod2luZG93IGFzIGFueSkuRmlsZSB8fFxuICAgICAgICAhKGZpbGUub3JpZ2luRmlsZU9iaiBpbnN0YW5jZW9mIEZpbGUpIHx8XG4gICAgICAgIGZpbGUudGh1bWJVcmwgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSAqL1xuICAgICAgZmlsZS50aHVtYlVybCA9ICcnO1xuICAgICAgcHJldmlld0ZpbGUoZmlsZS5vcmlnaW5GaWxlT2JqLCAocHJldmlld0RhdGFVcmw6IHN0cmluZykgPT4ge1xuICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgKi9cbiAgICAgICAgZmlsZS50aHVtYlVybCA9IHByZXZpZXdEYXRhVXJsO1xuICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBwcmVmaXhDbHM6IGN1c3RvbWl6ZVByZWZpeENscyxcbiAgICAgIGl0ZW1zID0gW10sXG4gICAgICBsaXN0VHlwZSxcbiAgICAgIHNob3dQcmV2aWV3SWNvbixcbiAgICAgIHNob3dSZW1vdmVJY29uLFxuICAgICAgbG9jYWxlLFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHByZWZpeENscyA9IGdldFByZWZpeENscygndXBsb2FkJywgY3VzdG9taXplUHJlZml4Q2xzKTtcbiAgICBjb25zdCBsaXN0ID0gaXRlbXMubWFwKGZpbGUgPT4ge1xuICAgICAgbGV0IHByb2dyZXNzO1xuICAgICAgbGV0IGljb24gPSA8SWNvbiB0eXBlPXtmaWxlLnN0YXR1cyA9PT0gJ3VwbG9hZGluZycgPyAnbG9hZGluZycgOiAnYXR0YWNoX2ZpbGUnfSAvPjtcblxuICAgICAgaWYgKGxpc3RUeXBlID09PSAncGljdHVyZScgfHwgbGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnKSB7XG4gICAgICAgIGlmIChsaXN0VHlwZSA9PT0gJ3BpY3R1cmUtY2FyZCcgJiYgZmlsZS5zdGF0dXMgPT09ICd1cGxvYWRpbmcnKSB7XG4gICAgICAgICAgaWNvbiA9IDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS11cGxvYWRpbmctdGV4dGB9Pntsb2NhbGUudXBsb2FkaW5nfTwvZGl2PjtcbiAgICAgICAgfSBlbHNlIGlmICghZmlsZS50aHVtYlVybCAmJiAhZmlsZS51cmwpIHtcbiAgICAgICAgICBpY29uID0gPEljb24gY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS10aHVtYm5haWxgfSB0eXBlPVwicGljdHVyZVwiIC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHRodW1ibmFpbCA9IGlzSW1hZ2VVcmwoKGZpbGUudGh1bWJVcmwgfHwgZmlsZS51cmwpIGFzIHN0cmluZykgPyAoXG4gICAgICAgICAgICA8aW1nIHNyYz17ZmlsZS50aHVtYlVybCB8fCBmaWxlLnVybH0gYWx0PXtmaWxlLm5hbWV9IC8+XG4gICAgICAgICAgKSA6IChcbiAgICAgICAgICAgIDxJY29uIHR5cGU9XCJmaWxlXCIgc3R5bGU9e3sgZm9udFNpemU6IDQ4LCBjb2xvcjogJ3JnYmEoMCwwLDAsMC41KScgfX0gLz5cbiAgICAgICAgICApO1xuICAgICAgICAgIGljb24gPSAoXG4gICAgICAgICAgICA8YVxuICAgICAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbGlzdC1pdGVtLXRodW1ibmFpbGB9XG4gICAgICAgICAgICAgIG9uQ2xpY2s9e2UgPT4gdGhpcy5oYW5kbGVQcmV2aWV3KGZpbGUsIGUpfVxuICAgICAgICAgICAgICBocmVmPXtmaWxlLnVybCB8fCBmaWxlLnRodW1iVXJsfVxuICAgICAgICAgICAgICB0YXJnZXQ9XCJfYmxhbmtcIlxuICAgICAgICAgICAgICByZWw9XCJub29wZW5lciBub3JlZmVycmVyXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAge3RodW1ibmFpbH1cbiAgICAgICAgICAgIDwvYT5cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChmaWxlLnN0YXR1cyA9PT0gJ3VwbG9hZGluZycpIHtcbiAgICAgICAgY29uc3QgeyBwcm9ncmVzc0F0dHIgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIC8vIHNob3cgbG9hZGluZyBpY29uIGlmIHVwbG9hZCBwcm9ncmVzcyBsaXN0ZW5lciBpcyBkaXNhYmxlZFxuICAgICAgICBjb25zdCBsb2FkaW5nUHJvZ3Jlc3MgPVxuICAgICAgICAgICdwZXJjZW50JyBpbiBmaWxlID8gKFxuICAgICAgICAgICAgPFByb2dyZXNzIHR5cGU9e1Byb2dyZXNzVHlwZS5saW5lfSB7Li4ucHJvZ3Jlc3NBdHRyfSBwZXJjZW50PXtmaWxlLnBlcmNlbnR9IC8+XG4gICAgICAgICAgKSA6IG51bGw7XG5cbiAgICAgICAgcHJvZ3Jlc3MgPSAoXG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbGlzdC1pdGVtLXByb2dyZXNzYH0ga2V5PVwicHJvZ3Jlc3NcIj5cbiAgICAgICAgICAgIHtsb2FkaW5nUHJvZ3Jlc3N9XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjb25zdCBpbmZvVXBsb2FkaW5nQ2xhc3MgPSBjbGFzc05hbWVzKHtcbiAgICAgICAgW2Ake3ByZWZpeENsc30tbGlzdC1pdGVtYF06IHRydWUsXG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS0ke2ZpbGUuc3RhdHVzfWBdOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBwcmV2aWV3ID0gZmlsZS51cmwgPyAoXG4gICAgICAgIDxhXG4gICAgICAgICAgey4uLmZpbGUubGlua1Byb3BzfVxuICAgICAgICAgIGhyZWY9e2ZpbGUudXJsfVxuICAgICAgICAgIHRhcmdldD1cIl9ibGFua1wiXG4gICAgICAgICAgcmVsPVwibm9vcGVuZXIgbm9yZWZlcnJlclwiXG4gICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS1uYW1lYH1cbiAgICAgICAgICBvbkNsaWNrPXtlID0+IHRoaXMuaGFuZGxlUHJldmlldyhmaWxlLCBlKX1cbiAgICAgICAgICB0aXRsZT17ZmlsZS5uYW1lfVxuICAgICAgICA+XG4gICAgICAgICAge2ZpbGUubmFtZX1cbiAgICAgICAgPC9hPlxuICAgICAgKSA6IChcbiAgICAgICAgPHNwYW5cbiAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tbGlzdC1pdGVtLW5hbWVgfVxuICAgICAgICAgIG9uQ2xpY2s9e2UgPT4gdGhpcy5oYW5kbGVQcmV2aWV3KGZpbGUsIGUpfVxuICAgICAgICAgIHRpdGxlPXtmaWxlLm5hbWV9XG4gICAgICAgID5cbiAgICAgICAgICB7ZmlsZS5uYW1lfVxuICAgICAgICA8L3NwYW4+XG4gICAgICApO1xuICAgICAgY29uc3Qgc3R5bGUgPVxuICAgICAgICBmaWxlLnVybCB8fCBmaWxlLnRodW1iVXJsXG4gICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICA6ICh7XG4gICAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJyxcbiAgICAgICAgICAgICAgb3BhY2l0eTogMC41LFxuICAgICAgICAgICAgfSBhcyBDU1NQcm9wZXJ0aWVzKTtcbiAgICAgIGNvbnN0IHByZXZpZXdJY29uID0gc2hvd1ByZXZpZXdJY29uID8gKFxuICAgICAgICA8YVxuICAgICAgICAgIGhyZWY9e2ZpbGUudXJsIHx8IGZpbGUudGh1bWJVcmx9XG4gICAgICAgICAgdGFyZ2V0PVwiX2JsYW5rXCJcbiAgICAgICAgICByZWw9XCJub29wZW5lciBub3JlZmVycmVyXCJcbiAgICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICAgICAgb25DbGljaz17ZSA9PiB0aGlzLmhhbmRsZVByZXZpZXcoZmlsZSwgZSl9XG4gICAgICAgICAgdGl0bGU9e2xvY2FsZS5wcmV2aWV3RmlsZX1cbiAgICAgICAgPlxuICAgICAgICAgIDxJY29uIHR5cGU9XCJ2aXNpYmlsaXR5XCIgLz5cbiAgICAgICAgPC9hPlxuICAgICAgKSA6IG51bGw7XG4gICAgICBjb25zdCByZW1vdmVJY29uID0gc2hvd1JlbW92ZUljb24gPyAoXG4gICAgICAgIDxJY29uIHR5cGU9XCJkZWxldGVcIiB0aXRsZT17bG9jYWxlLnJlbW92ZUZpbGV9IG9uQ2xpY2s9eygpID0+IHRoaXMuaGFuZGxlQ2xvc2UoZmlsZSl9IC8+XG4gICAgICApIDogbnVsbDtcbiAgICAgIGNvbnN0IHJlbW92ZUljb25Dcm9zcyA9IHNob3dSZW1vdmVJY29uID8gKFxuICAgICAgICA8SWNvbiB0eXBlPVwiY2xvc2VcIiB0aXRsZT17bG9jYWxlLnJlbW92ZUZpbGV9IG9uQ2xpY2s9eygpID0+IHRoaXMuaGFuZGxlQ2xvc2UoZmlsZSl9IC8+XG4gICAgICApIDogbnVsbDtcbiAgICAgIGNvbnN0IGFjdGlvbnMgPVxuICAgICAgICBsaXN0VHlwZSA9PT0gJ3BpY3R1cmUtY2FyZCcgJiYgZmlsZS5zdGF0dXMgIT09ICd1cGxvYWRpbmcnID8gKFxuICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1saXN0LWl0ZW0tYWN0aW9uc2B9PlxuICAgICAgICAgICAge3ByZXZpZXdJY29ufVxuICAgICAgICAgICAge3JlbW92ZUljb259XG4gICAgICAgICAgPC9zcGFuPlxuICAgICAgICApIDogKFxuICAgICAgICAgIHJlbW92ZUljb25Dcm9zc1xuICAgICAgICApO1xuICAgICAgbGV0IG1lc3NhZ2U7XG4gICAgICBpZiAoZmlsZS5yZXNwb25zZSAmJiB0eXBlb2YgZmlsZS5yZXNwb25zZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgbWVzc2FnZSA9IGZpbGUucmVzcG9uc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNzYWdlID0gKGZpbGUuZXJyb3IgJiYgZmlsZS5lcnJvci5zdGF0dXNUZXh0KSB8fCBsb2NhbGUudXBsb2FkRXJyb3I7XG4gICAgICB9XG4gICAgICBjb25zdCBpY29uQW5kUHJldmlldyA9XG4gICAgICAgIGZpbGUuc3RhdHVzID09PSAnZXJyb3InID8gKFxuICAgICAgICAgIDxUb29sdGlwIHRpdGxlPXttZXNzYWdlfT5cbiAgICAgICAgICAgIHtpY29ufVxuICAgICAgICAgICAge3ByZXZpZXd9XG4gICAgICAgICAgPC9Ub29sdGlwPlxuICAgICAgICApIDogKFxuICAgICAgICAgIDxzcGFuPlxuICAgICAgICAgICAge2ljb259XG4gICAgICAgICAgICB7cHJldmlld31cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICk7XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtpbmZvVXBsb2FkaW5nQ2xhc3N9IGtleT17ZmlsZS51aWR9PlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWxpc3QtaXRlbS1pbmZvYH0+e2ljb25BbmRQcmV2aWV3fTwvZGl2PlxuICAgICAgICAgIHthY3Rpb25zfVxuICAgICAgICAgIDxBbmltYXRlIHRyYW5zaXRpb25OYW1lPVwiZmFkZVwiIGNvbXBvbmVudD1cIlwiPlxuICAgICAgICAgICAge3Byb2dyZXNzfVxuICAgICAgICAgIDwvQW5pbWF0ZT5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH0pO1xuICAgIGNvbnN0IGxpc3RDbGFzc05hbWVzID0gY2xhc3NOYW1lcyh7XG4gICAgICBbYCR7cHJlZml4Q2xzfS1saXN0YF06IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1saXN0LSR7bGlzdFR5cGV9YF06IHRydWUsXG4gICAgfSk7XG4gICAgY29uc3QgYW5pbWF0aW9uRGlyZWN0aW9uID0gbGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnID8gJ2FuaW1hdGUtaW5saW5lJyA6ICdhbmltYXRlJztcbiAgICByZXR1cm4gKFxuICAgICAgPEFuaW1hdGVcbiAgICAgICAgdHJhbnNpdGlvbk5hbWU9e2Ake3ByZWZpeENsc30tJHthbmltYXRpb25EaXJlY3Rpb259YH1cbiAgICAgICAgY29tcG9uZW50PVwiZGl2XCJcbiAgICAgICAgY2xhc3NOYW1lPXtsaXN0Q2xhc3NOYW1lc31cbiAgICAgID5cbiAgICAgICAge2xpc3R9XG4gICAgICA8L0FuaW1hdGU+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9