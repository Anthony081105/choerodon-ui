import React, { Component } from 'react';
import classNames from 'classnames';
import uniqBy from 'lodash/uniqBy';
import LocaleReceiver from '../locale-provider/LocaleReceiver';
import defaultLocale from '../locale-provider/default';
import UploadList from './UploadList';
import { fileToObject, genPercentAdd, getFileItem, removeFileItem, T } from './utils';
import RcUpload from '../rc-components/upload';
import { getPrefixCls } from '../configure';
export default class Upload extends Component {
    constructor(props) {
        super(props);
        this.onStart = (file) => {
            const { fileList } = this.state;
            const nextFileList = [...fileList];
            const targetItem = fileToObject(file);
            targetItem.status = 'uploading';
            nextFileList.push(targetItem);
            this.onChange({
                file: targetItem,
                fileList: nextFileList,
            });
            // fix ie progress
            if (!window.FormData) {
                this.autoUpdateProgress(0, targetItem);
            }
            const { onStart } = this.props;
            if (onStart) {
                onStart(file);
            }
        };
        this.onSuccess = (response, file) => {
            this.clearProgressTimer();
            try {
                if (typeof response === 'string') {
                    response = JSON.parse(response);
                }
            }
            catch (e) {
                /* do nothing */
            }
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (targetItem) {
                targetItem.status = 'done';
                targetItem.response = response;
                this.onChange({
                    file: { ...targetItem },
                    fileList,
                });
            }
            const { onSuccess } = this.props;
            if (onSuccess) {
                onSuccess(response, file);
            }
        };
        this.onProgress = (e, file) => {
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (targetItem) {
                targetItem.percent = e.percent;
                this.onChange({
                    event: e,
                    file: { ...targetItem },
                    fileList,
                });
            }
            const { onProgress } = this.props;
            if (onProgress) {
                onProgress(e, file);
            }
        };
        this.onError = (error, response, file) => {
            this.clearProgressTimer();
            const { fileList } = this.state;
            const targetItem = getFileItem(file, fileList);
            // removed
            if (!targetItem) {
                return;
            }
            targetItem.error = error;
            targetItem.response = response;
            targetItem.status = 'error';
            this.onChange({
                file: { ...targetItem },
                fileList,
            });
            const { onError } = this.props;
            if (onError) {
                onError(error, response, file);
            }
        };
        this.handleManualRemove = (file) => {
            this.upload.abort(file);
            file.status = 'removed'; // eslint-disable-line
            this.handleRemove(file);
        };
        this.onChange = (info) => {
            if (!('fileList' in this.props)) {
                this.setState({ fileList: info.fileList });
            }
            const { onChange } = this.props;
            if (onChange) {
                onChange(info);
            }
        };
        this.onFileDrop = (e) => {
            this.setState({
                dragState: e.type,
            });
        };
        this.beforeUpload = (file, uploadFiles) => {
            const { beforeUpload } = this.props;
            if (beforeUpload) {
                const result = beforeUpload(file, uploadFiles);
                if (result === false) {
                    const { fileList } = this.state;
                    this.onChange({
                        file,
                        fileList: uniqBy(uploadFiles.concat(fileList), (item) => item.uid),
                    });
                    return false;
                }
                if (result && result.then) {
                    return result;
                }
            }
            return true;
        };
        this.saveUpload = (node) => {
            this.upload = node;
        };
        this.renderUploadList = (uploadLocale) => {
            const { showUploadList, listType, onPreview, locale } = this.props;
            const { fileList } = this.state;
            const { showRemoveIcon, showPreviewIcon } = showUploadList;
            return (React.createElement(UploadList, { listType: listType, items: fileList, onPreview: onPreview, onRemove: this.handleManualRemove, showRemoveIcon: showRemoveIcon, showPreviewIcon: showPreviewIcon, locale: { ...uploadLocale, ...locale } }));
        };
        this.state = {
            fileList: props.fileList || props.defaultFileList || [],
            dragState: 'drop',
        };
    }
    componentWillUnmount() {
        this.clearProgressTimer();
    }
    autoUpdateProgress(_, file) {
        const getPercent = genPercentAdd();
        let curPercent = 0;
        this.clearProgressTimer();
        this.progressTimer = setInterval(() => {
            curPercent = getPercent(curPercent);
            this.onProgress({
                percent: curPercent,
            }, file);
        }, 200);
    }
    handleRemove(file) {
        const { onRemove } = this.props;
        Promise.resolve(typeof onRemove === 'function' ? onRemove(file) : onRemove).then(ret => {
            // Prevent removing file
            if (ret === false) {
                return;
            }
            const { fileList } = this.state;
            const removedFileList = removeFileItem(file, fileList);
            if (removedFileList) {
                this.onChange({
                    file,
                    fileList: removedFileList,
                });
            }
        });
    }
    componentWillReceiveProps(nextProps) {
        if ('fileList' in nextProps) {
            this.setState({
                fileList: nextProps.fileList || [],
            });
        }
    }
    clearProgressTimer() {
        clearInterval(this.progressTimer);
    }
    render() {
        const { prefixCls: customizePrefixCls, className, showUploadList, listType, type, disabled, children, } = this.props;
        const { fileList, dragState } = this.state;
        const prefixCls = getPrefixCls('upload', customizePrefixCls);
        const rcUploadProps = {
            ...this.props,
            onStart: this.onStart,
            onError: this.onError,
            onProgress: this.onProgress,
            onSuccess: this.onSuccess,
            beforeUpload: this.beforeUpload,
            prefixCls,
        };
        delete rcUploadProps.className;
        const uploadList = showUploadList ? (React.createElement(LocaleReceiver, { componentName: "Upload", defaultLocale: defaultLocale.Upload }, this.renderUploadList)) : null;
        if (type === 'drag') {
            const dragCls = classNames(prefixCls, {
                [`${prefixCls}-drag`]: true,
                [`${prefixCls}-drag-uploading`]: fileList.some(file => file.status === 'uploading'),
                [`${prefixCls}-drag-hover`]: dragState === 'dragover',
                [`${prefixCls}-disabled`]: disabled,
            });
            return (React.createElement("span", { className: className },
                React.createElement("div", { className: dragCls, onDrop: this.onFileDrop, onDragOver: this.onFileDrop, onDragLeave: this.onFileDrop },
                    React.createElement(RcUpload, Object.assign({}, rcUploadProps, { ref: this.saveUpload, className: `${prefixCls}-btn` }),
                        React.createElement("div", { className: `${prefixCls}-drag-container` }, children))),
                uploadList));
        }
        const uploadButtonCls = classNames(prefixCls, {
            [`${prefixCls}-select`]: true,
            [`${prefixCls}-select-${listType}`]: true,
            [`${prefixCls}-disabled`]: disabled,
        });
        const uploadButton = (React.createElement("div", { className: uploadButtonCls, style: { display: children ? '' : 'none' } },
            React.createElement(RcUpload, Object.assign({}, rcUploadProps, { ref: this.saveUpload }))));
        if (listType === 'picture-card') {
            return (React.createElement("span", { className: className },
                uploadList,
                uploadButton));
        }
        return (React.createElement("span", { className: className },
            uploadButton,
            uploadList));
    }
}
Upload.displayName = 'Upload';
Upload.defaultProps = {
    type: 'select',
    multiple: false,
    action: '',
    data: {},
    accept: '',
    beforeUpload: T,
    showUploadList: true,
    listType: 'text',
    className: '',
    disabled: false,
    supportServerRender: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdXBsb2FkL1VwbG9hZC50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQWEsTUFBTSxPQUFPLENBQUM7QUFDcEQsT0FBTyxVQUFVLE1BQU0sWUFBWSxDQUFDO0FBQ3BDLE9BQU8sTUFBTSxNQUFNLGVBQWUsQ0FBQztBQUNuQyxPQUFPLGNBQWMsTUFBTSxtQ0FBbUMsQ0FBQztBQUMvRCxPQUFPLGFBQWEsTUFBTSw0QkFBNEIsQ0FBQztBQUV2RCxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFFdEMsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDdEYsT0FBTyxRQUFRLE1BQU0seUJBQXlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUk1QyxNQUFNLENBQUMsT0FBTyxPQUFPLE1BQU8sU0FBUSxTQUFtQztJQXlCckUsWUFBWSxLQUFrQjtRQUM1QixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFZZixZQUFPLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEVBQUU7WUFDN0IsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDaEMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxVQUFVLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztZQUNoQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQ1osSUFBSSxFQUFFLFVBQVU7Z0JBQ2hCLFFBQVEsRUFBRSxZQUFZO2FBQ3ZCLENBQUMsQ0FBQztZQUNILGtCQUFr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b2Rvbi11aS9jb21wb25lbnRzL3VwbG9hZC9VcGxvYWQudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIERyYWdFdmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHVuaXFCeSBmcm9tICdsb2Rhc2gvdW5pcUJ5JztcbmltcG9ydCBMb2NhbGVSZWNlaXZlciBmcm9tICcuLi9sb2NhbGUtcHJvdmlkZXIvTG9jYWxlUmVjZWl2ZXInO1xuaW1wb3J0IGRlZmF1bHRMb2NhbGUgZnJvbSAnLi4vbG9jYWxlLXByb3ZpZGVyL2RlZmF1bHQnO1xuaW1wb3J0IERyYWdnZXIgZnJvbSAnLi9EcmFnZ2VyJztcbmltcG9ydCBVcGxvYWRMaXN0IGZyb20gJy4vVXBsb2FkTGlzdCc7XG5pbXBvcnQgeyBVcGxvYWRDaGFuZ2VQYXJhbSwgVXBsb2FkRmlsZSwgVXBsb2FkTG9jYWxlLCBVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBmaWxlVG9PYmplY3QsIGdlblBlcmNlbnRBZGQsIGdldEZpbGVJdGVtLCByZW1vdmVGaWxlSXRlbSwgVCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFJjVXBsb2FkIGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdXBsb2FkJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCB7IFVwbG9hZFByb3BzIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVwbG9hZCBleHRlbmRzIENvbXBvbmVudDxVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGU+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ1VwbG9hZCc7XG5cbiAgc3RhdGljIERyYWdnZXI6IHR5cGVvZiBEcmFnZ2VyO1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgdHlwZTogJ3NlbGVjdCcsXG4gICAgbXVsdGlwbGU6IGZhbHNlLFxuICAgIGFjdGlvbjogJycsXG4gICAgZGF0YToge30sXG4gICAgYWNjZXB0OiAnJyxcbiAgICBiZWZvcmVVcGxvYWQ6IFQsXG4gICAgc2hvd1VwbG9hZExpc3Q6IHRydWUsXG4gICAgbGlzdFR5cGU6ICd0ZXh0JywgLy8gb3IgcGljdHJ1ZVxuICAgIGNsYXNzTmFtZTogJycsXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxuICAgIHN1cHBvcnRTZXJ2ZXJSZW5kZXI6IHRydWUsXG4gIH07XG5cbiAgcmVjZW50VXBsb2FkU3RhdHVzOiBib29sZWFuIHwgUHJvbWlzZUxpa2U8YW55PjtcblxuICBwcm9ncmVzc1RpbWVyOiBhbnk7XG5cbiAgcHJpdmF0ZSB1cGxvYWQ6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogVXBsb2FkUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgZmlsZUxpc3Q6IHByb3BzLmZpbGVMaXN0IHx8IHByb3BzLmRlZmF1bHRGaWxlTGlzdCB8fCBbXSxcbiAgICAgIGRyYWdTdGF0ZTogJ2Ryb3AnLFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB0aGlzLmNsZWFyUHJvZ3Jlc3NUaW1lcigpO1xuICB9XG5cbiAgb25TdGFydCA9IChmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBuZXh0RmlsZUxpc3QgPSBbLi4uZmlsZUxpc3RdO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBmaWxlVG9PYmplY3QoZmlsZSk7XG4gICAgdGFyZ2V0SXRlbS5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICBuZXh0RmlsZUxpc3QucHVzaCh0YXJnZXRJdGVtKTtcbiAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgIGZpbGU6IHRhcmdldEl0ZW0sXG4gICAgICBmaWxlTGlzdDogbmV4dEZpbGVMaXN0LFxuICAgIH0pO1xuICAgIC8vIGZpeCBpZSBwcm9ncmVzc1xuICAgIGlmICghKHdpbmRvdyBhcyBhbnkpLkZvcm1EYXRhKSB7XG4gICAgICB0aGlzLmF1dG9VcGRhdGVQcm9ncmVzcygwLCB0YXJnZXRJdGVtKTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN0YXJ0IH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblN0YXJ0KSB7XG4gICAgICBvblN0YXJ0KGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBhdXRvVXBkYXRlUHJvZ3Jlc3MoXzogYW55LCBmaWxlOiBVcGxvYWRGaWxlKSB7XG4gICAgY29uc3QgZ2V0UGVyY2VudCA9IGdlblBlcmNlbnRBZGQoKTtcbiAgICBsZXQgY3VyUGVyY2VudCA9IDA7XG4gICAgdGhpcy5jbGVhclByb2dyZXNzVGltZXIoKTtcbiAgICB0aGlzLnByb2dyZXNzVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBjdXJQZXJjZW50ID0gZ2V0UGVyY2VudChjdXJQZXJjZW50KTtcbiAgICAgIHRoaXMub25Qcm9ncmVzcyhcbiAgICAgICAge1xuICAgICAgICAgIHBlcmNlbnQ6IGN1clBlcmNlbnQsXG4gICAgICAgIH0sXG4gICAgICAgIGZpbGUsXG4gICAgICApO1xuICAgIH0sIDIwMCk7XG4gIH1cblxuICBvblN1Y2Nlc3MgPSAocmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLyogZG8gbm90aGluZyAqL1xuICAgIH1cbiAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBnZXRGaWxlSXRlbShmaWxlLCBmaWxlTGlzdCk7XG4gICAgLy8gcmVtb3ZlZFxuICAgIGlmICh0YXJnZXRJdGVtKSB7XG4gICAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdkb25lJztcbiAgICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIHRoaXMub25DaGFuZ2Uoe1xuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN1Y2Nlc3MgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uU3VjY2Vzcykge1xuICAgICAgb25TdWNjZXNzKHJlc3BvbnNlLCBmaWxlKTtcbiAgICB9XG4gIH07XG5cbiAgb25Qcm9ncmVzcyA9IChlOiB7IHBlcmNlbnQ6IG51bWJlciB9LCBmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAodGFyZ2V0SXRlbSkge1xuICAgICAgdGFyZ2V0SXRlbS5wZXJjZW50ID0gZS5wZXJjZW50O1xuICAgICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICAgIGV2ZW50OiBlLFxuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblByb2dyZXNzIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblByb2dyZXNzKSB7XG4gICAgICBvblByb2dyZXNzKGUsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBvbkVycm9yID0gKGVycm9yOiBFcnJvciwgcmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAoIXRhcmdldEl0ZW0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGFyZ2V0SXRlbS5lcnJvciA9IGVycm9yO1xuICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgIGZpbGVMaXN0LFxuICAgIH0pO1xuICAgIGNvbnN0IHsgb25FcnJvciB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25FcnJvcikge1xuICAgICAgb25FcnJvcihlcnJvciwgcmVzcG9uc2UsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBoYW5kbGVSZW1vdmUoZmlsZTogVXBsb2FkRmlsZSkge1xuICAgIGNvbnN0IHsgb25SZW1vdmUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBQcm9taXNlLnJlc29sdmUodHlwZW9mIG9uUmVtb3ZlID09PSAnZnVuY3Rpb24nID8gb25SZW1vdmUoZmlsZSkgOiBvblJlbW92ZSkudGhlbihyZXQgPT4ge1xuICAgICAgLy8gUHJldmVudCByZW1vdmluZyBmaWxlXG4gICAgICBpZiAocmV0ID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgY29uc3QgcmVtb3ZlZEZpbGVMaXN0ID0gcmVtb3ZlRmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgICAgaWYgKHJlbW92ZWRGaWxlTGlzdCkge1xuICAgICAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgICAgICBmaWxlLFxuICAgICAgICAgIGZpbGVMaXN0OiByZW1vdmVkRmlsZUxpc3QsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlTWFudWFsUmVtb3ZlID0gKGZpbGU6IFVwbG9hZEZpbGUpID0+IHtcbiAgICB0aGlzLnVwbG9hZC5hYm9ydChmaWxlKTtcbiAgICBmaWxlLnN0YXR1cyA9ICdyZW1vdmVkJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgIHRoaXMuaGFuZGxlUmVtb3ZlKGZpbGUpO1xuICB9O1xuXG4gIG9uQ2hhbmdlID0gKGluZm86IFVwbG9hZENoYW5nZVBhcmFtKSA9PiB7XG4gICAgaWYgKCEoJ2ZpbGVMaXN0JyBpbiB0aGlzLnByb3BzKSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGZpbGVMaXN0OiBpbmZvLmZpbGVMaXN0IH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uQ2hhbmdlKSB7XG4gICAgICBvbkNoYW5nZShpbmZvKTtcbiAgICB9XG4gIH07XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IFVwbG9hZFByb3BzKSB7XG4gICAgaWYgKCdmaWxlTGlzdCcgaW4gbmV4dFByb3BzKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgZmlsZUxpc3Q6IG5leHRQcm9wcy5maWxlTGlzdCB8fCBbXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9uRmlsZURyb3AgPSAoZTogRHJhZ0V2ZW50PEhUTUxEaXZFbGVtZW50PikgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgZHJhZ1N0YXRlOiBlLnR5cGUsXG4gICAgfSk7XG4gIH07XG5cbiAgYmVmb3JlVXBsb2FkID0gKGZpbGU6IFVwbG9hZEZpbGUsIHVwbG9hZEZpbGVzOiBVcGxvYWRGaWxlW10pID0+IHtcbiAgICBjb25zdCB7IGJlZm9yZVVwbG9hZCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoYmVmb3JlVXBsb2FkKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBiZWZvcmVVcGxvYWQoZmlsZSwgdXBsb2FkRmlsZXMpO1xuICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICAgICAgZmlsZSxcbiAgICAgICAgICBmaWxlTGlzdDogdW5pcUJ5KHVwbG9hZEZpbGVzLmNvbmNhdChmaWxlTGlzdCksIChpdGVtOiBhbnkpID0+IGl0ZW0udWlkKSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXN1bHQgJiYgKHJlc3VsdCBhcyBQcm9taXNlTGlrZTxhbnk+KS50aGVuKSB7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIGNsZWFyUHJvZ3Jlc3NUaW1lcigpIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMucHJvZ3Jlc3NUaW1lcik7XG4gIH1cblxuICBzYXZlVXBsb2FkID0gKG5vZGU6IFJjVXBsb2FkIHwgbnVsbCkgPT4ge1xuICAgIHRoaXMudXBsb2FkID0gbm9kZTtcbiAgfTtcblxuICByZW5kZXJVcGxvYWRMaXN0ID0gKHVwbG9hZExvY2FsZTogVXBsb2FkTG9jYWxlKSA9PiB7XG4gICAgY29uc3QgeyBzaG93VXBsb2FkTGlzdCwgbGlzdFR5cGUsIG9uUHJldmlldywgbG9jYWxlIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgZmlsZUxpc3QgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgeyBzaG93UmVtb3ZlSWNvbiwgc2hvd1ByZXZpZXdJY29uIH0gPSBzaG93VXBsb2FkTGlzdCBhcyBhbnk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxVcGxvYWRMaXN0XG4gICAgICAgIGxpc3RUeXBlPXtsaXN0VHlwZX1cbiAgICAgICAgaXRlbXM9e2ZpbGVMaXN0fVxuICAgICAgICBvblByZXZpZXc9e29uUHJldmlld31cbiAgICAgICAgb25SZW1vdmU9e3RoaXMuaGFuZGxlTWFudWFsUmVtb3ZlfVxuICAgICAgICBzaG93UmVtb3ZlSWNvbj17c2hvd1JlbW92ZUljb259XG4gICAgICAgIHNob3dQcmV2aWV3SWNvbj17c2hvd1ByZXZpZXdJY29ufVxuICAgICAgICBsb2NhbGU9e3sgLi4udXBsb2FkTG9jYWxlLCAuLi5sb2NhbGUgfX1cbiAgICAgIC8+XG4gICAgKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgcHJlZml4Q2xzOiBjdXN0b21pemVQcmVmaXhDbHMsXG4gICAgICBjbGFzc05hbWUsXG4gICAgICBzaG93VXBsb2FkTGlzdCxcbiAgICAgIGxpc3RUeXBlLFxuICAgICAgdHlwZSxcbiAgICAgIGRpc2FibGVkLFxuICAgICAgY2hpbGRyZW4sXG4gICAgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBmaWxlTGlzdCwgZHJhZ1N0YXRlIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgY29uc3QgcHJlZml4Q2xzID0gZ2V0UHJlZml4Q2xzKCd1cGxvYWQnLCBjdXN0b21pemVQcmVmaXhDbHMpO1xuXG4gICAgY29uc3QgcmNVcGxvYWRQcm9wcyA9IHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBvblN0YXJ0OiB0aGlzLm9uU3RhcnQsXG4gICAgICBvbkVycm9yOiB0aGlzLm9uRXJyb3IsXG4gICAgICBvblByb2dyZXNzOiB0aGlzLm9uUHJvZ3Jlc3MsXG4gICAgICBvblN1Y2Nlc3M6IHRoaXMub25TdWNjZXNzLFxuICAgICAgYmVmb3JlVXBsb2FkOiB0aGlzLmJlZm9yZVVwbG9hZCxcbiAgICAgIHByZWZpeENscyxcbiAgICB9O1xuXG4gICAgZGVsZXRlIHJjVXBsb2FkUHJvcHMuY2xhc3NOYW1lO1xuXG4gICAgY29uc3QgdXBsb2FkTGlzdCA9IHNob3dVcGxvYWRMaXN0ID8gKFxuICAgICAgPExvY2FsZVJlY2VpdmVyIGNvbXBvbmVudE5hbWU9XCJVcGxvYWRcIiBkZWZhdWx0TG9jYWxlPXtkZWZhdWx0TG9jYWxlLlVwbG9hZH0+XG4gICAgICAgIHt0aGlzLnJlbmRlclVwbG9hZExpc3R9XG4gICAgICA8L0xvY2FsZVJlY2VpdmVyPlxuICAgICkgOiBudWxsO1xuXG4gICAgaWYgKHR5cGUgPT09ICdkcmFnJykge1xuICAgICAgY29uc3QgZHJhZ0NscyA9IGNsYXNzTmFtZXMocHJlZml4Q2xzLCB7XG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWdgXTogdHJ1ZSxcbiAgICAgICAgW2Ake3ByZWZpeENsc30tZHJhZy11cGxvYWRpbmdgXTogZmlsZUxpc3Quc29tZShmaWxlID0+IGZpbGUuc3RhdHVzID09PSAndXBsb2FkaW5nJyksXG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWctaG92ZXJgXTogZHJhZ1N0YXRlID09PSAnZHJhZ292ZXInLFxuICAgICAgICBbYCR7cHJlZml4Q2xzfS1kaXNhYmxlZGBdOiBkaXNhYmxlZCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtjbGFzc05hbWV9PlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzTmFtZT17ZHJhZ0Nsc31cbiAgICAgICAgICAgIG9uRHJvcD17dGhpcy5vbkZpbGVEcm9wfVxuICAgICAgICAgICAgb25EcmFnT3Zlcj17dGhpcy5vbkZpbGVEcm9wfVxuICAgICAgICAgICAgb25EcmFnTGVhdmU9e3RoaXMub25GaWxlRHJvcH1cbiAgICAgICAgICA+XG4gICAgICAgICAgICA8UmNVcGxvYWQgey4uLnJjVXBsb2FkUHJvcHN9IHJlZj17dGhpcy5zYXZlVXBsb2FkfSBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tYnRuYH0+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWRyYWctY29udGFpbmVyYH0+e2NoaWxkcmVufTwvZGl2PlxuICAgICAgICAgICAgPC9SY1VwbG9hZD5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICB7dXBsb2FkTGlzdH1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGxvYWRCdXR0b25DbHMgPSBjbGFzc05hbWVzKHByZWZpeENscywge1xuICAgICAgW2Ake3ByZWZpeENsc30tc2VsZWN0YF06IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1zZWxlY3QtJHtsaXN0VHlwZX1gXTogdHJ1ZSxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWRpc2FibGVkYF06IGRpc2FibGVkLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdXBsb2FkQnV0dG9uID0gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e3VwbG9hZEJ1dHRvbkNsc30gc3R5bGU9e3sgZGlzcGxheTogY2hpbGRyZW4gPyAnJyA6ICdub25lJyB9fT5cbiAgICAgICAgPFJjVXBsb2FkIHsuLi5yY1VwbG9hZFByb3BzfSByZWY9e3RoaXMuc2F2ZVVwbG9hZH0gLz5cbiAgICAgIDwvZGl2PlxuICAgICk7XG5cbiAgICBpZiAobGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2NsYXNzTmFtZX0+XG4gICAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NOYW1lfT5cbiAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICA8L3NwYW4+XG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9