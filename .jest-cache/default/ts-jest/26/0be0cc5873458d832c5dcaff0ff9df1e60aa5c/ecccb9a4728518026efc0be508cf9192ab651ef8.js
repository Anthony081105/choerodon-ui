import React, { cloneElement, Component, isValidElement, } from 'react';
import classNames from 'classnames';
import getPlacements from './placements';
import RcTooltip from '../rc-components/tooltip';
import { getPrefixCls } from '../configure';
const splitObject = (obj, keys) => {
    const picked = {};
    const omited = { ...obj };
    keys.forEach(key => {
        if (obj && key in obj) {
            picked[key] = obj[key];
            delete omited[key];
        }
    });
    return { picked, omited };
};
export default class Tooltip extends Component {
    constructor(props) {
        super(props);
        this.onVisibleChange = (visible) => {
            const { onVisibleChange } = this.props;
            if (!('visible' in this.props)) {
                this.setState({ visible: this.isNoTitle() ? false : visible });
            }
            if (onVisibleChange && !this.isNoTitle()) {
                onVisibleChange(visible);
            }
        };
        // 动态设置动画点
        this.onPopupAlign = (domNode, align) => {
            const placements = this.getPlacements();
            // 当前返回的位置
            const placement = Object.keys(placements).filter(key => placements[key].points[0] === align.points[0] &&
                placements[key].points[1] === align.points[1])[0];
            if (!placement) {
                return;
            }
            // 根据当前坐标设置动画点
            const rect = domNode.getBoundingClientRect();
            const transformOrigin = {
                top: '50%',
                left: '50%',
            };
            if (placement.indexOf('top') >= 0 || placement.indexOf('Bottom') >= 0) {
                transformOrigin.top = `${rect.height - align.offset[1]}px`;
            }
            else if (placement.indexOf('Top') >= 0 || placement.indexOf('bottom') >= 0) {
                transformOrigin.top = `${-align.offset[1]}px`;
            }
            if (placement.indexOf('left') >= 0 || placement.indexOf('Right') >= 0) {
                transformOrigin.left = `${rect.width - align.offset[0]}px`;
            }
            else if (placement.indexOf('right') >= 0 || placement.indexOf('Left') >= 0) {
                transformOrigin.left = `${-align.offset[0]}px`;
            }
            domNode.style.transformOrigin = `${transformOrigin.left} ${transformOrigin.top}`;
        };
        this.saveTooltip = (node) => {
            this.tooltip = node;
        };
        this.state = {
            visible: !!props.visible || !!props.defaultVisible,
        };
    }
    componentWillReceiveProps(nextProps) {
        if ('visible' in nextProps) {
            this.setState({ visible: nextProps.visible });
        }
    }
    getPopupDomNode() {
        return this.tooltip.getPopupDomNode();
    }
    getPlacements() {
        const { builtinPlacements, arrowPointAtCenter, autoAdjustOverflow } = this.props;
        return (builtinPlacements ||
            getPlacements({
                arrowPointAtCenter,
                verticalArrowShift: 8,
                autoAdjustOverflow,
            }));
    }
    isHoverTrigger() {
        const { trigger } = this.props;
        if (!trigger || trigger === 'hover') {
            return true;
        }
        if (Array.isArray(trigger)) {
            return trigger.indexOf('hover') >= 0;
        }
        return false;
    }
    // Fix Tooltip won't hide at disabled button
    // mouse events don't trigger at disabled button in Chrome
    // https://github.com/react-component/tooltip/issues/18
    getDisabledCompatibleChildren(element) {
        const elementType = element.type;
        if (((elementType.__Pro_BUTTON === true ||
            elementType.__Pro_SWITCH === true ||
            elementType.__Pro_CHECKBOX === true ||
            element.type.__ANT_BUTTON ||
            element.type === 'button') &&
            element.props.disabled) &&
            element.props.disabled &&
            this.isHoverTrigger()) {
            // Pick some layout related style properties up to span
            const { picked, omited } = splitObject(element.props.style, [
                'position',
                'left',
                'right',
                'top',
                'bottom',
                'float',
                'display',
                'zIndex',
            ]);
            const spanStyle = {
                display: 'inline-block',
                ...picked,
                cursor: 'not-allowed',
            };
            const buttonStyle = {
                ...omited,
                pointerEvents: 'none',
            };
            const child = cloneElement(element, {
                style: buttonStyle,
                className: null,
            });
            return (React.createElement("span", { style: spanStyle, className: element.props.className }, child));
        }
        return element;
    }
    isNoTitle() {
        const { title, overlay } = this.props;
        return !title && !overlay; // overlay for old version compatibility
    }
    render() {
        const { props, state } = this;
        const { prefixCls: customizePrefixCls, title, overlay, openClassName, getPopupContainer, getTooltipContainer, } = props;
        const prefixCls = getPrefixCls('tooltip', customizePrefixCls);
        const children = props.children;
        let visible = state.visible;
        // Hide tooltip when there is no title
        if (!('visible' in props) && this.isNoTitle()) {
            visible = false;
        }
        const child = this.getDisabledCompatibleChildren(isValidElement(children) ? children : React.createElement("span", null, children));
        const childProps = child.props;
        const childCls = classNames(childProps.className, {
            [openClassName || `${prefixCls}-open`]: true,
        });
        return (React.createElement(RcTooltip, Object.assign({}, this.props, { prefixCls: prefixCls, getTooltipContainer: getPopupContainer || getTooltipContainer, ref: this.saveTooltip, builtinPlacements: this.getPlacements(), overlay: overlay || title || '', visible: visible, onVisibleChange: this.onVisibleChange, onPopupAlign: this.onPopupAlign }), visible ? cloneElement(child, { className: childCls }) : child));
    }
}
Tooltip.displayName = 'Tooltip';
Tooltip.defaultProps = {
    placement: 'top',
    transitionName: 'zoom-big-fast',
    mouseEnterDelay: 0.1,
    mouseLeaveDelay: 0.1,
    arrowPointAtCenter: false,
    autoAdjustOverflow: true,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdG9vbHRpcC9pbmRleC50c3giLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsRUFDWixZQUFZLEVBQ1osU0FBUyxFQUVULGNBQWMsR0FHZixNQUFNLE9BQU8sQ0FBQztBQUNmLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLGFBQW1ELE1BQU0sY0FBYyxDQUFDO0FBRS9FLE9BQU8sU0FBUyxNQUFNLDBCQUEwQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFnRDVDLE1BQU0sV0FBVyxHQUFHLENBQUMsR0FBUSxFQUFFLElBQWMsRUFBRSxFQUFFO0lBQy9DLE1BQU0sTUFBTSxHQUFRLEVBQUUsQ0FBQztJQUN2QixNQUFNLE1BQU0sR0FBUSxFQUFFLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNqQixJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFO1lBQ3JCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDcEI7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDNUIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxPQUFRLFNBQVEsU0FBNEI7SUFjL0QsWUFBWSxLQUFtQjtRQUM3QixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFhZixvQkFBZSxHQUFHLENBQUMsT0FBZ0IsRUFBRSxFQUFFO1lBQ3JDLE1BQU0sRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxJQUFJLENB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LElBQUksQ0FBQyxXQUFXLEVBQ3JCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFDdkMsT0FBTyxFQUFFLE9BQU8sSUFBSSxLQUFLLElBQUksRUFBRSxFQUMvQixPQUFPLEVBQUUsT0FBTyxFQUNoQixlQUFlLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFDckMsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLEtBRTlCLE9BQU8sQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQ3JELENBQ2IsQ0FBQztJQUNKLENBQUM7O0FBbk1NLG1CQUFXLEdBQUcsU0FBUyxDQUFDO0FBRXhCLG9CQUFZLEdBQUc7SUFDcEIsU0FBUyxFQUFFLEtBQUs7SUFDaEIsY0FBYyxFQUFFLGVBQWU7SUFDL0IsZUFBZSxFQUFFLEdBQUc7SUFDcEIsZUFBZSxFQUFFLEdBQUc7SUFDcEIsa0JBQWtCLEVBQUUsS0FBSztJQUN6QixrQkFBa0IsRUFBRSxJQUFJO0NBQ3pCLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2h1aWh1YXdrL0RvY3VtZW50cy9vcHQvY2hvZXJvZG9uLXVpL2NvbXBvbmVudHMvdG9vbHRpcC9pbmRleC50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7XG4gIGNsb25lRWxlbWVudCxcbiAgQ29tcG9uZW50LFxuICBDU1NQcm9wZXJ0aWVzLFxuICBpc1ZhbGlkRWxlbWVudCxcbiAgUmVhY3RFbGVtZW50LFxuICBSZWFjdE5vZGUsXG59IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IGdldFBsYWNlbWVudHMsIHsgQWRqdXN0T3ZlcmZsb3csIFBsYWNlbWVudHNDb25maWcgfSBmcm9tICcuL3BsYWNlbWVudHMnO1xuaW1wb3J0IEJ1dHRvbiBmcm9tICcuLi9idXR0b24vaW5kZXgnO1xuaW1wb3J0IFJjVG9vbHRpcCBmcm9tICcuLi9yYy1jb21wb25lbnRzL3Rvb2x0aXAnO1xuaW1wb3J0IHsgZ2V0UHJlZml4Q2xzIH0gZnJvbSAnLi4vY29uZmlndXJlJztcblxuZXhwb3J0IHsgQWRqdXN0T3ZlcmZsb3csIFBsYWNlbWVudHNDb25maWcgfTtcblxuZXhwb3J0IHR5cGUgVG9vbHRpcFBsYWNlbWVudCA9XG4gIHwgJ3RvcCdcbiAgfCAnbGVmdCdcbiAgfCAncmlnaHQnXG4gIHwgJ2JvdHRvbSdcbiAgfCAndG9wTGVmdCdcbiAgfCAndG9wUmlnaHQnXG4gIHwgJ2JvdHRvbUxlZnQnXG4gIHwgJ2JvdHRvbVJpZ2h0J1xuICB8ICdsZWZ0VG9wJ1xuICB8ICdsZWZ0Qm90dG9tJ1xuICB8ICdyaWdodFRvcCdcbiAgfCAncmlnaHRCb3R0b20nO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFic3RyYWN0VG9vbHRpcFByb3BzIHtcbiAgcHJlZml4Q2xzPzogc3RyaW5nO1xuICBvdmVybGF5Q2xhc3NOYW1lPzogc3RyaW5nO1xuICBzdHlsZT86IENTU1Byb3BlcnRpZXM7XG4gIG92ZXJsYXlTdHlsZT86IENTU1Byb3BlcnRpZXM7XG4gIHBsYWNlbWVudD86IFRvb2x0aXBQbGFjZW1lbnQ7XG4gIGJ1aWx0aW5QbGFjZW1lbnRzPzogT2JqZWN0O1xuICBkZWZhdWx0VmlzaWJsZT86IGJvb2xlYW47XG4gIHZpc2libGU/OiBib29sZWFuO1xuICBvblZpc2libGVDaGFuZ2U/OiAodmlzaWJsZTogYm9vbGVhbikgPT4gdm9pZDtcbiAgbW91c2VFbnRlckRlbGF5PzogbnVtYmVyO1xuICBtb3VzZUxlYXZlRGVsYXk/OiBudW1iZXI7XG4gIHRyYW5zaXRpb25OYW1lPzogc3RyaW5nO1xuICB0cmlnZ2VyPzogJ2hvdmVyJyB8ICdmb2N1cycgfCAnY2xpY2snIHwgJ2NvbnRleHRNZW51JztcbiAgb3BlbkNsYXNzTmFtZT86IHN0cmluZztcbiAgYXJyb3dQb2ludEF0Q2VudGVyPzogYm9vbGVhbjtcbiAgYXV0b0FkanVzdE92ZXJmbG93PzogYm9vbGVhbiB8IEFkanVzdE92ZXJmbG93O1xuICAvLyBnZXRUb29sdGlwQ29udGFpbmVyIGhhZCBiZWVuIHJlbmFtZSB0byBnZXRQb3B1cENvbnRhaW5lclxuICBnZXRUb29sdGlwQ29udGFpbmVyPzogKHRyaWdnZXJOb2RlOiBFbGVtZW50KSA9PiBIVE1MRWxlbWVudDtcbiAgZ2V0UG9wdXBDb250YWluZXI/OiAodHJpZ2dlck5vZGU6IEVsZW1lbnQpID0+IEhUTUxFbGVtZW50O1xuICBjaGlsZHJlbj86IFJlYWN0Tm9kZTtcbn1cblxuZXhwb3J0IHR5cGUgUmVuZGVyRnVuY3Rpb24gPSAoKSA9PiBSZWFjdE5vZGU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9vbHRpcFByb3BzIGV4dGVuZHMgQWJzdHJhY3RUb29sdGlwUHJvcHMge1xuICB0aXRsZT86IFJlYWN0Tm9kZSB8IFJlbmRlckZ1bmN0aW9uO1xuICBvdmVybGF5PzogUmVhY3ROb2RlIHwgUmVuZGVyRnVuY3Rpb247XG59XG5cbmNvbnN0IHNwbGl0T2JqZWN0ID0gKG9iajogYW55LCBrZXlzOiBzdHJpbmdbXSkgPT4ge1xuICBjb25zdCBwaWNrZWQ6IGFueSA9IHt9O1xuICBjb25zdCBvbWl0ZWQ6IGFueSA9IHsgLi4ub2JqIH07XG4gIGtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgIGlmIChvYmogJiYga2V5IGluIG9iaikge1xuICAgICAgcGlja2VkW2tleV0gPSBvYmpba2V5XTtcbiAgICAgIGRlbGV0ZSBvbWl0ZWRba2V5XTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4geyBwaWNrZWQsIG9taXRlZCB9O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVG9vbHRpcCBleHRlbmRzIENvbXBvbmVudDxUb29sdGlwUHJvcHMsIGFueT4ge1xuICBzdGF0aWMgZGlzcGxheU5hbWUgPSAnVG9vbHRpcCc7XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBwbGFjZW1lbnQ6ICd0b3AnLFxuICAgIHRyYW5zaXRpb25OYW1lOiAnem9vbS1iaWctZmFzdCcsXG4gICAgbW91c2VFbnRlckRlbGF5OiAwLjEsXG4gICAgbW91c2VMZWF2ZURlbGF5OiAwLjEsXG4gICAgYXJyb3dQb2ludEF0Q2VudGVyOiBmYWxzZSxcbiAgICBhdXRvQWRqdXN0T3ZlcmZsb3c6IHRydWUsXG4gIH07XG5cbiAgcHJpdmF0ZSB0b29sdGlwOiBhbnk7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFRvb2x0aXBQcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcblxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICB2aXNpYmxlOiAhIXByb3BzLnZpc2libGUgfHwgISFwcm9wcy5kZWZhdWx0VmlzaWJsZSxcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IFRvb2x0aXBQcm9wcykge1xuICAgIGlmICgndmlzaWJsZScgaW4gbmV4dFByb3BzKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgdmlzaWJsZTogbmV4dFByb3BzLnZpc2libGUgfSk7XG4gICAgfVxuICB9XG5cbiAgb25WaXNpYmxlQ2hhbmdlID0gKHZpc2libGU6IGJvb2xlYW4pID0+IHtcbiAgICBjb25zdCB7IG9uVmlzaWJsZUNoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoISgndmlzaWJsZScgaW4gdGhpcy5wcm9wcykpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyB2aXNpYmxlOiB0aGlzLmlzTm9UaXRsZSgpID8gZmFsc2UgOiB2aXNpYmxlIH0pO1xuICAgIH1cbiAgICBpZiAob25WaXNpYmxlQ2hhbmdlICYmICF0aGlzLmlzTm9UaXRsZSgpKSB7XG4gICAgICBvblZpc2libGVDaGFuZ2UodmlzaWJsZSk7XG4gICAgfVxuICB9O1xuXG4gIGdldFBvcHVwRG9tTm9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy50b29sdGlwLmdldFBvcHVwRG9tTm9kZSgpO1xuICB9XG5cbiAgZ2V0UGxhY2VtZW50cygpIHtcbiAgICBjb25zdCB7IGJ1aWx0aW5QbGFjZW1lbnRzLCBhcnJvd1BvaW50QXRDZW50ZXIsIGF1dG9BZGp1c3RPdmVyZmxvdyB9ID0gdGhpcy5wcm9wcztcbiAgICByZXR1cm4gKFxuICAgICAgYnVpbHRpblBsYWNlbWVudHMgfHxcbiAgICAgIGdldFBsYWNlbWVudHMoe1xuICAgICAgICBhcnJvd1BvaW50QXRDZW50ZXIsXG4gICAgICAgIHZlcnRpY2FsQXJyb3dTaGlmdDogOCxcbiAgICAgICAgYXV0b0FkanVzdE92ZXJmbG93LFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgaXNIb3ZlclRyaWdnZXIoKSB7XG4gICAgY29uc3QgeyB0cmlnZ2VyIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmICghdHJpZ2dlciB8fCB0cmlnZ2VyID09PSAnaG92ZXInKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodHJpZ2dlcikpIHtcbiAgICAgIHJldHVybiB0cmlnZ2VyLmluZGV4T2YoJ2hvdmVyJykgPj0gMDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gRml4IFRvb2x0aXAgd29uJ3QgaGlkZSBhdCBkaXNhYmxlZCBidXR0b25cbiAgLy8gbW91c2UgZXZlbnRzIGRvbid0IHRyaWdnZXIgYXQgZGlzYWJsZWQgYnV0dG9uIGluIENocm9tZVxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vcmVhY3QtY29tcG9uZW50L3Rvb2x0aXAvaXNzdWVzLzE4XG4gIGdldERpc2FibGVkQ29tcGF0aWJsZUNoaWxkcmVuKGVsZW1lbnQ6IFJlYWN0RWxlbWVudDxhbnk+KSB7XG4gICAgY29uc3QgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGUgYXMgYW55XG4gICAgaWYgKFxuICAgICAgKCggZWxlbWVudFR5cGUuX19Qcm9fQlVUVE9OID09PSB0cnVlIHx8XG4gICAgICAgIGVsZW1lbnRUeXBlLl9fUHJvX1NXSVRDSCA9PT0gdHJ1ZSB8fFxuICAgICAgICBlbGVtZW50VHlwZS5fX1Byb19DSEVDS0JPWCA9PT0gdHJ1ZSB8fCBcbiAgICAgICAgKGVsZW1lbnQudHlwZSBhcyB0eXBlb2YgQnV0dG9uKS5fX0FOVF9CVVRUT04gfHwgXG4gICAgICAgIGVsZW1lbnQudHlwZSA9PT0gJ2J1dHRvbicpICYmXG4gICAgICAgIGVsZW1lbnQucHJvcHMuZGlzYWJsZWQgXG4gICAgICApICYmXG4gICAgICBlbGVtZW50LnByb3BzLmRpc2FibGVkICYmXG4gICAgICB0aGlzLmlzSG92ZXJUcmlnZ2VyKClcbiAgICApIHtcbiAgICAgIC8vIFBpY2sgc29tZSBsYXlvdXQgcmVsYXRlZCBzdHlsZSBwcm9wZXJ0aWVzIHVwIHRvIHNwYW5cblxuICAgICAgY29uc3QgeyBwaWNrZWQsIG9taXRlZCB9ID0gc3BsaXRPYmplY3QoZWxlbWVudC5wcm9wcy5zdHlsZSwgW1xuICAgICAgICAncG9zaXRpb24nLFxuICAgICAgICAnbGVmdCcsXG4gICAgICAgICdyaWdodCcsXG4gICAgICAgICd0b3AnLFxuICAgICAgICAnYm90dG9tJyxcbiAgICAgICAgJ2Zsb2F0JyxcbiAgICAgICAgJ2Rpc3BsYXknLFxuICAgICAgICAnekluZGV4JyxcbiAgICAgIF0pO1xuICAgICAgY29uc3Qgc3BhblN0eWxlID0ge1xuICAgICAgICBkaXNwbGF5OiAnaW5saW5lLWJsb2NrJywgLy8gZGVmYXVsdCBpbmxpbmUtYmxvY2sgaXMgaW1wb3J0YW50XG4gICAgICAgIC4uLnBpY2tlZCxcbiAgICAgICAgY3Vyc29yOiAnbm90LWFsbG93ZWQnLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IGJ1dHRvblN0eWxlID0ge1xuICAgICAgICAuLi5vbWl0ZWQsXG4gICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJyxcbiAgICAgIH07XG4gICAgICBjb25zdCBjaGlsZCA9IGNsb25lRWxlbWVudChlbGVtZW50LCB7XG4gICAgICAgIHN0eWxlOiBidXR0b25TdHlsZSxcbiAgICAgICAgY2xhc3NOYW1lOiBudWxsLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8c3BhbiBzdHlsZT17c3BhblN0eWxlfSBjbGFzc05hbWU9e2VsZW1lbnQucHJvcHMuY2xhc3NOYW1lfT5cbiAgICAgICAgICB7Y2hpbGR9XG4gICAgICAgIDwvc3Bhbj5cbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50O1xuICB9XG5cbiAgaXNOb1RpdGxlKCkge1xuICAgIGNvbnN0IHsgdGl0bGUsIG92ZXJsYXkgfSA9IHRoaXMucHJvcHM7XG4gICAgcmV0dXJuICF0aXRsZSAmJiAhb3ZlcmxheTsgLy8gb3ZlcmxheSBmb3Igb2xkIHZlcnNpb24gY29tcGF0aWJpbGl0eVxuICB9XG5cbiAgLy8g5Yqo5oCB6K6+572u5Yqo55S754K5XG4gIG9uUG9wdXBBbGlnbiA9IChkb21Ob2RlOiBIVE1MRWxlbWVudCwgYWxpZ246IGFueSkgPT4ge1xuICAgIGNvbnN0IHBsYWNlbWVudHM6IGFueSA9IHRoaXMuZ2V0UGxhY2VtZW50cygpO1xuICAgIC8vIOW9k+WJjei/lOWbnueahOS9jee9rlxuICAgIGNvbnN0IHBsYWNlbWVudCA9IE9iamVjdC5rZXlzKHBsYWNlbWVudHMpLmZpbHRlcihcbiAgICAgIGtleSA9PlxuICAgICAgICBwbGFjZW1lbnRzW2tleV0ucG9pbnRzWzBdID09PSBhbGlnbi5wb2ludHNbMF0gJiZcbiAgICAgICAgcGxhY2VtZW50c1trZXldLnBvaW50c1sxXSA9PT0gYWxpZ24ucG9pbnRzWzFdLFxuICAgIClbMF07XG4gICAgaWYgKCFwbGFjZW1lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8g5qC55o2u5b2T5YmN5Z2Q5qCH6K6+572u5Yqo55S754K5XG4gICAgY29uc3QgcmVjdCA9IGRvbU5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgdHJhbnNmb3JtT3JpZ2luID0ge1xuICAgICAgdG9wOiAnNTAlJyxcbiAgICAgIGxlZnQ6ICc1MCUnLFxuICAgIH07XG4gICAgaWYgKHBsYWNlbWVudC5pbmRleE9mKCd0b3AnKSA+PSAwIHx8IHBsYWNlbWVudC5pbmRleE9mKCdCb3R0b20nKSA+PSAwKSB7XG4gICAgICB0cmFuc2Zvcm1PcmlnaW4udG9wID0gYCR7cmVjdC5oZWlnaHQgLSBhbGlnbi5vZmZzZXRbMV19cHhgO1xuICAgIH0gZWxzZSBpZiAocGxhY2VtZW50LmluZGV4T2YoJ1RvcCcpID49IDAgfHwgcGxhY2VtZW50LmluZGV4T2YoJ2JvdHRvbScpID49IDApIHtcbiAgICAgIHRyYW5zZm9ybU9yaWdpbi50b3AgPSBgJHstYWxpZ24ub2Zmc2V0WzFdfXB4YDtcbiAgICB9XG4gICAgaWYgKHBsYWNlbWVudC5pbmRleE9mKCdsZWZ0JykgPj0gMCB8fCBwbGFjZW1lbnQuaW5kZXhPZignUmlnaHQnKSA+PSAwKSB7XG4gICAgICB0cmFuc2Zvcm1PcmlnaW4ubGVmdCA9IGAke3JlY3Qud2lkdGggLSBhbGlnbi5vZmZzZXRbMF19cHhgO1xuICAgIH0gZWxzZSBpZiAocGxhY2VtZW50LmluZGV4T2YoJ3JpZ2h0JykgPj0gMCB8fCBwbGFjZW1lbnQuaW5kZXhPZignTGVmdCcpID49IDApIHtcbiAgICAgIHRyYW5zZm9ybU9yaWdpbi5sZWZ0ID0gYCR7LWFsaWduLm9mZnNldFswXX1weGA7XG4gICAgfVxuICAgIGRvbU5vZGUuc3R5bGUudHJhbnNmb3JtT3JpZ2luID0gYCR7dHJhbnNmb3JtT3JpZ2luLmxlZnR9ICR7dHJhbnNmb3JtT3JpZ2luLnRvcH1gO1xuICB9O1xuXG4gIHNhdmVUb29sdGlwID0gKG5vZGU6IFJjVG9vbHRpcCB8IG51bGwpID0+IHtcbiAgICB0aGlzLnRvb2x0aXAgPSBub2RlO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0ZSB9ID0gdGhpcztcbiAgICBjb25zdCB7XG4gICAgICBwcmVmaXhDbHM6IGN1c3RvbWl6ZVByZWZpeENscyxcbiAgICAgIHRpdGxlLFxuICAgICAgb3ZlcmxheSxcbiAgICAgIG9wZW5DbGFzc05hbWUsXG4gICAgICBnZXRQb3B1cENvbnRhaW5lcixcbiAgICAgIGdldFRvb2x0aXBDb250YWluZXIsXG4gICAgfSA9IHByb3BzO1xuICAgIGNvbnN0IHByZWZpeENscyA9IGdldFByZWZpeENscygndG9vbHRpcCcsIGN1c3RvbWl6ZVByZWZpeENscyk7XG4gICAgY29uc3QgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbiBhcyBSZWFjdEVsZW1lbnQ8YW55PjtcbiAgICBsZXQgdmlzaWJsZSA9IHN0YXRlLnZpc2libGU7XG4gICAgLy8gSGlkZSB0b29sdGlwIHdoZW4gdGhlcmUgaXMgbm8gdGl0bGVcbiAgICBpZiAoISgndmlzaWJsZScgaW4gcHJvcHMpICYmIHRoaXMuaXNOb1RpdGxlKCkpIHtcbiAgICAgIHZpc2libGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGlsZCA9IHRoaXMuZ2V0RGlzYWJsZWRDb21wYXRpYmxlQ2hpbGRyZW4oXG4gICAgICBpc1ZhbGlkRWxlbWVudChjaGlsZHJlbikgPyBjaGlsZHJlbiA6IDxzcGFuPntjaGlsZHJlbn08L3NwYW4+LFxuICAgICk7XG4gICAgY29uc3QgY2hpbGRQcm9wcyA9IGNoaWxkLnByb3BzO1xuICAgIGNvbnN0IGNoaWxkQ2xzID0gY2xhc3NOYW1lcyhjaGlsZFByb3BzLmNsYXNzTmFtZSwge1xuICAgICAgW29wZW5DbGFzc05hbWUgfHwgYCR7cHJlZml4Q2xzfS1vcGVuYF06IHRydWUsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFJjVG9vbHRpcFxuICAgICAgICB7Li4udGhpcy5wcm9wc31cbiAgICAgICAgcHJlZml4Q2xzPXtwcmVmaXhDbHN9XG4gICAgICAgIGdldFRvb2x0aXBDb250YWluZXI9e2dldFBvcHVwQ29udGFpbmVyIHx8IGdldFRvb2x0aXBDb250YWluZXJ9XG4gICAgICAgIHJlZj17dGhpcy5zYXZlVG9vbHRpcH1cbiAgICAgICAgYnVpbHRpblBsYWNlbWVudHM9e3RoaXMuZ2V0UGxhY2VtZW50cygpfVxuICAgICAgICBvdmVybGF5PXtvdmVybGF5IHx8IHRpdGxlIHx8ICcnfVxuICAgICAgICB2aXNpYmxlPXt2aXNpYmxlfVxuICAgICAgICBvblZpc2libGVDaGFuZ2U9e3RoaXMub25WaXNpYmxlQ2hhbmdlfVxuICAgICAgICBvblBvcHVwQWxpZ249e3RoaXMub25Qb3B1cEFsaWdufVxuICAgICAgPlxuICAgICAgICB7dmlzaWJsZSA/IGNsb25lRWxlbWVudChjaGlsZCwgeyBjbGFzc05hbWU6IGNoaWxkQ2xzIH0pIDogY2hpbGR9XG4gICAgICA8L1JjVG9vbHRpcD5cbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=