fc3ef5809617420413f038b2d4093cd1
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getPrecision = getPrecision;
exports.plus = plus;
exports.getNearStepValues = getNearStepValues;
exports.MAX_SAFE_INTEGER = void 0;

var _moment = require("moment");

var _isNumber = _interopRequireDefault(require("lodash/isNumber"));

var _defaultTo = _interopRequireDefault(require("lodash/defaultTo"));

var MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER || Math.pow(2, 53) - 1;
exports.MAX_SAFE_INTEGER = MAX_SAFE_INTEGER;

function getPrecision(value) {
  var valueString = value.toString();

  if (valueString.indexOf('e-') >= 0) {
    return parseInt(valueString.slice(valueString.indexOf('e-') + 2), 10);
  }

  if (valueString.indexOf('.') >= 0) {
    return valueString.length - valueString.indexOf('.') - 1;
  }

  return 0;
}

function getMaxPrecision(value, step) {
  var stepPrecision = getPrecision(step);
  var currentValuePrecision = getPrecision(value);

  if (!value) {
    return stepPrecision;
  }

  return Math.max(currentValuePrecision, stepPrecision);
}

function getPrecisionFactor(value, step) {
  return Math.pow(10, getMaxPrecision(value, step));
}

function precisionFix(value, precisionFactor) {
  return Math.round(value * precisionFactor);
}

function plus() {
  for (var _len = arguments.length, values = new Array(_len), _key = 0; _key < _len; _key++) {
    values[_key] = arguments[_key];
  }

  if (values.length > 2) {
    return plus(values.shift(), plus.apply(void 0, values));
  }

  if (values.length < 2) {
    return values[0];
  }

  var v1 = values[0];
  var v2 = values[1];
  var precisionFactor = getPrecisionFactor(v1, v2);
  return (precisionFix(v1, precisionFactor) + precisionFix(v2, precisionFactor)) / precisionFactor;
}

function getBeforeStepValue(value, minFactor, stepFactor) {
  return value - (value - minFactor) % stepFactor;
}

function getNearStepMoments(value, step, unit) {
  var unitValue = value.get(unit);
  var mod = unitValue % step;

  if (mod !== 0) {
    var before = unitValue - mod;
    var after = before + step;
    return [value.clone().set(unit, before), value.clone().set(unit, after)];
  }
}

function getNearStepValues(value, step, min, max) {
  if ((0, _isNumber["default"])(step)) {
    if ((0, _isNumber["default"])(value)) {
      min = (0, _defaultTo["default"])(Number(min), -MAX_SAFE_INTEGER);
      max = (0, _defaultTo["default"])(Number(max), MAX_SAFE_INTEGER);
      var precisionFactor = getPrecisionFactor(value, step);
      var valueFactor = precisionFix(value, precisionFactor);
      var minFactor = precisionFix(min, precisionFactor);
      var minFactorBase = min === -MAX_SAFE_INTEGER ? 0 : minFactor;
      var maxFactor = precisionFix(max, precisionFactor);
      var stepFactor = precisionFix(step, precisionFactor);
      var beforeStepFactor = getBeforeStepValue(valueFactor, minFactorBase, stepFactor);

      if (beforeStepFactor === valueFactor) {
        return undefined;
      }

      if (beforeStepFactor > maxFactor) {
        beforeStepFactor = getBeforeStepValue(maxFactor, minFactorBase, stepFactor);
      } else if (beforeStepFactor < minFactor) {
        beforeStepFactor = minFactor;
      }

      var afterStepFactor = beforeStepFactor + stepFactor;
      var values = [beforeStepFactor / precisionFactor];

      if (afterStepFactor <= maxFactor) {
        values.push(afterStepFactor / precisionFactor);
      }

      return values;
    }
  } else if ((0, _moment.isMoment)(value)) {
    var hour = step.hour,
        minute = step.minute,
        second = step.second;

    if (second) {
      return getNearStepMoments(value, second, "s"
      /* second */
      );
    }

    if (minute) {
      return getNearStepMoments(value, minute, "m"
      /* minute */
      );
    }

    if (hour) {
      return getNearStepMoments(value, hour, "h"
      /* hour */
      );
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby9udW1iZXItZmllbGQvdXRpbHMudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUlPLElBQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLGdCQUFQLElBQTJCLFlBQUssRUFBTCxJQUFVLENBQTlEOzs7QUFFRCxTQUFVLFlBQVYsQ0FBdUIsS0FBdkIsRUFBb0M7QUFDeEMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFFBQU4sRUFBcEI7O0FBQ0EsTUFBSSxXQUFXLENBQUMsT0FBWixDQUFvQixJQUFwQixLQUE2QixDQUFqQyxFQUFvQztBQUNsQyxXQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBWixDQUFrQixXQUFXLENBQUMsT0FBWixDQUFvQixJQUFwQixJQUE0QixDQUE5QyxDQUFELEVBQW1ELEVBQW5ELENBQWY7QUFDRDs7QUFDRCxNQUFJLFdBQVcsQ0FBQyxPQUFaLENBQW9CLEdBQXBCLEtBQTRCLENBQWhDLEVBQW1DO0FBQ2pDLFdBQU8sV0FBVyxDQUFDLE1BQVosR0FBcUIsV0FBVyxDQUFDLE9BQVosQ0FBb0IsR0FBcEIsQ0FBckIsR0FBZ0QsQ0FBdkQ7QUFDRDs7QUFDRCxTQUFPLENBQVA7QUFDRDs7QUFFRCxTQUFTLGVBQVQsQ0FBeUIsS0FBekIsRUFBd0MsSUFBeEMsRUFBb0Q7QUFDbEQsTUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLElBQUQsQ0FBbEM7QUFDQSxNQUFNLHFCQUFxQixHQUFHLFlBQVksQ0FBQyxLQUFELENBQTFDOztBQUNBLE1BQUksQ0FBQyxLQUFMLEVBQVk7QUFDVixXQUFPLGFBQVA7QUFDRDs7QUFDRCxTQUFPLElBQUksQ0FBQyxHQUFMLENBQVMscUJBQVQsRUFBZ0MsYUFBaEMsQ0FBUDtBQUNEOztBQUVELFNBQVMsa0JBQVQsQ0FBNEIsS0FBNUIsRUFBMkMsSUFBM0MsRUFBdUQ7QUFDckQsa0JBQU8sRUFBUCxFQUFhLGVBQWUsQ0FBQyxLQUFELEVBQVEsSUFBUixDQUE1QjtBQUNEOztBQUVELFNBQVMsWUFBVCxDQUFzQixLQUF0QixFQUFxQyxlQUFyQyxFQUE0RDtBQUMxRCxTQUFPLElBQUksQ0FBQyxLQUFMLENBQVcsS0FBSyxHQUFHLGVBQW5CLENBQVA7QUFDRDs7QUFFSyxTQUFVLElBQVYsR0FBa0M7QUFBQSxvQ0FBaEIsTUFBZ0I7QUFBaEIsSUFBQSxNQUFnQjtBQUFBOztBQUN0QyxNQUFJLE1BQU0sQ0FBQyxNQUFQLEdBQWdCLENBQXBCLEVBQXVCO0FBQ3JCLFdBQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFQLEVBQUQsRUFBMkIsSUFBSSxNQUFKLFNBQVEsTUFBUixDQUEzQixDQUFYO0FBQ0Q7O0FBQ0QsTUFBSSxNQUFNLENBQUMsTUFBUCxHQUFnQixDQUFwQixFQUF1QjtBQUNyQixXQUFPLE1BQU0sQ0FBQyxDQUFELENBQWI7QUFDRDs7QUFDRCxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsQ0FBRCxDQUFqQjtBQUNBLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFELENBQWpCO0FBQ0EsTUFBTSxlQUFlLEdBQUcsa0JBQWtCLENBQUMsRUFBRCxFQUFLLEVBQUwsQ0FBMUM7QUFDQSxTQUFPLENBQUMsWUFBWSxDQUFDLEVBQUQsRUFBSyxlQUFMLENBQVosR0FBb0MsWUFBWSxDQUFDLEVBQUQsRUFBSyxlQUFMLENBQWpELElBQTBFLGVBQWpGO0FBQ0Q7O0FBRUQsU0FBUyxrQkFBVCxDQUE0QixLQUE1QixFQUEyQyxTQUEzQyxFQUE4RCxVQUE5RCxFQUFnRjtBQUM5RSxTQUFPLEtBQUssR0FBSSxDQUFDLEtBQUssR0FBRyxTQUFULElBQXNCLFVBQXRDO0FBQ0Q7O0FBRUQsU0FBUyxrQkFBVCxDQUNFLEtBREYsRUFFRSxJQUZGLEVBR0UsSUFIRixFQUd1QjtBQUVyQixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBbEI7QUFDQSxNQUFNLEdBQUcsR0FBRyxTQUFTLEdBQUcsSUFBeEI7O0FBQ0EsTUFBSSxHQUFHLEtBQUssQ0FBWixFQUFlO0FBQ2IsUUFBTSxNQUFNLEdBQUcsU0FBUyxHQUFHLEdBQTNCO0FBQ0EsUUFBTSxLQUFLLEdBQUcsTUFBTSxHQUFHLElBQXZCO0FBQ0EsV0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFOLEdBQWMsR0FBZCxDQUFrQixJQUFsQixFQUF3QixNQUF4QixDQUFELEVBQWtDLEtBQUssQ0FBQyxLQUFOLEdBQWMsR0FBZCxDQUFrQixJQUFsQixFQUF3QixLQUF4QixDQUFsQyxDQUFQO0FBQ0Q7QUFDRjs7QUFFSyxTQUFVLGlCQUFWLENBQ0osS0FESSxFQUVKLElBRkksRUFHSixHQUhJLEVBSUosR0FKSSxFQUl3QjtBQUU1QixNQUFJLDBCQUFTLElBQVQsQ0FBSixFQUFvQjtBQUNsQixRQUFJLDBCQUFTLEtBQVQsQ0FBSixFQUFxQjtBQUNuQixNQUFBLEdBQUcsR0FBRywyQkFBVSxNQUFNLENBQUMsR0FBRCxDQUFoQixFQUF1QixDQUFDLGdCQUF4QixDQUFOO0FBQ0EsTUFBQSxHQUFHLEdBQUcsMkJBQVUsTUFBTSxDQUFDLEdBQUQsQ0FBaEIsRUFBdUIsZ0JBQXZCLENBQU47QUFDQSxVQUFNLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQyxLQUFELEVBQVEsSUFBUixDQUExQztBQUNBLFVBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxLQUFELEVBQVEsZUFBUixDQUFoQztBQUNBLFVBQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxHQUFELEVBQU0sZUFBTixDQUE5QjtBQUNBLFVBQU0sYUFBYSxHQUFHLEdBQUcsS0FBSyxDQUFDLGdCQUFULEdBQTRCLENBQTVCLEdBQWdDLFNBQXREO0FBQ0EsVUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLEdBQUQsRUFBTSxlQUFOLENBQTlCO0FBQ0EsVUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLElBQUQsRUFBTyxlQUFQLENBQS9CO0FBQ0EsVUFBSSxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQyxXQUFELEVBQWMsYUFBZCxFQUE2QixVQUE3QixDQUF6Qzs7QUFDQSxVQUFJLGdCQUFnQixLQUFLLFdBQXpCLEVBQXNDO0FBQ3BDLGVBQU8sU0FBUDtBQUNEOztBQUNELFVBQUksZ0JBQWdCLEdBQUcsU0FBdkIsRUFBa0M7QUFDaEMsUUFBQSxnQkFBZ0IsR0FBRyxrQkFBa0IsQ0FBQyxTQUFELEVBQVksYUFBWixFQUEyQixVQUEzQixDQUFyQztBQUNELE9BRkQsTUFFTyxJQUFJLGdCQUFnQixHQUFHLFNBQXZCLEVBQWtDO0FBQ3ZDLFFBQUEsZ0JBQWdCLEdBQUcsU0FBbkI7QUFDRDs7QUFDRCxVQUFNLGVBQWUsR0FBRyxnQkFBZ0IsR0FBRyxVQUEzQztBQUNBLFVBQU0sTUFBTSxHQUFhLENBQUMsZ0JBQWdCLEdBQUcsZUFBcEIsQ0FBekI7O0FBQ0EsVUFBSSxlQUFlLElBQUksU0FBdkIsRUFBa0M7QUFDaEMsUUFBQSxNQUFNLENBQUMsSUFBUCxDQUFZLGVBQWUsR0FBRyxlQUE5QjtBQUNEOztBQUNELGFBQU8sTUFBUDtBQUNEO0FBQ0YsR0ExQkQsTUEwQk8sSUFBSSxzQkFBUyxLQUFULENBQUosRUFBcUI7QUFBQSxRQUNsQixJQURrQixHQUNPLElBRFAsQ0FDbEIsSUFEa0I7QUFBQSxRQUNaLE1BRFksR0FDTyxJQURQLENBQ1osTUFEWTtBQUFBLFFBQ0osTUFESSxHQUNPLElBRFAsQ0FDSixNQURJOztBQUUxQixRQUFJLE1BQUosRUFBWTtBQUNWLGFBQU8sa0JBQWtCLENBQUMsS0FBRCxFQUFRLE1BQVIsRUFBYztBQUFBO0FBQWQsT0FBekI7QUFDRDs7QUFDRCxRQUFJLE1BQUosRUFBWTtBQUNWLGFBQU8sa0JBQWtCLENBQUMsS0FBRCxFQUFRLE1BQVIsRUFBYztBQUFBO0FBQWQsT0FBekI7QUFDRDs7QUFDRCxRQUFJLElBQUosRUFBVTtBQUNSLGFBQU8sa0JBQWtCLENBQUMsS0FBRCxFQUFRLElBQVIsRUFBWTtBQUFBO0FBQVosT0FBekI7QUFDRDtBQUNGO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc01vbWVudCwgTW9tZW50LCB1bml0T2ZUaW1lIH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCBpc051bWJlciBmcm9tICdsb2Rhc2gvaXNOdW1iZXInO1xuaW1wb3J0IGRlZmF1bHRUbyBmcm9tICdsb2Rhc2gvZGVmYXVsdFRvJztcbmltcG9ydCB7IFRpbWVTdGVwIH0gZnJvbSAnLi4vZGF0ZS1waWNrZXIvRGF0ZVBpY2tlcic7XG5pbXBvcnQgeyBUaW1lVW5pdCB9IGZyb20gJy4uL2RhdGUtcGlja2VyL2VudW0nO1xuXG5leHBvcnQgY29uc3QgTUFYX1NBRkVfSU5URUdFUiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSIHx8IDIgKiogNTMgLSAxO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJlY2lzaW9uKHZhbHVlOiBudW1iZXIpOiBudW1iZXIge1xuICBjb25zdCB2YWx1ZVN0cmluZyA9IHZhbHVlLnRvU3RyaW5nKCk7XG4gIGlmICh2YWx1ZVN0cmluZy5pbmRleE9mKCdlLScpID49IDApIHtcbiAgICByZXR1cm4gcGFyc2VJbnQodmFsdWVTdHJpbmcuc2xpY2UodmFsdWVTdHJpbmcuaW5kZXhPZignZS0nKSArIDIpLCAxMCk7XG4gIH1cbiAgaWYgKHZhbHVlU3RyaW5nLmluZGV4T2YoJy4nKSA+PSAwKSB7XG4gICAgcmV0dXJuIHZhbHVlU3RyaW5nLmxlbmd0aCAtIHZhbHVlU3RyaW5nLmluZGV4T2YoJy4nKSAtIDE7XG4gIH1cbiAgcmV0dXJuIDA7XG59XG5cbmZ1bmN0aW9uIGdldE1heFByZWNpc2lvbih2YWx1ZTogbnVtYmVyLCBzdGVwOiBudW1iZXIpOiBudW1iZXIge1xuICBjb25zdCBzdGVwUHJlY2lzaW9uID0gZ2V0UHJlY2lzaW9uKHN0ZXApO1xuICBjb25zdCBjdXJyZW50VmFsdWVQcmVjaXNpb24gPSBnZXRQcmVjaXNpb24odmFsdWUpO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIHN0ZXBQcmVjaXNpb247XG4gIH1cbiAgcmV0dXJuIE1hdGgubWF4KGN1cnJlbnRWYWx1ZVByZWNpc2lvbiwgc3RlcFByZWNpc2lvbik7XG59XG5cbmZ1bmN0aW9uIGdldFByZWNpc2lvbkZhY3Rvcih2YWx1ZTogbnVtYmVyLCBzdGVwOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gMTAgKiogZ2V0TWF4UHJlY2lzaW9uKHZhbHVlLCBzdGVwKTtcbn1cblxuZnVuY3Rpb24gcHJlY2lzaW9uRml4KHZhbHVlOiBudW1iZXIsIHByZWNpc2lvbkZhY3RvcjogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBwcmVjaXNpb25GYWN0b3IpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGx1cyguLi52YWx1ZXM6IG51bWJlcltdKSB7XG4gIGlmICh2YWx1ZXMubGVuZ3RoID4gMikge1xuICAgIHJldHVybiBwbHVzKHZhbHVlcy5zaGlmdCgpIGFzIG51bWJlciwgcGx1cyguLi52YWx1ZXMpKTtcbiAgfVxuICBpZiAodmFsdWVzLmxlbmd0aCA8IDIpIHtcbiAgICByZXR1cm4gdmFsdWVzWzBdO1xuICB9XG4gIGNvbnN0IHYxID0gdmFsdWVzWzBdO1xuICBjb25zdCB2MiA9IHZhbHVlc1sxXTtcbiAgY29uc3QgcHJlY2lzaW9uRmFjdG9yID0gZ2V0UHJlY2lzaW9uRmFjdG9yKHYxLCB2Mik7XG4gIHJldHVybiAocHJlY2lzaW9uRml4KHYxLCBwcmVjaXNpb25GYWN0b3IpICsgcHJlY2lzaW9uRml4KHYyLCBwcmVjaXNpb25GYWN0b3IpKSAvIHByZWNpc2lvbkZhY3Rvcjtcbn1cblxuZnVuY3Rpb24gZ2V0QmVmb3JlU3RlcFZhbHVlKHZhbHVlOiBudW1iZXIsIG1pbkZhY3RvcjogbnVtYmVyLCBzdGVwRmFjdG9yOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gdmFsdWUgLSAoKHZhbHVlIC0gbWluRmFjdG9yKSAlIHN0ZXBGYWN0b3IpO1xufVxuXG5mdW5jdGlvbiBnZXROZWFyU3RlcE1vbWVudHMoXG4gIHZhbHVlOiBNb21lbnQsXG4gIHN0ZXA6IG51bWJlcixcbiAgdW5pdDogdW5pdE9mVGltZS5CYXNlLFxuKTogTW9tZW50W10gfCB1bmRlZmluZWQge1xuICBjb25zdCB1bml0VmFsdWUgPSB2YWx1ZS5nZXQodW5pdCk7XG4gIGNvbnN0IG1vZCA9IHVuaXRWYWx1ZSAlIHN0ZXA7XG4gIGlmIChtb2QgIT09IDApIHtcbiAgICBjb25zdCBiZWZvcmUgPSB1bml0VmFsdWUgLSBtb2Q7XG4gICAgY29uc3QgYWZ0ZXIgPSBiZWZvcmUgKyBzdGVwO1xuICAgIHJldHVybiBbdmFsdWUuY2xvbmUoKS5zZXQodW5pdCwgYmVmb3JlKSwgdmFsdWUuY2xvbmUoKS5zZXQodW5pdCwgYWZ0ZXIpXTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmVhclN0ZXBWYWx1ZXM8VCBleHRlbmRzIE1vbWVudCB8IG51bWJlcj4oXG4gIHZhbHVlOiBULFxuICBzdGVwOiBudW1iZXIgfCBUaW1lU3RlcCxcbiAgbWluPzogbnVtYmVyIHwgTW9tZW50IHwgbnVsbCxcbiAgbWF4PzogbnVtYmVyIHwgTW9tZW50IHwgbnVsbCxcbik6IFRbXSB8IHVuZGVmaW5lZCB7XG4gIGlmIChpc051bWJlcihzdGVwKSkge1xuICAgIGlmIChpc051bWJlcih2YWx1ZSkpIHtcbiAgICAgIG1pbiA9IGRlZmF1bHRUbyhOdW1iZXIobWluKSwgLU1BWF9TQUZFX0lOVEVHRVIpO1xuICAgICAgbWF4ID0gZGVmYXVsdFRvKE51bWJlcihtYXgpLCBNQVhfU0FGRV9JTlRFR0VSKTtcbiAgICAgIGNvbnN0IHByZWNpc2lvbkZhY3RvciA9IGdldFByZWNpc2lvbkZhY3Rvcih2YWx1ZSwgc3RlcCk7XG4gICAgICBjb25zdCB2YWx1ZUZhY3RvciA9IHByZWNpc2lvbkZpeCh2YWx1ZSwgcHJlY2lzaW9uRmFjdG9yKTtcbiAgICAgIGNvbnN0IG1pbkZhY3RvciA9IHByZWNpc2lvbkZpeChtaW4sIHByZWNpc2lvbkZhY3Rvcik7XG4gICAgICBjb25zdCBtaW5GYWN0b3JCYXNlID0gbWluID09PSAtTUFYX1NBRkVfSU5URUdFUiA/IDAgOiBtaW5GYWN0b3I7XG4gICAgICBjb25zdCBtYXhGYWN0b3IgPSBwcmVjaXNpb25GaXgobWF4LCBwcmVjaXNpb25GYWN0b3IpO1xuICAgICAgY29uc3Qgc3RlcEZhY3RvciA9IHByZWNpc2lvbkZpeChzdGVwLCBwcmVjaXNpb25GYWN0b3IpO1xuICAgICAgbGV0IGJlZm9yZVN0ZXBGYWN0b3IgPSBnZXRCZWZvcmVTdGVwVmFsdWUodmFsdWVGYWN0b3IsIG1pbkZhY3RvckJhc2UsIHN0ZXBGYWN0b3IpO1xuICAgICAgaWYgKGJlZm9yZVN0ZXBGYWN0b3IgPT09IHZhbHVlRmFjdG9yKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBpZiAoYmVmb3JlU3RlcEZhY3RvciA+IG1heEZhY3Rvcikge1xuICAgICAgICBiZWZvcmVTdGVwRmFjdG9yID0gZ2V0QmVmb3JlU3RlcFZhbHVlKG1heEZhY3RvciwgbWluRmFjdG9yQmFzZSwgc3RlcEZhY3Rvcik7XG4gICAgICB9IGVsc2UgaWYgKGJlZm9yZVN0ZXBGYWN0b3IgPCBtaW5GYWN0b3IpIHtcbiAgICAgICAgYmVmb3JlU3RlcEZhY3RvciA9IG1pbkZhY3RvcjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFmdGVyU3RlcEZhY3RvciA9IGJlZm9yZVN0ZXBGYWN0b3IgKyBzdGVwRmFjdG9yO1xuICAgICAgY29uc3QgdmFsdWVzOiBudW1iZXJbXSA9IFtiZWZvcmVTdGVwRmFjdG9yIC8gcHJlY2lzaW9uRmFjdG9yXTtcbiAgICAgIGlmIChhZnRlclN0ZXBGYWN0b3IgPD0gbWF4RmFjdG9yKSB7XG4gICAgICAgIHZhbHVlcy5wdXNoKGFmdGVyU3RlcEZhY3RvciAvIHByZWNpc2lvbkZhY3Rvcik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWVzIGFzIFRbXTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoaXNNb21lbnQodmFsdWUpKSB7XG4gICAgY29uc3QgeyBob3VyLCBtaW51dGUsIHNlY29uZCB9ID0gc3RlcDtcbiAgICBpZiAoc2Vjb25kKSB7XG4gICAgICByZXR1cm4gZ2V0TmVhclN0ZXBNb21lbnRzKHZhbHVlLCBzZWNvbmQsIFRpbWVVbml0LnNlY29uZCkgYXMgVFtdO1xuICAgIH1cbiAgICBpZiAobWludXRlKSB7XG4gICAgICByZXR1cm4gZ2V0TmVhclN0ZXBNb21lbnRzKHZhbHVlLCBtaW51dGUsIFRpbWVVbml0Lm1pbnV0ZSkgYXMgVFtdO1xuICAgIH1cbiAgICBpZiAoaG91cikge1xuICAgICAgcmV0dXJuIGdldE5lYXJTdGVwTW9tZW50cyh2YWx1ZSwgaG91ciwgVGltZVVuaXQuaG91cikgYXMgVFtdO1xuICAgIH1cbiAgfVxufVxuIl19