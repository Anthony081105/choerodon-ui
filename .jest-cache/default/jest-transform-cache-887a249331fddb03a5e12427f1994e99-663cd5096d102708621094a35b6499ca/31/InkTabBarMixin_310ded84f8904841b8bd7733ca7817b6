06bffd2adc783e0cc6c8d875404a1cc9
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getScroll = getScroll;
exports["default"] = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _utils = require("./utils");

var _react = _interopRequireDefault(require("react"));

var _classnames2 = _interopRequireDefault(require("classnames"));

var isDev = process.env.NODE_ENV !== 'production';

function getScroll(w, top) {
  var ret = w["page".concat(top ? 'Y' : 'X', "Offset")];
  var method = "scroll".concat(top ? 'Top' : 'Left');

  if (typeof ret !== 'number') {
    var d = w.document; // ie6,7,8 standard mode

    ret = d.documentElement[method];

    if (typeof ret !== 'number') {
      // quirks mode
      ret = d.body[method];
    }
  }

  return ret;
}

function offset(elem) {
  var box;
  var x;
  var y;
  var doc = elem.ownerDocument;
  var body = doc.body;
  var docElem = doc && doc.documentElement;
  box = elem.getBoundingClientRect();
  x = box.left;
  y = box.top;
  x -= docElem.clientLeft || body.clientLeft || 0;
  y -= docElem.clientTop || body.clientTop || 0;
  var w = doc.defaultView || doc.parentWindow;
  x += getScroll(w);
  y += getScroll(w, true);
  return {
    left: x,
    top: y
  };
}

function _componentDidUpdate(component, init) {
  var styles = component.props.styles;
  var rootNode = component.root;
  var wrapNode = component.nav || rootNode;
  var containerOffset = offset(wrapNode);
  var inkBarNode = component.inkBar;
  var activeTab = component.activeTab;
  var inkBarNodeStyle = inkBarNode.style;
  var tabBarPosition = component.props.tabBarPosition;

  if (init) {
    // prevent mount animation
    inkBarNodeStyle.display = 'none';
  }

  if (activeTab) {
    var tabNode = activeTab;
    var tabOffset = offset(tabNode);
    var transformSupported = (0, _utils.isTransformSupported)(inkBarNodeStyle);

    if (tabBarPosition === 'top' || tabBarPosition === 'bottom') {
      var left = tabOffset.left - containerOffset.left;
      var width = tabNode.offsetWidth; // If tabNode'width width equal to wrapNode'width when tabBarPosition is top or bottom
      // It means no css working, then ink bar should not have width until css is loaded

      if (width === rootNode.offsetWidth) {
        width = 0;
      } else if (styles.inkBar && styles.inkBar.width !== undefined) {
        width = parseFloat(styles.inkBar.width, 10);

        if (width) {
          left = left + (tabNode.offsetWidth - width) / 2;
        }
      } // use 3d gpu to optimize render


      if (transformSupported) {
        (0, _utils.setTransform)(inkBarNodeStyle, "translate3d(".concat(left, "px,0,0)"));
        inkBarNodeStyle.width = "".concat(width, "px");
        inkBarNodeStyle.height = '';
      } else {
        inkBarNodeStyle.left = "".concat(left, "px");
        inkBarNodeStyle.top = '';
        inkBarNodeStyle.bottom = '';
        inkBarNodeStyle.right = "".concat(wrapNode.offsetWidth - left - width, "px");
      }
    } else {
      var top = tabOffset.top - containerOffset.top;
      var height = tabNode.offsetHeight;

      if (styles.inkBar && styles.inkBar.height !== undefined) {
        height = parseFloat(styles.inkBar.height, 10);

        if (height) {
          top = top + (tabNode.offsetHeight - height) / 2;
        }
      }

      if (transformSupported) {
        (0, _utils.setTransform)(inkBarNodeStyle, "translate3d(0,".concat(top, "px,0)"));
        inkBarNodeStyle.height = "".concat(height, "px");
        inkBarNodeStyle.width = '';
      } else {
        inkBarNodeStyle.left = '';
        inkBarNodeStyle.right = '';
        inkBarNodeStyle.top = "".concat(top, "px");
        inkBarNodeStyle.bottom = "".concat(wrapNode.offsetHeight - top - height, "px");
      }
    }
  }

  inkBarNodeStyle.display = activeTab ? 'block' : 'none';
}

var _default = {
  getDefaultProps: function getDefaultProps() {
    return {
      inkBarAnimated: true
    };
  },
  componentDidUpdate: function componentDidUpdate() {
    _componentDidUpdate(this);
  },
  componentDidMount: function componentDidMount() {
    var _this = this;

    if (isDev) {
      this.timeout = setTimeout(function () {
        _componentDidUpdate(_this, true);
      }, 0);
    } else {
      _componentDidUpdate(this, true);
    }
  },
  componentWillUnmount: function componentWillUnmount() {
    clearTimeout(this.timeout);
  },
  getInkBarNode: function getInkBarNode() {
    var _classnames;

    var _this$props = this.props,
        prefixCls = _this$props.prefixCls,
        styles = _this$props.styles,
        inkBarAnimated = _this$props.inkBarAnimated;
    var className = "".concat(prefixCls, "-ink-bar");
    var classes = (0, _classnames2["default"])((_classnames = {}, (0, _defineProperty2["default"])(_classnames, className, true), (0, _defineProperty2["default"])(_classnames, inkBarAnimated ? "".concat(className, "-animated") : "".concat(className, "-no-animated"), true), _classnames));
    return _react["default"].createElement("div", {
      style: styles.inkBar,
      className: classes,
      key: "inkBar",
      ref: this.saveRef('inkBar')
    });
  }
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIklua1RhYkJhck1peGluLmpzeCJdLCJuYW1lcyI6WyJpc0RldiIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImdldFNjcm9sbCIsInciLCJ0b3AiLCJyZXQiLCJtZXRob2QiLCJkIiwiZG9jdW1lbnQiLCJkb2N1bWVudEVsZW1lbnQiLCJib2R5Iiwib2Zmc2V0IiwiZWxlbSIsImJveCIsIngiLCJ5IiwiZG9jIiwib3duZXJEb2N1bWVudCIsImRvY0VsZW0iLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJsZWZ0IiwiY2xpZW50TGVmdCIsImNsaWVudFRvcCIsImRlZmF1bHRWaWV3IiwicGFyZW50V2luZG93IiwiY29tcG9uZW50RGlkVXBkYXRlIiwiY29tcG9uZW50IiwiaW5pdCIsInN0eWxlcyIsInByb3BzIiwicm9vdE5vZGUiLCJyb290Iiwid3JhcE5vZGUiLCJuYXYiLCJjb250YWluZXJPZmZzZXQiLCJpbmtCYXJOb2RlIiwiaW5rQmFyIiwiYWN0aXZlVGFiIiwiaW5rQmFyTm9kZVN0eWxlIiwic3R5bGUiLCJ0YWJCYXJQb3NpdGlvbiIsImRpc3BsYXkiLCJ0YWJOb2RlIiwidGFiT2Zmc2V0IiwidHJhbnNmb3JtU3VwcG9ydGVkIiwid2lkdGgiLCJvZmZzZXRXaWR0aCIsInVuZGVmaW5lZCIsInBhcnNlRmxvYXQiLCJoZWlnaHQiLCJib3R0b20iLCJyaWdodCIsIm9mZnNldEhlaWdodCIsImdldERlZmF1bHRQcm9wcyIsImlua0JhckFuaW1hdGVkIiwiY29tcG9uZW50RGlkTW91bnQiLCJ0aW1lb3V0Iiwic2V0VGltZW91dCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiY2xlYXJUaW1lb3V0IiwiZ2V0SW5rQmFyTm9kZSIsInByZWZpeENscyIsImNsYXNzTmFtZSIsImNsYXNzZXMiLCJzYXZlUmVmIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixD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WSxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNUcmFuc2Zvcm1TdXBwb3J0ZWQsIHNldFRyYW5zZm9ybSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuXG5jb25zdCBpc0RldiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbic7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTY3JvbGwodywgdG9wKSB7XG4gIGxldCByZXQgPSB3W2BwYWdlJHt0b3AgPyAnWScgOiAnWCd9T2Zmc2V0YF07XG4gIGNvbnN0IG1ldGhvZCA9IGBzY3JvbGwke3RvcCA/ICdUb3AnIDogJ0xlZnQnfWA7XG4gIGlmICh0eXBlb2YgcmV0ICE9PSAnbnVtYmVyJykge1xuICAgIGNvbnN0IGQgPSB3LmRvY3VtZW50O1xuICAgIC8vIGllNiw3LDggc3RhbmRhcmQgbW9kZVxuICAgIHJldCA9IGQuZG9jdW1lbnRFbGVtZW50W21ldGhvZF07XG4gICAgaWYgKHR5cGVvZiByZXQgIT09ICdudW1iZXInKSB7XG4gICAgICAvLyBxdWlya3MgbW9kZVxuICAgICAgcmV0ID0gZC5ib2R5W21ldGhvZF07XG4gICAgfVxuICB9XG4gIHJldHVybiByZXQ7XG59XG5cbmZ1bmN0aW9uIG9mZnNldChlbGVtKSB7XG4gIGxldCBib3g7XG4gIGxldCB4O1xuICBsZXQgeTtcbiAgY29uc3QgZG9jID0gZWxlbS5vd25lckRvY3VtZW50O1xuICBjb25zdCBib2R5ID0gZG9jLmJvZHk7XG4gIGNvbnN0IGRvY0VsZW0gPSBkb2MgJiYgZG9jLmRvY3VtZW50RWxlbWVudDtcbiAgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgeCA9IGJveC5sZWZ0O1xuICB5ID0gYm94LnRvcDtcbiAgeCAtPSBkb2NFbGVtLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDA7XG4gIHkgLT0gZG9jRWxlbS5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMDtcbiAgY29uc3QgdyA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93O1xuICB4ICs9IGdldFNjcm9sbCh3KTtcbiAgeSArPSBnZXRTY3JvbGwodywgdHJ1ZSk7XG4gIHJldHVybiB7XG4gICAgbGVmdDogeCwgdG9wOiB5LFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb21wb25lbnREaWRVcGRhdGUoY29tcG9uZW50LCBpbml0KSB7XG4gIGNvbnN0IHsgc3R5bGVzIH0gPSBjb21wb25lbnQucHJvcHM7XG4gIGNvbnN0IHJvb3ROb2RlID0gY29tcG9uZW50LnJvb3Q7XG4gIGNvbnN0IHdyYXBOb2RlID0gY29tcG9uZW50Lm5hdiB8fCByb290Tm9kZTtcbiAgY29uc3QgY29udGFpbmVyT2Zmc2V0ID0gb2Zmc2V0KHdyYXBOb2RlKTtcbiAgY29uc3QgaW5rQmFyTm9kZSA9IGNvbXBvbmVudC5pbmtCYXI7XG4gIGNvbnN0IGFjdGl2ZVRhYiA9IGNvbXBvbmVudC5hY3RpdmVUYWI7XG4gIGNvbnN0IGlua0Jhck5vZGVTdHlsZSA9IGlua0Jhck5vZGUuc3R5bGU7XG4gIGNvbnN0IHRhYkJhclBvc2l0aW9uID0gY29tcG9uZW50LnByb3BzLnRhYkJhclBvc2l0aW9uO1xuICBpZiAoaW5pdCkge1xuICAgIC8vIHByZXZlbnQgbW91bnQgYW5pbWF0aW9uXG4gICAgaW5rQmFyTm9kZVN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gIH1cbiAgaWYgKGFjdGl2ZVRhYikge1xuICAgIGNvbnN0IHRhYk5vZGUgPSBhY3RpdmVUYWI7XG4gICAgY29uc3QgdGFiT2Zmc2V0ID0gb2Zmc2V0KHRhYk5vZGUpO1xuICAgIGNvbnN0IHRyYW5zZm9ybVN1cHBvcnRlZCA9IGlzVHJhbnNmb3JtU3VwcG9ydGVkKGlua0Jhck5vZGVTdHlsZSk7XG4gICAgaWYgKHRhYkJhclBvc2l0aW9uID09PSAndG9wJyB8fCB0YWJCYXJQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgIGxldCBsZWZ0ID0gdGFiT2Zmc2V0LmxlZnQgLSBjb250YWluZXJPZmZzZXQubGVmdDtcbiAgICAgIGxldCB3aWR0aCA9IHRhYk5vZGUub2Zmc2V0V2lkdGg7XG5cbiAgICAgIC8vIElmIHRhYk5vZGUnd2lkdGggd2lkdGggZXF1YWwgdG8gd3JhcE5vZGUnd2lkdGggd2hlbiB0YWJCYXJQb3NpdGlvbiBpcyB0b3Agb3IgYm90dG9tXG4gICAgICAvLyBJdCBtZWFucyBubyBjc3Mgd29ya2luZywgdGhlbiBpbmsgYmFyIHNob3VsZCBub3QgaGF2ZSB3aWR0aCB1bnRpbCBjc3MgaXMgbG9hZGVkXG4gICAgICBpZiAod2lkdGggPT09IHJvb3ROb2RlLm9mZnNldFdpZHRoKSB7XG4gICAgICAgIHdpZHRoID0gMDtcbiAgICAgIH0gZWxzZSBpZiAoc3R5bGVzLmlua0JhciAmJiBzdHlsZXMuaW5rQmFyLndpZHRoICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgd2lkdGggPSBwYXJzZUZsb2F0KHN0eWxlcy5pbmtCYXIud2lkdGgsIDEwKTtcbiAgICAgICAgaWYgKHdpZHRoKSB7XG4gICAgICAgICAgbGVmdCA9IGxlZnQgKyAodGFiTm9kZS5vZmZzZXRXaWR0aCAtIHdpZHRoKSAvIDI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIHVzZSAzZCBncHUgdG8gb3B0aW1pemUgcmVuZGVyXG4gICAgICBpZiAodHJhbnNmb3JtU3VwcG9ydGVkKSB7XG4gICAgICAgIHNldFRyYW5zZm9ybShpbmtCYXJOb2RlU3R5bGUsIGB0cmFuc2xhdGUzZCgke2xlZnR9cHgsMCwwKWApO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUud2lkdGggPSBgJHt3aWR0aH1weGA7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS5oZWlnaHQgPSAnJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS5sZWZ0ID0gYCR7bGVmdH1weGA7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS50b3AgPSAnJztcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLmJvdHRvbSA9ICcnO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUucmlnaHQgPSBgJHt3cmFwTm9kZS5vZmZzZXRXaWR0aCAtIGxlZnQgLSB3aWR0aH1weGA7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB0b3AgPSB0YWJPZmZzZXQudG9wIC0gY29udGFpbmVyT2Zmc2V0LnRvcDtcbiAgICAgIGxldCBoZWlnaHQgPSB0YWJOb2RlLm9mZnNldEhlaWdodDtcbiAgICAgIGlmIChzdHlsZXMuaW5rQmFyICYmIHN0eWxlcy5pbmtCYXIuaGVpZ2h0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaGVpZ2h0ID0gcGFyc2VGbG9hdChzdHlsZXMuaW5rQmFyLmhlaWdodCwgMTApO1xuICAgICAgICBpZiAoaGVpZ2h0KSB7XG4gICAgICAgICAgdG9wID0gdG9wICsgKHRhYk5vZGUub2Zmc2V0SGVpZ2h0IC0gaGVpZ2h0KSAvIDI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0cmFuc2Zvcm1TdXBwb3J0ZWQpIHtcbiAgICAgICAgc2V0VHJhbnNmb3JtKGlua0Jhck5vZGVTdHlsZSwgYHRyYW5zbGF0ZTNkKDAsJHt0b3B9cHgsMClgKTtcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS53aWR0aCA9ICcnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLmxlZnQgPSAnJztcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLnJpZ2h0ID0gJyc7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS50b3AgPSBgJHt0b3B9cHhgO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUuYm90dG9tID0gYCR7d3JhcE5vZGUub2Zmc2V0SGVpZ2h0IC0gdG9wIC0gaGVpZ2h0fXB4YDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaW5rQmFyTm9kZVN0eWxlLmRpc3BsYXkgPSBhY3RpdmVUYWIgPyAnYmxvY2snIDogJ25vbmUnO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGdldERlZmF1bHRQcm9wcygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaW5rQmFyQW5pbWF0ZWQ6IHRydWUsXG4gICAgfTtcbiAgfSxcblxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKHRoaXMpO1xuICB9LFxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIGlmIChpc0Rldikge1xuICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbXBvbmVudERpZFVwZGF0ZSh0aGlzLCB0cnVlKTtcbiAgICAgIH0sIDApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb21wb25lbnREaWRVcGRhdGUodGhpcywgdHJ1ZSk7XG4gICAgfVxuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpO1xuICB9LFxuXG4gIGdldElua0Jhck5vZGUoKSB7XG4gICAgY29uc3QgeyBwcmVmaXhDbHMsIHN0eWxlcywgaW5rQmFyQW5pbWF0ZWQgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gYCR7cHJlZml4Q2xzfS1pbmstYmFyYDtcbiAgICBjb25zdCBjbGFzc2VzID0gY2xhc3NuYW1lcyh7XG4gICAgICBbY2xhc3NOYW1lXTogdHJ1ZSxcbiAgICAgIFtcbiAgICAgICAgaW5rQmFyQW5pbWF0ZWQgP1xuICAgICAgICAgIGAke2NsYXNzTmFtZX0tYW5pbWF0ZWRgIDpcbiAgICAgICAgICBgJHtjbGFzc05hbWV9LW5vLWFuaW1hdGVkYFxuICAgICAgICBdOiB0cnVlLFxuICAgIH0pO1xuICAgIHJldHVybiAoXG4gICAgICA8ZGl2XG4gICAgICAgIHN0eWxlPXtzdHlsZXMuaW5rQmFyfVxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzZXN9XG4gICAgICAgIGtleT1cImlua0JhclwiXG4gICAgICAgIHJlZj17dGhpcy5zYXZlUmVmKCdpbmtCYXInKX1cbiAgICAgIC8+XG4gICAgKTtcbiAgfSxcbn07XG4iXX0=