b74df8f0a87af2ee1b0a3f3a585a1886
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var React = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _omit = _interopRequireDefault(require("lodash/omit"));

var _debounce = _interopRequireDefault(require("lodash/debounce"));

var _icon = _interopRequireDefault(require("../icon"));

var _util = require("../rc-components/tree/util");

var _treeUtil = require("../rc-components/tree/utils/treeUtil");

var _configure = require("../configure");

var _index = _interopRequireDefault(require("./index"));

var _dictUtil = require("./utils/dictUtil");

function getIcon(props) {
  var isLeaf = props.isLeaf,
      expanded = props.expanded,
      prefixCls = props.prefixCls;
  var prefixCl = (0, _configure.getPrefixCls)('tree', prefixCls);

  if (isLeaf) {
    return React.createElement(_icon["default"], {
      type: "insert_drive_file",
      className: "".concat(prefixCl, "-switcher-line-icon")
    });
  }

  return expanded ? React.createElement(_icon["default"], {
    type: "baseline-file_copy",
    className: "".concat(prefixCl, "-switcher-line-icon")
  }) : React.createElement(_icon["default"], {
    type: "library_books",
    className: "".concat(prefixCl, "-switcher-line-icon")
  });
}

function getTreeData(_ref) {
  var treeData = _ref.treeData,
      children = _ref.children;
  return treeData || (0, _treeUtil.convertTreeToData)(children);
}

var DirectoryTree =
/*#__PURE__*/
function (_React$Component) {
  (0, _inherits2["default"])(DirectoryTree, _React$Component);

  function DirectoryTree(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, DirectoryTree);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(DirectoryTree).call(this, props));

    _this.onExpand = function (expandedKeys, info) {
      var onExpand = _this.props.onExpand;

      _this.setUncontrolledState({
        expandedKeys: expandedKeys
      }); // Call origin function


      if (onExpand) {
        return onExpand(expandedKeys, info);
      }

      return undefined;
    };

    _this.onClick = function (event, node) {
      var _this$props = _this.props,
          onClick = _this$props.onClick,
          expandAction = _this$props.expandAction; // Expand the tree

      if (expandAction === 'click') {
        _this.onDebounceExpand(event, node);
      }

      if (onClick) {
        onClick(event, node);
      }
    };

    _this.onDoubleClick = function (event, node) {
      var _this$props2 = _this.props,
          onDoubleClick = _this$props2.onDoubleClick,
          expandAction = _this$props2.expandAction; // Expand the tree

      if (expandAction === 'doubleClick') {
        _this.onDebounceExpand(event, node);
      }

      if (onDoubleClick) {
        onDoubleClick(event, node);
      }
    };

    _this.onSelect = function (keys, event) {
      var _this$props3 = _this.props,
          onSelect = _this$props3.onSelect,
          multiple = _this$props3.multiple;
      var _this$state$expandedK = _this.state.expandedKeys,
          expandedKeys = _this$state$expandedK === void 0 ? [] : _this$state$expandedK;
      var node = event.node,
          nativeEvent = event.nativeEvent;
      var _node$key = node.key,
          key = _node$key === void 0 ? '' : _node$key;
      var treeData = getTreeData(_this.props);
      var newState = {}; // We need wrap this event since some value is not same

      var newEvent = (0, _objectSpread2["default"])({}, event, {
        selected: true
      }); // Windows / Mac single pick

      var ctrlPick = nativeEvent.ctrlKey || nativeEvent.metaKey;
      var shiftPick = nativeEvent.shiftKey; // Generate new selected keys

      var newSelectedKeys;

      if (multiple && ctrlPick) {
        // Control click
        newSelectedKeys = keys;
        _this.lastSelectedKey = key;
        _this.cachedSelectedKeys = newSelectedKeys;
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      } else if (multiple && shiftPick) {
        // Shift click
        newSelectedKeys = Array.from(new Set([].concat((0, _toConsumableArray2["default"])(_this.cachedSelectedKeys || []), (0, _toConsumableArray2["default"])((0, _dictUtil.calcRangeKeys)(treeData, expandedKeys, key, _this.lastSelectedKey)))));
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      } else {
        // Single click
        newSelectedKeys = [key];
        _this.lastSelectedKey = key;
        _this.cachedSelectedKeys = newSelectedKeys;
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      }

      newState.selectedKeys = newSelectedKeys;

      if (onSelect) {
        onSelect(newSelectedKeys, newEvent);
      }

      _this.setUncontrolledState(newState);
    };

    _this.setTreeRef = function (node) {
      _this.tree = node;
    };

    _this.expandFolderNode = function (event, node) {
      var isLeaf = node.isLeaf;

      if (isLeaf || event.shiftKey || event.metaKey || event.ctrlKey) {
        return;
      } // Get internal rc-tree


      var internalTree = _this.tree.tree; // Call internal rc-tree expand function
      // https://github.com/C7n-design/C7n-design/issues/12567

      internalTree.onNodeExpand(event, node);
    };

    _this.setUncontrolledState = function (state) {
      var newState = (0, _omit["default"])(state, Object.keys(_this.props));

      if (Object.keys(newState).length) {
        _this.setState(newState);
      }
    };

    _this.renderDirectoryTree = function () {
      var _this$props4 = _this.props,
          className = _this$props4.className,
          props = (0, _objectWithoutProperties2["default"])(_this$props4, ["className"]);
      var _this$state = _this.state,
          expandedKeys = _this$state.expandedKeys,
          selectedKeys = _this$state.selectedKeys;

      var prefixCls = _this.getPrefixCls();

      var connectClassName = (0, _classnames["default"])("".concat(prefixCls, "-directory"), className, (0, _defineProperty2["default"])({}, "".concat(prefixCls, "-directory-rtl"), true));
      return React.createElement(_index["default"], (0, _extends2["default"])({
        icon: getIcon,
        ref: _this.setTreeRef,
        blockNode: true
      }, props, {
        prefixCls: prefixCls,
        className: connectClassName,
        expandedKeys: expandedKeys,
        selectedKeys: selectedKeys,
        onSelect: _this.onSelect,
        onClick: _this.onClick,
        onDoubleClick: _this.onDoubleClick,
        onExpand: _this.onExpand
      }));
    };

    var defaultExpandAll = props.defaultExpandAll,
        defaultExpandParent = props.defaultExpandParent,
        expandedKeys = props.expandedKeys,
        defaultExpandedKeys = props.defaultExpandedKeys;

    var _convertDataToEntitie = (0, _treeUtil.convertDataToEntities)(getTreeData(props)),
        keyEntities = _convertDataToEntitie.keyEntities; // Selected keys


    _this.state = {
      selectedKeys: props.selectedKeys || props.defaultSelectedKeys || []
    }; // Expanded keys

    if (defaultExpandAll) {
      _this.state.expandedKeys = Object.keys(keyEntities);
    } else if (defaultExpandParent) {
      _this.state.expandedKeys = (0, _util.conductExpandParent)(expandedKeys || defaultExpandedKeys || [], keyEntities);
    } else {
      _this.state.expandedKeys = expandedKeys || defaultExpandedKeys;
    }

    _this.onDebounceExpand = (0, _debounce["default"])(_this.expandFolderNode, 200, {
      leading: true
    });
    return _this;
  }

  (0, _createClass2["default"])(DirectoryTree, [{
    key: "getPrefixCls",
    value: function getPrefixCls() {
      var prefixCls = this.props.prefixCls;
      return (0, _configure.getPrefixCls)('tree', prefixCls);
    }
  }, {
    key: "render",
    value: function render() {
      return this.renderDirectoryTree();
    }
  }], [{
    key: "getDerivedStateFromProps",
    value: function getDerivedStateFromProps(nextProps) {
      var newState = {};

      if ('expandedKeys' in nextProps) {
        newState.expandedKeys = nextProps.expandedKeys;
      }

      if ('selectedKeys' in nextProps) {
        newState.selectedKeys = nextProps.selectedKeys;
      }

      return newState;
    }
  }]);
  return DirectoryTree;
}(React.Component);

DirectoryTree.defaultProps = {
  showIcon: true,
  expandAction: 'click'
};
var _default = DirectoryTree;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyZWUvRGlyZWN0b3J5VHJlZS5qcyJdLCJuYW1lcyI6WyJpc0xlYWYiLCJleHBhbmRlZCIsInByZWZpeENscyIsInByb3BzIiwicHJlZml4Q2wiLCJJY29uIiwidHlwZSIsImNsYXNzTmFtZSIsInRyZWVEYXRhIiwiY2hpbGRyZW4iLCJEaXJlY3RvcnlUcmVlIiwiUmVhY3QiLCJDb21wb25lbnQiLCJvbkV4cGFuZCIsImV4cGFuZGVkS2V5cyIsIm9uQ2xpY2siLCJleHBhbmRBY3Rpb24iLCJvbkRvdWJsZUNsaWNrIiwib25TZWxlY3QiLCJtdWx0aXBsZSIsIm5vZGUiLCJuYXRpdmVFdmVudCIsImV2ZW50Iiwia2V5IiwiZ2V0VHJlZURhdGEiLCJuZXdTdGF0ZSIsIm5ld0V2ZW50Iiwic2VsZWN0ZWQiLCJjdHJsUGljayIsInNoaWZ0UGljayIsIm5ld1NlbGVjdGVkS2V5cyIsIkFycmF5IiwiaW50ZXJuYWxUcmVlIiwiT2JqZWN0Iiwic2VsZWN0ZWRLZXlzIiwiY29ubmVjdENsYXNzTmFtZSIsIlRyZWUiLCJpY29uIiwicmVmIiwiYmxvY2tOb2RlIiwiZGVmYXVsdEV4cGFuZEFsbCIsImRlZmF1bHRFeHBhbmRQYXJlbnQiLCJkZWZhdWx0RXhwYW5kZWRLZXlzIiwia2V5RW50aXRpZXMiLCJsZWFkaW5nIiwibmV4dFByb3BzIiwic2hvd0ljb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFBLEtBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLFdBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLEtBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxhQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLFNBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxLQUFB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QUFQO0FBQ0g7Ozs2Q0FoQitCMkMsUyxFQUFXO0FBQ3ZDLFVBQU1wQixRQUFRLEdBQWQsRUFBQTs7QUFDQSxVQUFJLGtCQUFKLFNBQUEsRUFBaUM7QUFDN0JBLFFBQUFBLFFBQVEsQ0FBUkEsWUFBQUEsR0FBd0JvQixTQUFTLENBQWpDcEIsWUFBQUE7QUFDSDs7QUFDRCxVQUFJLGtCQUFKLFNBQUEsRUFBaUM7QUFDN0JBLFFBQUFBLFFBQVEsQ0FBUkEsWUFBQUEsR0FBd0JvQixTQUFTLENBQWpDcEIsWUFBQUE7QUFDSDs7QUFDRCxhQUFBLFFBQUE7QUFDSDs7O0VBdkl1QmQsS0FBSyxDQUFDQyxTOztBQWdKbENGLGFBQWEsQ0FBYkEsWUFBQUEsR0FBNkI7QUFDekJvQyxFQUFBQSxRQUFRLEVBRGlCLElBQUE7QUFFekI5QixFQUFBQSxZQUFZLEVBQUU7QUFGVyxDQUE3Qk47ZUFJZUEsYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IG9taXQgZnJvbSAnbG9kYXNoL29taXQnO1xuaW1wb3J0IGRlYm91bmNlIGZyb20gJ2xvZGFzaC9kZWJvdW5jZSc7XG5pbXBvcnQgSWNvbiBmcm9tICcuLi9pY29uJztcbmltcG9ydCB7IGNvbmR1Y3RFeHBhbmRQYXJlbnQgfSBmcm9tICcuLi9yYy1jb21wb25lbnRzL3RyZWUvdXRpbCc7XG5pbXBvcnQgeyBjb252ZXJ0RGF0YVRvRW50aXRpZXMsIGNvbnZlcnRUcmVlVG9EYXRhIH0gZnJvbSAnLi4vcmMtY29tcG9uZW50cy90cmVlL3V0aWxzL3RyZWVVdGlsJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5pbXBvcnQgVHJlZSBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7IGNhbGNSYW5nZUtleXMsIGNvbnZlcnREaXJlY3RvcnlLZXlzVG9Ob2RlcyB9IGZyb20gJy4vdXRpbHMvZGljdFV0aWwnO1xuZnVuY3Rpb24gZ2V0SWNvbihwcm9wcykge1xuICAgIGNvbnN0IHsgaXNMZWFmLCBleHBhbmRlZCwgcHJlZml4Q2xzIH0gPSBwcm9wcztcbiAgICBjb25zdCBwcmVmaXhDbCA9IGdldFByZWZpeENscygndHJlZScsIHByZWZpeENscyk7XG4gICAgaWYgKGlzTGVhZikge1xuICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChJY29uLCB7IHR5cGU6IFwiaW5zZXJ0X2RyaXZlX2ZpbGVcIiwgY2xhc3NOYW1lOiBgJHtwcmVmaXhDbH0tc3dpdGNoZXItbGluZS1pY29uYCB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGV4cGFuZGVkID8gUmVhY3QuY3JlYXRlRWxlbWVudChJY29uLCB7IHR5cGU6IFwiYmFzZWxpbmUtZmlsZV9jb3B5XCIsIGNsYXNzTmFtZTogYCR7cHJlZml4Q2x9LXN3aXRjaGVyLWxpbmUtaWNvbmAgfSkgOiBSZWFjdC5jcmVhdGVFbGVtZW50KEljb24sIHsgdHlwZTogXCJsaWJyYXJ5X2Jvb2tzXCIsIGNsYXNzTmFtZTogYCR7cHJlZml4Q2x9LXN3aXRjaGVyLWxpbmUtaWNvbmAgfSk7XG59XG5mdW5jdGlvbiBnZXRUcmVlRGF0YSh7IHRyZWVEYXRhLCBjaGlsZHJlbiB9KSB7XG4gICAgcmV0dXJuIHRyZWVEYXRhIHx8IGNvbnZlcnRUcmVlVG9EYXRhKGNoaWxkcmVuKTtcbn1cbmNsYXNzIERpcmVjdG9yeVRyZWUgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5vbkV4cGFuZCA9IChleHBhbmRlZEtleXMsIGluZm8pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgb25FeHBhbmQgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgICAgICB0aGlzLnNldFVuY29udHJvbGxlZFN0YXRlKHsgZXhwYW5kZWRLZXlzIH0pO1xuICAgICAgICAgICAgLy8gQ2FsbCBvcmlnaW4gZnVuY3Rpb25cbiAgICAgICAgICAgIGlmIChvbkV4cGFuZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvbkV4cGFuZChleHBhbmRlZEtleXMsIGluZm8pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbkNsaWNrID0gKGV2ZW50LCBub2RlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IG9uQ2xpY2ssIGV4cGFuZEFjdGlvbiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIC8vIEV4cGFuZCB0aGUgdHJlZVxuICAgICAgICAgICAgaWYgKGV4cGFuZEFjdGlvbiA9PT0gJ2NsaWNrJykge1xuICAgICAgICAgICAgICAgIHRoaXMub25EZWJvdW5jZUV4cGFuZChldmVudCwgbm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob25DbGljaykge1xuICAgICAgICAgICAgICAgIG9uQ2xpY2soZXZlbnQsIG5vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLm9uRG91YmxlQ2xpY2sgPSAoZXZlbnQsIG5vZGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgb25Eb3VibGVDbGljaywgZXhwYW5kQWN0aW9uIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgLy8gRXhwYW5kIHRoZSB0cmVlXG4gICAgICAgICAgICBpZiAoZXhwYW5kQWN0aW9uID09PSAnZG91YmxlQ2xpY2snKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkRlYm91bmNlRXhwYW5kKGV2ZW50LCBub2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvbkRvdWJsZUNsaWNrKSB7XG4gICAgICAgICAgICAgICAgb25Eb3VibGVDbGljayhldmVudCwgbm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMub25TZWxlY3QgPSAoa2V5cywgZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgb25TZWxlY3QsIG11bHRpcGxlIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgY29uc3QgeyBleHBhbmRlZEtleXMgPSBbXSB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgICAgIGNvbnN0IHsgbm9kZSwgbmF0aXZlRXZlbnQgfSA9IGV2ZW50O1xuICAgICAgICAgICAgY29uc3QgeyBrZXkgPSAnJyB9ID0gbm9kZTtcbiAgICAgICAgICAgIGNvbnN0IHRyZWVEYXRhID0gZ2V0VHJlZURhdGEodGhpcy5wcm9wcyk7XG4gICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHt9O1xuICAgICAgICAgICAgLy8gV2UgbmVlZCB3cmFwIHRoaXMgZXZlbnQgc2luY2Ugc29tZSB2YWx1ZSBpcyBub3Qgc2FtZVxuICAgICAgICAgICAgY29uc3QgbmV3RXZlbnQgPSB7XG4gICAgICAgICAgICAgICAgLi4uZXZlbnQsXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gV2luZG93cyAvIE1hYyBzaW5nbGUgcGlja1xuICAgICAgICAgICAgY29uc3QgY3RybFBpY2sgPSBuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50Lm1ldGFLZXk7XG4gICAgICAgICAgICBjb25zdCBzaGlmdFBpY2sgPSBuYXRpdmVFdmVudC5zaGlmdEtleTtcbiAgICAgICAgICAgIC8vIEdlbmVyYXRlIG5ldyBzZWxlY3RlZCBrZXlzXG4gICAgICAgICAgICBsZXQgbmV3U2VsZWN0ZWRLZXlzO1xuICAgICAgICAgICAgaWYgKG11bHRpcGxlICYmIGN0cmxQaWNrKSB7XG4gICAgICAgICAgICAgICAgLy8gQ29udHJvbCBjbGlja1xuICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkS2V5cyA9IGtleXM7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0U2VsZWN0ZWRLZXkgPSBrZXk7XG4gICAgICAgICAgICAgICAgdGhpcy5jYWNoZWRTZWxlY3RlZEtleXMgPSBuZXdTZWxlY3RlZEtleXM7XG4gICAgICAgICAgICAgICAgbmV3RXZlbnQuc2VsZWN0ZWROb2RlcyA9IGNvbnZlcnREaXJlY3RvcnlLZXlzVG9Ob2Rlcyh0cmVlRGF0YSwgbmV3U2VsZWN0ZWRLZXlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKG11bHRpcGxlICYmIHNoaWZ0UGljaykge1xuICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGNsaWNrXG4gICAgICAgICAgICAgICAgbmV3U2VsZWN0ZWRLZXlzID0gQXJyYXkuZnJvbShuZXcgU2V0KFtcbiAgICAgICAgICAgICAgICAgICAgLi4uKHRoaXMuY2FjaGVkU2VsZWN0ZWRLZXlzIHx8IFtdKSxcbiAgICAgICAgICAgICAgICAgICAgLi4uY2FsY1JhbmdlS2V5cyh0cmVlRGF0YSwgZXhwYW5kZWRLZXlzLCBrZXksIHRoaXMubGFzdFNlbGVjdGVkS2V5KSxcbiAgICAgICAgICAgICAgICBdKSk7XG4gICAgICAgICAgICAgICAgbmV3RXZlbnQuc2VsZWN0ZWROb2RlcyA9IGNvbnZlcnREaXJlY3RvcnlLZXlzVG9Ob2Rlcyh0cmVlRGF0YSwgbmV3U2VsZWN0ZWRLZXlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFNpbmdsZSBjbGlja1xuICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkS2V5cyA9IFtrZXldO1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNlbGVjdGVkS2V5ID0ga2V5O1xuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVkU2VsZWN0ZWRLZXlzID0gbmV3U2VsZWN0ZWRLZXlzO1xuICAgICAgICAgICAgICAgIG5ld0V2ZW50LnNlbGVjdGVkTm9kZXMgPSBjb252ZXJ0RGlyZWN0b3J5S2V5c1RvTm9kZXModHJlZURhdGEsIG5ld1NlbGVjdGVkS2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXdTdGF0ZS5zZWxlY3RlZEtleXMgPSBuZXdTZWxlY3RlZEtleXM7XG4gICAgICAgICAgICBpZiAob25TZWxlY3QpIHtcbiAgICAgICAgICAgICAgICBvblNlbGVjdChuZXdTZWxlY3RlZEtleXMsIG5ld0V2ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0VW5jb250cm9sbGVkU3RhdGUobmV3U3RhdGUpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldFRyZWVSZWYgPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy50cmVlID0gbm9kZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5leHBhbmRGb2xkZXJOb2RlID0gKGV2ZW50LCBub2RlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGlzTGVhZiB9ID0gbm9kZTtcbiAgICAgICAgICAgIGlmIChpc0xlYWYgfHwgZXZlbnQuc2hpZnRLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC5jdHJsS2V5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gR2V0IGludGVybmFsIHJjLXRyZWVcbiAgICAgICAgICAgIGNvbnN0IGludGVybmFsVHJlZSA9IHRoaXMudHJlZS50cmVlO1xuICAgICAgICAgICAgLy8gQ2FsbCBpbnRlcm5hbCByYy10cmVlIGV4cGFuZCBmdW5jdGlvblxuICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL0M3bi1kZXNpZ24vQzduLWRlc2lnbi9pc3N1ZXMvMTI1NjdcbiAgICAgICAgICAgIGludGVybmFsVHJlZS5vbk5vZGVFeHBhbmQoZXZlbnQsIG5vZGUpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldFVuY29udHJvbGxlZFN0YXRlID0gKHN0YXRlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IG9taXQoc3RhdGUsIE9iamVjdC5rZXlzKHRoaXMucHJvcHMpKTtcbiAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhuZXdTdGF0ZSkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmVuZGVyRGlyZWN0b3J5VHJlZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgY2xhc3NOYW1lLCAuLi5wcm9wcyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGNvbnN0IHsgZXhwYW5kZWRLZXlzLCBzZWxlY3RlZEtleXMgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICBjb25zdCBwcmVmaXhDbHMgPSB0aGlzLmdldFByZWZpeENscygpO1xuICAgICAgICAgICAgY29uc3QgY29ubmVjdENsYXNzTmFtZSA9IGNsYXNzTmFtZXMoYCR7cHJlZml4Q2xzfS1kaXJlY3RvcnlgLCBjbGFzc05hbWUsIHtcbiAgICAgICAgICAgICAgICBbYCR7cHJlZml4Q2xzfS1kaXJlY3RvcnktcnRsYF06IHRydWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiAoUmVhY3QuY3JlYXRlRWxlbWVudChUcmVlLCBPYmplY3QuYXNzaWduKHsgaWNvbjogZ2V0SWNvbiwgcmVmOiB0aGlzLnNldFRyZWVSZWYsIGJsb2NrTm9kZTogdHJ1ZSB9LCBwcm9wcywgeyBwcmVmaXhDbHM6IHByZWZpeENscywgY2xhc3NOYW1lOiBjb25uZWN0Q2xhc3NOYW1lLCBleHBhbmRlZEtleXM6IGV4cGFuZGVkS2V5cywgc2VsZWN0ZWRLZXlzOiBzZWxlY3RlZEtleXMsIG9uU2VsZWN0OiB0aGlzLm9uU2VsZWN0LCBvbkNsaWNrOiB0aGlzLm9uQ2xpY2ssIG9uRG91YmxlQ2xpY2s6IHRoaXMub25Eb3VibGVDbGljaywgb25FeHBhbmQ6IHRoaXMub25FeHBhbmQgfSkpKTtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgeyBkZWZhdWx0RXhwYW5kQWxsLCBkZWZhdWx0RXhwYW5kUGFyZW50LCBleHBhbmRlZEtleXMsIGRlZmF1bHRFeHBhbmRlZEtleXMgfSA9IHByb3BzO1xuICAgICAgICBjb25zdCB7IGtleUVudGl0aWVzIH0gPSBjb252ZXJ0RGF0YVRvRW50aXRpZXMoZ2V0VHJlZURhdGEocHJvcHMpKTtcbiAgICAgICAgLy8gU2VsZWN0ZWQga2V5c1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWRLZXlzOiBwcm9wcy5zZWxlY3RlZEtleXMgfHwgcHJvcHMuZGVmYXVsdFNlbGVjdGVkS2V5cyB8fCBbXSxcbiAgICAgICAgfTtcbiAgICAgICAgLy8gRXhwYW5kZWQga2V5c1xuICAgICAgICBpZiAoZGVmYXVsdEV4cGFuZEFsbCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5leHBhbmRlZEtleXMgPSBPYmplY3Qua2V5cyhrZXlFbnRpdGllcyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoZGVmYXVsdEV4cGFuZFBhcmVudCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5leHBhbmRlZEtleXMgPSBjb25kdWN0RXhwYW5kUGFyZW50KGV4cGFuZGVkS2V5cyB8fCBkZWZhdWx0RXhwYW5kZWRLZXlzIHx8IFtdLCBrZXlFbnRpdGllcyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmV4cGFuZGVkS2V5cyA9IGV4cGFuZGVkS2V5cyB8fCBkZWZhdWx0RXhwYW5kZWRLZXlzO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub25EZWJvdW5jZUV4cGFuZCA9IGRlYm91bmNlKHRoaXMuZXhwYW5kRm9sZGVyTm9kZSwgMjAwLCB7XG4gICAgICAgICAgICBsZWFkaW5nOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMpIHtcbiAgICAgICAgY29uc3QgbmV3U3RhdGUgPSB7fTtcbiAgICAgICAgaWYgKCdleHBhbmRlZEtleXMnIGluIG5leHRQcm9wcykge1xuICAgICAgICAgICAgbmV3U3RhdGUuZXhwYW5kZWRLZXlzID0gbmV4dFByb3BzLmV4cGFuZGVkS2V5cztcbiAgICAgICAgfVxuICAgICAgICBpZiAoJ3NlbGVjdGVkS2V5cycgaW4gbmV4dFByb3BzKSB7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zZWxlY3RlZEtleXMgPSBuZXh0UHJvcHMuc2VsZWN0ZWRLZXlzO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXdTdGF0ZTtcbiAgICB9XG4gICAgZ2V0UHJlZml4Q2xzKCkge1xuICAgICAgICBjb25zdCB7IHByZWZpeENscyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuIGdldFByZWZpeENscygndHJlZScsIHByZWZpeENscyk7XG4gICAgfVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyRGlyZWN0b3J5VHJlZSgpO1xuICAgIH1cbn1cbkRpcmVjdG9yeVRyZWUuZGVmYXVsdFByb3BzID0ge1xuICAgIHNob3dJY29uOiB0cnVlLFxuICAgIGV4cGFuZEFjdGlvbjogJ2NsaWNrJyxcbn07XG5leHBvcnQgZGVmYXVsdCBEaXJlY3RvcnlUcmVlO1xuIl19