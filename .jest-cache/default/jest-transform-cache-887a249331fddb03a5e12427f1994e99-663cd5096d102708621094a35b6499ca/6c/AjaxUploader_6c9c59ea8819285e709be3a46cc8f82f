940c8bbb8eb70f4dbf57731547b8d086
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _classnames = _interopRequireDefault(require("classnames"));

var _request = _interopRequireDefault(require("./request"));

var _uid = _interopRequireDefault(require("./uid"));

var _attrAccept = _interopRequireDefault(require("./attr-accept"));

function _createSuper(Derived) {
  function isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  return function () {
    var Super = (0, _getPrototypeOf2["default"])(Derived),
        result;

    if (isNativeReflectConstruct()) {
      var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor;
      result = Reflect.construct(Super, arguments, NewTarget);
    } else {
      result = Super.apply(this, arguments);
    }

    return (0, _possibleConstructorReturn2["default"])(this, result);
  };
}

var AjaxUploader =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(AjaxUploader, _Component);

  var _super = _createSuper(AjaxUploader);

  function AjaxUploader() {
    var _this;

    (0, _classCallCheck2["default"])(this, AjaxUploader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      uid: (0, _uid["default"])()
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "reqs", {});
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onChange", function (e) {
      var files = e.target.files;

      _this.uploadFiles(files);

      _this.reset();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onClick", function () {
      var el = _this.fileInput;

      if (!el) {
        return;
      }

      el.click();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onKeyDown", function (e) {
      if (e.key === 'Enter') {
        _this.onClick();
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onFileDrop", function (e) {
      if (e.type === 'dragover') {
        e.preventDefault();
        return;
      }

      var files = Array.prototype.slice.call(e.dataTransfer.files).filter(function (file) {
        return (0, _attrAccept["default"])(file, _this.props.accept);
      });

      _this.uploadFiles(files);

      e.preventDefault();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "saveFileInput", function (node) {
      _this.fileInput = node;
    });
    return _this;
  }

  (0, _createClass2["default"])(AjaxUploader, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this._isMounted = true;
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this._isMounted = false;
      this.abort();
    }
  }, {
    key: "uploadFiles",
    value: function uploadFiles(files) {
      var _this2 = this;

      var postFiles = Array.prototype.slice.call(files);
      postFiles.forEach(function (file) {
        file.uid = (0, _uid["default"])();

        _this2.upload(file, postFiles);
      });
    }
  }, {
    key: "upload",
    value: function upload(file, fileList) {
      var _this3 = this;

      var props = this.props;

      if (!props.beforeUpload) {
        // always async in case use react state to keep fileList
        return setTimeout(function () {
          return _this3.post(file);
        }, 0);
      }

      var before = props.beforeUpload(file, fileList);

      if (before && before.then) {
        before.then(function (processedFile) {
          var processedFileType = Object.prototype.toString.call(processedFile);

          if (processedFileType === '[object File]' || processedFileType === '[object Blob]') {
            _this3.post(processedFile);
          } else {
            _this3.post(file);
          }
        })["catch"](function (e) {
          console && console.log(e); // eslint-disable-line
        });
      } else if (before !== false) {
        setTimeout(function () {
          return _this3.post(file);
        }, 0);
      }
    }
  }, {
    key: "post",
    value: function post(file) {
      var _this4 = this;

      if (!this._isMounted) {
        return;
      }

      var props = this.props;
      var data = props.data;
      var onStart = props.onStart,
          onProgress = props.onProgress;

      if (typeof data === 'function') {
        data = data(file);
      }

      var uid = file.uid;
      var request = props.customRequest || _request["default"];
      this.reqs[uid] = request({
        action: props.action,
        filename: props.name,
        file: file,
        data: data,
        headers: props.headers,
        withCredentials: props.withCredentials,
        onProgress: onProgress ? function (e) {
          onProgress(e, file);
        } : null,
        onSuccess: function onSuccess(ret, xhr) {
          delete _this4.reqs[uid];
          props.onSuccess(ret, file, xhr);
        },
        onError: function onError(err, ret) {
          delete _this4.reqs[uid];
          props.onError(err, ret, file);
        }
      });
      onStart(file);
    }
  }, {
    key: "reset",
    value: function reset() {
      this.setState({
        uid: (0, _uid["default"])()
      });
    }
  }, {
    key: "abort",
    value: function abort(file) {
      var reqs = this.reqs;

      if (file) {
        var uid = file;

        if (file && file.uid) {
          uid = file.uid;
        }

        if (reqs[uid]) {
          reqs[uid].abort();
          delete reqs[uid];
        }
      } else {
        Object.keys(reqs).forEach(function (uid) {
          if (reqs[uid]) {
            reqs[uid].abort();
          }

          delete reqs[uid];
        });
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _classNames;

      var _this$props = this.props,
          Tag = _this$props.component,
          prefixCls = _this$props.prefixCls,
          className = _this$props.className,
          disabled = _this$props.disabled,
          style = _this$props.style,
          multiple = _this$props.multiple,
          accept = _this$props.accept,
          children = _this$props.children;
      var cls = (0, _classnames["default"])((_classNames = {}, (0, _defineProperty2["default"])(_classNames, prefixCls, true), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-disabled"), disabled), (0, _defineProperty2["default"])(_classNames, className, className), _classNames));
      var events = disabled ? {} : {
        onClick: this.onClick,
        onKeyDown: this.onKeyDown,
        onDrop: this.onFileDrop,
        onDragOver: this.onFileDrop,
        tabIndex: '0'
      };
      return _react["default"].createElement(Tag, (0, _extends2["default"])({}, events, {
        className: cls,
        role: "button",
        style: style
      }), _react["default"].createElement("input", {
        type: "file",
        ref: this.saveFileInput,
        key: this.state.uid,
        style: {
          display: 'none'
        },
        accept: accept,
        multiple: multiple,
        onChange: this.onChange
      }), children);
    }
  }]);
  return AjaxUploader;
}(_react.Component);

(0, _defineProperty2["default"])(AjaxUploader, "propTypes", {
  component: _propTypes["default"].string,
  style: _propTypes["default"].object,
  prefixCls: _propTypes["default"].string,
  className: _propTypes["default"].string,
  multiple: _propTypes["default"].bool,
  disabled: _propTypes["default"].bool,
  accept: _propTypes["default"].string,
  children: _propTypes["default"].any,
  onStart: _propTypes["default"].func,
  data: _propTypes["default"].oneOfType([_propTypes["default"].object, _propTypes["default"].func]),
  headers: _propTypes["default"].object,
  beforeUpload: _propTypes["default"].func,
  customRequest: _propTypes["default"].func,
  onProgress: _propTypes["default"].func,
  withCredentials: _propTypes["default"].bool
});
var _default = AjaxUploader;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFqYXhVcGxvYWRlci5qc3giXSwibmFtZXMiOlsiQWpheFVwbG9hZGVyIiwidWlkIiwiZSIsImZpbGVzIiwidGFyZ2V0IiwidXBsb2FkRmlsZXMiLCJyZXNldCIsImVsIiwiZmlsZUlucHV0IiwiY2xpY2siLCJrZXkiLCJvbkNsaWNrIiwidHlwZSIsInByZXZlbnREZWZhdWx0IiwiQXJyYXkiLCJwcm90b3R5cGUiLCJzbGljZSIsImNhbGwiLCJkYXRhVHJhbnNmZXIiLCJmaWx0ZXIiLCJmaWxlIiwicHJvcHMiLCJhY2NlcHQiLCJub2RlIiwiX2lzTW91bnRlZCIsImFib3J0IiwicG9zdEZpbGVzIiwiZm9yRWFjaCIsInVwbG9hZCIsImZpbGVMaXN0IiwiYmVmb3JlVXBsb2FkIiwic2V0VGltZW91dCIsInBvc3QiLCJiZWZvcmUiLCJ0aGVuIiwicHJvY2Vzc2VkRmlsZSIsInByb2Nlc3NlZEZpbGVUeXBlIiwiT2JqZWN0IiwidG9TdHJpbmciLCJjb25zb2xlIiwibG9nIiwiZGF0YSIsIm9uU3RhcnQiLCJvblByb2dyZXNzIiwicmVxdWVzdCIsImN1c3RvbVJlcXVlc3QiLCJkZWZhdWx0UmVxdWVzdCIsInJlcXMiLCJhY3Rpb24iLCJmaWxlbmFtZSIsIm5hbWUiLCJoZWFkZXJzIiwid2l0aENyZWRlbnRpYWxzIiwib25TdWNjZXNzIiwicmV0IiwieGhyIiwib25FcnJvciIsImVyciIsInNldFN0YXRlIiwia2V5cyIsIlRhZyIsImNvbXBvbmVudCIsInByZWZpeENscyIsImNsYXNzTmFtZSIsImRpc2FibGVkIiwic3R5bGUiLCJtdWx0aXBsZSIsImNoaWxkcmVuIiwiY2xzIiwiZXZlbnRzIiwib25LZXlEb3duIiwib25Ecm9wIiwib25GaWxlRHJvcCIsIm9uRHJhZ092ZXIiLCJ0YWJJbmRleCIsInNhdmVGaWxlSW5wdXQiLCJzdGF0ZSIsImRpc3BsYXkiLCJvbkNoYW5nZSIsIkNvbXBvbmVudCIsIlByb3BUeXBlcyIsInN0cmluZyIsIm9iamVjdCIsImJvb2wi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QUFVSyxJQVRGO0FBVWpCNUMsRUFBQUEsSUFBSSxFQUFFdUMsc0JBQVVNLFNBQVYsQ0FBb0IsQ0FDeEJOLHNCQUFVRSxNQURjLEVBRXhCRixzQkFBVUssSUFGYyxDQUFwQixDQVZXO0FBY2pCbEMsRUFBQUEsT0FBTyxFQUFFNkIsc0JBQVVFLE1BZEY7QUFlakJwRCxFQUFBQSxZQUFZLEVBQUVrRCxzQkFBVUssSUFmUDtBQWdCakJ4QyxFQUFBQSxhQUFhLEVBQUVtQyxzQkFBVUssSUFoQlI7QUFpQmpCMUMsRUFBQUEsVUFBVSxFQUFFcUMsc0JBQVVLLElBakJMO0FBa0JqQmpDLEVBQUFBLGVBQWUsRUFBRTRCLHNCQUFVRztBQWxCVixDO2VBNE1ObkYsWSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCByZWFjdC9uby1pcy1tb3VudGVkOjAgcmVhY3Qvc29ydC1jb21wOjAgKi9cblxuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBkZWZhdWx0UmVxdWVzdCBmcm9tICcuL3JlcXVlc3QnO1xuaW1wb3J0IGdldFVpZCBmcm9tICcuL3VpZCc7XG5pbXBvcnQgYXR0ckFjY2VwdCBmcm9tICcuL2F0dHItYWNjZXB0JztcblxuY2xhc3MgQWpheFVwbG9hZGVyIGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBjb21wb25lbnQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgc3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgcHJlZml4Q2xzOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBtdWx0aXBsZTogUHJvcFR5cGVzLmJvb2wsXG4gICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuICAgIGFjY2VwdDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjaGlsZHJlbjogUHJvcFR5cGVzLmFueSxcbiAgICBvblN0YXJ0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBkYXRhOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICAgIFByb3BUeXBlcy5vYmplY3QsXG4gICAgICBQcm9wVHlwZXMuZnVuYyxcbiAgICBdKSxcbiAgICBoZWFkZXJzOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIGJlZm9yZVVwbG9hZDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgY3VzdG9tUmVxdWVzdDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25Qcm9ncmVzczogUHJvcFR5cGVzLmZ1bmMsXG4gICAgd2l0aENyZWRlbnRpYWxzOiBQcm9wVHlwZXMuYm9vbCxcbiAgfVxuXG4gIHN0YXRlID0geyB1aWQ6IGdldFVpZCgpIH1cblxuICByZXFzID0ge31cblxuICBvbkNoYW5nZSA9IGUgPT4ge1xuICAgIGNvbnN0IGZpbGVzID0gZS50YXJnZXQuZmlsZXM7XG4gICAgdGhpcy51cGxvYWRGaWxlcyhmaWxlcyk7XG4gICAgdGhpcy5yZXNldCgpO1xuICB9XG5cbiAgb25DbGljayA9ICgpID0+IHtcbiAgICBjb25zdCBlbCA9IHRoaXMuZmlsZUlucHV0O1xuICAgIGlmICghZWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZWwuY2xpY2soKTtcbiAgfVxuXG4gIG9uS2V5RG93biA9IGUgPT4ge1xuICAgIGlmIChlLmtleSA9PT0gJ0VudGVyJykge1xuICAgICAgdGhpcy5vbkNsaWNrKCk7XG4gICAgfVxuICB9XG5cbiAgb25GaWxlRHJvcCA9IGUgPT4ge1xuICAgIGlmIChlLnR5cGUgPT09ICdkcmFnb3ZlcicpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZmlsZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlLmRhdGFUcmFuc2Zlci5maWxlcykuZmlsdGVyKFxuICAgICAgZmlsZSA9PiBhdHRyQWNjZXB0KGZpbGUsIHRoaXMucHJvcHMuYWNjZXB0KVxuICAgICk7XG4gICAgdGhpcy51cGxvYWRGaWxlcyhmaWxlcyk7XG5cbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLl9pc01vdW50ZWQgPSB0cnVlO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5faXNNb3VudGVkID0gZmFsc2U7XG4gICAgdGhpcy5hYm9ydCgpO1xuICB9XG5cbiAgdXBsb2FkRmlsZXMoZmlsZXMpIHtcbiAgICBjb25zdCBwb3N0RmlsZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChmaWxlcyk7XG4gICAgcG9zdEZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgIGZpbGUudWlkID0gZ2V0VWlkKCk7XG4gICAgICB0aGlzLnVwbG9hZChmaWxlLCBwb3N0RmlsZXMpO1xuICAgIH0pO1xuICB9XG5cbiAgdXBsb2FkKGZpbGUsIGZpbGVMaXN0KSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBpZiAoIXByb3BzLmJlZm9yZVVwbG9hZCkge1xuICAgICAgLy8gYWx3YXlzIGFzeW5jIGluIGNhc2UgdXNlIHJlYWN0IHN0YXRlIHRvIGtlZXAgZmlsZUxpc3RcbiAgICAgIHJldHVybiBzZXRUaW1lb3V0KCgpID0+IHRoaXMucG9zdChmaWxlKSwgMCk7XG4gICAgfVxuXG4gICAgY29uc3QgYmVmb3JlID0gcHJvcHMuYmVmb3JlVXBsb2FkKGZpbGUsIGZpbGVMaXN0KTtcbiAgICBpZiAoYmVmb3JlICYmIGJlZm9yZS50aGVuKSB7XG4gICAgICBiZWZvcmUudGhlbigocHJvY2Vzc2VkRmlsZSkgPT4ge1xuICAgICAgICBjb25zdCBwcm9jZXNzZWRGaWxlVHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChwcm9jZXNzZWRGaWxlKTtcbiAgICAgICAgaWYgKHByb2Nlc3NlZEZpbGVUeXBlID09PSAnW29iamVjdCBGaWxlXScgfHwgcHJvY2Vzc2VkRmlsZVR5cGUgPT09ICdbb2JqZWN0IEJsb2JdJykge1xuICAgICAgICAgIHRoaXMucG9zdChwcm9jZXNzZWRGaWxlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnBvc3QoZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgICBjb25zb2xlICYmIGNvbnNvbGUubG9nKGUpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGJlZm9yZSAhPT0gZmFsc2UpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5wb3N0KGZpbGUpLCAwKTtcbiAgICB9XG4gIH1cblxuICBwb3N0KGZpbGUpIHtcbiAgICBpZiAoIXRoaXMuX2lzTW91bnRlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGxldCB7IGRhdGEgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgb25TdGFydCwgb25Qcm9ncmVzcyB9ID0gcHJvcHM7XG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBkYXRhID0gZGF0YShmaWxlKTtcbiAgICB9XG4gICAgY29uc3QgeyB1aWQgfSA9IGZpbGU7XG4gICAgY29uc3QgcmVxdWVzdCA9IHByb3BzLmN1c3RvbVJlcXVlc3QgfHwgZGVmYXVsdFJlcXVlc3Q7XG4gICAgdGhpcy5yZXFzW3VpZF0gPSByZXF1ZXN0KHtcbiAgICAgIGFjdGlvbjogcHJvcHMuYWN0aW9uLFxuICAgICAgZmlsZW5hbWU6IHByb3BzLm5hbWUsXG4gICAgICBmaWxlLFxuICAgICAgZGF0YSxcbiAgICAgIGhlYWRlcnM6IHByb3BzLmhlYWRlcnMsXG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHByb3BzLndpdGhDcmVkZW50aWFscyxcbiAgICAgIG9uUHJvZ3Jlc3M6IG9uUHJvZ3Jlc3MgPyBlID0+IHtcbiAgICAgICAgb25Qcm9ncmVzcyhlLCBmaWxlKTtcbiAgICAgIH0gOiBudWxsLFxuICAgICAgb25TdWNjZXNzOiAocmV0LCB4aHIpID0+IHtcbiAgICAgICAgZGVsZXRlIHRoaXMucmVxc1t1aWRdO1xuICAgICAgICBwcm9wcy5vblN1Y2Nlc3MocmV0LCBmaWxlLCB4aHIpO1xuICAgICAgfSxcbiAgICAgIG9uRXJyb3I6IChlcnIsIHJldCkgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy5yZXFzW3VpZF07XG4gICAgICAgIHByb3BzLm9uRXJyb3IoZXJyLCByZXQsIGZpbGUpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICBvblN0YXJ0KGZpbGUpO1xuICB9XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICB1aWQ6IGdldFVpZCgpLFxuICAgIH0pO1xuICB9XG5cbiAgYWJvcnQoZmlsZSkge1xuICAgIGNvbnN0IHsgcmVxcyB9ID0gdGhpcztcbiAgICBpZiAoZmlsZSkge1xuICAgICAgbGV0IHVpZCA9IGZpbGU7XG4gICAgICBpZiAoZmlsZSAmJiBmaWxlLnVpZCkge1xuICAgICAgICB1aWQgPSBmaWxlLnVpZDtcbiAgICAgIH1cbiAgICAgIGlmIChyZXFzW3VpZF0pIHtcbiAgICAgICAgcmVxc1t1aWRdLmFib3J0KCk7XG4gICAgICAgIGRlbGV0ZSByZXFzW3VpZF07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIE9iamVjdC5rZXlzKHJlcXMpLmZvckVhY2goKHVpZCkgPT4ge1xuICAgICAgICBpZiAocmVxc1t1aWRdKSB7XG4gICAgICAgICAgcmVxc1t1aWRdLmFib3J0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgcmVxc1t1aWRdO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc2F2ZUZpbGVJbnB1dCA9IChub2RlKSA9PiB7XG4gICAgdGhpcy5maWxlSW5wdXQgPSBub2RlO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIGNvbXBvbmVudDogVGFnLCBwcmVmaXhDbHMsIGNsYXNzTmFtZSwgZGlzYWJsZWQsXG4gICAgICBzdHlsZSwgbXVsdGlwbGUsIGFjY2VwdCwgY2hpbGRyZW4sXG4gICAgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY2xzID0gY2xhc3NOYW1lcyh7XG4gICAgICBbcHJlZml4Q2xzXTogdHJ1ZSxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWRpc2FibGVkYF06IGRpc2FibGVkLFxuICAgICAgW2NsYXNzTmFtZV06IGNsYXNzTmFtZSxcbiAgICB9KTtcbiAgICBjb25zdCBldmVudHMgPSBkaXNhYmxlZCA/IHt9IDoge1xuICAgICAgb25DbGljazogdGhpcy5vbkNsaWNrLFxuICAgICAgb25LZXlEb3duOiB0aGlzLm9uS2V5RG93bixcbiAgICAgIG9uRHJvcDogdGhpcy5vbkZpbGVEcm9wLFxuICAgICAgb25EcmFnT3ZlcjogdGhpcy5vbkZpbGVEcm9wLFxuICAgICAgdGFiSW5kZXg6ICcwJyxcbiAgICB9O1xuICAgIHJldHVybiAoXG4gICAgICA8VGFnXG4gICAgICAgIHsuLi5ldmVudHN9XG4gICAgICAgIGNsYXNzTmFtZT17Y2xzfVxuICAgICAgICByb2xlPVwiYnV0dG9uXCJcbiAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgPlxuICAgICAgICA8aW5wdXRcbiAgICAgICAgICB0eXBlPVwiZmlsZVwiXG4gICAgICAgICAgcmVmPXt0aGlzLnNhdmVGaWxlSW5wdXR9XG4gICAgICAgICAga2V5PXt0aGlzLnN0YXRlLnVpZH1cbiAgICAgICAgICBzdHlsZT17eyBkaXNwbGF5OiAnbm9uZScgfX1cbiAgICAgICAgICBhY2NlcHQ9e2FjY2VwdH1cbiAgICAgICAgICBtdWx0aXBsZT17bXVsdGlwbGV9XG4gICAgICAgICAgb25DaGFuZ2U9e3RoaXMub25DaGFuZ2V9XG4gICAgICAgIC8+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvVGFnPlxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQWpheFVwbG9hZGVyO1xuIl19