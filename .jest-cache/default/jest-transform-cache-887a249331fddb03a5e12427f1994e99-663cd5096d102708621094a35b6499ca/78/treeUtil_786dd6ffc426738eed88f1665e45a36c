55ab47521d8242555c1706fec1afbdc2
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getKey = getKey;
exports.warningWithoutKey = warningWithoutKey;
exports.convertTreeToData = convertTreeToData;
exports.flattenTreeData = flattenTreeData;
exports.traverseDataNodes = traverseDataNodes;
exports.convertDataToEntities = convertDataToEntities;
exports.getTreeNodeProps = getTreeNodeProps;
exports.convertNodePropsToEventData = convertNodePropsToEventData;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toArray = _interopRequireDefault(require("rc-util/lib/Children/toArray"));

var _warning = _interopRequireDefault(require("rc-util/lib/warning"));

var _util = require("../util"); // @ts-ignore


function getKey(key, pos) {
  if (key !== null && key !== undefined) {
    return key;
  }

  return pos;
}
/**
 * Warning if TreeNode do not provides key
 */


function warningWithoutKey() {
  var treeData = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var keys = new Map();

  function dig(list) {
    var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
    (list || []).forEach(function (treeNode) {
      var key = treeNode.key,
          children = treeNode.children;
      (0, _warning["default"])(key !== null && key !== undefined, "Tree node must have a certain key: [".concat(path).concat(key, "]"));
      var recordKey = String(key);
      (0, _warning["default"])(!keys.has(recordKey) || key === null || key === undefined, "Same 'key' exist in the Tree: ".concat(recordKey));
      keys.set(recordKey, true);
      dig(children, "".concat(path).concat(recordKey, " > "));
    });
  }

  dig(treeData);
}
/**
 * Convert `children` of Tree into `treeData` structure.
 */


function convertTreeToData(rootNodes) {
  function dig(node) {
    var treeNodes = (0, _toArray["default"])(node);
    return treeNodes.map(function (treeNode) {
      // Filter invalidate node
      if (!(0, _util.isTreeNode)(treeNode)) {
        (0, _warning["default"])(!treeNode, 'Tree/TreeNode can only accept TreeNode as children.');
        return null;
      }

      var key = treeNode.key;
      var _treeNode$props = treeNode.props,
          children = _treeNode$props.children,
          rest = (0, _objectWithoutProperties2["default"])(_treeNode$props, ["children"]);
      var dataNode = (0, _objectSpread2["default"])({
        key: key
      }, rest);
      var parsedChildren = dig(children);

      if (parsedChildren.length) {
        dataNode.children = parsedChildren;
      }

      return dataNode;
    }).filter(function (dataNode) {
      return dataNode;
    });
  }

  return dig(rootNodes);
}
/**
 * Flat nest tree data into flatten list. This is used for virtual list render.
 * @param treeNodeList Origin data node list
 * @param expandedKeys
 * need expanded keys, provides `true` means all expanded (used in `rc-tree-select`).
 */


function flattenTreeData() {
  var treeNodeList = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var expandedKeys = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var expandedKeySet = new Set(expandedKeys === true ? [] : expandedKeys);
  var flattenList = [];

  function dig(list) {
    var parent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;
    return list.map(function (treeNode, index) {
      var pos = (0, _util.getPosition)(parent ? parent.pos : '0', index);
      var mergedKey = getKey(treeNode.key, pos); // Add FlattenDataNode into list

      var flattenNode = (0, _objectSpread2["default"])({}, treeNode, {
        parent: parent,
        pos: pos,
        children: null,
        data: treeNode,
        isStart: [].concat((0, _toConsumableArray2["default"])(parent ? parent.isStart : []), [index === 0]),
        isEnd: [].concat((0, _toConsumableArray2["default"])(parent ? parent.isEnd : []), [index === list.length - 1])
      });
      flattenList.push(flattenNode); // Loop treeNode children

      if (expandedKeys === true || expandedKeySet.has(mergedKey)) {
        flattenNode.children = dig(treeNode.children || [], flattenNode);
      } else {
        flattenNode.children = [];
      }

      return flattenNode;
    });
  }

  dig(treeNodeList);
  return flattenList;
}
/**
 * Traverse all the data by `treeData`.
 * Please not use it out of the `rc-tree` since we may refactor this code.
 */


function traverseDataNodes(dataNodes, callback) {
  function processNode(node, index, parent) {
    var children = node ? node.children : dataNodes;
    var pos = node ? (0, _util.getPosition)(parent.pos, index) : '0'; // Process node if is not root

    if (node) {
      var data = {
        node: node,
        index: index,
        pos: pos,
        key: node.key !== null ? node.key : pos,
        parentPos: parent.node ? parent.pos : null,
        level: parent.level + 1
      };
      callback(data);
    } // Process children node


    if (children) {
      children.forEach(function (subNode, subIndex) {
        processNode(subNode, subIndex, {
          node: node,
          pos: pos,
          level: parent ? parent.level + 1 : -1
        });
      });
    }
  }

  processNode(null);
}
/**
 * Convert `treeData` into entity records.
 */


function convertDataToEntities(dataNodes) {
  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
      initWrapper = _ref.initWrapper,
      processEntity = _ref.processEntity,
      onProcessFinished = _ref.onProcessFinished;

  var posEntities = {};
  var keyEntities = {};
  var wrapper = {
    posEntities: posEntities,
    keyEntities: keyEntities
  };

  if (initWrapper) {
    wrapper = initWrapper(wrapper) || wrapper;
  }

  traverseDataNodes(dataNodes, function (item) {
    var node = item.node,
        index = item.index,
        pos = item.pos,
        key = item.key,
        parentPos = item.parentPos,
        level = item.level;
    var entity = {
      node: node,
      index: index,
      key: key,
      pos: pos,
      level: level
    };
    var mergedKey = getKey(key, pos);
    posEntities[pos] = entity;
    keyEntities[mergedKey] = entity; // Fill children

    entity.parent = posEntities[parentPos];

    if (entity.parent) {
      entity.parent.children = entity.parent.children || [];
      entity.parent.children.push(entity);
    }

    if (processEntity) {
      processEntity(entity, wrapper);
    }
  });

  if (onProcessFinished) {
    onProcessFinished(wrapper);
  }

  return wrapper;
}
/**
 * Get TreeNode props with Tree props.
 */


function getTreeNodeProps(key, _ref2) {
  var expandedKeys = _ref2.expandedKeys,
      selectedKeys = _ref2.selectedKeys,
      loadedKeys = _ref2.loadedKeys,
      loadingKeys = _ref2.loadingKeys,
      checkedKeys = _ref2.checkedKeys,
      halfCheckedKeys = _ref2.halfCheckedKeys,
      dragOverNodeKey = _ref2.dragOverNodeKey,
      dropPosition = _ref2.dropPosition,
      keyEntities = _ref2.keyEntities;
  var entity = keyEntities[key];
  var treeNodeProps = {
    eventKey: key,
    expanded: expandedKeys.indexOf(key) !== -1,
    selected: selectedKeys.indexOf(key) !== -1,
    loaded: loadedKeys.indexOf(key) !== -1,
    loading: loadingKeys.indexOf(key) !== -1,
    checked: checkedKeys.indexOf(key) !== -1,
    halfChecked: halfCheckedKeys.indexOf(key) !== -1,
    pos: String(entity ? entity.pos : ''),
    // [Legacy] Drag props
    dragOver: dragOverNodeKey === key && dropPosition === 0,
    dragOverGapTop: dragOverNodeKey === key && dropPosition === -1,
    dragOverGapBottom: dragOverNodeKey === key && dropPosition === 1
  };
  return treeNodeProps;
}

function convertNodePropsToEventData(props) {
  var data = props.data,
      expanded = props.expanded,
      selected = props.selected,
      checked = props.checked,
      loaded = props.loaded,
      loading = props.loading,
      halfChecked = props.halfChecked,
      dragOver = props.dragOver,
      dragOverGapTop = props.dragOverGapTop,
      dragOverGapBottom = props.dragOverGapBottom,
      pos = props.pos,
      active = props.active;
  var eventData = (0, _objectSpread2["default"])({}, data, {
    expanded: expanded,
    selected: selected,
    checked: checked,
    loaded: loaded,
    loading: loading,
    halfChecked: halfChecked,
    dragOver: dragOver,
    dragOverGapTop: dragOverGapTop,
    dragOverGapBottom: dragOverGapBottom,
    pos: pos,
    active: active
  });

  if (!('props' in eventData)) {
    Object.defineProperty(eventData, 'props', {
      get: function get() {
        (0, _warning["default"])(false, 'Second param return from event is node data instead of TreeNode instance. Please read value directly instead of reading from `props`.');
        return props;
      }
    });
  }

  return eventData;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJjLWNvbXBvbmVudHMvdHJlZS91dGlscy90cmVlVXRpbC5qcyJdLCJuYW1lcyI6WyJrZXkiLCJ0cmVlRGF0YSIsImtleXMiLCJwYXRoIiwibGlzdCIsImNoaWxkcmVuIiwidHJlZU5vZGUiLCJyZWNvcmRLZXkiLCJTdHJpbmciLCJkaWciLCJ0cmVlTm9kZXMiLCJyZXN0IiwiZGF0YU5vZGUiLCJwYXJzZWRDaGlsZHJlbiIsInRyZWVOb2RlTGlzdCIsImV4cGFuZGVkS2V5cyIsImV4cGFuZGVkS2V5U2V0IiwiZmxhdHRlbkxpc3QiLCJwYXJlbnQiLCJwb3MiLCJtZXJnZWRLZXkiLCJnZXRLZXkiLCJmbGF0dGVuTm9kZSIsImRhdGEiLCJpc1N0YXJ0IiwiaW5kZXgiLCJpc0VuZCIsIm5vZGUiLCJwYXJlbnRQb3MiLCJsZXZlbCIsImNhbGxiYWNrIiwicHJvY2Vzc05vZGUiLCJpbml0V3JhcHBlciIsInByb2Nlc3NFbnRpdHkiLCJvblByb2Nlc3NGaW5pc2hlZCIsInBvc0VudGl0aWVzIiwia2V5RW50aXRpZXMiLCJ3cmFwcGVyIiwidHJhdmVyc2VEYXRhTm9kZXMiLCJpdGVtIiwiZW50aXR5Iiwic2VsZWN0ZWRLZXlzIiwibG9hZGVkS2V5cyIsImxvYWRpbmdLZXlzIiwiY2hlY2tlZEtleXMiLCJoYWxmQ2hlY2tlZEtleXMiLCJkcmFnT3Zlck5vZGVLZXkiLCJkcm9wUG9zaXRpb24iLCJ0cmVlTm9kZVByb3BzIiwiZXZlbnRLZXkiLCJleHBhbmRlZCIsInNlbGVjdGVkIiwibG9hZGVkIiwibG9hZGluZyIsImNoZWNrZWQiLCJoYWxmQ2hlY2tlZCIsImRyYWdPdmVyIiwiZHJhZ092ZXJHYXBUb3AiLCJkcmFnT3ZlckdhcEJvdHRvbSIsImFjdGl2ZSIsInByb3BzIiwiZXZlbnREYXRhIiwiT2JqZWN0IiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBQSxRQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsOEJBQUEs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LENBQUEsaUJBQUE7QUFBQSxNQUN1RXpDLEdBRHZFLEdBQ3dGeUMsS0FEeEYsQ0FBQSxHQUFBO0FBQUEsTUFDNEVELE1BRDVFLEdBQ3dGQyxLQUR4RixDQUFBLE1BQUE7QUFFL0MsTUFBTUMsU0FBUyxHQUFBLENBQUEsR0FBQSxjQUFBLENBQUEsU0FBQSxDQUFBLEVBQUEsRUFBQSxFQUFBLElBQUEsRUFBQTtBQUVYWCxJQUFBQSxRQUFRLEVBRkcsUUFBQTtBQUdYQyxJQUFBQSxRQUFRLEVBSEcsUUFBQTtBQUlYRyxJQUFBQSxPQUFPLEVBSkksT0FBQTtBQUtYRixJQUFBQSxNQUFNLEVBTEssTUFBQTtBQU1YQyxJQUFBQSxPQUFPLEVBTkksT0FBQTtBQU9YRSxJQUFBQSxXQUFXLEVBUEEsV0FBQTtBQVFYQyxJQUFBQSxRQUFRLEVBUkcsUUFBQTtBQVNYQyxJQUFBQSxjQUFjLEVBVEgsY0FBQTtBQVVYQyxJQUFBQSxpQkFBaUIsRUFWTixpQkFBQTtBQVdYdkMsSUFBQUEsR0FBRyxFQVhRLEdBQUE7QUFZWHdDLElBQUFBLE1BQU0sRUFBTkE7QUFaVyxHQUFBLENBQWY7O0FBY0EsTUFBSSxFQUFFLFdBQU4sU0FBSSxDQUFKLEVBQTZCO0FBQ3pCRyxJQUFBQSxNQUFNLENBQU5BLGNBQUFBLENBQUFBLFNBQUFBLEVBQUFBLE9BQUFBLEVBQTBDO0FBQ3RDQyxNQUFBQSxHQURzQyxFQUFBLFNBQUEsR0FBQSxHQUNoQztBQUNGLFNBQUEsR0FBQSxRQUFBLENBQUEsU0FBQSxDQUFBLEVBQUEsS0FBQSxFQUFBLHVJQUFBO0FBQ0EsZUFBQSxLQUFBO0FBQ0g7QUFKcUMsS0FBMUNEO0FBTUg7O0FBQ0QsU0FBQSxTQUFBO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdG9BcnJheSBmcm9tICdyYy11dGlsL2xpYi9DaGlsZHJlbi90b0FycmF5JztcbmltcG9ydCB3YXJuaW5nIGZyb20gJ3JjLXV0aWwvbGliL3dhcm5pbmcnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHsgZ2V0UG9zaXRpb24sIGlzVHJlZU5vZGUgfSBmcm9tICcuLi91dGlsJztcbmV4cG9ydCBmdW5jdGlvbiBnZXRLZXkoa2V5LCBwb3MpIHtcbiAgICBpZiAoa2V5ICE9PSBudWxsICYmIGtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBrZXk7XG4gICAgfVxuICAgIHJldHVybiBwb3M7XG59XG4vKipcbiAqIFdhcm5pbmcgaWYgVHJlZU5vZGUgZG8gbm90IHByb3ZpZGVzIGtleVxuICovXG5leHBvcnQgZnVuY3Rpb24gd2FybmluZ1dpdGhvdXRLZXkodHJlZURhdGEgPSBbXSkge1xuICAgIGNvbnN0IGtleXMgPSBuZXcgTWFwKCk7XG4gICAgZnVuY3Rpb24gZGlnKGxpc3QsIHBhdGggPSAnJykge1xuICAgICAgICAobGlzdCB8fCBbXSkuZm9yRWFjaCh0cmVlTm9kZSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGtleSwgY2hpbGRyZW4gfSA9IHRyZWVOb2RlO1xuICAgICAgICAgICAgd2FybmluZyhrZXkgIT09IG51bGwgJiYga2V5ICE9PSB1bmRlZmluZWQsIGBUcmVlIG5vZGUgbXVzdCBoYXZlIGEgY2VydGFpbiBrZXk6IFske3BhdGh9JHtrZXl9XWApO1xuICAgICAgICAgICAgY29uc3QgcmVjb3JkS2V5ID0gU3RyaW5nKGtleSk7XG4gICAgICAgICAgICB3YXJuaW5nKCFrZXlzLmhhcyhyZWNvcmRLZXkpIHx8IGtleSA9PT0gbnVsbCB8fCBrZXkgPT09IHVuZGVmaW5lZCwgYFNhbWUgJ2tleScgZXhpc3QgaW4gdGhlIFRyZWU6ICR7cmVjb3JkS2V5fWApO1xuICAgICAgICAgICAga2V5cy5zZXQocmVjb3JkS2V5LCB0cnVlKTtcbiAgICAgICAgICAgIGRpZyhjaGlsZHJlbiwgYCR7cGF0aH0ke3JlY29yZEtleX0gPiBgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGRpZyh0cmVlRGF0YSk7XG59XG4vKipcbiAqIENvbnZlcnQgYGNoaWxkcmVuYCBvZiBUcmVlIGludG8gYHRyZWVEYXRhYCBzdHJ1Y3R1cmUuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0VHJlZVRvRGF0YShyb290Tm9kZXMpIHtcbiAgICBmdW5jdGlvbiBkaWcobm9kZSkge1xuICAgICAgICBjb25zdCB0cmVlTm9kZXMgPSB0b0FycmF5KG5vZGUpO1xuICAgICAgICByZXR1cm4gdHJlZU5vZGVzXG4gICAgICAgICAgICAubWFwKHRyZWVOb2RlID0+IHtcbiAgICAgICAgICAgIC8vIEZpbHRlciBpbnZhbGlkYXRlIG5vZGVcbiAgICAgICAgICAgIGlmICghaXNUcmVlTm9kZSh0cmVlTm9kZSkpIHtcbiAgICAgICAgICAgICAgICB3YXJuaW5nKCF0cmVlTm9kZSwgJ1RyZWUvVHJlZU5vZGUgY2FuIG9ubHkgYWNjZXB0IFRyZWVOb2RlIGFzIGNoaWxkcmVuLicpO1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgeyBrZXkgfSA9IHRyZWVOb2RlO1xuICAgICAgICAgICAgY29uc3QgeyBjaGlsZHJlbiwgLi4ucmVzdCB9ID0gdHJlZU5vZGUucHJvcHM7XG4gICAgICAgICAgICBjb25zdCBkYXRhTm9kZSA9IHtcbiAgICAgICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAgICAgLi4ucmVzdCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBwYXJzZWRDaGlsZHJlbiA9IGRpZyhjaGlsZHJlbik7XG4gICAgICAgICAgICBpZiAocGFyc2VkQ2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgZGF0YU5vZGUuY2hpbGRyZW4gPSBwYXJzZWRDaGlsZHJlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBkYXRhTm9kZTtcbiAgICAgICAgfSlcbiAgICAgICAgICAgIC5maWx0ZXIoKGRhdGFOb2RlKSA9PiBkYXRhTm9kZSk7XG4gICAgfVxuICAgIHJldHVybiBkaWcocm9vdE5vZGVzKTtcbn1cbi8qKlxuICogRmxhdCBuZXN0IHRyZWUgZGF0YSBpbnRvIGZsYXR0ZW4gbGlzdC4gVGhpcyBpcyB1c2VkIGZvciB2aXJ0dWFsIGxpc3QgcmVuZGVyLlxuICogQHBhcmFtIHRyZWVOb2RlTGlzdCBPcmlnaW4gZGF0YSBub2RlIGxpc3RcbiAqIEBwYXJhbSBleHBhbmRlZEtleXNcbiAqIG5lZWQgZXhwYW5kZWQga2V5cywgcHJvdmlkZXMgYHRydWVgIG1lYW5zIGFsbCBleHBhbmRlZCAodXNlZCBpbiBgcmMtdHJlZS1zZWxlY3RgKS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5UcmVlRGF0YSh0cmVlTm9kZUxpc3QgPSBbXSwgZXhwYW5kZWRLZXlzID0gW10pIHtcbiAgICBjb25zdCBleHBhbmRlZEtleVNldCA9IG5ldyBTZXQoZXhwYW5kZWRLZXlzID09PSB0cnVlID8gW10gOiBleHBhbmRlZEtleXMpO1xuICAgIGNvbnN0IGZsYXR0ZW5MaXN0ID0gW107XG4gICAgZnVuY3Rpb24gZGlnKGxpc3QsIHBhcmVudCA9IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGxpc3QubWFwKCh0cmVlTm9kZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBvcyA9IGdldFBvc2l0aW9uKHBhcmVudCA/IHBhcmVudC5wb3MgOiAnMCcsIGluZGV4KTtcbiAgICAgICAgICAgIGNvbnN0IG1lcmdlZEtleSA9IGdldEtleSh0cmVlTm9kZS5rZXksIHBvcyk7XG4gICAgICAgICAgICAvLyBBZGQgRmxhdHRlbkRhdGFOb2RlIGludG8gbGlzdFxuICAgICAgICAgICAgY29uc3QgZmxhdHRlbk5vZGUgPSB7XG4gICAgICAgICAgICAgICAgLi4udHJlZU5vZGUsXG4gICAgICAgICAgICAgICAgcGFyZW50LFxuICAgICAgICAgICAgICAgIHBvcyxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogbnVsbCxcbiAgICAgICAgICAgICAgICBkYXRhOiB0cmVlTm9kZSxcbiAgICAgICAgICAgICAgICBpc1N0YXJ0OiBbLi4uKHBhcmVudCA/IHBhcmVudC5pc1N0YXJ0IDogW10pLCBpbmRleCA9PT0gMF0sXG4gICAgICAgICAgICAgICAgaXNFbmQ6IFsuLi4ocGFyZW50ID8gcGFyZW50LmlzRW5kIDogW10pLCBpbmRleCA9PT0gbGlzdC5sZW5ndGggLSAxXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBmbGF0dGVuTGlzdC5wdXNoKGZsYXR0ZW5Ob2RlKTtcbiAgICAgICAgICAgIC8vIExvb3AgdHJlZU5vZGUgY2hpbGRyZW5cbiAgICAgICAgICAgIGlmIChleHBhbmRlZEtleXMgPT09IHRydWUgfHwgZXhwYW5kZWRLZXlTZXQuaGFzKG1lcmdlZEtleSkpIHtcbiAgICAgICAgICAgICAgICBmbGF0dGVuTm9kZS5jaGlsZHJlbiA9IGRpZyh0cmVlTm9kZS5jaGlsZHJlbiB8fCBbXSwgZmxhdHRlbk5vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZmxhdHRlbk5vZGUuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmbGF0dGVuTm9kZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGRpZyh0cmVlTm9kZUxpc3QpO1xuICAgIHJldHVybiBmbGF0dGVuTGlzdDtcbn1cbi8qKlxuICogVHJhdmVyc2UgYWxsIHRoZSBkYXRhIGJ5IGB0cmVlRGF0YWAuXG4gKiBQbGVhc2Ugbm90IHVzZSBpdCBvdXQgb2YgdGhlIGByYy10cmVlYCBzaW5jZSB3ZSBtYXkgcmVmYWN0b3IgdGhpcyBjb2RlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdHJhdmVyc2VEYXRhTm9kZXMoZGF0YU5vZGVzLCBjYWxsYmFjaykge1xuICAgIGZ1bmN0aW9uIHByb2Nlc3NOb2RlKG5vZGUsIGluZGV4LCBwYXJlbnQpIHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBub2RlID8gbm9kZS5jaGlsZHJlbiA6IGRhdGFOb2RlcztcbiAgICAgICAgY29uc3QgcG9zID0gbm9kZSA/IGdldFBvc2l0aW9uKHBhcmVudC5wb3MsIGluZGV4KSA6ICcwJztcbiAgICAgICAgLy8gUHJvY2VzcyBub2RlIGlmIGlzIG5vdCByb290XG4gICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgcG9zLFxuICAgICAgICAgICAgICAgIGtleTogbm9kZS5rZXkgIT09IG51bGwgPyBub2RlLmtleSA6IHBvcyxcbiAgICAgICAgICAgICAgICBwYXJlbnRQb3M6IHBhcmVudC5ub2RlID8gcGFyZW50LnBvcyA6IG51bGwsXG4gICAgICAgICAgICAgICAgbGV2ZWw6IHBhcmVudC5sZXZlbCArIDEsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gUHJvY2VzcyBjaGlsZHJlbiBub2RlXG4gICAgICAgIGlmIChjaGlsZHJlbikge1xuICAgICAgICAgICAgY2hpbGRyZW4uZm9yRWFjaCgoc3ViTm9kZSwgc3ViSW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzTm9kZShzdWJOb2RlLCBzdWJJbmRleCwge1xuICAgICAgICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICAgICAgICBwb3MsXG4gICAgICAgICAgICAgICAgICAgIGxldmVsOiBwYXJlbnQgPyBwYXJlbnQubGV2ZWwgKyAxIDogLTEsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwcm9jZXNzTm9kZShudWxsKTtcbn1cbi8qKlxuICogQ29udmVydCBgdHJlZURhdGFgIGludG8gZW50aXR5IHJlY29yZHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0RGF0YVRvRW50aXRpZXMoZGF0YU5vZGVzLCB7IGluaXRXcmFwcGVyLCBwcm9jZXNzRW50aXR5LCBvblByb2Nlc3NGaW5pc2hlZCwgfSA9IHt9KSB7XG4gICAgY29uc3QgcG9zRW50aXRpZXMgPSB7fTtcbiAgICBjb25zdCBrZXlFbnRpdGllcyA9IHt9O1xuICAgIGxldCB3cmFwcGVyID0ge1xuICAgICAgICBwb3NFbnRpdGllcyxcbiAgICAgICAga2V5RW50aXRpZXMsXG4gICAgfTtcbiAgICBpZiAoaW5pdFdyYXBwZXIpIHtcbiAgICAgICAgd3JhcHBlciA9IGluaXRXcmFwcGVyKHdyYXBwZXIpIHx8IHdyYXBwZXI7XG4gICAgfVxuICAgIHRyYXZlcnNlRGF0YU5vZGVzKGRhdGFOb2RlcywgaXRlbSA9PiB7XG4gICAgICAgIGNvbnN0IHsgbm9kZSwgaW5kZXgsIHBvcywga2V5LCBwYXJlbnRQb3MsIGxldmVsIH0gPSBpdGVtO1xuICAgICAgICBjb25zdCBlbnRpdHkgPSB7IG5vZGUsIGluZGV4LCBrZXksIHBvcywgbGV2ZWwgfTtcbiAgICAgICAgY29uc3QgbWVyZ2VkS2V5ID0gZ2V0S2V5KGtleSwgcG9zKTtcbiAgICAgICAgcG9zRW50aXRpZXNbcG9zXSA9IGVudGl0eTtcbiAgICAgICAga2V5RW50aXRpZXNbbWVyZ2VkS2V5XSA9IGVudGl0eTtcbiAgICAgICAgLy8gRmlsbCBjaGlsZHJlblxuICAgICAgICBlbnRpdHkucGFyZW50ID0gcG9zRW50aXRpZXNbcGFyZW50UG9zXTtcbiAgICAgICAgaWYgKGVudGl0eS5wYXJlbnQpIHtcbiAgICAgICAgICAgIGVudGl0eS5wYXJlbnQuY2hpbGRyZW4gPSBlbnRpdHkucGFyZW50LmNoaWxkcmVuIHx8IFtdO1xuICAgICAgICAgICAgZW50aXR5LnBhcmVudC5jaGlsZHJlbi5wdXNoKGVudGl0eSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb2Nlc3NFbnRpdHkpIHtcbiAgICAgICAgICAgIHByb2Nlc3NFbnRpdHkoZW50aXR5LCB3cmFwcGVyKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChvblByb2Nlc3NGaW5pc2hlZCkge1xuICAgICAgICBvblByb2Nlc3NGaW5pc2hlZCh3cmFwcGVyKTtcbiAgICB9XG4gICAgcmV0dXJuIHdyYXBwZXI7XG59XG4vKipcbiAqIEdldCBUcmVlTm9kZSBwcm9wcyB3aXRoIFRyZWUgcHJvcHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUcmVlTm9kZVByb3BzKGtleSwgeyBleHBhbmRlZEtleXMsIHNlbGVjdGVkS2V5cywgbG9hZGVkS2V5cywgbG9hZGluZ0tleXMsIGNoZWNrZWRLZXlzLCBoYWxmQ2hlY2tlZEtleXMsIGRyYWdPdmVyTm9kZUtleSwgZHJvcFBvc2l0aW9uLCBrZXlFbnRpdGllcywgfSkge1xuICAgIGNvbnN0IGVudGl0eSA9IGtleUVudGl0aWVzW2tleV07XG4gICAgY29uc3QgdHJlZU5vZGVQcm9wcyA9IHtcbiAgICAgICAgZXZlbnRLZXk6IGtleSxcbiAgICAgICAgZXhwYW5kZWQ6IGV4cGFuZGVkS2V5cy5pbmRleE9mKGtleSkgIT09IC0xLFxuICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWRLZXlzLmluZGV4T2Yoa2V5KSAhPT0gLTEsXG4gICAgICAgIGxvYWRlZDogbG9hZGVkS2V5cy5pbmRleE9mKGtleSkgIT09IC0xLFxuICAgICAgICBsb2FkaW5nOiBsb2FkaW5nS2V5cy5pbmRleE9mKGtleSkgIT09IC0xLFxuICAgICAgICBjaGVja2VkOiBjaGVja2VkS2V5cy5pbmRleE9mKGtleSkgIT09IC0xLFxuICAgICAgICBoYWxmQ2hlY2tlZDogaGFsZkNoZWNrZWRLZXlzLmluZGV4T2Yoa2V5KSAhPT0gLTEsXG4gICAgICAgIHBvczogU3RyaW5nKGVudGl0eSA/IGVudGl0eS5wb3MgOiAnJyksXG4gICAgICAgIC8vIFtMZWdhY3ldIERyYWcgcHJvcHNcbiAgICAgICAgZHJhZ092ZXI6IGRyYWdPdmVyTm9kZUtleSA9PT0ga2V5ICYmIGRyb3BQb3NpdGlvbiA9PT0gMCxcbiAgICAgICAgZHJhZ092ZXJHYXBUb3A6IGRyYWdPdmVyTm9kZUtleSA9PT0ga2V5ICYmIGRyb3BQb3NpdGlvbiA9PT0gLTEsXG4gICAgICAgIGRyYWdPdmVyR2FwQm90dG9tOiBkcmFnT3Zlck5vZGVLZXkgPT09IGtleSAmJiBkcm9wUG9zaXRpb24gPT09IDEsXG4gICAgfTtcbiAgICByZXR1cm4gdHJlZU5vZGVQcm9wcztcbn1cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0Tm9kZVByb3BzVG9FdmVudERhdGEocHJvcHMpIHtcbiAgICBjb25zdCB7IGRhdGEsIGV4cGFuZGVkLCBzZWxlY3RlZCwgY2hlY2tlZCwgbG9hZGVkLCBsb2FkaW5nLCBoYWxmQ2hlY2tlZCwgZHJhZ092ZXIsIGRyYWdPdmVyR2FwVG9wLCBkcmFnT3ZlckdhcEJvdHRvbSwgcG9zLCBhY3RpdmUsIH0gPSBwcm9wcztcbiAgICBjb25zdCBldmVudERhdGEgPSB7XG4gICAgICAgIC4uLmRhdGEsXG4gICAgICAgIGV4cGFuZGVkLFxuICAgICAgICBzZWxlY3RlZCxcbiAgICAgICAgY2hlY2tlZCxcbiAgICAgICAgbG9hZGVkLFxuICAgICAgICBsb2FkaW5nLFxuICAgICAgICBoYWxmQ2hlY2tlZCxcbiAgICAgICAgZHJhZ092ZXIsXG4gICAgICAgIGRyYWdPdmVyR2FwVG9wLFxuICAgICAgICBkcmFnT3ZlckdhcEJvdHRvbSxcbiAgICAgICAgcG9zLFxuICAgICAgICBhY3RpdmUsXG4gICAgfTtcbiAgICBpZiAoISgncHJvcHMnIGluIGV2ZW50RGF0YSkpIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV2ZW50RGF0YSwgJ3Byb3BzJywge1xuICAgICAgICAgICAgZ2V0KCkge1xuICAgICAgICAgICAgICAgIHdhcm5pbmcoZmFsc2UsICdTZWNvbmQgcGFyYW0gcmV0dXJuIGZyb20gZXZlbnQgaXMgbm9kZSBkYXRhIGluc3RlYWQgb2YgVHJlZU5vZGUgaW5zdGFuY2UuIFBsZWFzZSByZWFkIHZhbHVlIGRpcmVjdGx5IGluc3RlYWQgb2YgcmVhZGluZyBmcm9tIGBwcm9wc2AuJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3BzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBldmVudERhdGE7XG59XG4iXX0=