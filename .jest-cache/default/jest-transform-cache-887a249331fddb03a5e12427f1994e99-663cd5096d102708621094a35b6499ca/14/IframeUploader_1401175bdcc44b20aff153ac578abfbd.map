{"version":3,"sources":["IframeUploader.jsx"],"names":["IFRAME_STYLE","position","top","opacity","filter","left","zIndex","IframeUploader","uploading","state","props","file","response","doc","getIframeDocument","script","getElementsByTagName","parentNode","body","removeChild","innerHTML","onSuccess","err","onError","endUpload","target","getFormInputNode","uid","name","value","startUpload","beforeUpload","post","before","then","node","iframe","updateIframeWH","initIframe","getIframeNode","contentDocument","getElementById","multiple","domain","domainScript","domainInput","action","src","iframeNode","win","contentWindow","initIframeSrc","document","e","open","write","getIframeHTML","close","onchange","onChange","setState","rootNode","ReactDOM","findDOMNode","style","height","offsetHeight","width","offsetWidth","formNode","getFormNode","dataSpan","getFormDataNode","data","onStart","inputs","createDocumentFragment","key","hasOwnProperty","input","createElement","setAttribute","appendChild","submit","Tag","component","disabled","className","prefixCls","children","iframeStyle","display","cls","saveIframe","onLoad","Component","PropTypes","string","object","bool","accept","func","any","oneOfType"],"mappings":"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","sourcesContent":["/* eslint react/sort-comp:0 */\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport ReactDOM from 'react-dom';\nimport classNames from 'classnames';\nimport getUid from './uid';\nimport warning from '../../_util/warning';\n\nconst IFRAME_STYLE = {\n  position: 'absolute',\n  top: 0,\n  opacity: 0,\n  filter: 'alpha(opacity=0)',\n  left: 0,\n  zIndex: 9999,\n};\n\n// diferent from AjaxUpload, can only upload on at one time, serial seriously\nclass IframeUploader extends Component {\n  static propTypes = {\n    component: PropTypes.string,\n    style: PropTypes.object,\n    disabled: PropTypes.bool,\n    prefixCls: PropTypes.string,\n    className: PropTypes.string,\n    accept: PropTypes.string,\n    onStart: PropTypes.func,\n    multiple: PropTypes.bool,\n    children: PropTypes.any,\n    data: PropTypes.oneOfType([\n      PropTypes.object,\n      PropTypes.func,\n    ]),\n    action: PropTypes.string,\n    name: PropTypes.string,\n  }\n\n  state = { uploading: false }\n\n  file = {}\n\n  onLoad = () => {\n    if (!this.state.uploading) {\n      return;\n    }\n    const { props, file } = this;\n    let response;\n    try {\n      const doc = this.getIframeDocument();\n      const script = doc.getElementsByTagName('script')[0];\n      if (script && script.parentNode === doc.body) {\n        doc.body.removeChild(script);\n      }\n      response = doc.body.innerHTML;\n      props.onSuccess(response, file);\n    } catch (err) {\n      warning(false, 'cross domain error for Upload. Maybe server should return document.domain script. see Note from https://github.com/react-component/upload');\n      response = 'cross-domain';\n      props.onError(err, null, file);\n    }\n    this.endUpload();\n  }\n\n  onChange = () => {\n    const target = this.getFormInputNode();\n    // ie8/9 don't support FileList Object\n    // http://stackoverflow.com/questions/12830058/ie8-input-type-file-get-files\n    const file = this.file = {\n      uid: getUid(),\n      name: target.value,\n    };\n    this.startUpload();\n    const { props } = this;\n    if (!props.beforeUpload) {\n      return this.post(file);\n    }\n    const before = props.beforeUpload(file);\n    if (before && before.then) {\n      before.then(() => {\n        this.post(file);\n      }, () => {\n        this.endUpload();\n      });\n    } else if (before !== false) {\n      this.post(file);\n    } else {\n      this.endUpload();\n    }\n  }\n\n  componentDidMount() {\n    this.updateIframeWH();\n    this.initIframe();\n  }\n\n  componentDidUpdate() {\n    this.updateIframeWH();\n  }\n\n  getIframeNode() {\n    return this.iframe;\n  }\n\n  getIframeDocument() {\n    return this.getIframeNode().contentDocument;\n  }\n\n  getFormNode() {\n    return this.getIframeDocument().getElementById('form');\n  }\n\n  getFormInputNode() {\n    return this.getIframeDocument().getElementById('input');\n  }\n\n  getFormDataNode() {\n    return this.getIframeDocument().getElementById('data');\n  }\n\n  getFileForMultiple(file) {\n    return this.props.multiple ? [file] : file;\n  }\n\n  getIframeHTML(domain) {\n    let domainScript = '';\n    let domainInput = '';\n    if (domain) {\n      const script = 'script';\n      domainScript = `<${script}>document.domain=\"${domain}\";</${script}>`;\n      domainInput = `<input name=\"_documentDomain\" value=\"${domain}\" />`;\n    }\n    return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    <style>\n    body,html {padding:0;margin:0;border:0;overflow:hidden;}\n    </style>\n    ${domainScript}\n    </head>\n    <body>\n    <form method=\"post\"\n    encType=\"multipart/form-data\"\n    action=\"${this.props.action}\" id=\"form\"\n    style=\"display:block;height:9999px;position:relative;overflow:hidden;\">\n    <input id=\"input\" type=\"file\"\n     name=\"${this.props.name}\"\n     style=\"position:absolute;top:0;right:0;height:9999px;font-size:9999px;cursor:pointer;\"/>\n    ${domainInput}\n    <span id=\"data\"></span>\n    </form>\n    </body>\n    </html>\n    `;\n  }\n\n  initIframeSrc() {\n    if (this.domain) {\n      this.getIframeNode().src = `javascript:void((function(){\n        var d = document;\n        d.open();\n        d.domain='${this.domain}';\n        d.write('');\n        d.close();\n      })())`;\n    }\n  }\n\n  initIframe() {\n    const iframeNode = this.getIframeNode();\n    let win = iframeNode.contentWindow;\n    let doc;\n    this.domain = this.domain || '';\n    this.initIframeSrc();\n    try {\n      doc = win.document;\n    } catch (e) {\n      this.domain = document.domain;\n      this.initIframeSrc();\n      win = iframeNode.contentWindow;\n      doc = win.document;\n    }\n    doc.open('text/html', 'replace');\n    doc.write(this.getIframeHTML(this.domain));\n    doc.close();\n    this.getFormInputNode().onchange = this.onChange;\n  }\n\n  endUpload() {\n    if (this.state.uploading) {\n      this.file = {};\n      // hack avoid batch\n      this.state.uploading = false;\n      this.setState({\n        uploading: false,\n      });\n      this.initIframe();\n    }\n  }\n\n  startUpload() {\n    if (!this.state.uploading) {\n      this.state.uploading = true;\n      this.setState({\n        uploading: true,\n      });\n    }\n  }\n\n  updateIframeWH() {\n    const rootNode = ReactDOM.findDOMNode(this);\n    const iframeNode = this.getIframeNode();\n    iframeNode.style.height = `${rootNode.offsetHeight}px`;\n    iframeNode.style.width = `${rootNode.offsetWidth}px`;\n  }\n\n  abort(file) {\n    if (file) {\n      let uid = file;\n      if (file && file.uid) {\n        uid = file.uid;\n      }\n      if (uid === this.file.uid) {\n        this.endUpload();\n      }\n    } else {\n      this.endUpload();\n    }\n  }\n\n  post(file) {\n    const formNode = this.getFormNode();\n    const dataSpan = this.getFormDataNode();\n    let { data } = this.props;\n    const { onStart } = this.props;\n    if (typeof data === 'function') {\n      data = data(file);\n    }\n    const inputs = document.createDocumentFragment();\n    for (const key in data) {\n      if (data.hasOwnProperty(key)) {\n        const input = document.createElement('input');\n        input.setAttribute('name', key);\n        input.value = data[key];\n        inputs.appendChild(input);\n      }\n    }\n    dataSpan.appendChild(inputs);\n    formNode.submit();\n    dataSpan.innerHTML = '';\n    onStart(file);\n  }\n\n  saveIframe = (node) => {\n    this.iframe = node;\n  }\n\n  render() {\n    const {\n      component: Tag, disabled, className,\n      prefixCls, children, style,\n    } = this.props;\n    const iframeStyle = {\n      ...IFRAME_STYLE,\n      display: this.state.uploading || disabled ? 'none' : '',\n    };\n    const cls = classNames({\n      [prefixCls]: true,\n      [`${prefixCls}-disabled`]: disabled,\n      [className]: className,\n    });\n    return (\n      <Tag\n        className={cls}\n        style={{ position: 'relative', zIndex: 0, ...style }}\n      >\n        <iframe\n          ref={this.saveIframe}\n          onLoad={this.onLoad}\n          style={iframeStyle}\n        />\n        {children}\n      </Tag>\n    );\n  }\n}\n\nexport default IframeUploader;\n"]}