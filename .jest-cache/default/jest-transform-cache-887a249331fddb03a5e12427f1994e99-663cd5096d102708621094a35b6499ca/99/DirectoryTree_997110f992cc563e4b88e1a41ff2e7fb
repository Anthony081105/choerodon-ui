9111527c36ff671aed74c24fa6fe994e
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var React = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _omit = _interopRequireDefault(require("lodash/omit"));

var _debounce = _interopRequireDefault(require("lodash/debounce"));

var _icon = _interopRequireDefault(require("../icon"));

var _util = require("../rc-components/tree/util");

var _treeUtil = require("../rc-components/tree/utils/treeUtil");

var _configure = require("../configure");

var _index = _interopRequireDefault(require("./index"));

var _dictUtil = require("./utils/dictUtil");

function _createSuper(Derived) {
  function isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  return function () {
    var Super = (0, _getPrototypeOf2["default"])(Derived),
        result;

    if (isNativeReflectConstruct()) {
      var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor;
      result = Reflect.construct(Super, arguments, NewTarget);
    } else {
      result = Super.apply(this, arguments);
    }

    return (0, _possibleConstructorReturn2["default"])(this, result);
  };
}

function getIcon(props) {
  var isLeaf = props.isLeaf,
      expanded = props.expanded,
      prefixCls = props.prefixCls;
  var prefixCl = (0, _configure.getPrefixCls)('tree', prefixCls);

  if (isLeaf) {
    return React.createElement(_icon["default"], {
      type: "insert_drive_file",
      className: "".concat(prefixCl, "-switcher-line-icon")
    });
  }

  return expanded ? React.createElement(_icon["default"], {
    type: "baseline-file_copy",
    className: "".concat(prefixCl, "-switcher-line-icon")
  }) : React.createElement(_icon["default"], {
    type: "library_books",
    className: "".concat(prefixCl, "-switcher-line-icon")
  });
}

function getTreeData(_ref) {
  var treeData = _ref.treeData,
      children = _ref.children;
  return treeData || (0, _treeUtil.convertTreeToData)(children);
}

var DirectoryTree =
/*#__PURE__*/
function (_React$Component) {
  (0, _inherits2["default"])(DirectoryTree, _React$Component);

  var _super = _createSuper(DirectoryTree);

  function DirectoryTree(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, DirectoryTree);
    _this = _super.call(this, props);

    _this.onExpand = function (expandedKeys, info) {
      var onExpand = _this.props.onExpand;

      _this.setUncontrolledState({
        expandedKeys: expandedKeys
      }); // Call origin function


      if (onExpand) {
        return onExpand(expandedKeys, info);
      }

      return undefined;
    };

    _this.onClick = function (event, node) {
      var _this$props = _this.props,
          onClick = _this$props.onClick,
          expandAction = _this$props.expandAction; // Expand the tree

      if (expandAction === 'click') {
        _this.onDebounceExpand(event, node);
      }

      if (onClick) {
        onClick(event, node);
      }
    };

    _this.onDoubleClick = function (event, node) {
      var _this$props2 = _this.props,
          onDoubleClick = _this$props2.onDoubleClick,
          expandAction = _this$props2.expandAction; // Expand the tree

      if (expandAction === 'doubleClick') {
        _this.onDebounceExpand(event, node);
      }

      if (onDoubleClick) {
        onDoubleClick(event, node);
      }
    };

    _this.onSelect = function (keys, event) {
      var _this$props3 = _this.props,
          onSelect = _this$props3.onSelect,
          multiple = _this$props3.multiple;
      var _this$state$expandedK = _this.state.expandedKeys,
          expandedKeys = _this$state$expandedK === void 0 ? [] : _this$state$expandedK;
      var node = event.node,
          nativeEvent = event.nativeEvent;
      var _node$key = node.key,
          key = _node$key === void 0 ? '' : _node$key;
      var treeData = getTreeData(_this.props);
      var newState = {}; // We need wrap this event since some value is not same

      var newEvent = (0, _objectSpread2["default"])({}, event, {
        selected: true
      }); // Windows / Mac single pick

      var ctrlPick = nativeEvent.ctrlKey || nativeEvent.metaKey;
      var shiftPick = nativeEvent.shiftKey; // Generate new selected keys

      var newSelectedKeys;

      if (multiple && ctrlPick) {
        // Control click
        newSelectedKeys = keys;
        _this.lastSelectedKey = key;
        _this.cachedSelectedKeys = newSelectedKeys;
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      } else if (multiple && shiftPick) {
        // Shift click
        newSelectedKeys = Array.from(new Set([].concat((0, _toConsumableArray2["default"])(_this.cachedSelectedKeys || []), (0, _toConsumableArray2["default"])((0, _dictUtil.calcRangeKeys)(treeData, expandedKeys, key, _this.lastSelectedKey)))));
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      } else {
        // Single click
        newSelectedKeys = [key];
        _this.lastSelectedKey = key;
        _this.cachedSelectedKeys = newSelectedKeys;
        newEvent.selectedNodes = (0, _dictUtil.convertDirectoryKeysToNodes)(treeData, newSelectedKeys);
      }

      newState.selectedKeys = newSelectedKeys;

      if (onSelect) {
        onSelect(newSelectedKeys, newEvent);
      }

      _this.setUncontrolledState(newState);
    };

    _this.setTreeRef = function (node) {
      _this.tree = node;
    };

    _this.expandFolderNode = function (event, node) {
      var isLeaf = node.isLeaf;

      if (isLeaf || event.shiftKey || event.metaKey || event.ctrlKey) {
        return;
      } // Get internal rc-tree


      var internalTree = _this.tree.tree; // Call internal rc-tree expand function
      // https://github.com/C7n-design/C7n-design/issues/12567

      internalTree.onNodeExpand(event, node);
    };

    _this.setUncontrolledState = function (state) {
      var newState = (0, _omit["default"])(state, Object.keys(_this.props));

      if (Object.keys(newState).length) {
        _this.setState(newState);
      }
    };

    _this.renderDirectoryTree = function () {
      var _this$props4 = _this.props,
          className = _this$props4.className,
          props = (0, _objectWithoutProperties2["default"])(_this$props4, ["className"]);
      var _this$state = _this.state,
          expandedKeys = _this$state.expandedKeys,
          selectedKeys = _this$state.selectedKeys;

      var prefixCls = _this.getPrefixCls();

      var connectClassName = (0, _classnames["default"])("".concat(prefixCls, "-directory"), className, (0, _defineProperty2["default"])({}, "".concat(prefixCls, "-directory-rtl"), true));
      return React.createElement(_index["default"], (0, _extends2["default"])({
        icon: getIcon,
        ref: _this.setTreeRef,
        blockNode: true
      }, props, {
        prefixCls: prefixCls,
        className: connectClassName,
        expandedKeys: expandedKeys,
        selectedKeys: selectedKeys,
        onSelect: _this.onSelect,
        onClick: _this.onClick,
        onDoubleClick: _this.onDoubleClick,
        onExpand: _this.onExpand
      }));
    };

    var defaultExpandAll = props.defaultExpandAll,
        defaultExpandParent = props.defaultExpandParent,
        expandedKeys = props.expandedKeys,
        defaultExpandedKeys = props.defaultExpandedKeys;

    var _convertDataToEntitie = (0, _treeUtil.convertDataToEntities)(getTreeData(props)),
        keyEntities = _convertDataToEntitie.keyEntities; // Selected keys


    _this.state = {
      selectedKeys: props.selectedKeys || props.defaultSelectedKeys || []
    }; // Expanded keys

    if (defaultExpandAll) {
      _this.state.expandedKeys = Object.keys(keyEntities);
    } else if (defaultExpandParent) {
      _this.state.expandedKeys = (0, _util.conductExpandParent)(expandedKeys || defaultExpandedKeys || [], keyEntities);
    } else {
      _this.state.expandedKeys = expandedKeys || defaultExpandedKeys;
    }

    _this.onDebounceExpand = (0, _debounce["default"])(_this.expandFolderNode, 200, {
      leading: true
    });
    return _this;
  }

  (0, _createClass2["default"])(DirectoryTree, [{
    key: "getPrefixCls",
    value: function getPrefixCls() {
      var prefixCls = this.props.prefixCls;
      return (0, _configure.getPrefixCls)('tree', prefixCls);
    }
  }, {
    key: "render",
    value: function render() {
      return this.renderDirectoryTree();
    }
  }], [{
    key: "getDerivedStateFromProps",
    value: function getDerivedStateFromProps(nextProps) {
      var newState = {};

      if ('expandedKeys' in nextProps) {
        newState.expandedKeys = nextProps.expandedKeys;
      }

      if ('selectedKeys' in nextProps) {
        newState.selectedKeys = nextProps.selectedKeys;
      }

      return newState;
    }
  }]);
  return DirectoryTree;
}(React.Component);

DirectoryTree.defaultProps = {
  showIcon: true,
  expandAction: 'click'
};
var _default = DirectoryTree;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyZWUvRGlyZWN0b3J5VHJlZS5qcyJdLCJuYW1lcyI6WyJpc0xlYWYiLCJleHBhbmRlZCIsInByZWZpeENscyIsInByb3BzIiwicHJlZml4Q2wiLCJJY29uIiwidHlwZSIsImNsYXNzTmFtZSIsInRyZWVEYXRhIiwiY2hpbGRyZW4iLCJEaXJlY3RvcnlUcmVlIiwiUmVhY3QiLCJDb21wb25lbnQiLCJvbkV4cGFuZCIsImV4cGFuZGVkS2V5cyIsIm9uQ2xpY2siLCJleHBhbmRBY3Rpb24iLCJvbkRvdWJsZUNsaWNrIiwib25TZWxlY3QiLCJtdWx0aXBsZSIsIm5vZGUiLCJuYXRpdmVFdmVudCIsImV2ZW50Iiwia2V5IiwiZ2V0VHJlZURhdGEiLCJuZXdTdGF0ZSIsIm5ld0V2ZW50Iiwic2VsZWN0ZWQiLCJjdHJsUGljayIsInNoaWZ0UGljayIsIm5ld1NlbGVjdGVkS2V5cyIsIkFycmF5IiwiaW50ZXJuYWxUcmVlIiwiT2JqZWN0Iiwic2VsZWN0ZWRLZXlzIiwiY29ubmVjdENsYXNzTmFtZSIsIlRyZWUiLCJpY29uIiwicmVmIiwiYmxvY2tOb2RlIiwiZGVmYXVsdEV4cGFuZEFsbCIsImRlZmF1bHRFeHBhbmRQYXJlbnQiLCJkZWZhdWx0RXhwYW5kZWRLZXlzIiwia2V5RW50aXRpZXMiLCJsZWFkaW5nIiwibmV4dFByb3BzIiwic2hvd0ljb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFBLEtBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLFdBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLEtBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxhQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLFNBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxpQkFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxLQUFB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O0FBQ0EsVUFBSSxrQkFBSixTQUFBLEVBQWlDO0FBQzdCQSxRQUFBQSxRQUFRLENBQVJBLFlBQUFBLEdBQXdCb0IsU0FBUyxDQUFqQ3BCLFlBQUFBO0FBQ0g7O0FBQ0QsVUFBSSxrQkFBSixTQUFBLEVBQWlDO0FBQzdCQSxRQUFBQSxRQUFRLENBQVJBLFlBQUFBLEdBQXdCb0IsU0FBUyxDQUFqQ3BCLFlBQUFBO0FBQ0g7O0FBQ0QsYUFBQSxRQUFBO0FBQ0g7OztFQXZJdUJkLEtBQUssQ0FBQ0MsUzs7QUFnSmxDRixhQUFhLENBQWJBLFlBQUFBLEdBQTZCO0FBQ3pCb0MsRUFBQUEsUUFBUSxFQURpQixJQUFBO0FBRXpCOUIsRUFBQUEsWUFBWSxFQUFFO0FBRlcsQ0FBN0JOO2VBSWVBLGEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBvbWl0IGZyb20gJ2xvZGFzaC9vbWl0JztcbmltcG9ydCBkZWJvdW5jZSBmcm9tICdsb2Rhc2gvZGVib3VuY2UnO1xuaW1wb3J0IEljb24gZnJvbSAnLi4vaWNvbic7XG5pbXBvcnQgeyBjb25kdWN0RXhwYW5kUGFyZW50IH0gZnJvbSAnLi4vcmMtY29tcG9uZW50cy90cmVlL3V0aWwnO1xuaW1wb3J0IHsgY29udmVydERhdGFUb0VudGl0aWVzLCBjb252ZXJ0VHJlZVRvRGF0YSB9IGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdHJlZS91dGlscy90cmVlVXRpbCc7XG5pbXBvcnQgeyBnZXRQcmVmaXhDbHMgfSBmcm9tICcuLi9jb25maWd1cmUnO1xuaW1wb3J0IFRyZWUgZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBjYWxjUmFuZ2VLZXlzLCBjb252ZXJ0RGlyZWN0b3J5S2V5c1RvTm9kZXMgfSBmcm9tICcuL3V0aWxzL2RpY3RVdGlsJztcbmZ1bmN0aW9uIGdldEljb24ocHJvcHMpIHtcbiAgICBjb25zdCB7IGlzTGVhZiwgZXhwYW5kZWQsIHByZWZpeENscyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcHJlZml4Q2wgPSBnZXRQcmVmaXhDbHMoJ3RyZWUnLCBwcmVmaXhDbHMpO1xuICAgIGlmIChpc0xlYWYpIHtcbiAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoSWNvbiwgeyB0eXBlOiBcImluc2VydF9kcml2ZV9maWxlXCIsIGNsYXNzTmFtZTogYCR7cHJlZml4Q2x9LXN3aXRjaGVyLWxpbmUtaWNvbmAgfSk7XG4gICAgfVxuICAgIHJldHVybiBleHBhbmRlZCA/IFJlYWN0LmNyZWF0ZUVsZW1lbnQoSWNvbiwgeyB0eXBlOiBcImJhc2VsaW5lLWZpbGVfY29weVwiLCBjbGFzc05hbWU6IGAke3ByZWZpeENsfS1zd2l0Y2hlci1saW5lLWljb25gIH0pIDogUmVhY3QuY3JlYXRlRWxlbWVudChJY29uLCB7IHR5cGU6IFwibGlicmFyeV9ib29rc1wiLCBjbGFzc05hbWU6IGAke3ByZWZpeENsfS1zd2l0Y2hlci1saW5lLWljb25gIH0pO1xufVxuZnVuY3Rpb24gZ2V0VHJlZURhdGEoeyB0cmVlRGF0YSwgY2hpbGRyZW4gfSkge1xuICAgIHJldHVybiB0cmVlRGF0YSB8fCBjb252ZXJ0VHJlZVRvRGF0YShjaGlsZHJlbik7XG59XG5jbGFzcyBEaXJlY3RvcnlUcmVlIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgICAgIHRoaXMub25FeHBhbmQgPSAoZXhwYW5kZWRLZXlzLCBpbmZvKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IG9uRXhwYW5kIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgdGhpcy5zZXRVbmNvbnRyb2xsZWRTdGF0ZSh7IGV4cGFuZGVkS2V5cyB9KTtcbiAgICAgICAgICAgIC8vIENhbGwgb3JpZ2luIGZ1bmN0aW9uXG4gICAgICAgICAgICBpZiAob25FeHBhbmQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb25FeHBhbmQoZXhwYW5kZWRLZXlzLCBpbmZvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMub25DbGljayA9IChldmVudCwgbm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBvbkNsaWNrLCBleHBhbmRBY3Rpb24gfSA9IHRoaXMucHJvcHM7XG4gICAgICAgICAgICAvLyBFeHBhbmQgdGhlIHRyZWVcbiAgICAgICAgICAgIGlmIChleHBhbmRBY3Rpb24gPT09ICdjbGljaycpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRGVib3VuY2VFeHBhbmQoZXZlbnQsIG5vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9uQ2xpY2spIHtcbiAgICAgICAgICAgICAgICBvbkNsaWNrKGV2ZW50LCBub2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vbkRvdWJsZUNsaWNrID0gKGV2ZW50LCBub2RlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IG9uRG91YmxlQ2xpY2ssIGV4cGFuZEFjdGlvbiB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIC8vIEV4cGFuZCB0aGUgdHJlZVxuICAgICAgICAgICAgaWYgKGV4cGFuZEFjdGlvbiA9PT0gJ2RvdWJsZUNsaWNrJykge1xuICAgICAgICAgICAgICAgIHRoaXMub25EZWJvdW5jZUV4cGFuZChldmVudCwgbm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob25Eb3VibGVDbGljaykge1xuICAgICAgICAgICAgICAgIG9uRG91YmxlQ2xpY2soZXZlbnQsIG5vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLm9uU2VsZWN0ID0gKGtleXMsIGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IG9uU2VsZWN0LCBtdWx0aXBsZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGNvbnN0IHsgZXhwYW5kZWRLZXlzID0gW10gfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgICAgICBjb25zdCB7IG5vZGUsIG5hdGl2ZUV2ZW50IH0gPSBldmVudDtcbiAgICAgICAgICAgIGNvbnN0IHsga2V5ID0gJycgfSA9IG5vZGU7XG4gICAgICAgICAgICBjb25zdCB0cmVlRGF0YSA9IGdldFRyZWVEYXRhKHRoaXMucHJvcHMpO1xuICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSB7fTtcbiAgICAgICAgICAgIC8vIFdlIG5lZWQgd3JhcCB0aGlzIGV2ZW50IHNpbmNlIHNvbWUgdmFsdWUgaXMgbm90IHNhbWVcbiAgICAgICAgICAgIGNvbnN0IG5ld0V2ZW50ID0ge1xuICAgICAgICAgICAgICAgIC4uLmV2ZW50LFxuICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIFdpbmRvd3MgLyBNYWMgc2luZ2xlIHBpY2tcbiAgICAgICAgICAgIGNvbnN0IGN0cmxQaWNrID0gbmF0aXZlRXZlbnQuY3RybEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5O1xuICAgICAgICAgICAgY29uc3Qgc2hpZnRQaWNrID0gbmF0aXZlRXZlbnQuc2hpZnRLZXk7XG4gICAgICAgICAgICAvLyBHZW5lcmF0ZSBuZXcgc2VsZWN0ZWQga2V5c1xuICAgICAgICAgICAgbGV0IG5ld1NlbGVjdGVkS2V5cztcbiAgICAgICAgICAgIGlmIChtdWx0aXBsZSAmJiBjdHJsUGljaykge1xuICAgICAgICAgICAgICAgIC8vIENvbnRyb2wgY2xpY2tcbiAgICAgICAgICAgICAgICBuZXdTZWxlY3RlZEtleXMgPSBrZXlzO1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNlbGVjdGVkS2V5ID0ga2V5O1xuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVkU2VsZWN0ZWRLZXlzID0gbmV3U2VsZWN0ZWRLZXlzO1xuICAgICAgICAgICAgICAgIG5ld0V2ZW50LnNlbGVjdGVkTm9kZXMgPSBjb252ZXJ0RGlyZWN0b3J5S2V5c1RvTm9kZXModHJlZURhdGEsIG5ld1NlbGVjdGVkS2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChtdWx0aXBsZSAmJiBzaGlmdFBpY2spIHtcbiAgICAgICAgICAgICAgICAvLyBTaGlmdCBjbGlja1xuICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkS2V5cyA9IEFycmF5LmZyb20obmV3IFNldChbXG4gICAgICAgICAgICAgICAgICAgIC4uLih0aGlzLmNhY2hlZFNlbGVjdGVkS2V5cyB8fCBbXSksXG4gICAgICAgICAgICAgICAgICAgIC4uLmNhbGNSYW5nZUtleXModHJlZURhdGEsIGV4cGFuZGVkS2V5cywga2V5LCB0aGlzLmxhc3RTZWxlY3RlZEtleSksXG4gICAgICAgICAgICAgICAgXSkpO1xuICAgICAgICAgICAgICAgIG5ld0V2ZW50LnNlbGVjdGVkTm9kZXMgPSBjb252ZXJ0RGlyZWN0b3J5S2V5c1RvTm9kZXModHJlZURhdGEsIG5ld1NlbGVjdGVkS2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBTaW5nbGUgY2xpY2tcbiAgICAgICAgICAgICAgICBuZXdTZWxlY3RlZEtleXMgPSBba2V5XTtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RTZWxlY3RlZEtleSA9IGtleTtcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlZFNlbGVjdGVkS2V5cyA9IG5ld1NlbGVjdGVkS2V5cztcbiAgICAgICAgICAgICAgICBuZXdFdmVudC5zZWxlY3RlZE5vZGVzID0gY29udmVydERpcmVjdG9yeUtleXNUb05vZGVzKHRyZWVEYXRhLCBuZXdTZWxlY3RlZEtleXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3U3RhdGUuc2VsZWN0ZWRLZXlzID0gbmV3U2VsZWN0ZWRLZXlzO1xuICAgICAgICAgICAgaWYgKG9uU2VsZWN0KSB7XG4gICAgICAgICAgICAgICAgb25TZWxlY3QobmV3U2VsZWN0ZWRLZXlzLCBuZXdFdmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFVuY29udHJvbGxlZFN0YXRlKG5ld1N0YXRlKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zZXRUcmVlUmVmID0gKG5vZGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMudHJlZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhwYW5kRm9sZGVyTm9kZSA9IChldmVudCwgbm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBpc0xlYWYgfSA9IG5vZGU7XG4gICAgICAgICAgICBpZiAoaXNMZWFmIHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuY3RybEtleSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEdldCBpbnRlcm5hbCByYy10cmVlXG4gICAgICAgICAgICBjb25zdCBpbnRlcm5hbFRyZWUgPSB0aGlzLnRyZWUudHJlZTtcbiAgICAgICAgICAgIC8vIENhbGwgaW50ZXJuYWwgcmMtdHJlZSBleHBhbmQgZnVuY3Rpb25cbiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9DN24tZGVzaWduL0M3bi1kZXNpZ24vaXNzdWVzLzEyNTY3XG4gICAgICAgICAgICBpbnRlcm5hbFRyZWUub25Ob2RlRXhwYW5kKGV2ZW50LCBub2RlKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zZXRVbmNvbnRyb2xsZWRTdGF0ZSA9IChzdGF0ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSBvbWl0KHN0YXRlLCBPYmplY3Qua2V5cyh0aGlzLnByb3BzKSk7XG4gICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMobmV3U3RhdGUpLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJlbmRlckRpcmVjdG9yeVRyZWUgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgICAgICBjb25zdCB7IGV4cGFuZGVkS2V5cywgc2VsZWN0ZWRLZXlzIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICAgICAgY29uc3QgcHJlZml4Q2xzID0gdGhpcy5nZXRQcmVmaXhDbHMoKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbm5lY3RDbGFzc05hbWUgPSBjbGFzc05hbWVzKGAke3ByZWZpeENsc30tZGlyZWN0b3J5YCwgY2xhc3NOYW1lLCB7XG4gICAgICAgICAgICAgICAgW2Ake3ByZWZpeENsc30tZGlyZWN0b3J5LXJ0bGBdOiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gKFJlYWN0LmNyZWF0ZUVsZW1lbnQoVHJlZSwgT2JqZWN0LmFzc2lnbih7IGljb246IGdldEljb24sIHJlZjogdGhpcy5zZXRUcmVlUmVmLCBibG9ja05vZGU6IHRydWUgfSwgcHJvcHMsIHsgcHJlZml4Q2xzOiBwcmVmaXhDbHMsIGNsYXNzTmFtZTogY29ubmVjdENsYXNzTmFtZSwgZXhwYW5kZWRLZXlzOiBleHBhbmRlZEtleXMsIHNlbGVjdGVkS2V5czogc2VsZWN0ZWRLZXlzLCBvblNlbGVjdDogdGhpcy5vblNlbGVjdCwgb25DbGljazogdGhpcy5vbkNsaWNrLCBvbkRvdWJsZUNsaWNrOiB0aGlzLm9uRG91YmxlQ2xpY2ssIG9uRXhwYW5kOiB0aGlzLm9uRXhwYW5kIH0pKSk7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHsgZGVmYXVsdEV4cGFuZEFsbCwgZGVmYXVsdEV4cGFuZFBhcmVudCwgZXhwYW5kZWRLZXlzLCBkZWZhdWx0RXhwYW5kZWRLZXlzIH0gPSBwcm9wcztcbiAgICAgICAgY29uc3QgeyBrZXlFbnRpdGllcyB9ID0gY29udmVydERhdGFUb0VudGl0aWVzKGdldFRyZWVEYXRhKHByb3BzKSk7XG4gICAgICAgIC8vIFNlbGVjdGVkIGtleXNcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIHNlbGVjdGVkS2V5czogcHJvcHMuc2VsZWN0ZWRLZXlzIHx8IHByb3BzLmRlZmF1bHRTZWxlY3RlZEtleXMgfHwgW10sXG4gICAgICAgIH07XG4gICAgICAgIC8vIEV4cGFuZGVkIGtleXNcbiAgICAgICAgaWYgKGRlZmF1bHRFeHBhbmRBbGwpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXhwYW5kZWRLZXlzID0gT2JqZWN0LmtleXMoa2V5RW50aXRpZXMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGRlZmF1bHRFeHBhbmRQYXJlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXhwYW5kZWRLZXlzID0gY29uZHVjdEV4cGFuZFBhcmVudChleHBhbmRlZEtleXMgfHwgZGVmYXVsdEV4cGFuZGVkS2V5cyB8fCBbXSwga2V5RW50aXRpZXMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5leHBhbmRlZEtleXMgPSBleHBhbmRlZEtleXMgfHwgZGVmYXVsdEV4cGFuZGVkS2V5cztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9uRGVib3VuY2VFeHBhbmQgPSBkZWJvdW5jZSh0aGlzLmV4cGFuZEZvbGRlck5vZGUsIDIwMCwge1xuICAgICAgICAgICAgbGVhZGluZzogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzKSB7XG4gICAgICAgIGNvbnN0IG5ld1N0YXRlID0ge307XG4gICAgICAgIGlmICgnZXhwYW5kZWRLZXlzJyBpbiBuZXh0UHJvcHMpIHtcbiAgICAgICAgICAgIG5ld1N0YXRlLmV4cGFuZGVkS2V5cyA9IG5leHRQcm9wcy5leHBhbmRlZEtleXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCdzZWxlY3RlZEtleXMnIGluIG5leHRQcm9wcykge1xuICAgICAgICAgICAgbmV3U3RhdGUuc2VsZWN0ZWRLZXlzID0gbmV4dFByb3BzLnNlbGVjdGVkS2V5cztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3U3RhdGU7XG4gICAgfVxuICAgIGdldFByZWZpeENscygpIHtcbiAgICAgICAgY29uc3QgeyBwcmVmaXhDbHMgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIHJldHVybiBnZXRQcmVmaXhDbHMoJ3RyZWUnLCBwcmVmaXhDbHMpO1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlbmRlckRpcmVjdG9yeVRyZWUoKTtcbiAgICB9XG59XG5EaXJlY3RvcnlUcmVlLmRlZmF1bHRQcm9wcyA9IHtcbiAgICBzaG93SWNvbjogdHJ1ZSxcbiAgICBleHBhbmRBY3Rpb246ICdjbGljaycsXG59O1xuZXhwb3J0IGRlZmF1bHQgRGlyZWN0b3J5VHJlZTtcbiJdfQ==