20d54a8742053fbd3a867e99e3c4799e
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _classnames = _interopRequireDefault(require("classnames"));

var _request = _interopRequireDefault(require("./request"));

var _uid = _interopRequireDefault(require("./uid"));

var _attrAccept = _interopRequireDefault(require("./attr-accept"));

function _createSuper(Derived) {
  function isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  return function () {
    var Super = (0, _getPrototypeOf2["default"])(Derived),
        result;

    if (isNativeReflectConstruct()) {
      var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor;
      result = Reflect.construct(Super, arguments, NewTarget);
    } else {
      result = Super.apply(this, arguments);
    }

    return (0, _possibleConstructorReturn2["default"])(this, result);
  };
}

var AjaxUploader =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(AjaxUploader, _Component);

  var _super = _createSuper(AjaxUploader);

  function AjaxUploader() {
    var _this;

    (0, _classCallCheck2["default"])(this, AjaxUploader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      uid: (0, _uid["default"])()
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "reqs", {});
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onChange", function (e) {
      var files = e.target.files;

      _this.uploadFiles(files);

      _this.reset();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onClick", function () {
      var el = _this.fileInput;

      if (!el) {
        return;
      }

      el.click();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onKeyDown", function (e) {
      if (e.key === 'Enter') {
        _this.onClick();
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onFileDrop", function (e) {
      if (e.type === 'dragover') {
        e.preventDefault();
        return;
      }

      var files = Array.prototype.slice.call(e.dataTransfer.files).filter(function (file) {
        return (0, _attrAccept["default"])(file, _this.props.accept);
      });

      _this.uploadFiles(files);

      e.preventDefault();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "saveFileInput", function (node) {
      _this.fileInput = node;
    });
    return _this;
  }

  (0, _createClass2["default"])(AjaxUploader, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this._isMounted = true;
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this._isMounted = false;
      this.abort();
    }
  }, {
    key: "uploadFiles",
    value: function uploadFiles(files) {
      var _this2 = this;

      var postFiles = Array.prototype.slice.call(files);
      postFiles.forEach(function (file) {
        file.uid = (0, _uid["default"])();

        _this2.upload(file, postFiles);
      });
    }
  }, {
    key: "upload",
    value: function upload(file, fileList) {
      var _this3 = this;

      var props = this.props;

      if (!props.beforeUpload) {
        // always async in case use react state to keep fileList
        return setTimeout(function () {
          return _this3.post(file);
        }, 0);
      }

      var before = props.beforeUpload(file, fileList);

      if (before && before.then) {
        before.then(function (processedFile) {
          var processedFileType = Object.prototype.toString.call(processedFile);

          if (processedFileType === '[object File]' || processedFileType === '[object Blob]') {
            _this3.post(processedFile);
          } else {
            _this3.post(file);
          }
        })["catch"](function (e) {
          console && console.log(e); // eslint-disable-line
        });
      } else if (before !== false) {
        setTimeout(function () {
          return _this3.post(file);
        }, 0);
      }
    }
  }, {
    key: "post",
    value: function post(file) {
      var _this4 = this;

      var requestFileKeys = this.props.requestFileKeys;

      if (!this._isMounted) {
        return;
      }

      var props = this.props;
      var data = props.data;
      var onStart = props.onStart,
          onProgress = props.onProgress;

      if (typeof data === 'function') {
        data = data(file);
      }

      var uid = file.uid;
      var request = props.customRequest || _request["default"];
      this.reqs[uid] = request({
        action: props.action,
        filename: props.name,
        file: file,
        data: data,
        requestFileKeys: requestFileKeys,
        // 判断传递的是数据不是文件
        headers: props.headers,
        withCredentials: props.withCredentials,
        onProgress: onProgress ? function (e) {
          onProgress(e, file);
        } : null,
        onSuccess: function onSuccess(ret, xhr) {
          delete _this4.reqs[uid];
          props.onSuccess(ret, file, xhr);
        },
        onError: function onError(err, ret) {
          delete _this4.reqs[uid];
          props.onError(err, ret, file);
        }
      });
      onStart(file);
    }
  }, {
    key: "reset",
    value: function reset() {
      this.setState({
        uid: (0, _uid["default"])()
      });
    }
  }, {
    key: "abort",
    value: function abort(file) {
      var reqs = this.reqs;

      if (file) {
        var uid = file;

        if (file && file.uid) {
          uid = file.uid;
        }

        if (reqs[uid]) {
          reqs[uid].abort();
          delete reqs[uid];
        }
      } else {
        Object.keys(reqs).forEach(function (uid) {
          if (reqs[uid]) {
            reqs[uid].abort();
          }

          delete reqs[uid];
        });
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _classNames;

      var _this$props = this.props,
          Tag = _this$props.component,
          prefixCls = _this$props.prefixCls,
          className = _this$props.className,
          disabled = _this$props.disabled,
          style = _this$props.style,
          multiple = _this$props.multiple,
          accept = _this$props.accept,
          children = _this$props.children;
      var cls = (0, _classnames["default"])((_classNames = {}, (0, _defineProperty2["default"])(_classNames, prefixCls, true), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-disabled"), disabled), (0, _defineProperty2["default"])(_classNames, className, className), _classNames));
      var events = disabled ? {} : {
        onClick: this.onClick,
        onKeyDown: this.onKeyDown,
        onDrop: this.onFileDrop,
        onDragOver: this.onFileDrop,
        tabIndex: '0'
      };
      return _react["default"].createElement(Tag, (0, _extends2["default"])({}, events, {
        className: cls,
        role: "button",
        style: style
      }), _react["default"].createElement("input", {
        type: "file",
        ref: this.saveFileInput,
        key: this.state.uid,
        style: {
          display: 'none'
        },
        accept: accept,
        multiple: multiple,
        onChange: this.onChange
      }), children);
    }
  }]);
  return AjaxUploader;
}(_react.Component);

(0, _defineProperty2["default"])(AjaxUploader, "propTypes", {
  component: _propTypes["default"].string,
  style: _propTypes["default"].object,
  prefixCls: _propTypes["default"].string,
  className: _propTypes["default"].string,
  multiple: _propTypes["default"].bool,
  disabled: _propTypes["default"].bool,
  accept: _propTypes["default"].string,
  children: _propTypes["default"].any,
  onStart: _propTypes["default"].func,
  data: _propTypes["default"].oneOfType([_propTypes["default"].object, _propTypes["default"].func]),
  headers: _propTypes["default"].object,
  beforeUpload: _propTypes["default"].func,
  customRequest: _propTypes["default"].func,
  onProgress: _propTypes["default"].func,
  withCredentials: _propTypes["default"].bool
});
var _default = AjaxUploader;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFqYXhVcGxvYWRlci5qc3giXSwibmFtZXMiOlsiQWpheFVwbG9hZGVyIiwidWlkIiwiZSIsImZpbGVzIiwidGFyZ2V0IiwidXBsb2FkRmlsZXMiLCJyZXNldCIsImVsIiwiZmlsZUlucHV0IiwiY2xpY2siLCJrZXkiLCJvbkNsaWNrIiwidHlwZSIsInByZXZlbnREZWZhdWx0IiwiQXJyYXkiLCJwcm90b3R5cGUiLCJzbGljZSIsImNhbGwiLCJkYXRhVHJhbnNmZXIiLCJmaWx0ZXIiLCJmaWxlIiwicHJvcHMiLCJhY2NlcHQiLCJub2RlIiwiX2lzTW91bnRlZCIsImFib3J0IiwicG9zdEZpbGVzIiwiZm9yRWFjaCIsInVwbG9hZCIsImZpbGVMaXN0IiwiYmVmb3JlVXBsb2FkIiwic2V0VGltZW91dCIsInBvc3QiLCJiZWZvcmUiLCJ0aGVuIiwicHJvY2Vzc2VkRmlsZSIsInByb2Nlc3NlZEZpbGVUeXBlIiwiT2JqZWN0IiwidG9TdHJpbmciLCJjb25zb2xlIiwibG9nIiwicmVxdWVzdEZpbGVLZXlzIiwiZGF0YSIsIm9uU3RhcnQiLCJvblByb2dyZXNzIiwicmVxdWVzdCIsImN1c3RvbVJlcXVlc3QiLCJkZWZhdWx0UmVxdWVzdCIsInJlcXMiLCJhY3Rpb24iLCJmaWxlbmFtZSIsIm5hbWUiLCJoZWFkZXJzIiwid2l0aENyZWRlbnRpYWxzIiwib25TdWNjZXNzIiwicmV0IiwieGhyIiwib25FcnJvciIsImVyciIsInNldFN0YXRlIiwia2V5cyIsIlRhZyIsImNvbXBvbmVudCIsInByZWZpeENscyIsImNsYXNzTmFtZSIsImRpc2FibGVkIiwic3R5bGUiLCJtdWx0aXBsZSIsImNoaWxkcmVuIiwiY2xzIiwiZXZlbnRzIiwib25LZXlEb3duIiwib25Ecm9wIiwib25GaWxlRHJvcCIsIm9uRHJhZ092ZXIiLCJ0YWJJbmRleCIsInNhdmVGaWxlSW5wdXQiLCJzdGF0ZSIsImRpc3BsYXkiLCJvbkNoYW5nZSIsIkNvbXBvbmVudCIsIlByb3BUeXBlcyIsInN0cmlu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O0FBT2pCOUQsRUFBQUEsTUFBTSxFQUFFMkQsc0JBQVVDLE1BUEQ7QUFRakJkLEVBQUFBLFFBQVEsRUFBRWEsc0JBQVVJLEdBUkg7QUFTakIxQyxFQUFBQSxPQUFPLEVBQUVzQyxzQkFBVUssSUFURjtBQVVqQjVDLEVBQUFBLElBQUksRUFBRXVDLHNCQUFVTSxTQUFWLENBQW9CLENBQ3hCTixzQkFBVUUsTUFEYyxFQUV4QkYsc0JBQVVLLElBRmMsQ0FBcEIsQ0FWVztBQWNqQmxDLEVBQUFBLE9BQU8sRUFBRTZCLHNCQUFVRSxNQWRGO0FBZWpCckQsRUFBQUEsWUFBWSxFQUFFbUQsc0JBQVVLLElBZlA7QUFnQmpCeEMsRUFBQUEsYUFBYSxFQUFFbUMsc0JBQVVLLElBaEJSO0FBaUJqQjFDLEVBQUFBLFVBQVUsRUFBRXFDLHNCQUFVSyxJQWpCTDtBQWtCakJqQyxFQUFBQSxlQUFlLEVBQUU0QixzQkFBVUc7QUFsQlYsQztlQThNTnBGLFkiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgcmVhY3Qvbm8taXMtbW91bnRlZDowIHJlYWN0L3NvcnQtY29tcDowICovXG5cbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgZGVmYXVsdFJlcXVlc3QgZnJvbSAnLi9yZXF1ZXN0JztcbmltcG9ydCBnZXRVaWQgZnJvbSAnLi91aWQnO1xuaW1wb3J0IGF0dHJBY2NlcHQgZnJvbSAnLi9hdHRyLWFjY2VwdCc7XG5cbmNsYXNzIEFqYXhVcGxvYWRlciBleHRlbmRzIENvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgY29tcG9uZW50OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIHN0eWxlOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIHByZWZpeENsczogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgbXVsdGlwbGU6IFByb3BUeXBlcy5ib29sLFxuICAgIGRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBhY2NlcHQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgY2hpbGRyZW46IFByb3BUeXBlcy5hbnksXG4gICAgb25TdGFydDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgZGF0YTogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICBQcm9wVHlwZXMub2JqZWN0LFxuICAgICAgUHJvcFR5cGVzLmZ1bmMsXG4gICAgXSksXG4gICAgaGVhZGVyczogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBiZWZvcmVVcGxvYWQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIGN1c3RvbVJlcXVlc3Q6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uUHJvZ3Jlc3M6IFByb3BUeXBlcy5mdW5jLFxuICAgIHdpdGhDcmVkZW50aWFsczogUHJvcFR5cGVzLmJvb2wsXG4gIH1cblxuICBzdGF0ZSA9IHsgdWlkOiBnZXRVaWQoKSB9XG5cbiAgcmVxcyA9IHt9XG5cbiAgb25DaGFuZ2UgPSBlID0+IHtcbiAgICBjb25zdCBmaWxlcyA9IGUudGFyZ2V0LmZpbGVzO1xuICAgIHRoaXMudXBsb2FkRmlsZXMoZmlsZXMpO1xuICAgIHRoaXMucmVzZXQoKTtcbiAgfVxuXG4gIG9uQ2xpY2sgPSAoKSA9PiB7XG4gICAgY29uc3QgZWwgPSB0aGlzLmZpbGVJbnB1dDtcbiAgICBpZiAoIWVsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGVsLmNsaWNrKCk7XG4gIH1cblxuICBvbktleURvd24gPSBlID0+IHtcbiAgICBpZiAoZS5rZXkgPT09ICdFbnRlcicpIHtcbiAgICAgIHRoaXMub25DbGljaygpO1xuICAgIH1cbiAgfVxuXG4gIG9uRmlsZURyb3AgPSBlID0+IHtcbiAgICBpZiAoZS50eXBlID09PSAnZHJhZ292ZXInKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGZpbGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZS5kYXRhVHJhbnNmZXIuZmlsZXMpLmZpbHRlcihcbiAgICAgIGZpbGUgPT4gYXR0ckFjY2VwdChmaWxlLCB0aGlzLnByb3BzLmFjY2VwdClcbiAgICApO1xuICAgIHRoaXMudXBsb2FkRmlsZXMoZmlsZXMpO1xuXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5faXNNb3VudGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHRoaXMuX2lzTW91bnRlZCA9IGZhbHNlO1xuICAgIHRoaXMuYWJvcnQoKTtcbiAgfVxuXG4gIHVwbG9hZEZpbGVzKGZpbGVzKSB7XG4gICAgY29uc3QgcG9zdEZpbGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZmlsZXMpO1xuICAgIHBvc3RGaWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgICBmaWxlLnVpZCA9IGdldFVpZCgpO1xuICAgICAgdGhpcy51cGxvYWQoZmlsZSwgcG9zdEZpbGVzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHVwbG9hZChmaWxlLCBmaWxlTGlzdCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgaWYgKCFwcm9wcy5iZWZvcmVVcGxvYWQpIHtcbiAgICAgIC8vIGFsd2F5cyBhc3luYyBpbiBjYXNlIHVzZSByZWFjdCBzdGF0ZSB0byBrZWVwIGZpbGVMaXN0XG4gICAgICByZXR1cm4gc2V0VGltZW91dCgoKSA9PiB0aGlzLnBvc3QoZmlsZSksIDApO1xuICAgIH1cblxuICAgIGNvbnN0IGJlZm9yZSA9IHByb3BzLmJlZm9yZVVwbG9hZChmaWxlLCBmaWxlTGlzdCk7XG4gICAgaWYgKGJlZm9yZSAmJiBiZWZvcmUudGhlbikge1xuICAgICAgYmVmb3JlLnRoZW4oKHByb2Nlc3NlZEZpbGUpID0+IHtcbiAgICAgICAgY29uc3QgcHJvY2Vzc2VkRmlsZVR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocHJvY2Vzc2VkRmlsZSk7XG4gICAgICAgIGlmIChwcm9jZXNzZWRGaWxlVHlwZSA9PT0gJ1tvYmplY3QgRmlsZV0nIHx8IHByb2Nlc3NlZEZpbGVUeXBlID09PSAnW29iamVjdCBCbG9iXScpIHtcbiAgICAgICAgICB0aGlzLnBvc3QocHJvY2Vzc2VkRmlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wb3N0KGZpbGUpO1xuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgICAgY29uc29sZSAmJiBjb25zb2xlLmxvZyhlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChiZWZvcmUgIT09IGZhbHNlKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucG9zdChmaWxlKSwgMCk7XG4gICAgfVxuICB9XG5cbiAgcG9zdChmaWxlKSB7XG4gICAgY29uc3QgeyByZXF1ZXN0RmlsZUtleXMgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCF0aGlzLl9pc01vdW50ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBsZXQgeyBkYXRhIH0gPSBwcm9wcztcbiAgICBjb25zdCB7IG9uU3RhcnQsIG9uUHJvZ3Jlc3MgfSA9IHByb3BzO1xuICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgZGF0YSA9IGRhdGEoZmlsZSk7XG4gICAgfVxuICAgIGNvbnN0IHsgdWlkIH0gPSBmaWxlO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBwcm9wcy5jdXN0b21SZXF1ZXN0IHx8IGRlZmF1bHRSZXF1ZXN0O1xuICAgIHRoaXMucmVxc1t1aWRdID0gcmVxdWVzdCh7XG4gICAgICBhY3Rpb246IHByb3BzLmFjdGlvbixcbiAgICAgIGZpbGVuYW1lOiBwcm9wcy5uYW1lLFxuICAgICAgZmlsZSxcbiAgICAgIGRhdGEsXG4gICAgICByZXF1ZXN0RmlsZUtleXMsIC8vIOWIpOaWreS8oOmAkueahOaYr+aVsOaNruS4jeaYr+aWh+S7tlxuICAgICAgaGVhZGVyczogcHJvcHMuaGVhZGVycyxcbiAgICAgIHdpdGhDcmVkZW50aWFsczogcHJvcHMud2l0aENyZWRlbnRpYWxzLFxuICAgICAgb25Qcm9ncmVzczogb25Qcm9ncmVzcyA/IGUgPT4ge1xuICAgICAgICBvblByb2dyZXNzKGUsIGZpbGUpO1xuICAgICAgfSA6IG51bGwsXG4gICAgICBvblN1Y2Nlc3M6IChyZXQsIHhocikgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy5yZXFzW3VpZF07XG4gICAgICAgIHByb3BzLm9uU3VjY2VzcyhyZXQsIGZpbGUsIHhocik7XG4gICAgICB9LFxuICAgICAgb25FcnJvcjogKGVyciwgcmV0KSA9PiB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLnJlcXNbdWlkXTtcbiAgICAgICAgcHJvcHMub25FcnJvcihlcnIsIHJldCwgZmlsZSk7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIG9uU3RhcnQoZmlsZSk7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHVpZDogZ2V0VWlkKCksXG4gICAgfSk7XG4gIH1cblxuICBhYm9ydChmaWxlKSB7XG4gICAgY29uc3QgeyByZXFzIH0gPSB0aGlzO1xuICAgIGlmIChmaWxlKSB7XG4gICAgICBsZXQgdWlkID0gZmlsZTtcbiAgICAgIGlmIChmaWxlICYmIGZpbGUudWlkKSB7XG4gICAgICAgIHVpZCA9IGZpbGUudWlkO1xuICAgICAgfVxuICAgICAgaWYgKHJlcXNbdWlkXSkge1xuICAgICAgICByZXFzW3VpZF0uYWJvcnQoKTtcbiAgICAgICAgZGVsZXRlIHJlcXNbdWlkXTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmtleXMocmVxcykuZm9yRWFjaCgodWlkKSA9PiB7XG4gICAgICAgIGlmIChyZXFzW3VpZF0pIHtcbiAgICAgICAgICByZXFzW3VpZF0uYWJvcnQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSByZXFzW3VpZF07XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzYXZlRmlsZUlucHV0ID0gKG5vZGUpID0+IHtcbiAgICB0aGlzLmZpbGVJbnB1dCA9IG5vZGU7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY29tcG9uZW50OiBUYWcsIHByZWZpeENscywgY2xhc3NOYW1lLCBkaXNhYmxlZCxcbiAgICAgIHN0eWxlLCBtdWx0aXBsZSwgYWNjZXB0LCBjaGlsZHJlbixcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBjbHMgPSBjbGFzc05hbWVzKHtcbiAgICAgIFtwcmVmaXhDbHNdOiB0cnVlLFxuICAgICAgW2Ake3ByZWZpeENsc30tZGlzYWJsZWRgXTogZGlzYWJsZWQsXG4gICAgICBbY2xhc3NOYW1lXTogY2xhc3NOYW1lLFxuICAgIH0pO1xuICAgIGNvbnN0IGV2ZW50cyA9IGRpc2FibGVkID8ge30gOiB7XG4gICAgICBvbkNsaWNrOiB0aGlzLm9uQ2xpY2ssXG4gICAgICBvbktleURvd246IHRoaXMub25LZXlEb3duLFxuICAgICAgb25Ecm9wOiB0aGlzLm9uRmlsZURyb3AsXG4gICAgICBvbkRyYWdPdmVyOiB0aGlzLm9uRmlsZURyb3AsXG4gICAgICB0YWJJbmRleDogJzAnLFxuICAgIH07XG4gICAgcmV0dXJuIChcbiAgICAgIDxUYWdcbiAgICAgICAgey4uLmV2ZW50c31cbiAgICAgICAgY2xhc3NOYW1lPXtjbHN9XG4gICAgICAgIHJvbGU9XCJidXR0b25cIlxuICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICA+XG4gICAgICAgIDxpbnB1dFxuICAgICAgICAgIHR5cGU9XCJmaWxlXCJcbiAgICAgICAgICByZWY9e3RoaXMuc2F2ZUZpbGVJbnB1dH1cbiAgICAgICAgICBrZXk9e3RoaXMuc3RhdGUudWlkfVxuICAgICAgICAgIHN0eWxlPXt7IGRpc3BsYXk6ICdub25lJyB9fVxuICAgICAgICAgIGFjY2VwdD17YWNjZXB0fVxuICAgICAgICAgIG11bHRpcGxlPXttdWx0aXBsZX1cbiAgICAgICAgICBvbkNoYW5nZT17dGhpcy5vbkNoYW5nZX1cbiAgICAgICAgLz5cbiAgICAgICAge2NoaWxkcmVufVxuICAgICAgPC9UYWc+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBamF4VXBsb2FkZXI7XG4iXX0=