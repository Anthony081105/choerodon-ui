955456d465e887d98066a66fd2e6b5c1
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getScroll = getScroll;
exports["default"] = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _utils = require("./utils");

var _react = _interopRequireDefault(require("react"));

var _classnames2 = _interopRequireDefault(require("classnames"));

var isDev = process.env.NODE_ENV !== 'production';

function getScroll(w, top) {
  var ret = w["page".concat(top ? 'Y' : 'X', "Offset")];
  var method = "scroll".concat(top ? 'Top' : 'Left');

  if (typeof ret !== 'number') {
    var d = w.document; // ie6,7,8 standard mode

    ret = d.documentElement[method];

    if (typeof ret !== 'number') {
      // quirks mode
      ret = d.body[method];
    }
  }

  return ret;
}

function offset(elem) {
  var box;
  var x;
  var y;
  var doc = elem.ownerDocument;
  var body = doc.body;
  var docElem = doc && doc.documentElement;
  box = elem.getBoundingClientRect();
  x = box.left;
  y = box.top;
  x -= docElem.clientLeft || body.clientLeft || 0;
  y -= docElem.clientTop || body.clientTop || 0;
  var w = doc.defaultView || doc.parentWindow;
  x += getScroll(w);
  y += getScroll(w, true);
  return {
    left: x,
    top: y
  };
}

function _componentDidUpdate(component, init) {
  var styles = component.props.styles;
  var rootNode = component.root;
  var wrapNode = component.nav || rootNode;
  var inkBarNode = component.inkBar;
  var activeTab = component.activeTab;
  var inkBarNodeStyle = inkBarNode.style;
  var tabBarPosition = component.props.tabBarPosition;

  if (init) {
    // prevent mount animation
    inkBarNodeStyle.display = 'none';
  }

  if (activeTab) {
    var tabNode = activeTab;
    var transformSupported = (0, _utils.isTransformSupported)(inkBarNodeStyle);

    if (tabBarPosition === 'top' || tabBarPosition === 'bottom') {
      var left = (0, _utils.getLeft)(tabNode, wrapNode);
      var width = tabNode.offsetWidth; // If tabNode'width width equal to wrapNode'width when tabBarPosition is top or bottom
      // It means no css working, then ink bar should not have width until css is loaded

      if (width === rootNode.offsetWidth) {
        width = 0;
      } else if (styles.inkBar && styles.inkBar.width !== undefined) {
        width = parseFloat(styles.inkBar.width, 10);

        if (width) {
          left = left + (tabNode.offsetWidth - width) / 2;
        }
      } // use 3d gpu to optimize render


      if (transformSupported) {
        (0, _utils.setTransform)(inkBarNodeStyle, "translate3d(".concat(left, "px,0,0)"));
        inkBarNodeStyle.width = "".concat(width, "px");
        inkBarNodeStyle.height = '';
      } else {
        inkBarNodeStyle.left = "".concat(left, "px");
        inkBarNodeStyle.top = '';
        inkBarNodeStyle.bottom = '';
        inkBarNodeStyle.right = "".concat(wrapNode.offsetWidth - left - width, "px");
      }
    } else {
      var top = (0, _utils.getTop)(tabNode, wrapNode);
      var height = tabNode.offsetHeight;

      if (styles.inkBar && styles.inkBar.height !== undefined) {
        height = parseFloat(styles.inkBar.height, 10);

        if (height) {
          top = top + (tabNode.offsetHeight - height) / 2;
        }
      }

      if (transformSupported) {
        (0, _utils.setTransform)(inkBarNodeStyle, "translate3d(0,".concat(top, "px,0)"));
        inkBarNodeStyle.height = "".concat(height, "px");
        inkBarNodeStyle.width = '';
      } else {
        inkBarNodeStyle.left = '';
        inkBarNodeStyle.right = '';
        inkBarNodeStyle.top = "".concat(top, "px");
        inkBarNodeStyle.bottom = "".concat(wrapNode.offsetHeight - top - height, "px");
      }
    }
  }

  inkBarNodeStyle.display = activeTab ? 'block' : 'none';
}

var _default = {
  getDefaultProps: function getDefaultProps() {
    return {
      inkBarAnimated: true
    };
  },
  componentDidUpdate: function componentDidUpdate() {
    _componentDidUpdate(this);
  },
  componentDidMount: function componentDidMount() {
    var _this = this;

    if (isDev) {
      this.timeout = setTimeout(function () {
        _componentDidUpdate(_this, true);
      }, 0);
    } else {
      _componentDidUpdate(this, true);
    }
  },
  componentWillUnmount: function componentWillUnmount() {
    clearTimeout(this.timeout);
  },
  getInkBarNode: function getInkBarNode() {
    var _classnames;

    var _this$props = this.props,
        prefixCls = _this$props.prefixCls,
        styles = _this$props.styles,
        inkBarAnimated = _this$props.inkBarAnimated;
    var className = "".concat(prefixCls, "-ink-bar");
    var classes = (0, _classnames2["default"])((_classnames = {}, (0, _defineProperty2["default"])(_classnames, className, true), (0, _defineProperty2["default"])(_classnames, inkBarAnimated ? "".concat(className, "-animated") : "".concat(className, "-no-animated"), true), _classnames));
    return _react["default"].createElement("div", {
      style: styles.inkBar,
      className: classes,
      key: "inkBar",
      ref: this.saveRef('inkBar')
    });
  }
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRhYnMvSW5rVGFiQmFyTWl4aW4uanN4Il0sIm5hbWVzIjpbImlzRGV2IiwicHJvY2VzcyIsInJldCIsInciLCJ0b3AiLCJtZXRob2QiLCJkIiwiZG9jIiwiZWxlbSIsImJvZHkiLCJkb2NFbGVtIiwiYm94IiwieCIsInkiLCJnZXRTY3JvbGwiLCJsZWZ0Iiwic3R5bGVzIiwiY29tcG9uZW50Iiwicm9vdE5vZGUiLCJ3cmFwTm9kZSIsImlua0Jhck5vZGUiLCJhY3RpdmVUYWIiLCJpbmtCYXJOb2RlU3R5bGUiLCJ0YWJCYXJQb3NpdGlvbiIsInRhYk5vZGUiLCJ0cmFuc2Zvcm1TdXBwb3J0ZWQiLCJ3aWR0aCIsInBhcnNlRmxvYXQiLCJoZWlnaHQiLCJnZXREZWZhdWx0UHJvcHMiLCJpbmtCYXJBbmltYXRlZCIsImNvbXBvbmVudERpZFVwZGF0ZSIsImNvbXBvbmVudERpZE1vdW50Iiwic2V0VGltZW91dCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiY2xlYXJUaW1lb3V0IiwiZ2V0SW5rQmFyTm9kZSIsInByZWZpeENscyIsImNsYXNzTmFtZSIsImNsYXNzZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLElBQUEsTUFBQSxHQUFBLE9BQUEsQ0FBQSxTQUFBLENBQUE7O0FBQ0EsSUFBQSxNQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsT0FBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxZQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7O0FBRUEsSUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQVBBLEdBQUFBLENBQUFBLFFBQUFBLEtBQWQsWUFBQTs7QUFFTyxTQUFBLFNBQUEsQ0FBQSxDQUFBLEVBQUEsR0FBQSxFQUEyQjtBQUNoQyxNQUFJQyxHQUFHLEdBQUdDLENBQUMsQ0FBQSxPQUFBLE1BQUEsQ0FBUUMsR0FBRyxHQUFBLEdBQUEsR0FBWCxHQUFBLEVBQVgsUUFBVyxDQUFBLENBQVg7QUFDQSxNQUFNQyxN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QSxHQUFBLFlBQUEsQ0FBQSxTQUFBLENBQUEsR0FBQSxXQUFBLEdBQUEsRUFBQSxFQUFBLENBQUEsR0FBQSxnQkFBQSxDQUFBLFNBQUEsQ0FBQSxFQUFBLFdBQUEsRUFBQSxTQUFBLEVBQUEsSUFBQSxDQUFBLEVBQUEsQ0FBQSxHQUFBLGdCQUFBLENBQUEsU0FBQSxDQUFBLEVBQUEsV0FBQSxFQUdaVCxjQUFjLEdBQUEsR0FBQSxNQUFBLENBQUEsU0FBQSxFQUFBLFdBQUEsQ0FBQSxHQUFBLEdBQUEsTUFBQSxDQUFBLFNBQUEsRUFIRixjQUdFLENBSEYsRUFBQSxJQUFBLENBQUEsRUFBaEIsV0FBZ0IsRUFBaEI7QUFRQSxXQUNFLE1BQUEsQ0FBQSxTQUFBLENBQUEsQ0FBQSxhQUFBLENBQUEsS0FBQSxFQUFBO0FBQ0UsTUFBQSxLQUFLLEVBQUVkLE1BQU0sQ0FEZixNQUFBO0FBRUUsTUFBQSxTQUFTLEVBRlgsT0FBQTtBQUdFLE1BQUEsR0FBRyxFQUhMLFFBQUE7QUFJRSxNQUFBLEdBQUcsRUFBRSxLQUFBLE9BQUEsQ0FBQSxRQUFBO0FBSlAsS0FBQSxDQURGO0FBUUQ7QUE1Q1ksQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzVHJhbnNmb3JtU3VwcG9ydGVkLCBzZXRUcmFuc2Zvcm0sZ2V0TGVmdCxnZXRUb3AgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcblxuY29uc3QgaXNEZXYgPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2Nyb2xsKHcsIHRvcCkge1xuICBsZXQgcmV0ID0gd1tgcGFnZSR7dG9wID8gJ1knIDogJ1gnfU9mZnNldGBdO1xuICBjb25zdCBtZXRob2QgPSBgc2Nyb2xsJHt0b3AgPyAnVG9wJyA6ICdMZWZ0J31gO1xuICBpZiAodHlwZW9mIHJldCAhPT0gJ251bWJlcicpIHtcbiAgICBjb25zdCBkID0gdy5kb2N1bWVudDtcbiAgICAvLyBpZTYsNyw4IHN0YW5kYXJkIG1vZGVcbiAgICByZXQgPSBkLmRvY3VtZW50RWxlbWVudFttZXRob2RdO1xuICAgIGlmICh0eXBlb2YgcmV0ICE9PSAnbnVtYmVyJykge1xuICAgICAgLy8gcXVpcmtzIG1vZGVcbiAgICAgIHJldCA9IGQuYm9keVttZXRob2RdO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmV0O1xufVxuXG5mdW5jdGlvbiBvZmZzZXQoZWxlbSkge1xuICBsZXQgYm94O1xuICBsZXQgeDtcbiAgbGV0IHk7XG4gIGNvbnN0IGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDtcbiAgY29uc3QgYm9keSA9IGRvYy5ib2R5O1xuICBjb25zdCBkb2NFbGVtID0gZG9jICYmIGRvYy5kb2N1bWVudEVsZW1lbnQ7XG4gIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIHggPSBib3gubGVmdDtcbiAgeSA9IGJveC50b3A7XG4gIHggLT0gZG9jRWxlbS5jbGllbnRMZWZ0IHx8IGJvZHkuY2xpZW50TGVmdCB8fCAwO1xuICB5IC09IGRvY0VsZW0uY2xpZW50VG9wIHx8IGJvZHkuY2xpZW50VG9wIHx8IDA7XG4gIGNvbnN0IHcgPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdztcbiAgeCArPSBnZXRTY3JvbGwodyk7XG4gIHkgKz0gZ2V0U2Nyb2xsKHcsIHRydWUpO1xuICByZXR1cm4ge1xuICAgIGxlZnQ6IHgsIHRvcDogeSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gY29tcG9uZW50RGlkVXBkYXRlKGNvbXBvbmVudCwgaW5pdCkge1xuICBjb25zdCB7IHN0eWxlcyB9ID0gY29tcG9uZW50LnByb3BzO1xuICBjb25zdCByb290Tm9kZSA9IGNvbXBvbmVudC5yb290O1xuICBjb25zdCB3cmFwTm9kZSA9IGNvbXBvbmVudC5uYXYgfHwgcm9vdE5vZGU7XG4gIGNvbnN0IGlua0Jhck5vZGUgPSBjb21wb25lbnQuaW5rQmFyO1xuICBjb25zdCBhY3RpdmVUYWIgPSBjb21wb25lbnQuYWN0aXZlVGFiO1xuICBjb25zdCBpbmtCYXJOb2RlU3R5bGUgPSBpbmtCYXJOb2RlLnN0eWxlO1xuICBjb25zdCB0YWJCYXJQb3NpdGlvbiA9IGNvbXBvbmVudC5wcm9wcy50YWJCYXJQb3NpdGlvbjtcbiAgaWYgKGluaXQpIHtcbiAgICAvLyBwcmV2ZW50IG1vdW50IGFuaW1hdGlvblxuICAgIGlua0Jhck5vZGVTdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICB9XG4gIGlmIChhY3RpdmVUYWIpIHtcbiAgICBjb25zdCB0YWJOb2RlID0gYWN0aXZlVGFiO1xuICAgIGNvbnN0IHRyYW5zZm9ybVN1cHBvcnRlZCA9IGlzVHJhbnNmb3JtU3VwcG9ydGVkKGlua0Jhck5vZGVTdHlsZSk7XG4gICAgaWYgKHRhYkJhclBvc2l0aW9uID09PSAndG9wJyB8fCB0YWJCYXJQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgIGxldCBsZWZ0ID0gZ2V0TGVmdCh0YWJOb2RlLCB3cmFwTm9kZSk7XG4gICAgICBsZXQgd2lkdGggPSB0YWJOb2RlLm9mZnNldFdpZHRoO1xuXG4gICAgICAvLyBJZiB0YWJOb2RlJ3dpZHRoIHdpZHRoIGVxdWFsIHRvIHdyYXBOb2RlJ3dpZHRoIHdoZW4gdGFiQmFyUG9zaXRpb24gaXMgdG9wIG9yIGJvdHRvbVxuICAgICAgLy8gSXQgbWVhbnMgbm8gY3NzIHdvcmtpbmcsIHRoZW4gaW5rIGJhciBzaG91bGQgbm90IGhhdmUgd2lkdGggdW50aWwgY3NzIGlzIGxvYWRlZFxuICAgICAgaWYgKHdpZHRoID09PSByb290Tm9kZS5vZmZzZXRXaWR0aCkge1xuICAgICAgICB3aWR0aCA9IDA7XG4gICAgICB9IGVsc2UgaWYgKHN0eWxlcy5pbmtCYXIgJiYgc3R5bGVzLmlua0Jhci53aWR0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHdpZHRoID0gcGFyc2VGbG9hdChzdHlsZXMuaW5rQmFyLndpZHRoLCAxMCk7XG4gICAgICAgIGlmICh3aWR0aCkge1xuICAgICAgICAgIGxlZnQgPSBsZWZ0ICsgKHRhYk5vZGUub2Zmc2V0V2lkdGggLSB3aWR0aCkgLyAyO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyB1c2UgM2QgZ3B1IHRvIG9wdGltaXplIHJlbmRlclxuICAgICAgaWYgKHRyYW5zZm9ybVN1cHBvcnRlZCkge1xuICAgICAgICBzZXRUcmFuc2Zvcm0oaW5rQmFyTm9kZVN0eWxlLCBgdHJhbnNsYXRlM2QoJHtsZWZ0fXB4LDAsMClgKTtcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLndpZHRoID0gYCR7d2lkdGh9cHhgO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUuaGVpZ2h0ID0gJyc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUubGVmdCA9IGAke2xlZnR9cHhgO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUudG9wID0gJyc7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS5ib3R0b20gPSAnJztcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLnJpZ2h0ID0gYCR7d3JhcE5vZGUub2Zmc2V0V2lkdGggLSBsZWZ0IC0gd2lkdGh9cHhgO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgdG9wID0gZ2V0VG9wKHRhYk5vZGUsIHdyYXBOb2RlKTtcbiAgICAgIGxldCBoZWlnaHQgPSB0YWJOb2RlLm9mZnNldEhlaWdodDtcbiAgICAgIGlmIChzdHlsZXMuaW5rQmFyICYmIHN0eWxlcy5pbmtCYXIuaGVpZ2h0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaGVpZ2h0ID0gcGFyc2VGbG9hdChzdHlsZXMuaW5rQmFyLmhlaWdodCwgMTApO1xuICAgICAgICBpZiAoaGVpZ2h0KSB7XG4gICAgICAgICAgdG9wID0gdG9wICsgKHRhYk5vZGUub2Zmc2V0SGVpZ2h0IC0gaGVpZ2h0KSAvIDI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0cmFuc2Zvcm1TdXBwb3J0ZWQpIHtcbiAgICAgICAgc2V0VHJhbnNmb3JtKGlua0Jhck5vZGVTdHlsZSwgYHRyYW5zbGF0ZTNkKDAsJHt0b3B9cHgsMClgKTtcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS53aWR0aCA9ICcnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLmxlZnQgPSAnJztcbiAgICAgICAgaW5rQmFyTm9kZVN0eWxlLnJpZ2h0ID0gJyc7XG4gICAgICAgIGlua0Jhck5vZGVTdHlsZS50b3AgPSBgJHt0b3B9cHhgO1xuICAgICAgICBpbmtCYXJOb2RlU3R5bGUuYm90dG9tID0gYCR7d3JhcE5vZGUub2Zmc2V0SGVpZ2h0IC0gdG9wIC0gaGVpZ2h0fXB4YDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaW5rQmFyTm9kZVN0eWxlLmRpc3BsYXkgPSBhY3RpdmVUYWIgPyAnYmxvY2snIDogJ25vbmUnO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGdldERlZmF1bHRQcm9wcygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaW5rQmFyQW5pbWF0ZWQ6IHRydWUsXG4gICAgfTtcbiAgfSxcblxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKHRoaXMpO1xuICB9LFxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIGlmIChpc0Rldikge1xuICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbXBvbmVudERpZFVwZGF0ZSh0aGlzLCB0cnVlKTtcbiAgICAgIH0sIDApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb21wb25lbnREaWRVcGRhdGUodGhpcywgdHJ1ZSk7XG4gICAgfVxuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpO1xuICB9LFxuXG4gIGdldElua0Jhck5vZGUoKSB7XG4gICAgY29uc3QgeyBwcmVmaXhDbHMsIHN0eWxlcywgaW5rQmFyQW5pbWF0ZWQgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gYCR7cHJlZml4Q2xzfS1pbmstYmFyYDtcbiAgICBjb25zdCBjbGFzc2VzID0gY2xhc3NuYW1lcyh7XG4gICAgICBbY2xhc3NOYW1lXTogdHJ1ZSxcbiAgICAgIFtcbiAgICAgICAgaW5rQmFyQW5pbWF0ZWQgP1xuICAgICAgICAgIGAke2NsYXNzTmFtZX0tYW5pbWF0ZWRgIDpcbiAgICAgICAgICBgJHtjbGFzc05hbWV9LW5vLWFuaW1hdGVkYFxuICAgICAgICBdOiB0cnVlLFxuICAgIH0pO1xuICAgIHJldHVybiAoXG4gICAgICA8ZGl2XG4gICAgICAgIHN0eWxlPXtzdHlsZXMuaW5rQmFyfVxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzZXN9XG4gICAgICAgIGtleT1cImlua0JhclwiXG4gICAgICAgIHJlZj17dGhpcy5zYXZlUmVmKCdpbmtCYXInKX1cbiAgICAgIC8+XG4gICAgKTtcbiAgfSxcbn07XG4iXX0=