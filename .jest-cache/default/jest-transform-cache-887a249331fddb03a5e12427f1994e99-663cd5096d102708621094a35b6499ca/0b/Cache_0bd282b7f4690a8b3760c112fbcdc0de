3a7197290d32e5b8c0d660d7c0e65f5e
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.refreshCacheOptions = refreshCacheOptions;
exports["default"] = void 0;

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _mobx = require("mobx");

var _configure = require("choerodon-ui/lib/configure");

var _Yallist = _interopRequireDefault(require("./Yallist"));

// 双向链表 -> 缓存更新性能优化
var MAX = Symbol('max'); // 最大值

var LENGTH = Symbol('length'); // 长度

var LENGTH_CALCULATOR = Symbol('lengthCalculator'); // 长度计算

var ALLOW_STALE = Symbol('allowStale'); // 允许过时

var MAX_AGE = Symbol('maxAge'); // 最大时效（缓存时长）

var DISPOSE = Symbol('dispose'); // 处置 处理

var NO_DISPOSE_ON_SET = Symbol('noDisposeOnSet'); // 不可处理

var LIST = Symbol('list'); // 列表

var CACHE = Symbol('cache'); // 缓存

var UPDATE_AGE_ON_GET = Symbol('updateAgeOnGet'); // 获取更新时效

var naiveLength = function naiveLength() {
  return 1;
};
/**
 * 是否过时
 * @param self
 * @param hit
 */


function isStale(self, hit) {
  if (!hit || !hit.maxAge && !self[MAX_AGE]) return false;
  var diff = Date.now() - hit.now;
  return hit.maxAge ? diff > hit.maxAge : self[MAX_AGE] && diff > self[MAX_AGE];
}
/**
 * 删除
 * @param self
 * @param node
 */


function _del(self, node) {
  if (node) {
    var hit = node.value;
    if (self[DISPOSE]) self[DISPOSE](hit.key, hit.value);
    self[LENGTH] -= hit.length;
    self[CACHE]["delete"](hit.key);
    self[LIST].removeNode(node);
  }
}
/**
 * 获取
 * @param self
 * @param key
 * @param doUse
 */


function _get(self, key, doUse) {
  var node = self[CACHE].get(key);

  if (node) {
    var hit = node.value;

    if (isStale(self, hit)) {
      _del(self, node);

      if (!self[ALLOW_STALE]) return undefined;
    } else if (doUse) {
      if (self[UPDATE_AGE_ON_GET]) node.value.now = Date.now();
      self[LIST].unshiftNode(node);
    }

    return hit.value;
  }
}
/**
 * 修整
 * @param self
 */


function trim(self) {
  if (self[LENGTH] > self[MAX]) {
    for (var walker = self[LIST].tail; self[LENGTH] > self[MAX] && walker !== null;) {
      // We know that we're about to delete this one, and also
      // what the next least recently used key will be, so just
      // go ahead and set it now.
      var prev = walker.prev;

      _del(self, walker);

      walker = prev;
    }
  }
}
/**
 * 遍历步骤
 * @param self
 * @param fn
 * @param node
 * @param thisp
 */


function forEachStep(self, fn, node, thisp) {
  var hit = node.value;

  if (isStale(self, hit)) {
    _del(self, node);

    if (!self[ALLOW_STALE]) hit = undefined;
  }

  if (hit) fn.call(thisp, hit.value, hit.key, self);
}
/**
 * 构造 Entry 类
 */


var Entry = function Entry(key, value, length, now) {
  var maxAge = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : 0;
  (0, _classCallCheck2["default"])(this, Entry);
  this.key = key;
  this.value = value;
  this.length = length;
  this.now = now;
  this.maxAge = maxAge;
};
/**
 * 导出 Cache 类
 */


var Cache =
/*#__PURE__*/
function () {
  function Cache(options) {
    (0, _classCallCheck2["default"])(this, Cache);
    if (typeof options === 'number') options = {
      max: options
    };
    if (!options) options = {};
    if (options.max && (typeof options.max !== 'number' || options.max < 0)) throw new TypeError('max must be a non-negative number');
    this[MAX] = options.max || Infinity;
    var lc = options.length || naiveLength;
    this[LENGTH_CALCULATOR] = typeof lc !== 'function' ? naiveLength : lc;
    this[ALLOW_STALE] = options.stale || false;
    if (options.maxAge && typeof options.maxAge !== 'number') throw new TypeError('maxAge must be a number');
    this[MAX_AGE] = options.maxAge || 0;
    this[DISPOSE] = options.dispose;
    this[NO_DISPOSE_ON_SET] = options.noDisposeOnSet || false;
    this[UPDATE_AGE_ON_GET] = options.updateAgeOnGet || false;
    this.reset();
  } // resize the cache when the max changes.


  (0, _createClass2["default"])(Cache, [{
    key: "rforEach",
    value: function rforEach(fn, thisp) {
      thisp = thisp || this;

      for (var walker = this[LIST].tail; walker !== null;) {
        var prev = walker.prev;
        forEachStep(this, fn, walker, thisp);
        walker = prev;
      }
    }
  }, {
    key: "forEach",
    value: function forEach(fn, thisp) {
      thisp = thisp || this;

      for (var walker = this[LIST].head; walker !== null;) {
        var next = walker.next;
        forEachStep(this, fn, walker, thisp);
        walker = next;
      }
    }
  }, {
    key: "keys",
    value: function keys() {
      return this[LIST].toArray().map(function (k) {
        return k.key;
      });
    }
  }, {
    key: "values",
    value: function values() {
      return this[LIST].toArray().map(function (k) {
        return k.value;
      });
    }
  }, {
    key: "reset",
    value: function reset() {
      var _this = this;

      if (this[DISPOSE] && this[LIST] && this[LIST].length) {
        this[LIST].forEach(function (hit) {
          return _this[DISPOSE](hit.key, hit.value);
        });
      }

      this[CACHE] = new Map(); // hash of items by key

      this[LIST] = new _Yallist["default"](); // list of items in order of use recency

      this[LENGTH] = 0; // length of items in the list
    }
  }, {
    key: "dump",
    value: function dump() {
      var _this2 = this;

      return this[LIST].map(function (hit) {
        return isStale(_this2, hit) ? false : {
          k: hit.key,
          v: hit.value,
          e: hit.now + (hit.maxAge || 0)
        };
      }).toArray().filter(function (h) {
        return h;
      });
    }
  }, {
    key: "dumpLru",
    value: function dumpLru() {
      return this[LIST];
    }
  }, {
    key: "set",
    value: function set(key, value, maxAge) {
      maxAge = maxAge || this[MAX_AGE];
      if (maxAge && typeof maxAge !== 'number') throw new TypeError('maxAge must be a number');
      var now = maxAge ? Date.now() : 0;
      var len = this[LENGTH_CALCULATOR](value, key);

      if (this[CACHE].has(key)) {
        if (len > this[MAX]) {
          _del(this, this[CACHE].get(key));

          return false;
        }

        var node = this[CACHE].get(key);
        var item = node.value;

        if (this[DISPOSE]) {
          if (!this[NO_DISPOSE_ON_SET]) this[DISPOSE](key, item.value);
        }

        item.now = now;
        item.maxAge = maxAge;
        item.value = value;
        this[LENGTH] += len - item.length;
        item.length = len;
        this.get(key);
        trim(this);
        return true;
      }

      var hit = new Entry(key, value, len, now, maxAge);

      if (hit.length > this[MAX]) {
        if (this[DISPOSE]) this[DISPOSE](key, value);
        return false;
      }

      this[LENGTH] += hit.length;
      this[LIST].unshift(hit);
      this[CACHE].set(key, this[LIST].head);
      trim(this);
      return true;
    }
  }, {
    key: "has",
    value: function has(key) {
      if (!this[CACHE].has(key)) return false;
      var hit = this[CACHE].get(key).value;
      return !isStale(this, hit);
    }
  }, {
    key: "get",
    value: function get(key) {
      return _get(this, key, true);
    }
  }, {
    key: "peek",
    value: function peek(key) {
      return _get(this, key, false);
    }
  }, {
    key: "pop",
    value: function pop() {
      var node = this[LIST].tail;
      if (!node) return null;

      _del(this, node);

      return node.value;
    }
  }, {
    key: "del",
    value: function del(key) {
      _del(this, this[CACHE].get(key));
    }
  }, {
    key: "load",
    value: function load(arr) {
      this.reset();
      var now = Date.now(); // A previous serialized cache has the most recent items first

      for (var l = arr.length - 1; l >= 0; l--) {
        var hit = arr[l];
        var expiresAt = hit.e || 0;
        if (expiresAt === 0) // the item was created without expiration in a non aged cache
          this.set(hit.k, hit.v);else {
          var maxAge = expiresAt - now; // dont add already expired items

          if (maxAge > 0) {
            this.set(hit.k, hit.v, maxAge);
          }
        }
      }
    }
  }, {
    key: "prune",
    value: function prune() {
      var _this3 = this;

      this[CACHE].forEach(function (_value, key) {
        return _get(_this3, key, false);
      });
    }
  }, {
    key: "max",
    set: function set(mL) {
      if (typeof mL !== 'number' || mL < 0) throw new TypeError('max must be a non-negative number');
      this[MAX] = mL || Infinity;
      trim(this);
    },
    get: function get() {
      return this[MAX];
    }
  }, {
    key: "allowStale",
    set: function set(allowStale) {
      this[ALLOW_STALE] = !!allowStale;
    },
    get: function get() {
      return this[ALLOW_STALE];
    }
  }, {
    key: "maxAge",
    set: function set(mA) {
      if (typeof mA !== 'number') throw new TypeError('maxAge must be a non-negative number');
      this[MAX_AGE] = mA;
      trim(this);
    },
    get: function get() {
      return this[MAX_AGE];
    } // resize the cache when the lengthCalculator changes.

  }, {
    key: "lengthCalculator",
    set: function set(lC) {
      var _this4 = this;

      if (typeof lC !== 'function') lC = naiveLength;

      if (lC !== this[LENGTH_CALCULATOR]) {
        this[LENGTH_CALCULATOR] = lC;
        this[LENGTH] = 0;
        this[LIST].forEach(function (hit) {
          hit.length = _this4[LENGTH_CALCULATOR](hit.value, hit.key);
          _this4[LENGTH] += hit.length;
        });
      }

      trim(this);
    },
    get: function get() {
      return this[LENGTH_CALCULATOR];
    }
  }, {
    key: "length",
    get: function get() {
      return this[LENGTH];
    }
  }, {
    key: "itemCount",
    get: function get() {
      return this[LIST].length;
    }
  }]);
  return Cache;
}();

exports["default"] = Cache;

function refreshCacheOptions(cache) {
  return (0, _mobx.reaction)(function () {
    return (0, _configure.getConfig)('lookupCache');
  }, function () {
    var lookupCache = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    if ('max' in lookupCache) {
      cache.max = lookupCache.max;
    }

    if ('maxAge' in lookupCache) {
      cache.maxAge = lookupCache.maxAge;
    }

    if ('stale' in lookupCache) {
      cache.allowStale = lookupCache.stale;
    }

    if ('length' in lookupCache) {
      cache.lengthCalculator = lookupCache.length;
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby9fdXRpbC9DYWNoZS50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFBaUM7QUFFakMsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUQsQ0FBbEIsQyxDQUEyQjs7QUFDM0IsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFFBQUQsQ0FBckIsQyxDQUFpQzs7QUFDakMsSUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsa0JBQUQsQ0FBaEMsQyxDQUFzRDs7QUFDdEQsSUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFlBQUQsQ0FBMUIsQyxDQUEwQzs7QUFDMUMsSUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLFFBQUQsQ0FBdEIsQyxDQUFrQzs7QUFDbEMsSUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLFNBQUQsQ0FBdEIsQyxDQUFtQzs7QUFDbkMsSUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsZ0JBQUQsQ0FBaEMsQyxDQUFvRDs7QUFDcEQsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQUQsQ0FBbkIsQyxDQUE2Qjs7QUFDN0IsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQUQsQ0FBcEIsQyxDQUErQjs7QUFDL0IsSUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsZ0JBQUQsQ0FBaEMsQyxDQUFvRDs7QUFFcEQsSUFBTSxXQUFXLEdBQUcsU0FBZCxXQUFjO0FBQUEsU0FBTSxDQUFOO0FBQUEsQ0FBcEI7QUFFQTs7Ozs7OztBQUtBLFNBQVMsT0FBVCxDQUFpQixJQUFqQixFQUF1QixHQUF2QixFQUEwQjtBQUN4QixNQUFJLENBQUMsR0FBRCxJQUFTLENBQUMsR0FBRyxDQUFDLE1BQUwsSUFBZSxDQUFDLElBQUksQ0FBQyxPQUFELENBQWpDLEVBQTZDLE9BQU8sS0FBUDtBQUU3QyxNQUFNLElB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OEIsS0FBOUIsRUFBb0Q7QUFDeEQsU0FBTyxvQkFDTDtBQUFBLFdBQU0sMEJBQVUsYUFBVixDQUFOO0FBQUEsR0FESyxFQUVMLFlBQXFCO0FBQUEsUUFBcEIsV0FBb0IsdUVBQU4sRUFBTTs7QUFDbkIsUUFBSSxTQUFTLFdBQWIsRUFBMEI7QUFDeEIsTUFBQSxLQUFLLENBQUMsR0FBTixHQUFZLFdBQVcsQ0FBQyxHQUF4QjtBQUNEOztBQUNELFFBQUksWUFBWSxXQUFoQixFQUE2QjtBQUMzQixNQUFBLEtBQUssQ0FBQyxNQUFOLEdBQWUsV0FBVyxDQUFDLE1BQTNCO0FBQ0Q7O0FBQ0QsUUFBSSxXQUFXLFdBQWYsRUFBNEI7QUFDMUIsTUFBQSxLQUFLLENBQUMsVUFBTixHQUFtQixXQUFXLENBQUMsS0FBL0I7QUFDRDs7QUFDRCxRQUFJLFlBQVksV0FBaEIsRUFBNkI7QUFDM0IsTUFBQSxLQUFLLENBQUMsZ0JBQU4sR0FBeUIsV0FBVyxDQUFDLE1BQXJDO0FBQ0Q7QUFDRixHQWZJLENBQVA7QUFpQkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJUmVhY3Rpb25EaXNwb3NlciwgcmVhY3Rpb24gfSBmcm9tICdtb2J4JztcbmltcG9ydCB7IGdldENvbmZpZyB9IGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvY29uZmlndXJlJztcbmltcG9ydCBZYWxsaXN0IGZyb20gJy4vWWFsbGlzdCc7IC8vIOWPjOWQkemTvuihqCAtPiDnvJPlrZjmm7TmlrDmgKfog73kvJjljJZcblxuY29uc3QgTUFYID0gU3ltYm9sKCdtYXgnKTsgLy8g5pyA5aSn5YC8XG5jb25zdCBMRU5HVEggPSBTeW1ib2woJ2xlbmd0aCcpOyAvLyDplb/luqZcbmNvbnN0IExFTkdUSF9DQUxDVUxBVE9SID0gU3ltYm9sKCdsZW5ndGhDYWxjdWxhdG9yJyk7IC8vIOmVv+W6puiuoeeul1xuY29uc3QgQUxMT1dfU1RBTEUgPSBTeW1ib2woJ2FsbG93U3RhbGUnKTsgLy8g5YWB6K646L+H5pe2XG5jb25zdCBNQVhfQUdFID0gU3ltYm9sKCdtYXhBZ2UnKTsgLy8g5pyA5aSn5pe25pWI77yI57yT5a2Y5pe26ZW/77yJXG5jb25zdCBESVNQT1NFID0gU3ltYm9sKCdkaXNwb3NlJyk7IC8vIOWkhOe9riDlpITnkIZcbmNvbnN0IE5PX0RJU1BPU0VfT05fU0VUID0gU3ltYm9sKCdub0Rpc3Bvc2VPblNldCcpOyAvLyDkuI3lj6/lpITnkIZcbmNvbnN0IExJU1QgPSBTeW1ib2woJ2xpc3QnKTsgLy8g5YiX6KGoXG5jb25zdCBDQUNIRSA9IFN5bWJvbCgnY2FjaGUnKTsgLy8g57yT5a2YXG5jb25zdCBVUERBVEVfQUdFX09OX0dFVCA9IFN5bWJvbCgndXBkYXRlQWdlT25HZXQnKTsgLy8g6I635Y+W5pu05paw5pe25pWIXG5cbmNvbnN0IG5haXZlTGVuZ3RoID0gKCkgPT4gMTtcblxuLyoqXG4gKiDmmK/lkKbov4fml7ZcbiAqIEBwYXJhbSBzZWxmXG4gKiBAcGFyYW0gaGl0XG4gKi9cbmZ1bmN0aW9uIGlzU3RhbGUoc2VsZiwgaGl0KTogYm9vbGVhbiB7XG4gIGlmICghaGl0IHx8ICghaGl0Lm1heEFnZSAmJiAhc2VsZltNQVhfQUdFXSkpIHJldHVybiBmYWxzZTtcblxuICBjb25zdCBkaWZmID0gRGF0ZS5ub3coKSAtIGhpdC5ub3c7XG4gIHJldHVybiBoaXQubWF4QWdlID8gZGlmZiA+IGhpdC5tYXhBZ2UgOiBzZWxmW01BWF9BR0VdICYmIGRpZmYgPiBzZWxmW01BWF9BR0VdO1xufVxuXG4vKipcbiAqIOWIoOmZpFxuICogQHBhcmFtIHNlbGZcbiAqIEBwYXJhbSBub2RlXG4gKi9cbmZ1bmN0aW9uIGRlbChzZWxmLCBub2RlKSB7XG4gIGlmIChub2RlKSB7XG4gICAgY29uc3QgaGl0ID0gbm9kZS52YWx1ZTtcbiAgICBpZiAoc2VsZltESVNQT1NFXSkgc2VsZltESVNQT1NFXShoaXQua2V5LCBoaXQudmFsdWUpO1xuXG4gICAgc2VsZltMRU5HVEhdIC09IGhpdC5sZW5ndGg7XG4gICAgc2VsZltDQUNIRV0uZGVsZXRlKGhpdC5rZXkpO1xuICAgIHNlbGZbTElTVF0ucmVtb3ZlTm9kZShub2RlKTtcbiAgfVxufVxuXG4vKipcbiAqIOiOt+WPllxuICogQHBhcmFtIHNlbGZcbiAqIEBwYXJhbSBrZXlcbiAqIEBwYXJhbSBkb1VzZVxuICovXG5mdW5jdGlvbiBnZXQoc2VsZiwga2V5LCBkb1VzZSkge1xuICBjb25zdCBub2RlID0gc2VsZltDQUNIRV0uZ2V0KGtleSk7XG4gIGlmIChub2RlKSB7XG4gICAgY29uc3QgaGl0ID0gbm9kZS52YWx1ZTtcbiAgICBpZiAoaXNTdGFsZShzZWxmLCBoaXQpKSB7XG4gICAgICBkZWwoc2VsZiwgbm9kZSk7XG4gICAgICBpZiAoIXNlbGZbQUxMT1dfU1RBTEVdKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoZG9Vc2UpIHtcbiAgICAgIGlmIChzZWxmW1VQREFURV9BR0VfT05fR0VUXSkgbm9kZS52YWx1ZS5ub3cgPSBEYXRlLm5vdygpO1xuICAgICAgc2VsZltMSVNUXS51bnNoaWZ0Tm9kZShub2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIGhpdC52YWx1ZTtcbiAgfVxufVxuXG4vKipcbiAqIOS/ruaVtFxuICogQHBhcmFtIHNlbGZcbiAqL1xuZnVuY3Rpb24gdHJpbShzZWxmKSB7XG4gIGlmIChzZWxmW0xFTkdUSF0gPiBzZWxmW01BWF0pIHtcbiAgICBmb3IgKGxldCB3YWxrZXIgPSBzZWxmW0xJU1RdLnRhaWw7IHNlbGZbTEVOR1RIXSA+IHNlbGZbTUFYXSAmJiB3YWxrZXIgIT09IG51bGw7ICkge1xuICAgICAgLy8gV2Uga25vdyB0aGF0IHdlJ3JlIGFib3V0IHRvIGRlbGV0ZSB0aGlzIG9uZSwgYW5kIGFsc29cbiAgICAgIC8vIHdoYXQgdGhlIG5leHQgbGVhc3QgcmVjZW50bHkgdXNlZCBrZXkgd2lsbCBiZSwgc28ganVzdFxuICAgICAgLy8gZ28gYWhlYWQgYW5kIHNldCBpdCBub3cuXG4gICAgICBjb25zdCBwcmV2ID0gd2Fsa2VyLnByZXY7XG4gICAgICBkZWwoc2VsZiwgd2Fsa2VyKTtcbiAgICAgIHdhbGtlciA9IHByZXY7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICog6YGN5Y6G5q2l6aqkXG4gKiBAcGFyYW0gc2VsZlxuICogQHBhcmFtIGZuXG4gKiBAcGFyYW0gbm9kZVxuICogQHBhcmFtIHRoaXNwXG4gKi9cbmZ1bmN0aW9uIGZvckVhY2hTdGVwKHNlbGYsIGZuLCBub2RlLCB0aGlzcCkge1xuICBsZXQgaGl0ID0gbm9kZS52YWx1ZTtcbiAgaWYgKGlzU3RhbGUoc2VsZiwgaGl0KSkge1xuICAgIGRlbChzZWxmLCBub2RlKTtcbiAgICBpZiAoIXNlbGZbQUxMT1dfU1RBTEVdKSBoaXQgPSB1bmRlZmluZWQ7XG4gIH1cbiAgaWYgKGhpdCkgZm4uY2FsbCh0aGlzcCwgaGl0LnZhbHVlLCBoaXQua2V5LCBzZWxmKTtcbn1cblxuLyoqXG4gKiDmnoTpgKAgRW50cnkg57G7XG4gKi9cbmNsYXNzIEVudHJ5PEssIFY+IHtcbiAga2V5OiBLO1xuXG4gIHZhbHVlOiBWO1xuXG4gIGxlbmd0aDogbnVtYmVyO1xuXG4gIG5vdzogbnVtYmVyO1xuXG4gIG1heEFnZTogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKGtleTogSywgdmFsdWU6IFYsIGxlbmd0aDogbnVtYmVyLCBub3c6IG51bWJlciwgbWF4QWdlOiBudW1iZXIgPSAwKSB7XG4gICAgdGhpcy5rZXkgPSBrZXk7XG4gICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoO1xuICAgIHRoaXMubm93ID0gbm93O1xuICAgIHRoaXMubWF4QWdlID0gbWF4QWdlO1xuICB9XG59XG5cbi8qKlxuICog5aOw5piO57yT5a2Y57G75Z6LXG4gKi9cbmV4cG9ydCB0eXBlIENhY2hlT3B0aW9uczxLLCBWPiA9IHtcbiAgbWF4PzogbnVtYmVyO1xuICBtYXhBZ2U/OiBudW1iZXI7XG4gIGxlbmd0aD86ICh2YWx1ZTogViwga2V5OiBLKSA9PiBudW1iZXI7XG4gIHN0YWxlPzogYm9vbGVhbjtcbiAgZGlzcG9zZT86IChrZXk6IEssIHZhbHVlOiBWKSA9PiB2b2lkO1xuICBub0Rpc3Bvc2VPblNldD86IGJvb2xlYW47XG4gIHVwZGF0ZUFnZU9uR2V0PzogYm9vbGVhbjtcbn07XG5cbi8qKlxuICog5a+85Ye6IENhY2hlIOexu1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYWNoZTxLLCBWPiB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdudW1iZXInKSBvcHRpb25zID0geyBtYXg6IG9wdGlvbnMgfTtcblxuICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9O1xuXG4gICAgaWYgKG9wdGlvbnMubWF4ICYmICh0eXBlb2Ygb3B0aW9ucy5tYXggIT09ICdudW1iZXInIHx8IG9wdGlvbnMubWF4IDwgMCkpXG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtYXggbXVzdCBiZSBhIG5vbi1uZWdhdGl2ZSBudW1iZXInKTtcbiAgICB0aGlzW01BWF0gPSBvcHRpb25zLm1heCB8fCBJbmZpbml0eTtcblxuICAgIGNvbnN0IGxjID0gb3B0aW9ucy5sZW5ndGggfHwgbmFpdmVMZW5ndGg7XG4gICAgdGhpc1tMRU5HVEhfQ0FMQ1VMQVRPUl0gPSB0eXBlb2YgbGMgIT09ICdmdW5jdGlvbicgPyBuYWl2ZUxlbmd0aCA6IGxjO1xuICAgIHRoaXNbQUxMT1dfU1RBTEVdID0gb3B0aW9ucy5zdGFsZSB8fCBmYWxzZTtcbiAgICBpZiAob3B0aW9ucy5tYXhBZ2UgJiYgdHlwZW9mIG9wdGlvbnMubWF4QWdlICE9PSAnbnVtYmVyJylcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ21heEFnZSBtdXN0IGJlIGEgbnVtYmVyJyk7XG4gICAgdGhpc1tNQVhfQUdFXSA9IG9wdGlvbnMubWF4QWdlIHx8IDA7XG4gICAgdGhpc1tESVNQT1NFXSA9IG9wdGlvbnMuZGlzcG9zZTtcbiAgICB0aGlzW05PX0RJU1BPU0VfT05fU0VUXSA9IG9wdGlvbnMubm9EaXNwb3NlT25TZXQgfHwgZmFsc2U7XG4gICAgdGhpc1tVUERBVEVfQUdFX09OX0dFVF0gPSBvcHRpb25zLnVwZGF0ZUFnZU9uR2V0IHx8IGZhbHNlO1xuICAgIHRoaXMucmVzZXQoKTtcbiAgfVxuXG4gIC8vIHJlc2l6ZSB0aGUgY2FjaGUgd2hlbiB0aGUgbWF4IGNoYW5nZXMuXG4gIHNldCBtYXgobUwpIHtcbiAgICBpZiAodHlwZW9mIG1MICE9PSAnbnVtYmVyJyB8fCBtTCA8IDApIHRocm93IG5ldyBUeXBlRXJyb3IoJ21heCBtdXN0IGJlIGEgbm9uLW5lZ2F0aXZlIG51bWJlcicpO1xuXG4gICAgdGhpc1tNQVhdID0gbUwgfHwgSW5maW5pdHk7XG4gICAgdHJpbSh0aGlzKTtcbiAgfVxuXG4gIGdldCBtYXgoKSB7XG4gICAgcmV0dXJuIHRoaXNbTUFYXTtcbiAgfVxuXG4gIHNldCBhbGxvd1N0YWxlKGFsbG93U3RhbGUpIHtcbiAgICB0aGlzW0FMTE9XX1NUQUxFXSA9ICEhYWxsb3dTdGFsZTtcbiAgfVxuXG4gIGdldCBhbGxvd1N0YWxlKCkge1xuICAgIHJldHVybiB0aGlzW0FMTE9XX1NUQUxFXTtcbiAgfVxuXG4gIHNldCBtYXhBZ2UobUEpIHtcbiAgICBpZiAodHlwZW9mIG1BICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IFR5cGVFcnJvcignbWF4QWdlIG11c3QgYmUgYSBub24tbmVnYXRpdmUgbnVtYmVyJyk7XG5cbiAgICB0aGlzW01BWF9BR0VdID0gbUE7XG4gICAgdHJpbSh0aGlzKTtcbiAgfVxuXG4gIGdldCBtYXhBZ2UoKSB7XG4gICAgcmV0dXJuIHRoaXNbTUFYX0FHRV07XG4gIH1cblxuICAvLyByZXNpemUgdGhlIGNhY2hlIHdoZW4gdGhlIGxlbmd0aENhbGN1bGF0b3IgY2hhbmdlcy5cbiAgc2V0IGxlbmd0aENhbGN1bGF0b3IobEMpIHtcbiAgICBpZiAodHlwZW9mIGxDICE9PSAnZnVuY3Rpb24nKSBsQyA9IG5haXZlTGVuZ3RoO1xuXG4gICAgaWYgKGxDICE9PSB0aGlzW0xFTkdUSF9DQUxDVUxBVE9SXSkge1xuICAgICAgdGhpc1tMRU5HVEhfQ0FMQ1VMQVRPUl0gPSBsQztcbiAgICAgIHRoaXNbTEVOR1RIXSA9IDA7XG4gICAgICB0aGlzW0xJU1RdLmZvckVhY2goaGl0ID0+IHtcbiAgICAgICAgaGl0Lmxlbmd0aCA9IHRoaXNbTEVOR1RIX0NBTENVTEFUT1JdKGhpdC52YWx1ZSwgaGl0LmtleSk7XG4gICAgICAgIHRoaXNbTEVOR1RIXSArPSBoaXQubGVuZ3RoO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRyaW0odGhpcyk7XG4gIH1cblxuICBnZXQgbGVuZ3RoQ2FsY3VsYXRvcigpIHtcbiAgICByZXR1cm4gdGhpc1tMRU5HVEhfQ0FMQ1VMQVRPUl07XG4gIH1cblxuICBnZXQgbGVuZ3RoKCkge1xuICAgIHJldHVybiB0aGlzW0xFTkdUSF07XG4gIH1cblxuICBnZXQgaXRlbUNvdW50KCkge1xuICAgIHJldHVybiB0aGlzW0xJU1RdLmxlbmd0aDtcbiAgfVxuXG4gIHJmb3JFYWNoKGZuLCB0aGlzcCkge1xuICAgIHRoaXNwID0gdGhpc3AgfHwgdGhpcztcbiAgICBmb3IgKGxldCB3YWxrZXIgPSB0aGlzW0xJU1RdLnRhaWw7IHdhbGtlciAhPT0gbnVsbDsgKSB7XG4gICAgICBjb25zdCBwcmV2ID0gd2Fsa2VyLnByZXY7XG4gICAgICBmb3JFYWNoU3RlcCh0aGlzLCBmbiwgd2Fsa2VyLCB0aGlzcCk7XG4gICAgICB3YWxrZXIgPSBwcmV2O1xuICAgIH1cbiAgfVxuXG4gIGZvckVhY2goZm4sIHRoaXNwKSB7XG4gICAgdGhpc3AgPSB0aGlzcCB8fCB0aGlzO1xuICAgIGZvciAobGV0IHdhbGtlciA9IHRoaXNbTElTVF0uaGVhZDsgd2Fsa2VyICE9PSBudWxsOyApIHtcbiAgICAgIGNvbnN0IG5leHQgPSB3YWxrZXIubmV4dDtcbiAgICAgIGZvckVhY2hTdGVwKHRoaXMsIGZuLCB3YWxrZXIsIHRoaXNwKTtcbiAgICAgIHdhbGtlciA9IG5leHQ7XG4gICAgfVxuICB9XG5cbiAga2V5cygpOiBLW10ge1xuICAgIHJldHVybiB0aGlzW0xJU1RdLnRvQXJyYXkoKS5tYXAoayA9PiBrLmtleSk7XG4gIH1cblxuICB2YWx1ZXMoKTogVltdIHtcbiAgICByZXR1cm4gdGhpc1tMSVNUXS50b0FycmF5KCkubWFwKGsgPT4gay52YWx1ZSk7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICBpZiAodGhpc1tESVNQT1NFXSAmJiB0aGlzW0xJU1RdICYmIHRoaXNbTElTVF0ubGVuZ3RoKSB7XG4gICAgICB0aGlzW0xJU1RdLmZvckVhY2goaGl0ID0+IHRoaXNbRElTUE9TRV0oaGl0LmtleSwgaGl0LnZhbHVlKSk7XG4gICAgfVxuXG4gICAgdGhpc1tDQUNIRV0gPSBuZXcgTWFwPEssIFY+KCk7IC8vIGhhc2ggb2YgaXRlbXMgYnkga2V5XG4gICAgdGhpc1tMSVNUXSA9IG5ldyBZYWxsaXN0KCk7IC8vIGxpc3Qgb2YgaXRlbXMgaW4gb3JkZXIgb2YgdXNlIHJlY2VuY3lcbiAgICB0aGlzW0xFTkdUSF0gPSAwOyAvLyBsZW5ndGggb2YgaXRlbXMgaW4gdGhlIGxpc3RcbiAgfVxuXG4gIGR1bXAoKSB7XG4gICAgcmV0dXJuIHRoaXNbTElTVF0ubWFwKGhpdCA9PlxuICAgICAgaXNTdGFsZSh0aGlzLCBoaXQpXG4gICAgICAgID8gZmFsc2VcbiAgICAgICAgOiB7XG4gICAgICAgICAgICBrOiBoaXQua2V5LFxuICAgICAgICAgICAgdjogaGl0LnZhbHVlLFxuICAgICAgICAgICAgZTogaGl0Lm5vdyArIChoaXQubWF4QWdlIHx8IDApLFxuICAgICAgICAgIH0sXG4gICAgKVxuICAgICAgLnRvQXJyYXkoKVxuICAgICAgLmZpbHRlcihoID0+IGgpO1xuICB9XG5cbiAgZHVtcExydSgpIHtcbiAgICByZXR1cm4gdGhpc1tMSVNUXTtcbiAgfVxuXG4gIHNldChrZXk6IEssIHZhbHVlOiBWLCBtYXhBZ2U/OiBudW1iZXIpIHtcbiAgICBtYXhBZ2UgPSBtYXhBZ2UgfHwgdGhpc1tNQVhfQUdFXTtcblxuICAgIGlmIChtYXhBZ2UgJiYgdHlwZW9mIG1heEFnZSAhPT0gJ251bWJlcicpIHRocm93IG5ldyBUeXBlRXJyb3IoJ21heEFnZSBtdXN0IGJlIGEgbnVtYmVyJyk7XG5cbiAgICBjb25zdCBub3cgPSBtYXhBZ2UgPyBEYXRlLm5vdygpIDogMDtcbiAgICBjb25zdCBsZW4gPSB0aGlzW0xFTkdUSF9DQUxDVUxBVE9SXSh2YWx1ZSwga2V5KTtcblxuICAgIGlmICh0aGlzW0NBQ0hFXS5oYXMoa2V5KSkge1xuICAgICAgaWYgKGxlbiA+IHRoaXNbTUFYXSkge1xuICAgICAgICBkZWwodGhpcywgdGhpc1tDQUNIRV0uZ2V0KGtleSkpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzW0NBQ0hFXS5nZXQoa2V5KTtcbiAgICAgIGNvbnN0IGl0ZW0gPSBub2RlLnZhbHVlO1xuXG4gICAgICBpZiAodGhpc1tESVNQT1NFXSkge1xuICAgICAgICBpZiAoIXRoaXNbTk9fRElTUE9TRV9PTl9TRVRdKSB0aGlzW0RJU1BPU0VdKGtleSwgaXRlbS52YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIGl0ZW0ubm93ID0gbm93O1xuICAgICAgaXRlbS5tYXhBZ2UgPSBtYXhBZ2U7XG4gICAgICBpdGVtLnZhbHVlID0gdmFsdWU7XG4gICAgICB0aGlzW0xFTkdUSF0gKz0gbGVuIC0gaXRlbS5sZW5ndGg7XG4gICAgICBpdGVtLmxlbmd0aCA9IGxlbjtcbiAgICAgIHRoaXMuZ2V0KGtleSk7XG4gICAgICB0cmltKHRoaXMpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgaGl0ID0gbmV3IEVudHJ5PEssIFY+KGtleSwgdmFsdWUsIGxlbiwgbm93LCBtYXhBZ2UpO1xuXG4gICAgaWYgKGhpdC5sZW5ndGggPiB0aGlzW01BWF0pIHtcbiAgICAgIGlmICh0aGlzW0RJU1BPU0VdKSB0aGlzW0RJU1BPU0VdKGtleSwgdmFsdWUpO1xuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpc1tMRU5HVEhdICs9IGhpdC5sZW5ndGg7XG4gICAgdGhpc1tMSVNUXS51bnNoaWZ0KGhpdCk7XG4gICAgdGhpc1tDQUNIRV0uc2V0KGtleSwgdGhpc1tMSVNUXS5oZWFkKTtcbiAgICB0cmltKHRoaXMpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaGFzKGtleTogSyk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpc1tDQUNIRV0uaGFzKGtleSkpIHJldHVybiBmYWxzZTtcbiAgICBjb25zdCBoaXQgPSB0aGlzW0NBQ0hFXS5nZXQoa2V5KS52YWx1ZTtcbiAgICByZXR1cm4gIWlzU3RhbGUodGhpcywgaGl0KTtcbiAgfVxuXG4gIGdldChrZXk6IEspOiBWIHtcbiAgICByZXR1cm4gZ2V0KHRoaXMsIGtleSwgdHJ1ZSk7XG4gIH1cblxuICBwZWVrKGtleTogSyk6IFYge1xuICAgIHJldHVybiBnZXQodGhpcywga2V5LCBmYWxzZSk7XG4gIH1cblxuICBwb3AoKTogViB8IG51bGwge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzW0xJU1RdLnRhaWw7XG4gICAgaWYgKCFub2RlKSByZXR1cm4gbnVsbDtcblxuICAgIGRlbCh0aGlzLCBub2RlKTtcbiAgICByZXR1cm4gbm9kZS52YWx1ZTtcbiAgfVxuXG4gIGRlbChrZXk6IEspIHtcbiAgICBkZWwodGhpcywgdGhpc1tDQUNIRV0uZ2V0KGtleSkpO1xuICB9XG5cbiAgbG9hZChhcnIpIHtcbiAgICB0aGlzLnJlc2V0KCk7XG5cbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIC8vIEEgcHJldmlvdXMgc2VyaWFsaXplZCBjYWNoZSBoYXMgdGhlIG1vc3QgcmVjZW50IGl0ZW1zIGZpcnN0XG4gICAgZm9yIChsZXQgbCA9IGFyci5sZW5ndGggLSAxOyBsID49IDA7IGwtLSkge1xuICAgICAgY29uc3QgaGl0ID0gYXJyW2xdO1xuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gaGl0LmUgfHwgMDtcbiAgICAgIGlmIChleHBpcmVzQXQgPT09IDApXG4gICAgICAgIC8vIHRoZSBpdGVtIHdhcyBjcmVhdGVkIHdpdGhvdXQgZXhwaXJhdGlvbiBpbiBhIG5vbiBhZ2VkIGNhY2hlXG4gICAgICAgIHRoaXMuc2V0KGhpdC5rLCBoaXQudik7XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgbWF4QWdlID0gZXhwaXJlc0F0IC0gbm93O1xuICAgICAgICAvLyBkb250IGFkZCBhbHJlYWR5IGV4cGlyZWQgaXRlbXNcbiAgICAgICAgaWYgKG1heEFnZSA+IDApIHtcbiAgICAgICAgICB0aGlzLnNldChoaXQuaywgaGl0LnYsIG1heEFnZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcnVuZSgpIHtcbiAgICB0aGlzW0NBQ0hFXS5mb3JFYWNoKChfdmFsdWUsIGtleSkgPT4gZ2V0KHRoaXMsIGtleSwgZmFsc2UpKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVmcmVzaENhY2hlT3B0aW9ucyhjYWNoZTogQ2FjaGU8YW55LCBhbnk+KTogSVJlYWN0aW9uRGlzcG9zZXIge1xuICByZXR1cm4gcmVhY3Rpb24oXG4gICAgKCkgPT4gZ2V0Q29uZmlnKCdsb29rdXBDYWNoZScpLFxuICAgIChsb29rdXBDYWNoZSA9IHt9KSA9PiB7XG4gICAgICBpZiAoJ21heCcgaW4gbG9va3VwQ2FjaGUpIHtcbiAgICAgICAgY2FjaGUubWF4ID0gbG9va3VwQ2FjaGUubWF4O1xuICAgICAgfVxuICAgICAgaWYgKCdtYXhBZ2UnIGluIGxvb2t1cENhY2hlKSB7XG4gICAgICAgIGNhY2hlLm1heEFnZSA9IGxvb2t1cENhY2hlLm1heEFnZTtcbiAgICAgIH1cbiAgICAgIGlmICgnc3RhbGUnIGluIGxvb2t1cENhY2hlKSB7XG4gICAgICAgIGNhY2hlLmFsbG93U3RhbGUgPSBsb29rdXBDYWNoZS5zdGFsZTtcbiAgICAgIH1cbiAgICAgIGlmICgnbGVuZ3RoJyBpbiBsb29rdXBDYWNoZSkge1xuICAgICAgICBjYWNoZS5sZW5ndGhDYWxjdWxhdG9yID0gbG9va3VwQ2FjaGUubGVuZ3RoO1xuICAgICAgfVxuICAgIH0sXG4gICk7XG59XG4iXX0=