df3f77470174c946a280737440e67455
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _uniqBy = _interopRequireDefault(require("lodash/uniqBy"));

var _LocaleReceiver = _interopRequireDefault(require("../locale-provider/LocaleReceiver"));

var _default = _interopRequireDefault(require("../locale-provider/default"));

var _UploadList = _interopRequireDefault(require("./UploadList"));

var _utils = require("./utils");

var _upload = _interopRequireDefault(require("../rc-components/upload"));

var _configure = require("../configure");

function _createSuper(Derived) {
  function isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  return function () {
    var Super = (0, _getPrototypeOf2["default"])(Derived),
        result;

    if (isNativeReflectConstruct()) {
      var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor;
      result = Reflect.construct(Super, arguments, NewTarget);
    } else {
      result = Super.apply(this, arguments);
    }

    return (0, _possibleConstructorReturn2["default"])(this, result);
  };
}

var Upload =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(Upload, _Component);

  var _super = _createSuper(Upload);

  function Upload(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, Upload);
    _this = _super.call(this, props);

    _this.onStart = function (file) {
      var fileList = _this.state.fileList;
      var nextFileList = (0, _toConsumableArray2["default"])(fileList);
      var targetItem = (0, _utils.fileToObject)(file);
      targetItem.status = 'uploading';
      nextFileList.push(targetItem);

      _this.onChange({
        file: targetItem,
        fileList: nextFileList
      }); // fix ie progress


      if (!window.FormData) {
        _this.autoUpdateProgress(0, targetItem);
      }

      var onStart = _this.props.onStart;

      if (onStart) {
        onStart(file);
      }
    };

    _this.onSuccess = function (response, file) {
      _this.clearProgressTimer();

      try {
        if (typeof response === 'string') {
          response = JSON.parse(response);
        }
      } catch (e) {
        /* do nothing */
      }

      var fileList = _this.state.fileList;
      var targetItem = (0, _utils.getFileItem)(file, fileList); // removed

      if (targetItem) {
        targetItem.status = 'done';
        targetItem.response = response;

        _this.onChange({
          file: (0, _objectSpread2["default"])({}, targetItem),
          fileList: fileList
        });
      }

      var onSuccess = _this.props.onSuccess;

      if (onSuccess) {
        onSuccess(response, file);
      }
    };

    _this.onProgress = function (e, file) {
      var fileList = _this.state.fileList;
      var targetItem = (0, _utils.getFileItem)(file, fileList); // removed

      if (targetItem) {
        targetItem.percent = e.percent;

        _this.onChange({
          event: e,
          file: (0, _objectSpread2["default"])({}, targetItem),
          fileList: fileList
        });
      }

      var onProgress = _this.props.onProgress;

      if (onProgress) {
        onProgress(e, file);
      }
    };

    _this.onError = function (error, response, file) {
      _this.clearProgressTimer();

      var fileList = _this.state.fileList;
      var targetItem = (0, _utils.getFileItem)(file, fileList); // removed

      if (!targetItem) {
        return;
      }

      targetItem.error = error;
      targetItem.response = response;
      targetItem.status = 'error';

      _this.onChange({
        file: (0, _objectSpread2["default"])({}, targetItem),
        fileList: fileList
      });

      var onError = _this.props.onError;

      if (onError) {
        onError(error, response, file);
      }
    };

    _this.handleManualRemove = function (file) {
      _this.upload.abort(file);

      file.status = 'removed'; // eslint-disable-line

      _this.handleRemove(file);
    };

    _this.onChange = function (info) {
      if (!('fileList' in _this.props)) {
        _this.setState({
          fileList: info.fileList
        });
      }

      var onChange = _this.props.onChange;

      if (onChange) {
        onChange(info);
      }
    };

    _this.onFileDrop = function (e) {
      _this.setState({
        dragState: e.type
      });
    };

    _this.beforeUpload = function (file, uploadFiles) {
      var beforeUpload = _this.props.beforeUpload;

      if (beforeUpload) {
        var result = beforeUpload(file, uploadFiles);

        if (result === false) {
          var fileList = _this.state.fileList;

          _this.onChange({
            file: file,
            fileList: (0, _uniqBy["default"])(uploadFiles.concat(fileList), function (item) {
              return item.uid;
            })
          });

          return false;
        }

        if (result && result.then) {
          return result;
        }
      }

      return true;
    };

    _this.saveUpload = function (node) {
      _this.upload = node;
    };

    _this.renderUploadList = function (uploadLocale) {
      var _this$props = _this.props,
          showUploadList = _this$props.showUploadList,
          listType = _this$props.listType,
          onPreview = _this$props.onPreview,
          locale = _this$props.locale;
      var fileList = _this.state.fileList;
      var showRemoveIcon = showUploadList.showRemoveIcon,
          showPreviewIcon = showUploadList.showPreviewIcon;
      return _react["default"].createElement(_UploadList["default"], {
        listType: listType,
        items: fileList,
        onPreview: onPreview,
        onRemove: _this.handleManualRemove,
        showRemoveIcon: showRemoveIcon,
        showPreviewIcon: showPreviewIcon,
        locale: (0, _objectSpread2["default"])({}, uploadLocale, {}, locale)
      });
    };

    _this.state = {
      fileList: props.fileList || props.defaultFileList || [],
      dragState: 'drop'
    };
    return _this;
  }

  (0, _createClass2["default"])(Upload, [{
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this.clearProgressTimer();
    }
  }, {
    key: "autoUpdateProgress",
    value: function autoUpdateProgress(_, file) {
      var _this2 = this;

      var getPercent = (0, _utils.genPercentAdd)();
      var curPercent = 0;
      this.clearProgressTimer();
      this.progressTimer = setInterval(function () {
        curPercent = getPercent(curPercent);

        _this2.onProgress({
          percent: curPercent
        }, file);
      }, 200);
    }
  }, {
    key: "handleRemove",
    value: function handleRemove(file) {
      var _this3 = this;

      var onRemove = this.props.onRemove;
      Promise.resolve(typeof onRemove === 'function' ? onRemove(file) : onRemove).then(function (ret) {
        // Prevent removing file
        if (ret === false) {
          return;
        }

        var fileList = _this3.state.fileList;
        var removedFileList = (0, _utils.removeFileItem)(file, fileList);

        if (removedFileList) {
          _this3.onChange({
            file: file,
            fileList: removedFileList
          });
        }
      });
    }
  }, {
    key: "componentWillReceiveProps",
    value: function componentWillReceiveProps(nextProps) {
      if ('fileList' in nextProps) {
        this.setState({
          fileList: nextProps.fileList || []
        });
      }
    }
  }, {
    key: "clearProgressTimer",
    value: function clearProgressTimer() {
      clearInterval(this.progressTimer);
    }
  }, {
    key: "render",
    value: function render() {
      var _classNames2;

      var _this$props2 = this.props,
          customizePrefixCls = _this$props2.prefixCls,
          className = _this$props2.className,
          showUploadList = _this$props2.showUploadList,
          listType = _this$props2.listType,
          type = _this$props2.type,
          disabled = _this$props2.disabled,
          children = _this$props2.children;
      var _this$state = this.state,
          fileList = _this$state.fileList,
          dragState = _this$state.dragState;
      var prefixCls = (0, _configure.getPrefixCls)('upload', customizePrefixCls);
      var rcUploadProps = (0, _objectSpread2["default"])({}, this.props, {
        onStart: this.onStart,
        onError: this.onError,
        onProgress: this.onProgress,
        onSuccess: this.onSuccess,
        beforeUpload: this.beforeUpload,
        prefixCls: prefixCls
      });
      delete rcUploadProps.className;
      var uploadList = showUploadList ? _react["default"].createElement(_LocaleReceiver["default"], {
        componentName: "Upload",
        defaultLocale: _default["default"].Upload
      }, this.renderUploadList) : null;

      if (type === 'drag') {
        var _classNames;

        var dragCls = (0, _classnames["default"])(prefixCls, (_classNames = {}, (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-drag"), true), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-drag-uploading"), fileList.some(function (file) {
          return file.status === 'uploading';
        })), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-drag-hover"), dragState === 'dragover'), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-disabled"), disabled), _classNames));
        return _react["default"].createElement("span", {
          className: className
        }, _react["default"].createElement("div", {
          className: dragCls,
          onDrop: this.onFileDrop,
          onDragOver: this.onFileDrop,
          onDragLeave: this.onFileDrop
        }, _react["default"].createElement(_upload["default"], (0, _extends2["default"])({}, rcUploadProps, {
          ref: this.saveUpload,
          className: "".concat(prefixCls, "-btn")
        }), _react["default"].createElement("div", {
          className: "".concat(prefixCls, "-drag-container")
        }, children))), uploadList);
      }

      var uploadButtonCls = (0, _classnames["default"])(prefixCls, (_classNames2 = {}, (0, _defineProperty2["default"])(_classNames2, "".concat(prefixCls, "-select"), true), (0, _defineProperty2["default"])(_classNames2, "".concat(prefixCls, "-select-").concat(listType), true), (0, _defineProperty2["default"])(_classNames2, "".concat(prefixCls, "-disabled"), disabled), _classNames2));

      var uploadButton = _react["default"].createElement("div", {
        className: uploadButtonCls,
        style: {
          display: children ? '' : 'none'
        }
      }, _react["default"].createElement(_upload["default"], (0, _extends2["default"])({}, rcUploadProps, {
        ref: this.saveUpload
      })));

      if (listType === 'picture-card') {
        return _react["default"].createElement("span", {
          className: className
        }, uploadList, uploadButton);
      }

      return _react["default"].createElement("span", {
        className: className
      }, uploadButton, uploadList);
    }
  }]);
  return Upload;
}(_react.Component);

exports["default"] = Upload;
Upload.displayName = 'Upload';
Upload.defaultProps = {
  type: 'select',
  multiple: false,
  action: '',
  data: {},
  accept: '',
  beforeUpload: _utils.T,
  showUploadList: true,
  listType: 'text',
  className: '',
  disabled: false,
  supportServerRender: true
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzL3VwbG9hZC9VcGxvYWQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFJcUIsTTs7Ozs7OztBQXlCbkIsa0JBQVksS0FBWixFQUE4QjtBQUFBOztBQUFBO0FBQzVCLDhCQUFNLEtBQU47O0FBWUYsVUFBQSxPQUFBLEdBQVUsVUFBQyxJQUFELEVBQXFCO0FBQUEsVUFDckIsUUFEcUIsR0FDUixNQUFLLEtBREcsQ0FDckIsUUFEcUI7QUFFN0IsVUFBTSxZQUFZLHVDQUFPLFFBQVAsQ0FBbEI7QUFDQSxVQUFNLFVBQVUsR0FBRyx5QkFBYSxJQUFiLENBQW5CO0FBQ0EsTUFBQSxVQUFVLENBQUMsTUFBWCxHQUFvQixXQUFwQjtBQUNBLE1BQUEsWUFBWSxDQUFDLElBQWIsQ0FBa0IsVUFBbEI7O0FBQ0EsWUFBSyxRQUFMLENBQWM7QUFDWixRQUFBLElBQUksRUFBRSxVQURNO0FBRVosUUFBQSxRQUFRLEVBQUU7QUFGRSxPQUFkLEVBTjZCLENBVTdCOzs7QUFDQSxVQUFJLENBQUUsTUFBYyxDQUFDLFFBQXJCLEVBQStCO0FBQzdCLGNBQUssa0JBQUwsQ0FBd0IsQ0FBeEIsRUFBMkIsVUFBM0I7QUFDRDs7QUFiNEIsVUFjckIsT0FkcUIsR0FjVCxNQUFLLEtBZEksQ0FjckIsT0FkcUI7O0FBZTdCLFVBQUksT0FBSixFQUFhO0FBQ1gsUUFBQSxPQUFPLENBQUMsSUFBRCxDQUFQO0FBQ0Q7QUFDRixLQWxCRDs7QUFtQ0EsVUFBQSxTQUFBLEdBQVksVUFBQyxRQUFELEVBQWdCLElBQWhCLEVBQW9DO0FBQzlDLFlBQUssa0JBQUw7O0FBQ0EsVUFBSTtBQUNGLFlBQUks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QWpCLFNBQUEsRUFDRyxVQURILEVBRUcsWUFGSCxDQURGO0FBTUQ7O0FBQ0QsYUFDRSxrQkFBQSxhQUFBLENBQUEsTUFBQSxFQUFBO0FBQU0sUUFBQSxTQUFTLEVBQUU7QUFBakIsT0FBQSxFQUNHLFlBREgsRUFFRyxVQUZILENBREY7QUFNRDs7O0VBMVRpQyxnQjs7O0FBQzNCLE1BQUEsQ0FBQSxXQUFBLEdBQWMsUUFBZDtBQUlBLE1BQUEsQ0FBQSxZQUFBLEdBQWU7QUFDcEIsRUFBQSxJQUFJLEVBQUUsUUFEYztBQUVwQixFQUFBLFFBQVEsRUFBRSxLQUZVO0FBR3BCLEVBQUEsTUFBTSxFQUFFLEVBSFk7QUFJcEIsRUFBQSxJQUFJLEVBQUUsRUFKYztBQUtwQixFQUFBLE1BQU0sRUFBRSxFQUxZO0FBTXBCLEVBQUEsWUFBWSxFQUFFLFFBTk07QUFPcEIsRUFBQSxjQUFjLEVBQUUsSUFQSTtBQVFwQixFQUFBLFFBQVEsRUFBRSxNQVJVO0FBU3BCLEVBQUEsU0FBUyxFQUFFLEVBVFM7QUFVcEIsRUFBQSxRQUFRLEVBQUUsS0FWVTtBQVdwQixFQUFBLG1CQUFtQixFQUFFO0FBWEQsQ0FBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIERyYWdFdmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHVuaXFCeSBmcm9tICdsb2Rhc2gvdW5pcUJ5JztcbmltcG9ydCBMb2NhbGVSZWNlaXZlciBmcm9tICcuLi9sb2NhbGUtcHJvdmlkZXIvTG9jYWxlUmVjZWl2ZXInO1xuaW1wb3J0IGRlZmF1bHRMb2NhbGUgZnJvbSAnLi4vbG9jYWxlLXByb3ZpZGVyL2RlZmF1bHQnO1xuaW1wb3J0IERyYWdnZXIgZnJvbSAnLi9EcmFnZ2VyJztcbmltcG9ydCBVcGxvYWRMaXN0IGZyb20gJy4vVXBsb2FkTGlzdCc7XG5pbXBvcnQgeyBVcGxvYWRDaGFuZ2VQYXJhbSwgVXBsb2FkRmlsZSwgVXBsb2FkTG9jYWxlLCBVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBmaWxlVG9PYmplY3QsIGdlblBlcmNlbnRBZGQsIGdldEZpbGVJdGVtLCByZW1vdmVGaWxlSXRlbSwgVCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFJjVXBsb2FkIGZyb20gJy4uL3JjLWNvbXBvbmVudHMvdXBsb2FkJztcbmltcG9ydCB7IGdldFByZWZpeENscyB9IGZyb20gJy4uL2NvbmZpZ3VyZSc7XG5cbmV4cG9ydCB7IFVwbG9hZFByb3BzIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVwbG9hZCBleHRlbmRzIENvbXBvbmVudDxVcGxvYWRQcm9wcywgVXBsb2FkU3RhdGU+IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ1VwbG9hZCc7XG5cbiAgc3RhdGljIERyYWdnZXI6IHR5cGVvZiBEcmFnZ2VyO1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgdHlwZTogJ3NlbGVjdCcsXG4gICAgbXVsdGlwbGU6IGZhbHNlLFxuICAgIGFjdGlvbjogJycsXG4gICAgZGF0YToge30sXG4gICAgYWNjZXB0OiAnJyxcbiAgICBiZWZvcmVVcGxvYWQ6IFQsXG4gICAgc2hvd1VwbG9hZExpc3Q6IHRydWUsXG4gICAgbGlzdFR5cGU6ICd0ZXh0JywgLy8gb3IgcGljdHJ1ZVxuICAgIGNsYXNzTmFtZTogJycsXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxuICAgIHN1cHBvcnRTZXJ2ZXJSZW5kZXI6IHRydWUsXG4gIH07XG5cbiAgcmVjZW50VXBsb2FkU3RhdHVzOiBib29sZWFuIHwgUHJvbWlzZUxpa2U8YW55PjtcblxuICBwcm9ncmVzc1RpbWVyOiBhbnk7XG5cbiAgcHJpdmF0ZSB1cGxvYWQ6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogVXBsb2FkUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgZmlsZUxpc3Q6IHByb3BzLmZpbGVMaXN0IHx8IHByb3BzLmRlZmF1bHRGaWxlTGlzdCB8fCBbXSxcbiAgICAgIGRyYWdTdGF0ZTogJ2Ryb3AnLFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB0aGlzLmNsZWFyUHJvZ3Jlc3NUaW1lcigpO1xuICB9XG5cbiAgb25TdGFydCA9IChmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBuZXh0RmlsZUxpc3QgPSBbLi4uZmlsZUxpc3RdO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBmaWxlVG9PYmplY3QoZmlsZSk7XG4gICAgdGFyZ2V0SXRlbS5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICBuZXh0RmlsZUxpc3QucHVzaCh0YXJnZXRJdGVtKTtcbiAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgIGZpbGU6IHRhcmdldEl0ZW0sXG4gICAgICBmaWxlTGlzdDogbmV4dEZpbGVMaXN0LFxuICAgIH0pO1xuICAgIC8vIGZpeCBpZSBwcm9ncmVzc1xuICAgIGlmICghKHdpbmRvdyBhcyBhbnkpLkZvcm1EYXRhKSB7XG4gICAgICB0aGlzLmF1dG9VcGRhdGVQcm9ncmVzcygwLCB0YXJnZXRJdGVtKTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN0YXJ0IH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblN0YXJ0KSB7XG4gICAgICBvblN0YXJ0KGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBhdXRvVXBkYXRlUHJvZ3Jlc3MoXzogYW55LCBmaWxlOiBVcGxvYWRGaWxlKSB7XG4gICAgY29uc3QgZ2V0UGVyY2VudCA9IGdlblBlcmNlbnRBZGQoKTtcbiAgICBsZXQgY3VyUGVyY2VudCA9IDA7XG4gICAgdGhpcy5jbGVhclByb2dyZXNzVGltZXIoKTtcbiAgICB0aGlzLnByb2dyZXNzVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBjdXJQZXJjZW50ID0gZ2V0UGVyY2VudChjdXJQZXJjZW50KTtcbiAgICAgIHRoaXMub25Qcm9ncmVzcyhcbiAgICAgICAge1xuICAgICAgICAgIHBlcmNlbnQ6IGN1clBlcmNlbnQsXG4gICAgICAgIH0sXG4gICAgICAgIGZpbGUsXG4gICAgICApO1xuICAgIH0sIDIwMCk7XG4gIH1cblxuICBvblN1Y2Nlc3MgPSAocmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLyogZG8gbm90aGluZyAqL1xuICAgIH1cbiAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBnZXRGaWxlSXRlbShmaWxlLCBmaWxlTGlzdCk7XG4gICAgLy8gcmVtb3ZlZFxuICAgIGlmICh0YXJnZXRJdGVtKSB7XG4gICAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdkb25lJztcbiAgICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIHRoaXMub25DaGFuZ2Uoe1xuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblN1Y2Nlc3MgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uU3VjY2Vzcykge1xuICAgICAgb25TdWNjZXNzKHJlc3BvbnNlLCBmaWxlKTtcbiAgICB9XG4gIH07XG5cbiAgb25Qcm9ncmVzcyA9IChlOiB7IHBlcmNlbnQ6IG51bWJlciB9LCBmaWxlOiBVcGxvYWRGaWxlKSA9PiB7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAodGFyZ2V0SXRlbSkge1xuICAgICAgdGFyZ2V0SXRlbS5wZXJjZW50ID0gZS5wZXJjZW50O1xuICAgICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICAgIGV2ZW50OiBlLFxuICAgICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgICAgZmlsZUxpc3QsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBvblByb2dyZXNzIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChvblByb2dyZXNzKSB7XG4gICAgICBvblByb2dyZXNzKGUsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBvbkVycm9yID0gKGVycm9yOiBFcnJvciwgcmVzcG9uc2U6IGFueSwgZmlsZTogVXBsb2FkRmlsZSkgPT4ge1xuICAgIHRoaXMuY2xlYXJQcm9ncmVzc1RpbWVyKCk7XG4gICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB0YXJnZXRJdGVtID0gZ2V0RmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgIC8vIHJlbW92ZWRcbiAgICBpZiAoIXRhcmdldEl0ZW0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGFyZ2V0SXRlbS5lcnJvciA9IGVycm9yO1xuICAgIHRhcmdldEl0ZW0ucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICB0YXJnZXRJdGVtLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICBmaWxlOiB7IC4uLnRhcmdldEl0ZW0gfSxcbiAgICAgIGZpbGVMaXN0LFxuICAgIH0pO1xuICAgIGNvbnN0IHsgb25FcnJvciB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAob25FcnJvcikge1xuICAgICAgb25FcnJvcihlcnJvciwgcmVzcG9uc2UsIGZpbGUpO1xuICAgIH1cbiAgfTtcblxuICBoYW5kbGVSZW1vdmUoZmlsZTogVXBsb2FkRmlsZSkge1xuICAgIGNvbnN0IHsgb25SZW1vdmUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBQcm9taXNlLnJlc29sdmUodHlwZW9mIG9uUmVtb3ZlID09PSAnZnVuY3Rpb24nID8gb25SZW1vdmUoZmlsZSkgOiBvblJlbW92ZSkudGhlbihyZXQgPT4ge1xuICAgICAgLy8gUHJldmVudCByZW1vdmluZyBmaWxlXG4gICAgICBpZiAocmV0ID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB7IGZpbGVMaXN0IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgY29uc3QgcmVtb3ZlZEZpbGVMaXN0ID0gcmVtb3ZlRmlsZUl0ZW0oZmlsZSwgZmlsZUxpc3QpO1xuICAgICAgaWYgKHJlbW92ZWRGaWxlTGlzdCkge1xuICAgICAgICB0aGlzLm9uQ2hhbmdlKHtcbiAgICAgICAgICBmaWxlLFxuICAgICAgICAgIGZpbGVMaXN0OiByZW1vdmVkRmlsZUxpc3QsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlTWFudWFsUmVtb3ZlID0gKGZpbGU6IFVwbG9hZEZpbGUpID0+IHtcbiAgICB0aGlzLnVwbG9hZC5hYm9ydChmaWxlKTtcbiAgICBmaWxlLnN0YXR1cyA9ICdyZW1vdmVkJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgIHRoaXMuaGFuZGxlUmVtb3ZlKGZpbGUpO1xuICB9O1xuXG4gIG9uQ2hhbmdlID0gKGluZm86IFVwbG9hZENoYW5nZVBhcmFtKSA9PiB7XG4gICAgaWYgKCEoJ2ZpbGVMaXN0JyBpbiB0aGlzLnByb3BzKSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGZpbGVMaXN0OiBpbmZvLmZpbGVMaXN0IH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgb25DaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG9uQ2hhbmdlKSB7XG4gICAgICBvbkNoYW5nZShpbmZvKTtcbiAgICB9XG4gIH07XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IFVwbG9hZFByb3BzKSB7XG4gICAgaWYgKCdmaWxlTGlzdCcgaW4gbmV4dFByb3BzKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgZmlsZUxpc3Q6IG5leHRQcm9wcy5maWxlTGlzdCB8fCBbXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9uRmlsZURyb3AgPSAoZTogRHJhZ0V2ZW50PEhUTUxEaXZFbGVtZW50PikgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgZHJhZ1N0YXRlOiBlLnR5cGUsXG4gICAgfSk7XG4gIH07XG5cbiAgYmVmb3JlVXBsb2FkID0gKGZpbGU6IFVwbG9hZEZpbGUsIHVwbG9hZEZpbGVzOiBVcGxvYWRGaWxlW10pID0+IHtcbiAgICBjb25zdCB7IGJlZm9yZVVwbG9hZCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoYmVmb3JlVXBsb2FkKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBiZWZvcmVVcGxvYWQoZmlsZSwgdXBsb2FkRmlsZXMpO1xuICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgeyBmaWxlTGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgICAgdGhpcy5vbkNoYW5nZSh7XG4gICAgICAgICAgZmlsZSxcbiAgICAgICAgICBmaWxlTGlzdDogdW5pcUJ5KHVwbG9hZEZpbGVzLmNvbmNhdChmaWxlTGlzdCksIChpdGVtOiBhbnkpID0+IGl0ZW0udWlkKSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXN1bHQgJiYgKHJlc3VsdCBhcyBQcm9taXNlTGlrZTxhbnk+KS50aGVuKSB7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIGNsZWFyUHJvZ3Jlc3NUaW1lcigpIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMucHJvZ3Jlc3NUaW1lcik7XG4gIH1cblxuICBzYXZlVXBsb2FkID0gKG5vZGU6IFJjVXBsb2FkIHwgbnVsbCkgPT4ge1xuICAgIHRoaXMudXBsb2FkID0gbm9kZTtcbiAgfTtcblxuICByZW5kZXJVcGxvYWRMaXN0ID0gKHVwbG9hZExvY2FsZTogVXBsb2FkTG9jYWxlKSA9PiB7XG4gICAgY29uc3QgeyBzaG93VXBsb2FkTGlzdCwgbGlzdFR5cGUsIG9uUHJldmlldywgbG9jYWxlIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgZmlsZUxpc3QgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgeyBzaG93UmVtb3ZlSWNvbiwgc2hvd1ByZXZpZXdJY29uIH0gPSBzaG93VXBsb2FkTGlzdCBhcyBhbnk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxVcGxvYWRMaXN0XG4gICAgICAgIGxpc3RUeXBlPXtsaXN0VHlwZX1cbiAgICAgICAgaXRlbXM9e2ZpbGVMaXN0fVxuICAgICAgICBvblByZXZpZXc9e29uUHJldmlld31cbiAgICAgICAgb25SZW1vdmU9e3RoaXMuaGFuZGxlTWFudWFsUmVtb3ZlfVxuICAgICAgICBzaG93UmVtb3ZlSWNvbj17c2hvd1JlbW92ZUljb259XG4gICAgICAgIHNob3dQcmV2aWV3SWNvbj17c2hvd1ByZXZpZXdJY29ufVxuICAgICAgICBsb2NhbGU9e3sgLi4udXBsb2FkTG9jYWxlLCAuLi5sb2NhbGUgfX1cbiAgICAgIC8+XG4gICAgKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgcHJlZml4Q2xzOiBjdXN0b21pemVQcmVmaXhDbHMsXG4gICAgICBjbGFzc05hbWUsXG4gICAgICBzaG93VXBsb2FkTGlzdCxcbiAgICAgIGxpc3RUeXBlLFxuICAgICAgdHlwZSxcbiAgICAgIGRpc2FibGVkLFxuICAgICAgY2hpbGRyZW4sXG4gICAgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBmaWxlTGlzdCwgZHJhZ1N0YXRlIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgY29uc3QgcHJlZml4Q2xzID0gZ2V0UHJlZml4Q2xzKCd1cGxvYWQnLCBjdXN0b21pemVQcmVmaXhDbHMpO1xuXG4gICAgY29uc3QgcmNVcGxvYWRQcm9wcyA9IHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBvblN0YXJ0OiB0aGlzLm9uU3RhcnQsXG4gICAgICBvbkVycm9yOiB0aGlzLm9uRXJyb3IsXG4gICAgICBvblByb2dyZXNzOiB0aGlzLm9uUHJvZ3Jlc3MsXG4gICAgICBvblN1Y2Nlc3M6IHRoaXMub25TdWNjZXNzLFxuICAgICAgYmVmb3JlVXBsb2FkOiB0aGlzLmJlZm9yZVVwbG9hZCxcbiAgICAgIHByZWZpeENscyxcbiAgICB9O1xuXG4gICAgZGVsZXRlIHJjVXBsb2FkUHJvcHMuY2xhc3NOYW1lO1xuXG4gICAgY29uc3QgdXBsb2FkTGlzdCA9IHNob3dVcGxvYWRMaXN0ID8gKFxuICAgICAgPExvY2FsZVJlY2VpdmVyIGNvbXBvbmVudE5hbWU9XCJVcGxvYWRcIiBkZWZhdWx0TG9jYWxlPXtkZWZhdWx0TG9jYWxlLlVwbG9hZH0+XG4gICAgICAgIHt0aGlzLnJlbmRlclVwbG9hZExpc3R9XG4gICAgICA8L0xvY2FsZVJlY2VpdmVyPlxuICAgICkgOiBudWxsO1xuXG4gICAgaWYgKHR5cGUgPT09ICdkcmFnJykge1xuICAgICAgY29uc3QgZHJhZ0NscyA9IGNsYXNzTmFtZXMocHJlZml4Q2xzLCB7XG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWdgXTogdHJ1ZSxcbiAgICAgICAgW2Ake3ByZWZpeENsc30tZHJhZy11cGxvYWRpbmdgXTogZmlsZUxpc3Quc29tZShmaWxlID0+IGZpbGUuc3RhdHVzID09PSAndXBsb2FkaW5nJyksXG4gICAgICAgIFtgJHtwcmVmaXhDbHN9LWRyYWctaG92ZXJgXTogZHJhZ1N0YXRlID09PSAnZHJhZ292ZXInLFxuICAgICAgICBbYCR7cHJlZml4Q2xzfS1kaXNhYmxlZGBdOiBkaXNhYmxlZCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtjbGFzc05hbWV9PlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzTmFtZT17ZHJhZ0Nsc31cbiAgICAgICAgICAgIG9uRHJvcD17dGhpcy5vbkZpbGVEcm9wfVxuICAgICAgICAgICAgb25EcmFnT3Zlcj17dGhpcy5vbkZpbGVEcm9wfVxuICAgICAgICAgICAgb25EcmFnTGVhdmU9e3RoaXMub25GaWxlRHJvcH1cbiAgICAgICAgICA+XG4gICAgICAgICAgICA8UmNVcGxvYWQgey4uLnJjVXBsb2FkUHJvcHN9IHJlZj17dGhpcy5zYXZlVXBsb2FkfSBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tYnRuYH0+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWRyYWctY29udGFpbmVyYH0+e2NoaWxkcmVufTwvZGl2PlxuICAgICAgICAgICAgPC9SY1VwbG9hZD5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICB7dXBsb2FkTGlzdH1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGxvYWRCdXR0b25DbHMgPSBjbGFzc05hbWVzKHByZWZpeENscywge1xuICAgICAgW2Ake3ByZWZpeENsc30tc2VsZWN0YF06IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1zZWxlY3QtJHtsaXN0VHlwZX1gXTogdHJ1ZSxcbiAgICAgIFtgJHtwcmVmaXhDbHN9LWRpc2FibGVkYF06IGRpc2FibGVkLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdXBsb2FkQnV0dG9uID0gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9e3VwbG9hZEJ1dHRvbkNsc30gc3R5bGU9e3sgZGlzcGxheTogY2hpbGRyZW4gPyAnJyA6ICdub25lJyB9fT5cbiAgICAgICAgPFJjVXBsb2FkIHsuLi5yY1VwbG9hZFByb3BzfSByZWY9e3RoaXMuc2F2ZVVwbG9hZH0gLz5cbiAgICAgIDwvZGl2PlxuICAgICk7XG5cbiAgICBpZiAobGlzdFR5cGUgPT09ICdwaWN0dXJlLWNhcmQnKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2NsYXNzTmFtZX0+XG4gICAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NOYW1lfT5cbiAgICAgICAge3VwbG9hZEJ1dHRvbn1cbiAgICAgICAge3VwbG9hZExpc3R9XG4gICAgICA8L3NwYW4+XG4gICAgKTtcbiAgfVxufVxuIl19