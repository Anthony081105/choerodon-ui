cba80f036af3adee2c0fa15a35a2fac3
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = createFieldsStore;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _set = _interopRequireDefault(require("lodash/set"));

var _isEqual = _interopRequireDefault(require("lodash/isEqual"));

var _createFormField = _interopRequireWildcard(require("./createFormField"));

var _utils = require("./utils");

function partOf(a, b) {
  return b.indexOf(a) === 0 && ['.', '['].indexOf(b[a.length]) !== -1;
}

var FieldsStore =
/*#__PURE__*/
function () {
  function FieldsStore(_fields) {
    var _this = this;

    (0, _classCallCheck2["default"])(this, FieldsStore);
    (0, _defineProperty2["default"])(this, "setFieldsInitialValue", function (initialValues) {
      var flattenedInitialValues = _this.flattenRegisteredFields(initialValues);

      var fieldsMeta = _this.fieldsMeta;
      Object.keys(flattenedInitialValues).forEach(function (name) {
        if (fieldsMeta[name]) {
          _this.setFieldMeta(name, (0, _objectSpread2["default"])({}, _this.getFieldMeta(name), {
            initialValue: flattenedInitialValues[name]
          }));
        }
      });
    });
    (0, _defineProperty2["default"])(this, "getAllValues", function () {
      var fieldsMeta = _this.fieldsMeta,
          fields = _this.fields;
      return Object.keys(fieldsMeta).reduce(function (acc, name) {
        return (0, _set["default"])(acc, name, _this.getValueFromFields(name, fields));
      }, {});
    });
    (0, _defineProperty2["default"])(this, "getFieldsValue", function (names) {
      return _this.getNestedFields(names, _this.getFieldValue);
    });
    (0, _defineProperty2["default"])(this, "getFieldValue", function (name) {
      var fields = _this.fields;
      return _this.getNestedField(name, function (fullName) {
        return _this.getValueFromFields(fullName, fields);
      });
    });
    (0, _defineProperty2["default"])(this, "getFieldsError", function (names) {
      return _this.getNestedFields(names, _this.getFieldError);
    });
    (0, _defineProperty2["default"])(this, "getFieldError", function (name) {
      return _this.getNestedField(name, function (fullName) {
        return (0, _utils.getErrorStrs)(_this.getFieldMember(fullName, 'errors'));
      });
    });
    (0, _defineProperty2["default"])(this, "isFieldValidating", function (name) {
      return _this.getFieldMember(name, 'validating');
    });
    (0, _defineProperty2["default"])(this, "isFieldsValidating", function (ns) {
      var names = ns || _this.getValidFieldsName();

      return names.some(function (n) {
        return _this.isFieldValidating(n);
      });
    });
    (0, _defineProperty2["default"])(this, "isFieldTouched", function (name) {
      return _this.getFieldMember(name, 'touched');
    });
    (0, _defineProperty2["default"])(this, "isFieldsTouched", function (ns) {
      var names = ns || _this.getValidFieldsName();

      return names.some(function (n) {
        return _this.isFieldTouched(n);
      });
    });
    (0, _defineProperty2["default"])(this, "isModifiedField", function (name) {
      var value = _this.getFieldValue(name);

      var fieldMeta = _this.getFieldMeta(name);

      var initialValue = fieldMeta && fieldMeta.initialValue;

      if (!value && !initialValue) {
        return false;
      }

      if (!(0, _isEqual["default"])(value, initialValue)) {
        return true;
      }

      return false;
    });
    (0, _defineProperty2["default"])(this, "isModifiedFields", function (names) {
      var i;
      var length;
      var fieldNames = names ? _this.getValidFieldsFullName(names) : _this.getValidFieldsName();

      if (fieldNames && Array.isArray(fieldNames)) {
        for (i = 0, length = fieldNames.length; i < length; i++) {
          if (_this.isModifiedField(fieldNames[i])) {
            return true;
          }
        }
      }

      return false;
    });
    this.fields = this.flattenFields(_fields);
    this.fieldsMeta = {};
  }

  (0, _createClass2["default"])(FieldsStore, [{
    key: "updateFields",
    value: function updateFields(fields) {
      this.fields = this.flattenFields(fields);
    }
  }, {
    key: "flattenFields",
    value: function flattenFields(fields) {
      return (0, _utils.flattenFields)(fields, function (_, node) {
        return (0, _createFormField.isFormField)(node);
      }, 'You must wrap field data with `createFormField`.');
    }
  }, {
    key: "flattenRegisteredFields",
    value: function flattenRegisteredFields(fields) {
      var validFieldsName = this.getAllFieldsName();
      return (0, _utils.flattenFields)(fields, function (path) {
        return validFieldsName.indexOf(path) >= 0;
      }, 'You cannot set field before registering it.');
    }
  }, {
    key: "setFields",
    value: function setFields(fields) {
      var _this2 = this;

      var fieldsMeta = this.fieldsMeta;
      var nowFields = (0, _objectSpread2["default"])({}, this.fields, {}, fields);
      var nowValues = {};
      Object.keys(fieldsMeta).forEach(function (f) {
        return nowValues[f] = _this2.getValueFromFields(f, nowFields);
      });
      Object.keys(nowValues).forEach(function (f) {
        var value = nowValues[f];

        var fieldMeta = _this2.getFieldMeta(f);

        if (fieldMeta && fieldMeta.normalize) {
          var nowValue = fieldMeta.normalize(value, _this2.getValueFromFields(f, _this2.fields), nowValues);

          if (nowValue !== value) {
            nowFields[f] = (0, _objectSpread2["default"])({}, nowFields[f], {
              value: nowValue
            });
          }
        }
      });
      this.fields = nowFields;
    }
  }, {
    key: "resetFields",
    value: function resetFields(ns) {
      var fields = this.fields;
      var names = ns ? this.getValidFieldsFullName(ns) : this.getAllFieldsName();
      return names.reduce(function (acc, name) {
        var field = fields[name];

        if (field && 'value' in field) {
          acc[name] = {};
        }

        return acc;
      }, {});
    }
  }, {
    key: "setFieldMeta",
    value: function setFieldMeta(name, meta) {
      this.fieldsMeta[name] = meta;
    }
  }, {
    key: "getFieldMeta",
    value: function getFieldMeta(name) {
      this.fieldsMeta[name] = this.fieldsMeta[name] || {};
      return this.fieldsMeta[name];
    }
  }, {
    key: "getValueFromFields",
    value: function getValueFromFields(name, fields) {
      var field = fields[name];

      if (field && 'value' in field) {
        return field.value;
      }

      var fieldMeta = this.getFieldMeta(name);
      return fieldMeta && fieldMeta.initialValue;
    }
  }, {
    key: "getValidFieldsName",
    value: function getValidFieldsName() {
      var _this3 = this;

      var fieldsMeta = this.fieldsMeta;
      return fieldsMeta ? Object.keys(fieldsMeta).filter(function (name) {
        return !_this3.getFieldMeta(name).hidden;
      }) : [];
    }
  }, {
    key: "getAllFieldsName",
    value: function getAllFieldsName() {
      var fieldsMeta = this.fieldsMeta;
      return fieldsMeta ? Object.keys(fieldsMeta) : [];
    }
  }, {
    key: "getValidFieldsFullName",
    value: function getValidFieldsFullName(maybePartialName) {
      var maybePartialNames = Array.isArray(maybePartialName) ? maybePartialName : [maybePartialName];
      return this.getValidFieldsName().filter(function (fullName) {
        return maybePartialNames.some(function (partialName) {
          return fullName === partialName || (0, _utils.startsWith)(fullName, partialName) && ['.', '['].indexOf(fullName[partialName.length]) >= 0;
        });
      });
    }
  }, {
    key: "getFieldValuePropValue",
    value: function getFieldValuePropValue(fieldMeta) {
      var name = fieldMeta.name,
          getValueProps = fieldMeta.getValueProps,
          valuePropName = fieldMeta.valuePropName;
      var field = this.getField(name);
      var fieldValue = 'value' in field ? field.value : fieldMeta.initialValue;

      if (getValueProps) {
        return getValueProps(fieldValue);
      }

      return (0, _defineProperty2["default"])({}, valuePropName, fieldValue);
    }
  }, {
    key: "getField",
    value: function getField(name) {
      return (0, _objectSpread2["default"])({}, this.fields[name], {
        name: name
      });
    }
  }, {
    key: "getNotCollectedFields",
    value: function getNotCollectedFields() {
      var _this4 = this;

      return this.getValidFieldsName().filter(function (name) {
        return !_this4.fields[name];
      }).map(function (name) {
        return {
          name: name,
          dirty: false,
          value: _this4.getFieldMeta(name).initialValue
        };
      }).reduce(function (acc, field) {
        return (0, _set["default"])(acc, field.name, (0, _createFormField["default"])(field));
      }, {});
    }
  }, {
    key: "getNestedAllFields",
    value: function getNestedAllFields() {
      var _this5 = this;

      return Object.keys(this.fields).reduce(function (acc, name) {
        return (0, _set["default"])(acc, name, (0, _createFormField["default"])(_this5.fields[name]));
      }, this.getNotCollectedFields());
    }
  }, {
    key: "getFieldMember",
    value: function getFieldMember(name, member) {
      return this.getField(name)[member];
    }
  }, {
    key: "getNestedFields",
    value: function getNestedFields(names, getter) {
      var fields = names || this.getValidFieldsName();
      return fields.reduce(function (acc, f) {
        return (0, _set["default"])(acc, f, getter(f));
      }, {});
    }
  }, {
    key: "getNestedField",
    value: function getNestedField(name, getter) {
      var fullNames = this.getValidFieldsFullName(name);

      if (fullNames.length === 0 || // Not registered
      fullNames.length === 1 && fullNames[0] === name // Name already is full name.
      ) {
          return getter(name);
        }

      var isArrayValue = fullNames[0][name.length] === '[';
      var suffixNameStartIndex = isArrayValue ? name.length : name.length + 1;
      return fullNames.reduce(function (acc, fullName) {
        return (0, _set["default"])(acc, fullName.slice(suffixNameStartIndex), getter(fullName));
      }, isArrayValue ? [] : {});
    }
  }, {
    key: "isValidNestedFieldName",
    // @private
    // BG: `a` and `a.b` cannot be use in the same form
    value: function isValidNestedFieldName(name) {
      var names = this.getAllFieldsName();
      return names.every(function (n) {
        return !partOf(n, name) && !partOf(name, n);
      });
    }
  }, {
    key: "clearField",
    value: function clearField(name) {
      delete this.fields[name];
      delete this.fieldsMeta[name];
    }
  }]);
  return FieldsStore;
}();

function createFieldsStore(fields) {
  return new FieldsStore(fields);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZUZpZWxkc1N0b3JlLmpzeCJdLCJuYW1lcyI6WyJwYXJ0T2YiLCJhIiwiYiIsImluZGV4T2YiLCJsZW5ndGgiLCJGaWVsZHNTdG9yZSIsImZpZWxkcyIsImluaXRpYWxWYWx1ZXMiLCJmbGF0dGVuZWRJbml0aWFsVmFsdWVzIiwiZmxhdHRlblJlZ2lzdGVyZWRGaWVsZHMiLCJmaWVsZHNNZXRhIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJuYW1lIiwic2V0RmllbGRNZXRhIiwiZ2V0RmllbGRNZXRhIiwiaW5pdGlhbFZhbHVlIiwicmVkdWNlIiwiYWNjIiwiZ2V0VmFsdWVGcm9tRmllbGRzIiwibmFtZXMiLCJnZXROZXN0ZWRGaWVsZHMiLCJnZXRGaWVsZFZhbHVlIiwiZ2V0TmVzdGVkRmllbGQiLCJmdWxsTmFtZSIsImdldEZpZWxkRXJyb3IiLCJnZXRGaWVsZE1lbWJlciIsIm5zIiwiZ2V0VmFsaWRGaWVsZHNOYW1lIiwic29tZSIsIm4iLCJpc0ZpZWxkVmFsaWRhdGluZyIsImlzRmllbGRUb3VjaGVkIiwidmFsdWUiLCJmaWVsZE1ldGEiLCJpIiwiZmllbGROYW1lcyIsImdldFZhbGlkRmllbGRzRnVsbE5hbWUiLCJBcnJheSIsImlzQXJyYXkiLCJpc01vZGlmaWVkRmllbGQiLCJmbGF0dGVuRmllbGRzIiwiXyIsIm5vZGUiLCJ2YWxpZEZpZWxkc05hbWUiLCJnZXRBbGxGaWVsZHNOYW1lIiwicGF0aCIsIm5vd0ZpZWxkcyIsIm5vd1ZhbHVlcyIsImYiLCJub3JtYWxpemUiLCJub3dWYWx1ZSIsImZpZWxkIiwibWV0YSIsImZpbHRlciIsImhpZGRlbiIsIm1heWJlUGFydGlhbE5hbWUiLCJtYXliZVBhcnRpYWxOYW1lcyIsInBhcnRpYWxOYW1lIiwiZ2V0VmFsdWVQcm9wcyIsInZhbHVlUHJvcE5hbWUiLCJnZXRGaWVsZCIsImZpZWxkVmFsdWUiLCJtYXAiLCJkaXJ0eSIsImdldE5vdENvbGxlY3RlZEZpZWxkcyIsIm1lbWJlciIsImdldHRlciIsImZ1bGxOYW1lcyIsImlzQXJyYXlWYWx1ZSIsInN1ZmZpeE5hbWVTdGFydEluZGV4Iiwic2xpY2UiLCJldmVyeSIsImNyZWF0ZUZpZWxkc1N0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsU0FBU0EsTUFBVCxDQUFnQkMsQ0FBaEIsRUFBbUJDLENBQW5CLEVBQXNCO0FBQ3BCLFNBQU9BLENBQUMsQ0FBQ0MsT0FBRixDQUFVRixDQUFWLE1BQWlCLENBQWpCLElBQXNCLENBQUMsR0FBRCxFQUFNLEdBQU4sRUFBV0UsT0FBWCxDQUFtQkQsQ0FBQyxDQUFDRCxDQUFDLENBQUNHLE1BQUgsQ0FBcEIsTUFBb0MsQ0FBQyxDQUFsRTtBQUNEOztJQUVLQyxXOzs7QUFDSix1QkFBWUMsT0FBWixFQUFvQjtBQUFBOztBQUFBO0FBQUEsb0VBMEJJLFVBQUNDLGFBQUQsRUFBbUI7QUFDekMsVUFBTUMsc0JBQXNCLEdBQUcsS0FBSSxDQUFDQyx1QkFBTCxDQUE2QkYsYUFBN0IsQ0FBL0I7O0FBQ0EsVUFBTUcsVUFBVSxHQUFHLEtBQUksQ0FBQ0EsVUFBeEI7QUFDQUMsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlKLHNCQUFaLEVBQW9DSyxPQUFwQyxDQUE0QyxVQUFBQyxJQUFJLEVBQUk7QUFDbEQsWUFBSUosVUFBVSxDQUFDSSxJQUFELENBQWQsRUFBc0I7QUFDcEIsVUFBQSxLQUFJLENBQUNDLFlBQUwsQ0FBa0JELElBQWxCLHFDQUNLLEtBQUksQ0FBQ0UsWUFBTCxDQUFrQkYsSUFBbEIsQ0FETDtBQUVFRyxZQUFBQSxZQUFZLEVBQUVULHNCQUFzQixDQUFDTSxJQUFEO0FBRnRDO0FBSUQ7QUFDRixPQVBEO0FBUUQsS0FyQ21CO0FBQUEsMkRBaUdMLFlBQU07QUFBQSxVQUNYSixVQURXLEdBQ1ksS0FEWixDQUNYQSxVQURXO0FBQUEsVUFDQ0osTUFERCxHQUNZLEtBRFosQ0FDQ0EsTUFERDtBQUVuQixhQUFPSyxNQUFNLENBQUND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QUZHLEVBT0g2QyxZQUFZLEdBQUcsRUFBSCxHQUFRLEVBUGpCLENBQVA7QUFTRDs7O0FBd0NEO0FBQ0E7MkNBQ3VCeEQsSSxFQUFNO0FBQzNCLFVBQU1PLEtBQUssR0FBRyxLQUFLeUIsZ0JBQUwsRUFBZDtBQUNBLGFBQU96QixLQUFLLENBQUNvRCxLQUFOLENBQVksVUFBQTFDLENBQUM7QUFBQSxlQUFJLENBQUMvQixNQUFNLENBQUMrQixDQUFELEVBQUlqQixJQUFKLENBQVAsSUFBb0IsQ0FBQ2QsTUFBTSxDQUFDYyxJQUFELEVBQU9pQixDQUFQLENBQS9CO0FBQUEsT0FBYixDQUFQO0FBQ0Q7OzsrQkFFVWpCLEksRUFBTTtBQUNmLGFBQU8sS0FBS1IsTUFBTCxDQUFZUSxJQUFaLENBQVA7QUFDQSxhQUFPLEtBQUtKLFVBQUwsQ0FBZ0JJLElBQWhCLENBQVA7QUFDRDs7Ozs7QUFpQ1ksU0FBUzRELGlCQUFULENBQTJCcEUsTUFBM0IsRUFBbUM7QUFDaEQsU0FBTyxJQUFJRCxXQUFKLENBQWdCQyxNQUFoQixDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc2V0IGZyb20gJ2xvZGFzaC9zZXQnO1xuaW1wb3J0IGlzRXF1YWwgZnJvbSAnbG9kYXNoL2lzRXF1YWwnO1xuaW1wb3J0IGNyZWF0ZUZvcm1GaWVsZCwgeyBpc0Zvcm1GaWVsZCB9IGZyb20gJy4vY3JlYXRlRm9ybUZpZWxkJztcbmltcG9ydCB7IGZsYXR0ZW5GaWVsZHMsIGdldEVycm9yU3Rycywgc3RhcnRzV2l0aCwgfSBmcm9tICcuL3V0aWxzJztcblxuZnVuY3Rpb24gcGFydE9mKGEsIGIpIHtcbiAgcmV0dXJuIGIuaW5kZXhPZihhKSA9PT0gMCAmJiBbJy4nLCAnWyddLmluZGV4T2YoYlthLmxlbmd0aF0pICE9PSAtMTtcbn1cblxuY2xhc3MgRmllbGRzU3RvcmUge1xuICBjb25zdHJ1Y3RvcihmaWVsZHMpIHtcbiAgICB0aGlzLmZpZWxkcyA9IHRoaXMuZmxhdHRlbkZpZWxkcyhmaWVsZHMpO1xuICAgIHRoaXMuZmllbGRzTWV0YSA9IHt9O1xuICB9XG5cbiAgdXBkYXRlRmllbGRzKGZpZWxkcykge1xuICAgIHRoaXMuZmllbGRzID0gdGhpcy5mbGF0dGVuRmllbGRzKGZpZWxkcyk7XG4gIH1cblxuICBmbGF0dGVuRmllbGRzKGZpZWxkcykge1xuICAgIHJldHVybiBmbGF0dGVuRmllbGRzKFxuICAgICAgZmllbGRzLFxuICAgICAgKF8sIG5vZGUpID0+IGlzRm9ybUZpZWxkKG5vZGUpLFxuICAgICAgJ1lvdSBtdXN0IHdyYXAgZmllbGQgZGF0YSB3aXRoIGBjcmVhdGVGb3JtRmllbGRgLidcbiAgICApO1xuICB9XG5cbiAgZmxhdHRlblJlZ2lzdGVyZWRGaWVsZHMoZmllbGRzKSB7XG4gICAgY29uc3QgdmFsaWRGaWVsZHNOYW1lID0gdGhpcy5nZXRBbGxGaWVsZHNOYW1lKCk7XG4gICAgcmV0dXJuIGZsYXR0ZW5GaWVsZHMoXG4gICAgICBmaWVsZHMsXG4gICAgICBwYXRoID0+IHZhbGlkRmllbGRzTmFtZS5pbmRleE9mKHBhdGgpID49IDAsXG4gICAgICAnWW91IGNhbm5vdCBzZXQgZmllbGQgYmVmb3JlIHJlZ2lzdGVyaW5nIGl0LidcbiAgICApO1xuICB9XG5cbiAgc2V0RmllbGRzSW5pdGlhbFZhbHVlID0gKGluaXRpYWxWYWx1ZXMpID0+IHtcbiAgICBjb25zdCBmbGF0dGVuZWRJbml0aWFsVmFsdWVzID0gdGhpcy5mbGF0dGVuUmVnaXN0ZXJlZEZpZWxkcyhpbml0aWFsVmFsdWVzKTtcbiAgICBjb25zdCBmaWVsZHNNZXRhID0gdGhpcy5maWVsZHNNZXRhO1xuICAgIE9iamVjdC5rZXlzKGZsYXR0ZW5lZEluaXRpYWxWYWx1ZXMpLmZvckVhY2gobmFtZSA9PiB7XG4gICAgICBpZiAoZmllbGRzTWV0YVtuYW1lXSkge1xuICAgICAgICB0aGlzLnNldEZpZWxkTWV0YShuYW1lLCB7XG4gICAgICAgICAgLi4udGhpcy5nZXRGaWVsZE1ldGEobmFtZSksXG4gICAgICAgICAgaW5pdGlhbFZhbHVlOiBmbGF0dGVuZWRJbml0aWFsVmFsdWVzW25hbWVdLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNldEZpZWxkcyhmaWVsZHMpIHtcbiAgICBjb25zdCBmaWVsZHNNZXRhID0gdGhpcy5maWVsZHNNZXRhO1xuICAgIGNvbnN0IG5vd0ZpZWxkcyA9IHtcbiAgICAgIC4uLnRoaXMuZmllbGRzLFxuICAgICAgLi4uZmllbGRzLFxuICAgIH07XG4gICAgY29uc3Qgbm93VmFsdWVzID0ge307XG4gICAgT2JqZWN0LmtleXMoZmllbGRzTWV0YSlcbiAgICAgIC5mb3JFYWNoKChmKSA9PiBub3dWYWx1ZXNbZl0gPSB0aGlzLmdldFZhbHVlRnJvbUZpZWxkcyhmLCBub3dGaWVsZHMpKTtcbiAgICBPYmplY3Qua2V5cyhub3dWYWx1ZXMpLmZvckVhY2goKGYpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gbm93VmFsdWVzW2ZdO1xuICAgICAgY29uc3QgZmllbGRNZXRhID0gdGhpcy5nZXRGaWVsZE1ldGEoZik7XG4gICAgICBpZiAoZmllbGRNZXRhICYmIGZpZWxkTWV0YS5ub3JtYWxpemUpIHtcbiAgICAgICAgY29uc3Qgbm93VmFsdWUgPVxuICAgICAgICAgICAgICAgIGZpZWxkTWV0YS5ub3JtYWxpemUodmFsdWUsIHRoaXMuZ2V0VmFsdWVGcm9tRmllbGRzKGYsIHRoaXMuZmllbGRzKSwgbm93VmFsdWVzKTtcbiAgICAgICAgaWYgKG5vd1ZhbHVlICE9PSB2YWx1ZSkge1xuICAgICAgICAgIG5vd0ZpZWxkc1tmXSA9IHtcbiAgICAgICAgICAgIC4uLm5vd0ZpZWxkc1tmXSxcbiAgICAgICAgICAgIHZhbHVlOiBub3dWYWx1ZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5maWVsZHMgPSBub3dGaWVsZHM7XG4gIH1cblxuICByZXNldEZpZWxkcyhucykge1xuICAgIGNvbnN0IHsgZmllbGRzIH0gPSB0aGlzO1xuICAgIGNvbnN0IG5hbWVzID0gbnMgP1xuICAgICAgdGhpcy5nZXRWYWxpZEZpZWxkc0Z1bGxOYW1lKG5zKSA6XG4gICAgICB0aGlzLmdldEFsbEZpZWxkc05hbWUoKTtcbiAgICByZXR1cm4gbmFtZXMucmVkdWNlKChhY2MsIG5hbWUpID0+IHtcbiAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRzW25hbWVdO1xuICAgICAgaWYgKGZpZWxkICYmICd2YWx1ZScgaW4gZmllbGQpIHtcbiAgICAgICAgYWNjW25hbWVdID0ge307XG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcbiAgfVxuXG4gIHNldEZpZWxkTWV0YShuYW1lLCBtZXRhKSB7XG4gICAgdGhpcy5maWVsZHNNZXRhW25hbWVdID0gbWV0YTtcbiAgfVxuXG4gIGdldEZpZWxkTWV0YShuYW1lKSB7XG4gICAgdGhpcy5maWVsZHNNZXRhW25hbWVdID0gdGhpcy5maWVsZHNNZXRhW25hbWVdIHx8IHt9O1xuICAgIHJldHVybiB0aGlzLmZpZWxkc01ldGFbbmFtZV07XG4gIH1cblxuICBnZXRWYWx1ZUZyb21GaWVsZHMobmFtZSwgZmllbGRzKSB7XG4gICAgY29uc3QgZmllbGQgPSBmaWVsZHNbbmFtZV07XG4gICAgaWYgKGZpZWxkICYmICd2YWx1ZScgaW4gZmllbGQpIHtcbiAgICAgIHJldHVybiBmaWVsZC52YWx1ZTtcbiAgICB9XG4gICAgY29uc3QgZmllbGRNZXRhID0gdGhpcy5nZXRGaWVsZE1ldGEobmFtZSk7XG4gICAgcmV0dXJuIGZpZWxkTWV0YSAmJiBmaWVsZE1ldGEuaW5pdGlhbFZhbHVlO1xuICB9XG5cbiAgZ2V0QWxsVmFsdWVzID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgZmllbGRzTWV0YSwgZmllbGRzIH0gPSB0aGlzO1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhmaWVsZHNNZXRhKVxuICAgICAgLnJlZHVjZSgoYWNjLCBuYW1lKSA9PiBzZXQoYWNjLCBuYW1lLCB0aGlzLmdldFZhbHVlRnJvbUZpZWxkcyhuYW1lLCBmaWVsZHMpKSwge30pO1xuICB9XG5cbiAgZ2V0VmFsaWRGaWVsZHNOYW1lKCkge1xuICAgIGNvbnN0IHsgZmllbGRzTWV0YSB9ID0gdGhpcztcbiAgICByZXR1cm4gZmllbGRzTWV0YSA/XG4gICAgICBPYmplY3Qua2V5cyhmaWVsZHNNZXRhKS5maWx0ZXIobmFtZSA9PiAhdGhpcy5nZXRGaWVsZE1ldGEobmFtZSkuaGlkZGVuKSA6XG4gICAgICBbXTtcbiAgfVxuXG4gIGdldEFsbEZpZWxkc05hbWUoKSB7XG4gICAgY29uc3QgeyBmaWVsZHNNZXRhIH0gPSB0aGlzO1xuICAgIHJldHVybiBmaWVsZHNNZXRhID8gT2JqZWN0LmtleXMoZmllbGRzTWV0YSkgOiBbXTtcbiAgfVxuXG4gIGdldFZhbGlkRmllbGRzRnVsbE5hbWUobWF5YmVQYXJ0aWFsTmFtZSkge1xuICAgIGNvbnN0IG1heWJlUGFydGlhbE5hbWVzID0gQXJyYXkuaXNBcnJheShtYXliZVBhcnRpYWxOYW1lKSA/XG4gICAgICBtYXliZVBhcnRpYWxOYW1lIDogW21heWJlUGFydGlhbE5hbWVdO1xuICAgIHJldHVybiB0aGlzLmdldFZhbGlkRmllbGRzTmFtZSgpXG4gICAgICAuZmlsdGVyKGZ1bGxOYW1lID0+IG1heWJlUGFydGlhbE5hbWVzLnNvbWUocGFydGlhbE5hbWUgPT4gKFxuICAgICAgICBmdWxsTmFtZSA9PT0gcGFydGlhbE5hbWUgfHwgKFxuICAgICAgICAgIHN0YXJ0c1dpdGgoZnVsbE5hbWUsIHBhcnRpYWxOYW1lKSAmJlxuICAgICAgICAgIFsnLicsICdbJ10uaW5kZXhPZihmdWxsTmFtZVtwYXJ0aWFsTmFtZS5sZW5ndGhdKSA+PSAwXG4gICAgICAgIClcbiAgICAgICkpKTtcbiAgfVxuXG4gIGdldEZpZWxkVmFsdWVQcm9wVmFsdWUoZmllbGRNZXRhKSB7XG4gICAgY29uc3QgeyBuYW1lLCBnZXRWYWx1ZVByb3BzLCB2YWx1ZVByb3BOYW1lIH0gPSBmaWVsZE1ldGE7XG4gICAgY29uc3QgZmllbGQgPSB0aGlzLmdldEZpZWxkKG5hbWUpO1xuICAgIGNvbnN0IGZpZWxkVmFsdWUgPSAndmFsdWUnIGluIGZpZWxkID9cbiAgICAgIGZpZWxkLnZhbHVlIDogZmllbGRNZXRhLmluaXRpYWxWYWx1ZTtcbiAgICBpZiAoZ2V0VmFsdWVQcm9wcykge1xuICAgICAgcmV0dXJuIGdldFZhbHVlUHJvcHMoZmllbGRWYWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiB7IFt2YWx1ZVByb3BOYW1lXTogZmllbGRWYWx1ZSB9O1xuICB9XG5cbiAgZ2V0RmllbGQobmFtZSkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi50aGlzLmZpZWxkc1tuYW1lXSxcbiAgICAgIG5hbWUsXG4gICAgfTtcbiAgfVxuXG4gIGdldE5vdENvbGxlY3RlZEZpZWxkcygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRWYWxpZEZpZWxkc05hbWUoKVxuICAgICAgLmZpbHRlcihuYW1lID0+ICF0aGlzLmZpZWxkc1tuYW1lXSlcbiAgICAgIC5tYXAobmFtZSA9PiAoe1xuICAgICAgICBuYW1lLFxuICAgICAgICBkaXJ0eTogZmFsc2UsXG4gICAgICAgIHZhbHVlOiB0aGlzLmdldEZpZWxkTWV0YShuYW1lKS5pbml0aWFsVmFsdWUsXG4gICAgICB9KSlcbiAgICAgIC5yZWR1Y2UoKGFjYywgZmllbGQpID0+IHNldChhY2MsIGZpZWxkLm5hbWUsIGNyZWF0ZUZvcm1GaWVsZChmaWVsZCkpLCB7fSk7XG4gIH1cblxuICBnZXROZXN0ZWRBbGxGaWVsZHMoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuZmllbGRzKVxuICAgICAgLnJlZHVjZShcbiAgICAgICAgKGFjYywgbmFtZSkgPT4gc2V0KGFjYywgbmFtZSwgY3JlYXRlRm9ybUZpZWxkKHRoaXMuZmllbGRzW25hbWVdKSksXG4gICAgICAgIHRoaXMuZ2V0Tm90Q29sbGVjdGVkRmllbGRzKClcbiAgICAgICk7XG4gIH1cblxuICBnZXRGaWVsZE1lbWJlcihuYW1lLCBtZW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRGaWVsZChuYW1lKVttZW1iZXJdO1xuICB9XG5cbiAgZ2V0TmVzdGVkRmllbGRzKG5hbWVzLCBnZXR0ZXIpIHtcbiAgICBjb25zdCBmaWVsZHMgPSBuYW1lcyB8fCB0aGlzLmdldFZhbGlkRmllbGRzTmFtZSgpO1xuICAgIHJldHVybiBmaWVsZHMucmVkdWNlKChhY2MsIGYpID0+IHNldChhY2MsIGYsIGdldHRlcihmKSksIHt9KTtcbiAgfVxuXG4gIGdldE5lc3RlZEZpZWxkKG5hbWUsIGdldHRlcikge1xuICAgIGNvbnN0IGZ1bGxOYW1lcyA9IHRoaXMuZ2V0VmFsaWRGaWVsZHNGdWxsTmFtZShuYW1lKTtcbiAgICBpZiAoXG4gICAgICBmdWxsTmFtZXMubGVuZ3RoID09PSAwIHx8IC8vIE5vdCByZWdpc3RlcmVkXG4gICAgICAgIChmdWxsTmFtZXMubGVuZ3RoID09PSAxICYmIGZ1bGxOYW1lc1swXSA9PT0gbmFtZSkgLy8gTmFtZSBhbHJlYWR5IGlzIGZ1bGwgbmFtZS5cbiAgICApIHtcbiAgICAgIHJldHVybiBnZXR0ZXIobmFtZSk7XG4gICAgfVxuICAgIGNvbnN0IGlzQXJyYXlWYWx1ZSA9IGZ1bGxOYW1lc1swXVtuYW1lLmxlbmd0aF0gPT09ICdbJztcbiAgICBjb25zdCBzdWZmaXhOYW1lU3RhcnRJbmRleCA9IGlzQXJyYXlWYWx1ZSA/IG5hbWUubGVuZ3RoIDogbmFtZS5sZW5ndGggKyAxO1xuICAgIHJldHVybiBmdWxsTmFtZXNcbiAgICAgIC5yZWR1Y2UoXG4gICAgICAgIChhY2MsIGZ1bGxOYW1lKSA9PiBzZXQoXG4gICAgICAgICAgYWNjLFxuICAgICAgICAgIGZ1bGxOYW1lLnNsaWNlKHN1ZmZpeE5hbWVTdGFydEluZGV4KSxcbiAgICAgICAgICBnZXR0ZXIoZnVsbE5hbWUpXG4gICAgICAgICksXG4gICAgICAgIGlzQXJyYXlWYWx1ZSA/IFtdIDoge31cbiAgICAgICk7XG4gIH1cblxuICBnZXRGaWVsZHNWYWx1ZSA9IChuYW1lcykgPT4ge1xuICAgIHJldHVybiB0aGlzLmdldE5lc3RlZEZpZWxkcyhuYW1lcywgdGhpcy5nZXRGaWVsZFZhbHVlKTtcbiAgfVxuXG4gIGdldEZpZWxkVmFsdWUgPSAobmFtZSkgPT4ge1xuICAgIGNvbnN0IHsgZmllbGRzIH0gPSB0aGlzO1xuICAgIHJldHVybiB0aGlzLmdldE5lc3RlZEZpZWxkKG5hbWUsIChmdWxsTmFtZSkgPT4gdGhpcy5nZXRWYWx1ZUZyb21GaWVsZHMoZnVsbE5hbWUsIGZpZWxkcykpO1xuICB9XG5cbiAgZ2V0RmllbGRzRXJyb3IgPSAobmFtZXMpID0+IHtcbiAgICByZXR1cm4gdGhpcy5nZXROZXN0ZWRGaWVsZHMobmFtZXMsIHRoaXMuZ2V0RmllbGRFcnJvcik7XG4gIH1cblxuICBnZXRGaWVsZEVycm9yID0gKG5hbWUpID0+IHtcbiAgICByZXR1cm4gdGhpcy5nZXROZXN0ZWRGaWVsZChcbiAgICAgIG5hbWUsXG4gICAgICAoZnVsbE5hbWUpID0+IGdldEVycm9yU3Rycyh0aGlzLmdldEZpZWxkTWVtYmVyKGZ1bGxOYW1lLCAnZXJyb3JzJykpXG4gICAgKTtcbiAgfVxuXG4gIGlzRmllbGRWYWxpZGF0aW5nID0gKG5hbWUpID0+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRGaWVsZE1lbWJlcihuYW1lLCAndmFsaWRhdGluZycpO1xuICB9XG5cbiAgaXNGaWVsZHNWYWxpZGF0aW5nID0gKG5zKSA9PiB7XG4gICAgY29uc3QgbmFtZXMgPSBucyB8fCB0aGlzLmdldFZhbGlkRmllbGRzTmFtZSgpO1xuICAgIHJldHVybiBuYW1lcy5zb21lKChuKSA9PiB0aGlzLmlzRmllbGRWYWxpZGF0aW5nKG4pKTtcbiAgfVxuXG4gIGlzRmllbGRUb3VjaGVkID0gKG5hbWUpID0+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRGaWVsZE1lbWJlcihuYW1lLCAndG91Y2hlZCcpO1xuICB9XG5cbiAgaXNGaWVsZHNUb3VjaGVkID0gKG5zKSA9PiB7XG4gICAgY29uc3QgbmFtZXMgPSBucyB8fCB0aGlzLmdldFZhbGlkRmllbGRzTmFtZSgpO1xuICAgIHJldHVybiBuYW1lcy5zb21lKChuKSA9PiB0aGlzLmlzRmllbGRUb3VjaGVkKG4pKTtcbiAgfVxuXG4gIC8vIEBwcml2YXRlXG4gIC8vIEJHOiBgYWAgYW5kIGBhLmJgIGNhbm5vdCBiZSB1c2UgaW4gdGhlIHNhbWUgZm9ybVxuICBpc1ZhbGlkTmVzdGVkRmllbGROYW1lKG5hbWUpIHtcbiAgICBjb25zdCBuYW1lcyA9IHRoaXMuZ2V0QWxsRmllbGRzTmFtZSgpO1xuICAgIHJldHVybiBuYW1lcy5ldmVyeShuID0+ICFwYXJ0T2YobiwgbmFtZSkgJiYgIXBhcnRPZihuYW1lLCBuKSk7XG4gIH1cblxuICBjbGVhckZpZWxkKG5hbWUpIHtcbiAgICBkZWxldGUgdGhpcy5maWVsZHNbbmFtZV07XG4gICAgZGVsZXRlIHRoaXMuZmllbGRzTWV0YVtuYW1lXTtcbiAgfVxuXG4gIGlzTW9kaWZpZWRGaWVsZCA9IChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldEZpZWxkVmFsdWUobmFtZSk7XG4gICAgY29uc3QgZmllbGRNZXRhID0gdGhpcy5nZXRGaWVsZE1ldGEobmFtZSk7XG4gICAgY29uc3QgaW5pdGlhbFZhbHVlID0gIGZpZWxkTWV0YSAmJiBmaWVsZE1ldGEuaW5pdGlhbFZhbHVlO1xuICAgIGlmICghdmFsdWUgJiYgIWluaXRpYWxWYWx1ZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIWlzRXF1YWwodmFsdWUsIGluaXRpYWxWYWx1ZSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpc01vZGlmaWVkRmllbGRzID0gKG5hbWVzKSA9PiB7XG4gICAgbGV0IGk7XG4gICAgbGV0IGxlbmd0aDtcbiAgICBjb25zdCBmaWVsZE5hbWVzID0gbmFtZXMgP1xuICAgICAgICAgIHRoaXMuZ2V0VmFsaWRGaWVsZHNGdWxsTmFtZShuYW1lcykgOlxuICAgICAgICAgIHRoaXMuZ2V0VmFsaWRGaWVsZHNOYW1lKCk7XG4gICAgaWYgKGZpZWxkTmFtZXMgJiYgQXJyYXkuaXNBcnJheShmaWVsZE5hbWVzKSkge1xuICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gZmllbGROYW1lcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodGhpcy5pc01vZGlmaWVkRmllbGQoZmllbGROYW1lc1tpXSkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjcmVhdGVGaWVsZHNTdG9yZShmaWVsZHMpIHtcbiAgcmV0dXJuIG5ldyBGaWVsZHNTdG9yZShmaWVsZHMpO1xufVxuIl19