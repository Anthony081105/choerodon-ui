{"version":3,"sources":["request.jsx"],"names":["getError","option","xhr","msg","action","status","err","Error","method","url","getBody","text","responseText","response","JSON","parse","e","requestFileFormData","requestFileKeys","formData","FormData","data","Object","keys","map","key","append","filename","file","toStringValue","value","stringify","ArrayToObject","obj","arrayString","forEach","item","requestFileKeysFile","push","upload","XMLHttpRequest","onProgress","onprogress","progress","total","percent","loaded","onerror","error","onError","onload","onSuccess","open","withCredentials","headers","setRequestHeader","h","hasOwnProperty","send","abort"],"mappings":"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","sourcesContent":["import isString from 'lodash/isString';\nimport isArray from 'lodash/isArray';\nimport isObject  from 'lodash/isObject';\nimport toString  from 'lodash/toString';\nimport isNil  from 'lodash/isNil';\n\nfunction getError(option, xhr) {\n  const msg = `cannot post ${option.action} ${xhr.status}'`;\n  const err = new Error(msg);\n  err.status = xhr.status;\n  err.method = 'post';\n  err.url = option.action;\n  return err;\n}\n\nfunction getBody(xhr) {\n  const text = xhr.responseText || xhr.response;\n  if (!text) {\n    return text;\n  }\n\n  try {\n    return JSON.parse(text);\n  } catch (e) {\n    return text;\n  }\n}\n\n// option {\n//  onProgress: (event: { percent: number }): void,\n//  onError: (event: Error, body?: Object): void,\n//  onSuccess: (body: Object): void,\n//  data: Object,\n//  filename: String,\n//  file: File,\n//  withCredentials: Boolean,\n//  action: String,\n//  headers: Object,\n// }\n\n\nfunction requestFileFormData(requestFileKeys,option) {\n\n  const formData = new FormData();\n  /** \n   * 添加注入的data数据\n   */\n  if (option.data) {\n    Object.keys(option.data).map(key => {\n      formData.append(key, option.data[key]);\n    });\n  }\n  /**\n   * 添加文件数据\n   */\n  formData.append(option.filename, option.file);\n\n  const toStringValue = (value) => {\n    if(isNil(value)){\n      return '';\n    }\n    if(isString(value)){\n      return value\n    }\n    if(isObject(value)) {\n      return JSON.stringify(value)\n    }\n    return toString(value)\n  }\n  \n  /**\n   * \n   * @param {所有数据} obj \n   * @param {需要传出的参数keys} arrayString \n   */\n  const ArrayToObject = (obj,arrayString) => {\n    arrayString.forEach(item => {\n      formData.append(toStringValue(item), toStringValue(obj[toStringValue(item)]));\n    })\n  }\n  \n  /**\n   * 判断是否需要增加key\n   */\n  if(isString(requestFileKeys) || isArray(requestFileKeys)){\n    let requestFileKeysFile = ['uid','type','name','lastModifiedDate'];\n    if(isString(requestFileKeys)){\n      requestFileKeysFile.push(requestFileKeys);\n    }else{\n      requestFileKeysFile = [...requestFileKeysFile,...requestFileKeys]\n    }\n    ArrayToObject(option.file,requestFileKeysFile)\n  }\n  return formData\n}\nexport default function upload(option) {\n  const xhr = new XMLHttpRequest();\n\n  if (option.onProgress && xhr.upload) {\n    xhr.upload.onprogress = function progress(e) {\n      if (e.total > 0) {\n        e.percent = e.loaded / e.total * 100;\n      }\n      option.onProgress(e);\n    };\n  }\n\n\n  const formData =  requestFileFormData(option.requestFileKeys,option)\n\n\n  xhr.onerror = function error(e) {\n    option.onError(e);\n  };\n\n  xhr.onload = function onload() {\n    // allow success when 2xx status\n    // see https://github.com/react-component/upload/issues/34\n    if (xhr.status < 200 || xhr.status >= 300) {\n      return option.onError(getError(option, xhr), getBody(xhr));\n    }\n\n    option.onSuccess(getBody(xhr), xhr);\n  };\n\n\n  xhr.open('post', option.action, true);\n\n  // Has to be after `.open()`. See https://github.com/enyo/dropzone/issues/179\n  if (option.withCredentials && 'withCredentials' in xhr) {\n    xhr.withCredentials = true;\n  }\n\n  const headers = option.headers || {};\n\n  // when set headers['X-Requested-With'] = null , can close default XHR header\n  // see https://github.com/react-component/upload/issues/33\n  if (headers['X-Requested-With'] !== null) {\n    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');\n  }\n\n  for (const h in headers) {\n    if (headers.hasOwnProperty(h) && headers[h] !== null) {\n      xhr.setRequestHeader(h, headers[h]);\n    }\n  }\n  xhr.send(formData);\n\n  return {\n    abort() {\n      xhr.abort();\n    },\n  };\n}\n"]}