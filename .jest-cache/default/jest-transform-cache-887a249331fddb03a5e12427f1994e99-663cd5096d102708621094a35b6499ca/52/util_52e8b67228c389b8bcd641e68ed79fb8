f1788fe458535249125208d0242abad0
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.arrDel = arrDel;
exports.arrAdd = arrAdd;
exports.posToArr = posToArr;
exports.getPosition = getPosition;
exports.isTreeNode = isTreeNode;
exports.getDragNodesKeys = getDragNodesKeys;
exports.calcDropPosition = calcDropPosition;
exports.calcSelectedKeys = calcSelectedKeys;
exports.convertDataToTree = convertDataToTree;
exports.parseCheckedKeys = parseCheckedKeys;
exports.conductExpandParent = conductExpandParent;
exports.getDataAndAria = getDataAndAria;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireDefault(require("react"));

var _warning = _interopRequireDefault(require("../../_util/warning"));

var _TreeNode = _interopRequireDefault(require("./TreeNode"));
/**
 * Legacy code. Should avoid to use if you are new to import these code.
 */
// @ts-ignore


var DRAG_SIDE_RANGE = 0.25;
var DRAG_MIN_GAP = 2;

function arrDel(list, value) {
  var clone = list.slice();
  var index = clone.indexOf(value);

  if (index >= 0) {
    clone.splice(index, 1);
  }

  return clone;
}

function arrAdd(list, value) {
  var clone = list.slice();

  if (clone.indexOf(value) === -1) {
    clone.push(value);
  }

  return clone;
}

function posToArr(pos) {
  return pos.split('-');
}

function getPosition(level, index) {
  return "".concat(level, "-").concat(index);
}

function isTreeNode(node) {
  return node && node.type && node.type.isTreeNode;
}

function getDragNodesKeys(dragNodeKey, keyEntities) {
  var dragNodesKeys = [dragNodeKey];
  var entity = keyEntities[dragNodeKey];

  function dig() {
    var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
    list.forEach(function (_ref) {
      var key = _ref.key,
          children = _ref.children;
      dragNodesKeys.push(key);
      dig(children);
    });
  }

  dig(entity.children);
  return dragNodesKeys;
} // Only used when drag, not affect SSR.


function calcDropPosition(event, treeNode) {
  var clientY = event.clientY;

  var _treeNode$selectHandl = treeNode.selectHandle.getBoundingClientRect(),
      top = _treeNode$selectHandl.top,
      bottom = _treeNode$selectHandl.bottom,
      height = _treeNode$selectHandl.height;

  var des = Math.max(height * DRAG_SIDE_RANGE, DRAG_MIN_GAP);

  if (clientY <= top + des) {
    return -1;
  }

  if (clientY >= bottom - des) {
    return 1;
  }

  return 0;
}
/**
 * Return selectedKeys according with multiple prop
 * @param selectedKeys
 * @param props
 * @returns [string]
 */


function calcSelectedKeys(selectedKeys, props) {
  if (!selectedKeys) return undefined;
  var multiple = props.multiple;

  if (multiple) {
    return selectedKeys.slice();
  }

  if (selectedKeys.length) {
    return [selectedKeys[0]];
  }

  return selectedKeys;
}

var internalProcessProps = function internalProcessProps(props) {
  return props;
};

function convertDataToTree(treeData, processor) {
  if (!treeData) return [];

  var _ref2 = processor || {},
      _ref2$processProps = _ref2.processProps,
      processProps = _ref2$processProps === void 0 ? internalProcessProps : _ref2$processProps;

  var list = Array.isArray(treeData) ? treeData : [treeData];
  return list.map(function (_ref3) {
    var children = _ref3.children,
        props = (0, _objectWithoutProperties2["default"])(_ref3, ["children"]);
    var childrenNodes = convertDataToTree(children, processor); // @ts-ignore
    // eslint-disable-next-line react/jsx-key

    return _react["default"].createElement(_TreeNode["default"], (0, _extends2["default"])({}, processProps(props)), childrenNodes);
  });
}
/**
 * Parse `checkedKeys` to { checkedKeys, halfCheckedKeys } style
 */


function parseCheckedKeys(keys) {
  if (!keys) {
    return null;
  } // Convert keys to object format


  var keyProps;

  if (Array.isArray(keys)) {
    // [Legacy] Follow the api doc
    keyProps = {
      checkedKeys: keys,
      halfCheckedKeys: undefined
    };
  } else if ((0, _typeof2["default"])(keys) === 'object') {
    keyProps = {
      checkedKeys: keys.checked || undefined,
      halfCheckedKeys: keys.halfChecked || undefined
    };
  } else {
    (0, _warning["default"])(false, '`checkedKeys` is not an array or an object');
    return null;
  }

  return keyProps;
}
/**
 * If user use `autoExpandParent` we should get the list of parent node
 * @param keyList
 * @param keyEntities
 */


function conductExpandParent(keyList, keyEntities) {
  var expandedKeys = {};

  function conductUp(key) {
    if (expandedKeys[key]) return;
    var entity = keyEntities[key];
    if (!entity) return;
    expandedKeys[key] = true;
    var parent = entity.parent,
        node = entity.node;
    if (node.disabled) return;

    if (parent) {
      conductUp(parent.key);
    }
  }

  (keyList || []).forEach(function (key) {
    conductUp(key);
  });
  return Object.keys(expandedKeys);
}
/**
 * Returns only the data- and aria- key/value pairs
 */


function getDataAndAria(props) {
  var omitProps = {};
  Object.keys(props).forEach(function (key) {
    if (key.startsWith('data-') || key.startsWith('aria-')) {
      omitProps[key] = props[key];
    }
  });
  return omitProps;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJjLWNvbXBvbmVudHMvdHJlZS91dGlsLmpzIl0sIm5hbWVzIjpbIkRSQUdfU0lERV9SQU5HRSIsIkRSQUdfTUlOX0dBUCIsImNsb25lIiwibGlzdCIsImluZGV4IiwicG9zIiwibm9kZSIsImRyYWdOb2Rlc0tleXMiLCJlbnRpdHkiLCJrZXlFbnRpdGllcyIsImtleSIsImNoaWxkcmVuIiwiZGlnIiwiY2xpZW50WSIsImV2ZW50IiwidG9wIiwiYm90dG9tIiwiaGVpZ2h0IiwidHJlZU5vZGUiLCJkZXMiLCJNYXRoIiwibXVsdGlwbGUiLCJwcm9wcyIsInNlbGVjdGVkS2V5cyIsImludGVybmFsUHJvY2Vzc1Byb3BzIiwicHJvY2Vzc1Byb3BzIiwicHJvY2Vzc29yIiwiQXJyYXkiLCJjaGlsZHJlbk5vZGVzIiwiY29udmVydERhdGFUb1RyZWUiLCJSZWFjdCIsIlRyZWVOb2RlIiwia2V5UHJvcHMiLCJjaGVja2VkS2V5cyIsImhhbGZDaGVja2VkS2V5cyIsInVuZGVmaW5lZCIsImtleXMiLCJleHBhbmRlZEtleXMiLCJwYXJlbnQiLCJjb25kdWN0VXAiLCJrZXlMaXN0IiwiT2JqZWN0Iiwib21pdFByb3BzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUdBLElBQUEsTUFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBOztBQUNBLElBQUEsUUFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLHFCQUFBLENBQUEsQ0FBQTs7QUFFQSxJQUFBLFNBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtBQU5BOzs7QUFLQTs7O0FBRUEsSUFBTUEsZUFBZSxHQUFyQixJQUFBO0FBQ0EsSUFBTUMsWUFBWSxHQUFsQixDQUFBOztBQUNPLFNBQUEsTUFBQSxDQUFBLElBQUEsRUFBQSxLQUFBLEVBQTZCO0FBQ2hDLE1BQU1DLEtBQUssR0FBR0MsSUFBSSxDQUFsQixLQUFjQSxFQUFk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QWhCLEVBQ0k7QUFDSixRQUFNN0IsTUFBTSxHQUFHQyxXQUFXLENBQTFCLEdBQTBCLENBQTFCO0FBQ0EsUUFBSSxDQUFKLE1BQUEsRUFDSTtBQUNKNEIsSUFBQUEsWUFBWSxDQUFaQSxHQUFZLENBQVpBLEdBQUFBLElBQUFBO0FBTm9CLFFBT1pDLE1BUFksR0FPSzlCLE1BUEwsQ0FBQSxNQUFBO0FBQUEsUUFPSkYsSUFQSSxHQU9LRSxNQVBMLENBQUEsSUFBQTtBQVFwQixRQUFJRixJQUFJLENBQVIsUUFBQSxFQUNJOztBQUNKLFFBQUEsTUFBQSxFQUFZO0FBQ1JpQyxNQUFBQSxTQUFTLENBQUNELE1BQU0sQ0FBaEJDLEdBQVMsQ0FBVEE7QUFDSDtBQUNKOztBQUNELEdBQUNDLE9BQU8sSUFBUixFQUFBLEVBQUEsT0FBQSxDQUF3QixVQUFBLEdBQUEsRUFBTztBQUMzQkQsSUFBQUEsU0FBUyxDQUFUQSxHQUFTLENBQVRBO0FBREosR0FBQTtBQUdBLFNBQU9FLE1BQU0sQ0FBTkEsSUFBQUEsQ0FBUCxZQUFPQSxDQUFQO0FBQ0g7QUFDRDs7Ozs7QUFHTyxTQUFBLGNBQUEsQ0FBQSxLQUFBLEVBQStCO0FBQ2xDLE1BQU1DLFNBQVMsR0FBZixFQUFBO0FBQ0FELEVBQUFBLE1BQU0sQ0FBTkEsSUFBQUEsQ0FBQUEsS0FBQUEsRUFBQUEsT0FBQUEsQ0FBMkIsVUFBQSxHQUFBLEVBQU87QUFDOUIsUUFBSS9CLEdBQUcsQ0FBSEEsVUFBQUEsQ0FBQUEsT0FBQUEsS0FBMkJBLEdBQUcsQ0FBSEEsVUFBQUEsQ0FBL0IsT0FBK0JBLENBQS9CLEVBQXdEO0FBQ3BEZ0MsTUFBQUEsU0FBUyxDQUFUQSxHQUFTLENBQVRBLEdBQWlCcEIsS0FBSyxDQUF0Qm9CLEdBQXNCLENBQXRCQTtBQUNIO0FBSExELEdBQUFBO0FBS0EsU0FBQSxTQUFBO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIExlZ2FjeSBjb2RlLiBTaG91bGQgYXZvaWQgdG8gdXNlIGlmIHlvdSBhcmUgbmV3IHRvIGltcG9ydCB0aGVzZSBjb2RlLlxuICovXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHdhcm5pbmcgZnJvbSAnLi4vLi4vX3V0aWwvd2FybmluZyc7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgVHJlZU5vZGUgZnJvbSAnLi9UcmVlTm9kZSc7XG5jb25zdCBEUkFHX1NJREVfUkFOR0UgPSAwLjI1O1xuY29uc3QgRFJBR19NSU5fR0FQID0gMjtcbmV4cG9ydCBmdW5jdGlvbiBhcnJEZWwobGlzdCwgdmFsdWUpIHtcbiAgICBjb25zdCBjbG9uZSA9IGxpc3Quc2xpY2UoKTtcbiAgICBjb25zdCBpbmRleCA9IGNsb25lLmluZGV4T2YodmFsdWUpO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgIGNsb25lLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICAgIHJldHVybiBjbG9uZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBhcnJBZGQobGlzdCwgdmFsdWUpIHtcbiAgICBjb25zdCBjbG9uZSA9IGxpc3Quc2xpY2UoKTtcbiAgICBpZiAoY2xvbmUuaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7XG4gICAgICAgIGNsb25lLnB1c2godmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gY2xvbmU7XG59XG5leHBvcnQgZnVuY3Rpb24gcG9zVG9BcnIocG9zKSB7XG4gICAgcmV0dXJuIHBvcy5zcGxpdCgnLScpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFBvc2l0aW9uKGxldmVsLCBpbmRleCkge1xuICAgIHJldHVybiBgJHtsZXZlbH0tJHtpbmRleH1gO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGlzVHJlZU5vZGUobm9kZSkge1xuICAgIHJldHVybiBub2RlICYmIG5vZGUudHlwZSAmJiBub2RlLnR5cGUuaXNUcmVlTm9kZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXREcmFnTm9kZXNLZXlzKGRyYWdOb2RlS2V5LCBrZXlFbnRpdGllcykge1xuICAgIGNvbnN0IGRyYWdOb2Rlc0tleXMgPSBbZHJhZ05vZGVLZXldO1xuICAgIGNvbnN0IGVudGl0eSA9IGtleUVudGl0aWVzW2RyYWdOb2RlS2V5XTtcbiAgICBmdW5jdGlvbiBkaWcobGlzdCA9IFtdKSB7XG4gICAgICAgIGxpc3QuZm9yRWFjaCgoeyBrZXksIGNoaWxkcmVuIH0pID0+IHtcbiAgICAgICAgICAgIGRyYWdOb2Rlc0tleXMucHVzaChrZXkpO1xuICAgICAgICAgICAgZGlnKGNoaWxkcmVuKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGRpZyhlbnRpdHkuY2hpbGRyZW4pO1xuICAgIHJldHVybiBkcmFnTm9kZXNLZXlzO1xufVxuLy8gT25seSB1c2VkIHdoZW4gZHJhZywgbm90IGFmZmVjdCBTU1IuXG5leHBvcnQgZnVuY3Rpb24gY2FsY0Ryb3BQb3NpdGlvbihldmVudCwgdHJlZU5vZGUpIHtcbiAgICBjb25zdCB7IGNsaWVudFkgfSA9IGV2ZW50O1xuICAgIGNvbnN0IHsgdG9wLCBib3R0b20sIGhlaWdodCB9ID0gdHJlZU5vZGUuc2VsZWN0SGFuZGxlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IGRlcyA9IE1hdGgubWF4KGhlaWdodCAqIERSQUdfU0lERV9SQU5HRSwgRFJBR19NSU5fR0FQKTtcbiAgICBpZiAoY2xpZW50WSA8PSB0b3AgKyBkZXMpIHtcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgIH1cbiAgICBpZiAoY2xpZW50WSA+PSBib3R0b20gLSBkZXMpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIHJldHVybiAwO1xufVxuLyoqXG4gKiBSZXR1cm4gc2VsZWN0ZWRLZXlzIGFjY29yZGluZyB3aXRoIG11bHRpcGxlIHByb3BcbiAqIEBwYXJhbSBzZWxlY3RlZEtleXNcbiAqIEBwYXJhbSBwcm9wc1xuICogQHJldHVybnMgW3N0cmluZ11cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGNTZWxlY3RlZEtleXMoc2VsZWN0ZWRLZXlzLCBwcm9wcykge1xuICAgIGlmICghc2VsZWN0ZWRLZXlzKVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGNvbnN0IHsgbXVsdGlwbGUgfSA9IHByb3BzO1xuICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICByZXR1cm4gc2VsZWN0ZWRLZXlzLnNsaWNlKCk7XG4gICAgfVxuICAgIGlmIChzZWxlY3RlZEtleXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBbc2VsZWN0ZWRLZXlzWzBdXTtcbiAgICB9XG4gICAgcmV0dXJuIHNlbGVjdGVkS2V5cztcbn1cbmNvbnN0IGludGVybmFsUHJvY2Vzc1Byb3BzID0gKHByb3BzKSA9PiBwcm9wcztcbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0RGF0YVRvVHJlZSh0cmVlRGF0YSwgcHJvY2Vzc29yKSB7XG4gICAgaWYgKCF0cmVlRGF0YSlcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIGNvbnN0IHsgcHJvY2Vzc1Byb3BzID0gaW50ZXJuYWxQcm9jZXNzUHJvcHMgfSA9IHByb2Nlc3NvciB8fCB7fTtcbiAgICBjb25zdCBsaXN0ID0gQXJyYXkuaXNBcnJheSh0cmVlRGF0YSkgPyB0cmVlRGF0YSA6IFt0cmVlRGF0YV07XG4gICAgcmV0dXJuIGxpc3QubWFwKCh7IGNoaWxkcmVuLCAuLi5wcm9wcyB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGNoaWxkcmVuTm9kZXMgPSBjb252ZXJ0RGF0YVRvVHJlZShjaGlsZHJlbiwgcHJvY2Vzc29yKTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QvanN4LWtleVxuICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChUcmVlTm9kZSwgT2JqZWN0LmFzc2lnbih7fSwgcHJvY2Vzc1Byb3BzKHByb3BzKSksIGNoaWxkcmVuTm9kZXMpO1xuICAgIH0pO1xufVxuLyoqXG4gKiBQYXJzZSBgY2hlY2tlZEtleXNgIHRvIHsgY2hlY2tlZEtleXMsIGhhbGZDaGVja2VkS2V5cyB9IHN0eWxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUNoZWNrZWRLZXlzKGtleXMpIHtcbiAgICBpZiAoIWtleXMpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIC8vIENvbnZlcnQga2V5cyB0byBvYmplY3QgZm9ybWF0XG4gICAgbGV0IGtleVByb3BzO1xuICAgIGlmIChBcnJheS5pc0FycmF5KGtleXMpKSB7XG4gICAgICAgIC8vIFtMZWdhY3ldIEZvbGxvdyB0aGUgYXBpIGRvY1xuICAgICAgICBrZXlQcm9wcyA9IHtcbiAgICAgICAgICAgIGNoZWNrZWRLZXlzOiBrZXlzLFxuICAgICAgICAgICAgaGFsZkNoZWNrZWRLZXlzOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBrZXlzID09PSAnb2JqZWN0Jykge1xuICAgICAgICBrZXlQcm9wcyA9IHtcbiAgICAgICAgICAgIGNoZWNrZWRLZXlzOiBrZXlzLmNoZWNrZWQgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgaGFsZkNoZWNrZWRLZXlzOiBrZXlzLmhhbGZDaGVja2VkIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHdhcm5pbmcoZmFsc2UsICdgY2hlY2tlZEtleXNgIGlzIG5vdCBhbiBhcnJheSBvciBhbiBvYmplY3QnKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBrZXlQcm9wcztcbn1cbi8qKlxuICogSWYgdXNlciB1c2UgYGF1dG9FeHBhbmRQYXJlbnRgIHdlIHNob3VsZCBnZXQgdGhlIGxpc3Qgb2YgcGFyZW50IG5vZGVcbiAqIEBwYXJhbSBrZXlMaXN0XG4gKiBAcGFyYW0ga2V5RW50aXRpZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvbmR1Y3RFeHBhbmRQYXJlbnQoa2V5TGlzdCwga2V5RW50aXRpZXMpIHtcbiAgICBjb25zdCBleHBhbmRlZEtleXMgPSB7fTtcbiAgICBmdW5jdGlvbiBjb25kdWN0VXAoa2V5KSB7XG4gICAgICAgIGlmIChleHBhbmRlZEtleXNba2V5XSlcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgY29uc3QgZW50aXR5ID0ga2V5RW50aXRpZXNba2V5XTtcbiAgICAgICAgaWYgKCFlbnRpdHkpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIGV4cGFuZGVkS2V5c1trZXldID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgeyBwYXJlbnQsIG5vZGUgfSA9IGVudGl0eTtcbiAgICAgICAgaWYgKG5vZGUuZGlzYWJsZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICAgIGNvbmR1Y3RVcChwYXJlbnQua2V5KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAoa2V5TGlzdCB8fCBbXSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBjb25kdWN0VXAoa2V5KTtcbiAgICB9KTtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMoZXhwYW5kZWRLZXlzKTtcbn1cbi8qKlxuICogUmV0dXJucyBvbmx5IHRoZSBkYXRhLSBhbmQgYXJpYS0ga2V5L3ZhbHVlIHBhaXJzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXREYXRhQW5kQXJpYShwcm9wcykge1xuICAgIGNvbnN0IG9taXRQcm9wcyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnZGF0YS0nKSB8fCBrZXkuc3RhcnRzV2l0aCgnYXJpYS0nKSkge1xuICAgICAgICAgICAgb21pdFByb3BzW2tleV0gPSBwcm9wc1trZXldO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIG9taXRQcm9wcztcbn1cbiJdfQ==