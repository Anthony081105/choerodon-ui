440ec52aa2cb70a22d1b84a6df7b2db7
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isCheckDisabled = isCheckDisabled;
exports.conductCheck = conductCheck;

var _warning = _interopRequireDefault(require("rc-util/lib/warning")); // @ts-nocheck

/* eslint-disable */


function removeFromCheckedKeys(halfCheckedKeys, checkedKeys) {
  var filteredKeys = new Set();
  halfCheckedKeys.forEach(function (key) {
    if (!checkedKeys.has(key)) {
      filteredKeys.add(key);
    }
  });
  return filteredKeys;
}

function isCheckDisabled(node) {
  var _ref = node || {},
      disabled = _ref.disabled,
      disableCheckbox = _ref.disableCheckbox,
      checkable = _ref.checkable;

  return !!(disabled || disableCheckbox) || checkable === false;
} // Fill miss keys


function fillConductCheck(keys, levelEntities, maxLevel) {
  var checkedKeys = new Set(keys);
  var halfCheckedKeys = new Set(); // Add checked keys top to bottom

  for (var level = 0; level <= maxLevel; level += 1) {
    var entities = levelEntities.get(level) || new Set();
    entities.forEach(function (entity) {
      var key = entity.key,
          node = entity.node,
          _entity$children = entity.children,
          children = _entity$children === void 0 ? [] : _entity$children;

      if (checkedKeys.has(key) && !isCheckDisabled(node)) {
        children.filter(function (childEntity) {
          return !isCheckDisabled(childEntity.node);
        }).forEach(function (childEntity) {
          checkedKeys.add(childEntity.key);
        });
      }
    });
  } // Add checked keys from bottom to top


  var visitedKeys = new Set();

  for (var _level = maxLevel; _level >= 0; _level -= 1) {
    var _entities = levelEntities.get(_level) || new Set();

    _entities.forEach(function (entity) {
      var parent = entity.parent,
          node = entity.node; // Skip if no need to check

      if (isCheckDisabled(node) || !entity.parent || visitedKeys.has(entity.parent.key)) {
        return;
      } // Skip if parent is disabled


      if (isCheckDisabled(entity.parent.node)) {
        visitedKeys.add(parent.key);
        return;
      }

      var allChecked = true;
      var partialChecked = false;
      (parent.children || []).filter(function (childEntity) {
        return !isCheckDisabled(childEntity.node);
      }).forEach(function (_ref2) {
        var key = _ref2.key;
        var checked = checkedKeys.has(key);

        if (allChecked && !checked) {
          allChecked = false;
        }

        if (!partialChecked && (checked || halfCheckedKeys.has(key))) {
          partialChecked = true;
        }
      });

      if (allChecked) {
        checkedKeys.add(parent.key);
      }

      if (partialChecked) {
        halfCheckedKeys.add(parent.key);
      }

      visitedKeys.add(parent.key);
    });
  }

  return {
    checkedKeys: Array.from(checkedKeys),
    halfCheckedKeys: Array.from(removeFromCheckedKeys(halfCheckedKeys, checkedKeys))
  };
} // Remove useless key


function cleanConductCheck(keys, halfKeys, levelEntities, maxLevel) {
  var checkedKeys = new Set(keys);
  var halfCheckedKeys = new Set(halfKeys); // Remove checked keys from top to bottom

  for (var level = 0; level <= maxLevel; level += 1) {
    var entities = levelEntities.get(level) || new Set();
    entities.forEach(function (entity) {
      var key = entity.key,
          node = entity.node,
          _entity$children2 = entity.children,
          children = _entity$children2 === void 0 ? [] : _entity$children2;

      if (!checkedKeys.has(key) && !halfCheckedKeys.has(key) && !isCheckDisabled(node)) {
        children.filter(function (childEntity) {
          return !isCheckDisabled(childEntity.node);
        }).forEach(function (childEntity) {
          checkedKeys["delete"](childEntity.key);
        });
      }
    });
  } // Remove checked keys form bottom to top


  halfCheckedKeys = new Set();
  var visitedKeys = new Set();

  for (var _level2 = maxLevel; _level2 >= 0; _level2 -= 1) {
    var _entities2 = levelEntities.get(_level2) || new Set();

    _entities2.forEach(function (entity) {
      var parent = entity.parent,
          node = entity.node; // Skip if no need to check

      if (isCheckDisabled(node) || !entity.parent || visitedKeys.has(entity.parent.key)) {
        return;
      } // Skip if parent is disabled


      if (isCheckDisabled(entity.parent.node)) {
        visitedKeys.add(parent.key);
        return;
      }

      var allChecked = true;
      var partialChecked = false;
      (parent.children || []).filter(function (childEntity) {
        return !isCheckDisabled(childEntity.node);
      }).forEach(function (_ref3) {
        var key = _ref3.key;
        var checked = checkedKeys.has(key);

        if (allChecked && !checked) {
          allChecked = false;
        }

        if (!partialChecked && (checked || halfCheckedKeys.has(key))) {
          partialChecked = true;
        }
      });

      if (!allChecked) {
        checkedKeys["delete"](parent.key);
      }

      if (partialChecked) {
        halfCheckedKeys.add(parent.key);
      }

      visitedKeys.add(parent.key);
    });
  }

  return {
    checkedKeys: Array.from(checkedKeys),
    halfCheckedKeys: Array.from(removeFromCheckedKeys(halfCheckedKeys, checkedKeys))
  };
}
/**
 * Conduct with keys.
 * @param keyList current key list
 * @param keyEntities key - dataEntity map
 * @param mode `fill` to fill missing key, `clean` to remove useless key
 */


function conductCheck(keyList, checked, keyEntities) {
  var warningMissKeys = []; // We only handle exist keys

  var keys = new Set(keyList.filter(function (key) {
    var hasEntity = !!keyEntities[key];

    if (!hasEntity) {
      warningMissKeys.push(key);
    }

    return hasEntity;
  }));
  var levelEntities = new Map();
  var maxLevel = 0; // Convert entities by level for calculation

  Object.keys(keyEntities).forEach(function (key) {
    var entity = keyEntities[key];
    var level = entity.level;
    var levelSet = levelEntities.get(level);

    if (!levelSet) {
      levelSet = new Set();
      levelEntities.set(level, levelSet);
    }

    levelSet.add(entity);
    maxLevel = Math.max(maxLevel, level);
  });
  (0, _warning["default"])(!warningMissKeys.length, "Tree missing follow keys: ".concat(warningMissKeys.slice(0, 100).map(function (key) {
    return "'".concat(key, "'");
  }).join(', ')));
  var result;

  if (checked === true) {
    result = fillConductCheck(keys, levelEntities, maxLevel);
  } else {
    result = cleanConductCheck(keys, checked.halfCheckedKeys, levelEntities, maxLevel);
  }

  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJjLWNvbXBvbmVudHMvdHJlZS91dGlscy9jb25kdWN0VXRpbC5qcyJdLCJuYW1lcyI6WyJmaWx0ZXJlZEtleXMiLCJoYWxmQ2hlY2tlZEtleXMiLCJjaGVja2VkS2V5cyIsImRpc2FibGVkIiwiZGlzYWJsZUNoZWNrYm94IiwiY2hlY2thYmxlIiwibm9kZSIsImxldmVsIiwiZW50aXRpZXMiLCJsZXZlbEVudGl0aWVzIiwia2V5IiwiY2hpbGRyZW4iLCJlbnRpdHkiLCJpc0NoZWNrRGlzYWJsZWQiLCJjaGlsZEVudGl0eSIsInZpc2l0ZWRLZXlzIiwicGFyZW50IiwiYWxsQ2hlY2tlZCIsInBhcnRpYWxDaGVja2VkIiwiY2hlY2tlZCIsIkFycmF5IiwicmVtb3ZlRnJvbUNoZWNrZWRLZXlzIiwid2FybmluZ01pc3NLZXlzIiwia2V5cyIsImhhc0VudGl0eSIsImtleUVudGl0aWVzIiwibWF4TGV2ZWwiLCJPYmplY3QiLCJsZXZlbFNldCIsIk1hdGgiLCJyZXN1bHQiLCJmaWxsQ29uZHVjdENoZWNrIiwiY2xlYW5Db25kdWN0Q2hlY2siXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFFQSxJQUFBLFFBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxxQkFBQSxDQUFBLENBQUEsQyxDQUZBOztBQUNBOzs7QUFFQSxTQUFBLHFCQUFBLENBQUEsZUFBQSxFQUFBLFdBQUEsRUFBNkQ7QUFDekQsTUFBTUEsWUFBWSxHQUFHLElBQXJCLEdBQXFCLEVBQXJCO0FBQ0FDLEVBQUFBLGVBQWUsQ0FBZkEsT0FBQUEsQ0FBd0IsVUFBQSxHQUFBLEVBQU87QUFDM0IsUUFBSSxDQUFDQyxXQUFXLENBQVhBLEdBQUFBLENBQUwsR0FBS0EsQ0FBTCxFQUEyQjtBQUN2QkYsTUFBQUEsWUFBWSxDQUFaQSxHQUFBQSxDQUFBQSxHQUFBQTtBQUNIO0FBSExDLEdBQUFBO0FBS0EsU0FBQSxZQUFBO0FBQ0g7O0FBQ00sU0FBQSxlQUFBLENBQUEsSUFBQSxFQUErQjtBQUFBLE1BQUEs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RCxJQUE4RCxDQUE5RCxDQUFBO0FBSUEsTUFBQSxNQUFBOztBQUNBLE1BQUlILE9BQU8sS0FBWCxJQUFBLEVBQXNCO0FBQ2xCVyxJQUFBQSxNQUFNLEdBQUdDLGdCQUFnQixDQUFBLElBQUEsRUFBQSxhQUFBLEVBQXpCRCxRQUF5QixDQUF6QkE7QUFESixHQUFBLE1BR0s7QUFDREEsSUFBQUEsTUFBTSxHQUFHRSxpQkFBaUIsQ0FBQSxJQUFBLEVBQU9iLE9BQU8sQ0FBZCxlQUFBLEVBQUEsYUFBQSxFQUExQlcsUUFBMEIsQ0FBMUJBO0FBQ0g7O0FBQ0QsU0FBQSxNQUFBO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtbm9jaGVja1xuLyogZXNsaW50LWRpc2FibGUgKi9cbmltcG9ydCB3YXJuaW5nIGZyb20gJ3JjLXV0aWwvbGliL3dhcm5pbmcnO1xuZnVuY3Rpb24gcmVtb3ZlRnJvbUNoZWNrZWRLZXlzKGhhbGZDaGVja2VkS2V5cywgY2hlY2tlZEtleXMpIHtcbiAgICBjb25zdCBmaWx0ZXJlZEtleXMgPSBuZXcgU2V0KCk7XG4gICAgaGFsZkNoZWNrZWRLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgaWYgKCFjaGVja2VkS2V5cy5oYXMoa2V5KSkge1xuICAgICAgICAgICAgZmlsdGVyZWRLZXlzLmFkZChrZXkpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGZpbHRlcmVkS2V5cztcbn1cbmV4cG9ydCBmdW5jdGlvbiBpc0NoZWNrRGlzYWJsZWQobm9kZSkge1xuICAgIGNvbnN0IHsgZGlzYWJsZWQsIGRpc2FibGVDaGVja2JveCwgY2hlY2thYmxlIH0gPSAobm9kZSB8fCB7fSk7XG4gICAgcmV0dXJuICEhKGRpc2FibGVkIHx8IGRpc2FibGVDaGVja2JveCkgfHwgY2hlY2thYmxlID09PSBmYWxzZTtcbn1cbi8vIEZpbGwgbWlzcyBrZXlzXG5mdW5jdGlvbiBmaWxsQ29uZHVjdENoZWNrKGtleXMsIGxldmVsRW50aXRpZXMsIG1heExldmVsKSB7XG4gICAgY29uc3QgY2hlY2tlZEtleXMgPSBuZXcgU2V0KGtleXMpO1xuICAgIGNvbnN0IGhhbGZDaGVja2VkS2V5cyA9IG5ldyBTZXQoKTtcbiAgICAvLyBBZGQgY2hlY2tlZCBrZXlzIHRvcCB0byBib3R0b21cbiAgICBmb3IgKGxldCBsZXZlbCA9IDA7IGxldmVsIDw9IG1heExldmVsOyBsZXZlbCArPSAxKSB7XG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gbGV2ZWxFbnRpdGllcy5nZXQobGV2ZWwpIHx8IG5ldyBTZXQoKTtcbiAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlbnRpdHkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBrZXksIG5vZGUsIGNoaWxkcmVuID0gW10gfSA9IGVudGl0eTtcbiAgICAgICAgICAgIGlmIChjaGVja2VkS2V5cy5oYXMoa2V5KSAmJiAhaXNDaGVja0Rpc2FibGVkKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgY2hpbGRyZW5cbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihjaGlsZEVudGl0eSA9PiAhaXNDaGVja0Rpc2FibGVkKGNoaWxkRW50aXR5Lm5vZGUpKVxuICAgICAgICAgICAgICAgICAgICAuZm9yRWFjaChjaGlsZEVudGl0eSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrZWRLZXlzLmFkZChjaGlsZEVudGl0eS5rZXkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gQWRkIGNoZWNrZWQga2V5cyBmcm9tIGJvdHRvbSB0byB0b3BcbiAgICBjb25zdCB2aXNpdGVkS2V5cyA9IG5ldyBTZXQoKTtcbiAgICBmb3IgKGxldCBsZXZlbCA9IG1heExldmVsOyBsZXZlbCA+PSAwOyBsZXZlbCAtPSAxKSB7XG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gbGV2ZWxFbnRpdGllcy5nZXQobGV2ZWwpIHx8IG5ldyBTZXQoKTtcbiAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlbnRpdHkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBwYXJlbnQsIG5vZGUgfSA9IGVudGl0eTtcbiAgICAgICAgICAgIC8vIFNraXAgaWYgbm8gbmVlZCB0byBjaGVja1xuICAgICAgICAgICAgaWYgKGlzQ2hlY2tEaXNhYmxlZChub2RlKSB8fCAhZW50aXR5LnBhcmVudCB8fCB2aXNpdGVkS2V5cy5oYXMoZW50aXR5LnBhcmVudC5rZXkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gU2tpcCBpZiBwYXJlbnQgaXMgZGlzYWJsZWRcbiAgICAgICAgICAgIGlmIChpc0NoZWNrRGlzYWJsZWQoZW50aXR5LnBhcmVudC5ub2RlKSkge1xuICAgICAgICAgICAgICAgIHZpc2l0ZWRLZXlzLmFkZChwYXJlbnQua2V5KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgYWxsQ2hlY2tlZCA9IHRydWU7XG4gICAgICAgICAgICBsZXQgcGFydGlhbENoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIChwYXJlbnQuY2hpbGRyZW4gfHwgW10pXG4gICAgICAgICAgICAgICAgLmZpbHRlcihjaGlsZEVudGl0eSA9PiAhaXNDaGVja0Rpc2FibGVkKGNoaWxkRW50aXR5Lm5vZGUpKVxuICAgICAgICAgICAgICAgIC5mb3JFYWNoKCh7IGtleSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hlY2tlZCA9IGNoZWNrZWRLZXlzLmhhcyhrZXkpO1xuICAgICAgICAgICAgICAgIGlmIChhbGxDaGVja2VkICYmICFjaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbENoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwYXJ0aWFsQ2hlY2tlZCAmJiAoY2hlY2tlZCB8fCBoYWxmQ2hlY2tlZEtleXMuaGFzKGtleSkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpYWxDaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChhbGxDaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgY2hlY2tlZEtleXMuYWRkKHBhcmVudC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhcnRpYWxDaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgaGFsZkNoZWNrZWRLZXlzLmFkZChwYXJlbnQua2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZpc2l0ZWRLZXlzLmFkZChwYXJlbnQua2V5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIGNoZWNrZWRLZXlzOiBBcnJheS5mcm9tKGNoZWNrZWRLZXlzKSxcbiAgICAgICAgaGFsZkNoZWNrZWRLZXlzOiBBcnJheS5mcm9tKHJlbW92ZUZyb21DaGVja2VkS2V5cyhoYWxmQ2hlY2tlZEtleXMsIGNoZWNrZWRLZXlzKSksXG4gICAgfTtcbn1cbi8vIFJlbW92ZSB1c2VsZXNzIGtleVxuZnVuY3Rpb24gY2xlYW5Db25kdWN0Q2hlY2soa2V5cywgaGFsZktleXMsIGxldmVsRW50aXRpZXMsIG1heExldmVsKSB7XG4gICAgY29uc3QgY2hlY2tlZEtleXMgPSBuZXcgU2V0KGtleXMpO1xuICAgIGxldCBoYWxmQ2hlY2tlZEtleXMgPSBuZXcgU2V0KGhhbGZLZXlzKTtcbiAgICAvLyBSZW1vdmUgY2hlY2tlZCBrZXlzIGZyb20gdG9wIHRvIGJvdHRvbVxuICAgIGZvciAobGV0IGxldmVsID0gMDsgbGV2ZWwgPD0gbWF4TGV2ZWw7IGxldmVsICs9IDEpIHtcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSBsZXZlbEVudGl0aWVzLmdldChsZXZlbCkgfHwgbmV3IFNldCgpO1xuICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGVudGl0eSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGtleSwgbm9kZSwgY2hpbGRyZW4gPSBbXSB9ID0gZW50aXR5O1xuICAgICAgICAgICAgaWYgKCFjaGVja2VkS2V5cy5oYXMoa2V5KSAmJiAhaGFsZkNoZWNrZWRLZXlzLmhhcyhrZXkpICYmICFpc0NoZWNrRGlzYWJsZWQobm9kZSkpIHtcbiAgICAgICAgICAgICAgICBjaGlsZHJlblxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGNoaWxkRW50aXR5ID0+ICFpc0NoZWNrRGlzYWJsZWQoY2hpbGRFbnRpdHkubm9kZSkpXG4gICAgICAgICAgICAgICAgICAgIC5mb3JFYWNoKGNoaWxkRW50aXR5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZEtleXMuZGVsZXRlKGNoaWxkRW50aXR5LmtleSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBSZW1vdmUgY2hlY2tlZCBrZXlzIGZvcm0gYm90dG9tIHRvIHRvcFxuICAgIGhhbGZDaGVja2VkS2V5cyA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCB2aXNpdGVkS2V5cyA9IG5ldyBTZXQoKTtcbiAgICBmb3IgKGxldCBsZXZlbCA9IG1heExldmVsOyBsZXZlbCA+PSAwOyBsZXZlbCAtPSAxKSB7XG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gbGV2ZWxFbnRpdGllcy5nZXQobGV2ZWwpIHx8IG5ldyBTZXQoKTtcbiAgICAgICAgZW50aXRpZXMuZm9yRWFjaChlbnRpdHkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBwYXJlbnQsIG5vZGUgfSA9IGVudGl0eTtcbiAgICAgICAgICAgIC8vIFNraXAgaWYgbm8gbmVlZCB0byBjaGVja1xuICAgICAgICAgICAgaWYgKGlzQ2hlY2tEaXNhYmxlZChub2RlKSB8fCAhZW50aXR5LnBhcmVudCB8fCB2aXNpdGVkS2V5cy5oYXMoZW50aXR5LnBhcmVudC5rZXkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gU2tpcCBpZiBwYXJlbnQgaXMgZGlzYWJsZWRcbiAgICAgICAgICAgIGlmIChpc0NoZWNrRGlzYWJsZWQoZW50aXR5LnBhcmVudC5ub2RlKSkge1xuICAgICAgICAgICAgICAgIHZpc2l0ZWRLZXlzLmFkZChwYXJlbnQua2V5KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgYWxsQ2hlY2tlZCA9IHRydWU7XG4gICAgICAgICAgICBsZXQgcGFydGlhbENoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIChwYXJlbnQuY2hpbGRyZW4gfHwgW10pXG4gICAgICAgICAgICAgICAgLmZpbHRlcihjaGlsZEVudGl0eSA9PiAhaXNDaGVja0Rpc2FibGVkKGNoaWxkRW50aXR5Lm5vZGUpKVxuICAgICAgICAgICAgICAgIC5mb3JFYWNoKCh7IGtleSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hlY2tlZCA9IGNoZWNrZWRLZXlzLmhhcyhrZXkpO1xuICAgICAgICAgICAgICAgIGlmIChhbGxDaGVja2VkICYmICFjaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbENoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwYXJ0aWFsQ2hlY2tlZCAmJiAoY2hlY2tlZCB8fCBoYWxmQ2hlY2tlZEtleXMuaGFzKGtleSkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRpYWxDaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICghYWxsQ2hlY2tlZCkge1xuICAgICAgICAgICAgICAgIGNoZWNrZWRLZXlzLmRlbGV0ZShwYXJlbnQua2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJ0aWFsQ2hlY2tlZCkge1xuICAgICAgICAgICAgICAgIGhhbGZDaGVja2VkS2V5cy5hZGQocGFyZW50LmtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2aXNpdGVkS2V5cy5hZGQocGFyZW50LmtleSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBjaGVja2VkS2V5czogQXJyYXkuZnJvbShjaGVja2VkS2V5cyksXG4gICAgICAgIGhhbGZDaGVja2VkS2V5czogQXJyYXkuZnJvbShyZW1vdmVGcm9tQ2hlY2tlZEtleXMoaGFsZkNoZWNrZWRLZXlzLCBjaGVja2VkS2V5cykpLFxuICAgIH07XG59XG4vKipcbiAqIENvbmR1Y3Qgd2l0aCBrZXlzLlxuICogQHBhcmFtIGtleUxpc3QgY3VycmVudCBrZXkgbGlzdFxuICogQHBhcmFtIGtleUVudGl0aWVzIGtleSAtIGRhdGFFbnRpdHkgbWFwXG4gKiBAcGFyYW0gbW9kZSBgZmlsbGAgdG8gZmlsbCBtaXNzaW5nIGtleSwgYGNsZWFuYCB0byByZW1vdmUgdXNlbGVzcyBrZXlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvbmR1Y3RDaGVjayhrZXlMaXN0LCBjaGVja2VkLCBrZXlFbnRpdGllcykge1xuICAgIGNvbnN0IHdhcm5pbmdNaXNzS2V5cyA9IFtdO1xuICAgIC8vIFdlIG9ubHkgaGFuZGxlIGV4aXN0IGtleXNcbiAgICBjb25zdCBrZXlzID0gbmV3IFNldChrZXlMaXN0LmZpbHRlcihrZXkgPT4ge1xuICAgICAgICBjb25zdCBoYXNFbnRpdHkgPSAhIWtleUVudGl0aWVzW2tleV07XG4gICAgICAgIGlmICghaGFzRW50aXR5KSB7XG4gICAgICAgICAgICB3YXJuaW5nTWlzc0tleXMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoYXNFbnRpdHk7XG4gICAgfSkpO1xuICAgIGNvbnN0IGxldmVsRW50aXRpZXMgPSBuZXcgTWFwKCk7XG4gICAgbGV0IG1heExldmVsID0gMDtcbiAgICAvLyBDb252ZXJ0IGVudGl0aWVzIGJ5IGxldmVsIGZvciBjYWxjdWxhdGlvblxuICAgIE9iamVjdC5rZXlzKGtleUVudGl0aWVzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IGtleUVudGl0aWVzW2tleV07XG4gICAgICAgIGNvbnN0IHsgbGV2ZWwgfSA9IGVudGl0eTtcbiAgICAgICAgbGV0IGxldmVsU2V0ID0gbGV2ZWxFbnRpdGllcy5nZXQobGV2ZWwpO1xuICAgICAgICBpZiAoIWxldmVsU2V0KSB7XG4gICAgICAgICAgICBsZXZlbFNldCA9IG5ldyBTZXQoKTtcbiAgICAgICAgICAgIGxldmVsRW50aXRpZXMuc2V0KGxldmVsLCBsZXZlbFNldCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV2ZWxTZXQuYWRkKGVudGl0eSk7XG4gICAgICAgIG1heExldmVsID0gTWF0aC5tYXgobWF4TGV2ZWwsIGxldmVsKTtcbiAgICB9KTtcbiAgICB3YXJuaW5nKCF3YXJuaW5nTWlzc0tleXMubGVuZ3RoLCBgVHJlZSBtaXNzaW5nIGZvbGxvdyBrZXlzOiAke3dhcm5pbmdNaXNzS2V5c1xuICAgICAgICAuc2xpY2UoMCwgMTAwKVxuICAgICAgICAubWFwKGtleSA9PiBgJyR7a2V5fSdgKVxuICAgICAgICAuam9pbignLCAnKX1gKTtcbiAgICBsZXQgcmVzdWx0O1xuICAgIGlmIChjaGVja2VkID09PSB0cnVlKSB7XG4gICAgICAgIHJlc3VsdCA9IGZpbGxDb25kdWN0Q2hlY2soa2V5cywgbGV2ZWxFbnRpdGllcywgbWF4TGV2ZWwpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmVzdWx0ID0gY2xlYW5Db25kdWN0Q2hlY2soa2V5cywgY2hlY2tlZC5oYWxmQ2hlY2tlZEtleXMsIGxldmVsRW50aXRpZXMsIG1heExldmVsKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==