b1857bcebc624cbf0fdc9a43b58b5324
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getKey = getKey;
exports.getContainer = getContainer;
exports.open = open;
exports["default"] = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _react = _interopRequireWildcard(require("react"));

var _reactDom = require("react-dom");

var _classnames = _interopRequireDefault(require("classnames"));

var _findLast = _interopRequireDefault(require("lodash/findLast.js"));

var _noop = _interopRequireDefault(require("lodash/noop"));

var _measureScrollbar = _interopRequireDefault(require("choerodon-ui/lib/_util/measureScrollbar"));

var _UnitConvertor = require("choerodon-ui/lib/_util/UnitConvertor");

var _warning = _interopRequireDefault(require("choerodon-ui/lib/_util/warning"));

var _configure = require("choerodon-ui/lib/configure");

var _Modal = _interopRequireWildcard(require("../modal/Modal"));

var _animate = _interopRequireDefault(require("../animate"));

var _Mask = _interopRequireDefault(require("./Mask"));

var _EventManager = require("../_util/EventManager");

var _utils = require("../modal/utils");

var KeyGen =
/*#__PURE__*/
_regenerator["default"].mark(function _callee(id) {
  return _regenerator["default"].wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          if (!true) {
            _context.next = 6;
            break;
          }

          _context.next = 3;
          return "".concat((0, _configure.getProPrefixCls)(_utils.suffixCls), "-").concat(id);

        case 3:
          id += 1;
          _context.next = 0;
          break;

        case 6:
        case "end":
          return _context.stop();
      }
    }
  }, _callee);
})(1);

var containerInstanses = [];

function removeInstanse(instanse) {
  var index = containerInstanses.indexOf(instanse);

  if (index > -1) {
    containerInstanses.splice(index, 1);
  }
}

function addInstanse(instanse) {
  removeInstanse(instanse);
  containerInstanses.push(instanse);
}

function getKey() {
  return KeyGen.next().value;
}

var root;
var defaultBodyStyle;

function getRoot() {
  if (typeof window !== 'undefined') {
    var doc = window.document;

    if (root) {
      if (!root.parentNode) {
        doc.body.appendChild(root);
      }
    } else {
      root = doc.createElement('div');
      root.className = "".concat((0, _configure.getProPrefixCls)(_utils.suffixCls), "-container");
      doc.body.appendChild(root);
    }
  }

  return root;
}
/**
 * 判断body是否有滚动条
 *
 * @returns {boolean}
 */


function hasScrollBar() {
  var _document$body = document.body,
      scrollHeight = _document$body.scrollHeight,
      clientHeight = _document$body.clientHeight;
  return scrollHeight > clientHeight;
}

function hideBodyScrollBar() {
  var style = document.body.style;

  if (!defaultBodyStyle) {
    defaultBodyStyle = {
      overflow: style.overflow,
      paddingRight: style.paddingRight
    };
    style.overflow = 'hidden';

    if (hasScrollBar()) {
      style.paddingRight = (0, _UnitConvertor.pxToRem)((0, _measureScrollbar["default"])()) || '';
    }
  }
}

function showBodyScrollBar() {
  var style = document.body.style;

  if (defaultBodyStyle) {
    var _defaultBodyStyle = defaultBodyStyle,
        overflow = _defaultBodyStyle.overflow,
        paddingRight = _defaultBodyStyle.paddingRight;
    defaultBodyStyle = undefined;
    style.overflow = overflow;
    style.paddingRight = paddingRight;
  }
}

var ModalContainer =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(ModalContainer, _Component);

  function ModalContainer(props, context) {
    var _this;

    (0, _classCallCheck2["default"])(this, ModalContainer);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(ModalContainer).call(this, props, context));
    _this.state = {
      modals: []
    };

    _this.handleAnimationEnd = function (modalKey, isEnter) {
      if (!isEnter) {
        var modals = _this.state.modals;

        var index = _this.findIndex(modalKey);

        if (index !== -1) {
          var _props = modals[index];
          modals.splice(index, 1);

          if (!_props.destroyOnClose) {
            modals.unshift(_props);
          }

          if (_props.afterClose) {
            _props.afterClose();
          }

          _this.setState({
            modals: modals
          });
        }
      }
    };

    _this.handleMaskClick =
    /*#__PURE__*/
    (0, _asyncToGenerator2["default"])(
    /*#__PURE__*/
    _regenerator["default"].mark(function _callee2() {
      var modals, modal, _modal$close, close, _modal$onCancel, onCancel, maskClosable, ret;

      return _regenerator["default"].wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              modals = _this.state.modals;
              modal = (0, _findLast["default"])(modals, function (_ref2) {
                var hidden = _ref2.hidden;
                return !hidden;
              });

              if (!modal) {
                _context2.next = 9;
                break;
              }

              _modal$close = modal.close, close = _modal$close === void 0 ? _noop["default"] : _modal$close, _modal$onCancel = modal.onCancel, onCancel = _modal$onCancel === void 0 ? _noop["default"] : _modal$onCancel, maskClosable = modal.maskClosable;

              if (!maskClosable) {
                _context2.next = 9;
                break;
              }

              _context2.next = 7;
              return onCancel();

            case 7:
              ret = _context2.sent;

              if (ret !== false) {
                close();
              }

            case 9:
            case "end":
              return _context2.stop();
          }
        }
      }, _callee2);
    }));

    _this.top();

    return _this;
  }

  (0, _createClass2["default"])(ModalContainer, [{
    key: "top",
    value: function top() {
      addInstanse(this);
      return this;
    }
  }, {
    key: "componentWillUpdate",
    value: function componentWillUpdate(nextProps) {
      var location = nextProps.location;
      var currentLocation = this.props.location;

      if (location && currentLocation && location.pathname !== currentLocation.pathname) {
        this.clear();
      }

      this.top();
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      removeInstanse(this);
    }
  }, {
    key: "findIndex",
    value: function findIndex(modalKey) {
      var modals = this.state.modals;
      return modals.findIndex(function (_ref3) {
        var key = _ref3.key;
        return key === modalKey;
      });
    }
  }, {
    key: "open",
    value: function open(props) {
      var modals = this.state.modals;

      if (!props.key) {
        props.key = getKey();
        (0, _warning["default"])(!!props.destroyOnClose, "The modal which opened has no key, please provide a key or set the `destroyOnClose` as true.");
      } else {
        var index = this.findIndex(props.key);

        if (index !== -1) {
          modals.splice(index, 1);
        }
      }

      modals.push((0, _objectSpread2["default"])({}, props, {
        hidden: false
      }));
      this.setState({
        modals: modals
      });
    }
  }, {
    key: "close",
    value: function close(props) {
      var modals = this.state.modals;
      var target = modals.find(function (_ref4) {
        var key = _ref4.key;
        return key === props.key;
      });

      if (target) {
        (0, _extends2["default"])(target, props, {
          hidden: true
        });
        this.setState({
          modals: modals
        });
      }
    }
  }, {
    key: "update",
    value: function update(props) {
      var originModals = this.state.modals;
      var modals = (0, _toConsumableArray2["default"])(originModals);

      if (props.key) {
        var index = this.findIndex(props.key);

        if (index !== -1) {
          modals[index] = props;
          this.setState({
            modals: modals
          });
        }
      }
    }
  }, {
    key: "clear",
    value: function clear() {
      var _this2 = this;

      var modals = this.state.modals;
      modals.forEach(function (modal) {
        return _this2.close((0, _objectSpread2["default"])({}, modal, {
          destroyOnClose: true
        }));
      });
    }
  }, {
    key: "getOffset",
    value: function getOffset(modals, idx) {
      var MARGIN_RIGHT_ARRAY = [];
      var DEFAULT = 150;
      var drawers = modals.filter(function (modal) {
        return modal.drawer && !modal.hidden;
      });
      var indexInDrawers = drawers.findIndex(function (drawer) {
        return drawer.key === modals[idx].key;
      });

      if (indexInDrawers === -1) {
        return 0;
      }

      for (var i = drawers.length - 1; i >= indexInDrawers; i--) {
        if (i === drawers.length - 1) {
          MARGIN_RIGHT_ARRAY.push(0);
        } else {
          var CURRENT_WIDTH = this.getModalWidth(drawers[i]);
          var NEXT_WIDTH = this.getModalWidth(drawers[i + 1]);
          var NEXT_MARGIN = MARGIN_RIGHT_ARRAY[drawers.length - i - 2];

          if (CURRENT_WIDTH >= NEXT_MARGIN + NEXT_WIDTH + DEFAULT) {
            MARGIN_RIGHT_ARRAY.push(0);
          } else {
            MARGIN_RIGHT_ARRAY.push(NEXT_MARGIN + NEXT_WIDTH + DEFAULT - CURRENT_WIDTH);
          }
        }
      }

      return MARGIN_RIGHT_ARRAY[MARGIN_RIGHT_ARRAY.length - 1];
    }
  }, {
    key: "getModalWidth",
    value: function getModalWidth(modal) {
      return modal && modal.style && modal.style.width || 520;
    }
  }, {
    key: "getComponent",
    value: function getComponent() {
      var _this3 = this;

      var hidden = true;
      var modals = this.state.modals;
      var items = modals.map(function (props, index) {
        var thisHidden = props.hidden;
        var _props$drawerTransiti = props.drawerTransitionName,
            drawerTransitionName = _props$drawerTransiti === void 0 ? 'slide-right' : _props$drawerTransiti;

        if (hidden && !thisHidden) {
          hidden = false;
        }

        var newProps = {};

        if (props.drawer) {
          newProps.style = (0, _objectSpread2["default"])({
            marginRight: _this3.getOffset(modals, index)
          }, props.style);
        }

        if (index === modals.length - 1) {
          newProps.className = (0, _classnames["default"])(props.className, "".concat((0, _configure.getProPrefixCls)(_utils.suffixCls), "-active"));
        }

        return _react["default"].createElement(_animate["default"], {
          key: props.key,
          component: "div",
          transitionAppear: true,
          transitionName: props.drawer ? drawerTransitionName : 'zoom',
          hiddenProp: "hidden",
          onEnd: _this3.handleAnimationEnd
        }, _react["default"].createElement(_Modal["default"], (0, _extends2["default"])({
          key: props.key
        }, props, newProps)));
      });
      var animationProps = {};

      if (typeof window !== 'undefined') {
        if (hidden) {
          animationProps.onEnd = showBodyScrollBar;
        } else {
          hideBodyScrollBar();
        }
      }

      var modal = (0, _findLast["default"])(modals, function (_ref5) {
        var modalHidden = _ref5.hidden;
        return !modalHidden;
      });

      var _ref6 = modal || {},
          maskStyle = _ref6.maskStyle,
          mask = _ref6.mask,
          maskClassName = _ref6.maskClassName;

      return _react["default"].createElement(_react["default"].Fragment, null, _react["default"].createElement(_animate["default"], (0, _extends2["default"])({
        component: "",
        transitionAppear: true,
        transitionName: "fade",
        hiddenProp: "hidden"
      }, animationProps), mask && _react["default"].createElement(_Mask["default"], {
        style: maskStyle,
        className: maskClassName,
        hidden: hidden,
        onClick: this.handleMaskClick,
        onMouseDown: _EventManager.stopEvent
      })), items);
    }
  }, {
    key: "render",
    value: function render() {
      var mount = getRoot();

      if (mount) {
        return (0, _reactDom.createPortal)(this.getComponent(), mount);
      }

      return null;
    }
  }]);
  return ModalContainer;
}(_react.Component);

exports["default"] = ModalContainer;
ModalContainer.displayName = 'ModalContainer';

function getContainer(loop) {
  var length = containerInstanses.length;

  if (length) {
    return containerInstanses[length - 1];
  }

  if (loop !== true) {
    (0, _reactDom.render)(_react["default"].createElement(ModalContainer, null), getRoot());
    return getContainer(true);
  }
}

function open(props) {
  var container = getContainer();

  function close(_x) {
    return _close.apply(this, arguments);
  }

  function _close() {
    _close = (0, _asyncToGenerator2["default"])(
    /*#__PURE__*/
    _regenerator["default"].mark(function _callee3(destroy) {
      var _props2, _props2$onClose, onClose;

      return _regenerator["default"].wrap(function _callee3$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              _props2 = props, _props2$onClose = _props2.onClose, onClose = _props2$onClose === void 0 ? _noop["default"] : _props2$onClose;
              _context3.next = 3;
              return onClose();

            case 3:
              _context3.t0 = _context3.sent;

              if (!(_context3.t0 !== false)) {
                _context3.next = 6;
                break;
              }

              if (destroy) {
                container.close((0, _objectSpread2["default"])({}, props, {
                  destroyOnClose: true
                }));
              } else {
                container.close(props);
              }

            case 6:
            case "end":
              return _context3.stop();
          }
        }
      }, _callee3);
    }));
    return _close.apply(this, arguments);
  }

  function update(newProps) {
    container.update((0, _objectSpread2["default"])({}, props, {}, newProps));
  }

  props = (0, _objectSpread2["default"])({
    close: close,
    update: update
  }, _Modal["default"].defaultProps, {}, props);
  container.open(props);

  _Modal.destroyFns.push(close);

  function show(newProps) {
    container.open((0, _objectSpread2["default"])({}, props, {}, newProps));
  }

  return {
    close: close,
    open: show,
    update: update
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9odWlodWF3ay9Eb2N1bWVudHMvb3B0L2Nob2Vyb2Rvbi11aS9jb21wb25lbnRzLXByby9tb2RhbC1jb250YWluZXIvTW9kYWxDb250YWluZXIudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFNLE1BQU07QUFBRztBQUFBLDZCQUFDLGlCQUFXLEVBQVg7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGVBQ1AsSUFETztBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUVaLDJCQUFTLGdDQUFnQixnQkFBaEIsQ0FBVCxjQUF1QyxFQUF2Qzs7QUFGWTtBQUdaLFVBQUEsRUFBRSxJQUFJLENBQU47QUFIWTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLENBQUQsRUFLWixDQUxZLENBQWY7O0FBT0EsSUFBTSxrQkFBa0IsR0FBcUIsRUFBN0M7O0FBRUEsU0FBUyxjQUFULENBQXdCLFFBQXhCLEVBQWdEO0FBQzlDLE1BQU0sS0FBSyxHQUFHLGtCQUFrQixDQUFDLE9BQW5CLENBQTJCLFFBQTNCLENBQWQ7O0FBQ0EsTUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFiLEVBQWdCO0FBQ2QsSUFBQSxrQkFBa0IsQ0FBQyxNQUFuQixDQUEwQixLQUExQixFQUFpQyxDQUFqQztBQUNEO0FBQ0Y7O0FBRUQsU0FBUyxXQUFULENBQXFCLFFBQXJCLEVBQTZDO0FBQzNDLEVBQUEsY0FBYyxDQUFDLFFBQUQsQ0FBZDtBQUNBLEVBQUEsa0JBQWtCLENBQUMsSUFBbkIsQ0FBd0IsUUFBeEI7QUFDRDs7QUFFSyxTQUFVLE1BQVYsR0FBZ0I7QUFDcEIsU0FBTyxNQUFNLENBQUMsSUFBUCxHQUFjLEtBQXJCO0FBQ0Q7O0FBRUQsSUFB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QUFBO0FBQUE7O0FBY25ELFdBQVMsTUFBVCxDQUFnQixRQUFoQixFQUF3QjtBQUN0QixJQUFBLFNBQVMsQ0FBQyxNQUFWLG9DQUFzQixLQUF0QixNQUFnQyxRQUFoQztBQUNEOztBQUVELEVBQUEsS0FBSztBQUNILElBQUEsS0FBSyxFQUFMLEtBREc7QUFFSCxJQUFBLE1BQU0sRUFBTjtBQUZHLEtBR0Esa0JBQU0sWUFITixNQUlBLEtBSkEsQ0FBTDtBQU1BLEVBQUEsU0FBUyxDQUFDLElBQVYsQ0FBZSxLQUFmOztBQUVBLG9CQUFXLElBQVgsQ0FBZ0IsS0FBaEI7O0FBRUEsV0FBUyxJQUFULENBQWMsUUFBZCxFQUFzQjtBQUNwQixJQUFBLFNBQVMsQ0FBQyxJQUFWLG9DQUFvQixLQUFwQixNQUE4QixRQUE5QjtBQUNEOztBQUVELFNBQU87QUFDTCxJQUFBLEtBQUssRUFBTCxLQURLO0FBRUwsSUFBQSxJQUFJLEVBQUUsSUFGRDtBQUdMLElBQUEsTUFBTSxFQUFOO0FBSEssR0FBUDtBQUtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IGNyZWF0ZVBvcnRhbCwgcmVuZGVyIH0gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IGZpbmRMYXN0IGZyb20gJ2xvZGFzaC9maW5kTGFzdC5qcyc7XG5pbXBvcnQgbm9vcCBmcm9tICdsb2Rhc2gvbm9vcCc7XG5pbXBvcnQgbWVhc3VyZVNjcm9sbGJhciBmcm9tICdjaG9lcm9kb24tdWkvbGliL191dGlsL21lYXN1cmVTY3JvbGxiYXInO1xuaW1wb3J0IHsgcHhUb1JlbSB9IGZyb20gJ2Nob2Vyb2Rvbi11aS9saWIvX3V0aWwvVW5pdENvbnZlcnRvcic7XG5pbXBvcnQgd2FybmluZyBmcm9tICdjaG9lcm9kb24tdWkvbGliL191dGlsL3dhcm5pbmcnO1xuaW1wb3J0IHsgZ2V0UHJvUHJlZml4Q2xzIH0gZnJvbSAnY2hvZXJvZG9uLXVpL2xpYi9jb25maWd1cmUnO1xuaW1wb3J0IE1vZGFsLCB7IE1vZGFsUHJvcHMsIGRlc3Ryb3lGbnMgfSBmcm9tICcuLi9tb2RhbC9Nb2RhbCc7XG5pbXBvcnQgQW5pbWF0ZSBmcm9tICcuLi9hbmltYXRlJztcbmltcG9ydCBNYXNrIGZyb20gJy4vTWFzayc7XG5pbXBvcnQgeyBzdG9wRXZlbnQgfSBmcm9tICcuLi9fdXRpbC9FdmVudE1hbmFnZXInO1xuaW1wb3J0IHsgc3VmZml4Q2xzIH0gZnJvbSAnLi4vbW9kYWwvdXRpbHMnO1xuXG5jb25zdCBLZXlHZW4gPSAoZnVuY3Rpb24qIChpZCkge1xuICB3aGlsZSAodHJ1ZSkge1xuICAgIHlpZWxkIGAke2dldFByb1ByZWZpeENscyhzdWZmaXhDbHMpfS0ke2lkfWA7XG4gICAgaWQgKz0gMTtcbiAgfVxufSkoMSk7XG5cbmNvbnN0IGNvbnRhaW5lckluc3RhbnNlczogTW9kYWxDb250YWluZXJbXSA9IFtdO1xuXG5mdW5jdGlvbiByZW1vdmVJbnN0YW5zZShpbnN0YW5zZTogTW9kYWxDb250YWluZXIpIHtcbiAgY29uc3QgaW5kZXggPSBjb250YWluZXJJbnN0YW5zZXMuaW5kZXhPZihpbnN0YW5zZSk7XG4gIGlmIChpbmRleCA+IC0xKSB7XG4gICAgY29udGFpbmVySW5zdGFuc2VzLnNwbGljZShpbmRleCwgMSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkSW5zdGFuc2UoaW5zdGFuc2U6IE1vZGFsQ29udGFpbmVyKSB7XG4gIHJlbW92ZUluc3RhbnNlKGluc3RhbnNlKTtcbiAgY29udGFpbmVySW5zdGFuc2VzLnB1c2goaW5zdGFuc2UpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0S2V5KCk6IHN0cmluZyB7XG4gIHJldHVybiBLZXlHZW4ubmV4dCgpLnZhbHVlO1xufVxuXG5sZXQgcm9vdDtcbmxldCBkZWZhdWx0Qm9keVN0eWxlOiB7IG92ZXJmbG93OyBwYWRkaW5nUmlnaHQgfSB8IHVuZGVmaW5lZDtcblxuZnVuY3Rpb24gZ2V0Um9vdCgpIHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc3QgZG9jID0gd2luZG93LmRvY3VtZW50O1xuICAgIGlmIChyb290KSB7XG4gICAgICBpZiAoIXJvb3QucGFyZW50Tm9kZSkge1xuICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChyb290KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcm9vdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIHJvb3QuY2xhc3NOYW1lID0gYCR7Z2V0UHJvUHJlZml4Q2xzKHN1ZmZpeENscyl9LWNvbnRhaW5lcmA7XG4gICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChyb290KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJvb3Q7XG59XG5cbi8qKlxuICog5Yik5patYm9keeaYr+WQpuaciea7muWKqOadoVxuICpcbiAqIEByZXR1cm5zIHtib29sZWFufVxuICovXG5mdW5jdGlvbiBoYXNTY3JvbGxCYXIoKTogYm9vbGVhbiB7XG4gIGNvbnN0IHsgc2Nyb2xsSGVpZ2h0LCBjbGllbnRIZWlnaHQgfSA9IGRvY3VtZW50LmJvZHk7XG4gIHJldHVybiBzY3JvbGxIZWlnaHQgPiBjbGllbnRIZWlnaHQ7XG59XG5cbmZ1bmN0aW9uIGhpZGVCb2R5U2Nyb2xsQmFyKCkge1xuICBjb25zdCB7IHN0eWxlIH0gPSBkb2N1bWVudC5ib2R5O1xuICBpZiAoIWRlZmF1bHRCb2R5U3R5bGUpIHtcbiAgICBkZWZhdWx0Qm9keVN0eWxlID0ge1xuICAgICAgb3ZlcmZsb3c6IHN0eWxlLm92ZXJmbG93LFxuICAgICAgcGFkZGluZ1JpZ2h0OiBzdHlsZS5wYWRkaW5nUmlnaHQsXG4gICAgfTtcbiAgICBzdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xuICAgIGlmIChoYXNTY3JvbGxCYXIoKSkge1xuICAgICAgc3R5bGUucGFkZGluZ1JpZ2h0ID0gcHhUb1JlbShtZWFzdXJlU2Nyb2xsYmFyKCkpIHx8ICcnO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzaG93Qm9keVNjcm9sbEJhcigpIHtcbiAgY29uc3QgeyBzdHlsZSB9ID0gZG9jdW1lbnQuYm9keTtcbiAgaWYgKGRlZmF1bHRCb2R5U3R5bGUpIHtcbiAgICBjb25zdCB7IG92ZXJmbG93LCBwYWRkaW5nUmlnaHQgfSA9IGRlZmF1bHRCb2R5U3R5bGU7XG4gICAgZGVmYXVsdEJvZHlTdHlsZSA9IHVuZGVmaW5lZDtcbiAgICBzdHlsZS5vdmVyZmxvdyA9IG92ZXJmbG93O1xuICAgIHN0eWxlLnBhZGRpbmdSaWdodCA9IHBhZGRpbmdSaWdodDtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsQ29udGFpbmVyUHJvcHMge1xuICBsb2NhdGlvbj86IHsgcGF0aG5hbWU6IHN0cmluZyB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsQ29udGFpbmVyU3RhdGUge1xuICBtb2RhbHM6IE1vZGFsUHJvcHNbXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW9kYWxDb250YWluZXIgZXh0ZW5kcyBDb21wb25lbnQ8TW9kYWxDb250YWluZXJQcm9wcz4ge1xuICBzdGF0aWMgZGlzcGxheU5hbWUgPSAnTW9kYWxDb250YWluZXInO1xuXG4gIHN0YXRlOiBNb2RhbENvbnRhaW5lclN0YXRlID0ge1xuICAgIG1vZGFsczogW10sXG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcbiAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XG4gICAgdGhpcy50b3AoKTtcbiAgfVxuXG4gIGhhbmRsZUFuaW1hdGlvbkVuZCA9IChtb2RhbEtleSwgaXNFbnRlcikgPT4ge1xuICAgIGlmICghaXNFbnRlcikge1xuICAgICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZEluZGV4KG1vZGFsS2V5KTtcbiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgY29uc3QgcHJvcHMgPSBtb2RhbHNbaW5kZXhdO1xuICAgICAgICBtb2RhbHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgaWYgKCFwcm9wcy5kZXN0cm95T25DbG9zZSkge1xuICAgICAgICAgIG1vZGFscy51bnNoaWZ0KHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvcHMuYWZ0ZXJDbG9zZSkge1xuICAgICAgICAgIHByb3BzLmFmdGVyQ2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgbW9kYWxzIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBoYW5kbGVNYXNrQ2xpY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgbW9kYWwgPSBmaW5kTGFzdChtb2RhbHMsICh7IGhpZGRlbiB9KSA9PiAhaGlkZGVuKTtcbiAgICBpZiAobW9kYWwpIHtcbiAgICAgIGNvbnN0IHsgY2xvc2UgPSBub29wLCBvbkNhbmNlbCA9IG5vb3AsIG1hc2tDbG9zYWJsZSB9ID0gbW9kYWw7XG4gICAgICBpZiAobWFza0Nsb3NhYmxlKSB7XG4gICAgICAgIGNvbnN0IHJldCA9IGF3YWl0IG9uQ2FuY2VsKCk7XG4gICAgICAgIGlmIChyZXQgIT09IGZhbHNlKSB7XG4gICAgICAgICAgY2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICB0b3AoKTogTW9kYWxDb250YWluZXIge1xuICAgIGFkZEluc3RhbnNlKHRoaXMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVwZGF0ZShuZXh0UHJvcHMpIHtcbiAgICBjb25zdCB7IGxvY2F0aW9uIH0gPSBuZXh0UHJvcHM7XG4gICAgY29uc3QgeyBsb2NhdGlvbjogY3VycmVudExvY2F0aW9uIH0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChsb2NhdGlvbiAmJiBjdXJyZW50TG9jYXRpb24gJiYgbG9jYXRpb24ucGF0aG5hbWUgIT09IGN1cnJlbnRMb2NhdGlvbi5wYXRobmFtZSkge1xuICAgICAgdGhpcy5jbGVhcigpO1xuICAgIH1cbiAgICB0aGlzLnRvcCgpO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgcmVtb3ZlSW5zdGFuc2UodGhpcyk7XG4gIH1cblxuICBmaW5kSW5kZXgobW9kYWxLZXkpIHtcbiAgICBjb25zdCB7IG1vZGFscyB9ID0gdGhpcy5zdGF0ZTtcbiAgICByZXR1cm4gbW9kYWxzLmZpbmRJbmRleCgoeyBrZXkgfSkgPT4ga2V5ID09PSBtb2RhbEtleSk7XG4gIH1cblxuICBvcGVuKHByb3BzOiBNb2RhbFByb3BzKSB7XG4gICAgY29uc3QgeyBtb2RhbHMgfSA9IHRoaXMuc3RhdGU7XG4gICAgaWYgKCFwcm9wcy5rZXkpIHtcbiAgICAgIHByb3BzLmtleSA9IGdldEtleSgpO1xuICAgICAgd2FybmluZyhcbiAgICAgICAgISFwcm9wcy5kZXN0cm95T25DbG9zZSxcbiAgICAgICAgYFRoZSBtb2RhbCB3aGljaCBvcGVuZWQgaGFzIG5vIGtleSwgcGxlYXNlIHByb3ZpZGUgYSBrZXkgb3Igc2V0IHRoZSBcXGBkZXN0cm95T25DbG9zZVxcYCBhcyB0cnVlLmAsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZEluZGV4KHByb3BzLmtleSk7XG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgIG1vZGFscy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgfVxuICAgIH1cbiAgICBtb2RhbHMucHVzaCh7IC4uLnByb3BzLCBoaWRkZW46IGZhbHNlIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoeyBtb2RhbHMgfSk7XG4gIH1cblxuICBjbG9zZShwcm9wczogTW9kYWxQcm9wcykge1xuICAgIGNvbnN0IHsgbW9kYWxzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHRhcmdldCA9IG1vZGFscy5maW5kKCh7IGtleSB9KSA9PiBrZXkgPT09IHByb3BzLmtleSk7XG4gICAgaWYgKHRhcmdldCkge1xuICAgICAgT2JqZWN0LmFzc2lnbih0YXJnZXQsIHByb3BzLCB7IGhpZGRlbjogdHJ1ZSB9KTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBtb2RhbHMgfSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlKHByb3BzOiBNb2RhbFByb3BzKSB7XG4gICAgY29uc3QgeyBtb2RhbHM6IG9yaWdpbk1vZGFscyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBtb2RhbHMgPSBbLi4ub3JpZ2luTW9kYWxzXTtcbiAgICBpZiAocHJvcHMua2V5KSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZEluZGV4KHByb3BzLmtleSk7XG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgIG1vZGFsc1tpbmRleF0gPSBwcm9wcztcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG1vZGFscyB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICBjb25zdCB7IG1vZGFscyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBtb2RhbHMuZm9yRWFjaChtb2RhbCA9PiB0aGlzLmNsb3NlKHsgLi4ubW9kYWwsIGRlc3Ryb3lPbkNsb3NlOiB0cnVlIH0pKTtcbiAgfVxuXG4gIGdldE9mZnNldChtb2RhbHMsIGlkeCkge1xuICAgIGNvbnN0IE1BUkdJTl9SSUdIVF9BUlJBWTogYW55ID0gW107XG4gICAgY29uc3QgREVGQVVMVCA9IDE1MDtcbiAgICBjb25zdCBkcmF3ZXJzID0gbW9kYWxzLmZpbHRlcihtb2RhbCA9PiBtb2RhbC5kcmF3ZXIgJiYgIW1vZGFsLmhpZGRlbik7XG4gICAgY29uc3QgaW5kZXhJbkRyYXdlcnMgPSBkcmF3ZXJzLmZpbmRJbmRleChkcmF3ZXIgPT4gZHJhd2VyLmtleSA9PT0gbW9kYWxzW2lkeF0ua2V5KTtcbiAgICBpZiAoaW5kZXhJbkRyYXdlcnMgPT09IC0xKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IGRyYXdlcnMubGVuZ3RoIC0gMTsgaSA+PSBpbmRleEluRHJhd2VyczsgaS0tKSB7XG4gICAgICBpZiAoaSA9PT0gZHJhd2Vycy5sZW5ndGggLSAxKSB7XG4gICAgICAgIE1BUkdJTl9SSUdIVF9BUlJBWS5wdXNoKDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgQ1VSUkVOVF9XSURUSCA9IHRoaXMuZ2V0TW9kYWxXaWR0aChkcmF3ZXJzW2ldKTtcbiAgICAgICAgY29uc3QgTkVYVF9XSURUSCA9IHRoaXMuZ2V0TW9kYWxXaWR0aChkcmF3ZXJzW2kgKyAxXSk7XG4gICAgICAgIGNvbnN0IE5FWFRfTUFSR0lOID0gTUFSR0lOX1JJR0hUX0FSUkFZW2RyYXdlcnMubGVuZ3RoIC0gaSAtIDJdO1xuICAgICAgICBpZiAoQ1VSUkVOVF9XSURUSCA+PSBORVhUX01BUkdJTiArIE5FWFRfV0lEVEggKyBERUZBVUxUKSB7XG4gICAgICAgICAgTUFSR0lOX1JJR0hUX0FSUkFZLnB1c2goMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgTUFSR0lOX1JJR0hUX0FSUkFZLnB1c2goTkVYVF9NQVJHSU4gKyBORVhUX1dJRFRIICsgREVGQVVMVCAtIENVUlJFTlRfV0lEVEgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBNQVJHSU5fUklHSFRfQVJSQVlbTUFSR0lOX1JJR0hUX0FSUkFZLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgZ2V0TW9kYWxXaWR0aChtb2RhbCkge1xuICAgIHJldHVybiAobW9kYWwgJiYgbW9kYWwuc3R5bGUgJiYgbW9kYWwuc3R5bGUud2lkdGgpIHx8IDUyMDtcbiAgfVxuXG4gIGdldENvbXBvbmVudCgpIHtcbiAgICBsZXQgaGlkZGVuID0gdHJ1ZTtcbiAgICBjb25zdCB7IG1vZGFscyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBpdGVtcyA9IG1vZGFscy5tYXAoKHByb3BzLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgdGhpc0hpZGRlbiA9IHByb3BzLmhpZGRlbjtcbiAgICAgIGNvbnN0IHsgZHJhd2VyVHJhbnNpdGlvbk5hbWUgPSAnc2xpZGUtcmlnaHQnIH0gPSBwcm9wcztcbiAgICAgIGlmIChoaWRkZW4gJiYgIXRoaXNIaWRkZW4pIHtcbiAgICAgICAgaGlkZGVuID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBuZXdQcm9wczogYW55ID0ge307XG4gICAgICBpZiAocHJvcHMuZHJhd2VyKSB7XG4gICAgICAgIG5ld1Byb3BzLnN0eWxlID0ge1xuICAgICAgICAgIG1hcmdpblJpZ2h0OiB0aGlzLmdldE9mZnNldChtb2RhbHMsIGluZGV4KSxcbiAgICAgICAgICAuLi5wcm9wcy5zdHlsZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGlmIChpbmRleCA9PT0gbW9kYWxzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgbmV3UHJvcHMuY2xhc3NOYW1lID0gY2xhc3NOYW1lcyhwcm9wcy5jbGFzc05hbWUsIGAke2dldFByb1ByZWZpeENscyhzdWZmaXhDbHMpfS1hY3RpdmVgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxBbmltYXRlXG4gICAgICAgICAga2V5PXtwcm9wcy5rZXl9XG4gICAgICAgICAgY29tcG9uZW50PVwiZGl2XCJcbiAgICAgICAgICB0cmFuc2l0aW9uQXBwZWFyXG4gICAgICAgICAgdHJhbnNpdGlvbk5hbWU9e3Byb3BzLmRyYXdlciA/IGRyYXdlclRyYW5zaXRpb25OYW1lIDogJ3pvb20nfVxuICAgICAgICAgIGhpZGRlblByb3A9XCJoaWRkZW5cIlxuICAgICAgICAgIG9uRW5kPXt0aGlzLmhhbmRsZUFuaW1hdGlvbkVuZH1cbiAgICAgICAgPlxuICAgICAgICAgIDxNb2RhbCBrZXk9e3Byb3BzLmtleX0gey4uLnByb3BzfSB7Li4ubmV3UHJvcHN9IC8+XG4gICAgICAgIDwvQW5pbWF0ZT5cbiAgICAgICk7XG4gICAgfSk7XG4gICAgY29uc3QgYW5pbWF0aW9uUHJvcHM6IGFueSA9IHt9O1xuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgaWYgKGhpZGRlbikge1xuICAgICAgICBhbmltYXRpb25Qcm9wcy5vbkVuZCA9IHNob3dCb2R5U2Nyb2xsQmFyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGlkZUJvZHlTY3JvbGxCYXIoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBtb2RhbCA9IGZpbmRMYXN0KG1vZGFscywgKHsgaGlkZGVuOiBtb2RhbEhpZGRlbiB9KSA9PiAhbW9kYWxIaWRkZW4pO1xuICAgIGNvbnN0IHsgbWFza1N0eWxlLCBtYXNrLCBtYXNrQ2xhc3NOYW1lIH0gPSBtb2RhbCB8fCB7fTtcbiAgICByZXR1cm4gKFxuICAgICAgPD5cbiAgICAgICAgPEFuaW1hdGVcbiAgICAgICAgICBjb21wb25lbnQ9XCJcIlxuICAgICAgICAgIHRyYW5zaXRpb25BcHBlYXJcbiAgICAgICAgICB0cmFuc2l0aW9uTmFtZT1cImZhZGVcIlxuICAgICAgICAgIGhpZGRlblByb3A9XCJoaWRkZW5cIlxuICAgICAgICAgIHsuLi5hbmltYXRpb25Qcm9wc31cbiAgICAgICAgPlxuICAgICAgICAgIHttYXNrICYmIDxNYXNrIHN0eWxlPXttYXNrU3R5bGV9IGNsYXNzTmFtZT17bWFza0NsYXNzTmFtZX0gaGlkZGVuPXtoaWRkZW59IG9uQ2xpY2s9e3RoaXMuaGFuZGxlTWFza0NsaWNrfSBvbk1vdXNlRG93bj17c3RvcEV2ZW50fSAvPn1cbiAgICAgICAgPC9BbmltYXRlPlxuICAgICAgICB7aXRlbXN9XG4gICAgICA8Lz5cbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IG1vdW50ID0gZ2V0Um9vdCgpO1xuICAgIGlmIChtb3VudCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVBvcnRhbCh0aGlzLmdldENvbXBvbmVudCgpLCBtb3VudCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb250YWluZXIobG9vcD86IGJvb2xlYW4pIHtcbiAgY29uc3QgeyBsZW5ndGggfSA9IGNvbnRhaW5lckluc3RhbnNlcztcbiAgaWYgKGxlbmd0aCkge1xuICAgIHJldHVybiBjb250YWluZXJJbnN0YW5zZXNbbGVuZ3RoIC0gMV07XG4gIH1cbiAgaWYgKGxvb3AgIT09IHRydWUpIHtcbiAgICByZW5kZXIoPE1vZGFsQ29udGFpbmVyIC8+LCBnZXRSb290KCkpO1xuICAgIHJldHVybiBnZXRDb250YWluZXIodHJ1ZSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW4ocHJvcHM6IE1vZGFsUHJvcHMgJiB7IGNoaWxkcmVuIH0pIHtcbiAgY29uc3QgY29udGFpbmVyID0gZ2V0Q29udGFpbmVyKCk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gY2xvc2UoZGVzdHJveT86IGJvb2xlYW4pIHtcbiAgICBjb25zdCB7IG9uQ2xvc2UgPSBub29wIH0gPSBwcm9wcztcbiAgICBpZiAoKGF3YWl0IG9uQ2xvc2UoKSkgIT09IGZhbHNlKSB7XG4gICAgICBpZiAoZGVzdHJveSkge1xuICAgICAgICBjb250YWluZXIuY2xvc2UoeyAuLi5wcm9wcywgZGVzdHJveU9uQ2xvc2U6IHRydWUgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb250YWluZXIuY2xvc2UocHJvcHMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZShuZXdQcm9wcykge1xuICAgIGNvbnRhaW5lci51cGRhdGUoeyAuLi5wcm9wcywgLi4ubmV3UHJvcHMgfSk7XG4gIH1cblxuICBwcm9wcyA9IHtcbiAgICBjbG9zZSxcbiAgICB1cGRhdGUsXG4gICAgLi4uTW9kYWwuZGVmYXVsdFByb3BzLFxuICAgIC4uLnByb3BzLFxuICB9O1xuICBjb250YWluZXIub3Blbihwcm9wcyk7XG5cbiAgZGVzdHJveUZucy5wdXNoKGNsb3NlKTtcblxuICBmdW5jdGlvbiBzaG93KG5ld1Byb3BzKSB7XG4gICAgY29udGFpbmVyLm9wZW4oeyAuLi5wcm9wcywgLi4ubmV3UHJvcHMgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNsb3NlLFxuICAgIG9wZW46IHNob3csXG4gICAgdXBkYXRlLFxuICB9O1xufVxuIl19