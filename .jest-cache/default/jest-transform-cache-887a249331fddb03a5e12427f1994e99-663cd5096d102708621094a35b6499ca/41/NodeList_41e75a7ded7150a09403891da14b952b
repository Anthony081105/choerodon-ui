b5a4429e3cb3ee0d425643cfeb084e47
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getMinimumRangeTransitionRange = getMinimumRangeTransitionRange;
exports["default"] = exports.MotionEntity = exports.MOTION_KEY = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var React = _interopRequireWildcard(require("react"));

var _rcVirtualList = _interopRequireDefault(require("rc-virtual-list"));

var _MotionTreeNode = _interopRequireDefault(require("./MotionTreeNode"));

var _diffUtil = require("./utils/diffUtil");

var _treeUtil = require("./utils/treeUtil");
/* eslint-disable @typescript-eslint/no-unused-vars */

/**
 * Handle virtual list of the TreeNodes.
 */


var HIDDEN_STYLE = {
  width: 0,
  height: 0,
  display: 'flex',
  overflow: 'hidden',
  opacity: 0,
  border: 0,
  padding: 0,
  margin: 0
};

var noop = function noop() {};

var MOTION_KEY = "RC_TREE_MOTION_".concat(Math.random());
exports.MOTION_KEY = MOTION_KEY;
var MotionNode = {
  key: MOTION_KEY
};
var MotionEntity = {
  key: MOTION_KEY,
  level: 0,
  index: 0,
  pos: '0',
  node: MotionNode
};
exports.MotionEntity = MotionEntity;
var MotionFlattenData = {
  parent: null,
  children: [],
  pos: MotionEntity.pos,
  data: MotionNode,

  /** Hold empty list here since we do not use it */
  isStart: [],
  isEnd: []
};
/**
 * We only need get visible content items to play the animation.
 */

function getMinimumRangeTransitionRange(list, height, itemHeight) {
  if (!height) {
    return list;
  }

  return list.slice(0, Math.ceil(height / itemHeight) + 1);
}

function itemKey(item) {
  var key = item.data.key,
      pos = item.pos;
  return (0, _treeUtil.getKey)(key, pos);
}

function getAccessibilityPath(item) {
  var path = String(item.data.key);
  var current = item;

  while (current.parent) {
    current = current.parent;
    path = "".concat(current.data.key, " > ").concat(path);
  }

  return path;
}

var RefNodeList = function RefNodeList(props, ref) {
  var prefixCls = props.prefixCls,
      data = props.data,
      selectable = props.selectable,
      expandedKeys = props.expandedKeys,
      selectedKeys = props.selectedKeys,
      checkedKeys = props.checkedKeys,
      loadedKeys = props.loadedKeys,
      loadingKeys = props.loadingKeys,
      halfCheckedKeys = props.halfCheckedKeys,
      keyEntities = props.keyEntities,
      disabled = props.disabled,
      dragging = props.dragging,
      dragOverNodeKey = props.dragOverNodeKey,
      dropPosition = props.dropPosition,
      motion = props.motion,
      height = props.height,
      itemHeight = props.itemHeight,
      virtual = props.virtual,
      focusable = props.focusable,
      activeItem = props.activeItem,
      focused = props.focused,
      tabIndex = props.tabIndex,
      onKeyDown = props.onKeyDown,
      onFocus = props.onFocus,
      onBlur = props.onBlur,
      onActiveChange = props.onActiveChange,
      domProps = (0, _objectWithoutProperties2["default"])(props, ["prefixCls", "data", "selectable", "expandedKeys", "selectedKeys", "checkedKeys", "loadedKeys", "loadingKeys", "halfCheckedKeys", "keyEntities", "disabled", "dragging", "dragOverNodeKey", "dropPosition", "motion", "height", "itemHeight", "virtual", "focusable", "activeItem", "focused", "tabIndex", "onKeyDown", "onFocus", "onBlur", "onActiveChange"]); // =============================== Ref ================================

  var listRef = React.useRef(null);
  React.useImperativeHandle(ref, function () {
    return {
      scrollTo: function scrollTo(scroll) {
        listRef.current.scrollTo(scroll);
      }
    };
  }); // ============================== Motion ==============================

  var _React$useState = React.useState(false),
      _React$useState2 = (0, _slicedToArray2["default"])(_React$useState, 2),
      disableVirtual = _React$useState2[0],
      setDisableVirtual = _React$useState2[1];

  var _React$useState3 = React.useState(expandedKeys),
      _React$useState4 = (0, _slicedToArray2["default"])(_React$useState3, 2),
      prevExpandedKeys = _React$useState4[0],
      setPrevExpandedKeys = _React$useState4[1];

  var _React$useState5 = React.useState(data),
      _React$useState6 = (0, _slicedToArray2["default"])(_React$useState5, 2),
      prevData = _React$useState6[0],
      setPrevData = _React$useState6[1];

  var _React$useState7 = React.useState(data),
      _React$useState8 = (0, _slicedToArray2["default"])(_React$useState7, 2),
      transitionData = _React$useState8[0],
      setTransitionData = _React$useState8[1];

  var _React$useState9 = React.useState([]),
      _React$useState10 = (0, _slicedToArray2["default"])(_React$useState9, 2),
      transitionRange = _React$useState10[0],
      setTransitionRange = _React$useState10[1];

  var _React$useState11 = React.useState(null),
      _React$useState12 = (0, _slicedToArray2["default"])(_React$useState11, 2),
      motionType = _React$useState12[0],
      setMotionType = _React$useState12[1];

  function onMotionEnd() {
    setPrevData(data);
    setTransitionData(data);
    setTransitionRange([]);
    setMotionType(null);
    setDisableVirtual(false);
  } // Do animation if expanded keys changed


  React.useEffect(function () {
    setPrevExpandedKeys(expandedKeys);
    var diffExpanded = (0, _diffUtil.findExpandedKeys)(prevExpandedKeys, expandedKeys);

    if (diffExpanded.key !== null) {
      if (diffExpanded.add) {
        var keyIndex = prevData.findIndex(function (_ref) {
          var key = _ref.data.key;
          return key === diffExpanded.key;
        });
        if (motion) setDisableVirtual(true);
        var rangeNodes = getMinimumRangeTransitionRange((0, _diffUtil.getExpandRange)(prevData, data, diffExpanded.key), height, itemHeight);
        var newTransitionData = prevData.slice();
        newTransitionData.splice(keyIndex + 1, 0, MotionFlattenData);
        setTransitionData(newTransitionData); // @ts-ignore

        setTransitionRange(rangeNodes);
        setMotionType('show');
      } else {
        var _keyIndex = data.findIndex(function (_ref2) {
          var key = _ref2.data.key;
          return key === diffExpanded.key;
        });

        if (motion) setDisableVirtual(true);

        var _rangeNodes = getMinimumRangeTransitionRange((0, _diffUtil.getExpandRange)(data, prevData, diffExpanded.key), height, itemHeight);

        var _newTransitionData = data.slice();

        _newTransitionData.splice(_keyIndex + 1, 0, MotionFlattenData);

        setTransitionData(_newTransitionData); // @ts-ignore

        setTransitionRange(_rangeNodes);
        setMotionType('hide');
      }
    } else if (prevData !== data) {
      // If whole data changed, we just refresh the list
      setPrevData(data);
      setTransitionData(data);
    }
  }, [expandedKeys, data]); // We should clean up motion if is changed by dragging

  React.useEffect(function () {
    if (!dragging) {
      onMotionEnd();
    }
  }, [dragging]);
  var mergedData = motion ? transitionData : data;
  var treeNodeRequiredProps = {
    expandedKeys: expandedKeys,
    selectedKeys: selectedKeys,
    loadedKeys: loadedKeys,
    loadingKeys: loadingKeys,
    checkedKeys: checkedKeys,
    halfCheckedKeys: halfCheckedKeys,
    dragOverNodeKey: dragOverNodeKey,
    dropPosition: dropPosition,
    keyEntities: keyEntities
  };
  return React.createElement(React.Fragment, null, focused && activeItem && React.createElement("span", {
    style: HIDDEN_STYLE,
    "aria-live": "assertive"
  }, getAccessibilityPath(activeItem)), React.createElement("div", {
    role: "tree"
  }, React.createElement("input", {
    style: HIDDEN_STYLE,
    disabled: focusable === false || disabled,
    tabIndex: focusable !== false ? tabIndex : undefined,
    onKeyDown: onKeyDown,
    onFocus: onFocus,
    onBlur: onBlur,
    value: "",
    onChange: noop
  })), React.createElement(_rcVirtualList["default"], (0, _extends2["default"])({}, domProps, {
    disabled: disableVirtual,
    data: mergedData,
    itemKey: itemKey,
    height: height,
    fullHeight: false,
    virtual: virtual,
    itemHeight: itemHeight,
    onSkipRender: onMotionEnd,
    prefixCls: "".concat(prefixCls, "-list"),
    ref: listRef
  }), function (treeNode) {
    var pos = treeNode.pos,
        _treeNode$data = treeNode.data,
        key = _treeNode$data.key,
        restProps = (0, _objectWithoutProperties2["default"])(_treeNode$data, ["key"]),
        isStart = treeNode.isStart,
        isEnd = treeNode.isEnd;
    var mergedKey = (0, _treeUtil.getKey)(key, pos);
    delete restProps.children;
    var treeNodeProps = (0, _treeUtil.getTreeNodeProps)(mergedKey, treeNodeRequiredProps);
    return React.createElement(_MotionTreeNode["default"], (0, _extends2["default"])({}, restProps, treeNodeProps, {
      // @ts-ignore
      active: activeItem && key === activeItem.data.key,
      pos: pos,
      data: treeNode.data,
      isStart: isStart,
      isEnd: isEnd,
      motion: motion,
      motionNodes: key === MOTION_KEY ? transitionRange : null,
      motionType: motionType,
      onMotionEnd: onMotionEnd,
      treeNodeRequiredProps: treeNodeRequiredProps,
      onMouseMove: function onMouseMove() {
        // @ts-ignore
        onActiveChange(null);
      }
    }));
  }));
};

var NodeList = React.forwardRef(RefNodeList);
NodeList.displayName = 'NodeList';
var _default = NodeList;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJjLWNvbXBvbmVudHMvdHJlZS9Ob2RlTGlzdC5qcyJdLCJuYW1lcyI6WyJISURERU5fU1RZTEUiLCJ3aWR0aCIsImhlaWdodCIsImRpc3BsYXkiLCJvdmVyZmxvdyIsIm9wYWNpdHkiLCJib3JkZXIiLCJwYWRkaW5nIiwibWFyZ2luIiwibm9vcCIsIk1PVElPTl9LRVkiLCJNYXRoIiwiTW90aW9uTm9kZSIsImtleSIsIk1vdGlvbkVudGl0eSIsImxldmVsIiwiaW5kZXgiLCJwb3MiLCJub2RlIiwiTW90aW9uRmxhdHRlbkRhdGEiLCJwYXJlbnQiLCJjaGlsZHJlbiIsImRhdGEiLCJpc1N0YXJ0IiwiaXNFbmQiLCJsaXN0IiwiaXRlbSIsInBhdGgiLCJTdHJpbmciLCJjdXJyZW50IiwiUmVmTm9kZUxpc3QiLCJwcmVmaXhDbHMiLCJzZWxlY3RhYmxlIiwiZXhwYW5kZWRLZXlzIiwic2VsZWN0ZWRLZXlzIiwiY2hlY2tlZEtleXMiLCJsb2FkZWRLZXlzIiwibG9hZGluZ0tleXMiLCJoYWxmQ2hlY2tlZEtleXMiLCJrZXlFbnRpdGllcyIsImRpc2FibGVkIiwiZHJhZ2dpbmciLCJkcmFnT3Zlck5vZGVLZXkiLCJkcm9wUG9zaXRpb24iLCJtb3Rpb24iLCJpdGVtSGVpZ2h0IiwidmlydHVhbCIsImZvY3VzYWJsZSIsImFjdGl2ZUl0ZW0iLCJmb2N1c2VkIiwidGFiSW5kZXgiLCJvbktleURvd24iLCJvbkZvY3VzIiwib25CbHVyIiwib25BY3RpdmVDaGFuZ2UiLCJkb21Qcm9wcyIsInByb3BzIiwibGlzdFJlZiIsIlJlYWN0Iiwic2Nyb2xsVG8iLCJkaXNhYmxlVmlydHVhbCIsInNldERpc2FibGVWaXJ0dWFsIiwicHJldkV4cGFuZGVkS2V5cyIsInNldFByZXZFeHBhbmRlZEtleXMiLCJwcmV2RGF0YSIsInNldFByZXZEYXRhIiwidHJhbnNpdGlvbkRhdGEiLCJzZXRUcmFuc2l0aW9uRGF0YSIsInRyYW5zaXRpb25SYW5nZSIsInNldFRyYW5zaXRpb25SYW5nZSIsIm1vdGlvblR5cGUiLCJzZXRNb3Rpb25UeXBlIiwiZGlmZkV4cGFuZGVkIiwia2V5SW5kZXgiLCJyYW5nZU5vZGVzIiwiZ2V0TWluaW11bVJhbmdlVHJhbnNpdGlvblJhbmdlIiwibmV3VHJhbnNpdGlvbkRhdGEiLCJvbk1vdGlvbkVuZCIsIm1lcmdlZERhdGEiLCJ0cmVlTm9kZVJlcXVpcmVkUHJvcHMiLCJzdHlsZSIsImdldEFjY2Vzc2liaWxpdHlQYXRoIiwicm9sZSIsInZhbHVlIiwib25DaGFuZ2UiLCJWaXJ0dWFsTGlzdCIsIml0ZW1LZXkiLCJmdWxsSGVpZ2h0Iiwib25Ta2lwUmVuZGVyIiwicmVmIiwicmVzdFByb3BzIiwidHJlZU5vZGUiLCJtZXJnZWRLZXkiLCJ0cmVlTm9kZVByb3BzIiwiTW90aW9uVHJlZU5vZGUiLCJhY3RpdmUiLCJtb3Rpb25Ob2RlcyIsIm9uTW91c2VNb3ZlIiwiTm9kZUxpc3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlBLElBQUEsS0FBQSxHQUFBLHVCQUFBLENBQUEsT0FBQSxDQUFBLE9BQUEsQ0FBQSxDQUFBOztBQUNBLElBQUEsY0FBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLGlCQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLGVBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxrQkFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxTQUFBLEdBQUEsT0FBQSxDQUFBLGtCQUFBLENBQUE7O0FBQ0EsSUFBQSxTQUFBLEdBQUEsT0FBQSxDQUFBLGtCQUFBLENBQUE7QUFSQTs7QUFDQTs7Ozs7QUFRQSxJQUFNQSxZQUFZLEdBQUc7QUFDakJDLEVBQUFBLEtBQUssRUFEWSxDQUFBO0FBRWpCQyxFQUFBQSxNQUFNLEVBRlcsQ0FBQTtBQUdqQkMsRUFBQUEsT0FBTyxFQUhVLE1BQUE7QUFJakJDLEVBQUFBLFFBQVEsRUFKUyxRQUFBO0FBS2pCQyxFQUFBQSxPQUFPLEVBTFUsQ0FBQTtBQU1qQkMsRUFBQUEsTUFBTSxFQU5XLENBQUE7QUFP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RixLQUE1QyxDQUFwQyxDQUFSO0FBVFIsR0FJSSxDQUpJLENBQVI7QUFqRkosQ0FBQTs7QUFrR0EsSUFBTTRDLFFBQVEsR0FBR3hDLEtBQUssQ0FBTEEsVUFBQUEsQ0FBakIsV0FBaUJBLENBQWpCO0FBQ0F3QyxRQUFRLENBQVJBLFdBQUFBLEdBQUFBLFVBQUFBO2VBQ2VBLFEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi9cbi8qKlxuICogSGFuZGxlIHZpcnR1YWwgbGlzdCBvZiB0aGUgVHJlZU5vZGVzLlxuICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgVmlydHVhbExpc3QgZnJvbSAncmMtdmlydHVhbC1saXN0JztcbmltcG9ydCBNb3Rpb25UcmVlTm9kZSBmcm9tICcuL01vdGlvblRyZWVOb2RlJztcbmltcG9ydCB7IGZpbmRFeHBhbmRlZEtleXMsIGdldEV4cGFuZFJhbmdlIH0gZnJvbSAnLi91dGlscy9kaWZmVXRpbCc7XG5pbXBvcnQgeyBnZXRUcmVlTm9kZVByb3BzLCBnZXRLZXkgfSBmcm9tICcuL3V0aWxzL3RyZWVVdGlsJztcbmNvbnN0IEhJRERFTl9TVFlMRSA9IHtcbiAgICB3aWR0aDogMCxcbiAgICBoZWlnaHQ6IDAsXG4gICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgIG92ZXJmbG93OiAnaGlkZGVuJyxcbiAgICBvcGFjaXR5OiAwLFxuICAgIGJvcmRlcjogMCxcbiAgICBwYWRkaW5nOiAwLFxuICAgIG1hcmdpbjogMCxcbn07XG5jb25zdCBub29wID0gKCkgPT4geyB9O1xuZXhwb3J0IGNvbnN0IE1PVElPTl9LRVkgPSBgUkNfVFJFRV9NT1RJT05fJHtNYXRoLnJhbmRvbSgpfWA7XG5jb25zdCBNb3Rpb25Ob2RlID0ge1xuICAgIGtleTogTU9USU9OX0tFWSxcbn07XG5leHBvcnQgY29uc3QgTW90aW9uRW50aXR5ID0ge1xuICAgIGtleTogTU9USU9OX0tFWSxcbiAgICBsZXZlbDogMCxcbiAgICBpbmRleDogMCxcbiAgICBwb3M6ICcwJyxcbiAgICBub2RlOiBNb3Rpb25Ob2RlLFxufTtcbmNvbnN0IE1vdGlvbkZsYXR0ZW5EYXRhID0ge1xuICAgIHBhcmVudDogbnVsbCxcbiAgICBjaGlsZHJlbjogW10sXG4gICAgcG9zOiBNb3Rpb25FbnRpdHkucG9zLFxuICAgIGRhdGE6IE1vdGlvbk5vZGUsXG4gICAgLyoqIEhvbGQgZW1wdHkgbGlzdCBoZXJlIHNpbmNlIHdlIGRvIG5vdCB1c2UgaXQgKi9cbiAgICBpc1N0YXJ0OiBbXSxcbiAgICBpc0VuZDogW10sXG59O1xuLyoqXG4gKiBXZSBvbmx5IG5lZWQgZ2V0IHZpc2libGUgY29udGVudCBpdGVtcyB0byBwbGF5IHRoZSBhbmltYXRpb24uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRNaW5pbXVtUmFuZ2VUcmFuc2l0aW9uUmFuZ2UobGlzdCwgaGVpZ2h0LCBpdGVtSGVpZ2h0KSB7XG4gICAgaWYgKCFoZWlnaHQpIHtcbiAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfVxuICAgIHJldHVybiBsaXN0LnNsaWNlKDAsIE1hdGguY2VpbChoZWlnaHQgLyBpdGVtSGVpZ2h0KSArIDEpO1xufVxuZnVuY3Rpb24gaXRlbUtleShpdGVtKSB7XG4gICAgY29uc3QgeyBkYXRhOiB7IGtleSB9LCBwb3MsIH0gPSBpdGVtO1xuICAgIHJldHVybiBnZXRLZXkoa2V5LCBwb3MpO1xufVxuZnVuY3Rpb24gZ2V0QWNjZXNzaWJpbGl0eVBhdGgoaXRlbSkge1xuICAgIGxldCBwYXRoID0gU3RyaW5nKGl0ZW0uZGF0YS5rZXkpO1xuICAgIGxldCBjdXJyZW50ID0gaXRlbTtcbiAgICB3aGlsZSAoY3VycmVudC5wYXJlbnQpIHtcbiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50O1xuICAgICAgICBwYXRoID0gYCR7Y3VycmVudC5kYXRhLmtleX0gPiAke3BhdGh9YDtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGg7XG59XG5jb25zdCBSZWZOb2RlTGlzdCA9IChwcm9wcywgcmVmKSA9PiB7XG4gICAgY29uc3QgeyBwcmVmaXhDbHMsIGRhdGEsIFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycyBcbiAgICBzZWxlY3RhYmxlLCBcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMgIFxuICAgIGV4cGFuZGVkS2V5cywgc2VsZWN0ZWRLZXlzLCBjaGVja2VkS2V5cywgbG9hZGVkS2V5cywgbG9hZGluZ0tleXMsIGhhbGZDaGVja2VkS2V5cywga2V5RW50aXRpZXMsIGRpc2FibGVkLCBkcmFnZ2luZywgZHJhZ092ZXJOb2RlS2V5LCBkcm9wUG9zaXRpb24sIG1vdGlvbiwgaGVpZ2h0LCBpdGVtSGVpZ2h0LCB2aXJ0dWFsLCBmb2N1c2FibGUsIGFjdGl2ZUl0ZW0sIGZvY3VzZWQsIHRhYkluZGV4LCBvbktleURvd24sIG9uRm9jdXMsIG9uQmx1ciwgb25BY3RpdmVDaGFuZ2UsIC4uLmRvbVByb3BzIH0gPSBwcm9wcztcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFJlZiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIGNvbnN0IGxpc3RSZWYgPSBSZWFjdC51c2VSZWYobnVsbCk7XG4gICAgUmVhY3QudXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsICgpID0+ICh7XG4gICAgICAgIHNjcm9sbFRvOiBzY3JvbGwgPT4ge1xuICAgICAgICAgICAgbGlzdFJlZi5jdXJyZW50LnNjcm9sbFRvKHNjcm9sbCk7XG4gICAgICAgIH0sXG4gICAgfSkpO1xuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNb3Rpb24gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgY29uc3QgW2Rpc2FibGVWaXJ0dWFsLCBzZXREaXNhYmxlVmlydHVhbF0gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSk7XG4gICAgY29uc3QgW3ByZXZFeHBhbmRlZEtleXMsIHNldFByZXZFeHBhbmRlZEtleXNdID0gUmVhY3QudXNlU3RhdGUoZXhwYW5kZWRLZXlzKTtcbiAgICBjb25zdCBbcHJldkRhdGEsIHNldFByZXZEYXRhXSA9IFJlYWN0LnVzZVN0YXRlKGRhdGEpO1xuICAgIGNvbnN0IFt0cmFuc2l0aW9uRGF0YSwgc2V0VHJhbnNpdGlvbkRhdGFdID0gUmVhY3QudXNlU3RhdGUoZGF0YSk7XG4gICAgY29uc3QgW3RyYW5zaXRpb25SYW5nZSwgc2V0VHJhbnNpdGlvblJhbmdlXSA9IFJlYWN0LnVzZVN0YXRlKFtdKTtcbiAgICBjb25zdCBbbW90aW9uVHlwZSwgc2V0TW90aW9uVHlwZV0gPSBSZWFjdC51c2VTdGF0ZShudWxsKTtcbiAgICBmdW5jdGlvbiBvbk1vdGlvbkVuZCgpIHtcbiAgICAgICAgc2V0UHJldkRhdGEoZGF0YSk7XG4gICAgICAgIHNldFRyYW5zaXRpb25EYXRhKGRhdGEpO1xuICAgICAgICBzZXRUcmFuc2l0aW9uUmFuZ2UoW10pO1xuICAgICAgICBzZXRNb3Rpb25UeXBlKG51bGwpO1xuICAgICAgICBzZXREaXNhYmxlVmlydHVhbChmYWxzZSk7XG4gICAgfVxuICAgIC8vIERvIGFuaW1hdGlvbiBpZiBleHBhbmRlZCBrZXlzIGNoYW5nZWRcbiAgICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBzZXRQcmV2RXhwYW5kZWRLZXlzKGV4cGFuZGVkS2V5cyk7XG4gICAgICAgIGNvbnN0IGRpZmZFeHBhbmRlZCA9IGZpbmRFeHBhbmRlZEtleXMocHJldkV4cGFuZGVkS2V5cywgZXhwYW5kZWRLZXlzKTtcbiAgICAgICAgaWYgKGRpZmZFeHBhbmRlZC5rZXkgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGlmIChkaWZmRXhwYW5kZWQuYWRkKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5SW5kZXggPSBwcmV2RGF0YS5maW5kSW5kZXgoKHsgZGF0YTogeyBrZXkgfSB9KSA9PiBrZXkgPT09IGRpZmZFeHBhbmRlZC5rZXkpO1xuICAgICAgICAgICAgICAgIGlmIChtb3Rpb24pXG4gICAgICAgICAgICAgICAgICAgIHNldERpc2FibGVWaXJ0dWFsKHRydWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlTm9kZXMgPSBnZXRNaW5pbXVtUmFuZ2VUcmFuc2l0aW9uUmFuZ2UoZ2V0RXhwYW5kUmFuZ2UocHJldkRhdGEsIGRhdGEsIGRpZmZFeHBhbmRlZC5rZXkpLCBoZWlnaHQsIGl0ZW1IZWlnaHQpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1RyYW5zaXRpb25EYXRhID0gcHJldkRhdGEuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICBuZXdUcmFuc2l0aW9uRGF0YS5zcGxpY2Uoa2V5SW5kZXggKyAxLCAwLCBNb3Rpb25GbGF0dGVuRGF0YSk7XG4gICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkRhdGEobmV3VHJhbnNpdGlvbkRhdGEpO1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uUmFuZ2UocmFuZ2VOb2Rlcyk7XG4gICAgICAgICAgICAgICAgc2V0TW90aW9uVHlwZSgnc2hvdycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5SW5kZXggPSBkYXRhLmZpbmRJbmRleCgoeyBkYXRhOiB7IGtleSB9IH0pID0+IGtleSA9PT0gZGlmZkV4cGFuZGVkLmtleSk7XG4gICAgICAgICAgICAgICAgaWYgKG1vdGlvbilcbiAgICAgICAgICAgICAgICAgICAgc2V0RGlzYWJsZVZpcnR1YWwodHJ1ZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmFuZ2VOb2RlcyA9IGdldE1pbmltdW1SYW5nZVRyYW5zaXRpb25SYW5nZShnZXRFeHBhbmRSYW5nZShkYXRhLCBwcmV2RGF0YSwgZGlmZkV4cGFuZGVkLmtleSksIGhlaWdodCwgaXRlbUhlaWdodCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3VHJhbnNpdGlvbkRhdGEgPSBkYXRhLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgbmV3VHJhbnNpdGlvbkRhdGEuc3BsaWNlKGtleUluZGV4ICsgMSwgMCwgTW90aW9uRmxhdHRlbkRhdGEpO1xuICAgICAgICAgICAgICAgIHNldFRyYW5zaXRpb25EYXRhKG5ld1RyYW5zaXRpb25EYXRhKTtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvblJhbmdlKHJhbmdlTm9kZXMpO1xuICAgICAgICAgICAgICAgIHNldE1vdGlvblR5cGUoJ2hpZGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwcmV2RGF0YSAhPT0gZGF0YSkge1xuICAgICAgICAgICAgLy8gSWYgd2hvbGUgZGF0YSBjaGFuZ2VkLCB3ZSBqdXN0IHJlZnJlc2ggdGhlIGxpc3RcbiAgICAgICAgICAgIHNldFByZXZEYXRhKGRhdGEpO1xuICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkRhdGEoZGF0YSk7XG4gICAgICAgIH1cbiAgICB9LCBbZXhwYW5kZWRLZXlzLCBkYXRhXSk7XG4gICAgLy8gV2Ugc2hvdWxkIGNsZWFuIHVwIG1vdGlvbiBpZiBpcyBjaGFuZ2VkIGJ5IGRyYWdnaW5nXG4gICAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICAgICAgaWYgKCFkcmFnZ2luZykge1xuICAgICAgICAgICAgb25Nb3Rpb25FbmQoKTtcbiAgICAgICAgfVxuICAgIH0sIFtkcmFnZ2luZ10pO1xuICAgIGNvbnN0IG1lcmdlZERhdGEgPSBtb3Rpb24gPyB0cmFuc2l0aW9uRGF0YSA6IGRhdGE7XG4gICAgY29uc3QgdHJlZU5vZGVSZXF1aXJlZFByb3BzID0ge1xuICAgICAgICBleHBhbmRlZEtleXMsXG4gICAgICAgIHNlbGVjdGVkS2V5cyxcbiAgICAgICAgbG9hZGVkS2V5cyxcbiAgICAgICAgbG9hZGluZ0tleXMsXG4gICAgICAgIGNoZWNrZWRLZXlzLFxuICAgICAgICBoYWxmQ2hlY2tlZEtleXMsXG4gICAgICAgIGRyYWdPdmVyTm9kZUtleSxcbiAgICAgICAgZHJvcFBvc2l0aW9uLFxuICAgICAgICBrZXlFbnRpdGllcyxcbiAgICB9O1xuICAgIHJldHVybiAoUmVhY3QuY3JlYXRlRWxlbWVudChSZWFjdC5GcmFnbWVudCwgbnVsbCxcbiAgICAgICAgZm9jdXNlZCAmJiBhY3RpdmVJdGVtICYmIChSZWFjdC5jcmVhdGVFbGVtZW50KFwic3BhblwiLCB7IHN0eWxlOiBISURERU5fU1RZTEUsIFwiYXJpYS1saXZlXCI6IFwiYXNzZXJ0aXZlXCIgfSwgZ2V0QWNjZXNzaWJpbGl0eVBhdGgoYWN0aXZlSXRlbSkpKSxcbiAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IHJvbGU6IFwidHJlZVwiIH0sXG4gICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFwiaW5wdXRcIiwgeyBzdHlsZTogSElEREVOX1NUWUxFLCBkaXNhYmxlZDogZm9jdXNhYmxlID09PSBmYWxzZSB8fCBkaXNhYmxlZCwgdGFiSW5kZXg6IGZvY3VzYWJsZSAhPT0gZmFsc2UgPyB0YWJJbmRleCA6IHVuZGVmaW5lZCwgb25LZXlEb3duOiBvbktleURvd24sIG9uRm9jdXM6IG9uRm9jdXMsIG9uQmx1cjogb25CbHVyLCB2YWx1ZTogXCJcIiwgb25DaGFuZ2U6IG5vb3AgfSkpLFxuICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFZpcnR1YWxMaXN0LCBPYmplY3QuYXNzaWduKHt9LCBkb21Qcm9wcywgeyBkaXNhYmxlZDogZGlzYWJsZVZpcnR1YWwsIGRhdGE6IG1lcmdlZERhdGEsIGl0ZW1LZXk6IGl0ZW1LZXksIGhlaWdodDogaGVpZ2h0LCBmdWxsSGVpZ2h0OiBmYWxzZSwgdmlydHVhbDogdmlydHVhbCwgaXRlbUhlaWdodDogaXRlbUhlaWdodCwgb25Ta2lwUmVuZGVyOiBvbk1vdGlvbkVuZCwgcHJlZml4Q2xzOiBgJHtwcmVmaXhDbHN9LWxpc3RgLCByZWY6IGxpc3RSZWYgfSksICh0cmVlTm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBwb3MsIGRhdGE6IHsga2V5LCAuLi5yZXN0UHJvcHMgfSwgaXNTdGFydCwgaXNFbmQsIH0gPSB0cmVlTm9kZTtcbiAgICAgICAgICAgIGNvbnN0IG1lcmdlZEtleSA9IGdldEtleShrZXksIHBvcyk7XG4gICAgICAgICAgICBkZWxldGUgcmVzdFByb3BzLmNoaWxkcmVuO1xuICAgICAgICAgICAgY29uc3QgdHJlZU5vZGVQcm9wcyA9IGdldFRyZWVOb2RlUHJvcHMobWVyZ2VkS2V5LCB0cmVlTm9kZVJlcXVpcmVkUHJvcHMpO1xuICAgICAgICAgICAgcmV0dXJuIChSZWFjdC5jcmVhdGVFbGVtZW50KE1vdGlvblRyZWVOb2RlLCBPYmplY3QuYXNzaWduKHt9LCByZXN0UHJvcHMsIHRyZWVOb2RlUHJvcHMsIHsgXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIGFjdGl2ZTogYWN0aXZlSXRlbSAmJiBrZXkgPT09IGFjdGl2ZUl0ZW0uZGF0YS5rZXksIHBvczogcG9zLCBkYXRhOiB0cmVlTm9kZS5kYXRhLCBpc1N0YXJ0OiBpc1N0YXJ0LCBpc0VuZDogaXNFbmQsIG1vdGlvbjogbW90aW9uLCBtb3Rpb25Ob2Rlczoga2V5ID09PSBNT1RJT05fS0VZID8gdHJhbnNpdGlvblJhbmdlIDogbnVsbCwgbW90aW9uVHlwZTogbW90aW9uVHlwZSwgb25Nb3Rpb25FbmQ6IG9uTW90aW9uRW5kLCB0cmVlTm9kZVJlcXVpcmVkUHJvcHM6IHRyZWVOb2RlUmVxdWlyZWRQcm9wcywgb25Nb3VzZU1vdmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICBvbkFjdGl2ZUNoYW5nZShudWxsKTtcbiAgICAgICAgICAgICAgICB9IH0pKSk7XG4gICAgICAgIH0pKSk7XG59O1xuY29uc3QgTm9kZUxpc3QgPSBSZWFjdC5mb3J3YXJkUmVmKFJlZk5vZGVMaXN0KTtcbk5vZGVMaXN0LmRpc3BsYXlOYW1lID0gJ05vZGVMaXN0JztcbmV4cG9ydCBkZWZhdWx0IE5vZGVMaXN0O1xuIl19