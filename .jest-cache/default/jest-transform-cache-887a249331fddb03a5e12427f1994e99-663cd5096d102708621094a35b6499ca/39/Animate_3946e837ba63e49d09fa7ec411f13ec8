f3cc667a7d7a93cdd774eed465afc2dd
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _react = require("react");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _omit = _interopRequireDefault(require("lodash/omit"));

var _noop = _interopRequireDefault(require("lodash/noop"));

var _ChildrenUtils = require("./ChildrenUtils");

var _AnimateChild = _interopRequireDefault(require("./AnimateChild"));

var _util = _interopRequireDefault(require("./util"));

var defaultKey = "animate_".concat(Date.now());

function getChildrenFromProps(props) {
  var children = props.children;

  if ((0, _react.isValidElement)(children)) {
    if (!children.key) {
      return (0, _react.cloneElement)(children, {
        key: defaultKey
      });
    }
  }

  return children;
}

var Animate =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(Animate, _Component);

  function Animate() {
    var _this;

    (0, _classCallCheck2["default"])(this, Animate);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(Animate).apply(this, arguments));
    _this.currentlyAnimatingKeys = {};
    _this.keysToEnter = [];
    _this.keysToLeave = [];
    _this.state = {
      children: (0, _ChildrenUtils.toArrayChildren)(getChildrenFromProps(_this.props))
    };
    _this.childrenRefs = {};

    _this.performEnter = function (key) {
      var childRef = _this.childrenRefs[key];

      if (childRef) {
        _this.currentlyAnimatingKeys[key] = true;
        childRef.componentWillEnter(_this.handleDoneAdding.bind((0, _assertThisInitialized2["default"])(_this), key, 'enter'));
      }
    };

    _this.performAppear = function (key) {
      var childRef = _this.childrenRefs[key];

      if (childRef) {
        _this.currentlyAnimatingKeys[key] = true;
        childRef.componentWillAppear(_this.handleDoneAdding.bind((0, _assertThisInitialized2["default"])(_this), key, 'appear'));
      }
    };

    _this.handleDoneAdding = function (key, type, childRef) {
      var _assertThisInitialize = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize.props;

      var exclusive = props.exclusive,
          _props$onAppear = props.onAppear,
          onAppear = _props$onAppear === void 0 ? _noop["default"] : _props$onAppear,
          _props$onEnd = props.onEnd,
          onEnd = _props$onEnd === void 0 ? _noop["default"] : _props$onEnd,
          _props$onEnter = props.onEnter,
          onEnter = _props$onEnter === void 0 ? _noop["default"] : _props$onEnter;
      delete _this.currentlyAnimatingKeys[key];

      if (exclusive && props !== _this.nextProps) {
        return;
      }

      if (!_this.isValidChildByKey((0, _ChildrenUtils.toArrayChildren)(getChildrenFromProps(props)), key)) {
        _this.performLeave(key);
      } else if (type === 'appear') {
        if (_util["default"].allowAppearCallback(props)) {
          onAppear(key, childRef);
          onEnd(key, true, childRef);
        }
      } else if (_util["default"].allowEnterCallback(props)) {
        onEnter(key, childRef);
        onEnd(key, true, childRef);
      }
    };

    _this.performLeave = function (key) {
      var childRef = _this.childrenRefs[key];

      if (childRef) {
        _this.currentlyAnimatingKeys[key] = true;
        childRef.componentWillLeave(_this.handleDoneLeaving.bind((0, _assertThisInitialized2["default"])(_this), key));
      }
    };

    _this.handleDoneLeaving = function (key, childRef) {
      var _assertThisInitialize2 = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize2.props,
          children = _assertThisInitialize2.state.children;

      var exclusive = props.exclusive,
          _props$onEnd2 = props.onEnd,
          onEnd = _props$onEnd2 === void 0 ? _noop["default"] : _props$onEnd2,
          _props$onLeave = props.onLeave,
          onLeave = _props$onLeave === void 0 ? _noop["default"] : _props$onLeave,
          hiddenProp = props.hiddenProp;
      delete _this.currentlyAnimatingKeys[key];

      if (exclusive && props !== _this.nextProps) {
        return;
      }

      var currentChildren = (0, _ChildrenUtils.toArrayChildren)(getChildrenFromProps(props));

      if (_this.isValidChildByKey(currentChildren, key)) {
        _this.performEnter(key);
      } else {
        var end = function end() {
          if (_util["default"].allowLeaveCallback(props)) {
            onLeave(key, childRef);
            onEnd(key, false, childRef);
          }
        };

        if (!(0, _ChildrenUtils.isSameChildren)(children, currentChildren, hiddenProp)) {
          _this.setState({
            children: currentChildren
          }, end);
        } else {
          end();
        }
      }
    };

    return _this;
  }

  (0, _createClass2["default"])(Animate, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this2 = this;

      var hiddenProp = this.props.hiddenProp;
      var children = this.state.children;

      if (hiddenProp) {
        children = children.filter(function (child) {
          return !child.props[hiddenProp];
        });
      }

      children.forEach(function (child) {
        if (child && child.key) {
          _this2.performAppear(child.key);
        }
      });
    }
  }, {
    key: "componentWillReceiveProps",
    value: function componentWillReceiveProps(nextProps) {
      var _this3 = this;

      this.nextProps = nextProps;
      var nextChildren = (0, _ChildrenUtils.toArrayChildren)(getChildrenFromProps(nextProps));
      var _this$props = this.props,
          exclusive = _this$props.exclusive,
          hiddenProp = _this$props.hiddenProp;
      var children = this.state.children;
      var currentlyAnimatingKeys = this.currentlyAnimatingKeys;

      if (exclusive) {
        Object.keys(currentlyAnimatingKeys).forEach(function (key) {
          return _this3.stop(key);
        });
      }

      var currentChildren = exclusive ? (0, _ChildrenUtils.toArrayChildren)(getChildrenFromProps(this.props)) : children;
      var newChildren = [];

      if (hiddenProp) {
        nextChildren.forEach(function (nextChild) {
          if (nextChild) {
            var newChild;
            var currentChild = (0, _ChildrenUtils.findChildInChildrenByKey)(currentChildren, nextChild.key);

            if (nextChild.props[hiddenProp] && currentChild && !currentChild.props[hiddenProp]) {
              newChild = (0, _react.cloneElement)(nextChild, (0, _defineProperty2["default"])({}, hiddenProp, false));
            } else {
              newChild = nextChild;
            }

            if (newChild) {
              newChildren.push(newChild);
            }
          }
        });
        newChildren = (0, _ChildrenUtils.mergeChildren)(currentChildren, newChildren);
      } else {
        newChildren = (0, _ChildrenUtils.mergeChildren)(currentChildren, nextChildren);
      }

      this.setState({
        children: newChildren
      });
      nextChildren.forEach(function (child) {
        var key = child && child.key;

        if (key) {
          if (child && currentlyAnimatingKeys[key]) {
            return;
          }

          var hasPrev = child && (0, _ChildrenUtils.findChildInChildrenByKey)(currentChildren, key);

          if (hiddenProp) {
            var showInNext = !child.props[hiddenProp];

            if (hasPrev) {
              var showInNow = (0, _ChildrenUtils.findShownChildInChildrenByKey)(currentChildren, key, hiddenProp);

              if (!showInNow && showInNext) {
                _this3.keysToEnter.push(key);
              }
            } else if (showInNext) {
              _this3.keysToEnter.push(key);
            }
          } else if (!hasPrev) {
            _this3.keysToEnter.push(key);
          }
        }
      });
      currentChildren.forEach(function (child) {
        var key = child && child.key;

        if (key) {
          if (child && currentlyAnimatingKeys[key]) {
            return;
          }

          var hasNext = child && (0, _ChildrenUtils.findChildInChildrenByKey)(nextChildren, key);

          if (hiddenProp) {
            var showInNow = !child.props[hiddenProp];

            if (hasNext) {
              var showInNext = (0, _ChildrenUtils.findShownChildInChildrenByKey)(nextChildren, key, hiddenProp);

              if (!showInNext && showInNow) {
                _this3.keysToLeave.push(key);
              }
            } else if (showInNow) {
              _this3.keysToLeave.push(key);
            }
          } else if (!hasNext) {
            _this3.keysToLeave.push(key);
          }
        }
      });
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate() {
      var keysToEnter = this.keysToEnter;
      this.keysToEnter = [];
      keysToEnter.forEach(this.performEnter);
      var keysToLeave = this.keysToLeave;
      this.keysToLeave = [];
      keysToLeave.forEach(this.performLeave);
    }
  }, {
    key: "isValidChildByKey",
    value: function isValidChildByKey(currentChildren, key) {
      var hiddenProp = this.props.hiddenProp;

      if (hiddenProp) {
        return !!(0, _ChildrenUtils.findShownChildInChildrenByKey)(currentChildren, key, hiddenProp);
      }

      return !!(0, _ChildrenUtils.findChildInChildrenByKey)(currentChildren, key);
    }
  }, {
    key: "stop",
    value: function stop(key) {
      delete this.currentlyAnimatingKeys[key];
      var component = this.childrenRefs[key];

      if (component) {
        component.stop();
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _this4 = this;

      var props = this.props;
      this.nextProps = props;
      var animation = props.animation,
          transitionName = props.transitionName,
          transitionEnter = props.transitionEnter,
          transitionAppear = props.transitionAppear,
          transitionLeave = props.transitionLeave,
          Cmp = props.component,
          componentProps = props.componentProps,
          otherProps = (0, _objectWithoutProperties2["default"])(props, ["animation", "transitionName", "transitionEnter", "transitionAppear", "transitionLeave", "component", "componentProps"]);
      var stateChildren = this.state.children;
      var children = [];

      if (stateChildren) {
        children = stateChildren.map(function (child) {
          if (child === null || child === undefined) {
            return child;
          }

          if (!child.key) {
            throw new Error('must set key for animate children');
          }

          return (0, _react.createElement)(_AnimateChild["default"], {
            key: child.key,
            ref: function ref(node) {
              if (child.key) {
                _this4.childrenRefs[child.key] = node;
              }
            },
            animation: animation,
            transitionName: transitionName,
            transitionEnter: transitionEnter,
            transitionAppear: transitionAppear,
            transitionLeave: transitionLeave
          }, child);
        });
      }

      if (Cmp) {
        var passedProps = (0, _omit["default"])(otherProps, ['exclusive', 'onEnd', 'onEnter', 'onLeave', 'onAppear', 'hiddenProp']);
        return (0, _react.createElement)(Cmp, (0, _objectSpread2["default"])({}, passedProps, {}, componentProps), children);
      }

      return children[0] || null;
    }
  }]);
  return Animate;
}(_react.Component);

exports["default"] = Animate;
Animate.displayName = 'Animate';
Animate.propTypes = {
  component: _propTypes["default"].any,
  componentProps: _propTypes["default"].object,
  animation: _propTypes["default"].object,
  transitionName: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].object]),
  transitionEnter: _propTypes["default"].bool,
  transitionAppear: _propTypes["default"].bool,
  exclusive: _propTypes["default"].bool,
  transitionLeave: _propTypes["default"].bool,
  onEnd: _propTypes["default"].func,
  onEnter: _propTypes["default"].func,
  onLeave: _propTypes["default"].func,
  onAppear: _propTypes["default"].func,
  hiddenProp: _propTypes["default"].string
};
Animate.defaultProps = {
  animation: {},
  component: 'span',
  componentProps: {},
  transitionEnter: true,
  transitionLeave: true,
  transitionAppear: false
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFuaW1hdGUvQW5pbWF0ZS5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0S2V5IiwiRGF0ZSIsImNoaWxkcmVuIiwicHJvcHMiLCJrZXkiLCJBbmltYXRlIiwiQ29tcG9uZW50IiwiZ2V0Q2hpbGRyZW5Gcm9tUHJvcHMiLCJjaGlsZFJlZiIsImV4Y2x1c2l2ZSIsIm9uQXBwZWFyIiwibm9vcCIsIm9uRW5kIiwib25FbnRlciIsInR5cGUiLCJhbmltVXRpbCIsIm9uTGVhdmUiLCJoaWRkZW5Qcm9wIiwiY3VycmVudENoaWxkcmVuIiwiZW5kIiwiY2hpbGQiLCJuZXh0UHJvcHMiLCJuZXh0Q2hpbGRyZW4iLCJjdXJyZW50bHlBbmltYXRpbmdLZXlzIiwiT2JqZWN0IiwibmV3Q2hpbGRyZW4iLCJjdXJyZW50Q2hpbGQiLCJuZXh0Q2hpbGQiLCJuZXdDaGlsZCIsImhhc1ByZXYiLCJzaG93SW5OZXh0Iiwic2hvd0luTm93IiwiaGFzTmV4dCIsImtleXNUb0VudGVyIiwia2V5c1RvTGVhdmUiLCJjb21wb25lbnQiLCJhbmltYXRpb24iLCJ0cmFuc2l0aW9uTmFtZSIsInRyYW5zaXRpb25FbnRlciIsInRyYW5zaXRpb25BcHBlYXIiLCJ0cmFuc2l0aW9uTGVhdmUiLCJDbXAiLCJjb21wb25lbnRQcm9wcyIsIm90aGVyUHJvcHMiLCJzdGF0ZUNoaWxkcmVuIiwiQW5pbWF0ZUNoaWxkIiwicmVmIiwicGFzc2VkUHJvcHMiLCJQcm9wVHlwZXMiLCJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUEsTUFBQSxHQUFBLE9BQUEsQ0FBQSxPQUFBLENBQUE7O0FBQ0EsSUFBQSxVQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxLQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsYUFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxLQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENB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O0FBT2hCdkMsRUFBQUEsU0FBUyxFQUFFdUMsVUFBQUEsQ0FBQUEsU0FBQUEsQ0FBQUEsQ0FQSyxJQUFBO0FBUWhCUixFQUFBQSxlQUFlLEVBQUVRLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBUkQsSUFBQTtBQVNoQnBDLEVBQUFBLEtBQUssRUFBRW9DLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBVFMsSUFBQTtBQVVoQm5DLEVBQUFBLE9BQU8sRUFBRW1DLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBVk8sSUFBQTtBQVdoQmhDLEVBQUFBLE9BQU8sRUFBRWdDLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBWE8sSUFBQTtBQVloQnRDLEVBQUFBLFFBQVEsRUFBRXNDLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBWk0sSUFBQTtBQWFoQi9CLEVBQUFBLFVBQVUsRUFBRStCLFVBQUFBLENBQUFBLFNBQUFBLENBQUFBLENBQVVDO0FBYk4sQ0FBcEI1QztBQWVBQSxPQUFPLENBQVBBLFlBQUFBLEdBQXVCO0FBQ25CK0IsRUFBQUEsU0FBUyxFQURVLEVBQUE7QUFFbkJELEVBQUFBLFNBQVMsRUFGVSxNQUFBO0FBR25CTyxFQUFBQSxjQUFjLEVBSEssRUFBQTtBQUluQkosRUFBQUEsZUFBZSxFQUpJLElBQUE7QUFLbkJFLEVBQUFBLGVBQWUsRUFMSSxJQUFBO0FBTW5CRCxFQUFBQSxnQkFBZ0IsRUFBRTtBQU5DLENBQXZCbEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjbG9uZUVsZW1lbnQsIENvbXBvbmVudCwgY3JlYXRlRWxlbWVudCwgaXNWYWxpZEVsZW1lbnQsIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBvbWl0IGZyb20gJ2xvZGFzaC9vbWl0JztcbmltcG9ydCBub29wIGZyb20gJ2xvZGFzaC9ub29wJztcbmltcG9ydCB7IGZpbmRDaGlsZEluQ2hpbGRyZW5CeUtleSwgZmluZFNob3duQ2hpbGRJbkNoaWxkcmVuQnlLZXksIGlzU2FtZUNoaWxkcmVuLCBtZXJnZUNoaWxkcmVuLCB0b0FycmF5Q2hpbGRyZW4sIH0gZnJvbSAnLi9DaGlsZHJlblV0aWxzJztcbmltcG9ydCBBbmltYXRlQ2hpbGQgZnJvbSAnLi9BbmltYXRlQ2hpbGQnO1xuaW1wb3J0IGFuaW1VdGlsIGZyb20gJy4vdXRpbCc7XG5jb25zdCBkZWZhdWx0S2V5ID0gYGFuaW1hdGVfJHtEYXRlLm5vdygpfWA7XG5mdW5jdGlvbiBnZXRDaGlsZHJlbkZyb21Qcm9wcyhwcm9wcykge1xuICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHByb3BzO1xuICAgIGlmIChpc1ZhbGlkRWxlbWVudChjaGlsZHJlbikpIHtcbiAgICAgICAgaWYgKCFjaGlsZHJlbi5rZXkpIHtcbiAgICAgICAgICAgIHJldHVybiBjbG9uZUVsZW1lbnQoY2hpbGRyZW4sIHtcbiAgICAgICAgICAgICAgICBrZXk6IGRlZmF1bHRLZXksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY2hpbGRyZW47XG59XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBbmltYXRlIGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoLi4uYXJndW1lbnRzKTtcbiAgICAgICAgdGhpcy5jdXJyZW50bHlBbmltYXRpbmdLZXlzID0ge307XG4gICAgICAgIHRoaXMua2V5c1RvRW50ZXIgPSBbXTtcbiAgICAgICAgdGhpcy5rZXlzVG9MZWF2ZSA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgY2hpbGRyZW46IHRvQXJyYXlDaGlsZHJlbihnZXRDaGlsZHJlbkZyb21Qcm9wcyh0aGlzLnByb3BzKSksXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuY2hpbGRyZW5SZWZzID0ge307XG4gICAgICAgIHRoaXMucGVyZm9ybUVudGVyID0gKGtleSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hpbGRSZWYgPSB0aGlzLmNoaWxkcmVuUmVmc1trZXldO1xuICAgICAgICAgICAgaWYgKGNoaWxkUmVmKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50bHlBbmltYXRpbmdLZXlzW2tleV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNoaWxkUmVmLmNvbXBvbmVudFdpbGxFbnRlcih0aGlzLmhhbmRsZURvbmVBZGRpbmcuYmluZCh0aGlzLCBrZXksICdlbnRlcicpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5wZXJmb3JtQXBwZWFyID0gKGtleSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hpbGRSZWYgPSB0aGlzLmNoaWxkcmVuUmVmc1trZXldO1xuICAgICAgICAgICAgaWYgKGNoaWxkUmVmKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50bHlBbmltYXRpbmdLZXlzW2tleV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNoaWxkUmVmLmNvbXBvbmVudFdpbGxBcHBlYXIodGhpcy5oYW5kbGVEb25lQWRkaW5nLmJpbmQodGhpcywga2V5LCAnYXBwZWFyJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZURvbmVBZGRpbmcgPSAoa2V5LCB0eXBlLCBjaGlsZFJlZikgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgICAgICAgIGNvbnN0IHsgZXhjbHVzaXZlLCBvbkFwcGVhciA9IG5vb3AsIG9uRW5kID0gbm9vcCwgb25FbnRlciA9IG5vb3AgfSA9IHByb3BzO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3VycmVudGx5QW5pbWF0aW5nS2V5c1trZXldO1xuICAgICAgICAgICAgaWYgKGV4Y2x1c2l2ZSAmJiBwcm9wcyAhPT0gdGhpcy5uZXh0UHJvcHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZENoaWxkQnlLZXkodG9BcnJheUNoaWxkcmVuKGdldENoaWxkcmVuRnJvbVByb3BzKHByb3BzKSksIGtleSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcmZvcm1MZWF2ZShrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2FwcGVhcicpIHtcbiAgICAgICAgICAgICAgICBpZiAoYW5pbVV0aWwuYWxsb3dBcHBlYXJDYWxsYmFjayhwcm9wcykpIHtcbiAgICAgICAgICAgICAgICAgICAgb25BcHBlYXIoa2V5LCBjaGlsZFJlZik7XG4gICAgICAgICAgICAgICAgICAgIG9uRW5kKGtleSwgdHJ1ZSwgY2hpbGRSZWYpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGFuaW1VdGlsLmFsbG93RW50ZXJDYWxsYmFjayhwcm9wcykpIHtcbiAgICAgICAgICAgICAgICBvbkVudGVyKGtleSwgY2hpbGRSZWYpO1xuICAgICAgICAgICAgICAgIG9uRW5kKGtleSwgdHJ1ZSwgY2hpbGRSZWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnBlcmZvcm1MZWF2ZSA9IChrZXkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkUmVmID0gdGhpcy5jaGlsZHJlblJlZnNba2V5XTtcbiAgICAgICAgICAgIGlmIChjaGlsZFJlZikge1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudGx5QW5pbWF0aW5nS2V5c1trZXldID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjaGlsZFJlZi5jb21wb25lbnRXaWxsTGVhdmUodGhpcy5oYW5kbGVEb25lTGVhdmluZy5iaW5kKHRoaXMsIGtleSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZURvbmVMZWF2aW5nID0gKGtleSwgY2hpbGRSZWYpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgcHJvcHMsIHN0YXRlOiB7IGNoaWxkcmVuIH0sIH0gPSB0aGlzO1xuICAgICAgICAgICAgY29uc3QgeyBleGNsdXNpdmUsIG9uRW5kID0gbm9vcCwgb25MZWF2ZSA9IG5vb3AsIGhpZGRlblByb3AgfSA9IHByb3BzO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3VycmVudGx5QW5pbWF0aW5nS2V5c1trZXldO1xuICAgICAgICAgICAgaWYgKGV4Y2x1c2l2ZSAmJiBwcm9wcyAhPT0gdGhpcy5uZXh0UHJvcHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50Q2hpbGRyZW4gPSB0b0FycmF5Q2hpbGRyZW4oZ2V0Q2hpbGRyZW5Gcm9tUHJvcHMocHJvcHMpKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzVmFsaWRDaGlsZEJ5S2V5KGN1cnJlbnRDaGlsZHJlbiwga2V5KSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGVyZm9ybUVudGVyKGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbmQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltVXRpbC5hbGxvd0xlYXZlQ2FsbGJhY2socHJvcHMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkxlYXZlKGtleSwgY2hpbGRSZWYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb25FbmQoa2V5LCBmYWxzZSwgY2hpbGRSZWYpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzU2FtZUNoaWxkcmVuKGNoaWxkcmVuLCBjdXJyZW50Q2hpbGRyZW4sIGhpZGRlblByb3ApKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IGN1cnJlbnRDaGlsZHJlbixcbiAgICAgICAgICAgICAgICAgICAgfSwgZW5kKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGVuZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgaGlkZGVuUHJvcCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgbGV0IHsgY2hpbGRyZW4gfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGlmIChoaWRkZW5Qcm9wKSB7XG4gICAgICAgICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuLmZpbHRlcihjaGlsZCA9PiAhY2hpbGQucHJvcHNbaGlkZGVuUHJvcF0pO1xuICAgICAgICB9XG4gICAgICAgIGNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICAgICAgaWYgKGNoaWxkICYmIGNoaWxkLmtleSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGVyZm9ybUFwcGVhcihjaGlsZC5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICAgICAgdGhpcy5uZXh0UHJvcHMgPSBuZXh0UHJvcHM7XG4gICAgICAgIGNvbnN0IG5leHRDaGlsZHJlbiA9IHRvQXJyYXlDaGlsZHJlbihnZXRDaGlsZHJlbkZyb21Qcm9wcyhuZXh0UHJvcHMpKTtcbiAgICAgICAgY29uc3QgeyBleGNsdXNpdmUsIGhpZGRlblByb3AgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRseUFuaW1hdGluZ0tleXMgPSB0aGlzLmN1cnJlbnRseUFuaW1hdGluZ0tleXM7XG4gICAgICAgIGlmIChleGNsdXNpdmUpIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGN1cnJlbnRseUFuaW1hdGluZ0tleXMpLmZvckVhY2goa2V5ID0+IHRoaXMuc3RvcChrZXkpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjdXJyZW50Q2hpbGRyZW4gPSBleGNsdXNpdmVcbiAgICAgICAgICAgID8gdG9BcnJheUNoaWxkcmVuKGdldENoaWxkcmVuRnJvbVByb3BzKHRoaXMucHJvcHMpKVxuICAgICAgICAgICAgOiBjaGlsZHJlbjtcbiAgICAgICAgbGV0IG5ld0NoaWxkcmVuID0gW107XG4gICAgICAgIGlmIChoaWRkZW5Qcm9wKSB7XG4gICAgICAgICAgICBuZXh0Q2hpbGRyZW4uZm9yRWFjaChuZXh0Q2hpbGQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChuZXh0Q2hpbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld0NoaWxkO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Q2hpbGQgPSBmaW5kQ2hpbGRJbkNoaWxkcmVuQnlLZXkoY3VycmVudENoaWxkcmVuLCBuZXh0Q2hpbGQua2V5KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRDaGlsZC5wcm9wc1toaWRkZW5Qcm9wXSAmJiBjdXJyZW50Q2hpbGQgJiYgIWN1cnJlbnRDaGlsZC5wcm9wc1toaWRkZW5Qcm9wXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBjbG9uZUVsZW1lbnQobmV4dENoaWxkLCB7IFtoaWRkZW5Qcm9wXTogZmFsc2UgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdDaGlsZCA9IG5leHRDaGlsZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NoaWxkcmVuLnB1c2gobmV3Q2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBuZXdDaGlsZHJlbiA9IG1lcmdlQ2hpbGRyZW4oY3VycmVudENoaWxkcmVuLCBuZXdDaGlsZHJlbik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBuZXdDaGlsZHJlbiA9IG1lcmdlQ2hpbGRyZW4oY3VycmVudENoaWxkcmVuLCBuZXh0Q2hpbGRyZW4pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgY2hpbGRyZW46IG5ld0NoaWxkcmVuLFxuICAgICAgICB9KTtcbiAgICAgICAgbmV4dENoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICAgICAgY29uc3Qga2V5ID0gY2hpbGQgJiYgY2hpbGQua2V5O1xuICAgICAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCAmJiBjdXJyZW50bHlBbmltYXRpbmdLZXlzW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBoYXNQcmV2ID0gY2hpbGQgJiYgZmluZENoaWxkSW5DaGlsZHJlbkJ5S2V5KGN1cnJlbnRDaGlsZHJlbiwga2V5KTtcbiAgICAgICAgICAgICAgICBpZiAoaGlkZGVuUHJvcCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG93SW5OZXh0ID0gIWNoaWxkLnByb3BzW2hpZGRlblByb3BdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzUHJldikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd0luTm93ID0gZmluZFNob3duQ2hpbGRJbkNoaWxkcmVuQnlLZXkoY3VycmVudENoaWxkcmVuLCBrZXksIGhpZGRlblByb3ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzaG93SW5Ob3cgJiYgc2hvd0luTmV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMua2V5c1RvRW50ZXIucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNob3dJbk5leHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMua2V5c1RvRW50ZXIucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFoYXNQcmV2KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMua2V5c1RvRW50ZXIucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGN1cnJlbnRDaGlsZHJlbi5mb3JFYWNoKGNoaWxkID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IGNoaWxkICYmIGNoaWxkLmtleTtcbiAgICAgICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgJiYgY3VycmVudGx5QW5pbWF0aW5nS2V5c1trZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzTmV4dCA9IGNoaWxkICYmIGZpbmRDaGlsZEluQ2hpbGRyZW5CeUtleShuZXh0Q2hpbGRyZW4sIGtleSk7XG4gICAgICAgICAgICAgICAgaWYgKGhpZGRlblByb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd0luTm93ID0gIWNoaWxkLnByb3BzW2hpZGRlblByb3BdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTmV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd0luTmV4dCA9IGZpbmRTaG93bkNoaWxkSW5DaGlsZHJlbkJ5S2V5KG5leHRDaGlsZHJlbiwga2V5LCBoaWRkZW5Qcm9wKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2hvd0luTmV4dCAmJiBzaG93SW5Ob3cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtleXNUb0xlYXZlLnB1c2goa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzaG93SW5Ob3cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMua2V5c1RvTGVhdmUucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFoYXNOZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMua2V5c1RvTGVhdmUucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAgICAgY29uc3Qga2V5c1RvRW50ZXIgPSB0aGlzLmtleXNUb0VudGVyO1xuICAgICAgICB0aGlzLmtleXNUb0VudGVyID0gW107XG4gICAgICAgIGtleXNUb0VudGVyLmZvckVhY2godGhpcy5wZXJmb3JtRW50ZXIpO1xuICAgICAgICBjb25zdCBrZXlzVG9MZWF2ZSA9IHRoaXMua2V5c1RvTGVhdmU7XG4gICAgICAgIHRoaXMua2V5c1RvTGVhdmUgPSBbXTtcbiAgICAgICAga2V5c1RvTGVhdmUuZm9yRWFjaCh0aGlzLnBlcmZvcm1MZWF2ZSk7XG4gICAgfVxuICAgIGlzVmFsaWRDaGlsZEJ5S2V5KGN1cnJlbnRDaGlsZHJlbiwga2V5KSB7XG4gICAgICAgIGNvbnN0IHsgaGlkZGVuUHJvcCB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgaWYgKGhpZGRlblByb3ApIHtcbiAgICAgICAgICAgIHJldHVybiAhIWZpbmRTaG93bkNoaWxkSW5DaGlsZHJlbkJ5S2V5KGN1cnJlbnRDaGlsZHJlbiwga2V5LCBoaWRkZW5Qcm9wKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gISFmaW5kQ2hpbGRJbkNoaWxkcmVuQnlLZXkoY3VycmVudENoaWxkcmVuLCBrZXkpO1xuICAgIH1cbiAgICBzdG9wKGtleSkge1xuICAgICAgICBkZWxldGUgdGhpcy5jdXJyZW50bHlBbmltYXRpbmdLZXlzW2tleV07XG4gICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IHRoaXMuY2hpbGRyZW5SZWZzW2tleV07XG4gICAgICAgIGlmIChjb21wb25lbnQpIHtcbiAgICAgICAgICAgIGNvbXBvbmVudC5zdG9wKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgICAgICB0aGlzLm5leHRQcm9wcyA9IHByb3BzO1xuICAgICAgICBjb25zdCB7IGFuaW1hdGlvbiwgdHJhbnNpdGlvbk5hbWUsIHRyYW5zaXRpb25FbnRlciwgdHJhbnNpdGlvbkFwcGVhciwgdHJhbnNpdGlvbkxlYXZlLCBjb21wb25lbnQ6IENtcCwgY29tcG9uZW50UHJvcHMsIC4uLm90aGVyUHJvcHMgfSA9IHByb3BzO1xuICAgICAgICBjb25zdCB7IGNoaWxkcmVuOiBzdGF0ZUNoaWxkcmVuIH0gPSB0aGlzLnN0YXRlO1xuICAgICAgICBsZXQgY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgaWYgKHN0YXRlQ2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNoaWxkcmVuID0gc3RhdGVDaGlsZHJlbi5tYXAoY2hpbGQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCBjaGlsZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFjaGlsZC5rZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IHNldCBrZXkgZm9yIGFuaW1hdGUgY2hpbGRyZW4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQoQW5pbWF0ZUNoaWxkLCB7XG4gICAgICAgICAgICAgICAgICAgIGtleTogY2hpbGQua2V5LFxuICAgICAgICAgICAgICAgICAgICByZWY6IG5vZGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5SZWZzW2NoaWxkLmtleV0gPSBub2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBhbmltYXRpb24sXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25OYW1lLFxuICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRW50ZXIsXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25BcHBlYXIsXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25MZWF2ZSxcbiAgICAgICAgICAgICAgICB9LCBjaGlsZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoQ21wKSB7XG4gICAgICAgICAgICBjb25zdCBwYXNzZWRQcm9wcyA9IG9taXQob3RoZXJQcm9wcywgW1xuICAgICAgICAgICAgICAgICdleGNsdXNpdmUnLFxuICAgICAgICAgICAgICAgICdvbkVuZCcsXG4gICAgICAgICAgICAgICAgJ29uRW50ZXInLFxuICAgICAgICAgICAgICAgICdvbkxlYXZlJyxcbiAgICAgICAgICAgICAgICAnb25BcHBlYXInLFxuICAgICAgICAgICAgICAgICdoaWRkZW5Qcm9wJyxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQoQ21wLCB7XG4gICAgICAgICAgICAgICAgLi4ucGFzc2VkUHJvcHMsXG4gICAgICAgICAgICAgICAgLi4uY29tcG9uZW50UHJvcHMsXG4gICAgICAgICAgICB9LCBjaGlsZHJlbik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNoaWxkcmVuWzBdIHx8IG51bGw7XG4gICAgfVxufVxuQW5pbWF0ZS5kaXNwbGF5TmFtZSA9ICdBbmltYXRlJztcbkFuaW1hdGUucHJvcFR5cGVzID0ge1xuICAgIGNvbXBvbmVudDogUHJvcFR5cGVzLmFueSxcbiAgICBjb21wb25lbnRQcm9wczogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBhbmltYXRpb246IFByb3BUeXBlcy5vYmplY3QsXG4gICAgdHJhbnNpdGlvbk5hbWU6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zdHJpbmcsIFByb3BUeXBlcy5vYmplY3RdKSxcbiAgICB0cmFuc2l0aW9uRW50ZXI6IFByb3BUeXBlcy5ib29sLFxuICAgIHRyYW5zaXRpb25BcHBlYXI6IFByb3BUeXBlcy5ib29sLFxuICAgIGV4Y2x1c2l2ZTogUHJvcFR5cGVzLmJvb2wsXG4gICAgdHJhbnNpdGlvbkxlYXZlOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBvbkVuZDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25FbnRlcjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25MZWF2ZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25BcHBlYXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIGhpZGRlblByb3A6IFByb3BUeXBlcy5zdHJpbmcsXG59O1xuQW5pbWF0ZS5kZWZhdWx0UHJvcHMgPSB7XG4gICAgYW5pbWF0aW9uOiB7fSxcbiAgICBjb21wb25lbnQ6ICdzcGFuJyxcbiAgICBjb21wb25lbnRQcm9wczoge30sXG4gICAgdHJhbnNpdGlvbkVudGVyOiB0cnVlLFxuICAgIHRyYW5zaXRpb25MZWF2ZTogdHJ1ZSxcbiAgICB0cmFuc2l0aW9uQXBwZWFyOiBmYWxzZSxcbn07XG4iXX0=