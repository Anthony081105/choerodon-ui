52ce8f4be3af7360389f8d44668b7e12
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _classnames = _interopRequireDefault(require("classnames"));

var _uid = _interopRequireDefault(require("./uid"));

var _warning = _interopRequireDefault(require("../../_util/warning"));

var _isString = _interopRequireDefault(require("lodash/isString"));

var _isArray = _interopRequireDefault(require("lodash/isArray"));

var _isObject = _interopRequireDefault(require("lodash/isObject"));

var _toString = _interopRequireDefault(require("lodash/toString"));

var _isNil = _interopRequireDefault(require("lodash/isNil"));

function _createSuper(Derived) {
  function isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  return function () {
    var Super = (0, _getPrototypeOf2["default"])(Derived),
        result;

    if (isNativeReflectConstruct()) {
      var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor;
      result = Reflect.construct(Super, arguments, NewTarget);
    } else {
      result = Super.apply(this, arguments);
    }

    return (0, _possibleConstructorReturn2["default"])(this, result);
  };
}

var IFRAME_STYLE = {
  position: 'absolute',
  top: 0,
  opacity: 0,
  filter: 'alpha(opacity=0)',
  left: 0,
  zIndex: 9999
}; // diferent from AjaxUpload, can only upload on at one time, serial seriously

var IframeUploader =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(IframeUploader, _Component);

  var _super = _createSuper(IframeUploader);

  function IframeUploader() {
    var _this;

    (0, _classCallCheck2["default"])(this, IframeUploader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      uploading: false
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "file", {});
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onLoad", function () {
      if (!_this.state.uploading) {
        return;
      }

      var _assertThisInitialize = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize.props,
          file = _assertThisInitialize.file;

      var response;

      try {
        var doc = _this.getIframeDocument();

        var script = doc.getElementsByTagName('script')[0];

        if (script && script.parentNode === doc.body) {
          doc.body.removeChild(script);
        }

        response = doc.body.innerHTML;
        props.onSuccess(response, file);
      } catch (err) {
        (0, _warning["default"])(false, 'cross domain error for Upload. Maybe server should return document.domain script. see Note from https://github.com/react-component/upload');
        response = 'cross-domain';
        props.onError(err, null, file);
      }

      _this.endUpload();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onChange", function () {
      var target = _this.getFormInputNode(); // ie8/9 don't support FileList Object
      // http://stackoverflow.com/questions/12830058/ie8-input-type-file-get-files


      var file = _this.file = {
        uid: (0, _uid["default"])(),
        name: target.value
      };

      _this.startUpload();

      var _assertThisInitialize2 = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize2.props;

      if (!props.beforeUpload) {
        return _this.post(file);
      }

      var before = props.beforeUpload(file);

      if (before && before.then) {
        before.then(function () {
          _this.post(file);
        }, function () {
          _this.endUpload();
        });
      } else if (before !== false) {
        _this.post(file);
      } else {
        _this.endUpload();
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "saveIframe", function (node) {
      _this.iframe = node;
    });
    return _this;
  }

  (0, _createClass2["default"])(IframeUploader, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this.updateIframeWH();
      this.initIframe();
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate() {
      this.updateIframeWH();
    }
  }, {
    key: "getIframeNode",
    value: function getIframeNode() {
      return this.iframe;
    }
  }, {
    key: "getIframeDocument",
    value: function getIframeDocument() {
      return this.getIframeNode().contentDocument;
    }
  }, {
    key: "getFormNode",
    value: function getFormNode() {
      return this.getIframeDocument().getElementById('form');
    }
  }, {
    key: "getFormInputNode",
    value: function getFormInputNode() {
      return this.getIframeDocument().getElementById('input');
    }
  }, {
    key: "getFormDataNode",
    value: function getFormDataNode() {
      return this.getIframeDocument().getElementById('data');
    }
  }, {
    key: "getFileForMultiple",
    value: function getFileForMultiple(file) {
      return this.props.multiple ? [file] : file;
    }
  }, {
    key: "getIframeHTML",
    value: function getIframeHTML(domain) {
      var domainScript = '';
      var domainInput = '';

      if (domain) {
        var script = 'script';
        domainScript = "<".concat(script, ">document.domain=\"").concat(domain, "\";</").concat(script, ">");
        domainInput = "<input name=\"_documentDomain\" value=\"".concat(domain, "\" />");
      }

      return "\n    <!DOCTYPE html>\n    <html>\n    <head>\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    <style>\n    body,html {padding:0;margin:0;border:0;overflow:hidden;}\n    </style>\n    ".concat(domainScript, "\n    </head>\n    <body>\n    <form method=\"post\"\n    encType=\"multipart/form-data\"\n    action=\"").concat(this.props.action, "\" id=\"form\"\n    style=\"display:block;height:9999px;position:relative;overflow:hidden;\">\n    <input id=\"input\" type=\"file\"\n     name=\"").concat(this.props.name, "\"\n     style=\"position:absolute;top:0;right:0;height:9999px;font-size:9999px;cursor:pointer;\"/>\n    ").concat(domainInput, "\n    <span id=\"data\"></span>\n    </form>\n    </body>\n    </html>\n    ");
    }
  }, {
    key: "initIframeSrc",
    value: function initIframeSrc() {
      if (this.domain) {
        this.getIframeNode().src = "javascript:void((function(){\n        var d = document;\n        d.open();\n        d.domain='".concat(this.domain, "';\n        d.write('');\n        d.close();\n      })())");
      }
    }
  }, {
    key: "initIframe",
    value: function initIframe() {
      var iframeNode = this.getIframeNode();
      var win = iframeNode.contentWindow;
      var doc;
      this.domain = this.domain || '';
      this.initIframeSrc();

      try {
        doc = win.document;
      } catch (e) {
        this.domain = document.domain;
        this.initIframeSrc();
        win = iframeNode.contentWindow;
        doc = win.document;
      }

      doc.open('text/html', 'replace');
      doc.write(this.getIframeHTML(this.domain));
      doc.close();
      this.getFormInputNode().onchange = this.onChange;
    }
  }, {
    key: "endUpload",
    value: function endUpload() {
      if (this.state.uploading) {
        this.file = {}; // hack avoid batch

        this.state.uploading = false;
        this.setState({
          uploading: false
        });
        this.initIframe();
      }
    }
  }, {
    key: "startUpload",
    value: function startUpload() {
      if (!this.state.uploading) {
        this.state.uploading = true;
        this.setState({
          uploading: true
        });
      }
    }
  }, {
    key: "updateIframeWH",
    value: function updateIframeWH() {
      var rootNode = _reactDom["default"].findDOMNode(this);

      var iframeNode = this.getIframeNode();
      iframeNode.style.height = "".concat(rootNode.offsetHeight, "px");
      iframeNode.style.width = "".concat(rootNode.offsetWidth, "px");
    }
  }, {
    key: "abort",
    value: function abort(file) {
      if (file) {
        var uid = file;

        if (file && file.uid) {
          uid = file.uid;
        }

        if (uid === this.file.uid) {
          this.endUpload();
        }
      } else {
        this.endUpload();
      }
    }
  }, {
    key: "post",
    value: function post(file) {
      var formNode = this.getFormNode();
      var dataSpan = this.getFormDataNode();
      var _this$props = this.props,
          data = _this$props.data,
          requestFileKeys = _this$props.requestFileKeys;
      var onStart = this.props.onStart;

      if (typeof data === 'function') {
        data = data(file);
      }

      var inputs = this.requestFileInput(requestFileKeys, file, data);
      dataSpan.appendChild(inputs);
      formNode.submit();
      dataSpan.innerHTML = '';
      onStart(file);
    }
    /**
     * 
     * @param { 需要加入的参数 } requestFileKeys 
     * @param { 文件内容 } file 
     * @param { props的必传参数 } data 
     */

  }, {
    key: "requestFileInput",
    value: function requestFileInput(requestFileKeys, file, data) {
      var inputs = document.createDocumentFragment();
      /** 
       * 添加注入的data数据
       */

      if (data) {
        for (var key in data) {
          if (data.hasOwnProperty(key)) {
            var input = document.createElement('input');
            input.setAttribute('name', key);
            input.value = data[key];
            /**
             * 添加文件数据
             */

            inputs.appendChild(input);
          }
        }
      }

      var toStringValue = function toStringValue(value) {
        if ((0, _isNil["default"])(value)) {
          return '';
        }

        if ((0, _isString["default"])(value)) {
          return value;
        }

        if ((0, _isObject["default"])(value)) {
          return JSON.stringify(value);
        }

        return (0, _toString["default"])(value);
      };
      /**
       * 
       * @param {所有数据} obj 
       * @param {需要传出的参数keys} arrayString 
       */


      var ArrayToObject = function ArrayToObject(obj, arrayString) {
        arrayString.forEach(function (item) {
          var input = document.createElement('input');
          input.setAttribute('name', toStringValue(item));
          input.value = toStringValue(obj[toStringValue(item)]);
          /**
           * 添加文件数据
           */

          inputs.appendChild(input);
        });
      };
      /**
       * 判断是否需要增加key
       */


      if ((0, _isString["default"])(requestFileKeys) || (0, _isArray["default"])(requestFileKeys)) {
        var requestFileKeysFile = ['uid', 'type', 'name', 'lastModifiedDate'];

        if ((0, _isString["default"])(requestFileKeys)) {
          requestFileKeysFile.push(requestFileKeys);
        } else {
          requestFileKeysFile = [].concat((0, _toConsumableArray2["default"])(requestFileKeysFile), (0, _toConsumableArray2["default"])(requestFileKeys));
        }

        ArrayToObject(file, requestFileKeysFile);
      }

      return inputs;
    }
  }, {
    key: "render",
    value: function render() {
      var _classNames;

      var _this$props2 = this.props,
          Tag = _this$props2.component,
          disabled = _this$props2.disabled,
          className = _this$props2.className,
          prefixCls = _this$props2.prefixCls,
          children = _this$props2.children,
          style = _this$props2.style;
      var iframeStyle = (0, _objectSpread2["default"])({}, IFRAME_STYLE, {
        display: this.state.uploading || disabled ? 'none' : ''
      });
      var cls = (0, _classnames["default"])((_classNames = {}, (0, _defineProperty2["default"])(_classNames, prefixCls, true), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-disabled"), disabled), (0, _defineProperty2["default"])(_classNames, className, className), _classNames));
      return _react["default"].createElement(Tag, {
        className: cls,
        style: (0, _objectSpread2["default"])({
          position: 'relative',
          zIndex: 0
        }, style)
      }, _react["default"].createElement("iframe", {
        ref: this.saveIframe,
        onLoad: this.onLoad,
        style: iframeStyle
      }), children);
    }
  }]);
  return IframeUploader;
}(_react.Component);

(0, _defineProperty2["default"])(IframeUploader, "propTypes", {
  component: _propTypes["default"].string,
  style: _propTypes["default"].object,
  disabled: _propTypes["default"].bool,
  prefixCls: _propTypes["default"].string,
  className: _propTypes["default"].string,
  accept: _propTypes["default"].string,
  onStart: _propTypes["default"].func,
  multiple: _propTypes["default"].bool,
  children: _propTypes["default"].any,
  data: _propTypes["default"].oneOfType([_propTypes["default"].object, _propTypes["default"].func]),
  action: _propTypes["default"].string,
  name: _propTypes["default"].string
});
var _default = IframeUploader;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIklmcmFtZVVwbG9hZGVyLmpzeCJdLCJuYW1lcyI6WyJJRlJBTUVfU1RZTEUiLCJwb3NpdGlvbiIsInRvcCIsIm9wYWNpdHkiLCJmaWx0ZXIiLCJsZWZ0IiwiekluZGV4IiwiSWZyYW1lVXBsb2FkZXIiLCJ1cGxvYWRpbmciLCJzdGF0ZSIsInByb3BzIiwiZmlsZSIsInJlc3BvbnNlIiwiZG9jIiwiZ2V0SWZyYW1lRG9jdW1lbnQiLCJzY3JpcHQiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsInBhcmVudE5vZGUiLCJib2R5IiwicmVtb3ZlQ2hpbGQiLCJpbm5lckhUTUwiLCJvblN1Y2Nlc3MiLCJlcnIiLCJvbkVycm9yIiwiZW5kVXBsb2FkIiwidGFyZ2V0IiwiZ2V0Rm9ybUlucHV0Tm9kZSIsInVpZCIsIm5hbWUiLCJ2YWx1ZSIsInN0YXJ0VXBsb2FkIiwiYmVmb3JlVXBsb2FkIiwicG9zdCIsImJlZm9yZSIsInRoZW4iLCJub2RlIiwiaWZyYW1lIiwidXBkYXRlSWZyYW1lV0giLCJpbml0SWZyYW1lIiwiZ2V0SWZyYW1lTm9kZSIsImNvbnRlbnREb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwibXVsdGlwbGUiLCJkb21haW4iLCJkb21haW5TY3JpcHQiLCJkb21haW5JbnB1dCIsImFjdGlvbiIsInNyYyIsImlmcmFtZU5vZGUiLCJ3aW4iLCJjb250ZW50V2luZG93IiwiaW5pdElmcmFtZVNyYyIsImRvY3VtZW50IiwiZSIsIm9wZW4iLCJ3cml0ZSIsImdldElmcmFtZUhUTUwiLCJjbG9zZSIsIm9uY2hhbmdlIiwib25DaGFuZ2UiLCJzZXRTdGF0ZSIsInJvb3ROb2RlIiwiUmVhY3RET00iLCJmaW5kRE9NTm9kZSIsInN0eWxlIiwiaGVpZ2h0Iiwib2Zmc2V0SGVpZ2h0Iiwid2lkdGgiLCJvZmZzZXRXaWR0aCIsImZvcm1Ob2RlIiwiZ2V0Rm9ybU5vZGUiLCJkYXRhU3BhbiIsImdldEZvcm1EYXRhTm9kZSIsImRhdGEiLCJyZXF1ZXN0RmlsZUtleXMiLCJvblN0YXJ0IiwiaW5wdXRzIiwicmVxdWVzdEZpbGVJbnB1dCIsImFwcGVuZENoaWxkIiwic3VibWl0IiwiY3JlYXRlRG9jdW1lbnRGcmFnbWVudCIsImtleSIsImhhc093blByb3BlcnR5IiwiaW5wdXQiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwidG9TdHJpbmdWYWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJBcnJheVRvT2JqZWN0Iiwib2JqIiwiYXJyYXlTdHJpbmciLCJmb3JFYWNoIiwiaXRlbSIsInJlcXVlc3RGaWxlS2V5c0ZpbGUiLCJwdXNoIiwiVGFnIiwiY29tcG9uZW50IiwiZGlzYWJsZWQiLCJjbGFzc05hbWUiLCJwcmVmaXhDbHMiLCJjaGlsZHJlbiIsImlmcmFtZVN0eWxlIiwiZGlzcGxheSIsImNscyIsInNhdmVJZnJhbWUiLCJvbkxvYWQiLCJDb21wb25lbnQiLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJvYmplY3QiLCJib29sIiwiYWNjZXB0IiwiZnVuYyIsImFueSIsIm9uZU9mVHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFlBQVksR0FBRztBQUNuQkMsRUFBQUEsUUFBUSxFQUFFLFVBRFM7QUFFbkJDLEVBQUFBLEdBQUcsRUFBRSxDQUZjO0FBR25CQyxFQUFBQSxPQUFPLEVBQUUsQ0FIVTtBQUluQkMsRUFBQUEsTUFBTSxFQUFFLGtCQUpXO0FBS25CQyxFQUFBQSxJQUFJLEVBQUUsQ0FMYTtBQU1uQkMsRUFBQUEsTUFBTSxFQUFFO0FBTlcsQ0FBckIsQyxDQVNBOztJQUNNQyxjOzs7Ozs7Ozs7Ozs7Ozs7Ozs4RkFtQkk7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsSzs2RkFFRCxFOytGQUVFLFlBQU07QUFDYixVQUFJLENBQUMsTUFB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QUFBMEJLLFVBQUFBLE1BQU0sRUFBRTtBQUFsQyxXQUF3QzBELEtBQXhDO0FBRlAsU0FJRTtBQUNFLFFBQUEsR0FBRyxFQUFFLEtBQUt5QyxVQURaO0FBRUUsUUFBQSxNQUFNLEVBQUUsS0FBS0MsTUFGZjtBQUdFLFFBQUEsS0FBSyxFQUFFSjtBQUhULFFBSkYsRUFTR0QsUUFUSCxDQURGO0FBYUQ7OztFQXpVMEJNLGdCOztpQ0FBdkJwRyxjLGVBQ2U7QUFDakIwRixFQUFBQSxTQUFTLEVBQUVXLHNCQUFVQyxNQURKO0FBRWpCN0MsRUFBQUEsS0FBSyxFQUFFNEMsc0JBQVVFLE1BRkE7QUFHakJaLEVBQUFBLFFBQVEsRUFBRVUsc0JBQVVHLElBSEg7QUFJakJYLEVBQUFBLFNBQVMsRUFBRVEsc0JBQVVDLE1BSko7QUFLakJWLEVBQUFBLFNBQVMsRUFBRVMsc0JBQVVDLE1BTEo7QUFNakJHLEVBQUFBLE1BQU0sRUFBRUosc0JBQVVDLE1BTkQ7QUFPakJsQyxFQUFBQSxPQUFPLEVBQUVpQyxzQkFBVUssSUFQRjtBQVFqQnZFLEVBQUFBLFFBQVEsRUFBRWtFLHNCQUFVRyxJQVJIO0FBU2pCVixFQUFBQSxRQUFRLEVBQUVPLHNCQUFVTSxHQVRIO0FBVWpCekMsRUFBQUEsSUFBSSxFQUFFbUMsc0JBQVVPLFNBQVYsQ0FBb0IsQ0FDeEJQLHNCQUFVRSxNQURjLEVBRXhCRixzQkFBVUssSUFGYyxDQUFwQixDQVZXO0FBY2pCbkUsRUFBQUEsTUFBTSxFQUFFOEQsc0JBQVVDLE1BZEQ7QUFlakJqRixFQUFBQSxJQUFJLEVBQUVnRixzQkFBVUM7QUFmQyxDO2VBMlVOdEcsYyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCByZWFjdC9zb3J0LWNvbXA6MCAqL1xuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IGdldFVpZCBmcm9tICcuL3VpZCc7XG5pbXBvcnQgd2FybmluZyBmcm9tICcuLi8uLi9fdXRpbC93YXJuaW5nJztcbmltcG9ydCBpc1N0cmluZyBmcm9tICdsb2Rhc2gvaXNTdHJpbmcnO1xuaW1wb3J0IGlzQXJyYXkgZnJvbSAnbG9kYXNoL2lzQXJyYXknO1xuaW1wb3J0IGlzT2JqZWN0ICBmcm9tICdsb2Rhc2gvaXNPYmplY3QnO1xuaW1wb3J0IHRvU3RyaW5nICBmcm9tICdsb2Rhc2gvdG9TdHJpbmcnO1xuaW1wb3J0IGlzTmlsICBmcm9tICdsb2Rhc2gvaXNOaWwnO1xuXG5jb25zdCBJRlJBTUVfU1RZTEUgPSB7XG4gIHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuICB0b3A6IDAsXG4gIG9wYWNpdHk6IDAsXG4gIGZpbHRlcjogJ2FscGhhKG9wYWNpdHk9MCknLFxuICBsZWZ0OiAwLFxuICB6SW5kZXg6IDk5OTksXG59O1xuXG4vLyBkaWZlcmVudCBmcm9tIEFqYXhVcGxvYWQsIGNhbiBvbmx5IHVwbG9hZCBvbiBhdCBvbmUgdGltZSwgc2VyaWFsIHNlcmlvdXNseVxuY2xhc3MgSWZyYW1lVXBsb2FkZXIgZXh0ZW5kcyBDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIGNvbXBvbmVudDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBzdHlsZTogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBkaXNhYmxlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgcHJlZml4Q2xzOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBhY2NlcHQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgb25TdGFydDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgbXVsdGlwbGU6IFByb3BUeXBlcy5ib29sLFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuYW55LFxuICAgIGRhdGE6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgICAgUHJvcFR5cGVzLm9iamVjdCxcbiAgICAgIFByb3BUeXBlcy5mdW5jLFxuICAgIF0pLFxuICAgIGFjdGlvbjogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBuYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICB9XG5cbiAgc3RhdGUgPSB7IHVwbG9hZGluZzogZmFsc2UgfVxuXG4gIGZpbGUgPSB7fVxuXG4gIG9uTG9hZCA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMuc3RhdGUudXBsb2FkaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHsgcHJvcHMsIGZpbGUgfSA9IHRoaXM7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkb2MgPSB0aGlzLmdldElmcmFtZURvY3VtZW50KCk7XG4gICAgICBjb25zdCBzY3JpcHQgPSBkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpWzBdO1xuICAgICAgaWYgKHNjcmlwdCAmJiBzY3JpcHQucGFyZW50Tm9kZSA9PT0gZG9jLmJvZHkpIHtcbiAgICAgICAgZG9jLmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTtcbiAgICAgIH1cbiAgICAgIHJlc3BvbnNlID0gZG9jLmJvZHkuaW5uZXJIVE1MO1xuICAgICAgcHJvcHMub25TdWNjZXNzKHJlc3BvbnNlLCBmaWxlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHdhcm5pbmcoZmFsc2UsICdjcm9zcyBkb21haW4gZXJyb3IgZm9yIFVwbG9hZC4gTWF5YmUgc2VydmVyIHNob3VsZCByZXR1cm4gZG9jdW1lbnQuZG9tYWluIHNjcmlwdC4gc2VlIE5vdGUgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vcmVhY3QtY29tcG9uZW50L3VwbG9hZCcpO1xuICAgICAgcmVzcG9uc2UgPSAnY3Jvc3MtZG9tYWluJztcbiAgICAgIHByb3BzLm9uRXJyb3IoZXJyLCBudWxsLCBmaWxlKTtcbiAgICB9XG4gICAgdGhpcy5lbmRVcGxvYWQoKTtcbiAgfVxuXG4gIG9uQ2hhbmdlID0gKCkgPT4ge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZ2V0Rm9ybUlucHV0Tm9kZSgpO1xuICAgIC8vIGllOC85IGRvbid0IHN1cHBvcnQgRmlsZUxpc3QgT2JqZWN0XG4gICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xMjgzMDA1OC9pZTgtaW5wdXQtdHlwZS1maWxlLWdldC1maWxlc1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmZpbGUgPSB7XG4gICAgICB1aWQ6IGdldFVpZCgpLFxuICAgICAgbmFtZTogdGFyZ2V0LnZhbHVlLFxuICAgIH07XG4gICAgdGhpcy5zdGFydFVwbG9hZCgpO1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgaWYgKCFwcm9wcy5iZWZvcmVVcGxvYWQpIHtcbiAgICAgIHJldHVybiB0aGlzLnBvc3QoZmlsZSk7XG4gICAgfVxuICAgIGNvbnN0IGJlZm9yZSA9IHByb3BzLmJlZm9yZVVwbG9hZChmaWxlKTtcbiAgICBpZiAoYmVmb3JlICYmIGJlZm9yZS50aGVuKSB7XG4gICAgICBiZWZvcmUudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMucG9zdChmaWxlKTtcbiAgICAgIH0sICgpID0+IHtcbiAgICAgICAgdGhpcy5lbmRVcGxvYWQoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoYmVmb3JlICE9PSBmYWxzZSkge1xuICAgICAgdGhpcy5wb3N0KGZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVuZFVwbG9hZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIHRoaXMudXBkYXRlSWZyYW1lV0goKTtcbiAgICB0aGlzLmluaXRJZnJhbWUoKTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICB0aGlzLnVwZGF0ZUlmcmFtZVdIKCk7XG4gIH1cblxuICBnZXRJZnJhbWVOb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmlmcmFtZTtcbiAgfVxuXG4gIGdldElmcmFtZURvY3VtZW50KCkge1xuICAgIHJldHVybiB0aGlzLmdldElmcmFtZU5vZGUoKS5jb250ZW50RG9jdW1lbnQ7XG4gIH1cblxuICBnZXRGb3JtTm9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRJZnJhbWVEb2N1bWVudCgpLmdldEVsZW1lbnRCeUlkKCdmb3JtJyk7XG4gIH1cblxuICBnZXRGb3JtSW5wdXROb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmdldElmcmFtZURvY3VtZW50KCkuZ2V0RWxlbWVudEJ5SWQoJ2lucHV0Jyk7XG4gIH1cblxuICBnZXRGb3JtRGF0YU5vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0SWZyYW1lRG9jdW1lbnQoKS5nZXRFbGVtZW50QnlJZCgnZGF0YScpO1xuICB9XG5cbiAgZ2V0RmlsZUZvck11bHRpcGxlKGZpbGUpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5tdWx0aXBsZSA/IFtmaWxlXSA6IGZpbGU7XG4gIH1cblxuICBnZXRJZnJhbWVIVE1MKGRvbWFpbikge1xuICAgIGxldCBkb21haW5TY3JpcHQgPSAnJztcbiAgICBsZXQgZG9tYWluSW5wdXQgPSAnJztcbiAgICBpZiAoZG9tYWluKSB7XG4gICAgICBjb25zdCBzY3JpcHQgPSAnc2NyaXB0JztcbiAgICAgIGRvbWFpblNjcmlwdCA9IGA8JHtzY3JpcHR9PmRvY3VtZW50LmRvbWFpbj1cIiR7ZG9tYWlufVwiOzwvJHtzY3JpcHR9PmA7XG4gICAgICBkb21haW5JbnB1dCA9IGA8aW5wdXQgbmFtZT1cIl9kb2N1bWVudERvbWFpblwiIHZhbHVlPVwiJHtkb21haW59XCIgLz5gO1xuICAgIH1cbiAgICByZXR1cm4gYFxuICAgIDwhRE9DVFlQRSBodG1sPlxuICAgIDxodG1sPlxuICAgIDxoZWFkPlxuICAgIDxtZXRhIGh0dHAtZXF1aXY9XCJYLVVBLUNvbXBhdGlibGVcIiBjb250ZW50PVwiSUU9ZWRnZVwiIC8+XG4gICAgPHN0eWxlPlxuICAgIGJvZHksaHRtbCB7cGFkZGluZzowO21hcmdpbjowO2JvcmRlcjowO292ZXJmbG93OmhpZGRlbjt9XG4gICAgPC9zdHlsZT5cbiAgICAke2RvbWFpblNjcmlwdH1cbiAgICA8L2hlYWQ+XG4gICAgPGJvZHk+XG4gICAgPGZvcm0gbWV0aG9kPVwicG9zdFwiXG4gICAgZW5jVHlwZT1cIm11bHRpcGFydC9mb3JtLWRhdGFcIlxuICAgIGFjdGlvbj1cIiR7dGhpcy5wcm9wcy5hY3Rpb259XCIgaWQ9XCJmb3JtXCJcbiAgICBzdHlsZT1cImRpc3BsYXk6YmxvY2s7aGVpZ2h0Ojk5OTlweDtwb3NpdGlvbjpyZWxhdGl2ZTtvdmVyZmxvdzpoaWRkZW47XCI+XG4gICAgPGlucHV0IGlkPVwiaW5wdXRcIiB0eXBlPVwiZmlsZVwiXG4gICAgIG5hbWU9XCIke3RoaXMucHJvcHMubmFtZX1cIlxuICAgICBzdHlsZT1cInBvc2l0aW9uOmFic29sdXRlO3RvcDowO3JpZ2h0OjA7aGVpZ2h0Ojk5OTlweDtmb250LXNpemU6OTk5OXB4O2N1cnNvcjpwb2ludGVyO1wiLz5cbiAgICAke2RvbWFpbklucHV0fVxuICAgIDxzcGFuIGlkPVwiZGF0YVwiPjwvc3Bhbj5cbiAgICA8L2Zvcm0+XG4gICAgPC9ib2R5PlxuICAgIDwvaHRtbD5cbiAgICBgO1xuICB9XG5cbiAgaW5pdElmcmFtZVNyYygpIHtcbiAgICBpZiAodGhpcy5kb21haW4pIHtcbiAgICAgIHRoaXMuZ2V0SWZyYW1lTm9kZSgpLnNyYyA9IGBqYXZhc2NyaXB0OnZvaWQoKGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBkID0gZG9jdW1lbnQ7XG4gICAgICAgIGQub3BlbigpO1xuICAgICAgICBkLmRvbWFpbj0nJHt0aGlzLmRvbWFpbn0nO1xuICAgICAgICBkLndyaXRlKCcnKTtcbiAgICAgICAgZC5jbG9zZSgpO1xuICAgICAgfSkoKSlgO1xuICAgIH1cbiAgfVxuXG4gIGluaXRJZnJhbWUoKSB7XG4gICAgY29uc3QgaWZyYW1lTm9kZSA9IHRoaXMuZ2V0SWZyYW1lTm9kZSgpO1xuICAgIGxldCB3aW4gPSBpZnJhbWVOb2RlLmNvbnRlbnRXaW5kb3c7XG4gICAgbGV0IGRvYztcbiAgICB0aGlzLmRvbWFpbiA9IHRoaXMuZG9tYWluIHx8ICcnO1xuICAgIHRoaXMuaW5pdElmcmFtZVNyYygpO1xuICAgIHRyeSB7XG4gICAgICBkb2MgPSB3aW4uZG9jdW1lbnQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5kb21haW4gPSBkb2N1bWVudC5kb21haW47XG4gICAgICB0aGlzLmluaXRJZnJhbWVTcmMoKTtcbiAgICAgIHdpbiA9IGlmcmFtZU5vZGUuY29udGVudFdpbmRvdztcbiAgICAgIGRvYyA9IHdpbi5kb2N1bWVudDtcbiAgICB9XG4gICAgZG9jLm9wZW4oJ3RleHQvaHRtbCcsICdyZXBsYWNlJyk7XG4gICAgZG9jLndyaXRlKHRoaXMuZ2V0SWZyYW1lSFRNTCh0aGlzLmRvbWFpbikpO1xuICAgIGRvYy5jbG9zZSgpO1xuICAgIHRoaXMuZ2V0Rm9ybUlucHV0Tm9kZSgpLm9uY2hhbmdlID0gdGhpcy5vbkNoYW5nZTtcbiAgfVxuXG4gIGVuZFVwbG9hZCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS51cGxvYWRpbmcpIHtcbiAgICAgIHRoaXMuZmlsZSA9IHt9O1xuICAgICAgLy8gaGFjayBhdm9pZCBiYXRjaFxuICAgICAgdGhpcy5zdGF0ZS51cGxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICB1cGxvYWRpbmc6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgICB0aGlzLmluaXRJZnJhbWUoKTtcbiAgICB9XG4gIH1cblxuICBzdGFydFVwbG9hZCgpIHtcbiAgICBpZiAoIXRoaXMuc3RhdGUudXBsb2FkaW5nKSB7XG4gICAgICB0aGlzLnN0YXRlLnVwbG9hZGluZyA9IHRydWU7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgdXBsb2FkaW5nOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlSWZyYW1lV0goKSB7XG4gICAgY29uc3Qgcm9vdE5vZGUgPSBSZWFjdERPTS5maW5kRE9NTm9kZSh0aGlzKTtcbiAgICBjb25zdCBpZnJhbWVOb2RlID0gdGhpcy5nZXRJZnJhbWVOb2RlKCk7XG4gICAgaWZyYW1lTm9kZS5zdHlsZS5oZWlnaHQgPSBgJHtyb290Tm9kZS5vZmZzZXRIZWlnaHR9cHhgO1xuICAgIGlmcmFtZU5vZGUuc3R5bGUud2lkdGggPSBgJHtyb290Tm9kZS5vZmZzZXRXaWR0aH1weGA7XG4gIH1cblxuICBhYm9ydChmaWxlKSB7XG4gICAgaWYgKGZpbGUpIHtcbiAgICAgIGxldCB1aWQgPSBmaWxlO1xuICAgICAgaWYgKGZpbGUgJiYgZmlsZS51aWQpIHtcbiAgICAgICAgdWlkID0gZmlsZS51aWQ7XG4gICAgICB9XG4gICAgICBpZiAodWlkID09PSB0aGlzLmZpbGUudWlkKSB7XG4gICAgICAgIHRoaXMuZW5kVXBsb2FkKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZW5kVXBsb2FkKCk7XG4gICAgfVxuICB9XG5cbiAgcG9zdChmaWxlKSB7XG4gICAgY29uc3QgZm9ybU5vZGUgPSB0aGlzLmdldEZvcm1Ob2RlKCk7XG4gICAgY29uc3QgZGF0YVNwYW4gPSB0aGlzLmdldEZvcm1EYXRhTm9kZSgpO1xuICAgIGxldCB7IGRhdGEsIHJlcXVlc3RGaWxlS2V5cyB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IG9uU3RhcnQgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBkYXRhID0gZGF0YShmaWxlKTtcbiAgICB9XG4gICAgY29uc3QgaW5wdXRzID0gdGhpcy5yZXF1ZXN0RmlsZUlucHV0KHJlcXVlc3RGaWxlS2V5cywgZmlsZSwgZGF0YSlcbiAgICBkYXRhU3Bhbi5hcHBlbmRDaGlsZChpbnB1dHMpO1xuICAgIGZvcm1Ob2RlLnN1Ym1pdCgpO1xuICAgIGRhdGFTcGFuLmlubmVySFRNTCA9ICcnO1xuICAgIG9uU3RhcnQoZmlsZSk7XG4gIH1cbi8qKlxuICogXG4gKiBAcGFyYW0geyDpnIDopoHliqDlhaXnmoTlj4LmlbAgfSByZXF1ZXN0RmlsZUtleXMgXG4gKiBAcGFyYW0geyDmlofku7blhoXlrrkgfSBmaWxlIFxuICogQHBhcmFtIHsgcHJvcHPnmoTlv4XkvKDlj4LmlbAgfSBkYXRhIFxuICovXG4gcmVxdWVzdEZpbGVJbnB1dChyZXF1ZXN0RmlsZUtleXMsZmlsZSxkYXRhKSB7XG5cbiAgIGNvbnN0IGlucHV0cyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcbiAgICAvKiogXG4gICAgICog5re75Yqg5rOo5YWl55qEZGF0YeaVsOaNrlxuICAgICAqL1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBkYXRhKSB7XG4gICAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCduYW1lJywga2V5KTtcbiAgICAgICAgICBpbnB1dC52YWx1ZSA9IGRhdGFba2V5XTtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiDmt7vliqDmlofku7bmlbDmja5cbiAgICAgICAgICAgKi9cbiAgICAgICAgICBpbnB1dHMuYXBwZW5kQ2hpbGQoaW5wdXQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBcblxuICAgIGNvbnN0IHRvU3RyaW5nVmFsdWUgPSAodmFsdWUpID0+IHtcbiAgICAgIGlmKGlzTmlsKHZhbHVlKSl7XG4gICAgICAgIHJldHVybiAnJztcbiAgICAgIH1cbiAgICAgIGlmKGlzU3RyaW5nKHZhbHVlKSl7XG4gICAgICAgIHJldHVybiB2YWx1ZVxuICAgICAgfVxuICAgICAgaWYoaXNPYmplY3QodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSlcbiAgICAgIH1cbiAgICAgIHJldHVybiB0b1N0cmluZyh2YWx1ZSlcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHvmiYDmnInmlbDmja59IG9iaiBcbiAgICAgKiBAcGFyYW0ge+mcgOimgeS8oOWHuueahOWPguaVsGtleXN9IGFycmF5U3RyaW5nIFxuICAgICAqL1xuICAgIGNvbnN0IEFycmF5VG9PYmplY3QgPSAob2JqLGFycmF5U3RyaW5nKSA9PiB7XG4gICAgICBhcnJheVN0cmluZy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnbmFtZScsIHRvU3RyaW5nVmFsdWUoaXRlbSkpO1xuICAgICAgICBpbnB1dC52YWx1ZSA9IHRvU3RyaW5nVmFsdWUob2JqW3RvU3RyaW5nVmFsdWUoaXRlbSldKTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOa3u+WKoOaWh+S7tuaVsOaNrlxuICAgICAgICAgKi9cbiAgICAgICAgaW5wdXRzLmFwcGVuZENoaWxkKGlucHV0KTtcbiAgICAgIH0pXG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIOWIpOaWreaYr+WQpumcgOimgeWinuWKoGtleVxuICAgICAqL1xuICAgIGlmKGlzU3RyaW5nKHJlcXVlc3RGaWxlS2V5cykgfHwgaXNBcnJheShyZXF1ZXN0RmlsZUtleXMpKXtcbiAgICAgIGxldCByZXF1ZXN0RmlsZUtleXNGaWxlID0gWyd1aWQnLCd0eXBlJywnbmFtZScsJ2xhc3RNb2RpZmllZERhdGUnXTtcbiAgICAgIGlmKGlzU3RyaW5nKHJlcXVlc3RGaWxlS2V5cykpe1xuICAgICAgICByZXF1ZXN0RmlsZUtleXNGaWxlLnB1c2gocmVxdWVzdEZpbGVLZXlzKTtcbiAgICAgIH1lbHNle1xuICAgICAgICByZXF1ZXN0RmlsZUtleXNGaWxlID0gWy4uLnJlcXVlc3RGaWxlS2V5c0ZpbGUsLi4ucmVxdWVzdEZpbGVLZXlzXVxuICAgICAgfVxuICAgICAgQXJyYXlUb09iamVjdChmaWxlLHJlcXVlc3RGaWxlS2V5c0ZpbGUpXG4gICAgfVxuICAgIHJldHVybiBpbnB1dHNcbiAgfVxuXG4gIHNhdmVJZnJhbWUgPSAobm9kZSkgPT4ge1xuICAgIHRoaXMuaWZyYW1lID0gbm9kZTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBjb21wb25lbnQ6IFRhZywgZGlzYWJsZWQsIGNsYXNzTmFtZSxcbiAgICAgIHByZWZpeENscywgY2hpbGRyZW4sIHN0eWxlLFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGlmcmFtZVN0eWxlID0ge1xuICAgICAgLi4uSUZSQU1FX1NUWUxFLFxuICAgICAgZGlzcGxheTogdGhpcy5zdGF0ZS51cGxvYWRpbmcgfHwgZGlzYWJsZWQgPyAnbm9uZScgOiAnJyxcbiAgICB9O1xuICAgIGNvbnN0IGNscyA9IGNsYXNzTmFtZXMoe1xuICAgICAgW3ByZWZpeENsc106IHRydWUsXG4gICAgICBbYCR7cHJlZml4Q2xzfS1kaXNhYmxlZGBdOiBkaXNhYmxlZCxcbiAgICAgIFtjbGFzc05hbWVdOiBjbGFzc05hbWUsXG4gICAgfSk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxUYWdcbiAgICAgICAgY2xhc3NOYW1lPXtjbHN9XG4gICAgICAgIHN0eWxlPXt7IHBvc2l0aW9uOiAncmVsYXRpdmUnLCB6SW5kZXg6IDAsIC4uLnN0eWxlIH19XG4gICAgICA+XG4gICAgICAgIDxpZnJhbWVcbiAgICAgICAgICByZWY9e3RoaXMuc2F2ZUlmcmFtZX1cbiAgICAgICAgICBvbkxvYWQ9e3RoaXMub25Mb2FkfVxuICAgICAgICAgIHN0eWxlPXtpZnJhbWVTdHlsZX1cbiAgICAgICAgLz5cbiAgICAgICAge2NoaWxkcmVufVxuICAgICAgPC9UYWc+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJZnJhbWVVcGxvYWRlcjtcbiJdfQ==