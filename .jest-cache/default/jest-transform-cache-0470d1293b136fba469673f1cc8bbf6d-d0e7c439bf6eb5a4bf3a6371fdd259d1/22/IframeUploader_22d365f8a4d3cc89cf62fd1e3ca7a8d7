268c965905ab3742e2e1aea2c9ef7901
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _classnames = _interopRequireDefault(require("classnames"));

var _uid = _interopRequireDefault(require("./uid"));

var _warning = _interopRequireDefault(require("../../_util/warning"));

/* eslint react/sort-comp:0 */
var IFRAME_STYLE = {
  position: 'absolute',
  top: 0,
  opacity: 0,
  filter: 'alpha(opacity=0)',
  left: 0,
  zIndex: 9999
}; // diferent from AjaxUpload, can only upload on at one time, serial seriously

var IframeUploader =
/*#__PURE__*/
function (_Component) {
  (0, _inherits2["default"])(IframeUploader, _Component);

  function IframeUploader() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2["default"])(this, IframeUploader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2["default"])(this, (_getPrototypeOf2 = (0, _getPrototypeOf3["default"])(IframeUploader)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      uploading: false
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "file", {});
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onLoad", function () {
      if (!_this.state.uploading) {
        return;
      }

      var _assertThisInitialize = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize.props,
          file = _assertThisInitialize.file;

      var response;

      try {
        var doc = _this.getIframeDocument();

        var script = doc.getElementsByTagName('script')[0];

        if (script && script.parentNode === doc.body) {
          doc.body.removeChild(script);
        }

        response = doc.body.innerHTML;
        props.onSuccess(response, file);
      } catch (err) {
        (0, _warning["default"])(false, 'cross domain error for Upload. Maybe server should return document.domain script. see Note from https://github.com/react-component/upload');
        response = 'cross-domain';
        props.onError(err, null, file);
      }

      _this.endUpload();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "onChange", function () {
      var target = _this.getFormInputNode(); // ie8/9 don't support FileList Object
      // http://stackoverflow.com/questions/12830058/ie8-input-type-file-get-files


      var file = _this.file = {
        uid: (0, _uid["default"])(),
        name: target.value
      };

      _this.startUpload();

      var _assertThisInitialize2 = (0, _assertThisInitialized2["default"])(_this),
          props = _assertThisInitialize2.props;

      if (!props.beforeUpload) {
        return _this.post(file);
      }

      var before = props.beforeUpload(file);

      if (before && before.then) {
        before.then(function () {
          _this.post(file);
        }, function () {
          _this.endUpload();
        });
      } else if (before !== false) {
        _this.post(file);
      } else {
        _this.endUpload();
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "saveIframe", function (node) {
      _this.iframe = node;
    });
    return _this;
  }

  (0, _createClass2["default"])(IframeUploader, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this.updateIframeWH();
      this.initIframe();
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate() {
      this.updateIframeWH();
    }
  }, {
    key: "getIframeNode",
    value: function getIframeNode() {
      return this.iframe;
    }
  }, {
    key: "getIframeDocument",
    value: function getIframeDocument() {
      return this.getIframeNode().contentDocument;
    }
  }, {
    key: "getFormNode",
    value: function getFormNode() {
      return this.getIframeDocument().getElementById('form');
    }
  }, {
    key: "getFormInputNode",
    value: function getFormInputNode() {
      return this.getIframeDocument().getElementById('input');
    }
  }, {
    key: "getFormDataNode",
    value: function getFormDataNode() {
      return this.getIframeDocument().getElementById('data');
    }
  }, {
    key: "getFileForMultiple",
    value: function getFileForMultiple(file) {
      return this.props.multiple ? [file] : file;
    }
  }, {
    key: "getIframeHTML",
    value: function getIframeHTML(domain) {
      var domainScript = '';
      var domainInput = '';

      if (domain) {
        var script = 'script';
        domainScript = "<".concat(script, ">document.domain=\"").concat(domain, "\";</").concat(script, ">");
        domainInput = "<input name=\"_documentDomain\" value=\"".concat(domain, "\" />");
      }

      return "\n    <!DOCTYPE html>\n    <html>\n    <head>\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n    <style>\n    body,html {padding:0;margin:0;border:0;overflow:hidden;}\n    </style>\n    ".concat(domainScript, "\n    </head>\n    <body>\n    <form method=\"post\"\n    encType=\"multipart/form-data\"\n    action=\"").concat(this.props.action, "\" id=\"form\"\n    style=\"display:block;height:9999px;position:relative;overflow:hidden;\">\n    <input id=\"input\" type=\"file\"\n     name=\"").concat(this.props.name, "\"\n     style=\"position:absolute;top:0;right:0;height:9999px;font-size:9999px;cursor:pointer;\"/>\n    ").concat(domainInput, "\n    <span id=\"data\"></span>\n    </form>\n    </body>\n    </html>\n    ");
    }
  }, {
    key: "initIframeSrc",
    value: function initIframeSrc() {
      if (this.domain) {
        this.getIframeNode().src = "javascript:void((function(){\n        var d = document;\n        d.open();\n        d.domain='".concat(this.domain, "';\n        d.write('');\n        d.close();\n      })())");
      }
    }
  }, {
    key: "initIframe",
    value: function initIframe() {
      var iframeNode = this.getIframeNode();
      var win = iframeNode.contentWindow;
      var doc;
      this.domain = this.domain || '';
      this.initIframeSrc();

      try {
        doc = win.document;
      } catch (e) {
        this.domain = document.domain;
        this.initIframeSrc();
        win = iframeNode.contentWindow;
        doc = win.document;
      }

      doc.open('text/html', 'replace');
      doc.write(this.getIframeHTML(this.domain));
      doc.close();
      this.getFormInputNode().onchange = this.onChange;
    }
  }, {
    key: "endUpload",
    value: function endUpload() {
      if (this.state.uploading) {
        this.file = {}; // hack avoid batch

        this.state.uploading = false;
        this.setState({
          uploading: false
        });
        this.initIframe();
      }
    }
  }, {
    key: "startUpload",
    value: function startUpload() {
      if (!this.state.uploading) {
        this.state.uploading = true;
        this.setState({
          uploading: true
        });
      }
    }
  }, {
    key: "updateIframeWH",
    value: function updateIframeWH() {
      var rootNode = _reactDom["default"].findDOMNode(this);

      var iframeNode = this.getIframeNode();
      iframeNode.style.height = "".concat(rootNode.offsetHeight, "px");
      iframeNode.style.width = "".concat(rootNode.offsetWidth, "px");
    }
  }, {
    key: "abort",
    value: function abort(file) {
      if (file) {
        var uid = file;

        if (file && file.uid) {
          uid = file.uid;
        }

        if (uid === this.file.uid) {
          this.endUpload();
        }
      } else {
        this.endUpload();
      }
    }
  }, {
    key: "post",
    value: function post(file) {
      var formNode = this.getFormNode();
      var dataSpan = this.getFormDataNode();
      var data = this.props.data;
      var onStart = this.props.onStart;

      if (typeof data === 'function') {
        data = data(file);
      }

      var inputs = document.createDocumentFragment();

      for (var key in data) {
        if (data.hasOwnProperty(key)) {
          var input = document.createElement('input');
          input.setAttribute('name', key);
          input.value = data[key];
          inputs.appendChild(input);
        }
      }

      dataSpan.appendChild(inputs);
      formNode.submit();
      dataSpan.innerHTML = '';
      onStart(file);
    }
  }, {
    key: "render",
    value: function render() {
      var _classNames;

      var _this$props = this.props,
          Tag = _this$props.component,
          disabled = _this$props.disabled,
          className = _this$props.className,
          prefixCls = _this$props.prefixCls,
          children = _this$props.children,
          style = _this$props.style;
      var iframeStyle = (0, _objectSpread2["default"])({}, IFRAME_STYLE, {
        display: this.state.uploading || disabled ? 'none' : ''
      });
      var cls = (0, _classnames["default"])((_classNames = {}, (0, _defineProperty2["default"])(_classNames, prefixCls, true), (0, _defineProperty2["default"])(_classNames, "".concat(prefixCls, "-disabled"), disabled), (0, _defineProperty2["default"])(_classNames, className, className), _classNames));
      return _react["default"].createElement(Tag, {
        className: cls,
        style: (0, _objectSpread2["default"])({
          position: 'relative',
          zIndex: 0
        }, style)
      }, _react["default"].createElement("iframe", {
        ref: this.saveIframe,
        onLoad: this.onLoad,
        style: iframeStyle
      }), children);
    }
  }]);
  return IframeUploader;
}(_react.Component);

(0, _defineProperty2["default"])(IframeUploader, "propTypes", {
  component: _propTypes["default"].string,
  style: _propTypes["default"].object,
  disabled: _propTypes["default"].bool,
  prefixCls: _propTypes["default"].string,
  className: _propTypes["default"].string,
  accept: _propTypes["default"].string,
  onStart: _propTypes["default"].func,
  multiple: _propTypes["default"].bool,
  children: _propTypes["default"].any,
  data: _propTypes["default"].oneOfType([_propTypes["default"].object, _propTypes["default"].func]),
  action: _propTypes["default"].string,
  name: _propTypes["default"].string
});
var _default = IframeUploader;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIklmcmFtZVVwbG9hZGVyLmpzeCJdLCJuYW1lcyI6WyJJRlJBTUVfU1RZTEUiLCJwb3NpdGlvbiIsInRvcCIsIm9wYWNpdHkiLCJmaWx0ZXIiLCJsZWZ0IiwiekluZGV4IiwiSWZyYW1lVXBsb2FkZXIiLCJ1cGxvYWRpbmciLCJzdGF0ZSIsInByb3BzIiwiZmlsZSIsInJlc3BvbnNlIiwiZG9jIiwiZ2V0SWZyYW1lRG9jdW1lbnQiLCJzY3JpcHQiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsInBhcmVudE5vZGUiLCJib2R5IiwicmVtb3ZlQ2hpbGQiLCJpbm5lckhUTUwiLCJvblN1Y2Nlc3MiLCJlcnIiLCJvbkVycm9yIiwiZW5kVXBsb2FkIiwidGFyZ2V0IiwiZ2V0Rm9ybUlucHV0Tm9kZSIsInVpZCIsIm5hbWUiLCJ2YWx1ZSIsInN0YXJ0VXBsb2FkIiwiYmVmb3JlVXBsb2FkIiwicG9zdCIsImJlZm9yZSIsInRoZW4iLCJub2RlIiwiaWZyYW1lIiwidXBkYXRlSWZyYW1lV0giLCJpbml0SWZyYW1lIiwiZ2V0SWZyYW1lTm9kZSIsImNvbnRlbnREb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwibXVsdGlwbGUiLCJkb21haW4iLCJkb21haW5TY3JpcHQiLCJkb21haW5JbnB1dCIsImFjdGlvbiIsInNyYyIsImlmcmFtZU5vZGUiLCJ3aW4iLCJjb250ZW50V2luZG93IiwiaW5pdElmcmFtZVNyYyIsImRvY3VtZW50IiwiZSIsIm9wZW4iLCJ3cml0ZSIsImdldElmcmFtZUhUTUwiLCJjbG9zZSIsIm9uY2hhbmdlIiwib25DaGFuZ2UiLCJzZXRTdGF0ZSIsInJvb3ROb2RlIiwiUmVhY3RET00iLCJmaW5kRE9NTm9kZSIsInN0eWxlIiwiaGVpZ2h0Iiwib2Zmc2V0SGVpZ2h0Iiwid2lkdGgiLCJvZmZzZXRXaWR0aCIsImZvcm1Ob2RlIiwiZ2V0Rm9ybU5vZGUiLCJkYXRhU3BhbiIsImdldEZvcm1EYXRhTm9kZSIsImRhdGEiLCJvblN0YXJ0IiwiaW5wdXRzIiwiY3JlYXRlRG9jdW1lbnRGcmFnbWVudCIsImtleSIsImhhc093blByb3BlcnR5IiwiaW5wdXQiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwiYXBwZW5kQ2hpbGQiLCJzdWJtaXQiLCJUYWciLCJjb21wb25lbnQiLCJkaXNhYmxlZCIsImNsYXNzTmFtZSIsInByZWZpeENscyIsImNoaWxkcmVuIiwiaWZyYW1lU3R5bGUiLCJkaXNwbGF5IiwiY2xzIiwic2F2ZUlmcmFtZSIsIm9uTG9hZCIsIkNvbXBvbmVudCIsIlByb3BUeXBlcyIsInN0cmluZyIsIm9iamVjdCIsImJvb2wiLCJhY2NlcHQiLCJmdW5jIiwiYW55Iiwib25lT2ZUeXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFOQTtBQVFBLElBQU1BLFlBQVksR0FBRztBQUNuQkMsRUFBQUEsUUFBUSxFQUFFLFVBRFM7QUFFbkJDLEVBQUFBLEdBQUcsRUFBRSxDQUZjO0FBR25CQyxFQUFBQSxPQUFPLEVBQUUsQ0FIVTtBQUluQkMsRUFBQUEsTUFBTSxFQUFFLGtCQUpXO0FBS25CQyxFQUFBQSxJQUFJLEVBQUUsQ0FMYTtBQU1uQkMsRUFBQUEsTUFBTSxFQUFFO0FBTlcsQ0FBckIsQyxDQVNBOztJQUNNQyxjOzs7Ozs7Ozs7Ozs7Ozs7Ozs4RkFtQkk7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsSzs2RkFFRCxFOytGQUVFLFlBQU07QUFDYixVQUFJLENBQUMsTUFBS0MsS0FBTCxDQUFXRCxTQUFoQixFQUEyQjtBQUN6QjtBQUNEOztBQUhZO0FBQUEsVUFJTEUsS0FKSyx5QkFJTEEsS0FKSztBQUFBLFVBSUVDLElBSkYseUJBSUVBLElBSkY7O0FBS2IsVUFBSUMsUUFBSjs7QUFDQSxVQUFJO0FBQ0YsWUFBTUMsR0FBRyxHQUFHLE1BQUtDLGlCQUFMLEVBQVo7O0FBQ0EsWUFBTUMsTUFBTSxHQUFHRixHQUFHLENBQUNHLG9CQUFKLENBQXlC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QURjLEVBRXhCRixzQkFBVUssSUFGYyxDQUFwQixDQVZXO0FBY2pCdkQsRUFBQUEsTUFBTSxFQUFFa0Qsc0JBQVVDLE1BZEQ7QUFlakJyRSxFQUFBQSxJQUFJLEVBQUVvRSxzQkFBVUM7QUFmQyxDO2VBNlFOMUYsYyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCByZWFjdC9zb3J0LWNvbXA6MCAqL1xuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IGdldFVpZCBmcm9tICcuL3VpZCc7XG5pbXBvcnQgd2FybmluZyBmcm9tICcuLi8uLi9fdXRpbC93YXJuaW5nJztcblxuY29uc3QgSUZSQU1FX1NUWUxFID0ge1xuICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgdG9wOiAwLFxuICBvcGFjaXR5OiAwLFxuICBmaWx0ZXI6ICdhbHBoYShvcGFjaXR5PTApJyxcbiAgbGVmdDogMCxcbiAgekluZGV4OiA5OTk5LFxufTtcblxuLy8gZGlmZXJlbnQgZnJvbSBBamF4VXBsb2FkLCBjYW4gb25seSB1cGxvYWQgb24gYXQgb25lIHRpbWUsIHNlcmlhbCBzZXJpb3VzbHlcbmNsYXNzIElmcmFtZVVwbG9hZGVyIGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBjb21wb25lbnQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgc3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuICAgIHByZWZpeENsczogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgYWNjZXB0OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIG9uU3RhcnQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIG11bHRpcGxlOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBjaGlsZHJlbjogUHJvcFR5cGVzLmFueSxcbiAgICBkYXRhOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICAgIFByb3BUeXBlcy5vYmplY3QsXG4gICAgICBQcm9wVHlwZXMuZnVuYyxcbiAgICBdKSxcbiAgICBhY3Rpb246IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgbmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgfVxuXG4gIHN0YXRlID0geyB1cGxvYWRpbmc6IGZhbHNlIH1cblxuICBmaWxlID0ge31cblxuICBvbkxvYWQgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLnVwbG9hZGluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB7IHByb3BzLCBmaWxlIH0gPSB0aGlzO1xuICAgIGxldCByZXNwb25zZTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZG9jID0gdGhpcy5nZXRJZnJhbWVEb2N1bWVudCgpO1xuICAgICAgY29uc3Qgc2NyaXB0ID0gZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTtcbiAgICAgIGlmIChzY3JpcHQgJiYgc2NyaXB0LnBhcmVudE5vZGUgPT09IGRvYy5ib2R5KSB7XG4gICAgICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKHNjcmlwdCk7XG4gICAgICB9XG4gICAgICByZXNwb25zZSA9IGRvYy5ib2R5LmlubmVySFRNTDtcbiAgICAgIHByb3BzLm9uU3VjY2VzcyhyZXNwb25zZSwgZmlsZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB3YXJuaW5nKGZhbHNlLCAnY3Jvc3MgZG9tYWluIGVycm9yIGZvciBVcGxvYWQuIE1heWJlIHNlcnZlciBzaG91bGQgcmV0dXJuIGRvY3VtZW50LmRvbWFpbiBzY3JpcHQuIHNlZSBOb3RlIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL3JlYWN0LWNvbXBvbmVudC91cGxvYWQnKTtcbiAgICAgIHJlc3BvbnNlID0gJ2Nyb3NzLWRvbWFpbic7XG4gICAgICBwcm9wcy5vbkVycm9yKGVyciwgbnVsbCwgZmlsZSk7XG4gICAgfVxuICAgIHRoaXMuZW5kVXBsb2FkKCk7XG4gIH1cblxuICBvbkNoYW5nZSA9ICgpID0+IHtcbiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdldEZvcm1JbnB1dE5vZGUoKTtcbiAgICAvLyBpZTgvOSBkb24ndCBzdXBwb3J0IEZpbGVMaXN0IE9iamVjdFxuICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTI4MzAwNTgvaWU4LWlucHV0LXR5cGUtZmlsZS1nZXQtZmlsZXNcbiAgICBjb25zdCBmaWxlID0gdGhpcy5maWxlID0ge1xuICAgICAgdWlkOiBnZXRVaWQoKSxcbiAgICAgIG5hbWU6IHRhcmdldC52YWx1ZSxcbiAgICB9O1xuICAgIHRoaXMuc3RhcnRVcGxvYWQoKTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGlmICghcHJvcHMuYmVmb3JlVXBsb2FkKSB7XG4gICAgICByZXR1cm4gdGhpcy5wb3N0KGZpbGUpO1xuICAgIH1cbiAgICBjb25zdCBiZWZvcmUgPSBwcm9wcy5iZWZvcmVVcGxvYWQoZmlsZSk7XG4gICAgaWYgKGJlZm9yZSAmJiBiZWZvcmUudGhlbikge1xuICAgICAgYmVmb3JlLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnBvc3QoZmlsZSk7XG4gICAgICB9LCAoKSA9PiB7XG4gICAgICAgIHRoaXMuZW5kVXBsb2FkKCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGJlZm9yZSAhPT0gZmFsc2UpIHtcbiAgICAgIHRoaXMucG9zdChmaWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbmRVcGxvYWQoKTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLnVwZGF0ZUlmcmFtZVdIKCk7XG4gICAgdGhpcy5pbml0SWZyYW1lKCk7XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgdGhpcy51cGRhdGVJZnJhbWVXSCgpO1xuICB9XG5cbiAgZ2V0SWZyYW1lTm9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pZnJhbWU7XG4gIH1cblxuICBnZXRJZnJhbWVEb2N1bWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRJZnJhbWVOb2RlKCkuY29udGVudERvY3VtZW50O1xuICB9XG5cbiAgZ2V0Rm9ybU5vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0SWZyYW1lRG9jdW1lbnQoKS5nZXRFbGVtZW50QnlJZCgnZm9ybScpO1xuICB9XG5cbiAgZ2V0Rm9ybUlucHV0Tm9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRJZnJhbWVEb2N1bWVudCgpLmdldEVsZW1lbnRCeUlkKCdpbnB1dCcpO1xuICB9XG5cbiAgZ2V0Rm9ybURhdGFOb2RlKCkge1xuICAgIHJldHVybiB0aGlzLmdldElmcmFtZURvY3VtZW50KCkuZ2V0RWxlbWVudEJ5SWQoJ2RhdGEnKTtcbiAgfVxuXG4gIGdldEZpbGVGb3JNdWx0aXBsZShmaWxlKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMubXVsdGlwbGUgPyBbZmlsZV0gOiBmaWxlO1xuICB9XG5cbiAgZ2V0SWZyYW1lSFRNTChkb21haW4pIHtcbiAgICBsZXQgZG9tYWluU2NyaXB0ID0gJyc7XG4gICAgbGV0IGRvbWFpbklucHV0ID0gJyc7XG4gICAgaWYgKGRvbWFpbikge1xuICAgICAgY29uc3Qgc2NyaXB0ID0gJ3NjcmlwdCc7XG4gICAgICBkb21haW5TY3JpcHQgPSBgPCR7c2NyaXB0fT5kb2N1bWVudC5kb21haW49XCIke2RvbWFpbn1cIjs8LyR7c2NyaXB0fT5gO1xuICAgICAgZG9tYWluSW5wdXQgPSBgPGlucHV0IG5hbWU9XCJfZG9jdW1lbnREb21haW5cIiB2YWx1ZT1cIiR7ZG9tYWlufVwiIC8+YDtcbiAgICB9XG4gICAgcmV0dXJuIGBcbiAgICA8IURPQ1RZUEUgaHRtbD5cbiAgICA8aHRtbD5cbiAgICA8aGVhZD5cbiAgICA8bWV0YSBodHRwLWVxdWl2PVwiWC1VQS1Db21wYXRpYmxlXCIgY29udGVudD1cIklFPWVkZ2VcIiAvPlxuICAgIDxzdHlsZT5cbiAgICBib2R5LGh0bWwge3BhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtvdmVyZmxvdzpoaWRkZW47fVxuICAgIDwvc3R5bGU+XG4gICAgJHtkb21haW5TY3JpcHR9XG4gICAgPC9oZWFkPlxuICAgIDxib2R5PlxuICAgIDxmb3JtIG1ldGhvZD1cInBvc3RcIlxuICAgIGVuY1R5cGU9XCJtdWx0aXBhcnQvZm9ybS1kYXRhXCJcbiAgICBhY3Rpb249XCIke3RoaXMucHJvcHMuYWN0aW9ufVwiIGlkPVwiZm9ybVwiXG4gICAgc3R5bGU9XCJkaXNwbGF5OmJsb2NrO2hlaWdodDo5OTk5cHg7cG9zaXRpb246cmVsYXRpdmU7b3ZlcmZsb3c6aGlkZGVuO1wiPlxuICAgIDxpbnB1dCBpZD1cImlucHV0XCIgdHlwZT1cImZpbGVcIlxuICAgICBuYW1lPVwiJHt0aGlzLnByb3BzLm5hbWV9XCJcbiAgICAgc3R5bGU9XCJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtyaWdodDowO2hlaWdodDo5OTk5cHg7Zm9udC1zaXplOjk5OTlweDtjdXJzb3I6cG9pbnRlcjtcIi8+XG4gICAgJHtkb21haW5JbnB1dH1cbiAgICA8c3BhbiBpZD1cImRhdGFcIj48L3NwYW4+XG4gICAgPC9mb3JtPlxuICAgIDwvYm9keT5cbiAgICA8L2h0bWw+XG4gICAgYDtcbiAgfVxuXG4gIGluaXRJZnJhbWVTcmMoKSB7XG4gICAgaWYgKHRoaXMuZG9tYWluKSB7XG4gICAgICB0aGlzLmdldElmcmFtZU5vZGUoKS5zcmMgPSBgamF2YXNjcmlwdDp2b2lkKChmdW5jdGlvbigpe1xuICAgICAgICB2YXIgZCA9IGRvY3VtZW50O1xuICAgICAgICBkLm9wZW4oKTtcbiAgICAgICAgZC5kb21haW49JyR7dGhpcy5kb21haW59JztcbiAgICAgICAgZC53cml0ZSgnJyk7XG4gICAgICAgIGQuY2xvc2UoKTtcbiAgICAgIH0pKCkpYDtcbiAgICB9XG4gIH1cblxuICBpbml0SWZyYW1lKCkge1xuICAgIGNvbnN0IGlmcmFtZU5vZGUgPSB0aGlzLmdldElmcmFtZU5vZGUoKTtcbiAgICBsZXQgd2luID0gaWZyYW1lTm9kZS5jb250ZW50V2luZG93O1xuICAgIGxldCBkb2M7XG4gICAgdGhpcy5kb21haW4gPSB0aGlzLmRvbWFpbiB8fCAnJztcbiAgICB0aGlzLmluaXRJZnJhbWVTcmMoKTtcbiAgICB0cnkge1xuICAgICAgZG9jID0gd2luLmRvY3VtZW50O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluO1xuICAgICAgdGhpcy5pbml0SWZyYW1lU3JjKCk7XG4gICAgICB3aW4gPSBpZnJhbWVOb2RlLmNvbnRlbnRXaW5kb3c7XG4gICAgICBkb2MgPSB3aW4uZG9jdW1lbnQ7XG4gICAgfVxuICAgIGRvYy5vcGVuKCd0ZXh0L2h0bWwnLCAncmVwbGFjZScpO1xuICAgIGRvYy53cml0ZSh0aGlzLmdldElmcmFtZUhUTUwodGhpcy5kb21haW4pKTtcbiAgICBkb2MuY2xvc2UoKTtcbiAgICB0aGlzLmdldEZvcm1JbnB1dE5vZGUoKS5vbmNoYW5nZSA9IHRoaXMub25DaGFuZ2U7XG4gIH1cblxuICBlbmRVcGxvYWQoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUudXBsb2FkaW5nKSB7XG4gICAgICB0aGlzLmZpbGUgPSB7fTtcbiAgICAgIC8vIGhhY2sgYXZvaWQgYmF0Y2hcbiAgICAgIHRoaXMuc3RhdGUudXBsb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgdXBsb2FkaW5nOiBmYWxzZSxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pbml0SWZyYW1lKCk7XG4gICAgfVxuICB9XG5cbiAgc3RhcnRVcGxvYWQoKSB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLnVwbG9hZGluZykge1xuICAgICAgdGhpcy5zdGF0ZS51cGxvYWRpbmcgPSB0cnVlO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIHVwbG9hZGluZzogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZUlmcmFtZVdIKCkge1xuICAgIGNvbnN0IHJvb3ROb2RlID0gUmVhY3RET00uZmluZERPTU5vZGUodGhpcyk7XG4gICAgY29uc3QgaWZyYW1lTm9kZSA9IHRoaXMuZ2V0SWZyYW1lTm9kZSgpO1xuICAgIGlmcmFtZU5vZGUuc3R5bGUuaGVpZ2h0ID0gYCR7cm9vdE5vZGUub2Zmc2V0SGVpZ2h0fXB4YDtcbiAgICBpZnJhbWVOb2RlLnN0eWxlLndpZHRoID0gYCR7cm9vdE5vZGUub2Zmc2V0V2lkdGh9cHhgO1xuICB9XG5cbiAgYWJvcnQoZmlsZSkge1xuICAgIGlmIChmaWxlKSB7XG4gICAgICBsZXQgdWlkID0gZmlsZTtcbiAgICAgIGlmIChmaWxlICYmIGZpbGUudWlkKSB7XG4gICAgICAgIHVpZCA9IGZpbGUudWlkO1xuICAgICAgfVxuICAgICAgaWYgKHVpZCA9PT0gdGhpcy5maWxlLnVpZCkge1xuICAgICAgICB0aGlzLmVuZFVwbG9hZCgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVuZFVwbG9hZCgpO1xuICAgIH1cbiAgfVxuXG4gIHBvc3QoZmlsZSkge1xuICAgIGNvbnN0IGZvcm1Ob2RlID0gdGhpcy5nZXRGb3JtTm9kZSgpO1xuICAgIGNvbnN0IGRhdGFTcGFuID0gdGhpcy5nZXRGb3JtRGF0YU5vZGUoKTtcbiAgICBsZXQgeyBkYXRhIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHsgb25TdGFydCB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGRhdGEgPSBkYXRhKGZpbGUpO1xuICAgIH1cbiAgICBjb25zdCBpbnB1dHMgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZGF0YSkge1xuICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG4gICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnbmFtZScsIGtleSk7XG4gICAgICAgIGlucHV0LnZhbHVlID0gZGF0YVtrZXldO1xuICAgICAgICBpbnB1dHMuYXBwZW5kQ2hpbGQoaW5wdXQpO1xuICAgICAgfVxuICAgIH1cbiAgICBkYXRhU3Bhbi5hcHBlbmRDaGlsZChpbnB1dHMpO1xuICAgIGZvcm1Ob2RlLnN1Ym1pdCgpO1xuICAgIGRhdGFTcGFuLmlubmVySFRNTCA9ICcnO1xuICAgIG9uU3RhcnQoZmlsZSk7XG4gIH1cblxuICBzYXZlSWZyYW1lID0gKG5vZGUpID0+IHtcbiAgICB0aGlzLmlmcmFtZSA9IG5vZGU7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY29tcG9uZW50OiBUYWcsIGRpc2FibGVkLCBjbGFzc05hbWUsXG4gICAgICBwcmVmaXhDbHMsIGNoaWxkcmVuLCBzdHlsZSxcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBpZnJhbWVTdHlsZSA9IHtcbiAgICAgIC4uLklGUkFNRV9TVFlMRSxcbiAgICAgIGRpc3BsYXk6IHRoaXMuc3RhdGUudXBsb2FkaW5nIHx8IGRpc2FibGVkID8gJ25vbmUnIDogJycsXG4gICAgfTtcbiAgICBjb25zdCBjbHMgPSBjbGFzc05hbWVzKHtcbiAgICAgIFtwcmVmaXhDbHNdOiB0cnVlLFxuICAgICAgW2Ake3ByZWZpeENsc30tZGlzYWJsZWRgXTogZGlzYWJsZWQsXG4gICAgICBbY2xhc3NOYW1lXTogY2xhc3NOYW1lLFxuICAgIH0pO1xuICAgIHJldHVybiAoXG4gICAgICA8VGFnXG4gICAgICAgIGNsYXNzTmFtZT17Y2xzfVxuICAgICAgICBzdHlsZT17eyBwb3NpdGlvbjogJ3JlbGF0aXZlJywgekluZGV4OiAwLCAuLi5zdHlsZSB9fVxuICAgICAgPlxuICAgICAgICA8aWZyYW1lXG4gICAgICAgICAgcmVmPXt0aGlzLnNhdmVJZnJhbWV9XG4gICAgICAgICAgb25Mb2FkPXt0aGlzLm9uTG9hZH1cbiAgICAgICAgICBzdHlsZT17aWZyYW1lU3R5bGV9XG4gICAgICAgIC8+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvVGFnPlxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSWZyYW1lVXBsb2FkZXI7XG4iXX0=