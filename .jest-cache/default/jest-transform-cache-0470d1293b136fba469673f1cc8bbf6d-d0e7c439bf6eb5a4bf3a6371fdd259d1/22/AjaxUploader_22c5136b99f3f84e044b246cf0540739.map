{"version":3,"sources":["AjaxUploader.jsx"],"names":["AjaxUploader","uid","e","files","target","uploadFiles","reset","el","fileInput","click","key","onClick","type","preventDefault","Array","prototype","slice","call","dataTransfer","filter","file","props","accept","node","_isMounted","abort","postFiles","forEach","upload","fileList","beforeUpload","setTimeout","post","before","then","processedFile","processedFileType","Object","toString","console","log","data","onStart","onProgress","request","customRequest","defaultRequest","reqs","action","filename","name","headers","withCredentials","onSuccess","ret","xhr","onError","err","setState","keys","Tag","component","prefixCls","className","disabled","style","multiple","children","cls","events","onKeyDown","onDrop","onFileDrop","onDragOver","tabIndex","saveFileInput","state","display","onChange","Component","PropTypes","string","object","bool","any","func","oneOfType"],"mappings":"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","sourcesContent":["/* eslint react/no-is-mounted:0 react/sort-comp:0 */\n\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport defaultRequest from './request';\nimport getUid from './uid';\nimport attrAccept from './attr-accept';\n\nclass AjaxUploader extends Component {\n  static propTypes = {\n    component: PropTypes.string,\n    style: PropTypes.object,\n    prefixCls: PropTypes.string,\n    className: PropTypes.string,\n    multiple: PropTypes.bool,\n    disabled: PropTypes.bool,\n    accept: PropTypes.string,\n    children: PropTypes.any,\n    onStart: PropTypes.func,\n    data: PropTypes.oneOfType([\n      PropTypes.object,\n      PropTypes.func,\n    ]),\n    headers: PropTypes.object,\n    beforeUpload: PropTypes.func,\n    customRequest: PropTypes.func,\n    onProgress: PropTypes.func,\n    withCredentials: PropTypes.bool,\n  }\n\n  state = { uid: getUid() }\n\n  reqs = {}\n\n  onChange = e => {\n    const files = e.target.files;\n    this.uploadFiles(files);\n    this.reset();\n  }\n\n  onClick = () => {\n    const el = this.fileInput;\n    if (!el) {\n      return;\n    }\n    el.click();\n  }\n\n  onKeyDown = e => {\n    if (e.key === 'Enter') {\n      this.onClick();\n    }\n  }\n\n  onFileDrop = e => {\n    if (e.type === 'dragover') {\n      e.preventDefault();\n      return;\n    }\n    const files = Array.prototype.slice.call(e.dataTransfer.files).filter(\n      file => attrAccept(file, this.props.accept)\n    );\n    this.uploadFiles(files);\n\n    e.preventDefault();\n  }\n\n  componentDidMount() {\n    this._isMounted = true;\n  }\n\n  componentWillUnmount() {\n    this._isMounted = false;\n    this.abort();\n  }\n\n  uploadFiles(files) {\n    const postFiles = Array.prototype.slice.call(files);\n    postFiles.forEach((file) => {\n      file.uid = getUid();\n      this.upload(file, postFiles);\n    });\n  }\n\n  upload(file, fileList) {\n    const { props } = this;\n    if (!props.beforeUpload) {\n      // always async in case use react state to keep fileList\n      return setTimeout(() => this.post(file), 0);\n    }\n\n    const before = props.beforeUpload(file, fileList);\n    if (before && before.then) {\n      before.then((processedFile) => {\n        const processedFileType = Object.prototype.toString.call(processedFile);\n        if (processedFileType === '[object File]' || processedFileType === '[object Blob]') {\n          this.post(processedFile);\n        } else {\n          this.post(file);\n        }\n      }).catch(e => {\n        console && console.log(e); // eslint-disable-line\n      });\n    } else if (before !== false) {\n      setTimeout(() => this.post(file), 0);\n    }\n  }\n\n  post(file) {\n    if (!this._isMounted) {\n      return;\n    }\n    const { props } = this;\n    let { data } = props;\n    const { onStart, onProgress } = props;\n    if (typeof data === 'function') {\n      data = data(file);\n    }\n    const { uid } = file;\n    const request = props.customRequest || defaultRequest;\n    this.reqs[uid] = request({\n      action: props.action,\n      filename: props.name,\n      file,\n      data,\n      headers: props.headers,\n      withCredentials: props.withCredentials,\n      onProgress: onProgress ? e => {\n        onProgress(e, file);\n      } : null,\n      onSuccess: (ret, xhr) => {\n        delete this.reqs[uid];\n        props.onSuccess(ret, file, xhr);\n      },\n      onError: (err, ret) => {\n        delete this.reqs[uid];\n        props.onError(err, ret, file);\n      },\n    });\n    onStart(file);\n  }\n\n  reset() {\n    this.setState({\n      uid: getUid(),\n    });\n  }\n\n  abort(file) {\n    const { reqs } = this;\n    if (file) {\n      let uid = file;\n      if (file && file.uid) {\n        uid = file.uid;\n      }\n      if (reqs[uid]) {\n        reqs[uid].abort();\n        delete reqs[uid];\n      }\n    } else {\n      Object.keys(reqs).forEach((uid) => {\n        if (reqs[uid]) {\n          reqs[uid].abort();\n        }\n\n        delete reqs[uid];\n      });\n    }\n  }\n\n  saveFileInput = (node) => {\n    this.fileInput = node;\n  }\n\n  render() {\n    const {\n      component: Tag, prefixCls, className, disabled,\n      style, multiple, accept, children,\n    } = this.props;\n    const cls = classNames({\n      [prefixCls]: true,\n      [`${prefixCls}-disabled`]: disabled,\n      [className]: className,\n    });\n    const events = disabled ? {} : {\n      onClick: this.onClick,\n      onKeyDown: this.onKeyDown,\n      onDrop: this.onFileDrop,\n      onDragOver: this.onFileDrop,\n      tabIndex: '0',\n    };\n    return (\n      <Tag\n        {...events}\n        className={cls}\n        role=\"button\"\n        style={style}\n      >\n        <input\n          type=\"file\"\n          ref={this.saveFileInput}\n          key={this.state.uid}\n          style={{ display: 'none' }}\n          accept={accept}\n          multiple={multiple}\n          onChange={this.onChange}\n        />\n        {children}\n      </Tag>\n    );\n  }\n}\n\nexport default AjaxUploader;\n"]}