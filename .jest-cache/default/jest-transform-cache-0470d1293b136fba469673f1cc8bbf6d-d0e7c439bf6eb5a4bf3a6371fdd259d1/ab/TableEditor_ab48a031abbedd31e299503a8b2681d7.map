{"version":3,"sources":["/Users/huihuawk/Documents/opt/choerodon-ui/components-pro/table/TableEditor.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { cloneElement, Component, isValidElement, ReactElement } from 'react';\nimport PropTypes from 'prop-types';\nimport { runInAction } from 'mobx';\nimport { observer } from 'mobx-react';\nimport noop from 'lodash/noop';\nimport KeyCode from 'choerodon-ui/lib/_util/KeyCode';\nimport { pxToRem } from 'choerodon-ui/lib/_util/UnitConvertor';\nimport { ColumnProps } from './Column';\nimport { ElementProps } from '../core/ViewComponent';\nimport { FormField, FormFieldProps } from '../field/FormField';\nimport TableContext from './TableContext';\nimport { findCell, getColumnKey, getEditorByColumnAndRecord, isRadio } from './utils';\nimport { stopEvent } from '../_util/EventManager';\nimport { ShowHelp } from '../field/enum';\nimport autobind from '../_util/autobind';\n\nexport interface TableEditorProps extends ElementProps {\n  column: ColumnProps;\n}\n\n@observer\nexport default class TableEditor extends Component<TableEditorProps> {\n  static displayName = 'TableEditor';\n\n  static propTypes = {\n    column: PropTypes.object.isRequired,\n  };\n\n  static contextType = TableContext;\n\n  editorProps?: any;\n\n  editor: FormField<FormFieldProps> | null;\n\n  editing: boolean = false;\n\n  currentEditorName?: string;\n\n  @autobind\n  onWindowResize() {\n    this.forceUpdate();\n  }\n\n  componentDidMount() {\n    window.addEventListener('resize', this.onWindowResize);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener('resize', this.onWindowResize);\n  }\n\n  @autobind\n  saveRef(node) {\n    this.editor = node;\n  }\n\n  @autobind\n  handleEditorKeyEnterDown(e) {\n    if (!e.isDefaultPrevented()) {\n      this.showNextEditor(e.shiftKey);\n    }\n  }\n\n  @autobind\n  handleEditorKeyDown(e) {\n    if (e.keyCode !== KeyCode.ESC || !e.isDefaultPrevented()) {\n      const { tableStore } = this.context;\n      switch (e.keyCode) {\n        case KeyCode.ESC:\n        case KeyCode.TAB: {\n          const { prefixCls, column } = this.props;\n          const cell = findCell(tableStore, prefixCls, getColumnKey(column));\n          if (cell) {\n            cell.focus();\n          }\n          this.hideEditor();\n          break;\n        }\n        case KeyCode.PAGE_UP:\n        case KeyCode.PAGE_DOWN:\n          stopEvent(e);\n          break;\n        default:\n      }\n    }\n    const { editorProps } = this;\n    if (editorProps) {\n      const { onKeyDown = noop } = editorProps;\n      onKeyDown(e);\n    }\n  }\n\n  @autobind\n  handleEditorFocus() {\n    const {\n      currentEditorName,\n      context: { tableStore },\n    } = this;\n    if (!tableStore.currentEditorName && currentEditorName) {\n      runInAction(() => {\n        tableStore.currentEditorName = currentEditorName;\n      });\n    }\n  }\n\n  @autobind\n  handleEditorBlur(e) {\n    this.hideEditor();\n    const { editorProps } = this;\n    if (editorProps) {\n      const { onBlur = noop } = editorProps;\n      onBlur(e);\n    }\n  }\n\n  hideEditor() {\n    if (this.editing) {\n      const { tableStore } = this.context;\n      tableStore.hideEditor();\n    }\n  }\n\n  showNextEditor(reserve: boolean) {\n    if (this.editor) {\n      this.editor.blur();\n    }\n    const { tableStore } = this.context;\n    const { column } = this.props;\n    tableStore.showNextEditor(column.name, reserve);\n  }\n\n  renderEditor(): ReactElement<FormFieldProps> | undefined {\n    const { column } = this.props;\n    const {\n      tableStore: { dataSet, currentEditRecord, rowHeight, pristine },\n    } = this.context;\n    const record = currentEditRecord || dataSet.current;\n    const cellEditor = getEditorByColumnAndRecord(column, record);\n    if (!pristine && isValidElement(cellEditor) && !isRadio(cellEditor)) {\n      this.editorProps = cellEditor.props;\n      const { style = {}, ...otherProps } = this.editorProps;\n      if (rowHeight !== 'auto') {\n        style.height = pxToRem(rowHeight);\n      }\n      const newEditorProps = {\n        ...otherProps,\n        style,\n        ref: this.saveRef,\n        record,\n        name: column.name,\n        onKeyDown: this.handleEditorKeyDown,\n        onEnterDown: this.handleEditorKeyEnterDown,\n        onBlur: this.handleEditorBlur,\n        tabIndex: -1,\n        showHelp: ShowHelp.none,\n      };\n      return cloneElement<FormFieldProps>(cellEditor, newEditorProps);\n    }\n  }\n\n  render() {\n    const editor = this.renderEditor();\n    if (editor) {\n      const {\n        prefixCls,\n        column,\n        column: { lock, name },\n      } = this.props;\n      const props: any = {\n        className: `${prefixCls}-editor`,\n      };\n      const editorProps: any = {};\n      const { tableStore } = this.context;\n      if (tableStore.currentEditorName === name || tableStore.currentEditRecord) {\n        this.currentEditorName = name;\n        const cell = findCell(tableStore, prefixCls, getColumnKey(column), lock);\n        if (cell) {\n          this.editing = true;\n          const { offsetLeft, offsetTop, offsetWidth, offsetHeight } = cell;\n          props.style = {\n            left: pxToRem(offsetLeft),\n            top: pxToRem(offsetTop),\n          };\n          editorProps.style = {\n            ...editor.props.style,\n            width: pxToRem(offsetWidth),\n            height: pxToRem(offsetHeight),\n          };\n        }\n      } else if (this.editing) {\n        this.editing = false;\n        editorProps.onFocus = this.handleEditorFocus;\n      }\n      return <div {...props}>{cloneElement(editor, editorProps)}</div>;\n    }\n    return null;\n  }\n\n  componentDidUpdate() {\n    const {\n      column: { name },\n    } = this.props;\n    const { tableStore } = this.context;\n    if (this.editor && this.editing && tableStore.currentEditorName === name) {\n      this.editor.focus();\n    }\n  }\n}\n"]}